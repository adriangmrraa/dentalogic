This file is a merged representation of the entire codebase, combined into a single document by Repomix.
The content has been processed where security check has been disabled.

# File Summary

## Purpose
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

## File Format
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  a. A header with the file path (## File: path/to/file)
  b. The full contents of the file in a code block

## Usage Guidelines
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

## Notes
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Security check has been disabled - content may contain sensitive information
- Files are sorted by Git change count (files with more changes are at the bottom)

# Directory Structure
```
.agent/
  skills/
    Agent_Configuration_Architect/
      SKILL.md
    Backend_Sovereign/
      SKILL.md
    Business_Forge_Engineer/
      SKILL.md
    Credential_Vault_Specialist/
      SKILL.md
    DB_Evolution/
      SKILL.md
    Deep_Research/
      SKILL.md
    DevOps_EasyPanel/
      SKILL.md
    Doc_Keeper/
      SKILL.md
    Frontend_Nexus/
      SKILL.md
    Magic_Onboarding_Orchestrator/
      SKILL.md
    Maintenance_Robot_Architect/
      SKILL.md
    Meta_Integration_Diplomat/
      SKILL.md
    Nexus_UI_Architect/
      SKILL.md
    Omnichannel_Chat_Operator/
      SKILL.md
    Prompt_Architect/
      SKILL.md
    Skill_Forge_Master/
      SKILL.md
    Skill_Sync/
      SKILL.md
    Sovereign_Auditor/
      SKILL.md
    Spec_Architect/
      SKILL.md
    Template_Transplant_Specialist/
      SKILL.md
    Testing_Quality/
      SKILL.md
    TiendaNube_Commerce_Bridge/
      SKILL.md
  workflows/
    advisor.md
    audit.md
    bug_fix.md
    clarify.md
    finish.md
    gate.md
    implement.md
    new_feature.md
    newproject.md
    plan.md
    push.md
    review.md
    secuency.md
    specify.md
    tasks.md
    update-docs.md
    verify.md
  agents.md
bff_service/
  src/
    index.ts
  Dockerfile
  package.json
  tsconfig.json
db/
  init/
    dentalogic_schema.sql
  models_dental.py
docs/
  01_architecture.md
  02_environment_variables.md
  03_deployment_guide.md
  04_agent_logic_and_persona.md
  05_developer_notes.md
  06_ai_prompt_template.md
  07_workflow_guide.md
  08_troubleshooting_history.md
  09_fase1_dental_datos_especificacion.md
  11_gap_analysis_nexus_to_dental.md
  12_resumen_funcional_no_tecnico.md
  Instrucciones para IA.md
frontend_react/
  public/
    vite.svg
  src/
    api/
      axios.ts
    assets/
      react.svg
    components/
      Layout.tsx
      Modal.tsx
      PageTransition.tsx
      ProtectedRoute.tsx
      Sidebar.tsx
      SkeletonLoader.tsx
    context/
      AuthContext.tsx
    hooks/
      useApi.ts
    views/
      AgendaView.tsx
      ChatsView.tsx
      Credentials.tsx
      Dashboard.tsx
      DashboardView.tsx
      LoginView.tsx
      Logs.tsx
      PatientDetail.tsx
      PatientsView.tsx
      ProfessionalsView.tsx
      Setup.tsx
      Stores.tsx
      Tools.tsx
      TreatmentsView.tsx
      UserApprovalView.tsx
    App.tsx
    index.css
    main.tsx
  .gitignore
  Dockerfile
  eslint.config.js
  index.html
  nginx.conf
  package.json
  postcss.config.js
  README.md
  tailwind.config.js
  tsconfig.app.json
  tsconfig.json
  tsconfig.node.json
  vite.config.ts
orchestrator_service/
  db/
    init/
      dentalogic_schema.sql
  admin_routes.py
  auth_routes.py
  auth_service.py
  db.py
  debug_creds.py
  debug_db_check.py
  Dockerfile
  email_service.py
  fix_orphaned_chats.py
  gcal_service.py
  main.py
  requirements.txt
  utils.py
platform_ui/
  app.js
  Dockerfile
  env.sh
  index.html
  nginx.conf
  style.css
shared/
  __init__.py
  models_dental.py
  models.py
tests/
  conftest.py
  test_orchestrator.py
  test_quick.py
  test_tiendanube.py
  test_whatsapp.py
whatsapp_service/
  Dockerfile
  main.py
  requirements.txt
  ycloud_client.py
.dockerignore
.gitignore
AGENTS.md
DEPLOYMENT_CHECKLIST.md
docker-compose.yml
ENVIRONMENT_VARIABLES.md
Instrucciones para IA.md
orchestrator_service.zip
platform_ui.zip
pytest.ini
README_BACKEND.md
README.md
run_migrations.ps1
sync-schema.ps1
tiendanube_service.zip
verify_backend_final.py
verify_backend.ps1
verify_phases.py
```

# Files

## File: .agent/skills/Agent_Configuration_Architect/SKILL.md
````markdown
---
name: "Agent Configuration Architect"
description: "Especialista en configuraci√≥n de agentes de IA: templates, tools, models, prompts y seed data."
trigger: "agents, agentes, AI, tools, templates, models, prompts, system prompt, wizard"
scope: "AGENTS"
auto-invoke: true
---

# Agent Configuration Architect - Dentalogic (v7.1.2)

## 1. Concepto: La Arquitectura de Agentes Nexus

### Filosof√≠a Multi-Capa
Nexus no usa un √∫nico system prompt est√°tico. Utiliza una arquitectura de **3 capas** para construir la inteligencia del agente en runtime:

1.  **Capa 1: Template Base (Polimorfismo)**: Definida en `agent_service/app/core/agent_templates.py`. Provee la estructura de identidad y reglas core seg√∫n el rol (Sales, Support, Leads, Logistics).
2.  **Capa 2: Wizard Overrides (Identidad de Negocio)**: Datos espec√≠ficos del cliente (Tono, Reglas de Negocio, Diccionario de Sin√≥nimos) que sobreescriben los valores del template.
3.  **Capa 3: Instrucciones de Tools (T√°ctica de Ejecuci√≥n)**: Instrucciones detalladas sobre C√ìMO usar cada herramienta y C√ìMO formatear la respuesta, inyectadas din√°micamente.

---

## 2. Configuraci√≥n de Templates (Wizard Defaults)

Los valores predeterminados para el Wizard se definen en `orchestrator_service/app/api/agents.py` ‚Üí `AGENT_TEMPLATES`.

### Ejemplo: Sales Agent (Pointe Coach inspired)
```python
AGENT_TEMPLATES = {
    "sales": {
        "agent_name": "Agente de Ventas (IA)",
        "model_provider": "openai",
        "model_version": "gpt-4o",
        "temperature": 0.7,
        "defaultValue": {
            "agent_tone": "Sos una asesora experta en danza cl√°sica... usamos voseo argentino...",
            "synonym_dictionary": "mallas: Leotardos\ncancanes: Medias...",
            "business_rules": "1. Prioridad: Venta asistida...\n2. Fitting: Ofrecer siempre para puntas...",
            "catalog_knowledge": "Categor√≠as: Zapatillas, Medias, Leotardos, Accesorios.",
            "store_website": "https://pointecoach.com"
        }
    }
}
```

---

## 3. Dynamic Global Templates (v7.2+)

Nexus ahora soporta **Templates Din√°micos** almacenados en la base de datos. Esto permite crear plantillas que aparecen autom√°ticamente en el Wizard de todos los inquilinos.

### L√≥gica de Visibilidad
El endpoint `/admin/agent-templates` mezcla los templates hardcoded con los de la base de datos siguiendo esta l√≥gica:
-   `is_template = TRUE`: El registro es tratado como una plantilla, no como un agente vivo.
-   `tenant_id IS NULL`: **Template Global**. Visible para todas las cuentas del sistema.
-   `tenant_id = X`: **Template Privado**. Visible solo para el inquilino X.

### Mapeo de Campos
El JSON en la columna `config` del template debe mapear a los campos expected del Wizard:
- `store_description` -> Descripci√≥n en el Wizard.
- `agent_tone` -> Tono y Personalidad.
- `business_rules` -> Reglas de Negocio.
- `synonym_dictionary` -> Diccionario de Sin√≥nimos.

---

## 4. Instrucciones de Herramientas (Tool Config)

Cada herramienta tiene dos componentes de inyecci√≥n de prompt definidos en `orchestrator_service/main.py`:

1.  **T√°ctica (`tactical_injections`)**: Instrucciones sobre el proceso de pensamiento y validaci√≥n antes de llamar a la tool.
2.  **Gu√≠a de Respuesta (`response_guides`)**: Instrucciones sobre el formato y contenido de la salida (ej: Formato WhatsApp limpio, CTAs obligatorios).

### Distribuci√≥n de Instrucciones
El sistema busca instrucciones en este orden de prioridad:
1.  **Personalizaci√≥n por Tienda**: Configurada en el modal "Configurar Herramientas" (`tenant.tool_config`).
2.  **Configuraci√≥n de la Tool en DB**: Tabla `tools`, campos `prompt_injection` y `response_guide`.
3.  **Global Defaults**: Diccionarios `tactical_injections` y `response_guides` en `main.py`.

---

## 4. Inyecci√≥n Din√°mica y Variables M√°gicas

El Orchestrator inyecta variables en el prompt antes de enviarlo al `agent_service`:

-   `{STORE_NAME}`: Nombre del comercio.
-   `{STORE_CATALOG_KNOWLEDGE}`: Descripci√≥n del cat√°logo (Wizard).
-   `{STORE_DESCRIPTION}`: Descripci√≥n del negocio.
-   `{store_website}`: URL del sitio (usado en gu√≠as de respuesta).

---

## 5. El Proceso de "Trasplante" de Templates

Cuando integres un agente de un proyecto legacy o una configuraci√≥n compleja (como Pointe Coach), utiliz√° la t√©cnica de **Distribuci√≥n Multi-Capa**:

| Componente | Ubicaci√≥n en C√≥digo | Prop√≥sito |
| :--- | :--- | :--- |
| **Identidad/Tono** | `agents.py` (Wizard) | Estilo de habla y personalidad. |
| **Reglas de Negocio** | `agents.py` (Wizard) | Pol√≠ticas de venta, derivaci√≥n y fitting. |
| **Diccionario** | `agents.py` (Wizard) | Mapeo de t√©rminos informales a categor√≠as. |
| **T√°ctica de Tool** | `main.py` (Tactical) | L√≥gica de b√∫squeda y validaci√≥n. |
| **Formato Respuesta** | `main.py` (Response) | Estructura visual de los mensajes (WhatsApp). |
| **Reglas de Calidez** | `templates.py` (Base) | Puntuaci√≥n, prohibiciones cr√≠ticas (anti-markdown). |

> [!TIP]
> Consult√° la skill `Template_Transplant_Specialist` para ver el proceso paso a paso de extracci√≥n textual 1:1.

---

## 6. Checklist de Arquitecto

1.  **Wizard Alignment**: Asegurate de que los campos `agent_tone`, `business_rules` y `synonym_dictionary` del Wizard lleguen como `wizard_overrides` al `agent_service`.
2.  **Tool Parity**: Verific√° que el modal "Configurar Herramientas" en el Frontend muestre los defaults del sistema si no hay customizaci√≥n.
3.  **Prompt Merge**: Verific√° en `agent_service/main.py` que el prompt final sea la uni√≥n de: `template.build_system_prompt()` + `request.context.system_prompt` + `injected_content` (RAG y Tools).
4.  **Token Flow**: Confirm√° que el `tiendanube_access_token` se obtenga del Vault y se pase limpio al `agent_service` sin fallbacks legacy.

---

**Protocolo Omega**: En el 2026, los agentes se definen por su capacidad de seguir instrucciones t√°cticas precisas por herramienta. Menos "instrucciones generales" y m√°s "gu√≠as de respuesta espec√≠ficas".
````

## File: .agent/skills/Backend_Sovereign/SKILL.md
````markdown
---
name: "Sovereign Backend Engineer"
description: "Experto en FastAPI y gesti√≥n segura de credenciales multi-tenant para Dentalogic."
trigger: "python, backend, endpoints, base de datos, credenciales, agents, tools"
scope: "BACKEND"
auto-invoke: true
---

# Sovereign Backend Engineer - Dentalogic

# Sovereign Backend Engineer - Dentalogic

## 1. Arquitectura y Estructura (Flat Pattern)
El proyecto utiliza una estructura plana en `orchestrator_service/` para m√°xima agilidad:
- `main.py`: Punto de entrada, agents y tools (Dental Tools).
- `admin_routes.py`: Endpoints administrativos (Pacientes, Profesionales, Dashboard).
- `gcal_service.py`: Gesti√≥n real con Google Calendar (Service Account).
- `db.py`: Conexiones as√≠ncronas v√≠a `asyncpg`.

## 2. Integraci√≥n con Google Calendar (Sovereign Sync)
**REGLA DE ORO**: Toda cita creada en la plataforma o por la IA **DEBE** sincronizarse con Google Calendar.

### Sincronizaci√≥n en Tools (main.py):
```python
# gcal_service.create_event devuelve el event_id de Google
gcal_event = gcal_service.create_event(
    summary=f"Cita Dental: {patient_name}",
    start_time=start_iso,
    end_time=end_iso,
    description=f"Paciente: {phone}\nMotivo: {reason}"
)

# Persistir en la base de datos
await db.pool.execute(
    "UPDATE appointments SET google_calendar_event_id = $1, google_calendar_sync_status = 'synced' WHERE id = $2",
    gcal_event['id'], apt_id
)
```

## 3. Seguridad y Autenticaci√≥n (Admin Protocol)
El acceso a endpoints administrativos est√° protegido por un `ADMIN_TOKEN`:

### Header Requerido:
`X-Admin-Token: <tu-token-aqui>`

### Validaci√≥n en FastAPI:
```python
def verify_admin_token(x_admin_token: str = Header(...)):
    if x_admin_token != ADMIN_TOKEN:
        raise HTTPException(status_code=401, detail="Invalid token")
```

## 4. Patrones de Base de Datos (SQL Puro / asyncpg)
No usamos ORM pesado. Preferimos queries directas para mayor performance:

```python
# Ejemplo de fetch de pacientes
patients = await db.pool.fetch("""
    SELECT id, first_name, last_name, phone_number 
    FROM patients 
    WHERE status = 'active'
""")
```

## 5. Dental IA Tools (main.py)
Las herramientas de la IA deben seguir protocolos estrictos de triaje y agenda:
- `check_availability`: Siempre consulta GCal antes de proponer horarios.
- `book_appointment`: Valida datos del paciente antes de confirmar.
- `triage_urgency`: Clasifica el dolor y deriva a humano si es `critical`.

## 7. Normalizaci√≥n de Payloads (Compatibility Layer)
Para asegurar compatibilidad entre microservicios (especialmente WhatsApp -> Orquestador), los modelos Pydantic deben ser flexibles:
- **Regla**: Aceptar m√∫ltiples nombres para el mismo dato (ej: `phone` y `from_number`).
- **Implementaci√≥n**: Usar `@property` o `Field(alias=...)` en los modelos de request para normalizar el acceso a los datos.

```python
class ChatRequest(BaseModel):
    message: Optional[str] = None
    text: Optional[str] = None  # Alias para compatibilidad
    
    @property
    def final_message(self) -> str:
        return self.message or self.text or ""
```

## 8. Checklist de Desarrollo
- [ ] ¬øEl nuevo endpoint usa `verify_admin_token`?
- [ ] ¬øLas operaciones de citas disparan un `gcal_service` sync?
- [ ] ¬øSe emiten eventos v√≠a Socket.IO para actualizaci√≥n del Dashboard?
- [ ] ¬øEl log de errores incluye contexto del paciente/turno?
````

## File: .agent/skills/Business_Forge_Engineer/SKILL.md
````markdown
---
name: "Business Forge Engineer"
description: "Especialista en Business Forge: gesti√≥n de assets post-magia, Fusion Engine y generaci√≥n de visuales."
trigger: "forge, business forge, assets, fusion, canvas, catalog, visuals, images"
scope: "FORGE"
auto-invoke: true
---

# Business Forge Engineer - Dentalogic

## 1. Concepto: The Business Forge

### Filosof√≠a
El **Business Forge** es el **estudio post-magia** donde los usuarios refinan y utilizan los assets generados por el proceso de "Hacer Magia".

### Capacidades
- **Canvas**: Visualizar assets generados (branding, scripts, ROI, visuals)
- **Smart Catalog**: Browser de productos brutos de Tienda Nube
- **Fusion Engine**: Generaci√≥n de im√°genes publicitarias on-demand
- **Reality vs Dream Mode**: Overlay de producto real sobre fondo IA

### Arquitectura
```
Frontend (BusinessForge.tsx)
    ‚Üì
Tab System (Canvas | Smart Catalog)
    ‚Üì
Canvas ‚Üí GET /admin/assets (filtrado por type)
    ‚Üì
Smart Catalog ‚Üí GET /admin/products
    ‚Üì
Fusion Engine ‚Üí POST /admin/generate-image
    ‚Üì
Google Imagen 3 ‚Üí Visual Asset
```

## 2. Frontend: Tab System

### BusinessForge Component
```tsx
const BusinessForge: React.FC = () => {
  const [activeTab, setActiveTab] = useState<'canvas' | 'catalog'>('canvas');
  const [assets, setAssets] = useState<Asset[]>([]);
  const [products, setProducts] = useState<Product[]>([]);
  
  useEffect(() => {
    if (activeTab === 'canvas') {
      loadAssets();
    } else {
      loadProducts();
    }
  }, [activeTab]);
  
  const loadAssets = async () => {
    const data = await useApi<Asset[]>({
      method: 'GET',
      url: '/admin/assets'
    });
    setAssets(data);
  };
  
  const loadProducts = async () => {
    const data = await useApi<Product[]>({
      method: 'GET',
      url: '/admin/products'
    });
    setProducts(data);
  };
  
  return (
    <div className="forge-container">
      {/* Tab Navigation */}
      <div className="tabs">
        <button
          className={activeTab === 'canvas' ? 'active' : ''}
          onClick={() => setActiveTab('canvas')}
        >
          üé® Canvas
        </button>
        <button
          className={activeTab === 'catalog' ? 'active' : ''}
          onClick={() => setActiveTab('catalog')}
        >
          üì¶ Smart Catalog
        </button>
      </div>
      
      {/* Content */}
      <div className="forge-content">
        {activeTab === 'canvas' ? (
          <CanvasView assets={assets} />
        ) : (
          <CatalogView products={products} />
        )}
      </div>
    </div>
  );
};
```

## 3. Canvas View (Assets Generados)

### Filtrado por Tipo
```tsx
const CanvasView: React.FC<{ assets: Asset[] }> = ({ assets }) => {
  const [filter, setFilter] = useState<AssetType>('all');
  
  const filteredAssets = filter === 'all'
    ? assets
    : assets.filter(a => a.type === filter);
  
  return (
    <div className="canvas-view">
      {/* Filtros */}
      <div className="filters">
        <button onClick={() => setFilter('all')}>All</button>
        <button onClick={() => setFilter('branding')}>üß¨ Branding</button>
        <button onClick={() => setFilter('scripts')}>üìù Scripts</button>
        <button onClick={() => setFilter('roi')}>üí∞ ROI</button>
        <button onClick={() => setFilter('visuals')}>üé® Visuals</button>
      </div>
      
      {/* Asset Grid */}
      <div className="asset-grid">
        {filteredAssets.map(asset => (
          <AssetCard key={asset.id} asset={asset} />
        ))}
      </div>
    </div>
  );
};
```

### Asset Card (Polymorphic Renderer)
```tsx
const AssetCard: React.FC<{ asset: Asset }> = ({ asset }) => {
  const renderContent = () => {
    switch (asset.type) {
      case 'branding':
        return <BrandingAsset content={asset.content} />;
      
      case 'scripts':
        return <ScriptsAsset content={asset.content} />;
      
      case 'roi':
        return <ROIAsset content={asset.content} />;
      
      case 'visuals':
        return <VisualsAsset content={asset.content} />;
      
      default:
        return <JSONView data={asset.content} />;
    }
  };
  
  return (
    <div className="asset-card">
      <div className="asset-header">
        <h3>{asset.type}</h3>
        <span className="timestamp">
          {new Date(asset.created_at).toLocaleDateString()}
        </span>
      </div>
      
      <div className="asset-body">
        {renderContent()}
      </div>
    </div>
  );
};
```

### Branding Asset
```tsx
const BrandingAsset: React.FC<{ content: BrandingContent }> = ({ content }) => {
  return (
    <div className="branding-asset">
      <div className="section">
        <h4>MISI√ìN</h4>
        <p>{content.mission}</p>
      </div>
      
      <div className="section">
        <h4>VISI√ìN</h4>
        <p>{content.vision}</p>
      </div>
      
      <div className="section">
        <h4>VOZ DE MARCA</h4>
        <p>{content.voice}</p>
      </div>
      
      <div className="section">
        <h4>VALORES</h4>
        <ul>
          {content.values.map((v, i) => (
            <li key={i}>{v}</li>
          ))}
        </ul>
      </div>
      
      <div className="color-palette">
        <h4>PALETA DE COLORES</h4>
        <div className="colors">
          {content.color_palette.map((color, i) => (
            <div
              key={i}
              className="color-swatch"
              style={{ backgroundColor: color }}
              title={color}
            />
          ))}
        </div>
      </div>
    </div>
  );
};
```

### Visuals Asset (Social Posts)
```tsx
const VisualsAsset: React.FC<{ content: VisualsContent }> = ({ content }) => {
  return (
    <div className="visuals-grid">
      {content.social_posts.map((post, i) => (
        <FusionItem key={i} post={post} />
      ))}
    </div>
  );
};
```

## 4. Fusion Engine (Generaci√≥n On-Demand)

### FusionItem Component
```tsx
interface FusionPost {
  product_id: string;
  product_name: string;
  image_url: string;  // URL de la imagen generada por IA
  base_image?: string;  // URL original del producto (para overlay)
  prompt_used: string;
}

const FusionItem: React.FC<{ post: FusionPost }> = ({ post }) => {
  const [viewMode, setViewMode] = useState<'dream' | 'reality'>('dream');
  
  return (
    <div className="fusion-item">
      <div className="image-container">
        {viewMode === 'dream' ? (
          // Imagen pura de IA (puede alucinar detalles)
          <img src={post.image_url} alt={post.product_name} />
        ) : (
          // Overlay: fondo IA + producto real
          <div className="reality-overlay">
            <img
              src={post.image_url}
              className="background"
              alt="AI Background"
            />
            <img
              src={post.base_image}
              className="product-overlay"
              alt={post.product_name}
              style={{
                position: 'absolute',
                top: '50%',
                left: '50%',
                transform: 'translate(-50%, -50%)',
                maxWidth: '60%',
                maxHeight: '60%',
                mixBlendMode: 'multiply'
              }}
            />
          </div>
        )}
      </div>
      
      <div className="fusion-controls">
        <button
          onClick={() => setViewMode(viewMode === 'dream' ? 'reality' : 'dream')}
        >
          {viewMode === 'dream' ? 'üåü Dream' : '‚ú® Reality'}
        </button>
      </div>
      
      <div className="product-info">
        <h4>{post.product_name}</h4>
        <p className="prompt-hint">{post.prompt_used}</p>
      </div>
    </div>
  );
};
```

### Generar Nueva Imagen (Fusion Button)
```tsx
const ProductCard: React.FC<{ product: Product }> = ({ product }) => {
  const [generating, setGenerating] = useState(false);
  
  const handleIgniteFusion = async () => {
    setGenerating(true);
    
    try {
      const prompt = `
Professional advertising shot of ${product.name}.
Luxury aesthetic, soft lighting, minimal background.
High-end product photography, studio quality.
`;
      
      const response = await useApi({
        method: 'POST',
        url: '/admin/generate-image',
        data: {
          prompt: prompt,
          image_url: product.image_url
        }
      });
      
      if (response.status === 'success') {
        // Guardar en assets
        await saveGeneratedVisual(response.url, product);
        alert('Visual generated!');
      }
      
    } catch (error) {
      alert('Generation failed');
    } finally {
      setGenerating(false);
    }
  };
  
  return (
    <div className="product-card">
      <img src={product.image_url} alt={product.name} />
      <h3>{product.name}</h3>
      <p>${product.price}</p>
      
      <button
        onClick={handleIgniteFusion}
        disabled={generating}
        className="fusion-btn"
      >
        {generating ? 'Generating...' : 'üî• Ignite Fusion'}
      </button>
    </div>
  );
};
```

## 5. Backend: Fusion Engine

### generate-image Endpoint
```python
# orchestrator_service/app/api/v1/endpoints/forge.py

@router.post("/admin/generate-image")
async def generate_image(
    payload: ImageGenerationRequest,
    current_user = Depends(verify_admin_token)
):
    """
    Genera imagen publicitaria usando Google Imagen 3
    """
    tenant_id = await resolve_tenant(current_user.id)
    
    # Validar credencial de Google
    google_key = await get_tenant_credential(
        tenant_id=tenant_id,
        category="google",
        name="API_KEY"
    )
    
    if not google_key:
        raise HTTPException(
            status_code=400,
            detail="Google API key not configured"
        )
    
    # Opcionalmente, descargar imagen base para context
    base_image_data = None
    if payload.image_url:
        img_response = await httpx.get(payload.image_url)
        base_image_data = img_response.content
    
    # Llamar a Google Imagen 3
    try:
        response = await httpx.post(
            "https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0:generate",
            headers={
                "Authorization": f"Bearer {google_key}",
                "Content-Type": "application/json"
            },
            json={
                "prompt": payload.prompt,
                "num_images": 1,
                "aspect_ratio": "1:1",
                "safety_filter": "medium"
            },
            timeout=60.0
        )
        
        if response.status_code != 200:
            raise HTTPException(
                status_code=response.status_code,
                detail=f"Google Imagen API error: {response.text}"
            )
        
        data = response.json()
        generated_url = data['images'][0]['url']
        
        return {
            "status": "success",
            "url": generated_url
        }
        
    except Exception as e:
        logger.error(f"Image generation failed: {str(e)}")
        raise HTTPException(
            status_code=500,
            detail=f"Generation failed: {str(e)}"
        )
```

## 6. Smart Catalog (Product Browser)

### Catalog View
```tsx
const CatalogView: React.FC<{ products: Product[] }> = ({ products }) => {
  const [categoryFilter, setCategoryFilter] = useState<string | null>(null);
  
  // Extraer categor√≠as √∫nicas
  const categories = Array.from(
    new Set(products.map(p => p.category).filter(Boolean))
  );
  
  const filteredProducts = categoryFilter
    ? products.filter(p => p.category === categoryFilter)
    : products;
  
  return (
    <div className="catalog-view">
      {/* Filtro de categor√≠as */}
      <div className="category-filters">
        <button
          className={!categoryFilter ? 'active' : ''}
          onClick={() => setCategoryFilter(null)}
        >
          All Products
        </button>
        {categories.map(cat => (
          <button
            key={cat}
            className={categoryFilter === cat ? 'active' : ''}
            onClick={() => setCategoryFilter(cat)}
          >
            {cat}
          </button>
        ))}
      </div>
      
      {/* Grid de productos */}
      <div className="product-grid">
        {filteredProducts.map(product => (
          <ProductCard key={product.id} product={product} />
        ))}
      </div>
    </div>
  );
};
```

## 7. Persistencia de Assets

### Backend: Assets Endpoint
```python
@router.get("/admin/assets")
async def list_assets(
    current_user = Depends(verify_admin_token),
    type_filter: Optional[str] = None,
    session: AsyncSession = Depends(get_session)
):
    """
    Lista assets generados
    """
    tenant_id = await resolve_tenant(current_user.id)
    
    # Query base
    stmt = select(BusinessAsset).where(
        BusinessAsset.tenant_id == tenant_id
    )
    
    # Filtro opcional por tipo
    if type_filter:
        stmt = stmt.where(BusinessAsset.type == type_filter)
    
    # Ordenar por m√°s reciente
    stmt = stmt.order_by(BusinessAsset.created_at.desc())
    
    result = await session.execute(stmt)
    assets = result.scalars().all()
    
    return [
        {
            "id": a.id,
            "type": a.type,
            "content": a.content,
            "created_at": a.created_at.isoformat()
        }
        for a in assets
    ]
```

### Guardar Visual Generado
```python
@router.post("/admin/assets", status_code=201)
async def save_asset(
    payload: AssetCreate,
    current_user = Depends(verify_admin_token),
    session: AsyncSession = Depends(get_session)
):
    tenant_id = await resolve_tenant(current_user.id)
    
    asset = BusinessAsset(
        tenant_id=tenant_id,
        type=payload.type,
        content=payload.content
    )
    
    session.add(asset)
    await session.commit()
    await session.refresh(asset)
    
    return {
        "id": asset.id,
        "status": "saved"
    }
```

## 8. Reality vs Dream Mode (CSS Magic)

### CSS Implementation
```css
/* Reality Mode: Overlay */
.reality-overlay {
  position: relative;
  width: 100%;
  aspect-ratio: 1 / 1;
  overflow: hidden;
}

.reality-overlay .background {
  width: 100%;
  height: 100%;
  object-fit: cover;
  filter: brightness(0.9);  /* Oscurecer ligeramente fondo */
}

.reality-overlay .product-overlay {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  max-width: 60%;
  max-height: 60%;
  object-fit: contain;
  mix-blend-mode: multiply;  /* Mezclar con fondo */
  filter: drop-shadow(0 10px 30px rgba(0,0,0,0.3));  /* Sombra realista */
}
```

## 9. Export & Download

### Exportar Asset
```tsx
const exportAsset = async (asset: Asset) => {
  if (asset.type === 'visuals') {
    // Descargar imagen
    const imageUrl = asset.content.social_posts[0].image_url;
    
    const link = document.createElement('a');
    link.href = imageUrl;
    link.download = `visual_${asset.id}.jpg`;
    link.click();
    
  } else {
    // Descargar JSON
    const blob = new Blob(
      [JSON.stringify(asset.content, null, 2)],
      { type: 'application/json' }
    );
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${asset.type}_${asset.id}.json`;
    link.click();
  }
};
```

## 10. Troubleshooting

### "No se ve la imagen generada"
```
Causa: URL de Google Imagen tiene CORS restrictivo
Soluci√≥n: Proxy la imagen a trav√©s del backend o guardarla en storage
```

### "Fusion falla silenciosamente"
```
Causa: Google API quota excedida
Soluci√≥n: Verificar quota en Google Cloud Console
```

### "Overlay no se ve bien"
```
Causa: Imagen original tiene fondo blanco (no transparente)
Soluci√≥n: Usar productos con PNGs transparentes o aplicar remove-bg
```

### "Assets no cargan"
```
Causa: tenant_id incorrecto
Soluci√≥n: Verificar resolve_tenant en backend
```

## 11. Checklist de Implementaci√≥n

### Frontend
- [ ] Tab system (Canvas / Catalog)
- [ ] Asset grid con filtros
- [ ] Polymorphic asset renderer
- [ ] Fusion button funcional
- [ ] Reality vs Dream toggle
- [ ] Category filters en Catalog
- [ ] Export/Download assets

### Backend
- [ ] GET /admin/assets (con filtros)
- [ ] POST /admin/generate-image
- [ ] GET /admin/products (desde TiendaNube)
- [ ] POST /admin/assets (guardar generados)
- [ ] Google Imagen 3 integration
- [ ] Validaci√≥n de credenciales

### Visuals
- [ ] Branding asset renderer
- [ ] Scripts asset renderer
- [ ] ROI asset renderer
- [ ] Social posts grid
- [ ] CSS overlay effect
- [ ] Product cards con imagen

---

**Tip**: Para mejores resultados en Fusion, usar prompts espec√≠ficos con estilo deseado (ej: "minimalist white background", "luxury studio lighting").
````

## File: .agent/skills/Credential_Vault_Specialist/SKILL.md
````markdown
---
name: "Credential Vault Specialist"
description: "Especialista en gesti√≥n segura de credenciales multi-tenant: encriptaci√≥n, scope, categor√≠as y The Vault."
trigger: "credentials, credenciales, vault, api keys, tokens, encriptaci√≥n, settings, sovereign"
scope: "SECURITY"
auto-invoke: true
---

# Credential Vault Specialist - Dentalogic

## 1. Concepto: The Sovereign Vault

### Filosof√≠a
**NO usar variables de entorno para secretos de tenant**. Cada tienda (tenant) proporciona sus propias credenciales API, garantizando:
- **Soberan√≠a de Datos**: El tenant controla sus propias keys
- **Aislamiento Total**: Las credenciales de Tenant 1 son invisibles para Tenant 2
- **Rotaci√≥n Independiente**: Cada tenant puede rotar sus keys sin afectar a otros

### The Vault Architecture
```
Frontend (Credentials View)
    ‚Üì
POST /admin/credentials (HTTPS)
    ‚Üì
Backend ‚Üí AES-256 Encryption (Fernet)
    ‚Üì
PostgreSQL credentials table (encrypted value)
    ‚Üì
Runtime ‚Üí Decrypt on-demand (get_tenant_credential)
    ‚Üì
API Calls (OpenAI, Meta, Google, SMTP)
```

## 2. Modelo de Datos

### credentials Table
```sql
CREATE TABLE credentials (
    id SERIAL PRIMARY KEY,
    tenant_id INTEGER REFERENCES tenants(id),
    category VARCHAR(100) NOT NULL,  -- 'openai', 'google', 'smtp', 'tiendanube', 'whatsapp_cloud'
    name VARCHAR(100) NOT NULL,      -- 'API_KEY', 'user_id', 'host'
    value TEXT NOT NULL,              -- Encrypted con AES-256
    scope VARCHAR(50) DEFAULT 'tenant',  -- 'global', 'tenant'
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(tenant_id, category, name)
);

-- Index for fast lookups
CREATE INDEX idx_credentials_tenant_category 
ON credentials(tenant_id, category);
```

### Categor√≠as Soportadas
```python
SUPPORTED_CATEGORIES = {
    "openai": {
        "fields": ["API_KEY"],
        "masked_display": True
    },
    "google": {
        "fields": ["API_KEY"],
        "masked_display": True
    },
    "smtp": {
        "fields": ["host", "port", "user", "pass"],
        "special_handling": "json_stringify"
    },
    "tiendanube": {
        "fields": ["access_token", "user_id"],
        "oauth": True
    },
    "whatsapp_cloud": {
        "fields": ["access_token", "phone_number_id", "waba_id"],
        "oauth": True
    },
    "meta": {
        "fields": ["long_lived_token"],
        "oauth": True,
        "expires": True
    }
}
```

## 3. Encriptaci√≥n (AES-256 with Fernet)

### Master Key (Environment Variable)
```python
# orchestrator_service/.env
INTERNAL_SECRET_KEY=base64_encoded_32_byte_key_here
```

### Encryption Module
```python
# app/core/encryption.py

from cryptography.fernet import Fernet
import base64
import os

class CredentialEncryption:
    def __init__(self):
        # Derivar key desde INTERNAL_SECRET_KEY
        secret = os.getenv('INTERNAL_SECRET_KEY')
        if not secret:
            raise ValueError("INTERNAL_SECRET_KEY not set")
        
        # Asegurar 32 bytes (URL-safe base64)
        key = base64.urlsafe_b64encode(secret.encode()[:32].ljust(32))
        self.cipher = Fernet(key)
    
    def encrypt(self, plaintext: str) -> str:
        """
        Encripta valor y retorna string base64
        """
        encrypted_bytes = self.cipher.encrypt(plaintext.encode())
        return encrypted_bytes.decode('utf-8')
    
    def decrypt(self, ciphertext: str) -> str:
        """
        Desencripta valor desde string base64
        """
        decrypted_bytes = self.cipher.decrypt(ciphertext.encode())
        return decrypted_bytes.decode('utf-8')

# Singleton
encryptor = CredentialEncryption()
```

## 4. Guardar Credencial (Frontend ‚Üí Backend)

### Frontend: Credentials View
```tsx
const CredentialsView: React.FC = () => {
  const [category, setCategory] = useState('openai');
  const [apiKey, setApiKey] = useState('');
  
  const handleSave = async () => {
    await useApi({
      method: 'POST',
      url: '/admin/credentials',
      data: {
        category: category,
        name: 'API_KEY',
        value: apiKey,
        scope: 'tenant'  // o 'global'
      }
    });
    
    // Limpiar input
    setApiKey('');
    alert('Credential saved securely');
  };
  
  return (
    <div className="vault-interface">
      <select value={category} onChange={(e) => setCategory(e.target.value)}>
        <option value="openai">OpenAI</option>
        <option value="google">Google</option>
        <option value="smtp">SMTP</option>
      </select>
      
      <input
        type="password"
        value={apiKey}
        onChange={(e) => setApiKey(e.target.value)}
        placeholder="Enter API Key"
      />
      
      <button onClick={handleSave}>Save to Vault</button>
    </div>
  );
};
```

### Backend: Save Endpoint
```python
# orchestrator_service/app/api/v1/endpoints/credentials.py

from app.core.encryption import encryptor

@router.post("/credentials", status_code=201)
async def save_credential(
    payload: CredentialCreate,
    current_user = Depends(verify_admin_token),
    session: AsyncSession = Depends(get_session)
):
    # Resolver tenant
    tenant_id = await resolve_tenant(current_user.id)
    
    # Validar scope
    if payload.scope == 'global' and not current_user.is_superadmin:
        raise HTTPException(
            status_code=403,
            detail="Only superadmins can set global credentials"
        )
    
    # Asignar tenant_id
    if payload.scope == 'tenant':
        final_tenant_id = tenant_id
    else:
        final_tenant_id = None  # Global credentials
    
    # Encriptar valor
    encrypted_value = encryptor.encrypt(payload.value)
    
    # Upsert (insert or update)
    stmt = select(Credential).where(
        Credential.tenant_id == final_tenant_id,
        Credential.category == payload.category,
        Credential.name == payload.name
    )
    result = await session.execute(stmt)
    existing = result.scalar_one_or_none()
    
    if existing:
        # Actualizar
        existing.value = encrypted_value
        existing.updated_at = datetime.utcnow()
    else:
        # Crear nuevo
        cred = Credential(
            tenant_id=final_tenant_id,
            category=payload.category,
            name=payload.name,
            value=encrypted_value,
            scope=payload.scope,
            metadata=payload.metadata or {}
        )
        session.add(cred)
    
    await session.commit()
    
    return {"status": "saved"}
```

## 5. Obtener Credencial (Runtime)

### get_tenant_credential Function
```python
# app/core/credentials.py

async def get_tenant_credential(
    tenant_id: int,
    category: str,
    name: str = "API_KEY",
    session: AsyncSession = None
) -> str | None:
    """
    Busca credencial con fallback a global
    
    Priority:
    1. Tenant-specific credential
    2. Global credential (if exists)
    3. None
    """
    # 1. Buscar credencial espec√≠fica del tenant
    stmt = select(Credential).where(
        Credential.tenant_id == tenant_id,
        Credential.category == category,
        Credential.name == name
    )
    result = await session.execute(stmt)
    cred = result.scalar_one_or_none()
    
    if cred:
        # Desencriptar y retornar
        return encryptor.decrypt(cred.value)
    
    # 2. Fallback: buscar credencial global
    stmt_global = select(Credential).where(
        Credential.tenant_id == None,
        Credential.category == category,
        Credential.name == name,
        Credential.scope == 'global'
    )
    result_global = await session.execute(stmt_global)
    cred_global = result_global.scalar_one_or_none()
    
    if cred_global:
        return encryptor.decrypt(cred_global.value)
    
    # 3. No encontrado
    return None
```

### Uso en Servicios
```python
# Ejemplo: Llamar a OpenAI
async def call_openai_api(tenant_id: int, prompt: str):
    # Obtener API key del tenant
    api_key = await get_tenant_credential(
        tenant_id=tenant_id,
        category="openai",
        name="API_KEY"
    )
    
    if not api_key:
        raise HTTPException(
            status_code=400,
            detail="OpenAI API key not configured for this tenant"
        )
    
    # Usar key
    client = OpenAI(api_key=api_key)
    response = client.chat.completions.create(
        model="gpt-5-mini",
        messages=[{"role": "user", "content": prompt}]
    )
    
    return response.choices[0].message.content
```

## 6. Caso Especial: SMTP (JSON Stringified)

### SMTP Configuration
```python
# SMTP requiere m√∫ltiples campos, se guarda como JSON string

smtp_config = {
    "host": "smtp.gmail.com",
    "port": "587",
    "user": "noreply@tienda.com",
    "pass": "app_specific_password"
}

# Guardar como string JSON
await save_credential(
    tenant_id=tenant_id,
    category="smtp",
    name="config",
    value=json.dumps(smtp_config)
)

# Recuperar y parsear
smtp_json = await get_tenant_credential(
    tenant_id=tenant_id,
    category="smtp",
    name="config"
)

smtp_dict = json.loads(smtp_json)
```

### Frontend SMTP Form
```tsx
const SMTPForm: React.FC = () => {
  const [host, setHost] = useState('');
  const [port, setPort] = useState('587');
  const [user, setUser] = useState('');
  const [pass, setPass] = useState('');
  
  const handleSave = async () => {
    const config = {
      host,
      port,
      user,
      pass
    };
    
    await useApi({
      method: 'POST',
      url: '/admin/credentials',
      data: {
        category: 'smtp',
        name: 'config',
        value: JSON.stringify(config),
        scope: 'tenant'
      }
    });
  };
  
  return (
    <form>
      <input
        value={host}
        onChange={(e) => setHost(e.target.value)}
        placeholder="SMTP Host (e.g., smtp.gmail.com)"
      />
      <input
        value={port}
        onChange={(e) => setPort(e.target.value)}
        placeholder="Port (587 for TLS)"
      />
      <input
        value={user}
        onChange={(e) => setUser(e.target.value)}
        placeholder="Username / Email"
      />
      <input
        type="password"
        value={pass}
        onChange={(e) => setPass(e.target.value)}
        placeholder="Password / App-Specific Password"
      />
      <button onClick={handleSave}>Save SMTP Config</button>
    </form>
  );
};
```

## 7. Listar Credenciales (Masked)

### Frontend: Credential List
```tsx
interface CredentialDisplay {
  id: number;
  category: string;
  name: string;
  masked_value: string;
  scope: string;
  created_at: string;
}

const CredentialsList: React.FC = () => {
  const [credentials, setCredentials] = useState<CredentialDisplay[]>([]);
  
  useEffect(() => {
    loadCredentials();
  }, []);
  
  const loadCredentials = async () => {
    const data = await useApi({
      method: 'GET',
      url: '/admin/credentials'
    });
    setCredentials(data);
  };
  
  const handleDelete = async (id: number) => {
    if (confirm('Delete this credential?')) {
      await useApi({
        method: 'DELETE',
        url: `/admin/credentials/${id}`
      });
      loadCredentials();
    }
  };
  
  return (
    <div className="credentials-list">
      {credentials.map(cred => (
        <div key={cred.id} className="credential-card">
          <div>
            <strong>{cred.category}</strong> / {cred.name}
          </div>
          <div className="masked-value">
            {cred.masked_value}
          </div>
          <div className="scope-badge">
            {cred.scope === 'global' ? 'üåç Global' : 'üîí Tenant'}
          </div>
          <button onClick={() => handleDelete(cred.id)}>Delete</button>
        </div>
      ))}
    </div>
  );
};
```

### Backend: List Endpoint (Masked)
```python
@router.get("/credentials")
async def list_credentials(
    current_user = Depends(verify_admin_token),
    session: AsyncSession = Depends(get_session)
):
    tenant_id = await resolve_tenant(current_user.id)
    
    # Obtener credenciales del tenant
    stmt = select(Credential).where(
        Credential.tenant_id == tenant_id
    )
    result = await session.execute(stmt)
    credentials = result.scalars().all()
    
    # Si es superadmin, mostrar tambi√©n globals
    if current_user.is_superadmin:
        stmt_global = select(Credential).where(
            Credential.scope == 'global'
        )
        result_global = await session.execute(stmt_global)
        credentials.extend(result_global.scalars().all())
    
    # Maskear valores
    return [
        {
            "id": cred.id,
            "category": cred.category,
            "name": cred.name,
            "masked_value": mask_value(cred.value),
            "scope": cred.scope,
            "created_at": cred.created_at.isoformat()
        }
        for cred in credentials
    ]

def mask_value(encrypted_value: str) -> str:
    """
    Devuelve valor mascarado (ej: sk-...xyz)
    """
    try:
        # Desencriptar
        decrypted = encryptor.decrypt(encrypted_value)
        
        # Maskear (mostrar primeros 3 y √∫ltimos 3 caracteres)
        if len(decrypted) > 10:
            return f"{decrypted[:3]}...{decrypted[-3:]}"
        else:
            return "***"
    except:
        return "*** (error decrypting)"
```

## 8. Rotaci√≥n de Credenciales

### Frontend: Rotate Key
```tsx
const rotateKey = async (credentialId: number) => {
  const newKey = prompt('Enter new API key:');
  
  if (!newKey) return;
  
  await useApi({
    method: 'PUT',
    url: `/admin/credentials/${credentialId}`,
    data: {
      value: newKey
    }
  });
  
  alert('Key rotated successfully');
};
```

### Backend: Update Endpoint
```python
@router.put("/credentials/{credential_id}")
async def update_credential(
    credential_id: int,
    payload: CredentialUpdate,
    current_user = Depends(verify_admin_token),
    session: AsyncSession = Depends(get_session)
):
    tenant_id = await resolve_tenant(current_user.id)
    
    # Obtener credencial
    cred = await session.get(Credential, credential_id)
    
    if not cred:
        raise HTTPException(status_code=404, detail="Credential not found")
    
    # Validar ownership
    if cred.tenant_id != tenant_id and not current_user.is_superadmin:
        raise HTTPException(status_code=403, detail="Forbidden")
    
    # Encriptar nuevo valor
    cred.value = encryptor.encrypt(payload.value)
    cred.updated_at = datetime.utcnow()
    
    await session.commit()
    
    return {"status": "updated"}
```

## 9. Scope: Global vs Tenant

### Global Credentials (Fallback)
```python
# Usar para credenciales compartidas (ej: SMTP del sistema)
# Solo superadmins pueden crear/editar

await save_credential(
    tenant_id=None,  # NULL = global
    category="smtp",
    name="config",
    value=json.dumps(smtp_config),
    scope="global"
)
```

### Tenant-Specific (Preferred)
```python
# Cada tenant provee sus propias keys
await save_credential(
    tenant_id=tenant_id,
    category="openai",
    name="API_KEY",
    value="sk-proj-...",
    scope="tenant"
)
```

### Resolution Logic
1. **Buscar tenant-specific** ‚Üí Si existe, usar
2. **Fallback a global** ‚Üí Si no existe tenant-specific
3. **Return None** ‚Üí Si no existe ninguna

## 10. Metadata (Expiration Tracking)

### Guardar con Metadata
```python
# Para tokens con expiraci√≥n (ej: Meta Long-Lived Token)
metadata = {
    "expires_at": (datetime.utcnow() + timedelta(days=60)).isoformat(),
    "token_type": "long_lived",
    "auto_refresh": False
}

await save_credential(
    tenant_id=tenant_id,
    category="meta",
    name="long_lived_token",
    value=token,
    metadata=metadata
)
```

### Verificar Expiraci√≥n
```python
async def check_token_expiration(tenant_id: int) -> bool:
    """
    Retorna True si token est√° por expirar (< 7 d√≠as)
    """
    stmt = select(Credential).where(
        Credential.tenant_id == tenant_id,
        Credential.category == "meta"
    )
    result = await session.execute(stmt)
    cred = result.scalar_one_or_none()
    
    if not cred:
        return False
    
    expires_at_str = cred.metadata.get('expires_at')
    if not expires_at_str:
        return False
    
    expires_at = datetime.fromisoformat(expires_at_str)
    days_remaining = (expires_at - datetime.utcnow()).days
    
    return days_remaining < 7
```

## 11. Troubleshooting

### "Decryption Error"
```
Causa: INTERNAL_SECRET_KEY cambi√≥ despu√©s de encriptar
Soluci√≥n: NUNCA cambiar INTERNAL_SECRET_KEY en producci√≥n
```

### "Credential not found"
```
Causa: tenant_id incorrecto (UUID vs Integer)
Soluci√≥n: Usar resolve_tenant(current_user.id) siempre
```

### "403 Forbidden on global credential"
```
Causa: Usuario no es superadmin
Soluci√≥n: Solo superadmins pueden gestionar scope='global'
```

## 12. Security Best Practices

### ‚úÖ DO
- Usar HTTPS siempre
- Encriptar valores antes de guardar
- Validar ownership antes de editar/borrar
- Maskear valores en listados
- Rotar keys peri√≥dicamente

### ‚ùå DON'T
- Enviar valores sin encriptar
- Guardar en localStorage (frontend)
- Exponer valores completos en logs
- Permitir edici√≥n cross-tenant
- Hardcodear keys en c√≥digo

## 13. Checklist de Implementaci√≥n

### Frontend
- [ ] Formularios por categor√≠a (OpenAI, Google, SMTP)
- [ ] Input type="password" para keys
- [ ] Lista de credenciales con valores masked
- [ ] Bot√≥n de rotaci√≥n funcional
- [ ] Indicador de scope (global vs tenant)
- [ ] Delete con confirmaci√≥n

### Backend
- [ ] Encriptaci√≥n AES-256 implementada
- [ ] get_tenant_credential con fallback
- [ ] Upsert logic (insert or update)
- [ ] Validaci√≥n de ownership
- [ ] Endpoint de listado masked
- [ ] Metadata para expiraci√≥n

---

**Tip**: Nunca loggear valores desencriptados. Usar `logger.info(f"Using credential for {category}")` sin exponer el valor.
````

## File: .agent/skills/DB_Evolution/SKILL.md
````markdown
---
name: "DB Schema Surgeon"
description: "Gesti√≥n del esquema PostgreSQL, Auto-Healing y arquitectura RAG h√≠brida."
trigger: "base de datos, modelos, migraciones, tablas, RAG, schema, SQL"
scope: "DATABASE"
auto-invoke: true
---

# DB Schema Surgeon - Dentalogic

# DB Schema Surgeon - Dentalogic

## 1. Patr√≥n de Acceso a Datos (Direct asyncpg)
Dentalogic prioriza el uso de SQL puro sobre `asyncpg` para m√°xima velocidad e hilos no bloqueantes. No usamos SQLAlchemy ORM de forma extensiva.

### Conector Principal (`orchestrator_service/db.py`):
```python
from db import pool

# Fetch row simple
patient = await db.pool.fetchrow("SELECT * FROM patients WHERE phone_number = $1", phone)
```

## 2. Esquema Core (Citas y Salud)

### Tabla `appointments` (El Coraz√≥n)
```sql
CREATE TABLE appointments (
    id SERIAL PRIMARY KEY,
    patient_id INTEGER REFERENCES patients(id),
    appointment_datetime TIMESTAMPTZ NOT NULL,
    status VARCHAR(50) DEFAULT 'scheduled', -- scheduled, completed, cancelled
    urgency_level VARCHAR(50) DEFAULT 'normal', -- normal, high, emergency
    google_calendar_event_id TEXT,
    google_calendar_sync_status VARCHAR(50) DEFAULT 'pending'
);
```

### Tabla `patients`
```sql
CREATE TABLE patients (
    id SERIAL PRIMARY KEY,
    first_name TEXT,
    last_name TEXT,
    phone_number TEXT UNIQUE,
    clinical_history TEXT
);
```

## 3. Gestor de Migraciones (Maintenance Robot)
Dentalogic utiliza un sistema de **Self-Healing** y **Evoluci√≥n Continua** en `orchestrator_service/db.py`.

### Arquitectura de Dos Capas:
1.  **Foundation**: Si la tabla `tenants` no existe, se aplica `dentalogic_schema.sql` completo.
2.  **Evolution Pipeline**: Una lista de parches en `db.py` que se ejecutan en cada arranque.

### Reglas para Evolucionar el Esquema:
- **NUNCA** hagas migraciones manuales en producci√≥n.
- **SIEMPRE** agrega un parche a la lista `patches` en `db.py`.
- **SINTAXIS**: Usa bloques `DO $$ BEGIN ... END $$` con `IF NOT EXISTS` para cualquier `ALTER TABLE` o `CREATE TABLE`.

**Ejemplo de Parche Seguro:**
```sql
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='professionals' AND column_name='specialty_code') THEN
        ALTER TABLE professionals ADD COLUMN specialty_code VARCHAR(10);
    END IF;
END $$;
```

## 4. Sincronizaci√≥n de Archivos SQL
Mant√©n siempre sincronizado el archivo ra√≠z con el del orquestador usando:
```bash
powershell -ExecutionPolicy Bypass -File ./sync-schema.ps1
```

## 5. Integraci√≥n con Google Calendar
Sincronizar siempre el `google_calendar_event_id` para evitar duplicados. Si un turno se cancela en la BD, **debe** dispararse la cancelaci√≥n en el `gcal_service`.

## 6. Checklist de Base de Datos
- [ ] ¬øEl cambio est√° en el Evolution Pipeline de `db.py`?
- [ ] ¬øEl bloque `DO` verifica la existencia antes de alterar?
- [ ] ¬øSe sincroniz√≥ el `dentalogic_schema.sql` para nuevas instalaciones?
- [ ] ¬øLa query usa `$1`, `$2` para prevenir SQL Injection?
- [ ] ¬øLos √≠ndices est√°n en los campos de b√∫squeda frecuentes?
````

## File: .agent/skills/Deep_Research/SKILL.md
````markdown
---
name: "Deep Researcher"
description: "Investiga documentaci√≥n oficial y valida soluciones en internet antes de implementar."
trigger: "Antes de usar una librer√≠a nueva, al enfrentar un error desconocido, o cuando el usuario diga 'investiga esto'."
scope: "GLOBAL"
auto-invoke: true
---

# Protocolo de Investigaci√≥n (Measure Twice, Cut Once)

Tu objetivo es validar la viabilidad t√©cnica leyendo fuentes externas actualizadas antes de escribir c√≥digo.

## 1. Estrategia de B√∫squeda
Antes de asumir una sintaxis o funci√≥n:
1.  **Identifica los Actores:** ¬øQu√© tecnolog√≠as est√°n involucradas? (ej. *FastAPI, Pydantic v2, Supabase Vector*).
2.  **Formula Queries Precisas:**
    - Mal: "C√≥mo usar pydantic"
    - Bien: "Pydantic v2 model_validator syntax example"
    - Bien: "Supabase pgvector python client insert guide"
3.  **Ejecuta B√∫squeda:** Utiliza tus herramientas de navegaci√≥n/b√∫squeda para leer la documentaci√≥n oficial o issues de GitHub recientes.

## 2. Validaci√≥n de Contexto (Sovereign Check)
Cruza la informaci√≥n encontrada con las reglas de `AGENTS.md`:
- ¬øLa soluci√≥n encontrada requiere variables de entorno globales? -> **Descartar** (Viola Protocolo Soberano).
- ¬øLa librer√≠a sugerida es compatible con Python 3.10+ as√≠ncrono? -> **Verificar**.

## 3. S√≠ntesis del Plan
Antes de escribir el c√≥digo final, genera un breve resumen:
> "He investigado la documentaci√≥n de [Librer√≠a].
> La versi√≥n actual requiere usar el m√©todo X en lugar de Y.
> Este es el plan de implementaci√≥n compatible con Nexus v6..."

## 4. Anti-Patrones a Evitar
- No uses tutoriales de m√°s de 2 a√±os de antig√ºedad sin verificar.
- No inventes importaciones. Si la documentaci√≥n no lo menciona, no existe.
````

## File: .agent/skills/DevOps_EasyPanel/SKILL.md
````markdown
---
name: "EasyPanel DevOps"
description: "Experto en Dockerizaci√≥n, Docker Compose y despliegue en EasyPanel."
trigger: "Cuando toque Dockerfile, docker-compose.yml o variables de entorno."
scope: "DEVOPS"
auto-invoke: true
---

# Protocolo de Despliegue EasyPanel

1. **Gesti√≥n de Puertos:**
   - El `orchestrator` SIEMPRE escucha en `8000` (interno).
   - El frontend escucha en `80` (dentro de Nginx).
   - Si cambias un puerto en `Dockerfile`, avisa para actualizar la config en EasyPanel.

2. **Persistencia (Vol√∫menes):**
   - Si agregas una funcionalidad que guarda archivos (ej. `uploads/`), aseg√∫rate de que la ruta est√© mapeada en los vol√∫menes persistentes de EasyPanel, o se perder√°n en el pr√≥ximo deploy.

3. **Variables de Entorno (Build vs Runtime):**
   - `VITE_` variables se inyectan en **BUILD TIME**. Si las cambias, hay que reconstruir la imagen.
   - Variables de Backend (Python) son **RUNTIME**. Solo requieren reinicio.

4. **Webhooks y Redirecci√≥n:**
   - Para servicios como YCloud, el orquestador debe aceptar tanto `/webhook` como `/webhook/ycloud` para evitar errores 404 si el usuario olvida la ruta espec√≠fica.

5. **Troubleshooting 401/422:**
   - 401 en Frontend ‚Üí Falta `VITE_ADMIN_TOKEN` en build.
   - 422 en Orchestrator ‚Üí Mismatch de nombres de campos en payload (normalizar en Pydantic).
````

## File: .agent/skills/Doc_Keeper/SKILL.md
````markdown
---
name: "Smart Doc Keeper"
description: "Actualiza documentaci√≥n y skills usando el protocolo 'Non-Destructive Fusion'. Garantiza que el contenido previo se preserve."
trigger: "Cuando el usuario diga 'actualiza la doc', 'documenta este cambio' o tras editar c√≥digo importante."
scope: "MAINTENANCE"
auto-invoke: false
---

# Protocolo de Documentaci√≥n "Smart Fusion"

Tu objetivo es mantener la documentaci√≥n viva sin matar la historia. Eres un **Bibliotecario**, no una trituradora de papel.

> [!CRITICAL]
> **PROTOCOLO DE SEGURIDAD DE DATOS**: Antes de guardar cualquier archivo `.md`, debes tener el contenido ORIGINAL completo en tu contexto. Si no le√≠ste el archivo entero, NO LO TOQUES.

## 1. El Flujo de Fusi√≥n (The Fusion Flow)

Cuando debas actualizar un documento (ej. `docs/CHATS_LOGIC.md` tras agregar una funci√≥n):

1.  **Lectura Total:** Lee el archivo objetivo completo (`read_file`).
2.  **Identificaci√≥n de Anclaje:** Busca un t√≠tulo o secci√≥n donde l√≥gicamente encaje lo nuevo.
    * *Ejemplo:* Si agregaste "Bot√≥n de P√°nico", busca `## 2. Endpoints & Payloads` o crea `## 3. Nuevas Funcionalidades`.
3.  **Construcci√≥n en Memoria:**
    * `[Contenido Viejo Superior]`
    * `+ [Tu Nuevo Contenido]`
    * `[Contenido Viejo Inferior]`
4.  **Escritura:** Guarda el archivo completo fusionado.

## 2. Estrategias de Actualizaci√≥n

### A. Estrategia "Append" (La m√°s segura)
√ösala para bit√°coras, changelogs o gu√≠as de migraci√≥n.
* **Acci√≥n:** No toques nada de lo existente. Agrega una nueva secci√≥n H2 (`##`) al final del documento con la fecha y el cambio.
* *Ejemplo:* `## [v6.2] Nueva integraci√≥n Chatwoot - Enero 2026` al final de `REPORTE_MASTER.md`.

### B. Estrategia "Injection" (Listas y Tablas)
√ösala para agregar endpoints a `API_REFERENCE.md` o variables a `INFRASTRUCTURE.md`.
* **Acci√≥n:** Localiza la tabla o lista existente. Inserta la nueva fila respetando el formato Markdown (`| Col | Col |`). Mant√©n el resto de filas intactas.

### C. Estrategia "Deprecation" (Reemplazo)
√ösala SOLO si una funci√≥n vieja dej√≥ de existir.
* **Acci√≥n:** En lugar de borrar el texto viejo, envu√©lvelo en un bloque de alerta:
    ```markdown
    > [!WARNING] DEPRECATED (v6.0)
    > El siguiente m√©todo ya no se usa, pero se mantiene por referencia hist√≥rica.
    > [Texto Viejo...]
    
    ### Nueva Implementaci√≥n (v6.2)
    [Texto Nuevo...]
    ```

## 3. Verificaci√≥n de Integridad (Safety Check)

Antes de ejecutar el comando `write_file` o guardar, hazte estas preguntas:

1.  *"¬øEl nuevo contenido es dr√°sticamente m√°s corto que el original?"*
    * Si el archivo original ten√≠a 500 l√≠neas y tu propuesta tiene 50, **DETENTE**. Est√°s a punto de borrar informaci√≥n.
2.  *"¬øHe mantenido los headers y la estructura de navegaci√≥n?"*
3.  *"¬øEstoy alucinando secciones que no le√≠?"*

## 4. Ejecuci√≥n T√°ctica

1.  **Analizar C√≥digo:** Lee el archivo de c√≥digo modificado (ej. `Chats.tsx` o `meta_service.py`).
2.  **Leer Doc:** Lee el documento correspondiente en `docs/`.
3.  **Redactar:** Crea el p√°rrafo t√©cnico explicando el cambio.
4.  **Fusionar:** Combina `Doc Original` + `Nuevo P√°rrafo`.
5.  **Guardar:** Escribe el resultado final.

## 5. Caso Especial: Actualizar Skills (`SKILL.md`)
Si actualizas una Skill:
1.  **NUNCA** toques el Frontmatter (YAML) a menos que se pida expl√≠citamente.
2.  Agrega nuevas reglas en la secci√≥n pertinente.
3.  Ejecuta la skill **"Skill Synchronizer"** al finalizar para re-indexar.
````

## File: .agent/skills/Frontend_Nexus/SKILL.md
````markdown
---
name: "Nexus UI Developer"
description: "Especialista en React 18, TypeScript, Tailwind CSS y conexi√≥n con API multi-tenant."
trigger: "frontend, react, tsx, componentes, UI, vistas, hooks"
scope: "FRONTEND"
auto-invoke: true
---

# Nexus UI Developer - Dentalogic

# Nexus UI Developer - Dentalogic

## 1. Arquitectura Frontend
El frontend en `frontend_react/` es una SPA moderna basada en:
- **React 18** + TypeScript + Vite.
- **TailwindCSS** para el layout y **Vanilla CSS** para el dise√±o premium (Glassmorphism).
- **Lucide Icons** para la iconograf√≠a dental.
- **Axios**: Cliente HTTP configurado en `src/api/axios.ts`.

## 2. API Communication Protocol
**REGLA DE ORO**: Todas las llamadas al backend administrativo **DEBEN** incluir el header `X-Admin-Token`.

### Hook `useApi`:
Utiliza el hook personalizado para manejar estados de carga y errores de forma estandarizada.

### Cliente Axios (`src/api/axios.ts`):
```typescript
import axios from 'axios';

const api = axios.create({
  baseURL: import.meta.env.VITE_API_URL,
  headers: {
    'X-Admin-Token': localStorage.getItem('admin_token')
  }
});
```

## 3. Vistas Cr√≠ticas (Business Logic)

### AgendaView.tsx
- La pieza central de Dentalogic.
- Muestra turnos desde la BD y bloqueos de Google Calendar.
- Permite agendar "Sobreturnos" forzados.

### DashboardView.tsx (Triage Center)
- Escucha eventos de Socket.IO (`HIGH_URGENCY_TRIAGE`, `CRITICAL_TRIAGE`).
- Muestra m√©tricas de hoy: Turnos, Pendientes, Urgencias.
- Controla el estado global del Bot IA.

### Credentials.tsx (The Vault UI)
- Gesti√≥n de `GOOGLE_CREDENTIALS` y `YCLOUD_API_KEY`.
- Muestra la URL din√°mica para el Webhook de YCloud con opci√≥n de copiado.

## 4. Estilos y UX (Premium Dental)
- **Glassmorphism**: Usar clase `.glass` para tarjetas e inputs.
- **Micro-animaciones**: Usar `animate-pulse` para estados de triaje cr√≠tico.
- **Responsive**: Mobile-first para que los odont√≥logos puedan ver su agenda desde el celular.

## 6. Producci√≥n y Dockerizaci√≥n
**CR√çTICO**: El frontend inyecta variables `VITE_` durante el **BUILD TIME**.
- **Regla**: El `Dockerfile` debe usar `ARG` y `ENV` para capturar `VITE_ADMIN_TOKEN` y `VITE_API_URL` durante el comando `npm run build`.
- **Verificaci√≥n**: Si el frontend da 401 en producci√≥n, lo primero es verificar que las variables est√°n presentes en el panel de EasyPanel ANTES del build.

## 7. Checklist de UI
- [ ] ¬øEl componente maneja `isLoading` con un spinner o esqueleto?
- [ ] ¬øLos errores se muestran v√≠a Toasts o alertas `check-fail`?
- [ ] ¬øSe usa `Lucide` para coherencia visual?
- [ ] ¬øLa tabla/lista tiene `key` √∫nico (IDs de la BD)?
````

## File: .agent/skills/Magic_Onboarding_Orchestrator/SKILL.md
````markdown
---
name: "Magic Onboarding Orchestrator"
description: "Especialista en el proceso 'Hacer Magia': orquestaci√≥n de agentes IA, SSE streaming y generaci√≥n de assets de negocio."
trigger: "magia, magic, onboarding, hacer magia, wizard, sse, stream, assets, branding"
scope: "MAGIC"
auto-invoke: true
---

# Magic Onboarding Orchestrator - Dentalogic

## 1. Concepto: "Hacer Magia" (The Ignition)

### Filosof√≠a
**"Hacer Magia"** es el proceso de **Onboarding Automatizado** que transforma una tienda conectada en una operaci√≥n lista para vender en minutos.

### Lo que hace:
1. **Analiza cat√°logo** de Tienda Nube
2. **Extrae Brand DNA** (misi√≥n, visi√≥n, tono)
3. **Vectoriza conocimiento** para RAG
4. **Genera scripts de venta** (AIDA, PAS)
5. **Calcula proyecciones ROI**
6. **Crea visuales publicitarios** (Google Imagen 3)

### Arquitectura
```
Frontend (MagicOnboarding.tsx)
    ‚Üì
POST /admin/onboarding/magic ‚Üí Background Task (202 Accepted)
    ‚Üì
SSE Stream (/engine/stream/v2/{tenant_id})
    ‚Üì
Orchestrator ‚Üí 7 Agent Pipeline
    ‚Üì
Business Assets (DB) + RAG Vectors (Supabase)
```

## 2. Los 7 Agentes Especializados

### Protocolo Omega (Sequential Pipeline)

```python
# agent_service/app/core/magic_orchestrator.py

MAGIC_PIPELINE = [
    {
        "name": "Catalog Analyzer",
        "role": "Analizar productos y categor√≠as",
        "output": "product_catalog.json"
    },
    {
        "name": "Brand DNA Extractor",
        "role": "Identificar identidad de marca",
        "output": "branding.json"
    },
    {
        "name": "Knowledge Vectorizer",
        "role": "Crear embeddings para RAG",
        "output": "rag_vectors (Supabase)"
    },
    {
        "name": "Sales Script Generator",
        "role": "Crear copys de venta (AIDA, PAS)",
        "output": "scripts.json"
    },
    {
        "name": "ROI Projector",
        "role": "Proyecciones financieras",
        "output": "roi.json"
    },
    {
        "name": "Visual Artist",
        "role": "Generar im√°genes publicitarias",
        "output": "visuals.json"
    },
    {
        "name": "Compliance Guardian",
        "role": "Validar coherencia y legalidad",
        "output": "validation_report.json"
    }
]
```

## 3. Frontend: Iniciar Magia

### MagicOnboarding Component
```tsx
const MagicOnboarding: React.FC = () => {
  const [loading, setLoading] = useState(false);
  const [logs, setLogs] = useState<string[]>([]);
  const [progress, setProgress] = useState(0);
  
  const handleIgnite = async () => {
    setLoading(true);
    
    // Iniciar proceso (background task)
    const response = await useApi({
      method: 'POST',
      url: '/admin/onboarding/magic',
      data: {
        mode: 'full',  // 'full', 'catalog_only', 'branding_only'
        options: {
          generate_visuals: true,
          vectorize_catalog: true
        }
      }
    });
    
    if (response.status === 'started') {
      // Conectar a SSE stream
      listenToStream(response.tenant_id);
    }
  };
  
  const listenToStream = (tenantId: number) => {
    const eventSource = new EventSource(
      `/api/admin/engine/stream/v2/${tenantId}`
    );
    
    eventSource.addEventListener('log', (e) => {
      const data = JSON.parse(e.data);
      setLogs(prev => [...prev, data.message]);
    });
    
    eventSource.addEventListener('progress', (e) => {
      const data = JSON.parse(e.data);
      setProgress(data.percentage);
    });
    
    eventSource.addEventListener('asset_generated', (e) => {
      const data = JSON.parse(e.data);
      console.log('Asset generated:', data.type, data.id);
    });
    
    eventSource.addEventListener('done', (e) => {
      eventSource.close();
      setLoading(false);
      // Redirigir a Business Forge
      navigate('/forge');
    });
    
    eventSource.addEventListener('error', (e) => {
      console.error('SSE Error:', e);
      eventSource.close();
      setLoading(false);
    });
  };
  
  return (
    <div className="magic-container">
      <button
        onClick={handleIgnite}
        disabled={loading}
        className="ignite-button"
      >
        {loading ? 'Creando Magia...' : 'Hacer Magia ‚ú®'}
      </button>
      
      {/* Progress bar */}
      <div className="progress-bar">
        <div style={{ width: `${progress}%` }} />
      </div>
      
      {/* Live logs */}
      <div className="log-console">
        {logs.map((log, i) => (
          <div key={i}>{log}</div>
        ))}
      </div>
    </div>
  );
};
```

## 4. Backend: Orchestrator

### Endpoint de Inicio
```python
# orchestrator_service/app/api/v1/endpoints/magic.py

@router.post("/onboarding/magic", status_code=202)
async def start_magic_onboarding(
    payload: MagicOnboardingRequest,
    current_user = Depends(verify_admin_token),
    background_tasks: BackgroundTasks,
    session: AsyncSession = Depends(get_session)
):
    """
    Inicia el proceso de Hacer Magia en background
    """
    tenant_id = await resolve_tenant(current_user.id)
    
    # Validar credenciales necesarias
    await validate_prerequisites(tenant_id, session)
    
    # Crear task en background
    background_tasks.add_task(
        execute_magic_pipeline,
        tenant_id=tenant_id,
        mode=payload.mode,
        options=payload.options
    )
    
    return {
        "status": "started",
        "tenant_id": tenant_id,
        "stream_url": f"/api/admin/engine/stream/v2/{tenant_id}"
    }
```

### Validaci√≥n de Prerequisites
```python
async def validate_prerequisites(
    tenant_id: int,
    session: AsyncSession
):
    """
    Verifica que est√©n configuradas las credenciales necesarias
    """
    # 1. Tienda Nube conectada
    tn_token = await get_tenant_credential(
        tenant_id=tenant_id,
        category="tiendanube"
    )
    if not tn_token:
        raise HTTPException(
            status_code=400,
            detail="Tienda Nube not connected. Connect your store first."
        )
    
    # 2. OpenAI API Key
    openai_key = await get_tenant_credential(
        tenant_id=tenant_id,
        category="openai"
    )
    if not openai_key:
        raise HTTPException(
            status_code=400,
            detail="OpenAI API key not configured"
        )
    
    # 3. Google API Key (para im√°genes)
    google_key = await get_tenant_credential(
        tenant_id=tenant_id,
        category="google"
    )
    if not google_key:
        raise HTTPException(
            status_code=400,
            detail="Google API key not configured (required for visuals)"
        )
```

## 5. SSE Stream (Server-Sent Events)

### Endpoint SSE
```python
# orchestrator_service/app/api/v1/endpoints/sse.py

from sse_starlette.sse import EventSourceResponse

@router.get("/engine/stream/v2/{tenant_id}")
async def stream_magic_progress(
    tenant_id: int,
    current_user = Depends(verify_admin_token)
):
    """
    Stream de eventos en tiempo real del proceso de Magia
    """
    async def event_generator():
        # Suscribirse a Redis channel
        pubsub = redis_client.pubsub()
        channel = f"magic_progress:{tenant_id}"
        await pubsub.subscribe(channel)
        
        try:
            async for message in pubsub.listen():
                if message['type'] == 'message':
                    data = json.loads(message['data'])
                    
                    # Enviar evento al frontend
                    yield {
                        "event": data.get('event', 'log'),
                        "data": json.dumps(data)
                    }
                    
                    # Si termin√≥, cerrar stream
                    if data.get('event') == 'done':
                        break
        finally:
            await pubsub.unsubscribe(channel)
    
    return EventSourceResponse(event_generator())
```

### Redis Broadcast (desde Pipeline)
```python
async def broadcast_progress(
    tenant_id: int,
    event: str,
    data: dict
):
    """
    Env√≠a evento a todos los clientes suscritos
    """
    channel = f"magic_progress:{tenant_id}"
    
    payload = {
        "event": event,
        **data
    }
    
    await redis_client.publish(
        channel,
        json.dumps(payload)
    )
```

## 6. Ejecuci√≥n del Pipeline

### execute_magic_pipeline (Background Task)
```python
async def execute_magic_pipeline(
    tenant_id: int,
    mode: str,
    options: dict
):
    """
    Ejecuta los 7 agentes secuencialmente
    """
    try:
        # 1. Catalog Analyzer
        await broadcast_progress(
            tenant_id,
            "log",
            {"message": "üì¶ Analizando cat√°logo de productos..."}
        )
        
        catalog = await analyze_catalog(tenant_id)
        
        await broadcast_progress(
            tenant_id,
            "progress",
            {"percentage": 14, "step": "catalog"}
        )
        
        # 2. Brand DNA Extractor
        await broadcast_progress(
            tenant_id,
            "log",
            {"message": "üß¨ Extrayendo ADN de marca..."}
        )
        
        branding = await extract_brand_dna(tenant_id, catalog)
        
        await save_asset(
            tenant_id=tenant_id,
            type="branding",
            content=branding
        )
        
        await broadcast_progress(
            tenant_id,
            "asset_generated",
            {"type": "branding", "id": branding_asset.id}
        )
        
        await broadcast_progress(
            tenant_id,
            "progress",
            {"percentage": 28, "step": "branding"}
        )
        
        # 3. Knowledge Vectorizer
        if options.get('vectorize_catalog', True):
            await broadcast_progress(
                tenant_id,
                "log",
                {"message": "üß† Vectorizando conocimiento para RAG..."}
            )
            
            await vectorize_catalog(tenant_id, catalog)
            
            await broadcast_progress(
                tenant_id,
                "progress",
                {"percentage": 42, "step": "vectorization"}
            )
        
        # 4. Sales Script Generator
        await broadcast_progress(
            tenant_id,
            "log",
            {"message": "üìù Generando scripts de venta..."}
        )
        
        scripts = await generate_sales_scripts(
            tenant_id,
            catalog,
            branding
        )
        
        await save_asset(
            tenant_id=tenant_id,
            type="scripts",
            content=scripts
        )
        
        await broadcast_progress(
            tenant_id,
            "progress",
            {"percentage": 56, "step": "scripts"}
        )
        
        # 5. ROI Projector
        await broadcast_progress(
            tenant_id,
            "log",
            {"message": "üí∞ Calculando proyecciones ROI..."}
        )
        
        roi = await calculate_roi(tenant_id, catalog)
        
        await save_asset(
            tenant_id=tenant_id,
            type="roi",
            content=roi
        )
        
        await broadcast_progress(
            tenant_id,
            "progress",
            {"percentage": 70, "step": "roi"}
        )
        
        # 6. Visual Artist
        if options.get('generate_visuals', True):
            await broadcast_progress(
                tenant_id,
                "log",
                {"message": "üé® Generando visuales publicitarios..."}
            )
            
            visuals = await generate_visuals(
                tenant_id,
                catalog,
                branding
            )
            
            await save_asset(
                tenant_id=tenant_id,
                type="visuals",
                content=visuals
            )
            
            await broadcast_progress(
                tenant_id,
                "progress",
                {"percentage": 85, "step": "visuals"}
            )
        
        # 7. Compliance Guardian
        await broadcast_progress(
            tenant_id,
            "log",
            {"message": "‚úÖ Validando coherencia..."}
        )
        
        validation = await validate_compliance(tenant_id)
        
        await broadcast_progress(
            tenant_id,
            "progress",
            {"percentage": 100, "step": "validation"}
        )
        
        # Finalizar
        await broadcast_progress(
            tenant_id,
            "done",
            {"message": "üéâ Magia completada!"}
        )
        
    except Exception as e:
        await broadcast_progress(
            tenant_id,
            "error",
            {"message": f"Error: {str(e)}"}
        )
        raise
```

## 7. Agentes Espec√≠ficos

### Catalog Analyzer
```python
async def analyze_catalog(tenant_id: int) -> dict:
    """
    Descarga y analiza cat√°logo de Tienda Nube
    """
    # Obtener credenciales
    tn_token = await get_tenant_credential(
        tenant_id=tenant_id,
        category="tiendanube"
    )
    
    tn_user_id = await get_tenant_credential(
        tenant_id=tenant_id,
        category="tiendanube",
        name="user_id"
    )
    
    # Llamar API de Tienda Nube
    response = await httpx.get(
        f"https://api.tiendanube.com/v1/{tn_user_id}/products",
        headers={"Authorization": f"Bearer {tn_token}"},
        params={"per_page": 200}
    )
    
    products = response.json()
    
    # An√°lisis estructural
    categories = extract_categories(products)
    price_range = calculate_price_range(products)
    top_products = identify_top_products(products)
    
    return {
        "products": products,
        "categories": categories,
        "price_range": price_range,
        "top_products": top_products,
        "total_products": len(products)
    }
```

### Brand DNA Extractor
```python
async def extract_brand_dna(
    tenant_id: int,
    catalog: dict
) -> dict:
    """
    Usa IA para analizar la identidad de marca
    """
    # Llamar a agent_service
    response = await httpx.post(
        "http://agent_service:8004/analyze-brand",
        json={
            "tenant_id": tenant_id,
            "catalog": catalog,
            "prompt": """
Analiza este cat√°logo de productos y extrae:
1. MISI√ìN: ¬øQu√© problema resuelve esta tienda?
2. VISI√ìN: ¬øQu√© aspiraci√≥n tiene?
3. VOZ: ¬øC√≥mo habla la marca? (formal, casual, t√©cnica)
4. VALORES: ¬øQu√© principios transmite?

Formato JSON.
"""
        }
    )
    
    brand_dna = response.json()
    
    return {
        "mission": brand_dna.get('mission'),
        "vision": brand_dna.get('vision'),
        "voice": brand_dna.get('voice'),
        "values": brand_dna.get('values'),
        "color_palette": brand_dna.get('color_palette'),
        "typography_vibe": brand_dna.get('typography_vibe')
    }
```

### Visual Artist
```python
async def generate_visuals(
    tenant_id: int,
    catalog: dict,
    branding: dict
) -> dict:
    """
    Genera im√°genes publicitarias con Google Imagen 3
    """
    google_key = await get_tenant_credential(
        tenant_id=tenant_id,
        category="google"
    )
    
    # Seleccionar top 3 productos
    top_products = catalog['top_products'][:3]
    
    visuals = []
    
    for product in top_products:
        # Construir prompt
        prompt = f"""
Professional advertising photography of {product['name']}.
Brand vibe: {branding['voice']}.
Colors: {branding['color_palette']}.
High-end commercial lighting, cinematic composition.
"""
        
        # Llamar a Google Imagen API
        response = await httpx.post(
            "https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0:generate",
            headers={"Authorization": f"Bearer {google_key}"},
            json={
                "prompt": prompt,
                "num_images": 1,
                "aspect_ratio": "1:1"
            }
        )
        
        image_url = response.json()['images'][0]['url']
        
        visuals.append({
            "product_id": product['id'],
            "product_name": product['name'],
            "image_url": image_url,
            "prompt_used": prompt
        })
    
    return {
        "social_posts": visuals,
        "generated_at": datetime.utcnow().isoformat()
    }
```

## 8. Persistencia de Assets

### business_assets Table
```sql
CREATE TABLE business_assets (
    id SERIAL PRIMARY KEY,
    tenant_id INTEGER REFERENCES tenants(id),
    type VARCHAR(50) NOT NULL,  -- 'branding', 'scripts', 'roi', 'visuals'
    content JSONB NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Guardar Asset
```python
async def save_asset(
    tenant_id: int,
    type: str,
    content: dict
) -> BusinessAsset:
    """
    Persiste asset generado en DB
    """
    asset = BusinessAsset(
        tenant_id=tenant_id,
        type=type,
        content=content
    )
    
    session.add(asset)
    await session.commit()
    await session.refresh(asset)
    
    return asset
```

## 9. Troubleshooting

### "Stream se desconecta"
```
Causa: Timeout de SSE (servidor cierra conexi√≥n)
Soluci√≥n: Enviar "heartbeat" cada 15 segundos desde backend
```

### "Error: Tienda Nube API 401"
```
Causa: Token expirado o inv√°lido
Soluci√≥n: Re-autenticar Tienda Nube en Settings
```

### "No se generan im√°genes"
```
Causa: Google API key faltante o quota excedida
Soluci√≥n: Configurar credencial 'google' en Vault
```

### "RAG vectorization falla"
```
Causa: Supabase URL incorrecta o pgvector no habilitado
Soluci√≥n: Verificar SUPABASE_DB_URL y extensi√≥n pgvector
```

## 10. Checklist de Implementaci√≥n

### Frontend
- [ ] Bot√≥n "Hacer Magia" funcional
- [ ] SSE listener conectado
- [ ] Progress bar actualizada en tiempo real
- [ ] Log console visible
- [ ] Redirecci√≥n a Forge al completar
- [ ] Error handling (stream disconnect)

### Backend
- [ ] Background task ejecut√°ndose
- [ ] SSE endpoint con Redis pubsub
- [ ] 7 agentes implementados
- [ ] Assets guardados en business_assets
- [ ] Validaci√≥n de prerequisites
- [ ] Broadcast de eventos correcto

### Credenciales Requeridas
- [ ] Tienda Nube (access_token + user_id)
- [ ] OpenAI (API key)
- [ ] Google (API key para Imagen 3)
- [ ] Supabase (DB URL para RAG)

---

**Tip**: Para debugging, usar Redis CLI para monitorear mensajes: `SUBSCRIBE magic_progress:*`
````

## File: .agent/skills/Maintenance_Robot_Architect/SKILL.md
````markdown
---
name: Maintenance Robot Architect
description: Especialista en la actualizaci√≥n del sistema de auto-migraci√≥n "Maintenance Robot" en orchestrator_service/db.py.
---

# Maintenance Robot Architect

Este Skill instruye al agente sobre c√≥mo modificar, extender y mantener el sistema de inicializaci√≥n y evoluci√≥n de base de datos automatizado, conocido como "Maintenance Robot". Dicho sistema reside en `orchestrator_service/db.py`.

## Prop√≥sito

Asegurar que **CADA NUEVO DESPLIEGUE** en un entorno limpio nazca funcional y que las **BASES EXISTENTES** se actualicen sin intervenci√≥n humana:
1.  **Foundation**: Creaci√≥n de tablas base si no existen.
2.  **Evolution**: Aplicaci√≥n de parches quir√∫rgicos para nuevas features.
3.  **Idempotencia**: Garantizar que el servicio pueda reiniciar infinitas veces sin errores.

## Reglas de Oro (Protocolo Omega)

1.  **Idempotencia Absoluta**:
    *   Toda alteraci√≥n de columna o tabla debe usar bloques `DO $$ ... END $$` con cl√°usulas `IF NOT EXISTS` sobre `information_schema`.
    *   NUNCA uses `ALTER TABLE` directo sin verificaci√≥n previa en el parche.

2.  **Ubicaci√≥n de la L√≥gica**:
    *   La evoluci√≥n vive en el m√©todo `_run_evolution_pipeline` de `db.py`.
    *   Los parches se agregan como strings SQL a la lista `patches`.

3.  **No Modificar Patches Antiguos**:
    *   Los parches son hist√≥ricos. Agrega siempre al final de la lista.
    *   Solo se modifican si rompen el arranque por error de sintaxis grave.

4.  **Smart SQL Splitting**:
    *   El motor en `db.py` ya maneja el split por `;` respetando bloques `$$`. 
    *   Aseg√∫rate de que cada parche termine en `;` y use `$$` para envolver bloques an√≥nimos.

## Gu√≠a de Implementaci√≥n

### 1. Agregar una nueva columna/feature
Cuando el c√≥digo requiera un cambio en la BD, a√±ade un parche a la lista en `db.py`:

```python
    # Parche N: [Descripci√≥n]
    """
    DO $$ 
    BEGIN 
        IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='appointments' AND column_name='ai_notes') THEN
            ALTER TABLE appointments ADD COLUMN ai_notes TEXT;
        END IF;
    END $$;
    """
```

### 2. Sincronizaci√≥n del Foundation
Si el cambio es permanente para nuevos usuarios, actualiza tambi√©n `db/init/dentalogic_schema.sql` y corre `./sync-schema.ps1` para que las nuevas instalaciones tengan la estructura final desde el inicio.

## Casos de Uso
- **Nuevas Tablas**: Usar `CREATE TABLE IF NOT EXISTS`.
- **Nuevos √çndices**: Usar `CREATE INDEX IF NOT EXISTS`.
- **Nuevas Columnas**: Usar el bloque `DO` con el `ALTER TABLE` interno.
- **Seeds de Configuraci√≥n**: Usar `INSERT ... ON CONFLICT DO NOTHING`.
````

## File: .agent/skills/Meta_Integration_Diplomat/SKILL.md
````markdown
---
name: "Meta Integration Diplomat"
description: "Especialista en OAuth Meta (Facebook, Instagram, WhatsApp Business) y gesti√≥n de activos de negocio."
trigger: "meta, facebook, instagram, whatsapp, oauth, integration, waba, pages"
scope: "INTEGRATIONS"
auto-invoke: true
---

# Meta Integration Diplomat - Dentalogic

## 1. El Protocolo "Meta Diplomat"

### Concepto
La integraci√≥n con Meta **NO es simple OAuth**. Es una **Vinculaci√≥n de Activos de Negocio** (Business Assets) que conecta:
- **Facebook Pages** ‚Üí P√°ginas de negocio (Graph API)
- **Instagram Accounts** ‚Üí Cuentas comerciales (Graph API)
- **WhatsApp Business Accounts (WABA)** ‚Üí N√∫meros de tel√©fono (WhatsApp Cloud API) -> *Protocolo diferente*

### Arquitectura
```
Frontend (MetaSettings.tsx)
    ‚Üì
FB SDK Loader ‚Üí FB.login() popup
    ‚Üì
Authorization Code (ef√≠mero)
    ‚Üì
POST /admin/meta/connect ‚Üí Backend Exchange
    ‚Üì
Long-Lived User Token (60 d√≠as)
    ‚Üì
Auto-Discovery (Pages, IG, WABA)
    ‚Üì
Wizard Selection ‚Üí Persist Assets
```

## 2. Frontend: SDK Loader

### useFacebookSdk Hook
```typescript
// hooks/useFacebookSdk.ts
import { useEffect, useState } from 'react';

export const useFacebookSdk = (configId: string) => {
  const [sdkLoaded, setSdkLoaded] = useState(false);
  
  useEffect(() => {
    // Inyectar script de Meta
    const script = document.createElement('script');
    script.src = 'https://connect.facebook.net/en_US/sdk.js';
    script.async = true;
    script.defer = true;
    
    script.onload = () => {
      window.FB.init({
        appId: configId,
        cookie: true,
        xfbml: true,
        version: 'v18.0'
      });
      setSdkLoaded(true);
    };
    
    document.body.appendChild(script);
  }, [configId]);
  
  return sdkLoaded;
};
```

### Environment Variable
```typescript
// .env
VITE_META_CONFIG_ID=123456789012345  // Meta App Config ID
```

## 3. OAuth Flow (Popup)

### Iniciar Conexi√≥n
```typescript
const connectMeta = () => {
  if (!window.FB) {
    alert('Meta SDK not loaded. Check ad-blocker.');
    return;
  }
  
  window.FB.login((response) => {
    if (response.authResponse) {
      // Usuario autoriz√≥
      const code = response.authResponse.code;
      handleMetaCallback(code);
    } else {
      // Usuario cancel√≥
      console.log('User cancelled login');
    }
  }, {
    config_id: VITE_META_CONFIG_ID,
    response_type: 'code',  // CR√çTICO: queremos code, no token
    override_default_response_type: true,
    scope: 'pages_show_list,instagram_basic,whatsapp_business_messaging'
  });
};
```

### Permisos Requeridos
- `pages_show_list`: Ver p√°ginas administradas
- `instagram_basic`: Acceso a cuentas IG Business
- `instagram_manage_messages`: Enviar/recibir mensajes IG
- `whatsapp_business_messaging`: Acceso a WABA
- `whatsapp_business_management`: Gestionar configuraci√≥n WABA

## 4. Backend: Token Exchange

### Endpoint de Conexi√≥n
```python
# orchestrator_service/app/api/v1/endpoints/integrations.py

@router.post("/meta/connect")
async def connect_meta(
    payload: MetaConnectRequest,
    current_user = Depends(verify_admin_token),
    session: AsyncSession = Depends(get_session)
):
    """
    Intercambia authorization code por Long-Lived Token
    y descubre activos disponibles
    """
    tenant_id = await resolve_tenant(current_user.id)
    
    # Validar redirect_uri
    if not payload.redirect_uri.startswith(ALLOWED_ORIGINS[0]):
        raise HTTPException(
            status_code=400,
            detail="Invalid redirect_uri"
        )
    
    # Llamar a meta_service para exchange
    response = await httpx.post(
        "http://meta_service:8002/connect",
        json={
            "code": payload.code,
            "redirect_uri": payload.redirect_uri,
            "tenant_id": tenant_id
        },
        headers={"X-Internal-Secret": INTERNAL_SECRET_KEY},
        timeout=30.0
    )
    
    if response.status_code != 200:
        raise HTTPException(
            status_code=response.status_code,
            detail=response.json().get('detail', 'Meta connection failed')
        )
    
    data = response.json()
    
    return {
        "status": "success",
        "assets": data.get("assets", {}),
        "connected": {
            "facebook": bool(data.get("assets", {}).get("pages")),
            "instagram": bool(data.get("assets", {}).get("instagram")),
            "whatsapp": bool(data.get("assets", {}).get("whatsapp"))
        }
    }
```


    # ...

### üõ†Ô∏è Omnichannel Routing v6.1 (Triangular)
A partir de v6.1, el Orchestrator centraliza el ruteo. 
- **Meta Direct**: Prioridad si hay tokens de Meta.
- **Chatwoot**: Gateway secundario para FB/IG si IDs est√°n presentes.
- **YCloud**: Gateway exclusivo para WhatsApp.

Toda comunicaci√≥n hacia FB/IG/WA debe pasar por `unified_message_delivery` en el Orchestrator.

## 5. Meta Service: Token Exchange & Discovery


### Exchange Code por Token
```python
# meta_service/main.py

@app.post("/connect")
async def exchange_code(
    payload: ConnectRequest,
    x_internal_secret: str = Header(None)
):
    # Validar secret interno
    if x_internal_secret != INTERNAL_SECRET_KEY:
        raise HTTPException(status_code=403, detail="Forbidden")
    
    # Exchange code por access_token
    token_response = requests.post(
        "https://graph.facebook.com/v18.0/oauth/access_token",
        params={
            "client_id": META_APP_ID,
            "client_secret": META_APP_SECRET,
            "code": payload.code,
            "redirect_uri": payload.redirect_uri
        }
    )
    
    if token_response.status_code != 200:
        raise HTTPException(
            status_code=400,
            detail=f"Meta token exchange failed: {token_response.text}"
        )
    
    access_token = token_response.json()['access_token']
    
    # Convertir a Long-Lived Token (60 d√≠as)
    ll_response = requests.get(
        "https://graph.facebook.com/v18.0/oauth/access_token",
        params={
            "grant_type": "fb_exchange_token",
            "client_id": META_APP_ID,
            "client_secret": META_APP_SECRET,
            "fb_exchange_token": access_token
        }
    )
    
    long_lived_token = ll_response.json()['access_token']
    
    # Auto-Discovery de activos
    assets = await discover_assets(long_lived_token)
    
    # Guardar token en Orchestrator Vault
    await save_to_vault(
        tenant_id=payload.tenant_id,
        token=long_lived_token,
        assets=assets
    )
    
    return {"status": "success", "assets": assets}
```

### Auto-Discovery
```python
async def discover_assets(access_token: str) -> dict:
    """
    Descubre autom√°ticamente Pages, Instagram, WABA
    """
    # 1. Obtener User ID
    me_response = requests.get(
        "https://graph.facebook.com/v18.0/me",
        params={"access_token": access_token}
    )
    user_id = me_response.json()['id']
    
    # 2. P√°ginas administradas
    pages_response = requests.get(
        f"https://graph.facebook.com/v18.0/{user_id}/accounts",
        params={
            "access_token": access_token,
            "fields": "id,name,access_token,category"
        }
    )
    pages = pages_response.json().get('data', [])
    
    # 3. Instagram Business Accounts (vinculadas a Pages)
    instagram_accounts = []
    for page in pages:
        ig_response = requests.get(
            f"https://graph.facebook.com/v18.0/{page['id']}",
            params={
                "access_token": access_token,
                "fields": "instagram_business_account"
            }
        )
        if 'instagram_business_account' in ig_response.json():
            ig_id = ig_response.json()['instagram_business_account']['id']
            instagram_accounts.append({
                "id": ig_id,
                "page_id": page['id'],
                "page_name": page['name']
            })
    
    # 4. WhatsApp Business Accounts
    waba_response = requests.get(
        f"https://graph.facebook.com/v18.0/{user_id}/businesses",
        params={
            "access_token": access_token,
            "fields": "owned_whatsapp_business_accounts{id,name,phone_numbers}"
        }
    )
    
    whatsapp_accounts = []
    businesses = waba_response.json().get('data', [])
    for business in businesses:
        wabas = business.get('owned_whatsapp_business_accounts', {}).get('data', [])
        for waba in wabas:
            whatsapp_accounts.append({
                "id": waba['id'],
                "name": waba.get('name', 'Unknown'),
                "phone_numbers": waba.get('phone_numbers', [])
            })
    
    return {
        "pages": pages,
        "instagram": instagram_accounts,
        "whatsapp": whatsapp_accounts
    }
```

## 6. Wizard de Selecci√≥n (Frontend)

### MetaOnboardingWizard Component
```tsx
interface MetaOnboardingWizardProps {
  assets: DiscoveredAssets;
  onComplete: (selected: SelectedAssets) => void;
}

const MetaOnboardingWizard: React.FC<MetaOnboardingWizardProps> = ({
  assets,
  onComplete
}) => {
  const [selectedPage, setSelectedPage] = useState<string | null>(null);
  const [selectedIG, setSelectedIG] = useState<string | null>(null);
  const [selectedWABA, setSelectedWABA] = useState<string | null>(null);
  
  const handleSave = async () => {
    // Persistir selecci√≥n en backend
    await useApi({
      method: 'POST',
      url: '/admin/meta/configure',
      data: {
        page_id: selectedPage,
        instagram_account_id: selectedIG,
        waba_id: selectedWABA
      }
    });
    
    onComplete({
      page_id: selectedPage,
      instagram_id: selectedIG,
      waba_id: selectedWABA
    });
  };
  
  return (
    <div className="wizard">
      <h2>Select Your Business Assets</h2>
      
      {/* Pages */}
      <section>
        <h3>Facebook Pages</h3>
        {assets.pages.map(page => (
          <label key={page.id}>
            <input
              type="radio"
              name="page"
              value={page.id}
              onChange={() => setSelectedPage(page.id)}
            />
            {page.name}
          </label>
        ))}
      </section>
      
      {/* Similar para Instagram y WhatsApp */}
      
      <button onClick={handleSave}>Save Configuration</button>
    </div>
  );
};
```

## 7. Persistir Assets (Backend)

### Guardar en Tenants Table
```python
@router.post("/meta/configure")
async def configure_meta_assets(
    payload: MetaConfigureRequest,
    current_user = Depends(verify_admin_token),
    session: AsyncSession = Depends(get_session)
):
    tenant_id = await resolve_tenant(current_user.id)
    
    # Actualizar tenant con assets seleccionados
    stmt = update(Tenant).where(
        Tenant.id == tenant_id
    ).values(
        meta_page_id=payload.page_id,
        instagram_account_id=payload.instagram_account_id,
        whatsapp_business_account_id=payload.waba_id
    )
    
    await session.execute(stmt)
    await session.commit()
    
    return {"status": "configured"}
```

## 8. Estado "Connected" (UI)

### Verificar Conexi√≥n
```typescript
const checkMetaConnection = async () => {
  const status = await useApi<ConnectionStatus>({
    method: 'GET',
    url: '/admin/integrations/status'
  });
  
  return {
    facebook: status.meta_page_id != null,
    instagram: status.instagram_account_id != null,
    whatsapp: status.whatsapp_business_account_id != null
  };
};
```

### Indicadores Visuales
```tsx
const MetaStatus: React.FC = () => {
  const [status, setStatus] = useState<ConnectionStatus | null>(null);
  
  useEffect(() => {
    loadStatus();
  }, []);
  
  return (
    <div className="grid grid-cols-3 gap-4">
      {/* Facebook */}
      <div className={status?.facebook ? 'border-green-500' : 'border-gray-300'}>
        <Facebook size={32} />
        <span>{status?.facebook ? '‚úì Connected' : '‚óã Not Connected'}</span>
      </div>
      
      {/* Instagram */}
      <div className={status?.instagram ? 'border-pink-500' : 'border-gray-300'}>
        <Instagram size={32} />
        <span>{status?.instagram ? '‚úì Connected' : '‚óã Not Connected'}</span>
      </div>
      
      {/* WhatsApp */}
      <div className={status?.whatsapp ? 'border-green-500' : 'border-gray-300'}>
        <MessageCircle size={32} />
        <span>{status?.whatsapp ? '‚úì Connected' : '‚óã Not Connected'}</span>
      </div>
    </div>
  );
};
```

## 9. Redirect URI (Critical Configuration)

### Configuraci√≥n en Meta Developers
```
App Dashboard ‚Üí Settings ‚Üí Basic
Valid OAuth Redirect URIs:
  https://yourdomain.com/
  http://localhost:5173/ (desarrollo)
```

### Frontend Dynamic URI
```typescript
// DEBE coincidir EXACTAMENTE con lo configurado en Meta
const redirect_uri = `${window.location.origin}/`;

// Enviar al backend
await connectMeta(code, redirect_uri);
```

### Error Com√∫n
```
‚ùå Error: "Invalid Redirect URI"
Causa: La URI enviada no est√° en la whitelist de Meta

Soluci√≥n:
1. Verificar en Meta Developers
2. Asegurar NO trailing slash si no est√° configurado
3. window.location.origin + '/' debe coincidir
```

## 10. Troubleshooting

### "App not configured" en Popup
```
Causa: VITE_META_CONFIG_ID incorrecto
Soluci√≥n: Verificar en Meta Developers ‚Üí App Settings
```

### "SDK is undefined" (window.FB)
```
Causa: Ad-blocker bloque√≥ connect.facebook.net
Soluci√≥n: Desactivar ad-blocker o usar dominio whitelist
```

### "Permissions Missing" Error
```
Causa: Usuario desmarc√≥ permisos en popup
Soluci√≥n: Re-iniciar flujo y asegurar todos los permisos
```

### "OAuthException" en Backend
```
Causa: Token vencido o revocado
Soluci√≥n: Re-autenticar (Long-Lived Tokens duran 60 d√≠as)
```

### "No assets found" en Wizard
```
Causa: Usuario no tiene Pages/WABA creadas
Soluci√≥n: 
1. Crear Facebook Page
2. Vincular Instagram Business Account
3. Registrar WhatsApp Business Account
```

## 11. Security Best Practices

### Never Expose Tokens en Frontend
```typescript
// ‚ùå MAL - Token en localStorage
localStorage.setItem('meta_token', token);

// ‚úÖ BIEN - Solo en backend vault
await saveToVault(token);
```

### Validar X-Internal-Secret
```python
# En meta_service, SIEMPRE validar
if x_internal_secret != INTERNAL_SECRET_KEY:
    raise HTTPException(status_code=403)
```

## 12. Token Refresh Strategy

### Long-Lived Token Lifecycle
- **Duraci√≥n**: 60 d√≠as
- **Renovaci√≥n**: No auto-refresh, re-autenticar cuando expire
- **Monitoreo**: Guardar `expires_at` en credentials metadata

```python
# Al guardar token
metadata = {
    "expires_at": (datetime.utcnow() + timedelta(days=60)).isoformat(),
    "token_type": "long_lived"
}

cred = Credential(
    tenant_id=tenant_id,
    category="meta",
    value=encrypted_token,
    metadata=metadata
)
```

## 13. Checklist de Implementaci√≥n

### Frontend
- [ ] SDK Loader implementado (useFacebookSdk)
- [ ] Popup OAuth funcional (FB.login)
- [ ] Redirect URI correcto (window.location.origin + '/')
- [ ] Wizard de selecci√≥n de assets
- [ ] Indicadores visuales de conexi√≥n
- [ ] Manejo de errores (ad-blocker, cancel)

### Backend (Orchestrator)
- [ ] Endpoint /meta/connect
- [ ] Validaci√≥n de redirect_uri
- [ ] Comunicaci√≥n con meta_service
- [ ] Persistencia de assets en tenants table
- [ ] Status endpoint (/integrations/status)

### Backend (Meta Service)
- [ ] Token exchange (code ‚Üí access_token)
- [ ] Long-Lived Token conversion
- [ ] Auto-Discovery (Pages, IG, WABA)
- [ ] Vault injection
- [ ] X-Internal-Secret validation
- [ ] Error handling (Meta API failures)

---

**Tip**: Usar Meta's Graph API Explorer (developers.facebook.com/tools/explorer) para probar manualmente permisos y descubrimiento de assets.
````

## File: .agent/skills/Nexus_UI_Architect/SKILL.md
````markdown
---
name: Nexus UI Architect
description: Especialista en Dise√±o Responsivo (Mobile First / Desktop Adaptive) y UX para Dentalogic. Define el est√°ndar visual y estructural.
---

# üé® Nexus UI Architect

## Misi√≥n
Garantizar que cada vista de **Dentalogic** funcione perfectamente tanto en dispositivos m√≥viles (iPhone SE/14 Pro) como en monitores Desktop (1080p/4k), manteniendo la est√©tica "Premium Deep Tech" de Nexus.

## üõ†Ô∏è Herramientas y Stack
- **Framework**: React 18 + Vite.
- **Styling**: Tailwind CSS (Strict Utility-First).
- **Iconograf√≠a**: `lucide-react`.
- **Animaciones**: CSS Nativo (`animate-pulse`, `animate-fade-in`).

## üìê Estrategia de Dise√±o Responsivo

### 1. Mobile First (Base)
Dise√±amos pensando en pantallas verticales estrechas.
- **Container**: `w-full px-4`.
- **Tipograf√≠a**: Textos legibles (min 14px), H1 grandes pero ajustados.
- **Touch Targets**: Botones de m√≠nimo 44x44px.
- **Navegaci√≥n**: Men√∫ hamburguesa o Bottom Bar para mobile. Sidebar colapsable.

### 2. Puntos de Quiebre (Breakpoints)
- **`md:` (768px)**: Tablets. Pasar de 1 col a 2 cols.
- **`lg:` (1024px)**: Laptops. Mostrar Sidebar fija. Main Layout 3-5 cols.
- **`xl:` (1280px)**: Desktop. Layout espacioso.

### 3. Patrones Comunes de Adaptaci√≥n

#### Grillas
```tsx
// Mobile: 1 columna | Desktop: 4 columnas
<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
```

#### Elementos Ocultos
```tsx
// Solo visible en mobile
<div className="block lg:hidden">...</div>

// Solo visible en desktop
<div className="hidden lg:block">...</div>
```

#### Modales y Drawers
- **Mobile**: Full screen o Bottom Sheet.
- **Desktop**: Dialog centrado con backdrop blur.

## üìã Checklist de Auditor√≠a UI (Por P√°gina)

1.  **Overflow Horizontal**: Verificar que nada rompa el ancho de la pantalla en mobile. (`overflow-x-hidden` en root).
2.  **Alturas Fijas**: Evitar `h-screen` en mobile por las barras del navegador. Usar `dvh` o `min-h`.
3.  **Legibilidad**: Contraste suficiente en textos sobre fondos oscuros/glass.
4.  **Espaciado**: M√°rgenes laterales (`px-4` o `px-6`) para que el contenido no pegue al borde.
5.  **Interacci√≥n**: Estados `:hover` solo en desktop. `:active` para feedback t√°ctil en mobile.

## üíæ Snippets de Oro (Nexus Design System)

### Glass Card (Universal)
```tsx
<div className="bg-white/5 backdrop-blur-xl border border-white/10 rounded-2xl p-6 shadow-xl">
  ...
</div>
```

### Bot√≥n de Acci√≥n Principal (Responsive)
```tsx
<button className="w-full lg:w-auto bg-accent hover:bg-accent-hover text-white px-6 py-3 rounded-xl font-bold transition-all active:scale-95 shadow-lg shadow-accent/20">
  Acci√≥n
</button>
```

### Contenedor de P√°gina Est√°ndar
```tsx
<div className="min-h-screen bg-gray-900 text-white p-4 lg:p-8 overflow-x-hidden">
  <div className="max-w-7xl mx-auto">
     {/* Contenido */}
  </div>
</div>
```

## üö® Protocolo de Correcci√≥n
1.  **Analizar**: Abrir la vista y simular viewport mobile (375px).
2.  **Identificar Roturas**: Textos cortados, scroll horizontal indeseado, botones inalcanzables.
3.  **Aplicar Clases Utilitarias**: Usar `className` de Tailwind para corregir (`flex-col` en mobile, `flex-row` en desktop).
4.  **Verificar**: Probar en Desktop para asegurar que no se rompi√≥ la experiencia grande.
````

## File: .agent/skills/Omnichannel_Chat_Operator/SKILL.md
````markdown
---
name: "Omnichannel Chat Operator"
description: "Especialista en gesti√≥n de conversaciones v√≠a WhatsApp (YCloud) para Dentalogic."
trigger: "chats, conversaciones, mensajes, whatsapp, human override, handoff"
scope: "CHATS"
auto-invoke: true
---

# Omnichannel Chat Operator - Dentalogic

## 1. Arquitectura de Comunicaci√≥n (WhatsApp via YCloud)
Dentalogic centraliza toda la comunicaci√≥n en WhatsApp utilizando el proveedor **YCloud**.

### Flujo de Recepci√≥n:
1. **YCloud**: Env√≠a Webhook a `whatsapp_service/webhook/ycloud`.
2. **Validaci√≥n**: HMAC-SHA256 usando `YCLOUD_WEBHOOK_SECRET`.
3. **Forwarding**: El `whatsapp_service` limpia el payload y lo env√≠a al orquestador.

## 2. Gesti√≥n de Human Handoff (Intervenci√≥n Humana)
La IA detecta autom√°ticamente cu√°ndo un paciente pide hablar con una persona o si la situaci√≥n es cr√≠tica.

### Token de Activaci√≥n:
`HUMAN_HANDOFF_REQUESTED`

Cuando el orquestador detecta este token en la respuesta de la IA:
1. Activa el "Chat Lock" (bloqueo de IA) por 24 horas.
2. Env√≠a una notificaci√≥n v√≠a email/notificaci√≥n administrativa.
3. El dashboard resalta la conversaci√≥n en rojo.

## 3. Seguridad de Webhooks
**REGLA DE ORO**: Nunca procesar un mensaje de WhatsApp sin validar su firma.

### Protocolo de Verificaci√≥n:
```python
# whatsapp_service/main.py
signed_payload = f"{timestamp}.{raw_body}"
expected = hmac.new(secret, signed_payload, hashlib.sha256).hexdigest()
if not hmac.compare_digest(expected, signature):
    raise HTTPException(401, "Invalid signature")
```

## 4. Env√≠o de Mensajes
Todas las respuestas de gesti√≥n manual desde el Dashboard deben enviarse v√≠a:
`POST /admin/whatsapp/send`

El orquestador se encarga de llamar al `ycloud_client.py` en el `whatsapp_service` para el env√≠o final.

## 5. Checklist de Operaci√≥n
- [ ] ¬øEl `YCLOUD_WEBHOOK_SECRET` est√° configurado correctamente en el entorno?
- [ ] ¬øEl triaje IA de "Gala" est√° activado en el orquestador?
- [ ] ¬øLas notificaciones de handoff est√°n configuradas para alertar al personal?
- [ ] ¬øEl Dashboard muestra los estados de entrega (sent, delivered, read) devueltos por YCloud?
````

## File: .agent/skills/Prompt_Architect/SKILL.md
````markdown
---
name: "AI Behavior Architect"
description: "Ingenier√≠a de prompts para los Agentes de Ventas, Soporte y Business Forge."
trigger: "Cuando edite system prompts, plantillas de agentes o l√≥gica de RAG."
scope: "AI_CORE"
auto-invoke: true
---

# AI Behavior Architect - Dentalogic (Protocolo "Gala")

## 1. Identidad y Tono (Asistente de Dra. Laura Delgado)
El agente es la **Asistente Virtual de la Dra. Laura Delgado**.
- **Tono**: Profesional, pero extremadamente c√°lido, humano y emp√°tico.
- **Voseo Argentino**: Usar voseo natural ("hola c√≥mo est√°s", "te cuento", "che f√≠jate").
- **Puntuaci√≥n Humana**: En las preguntas, us√° SOLAMENTE el signo de cierre `?` (no el de apertura `¬ø`). Esto hace que el chat se sienta mucho m√°s natural en WhatsApp.
- **Garant√≠a**: Siempre iniciar con el saludo oficial solicitado.

## 2. Protocolos de Triaje (Urgencias)
**REGLA DE ORO**: Si el paciente menciona "dolor", "accidente" o "sangrado", se debe activar `triage_urgency`.
- **Derivaci√≥n**: Si el nivel es `critical`, ofrecer derivaci√≥n inmediata a humano (`derivhumano`).
- **Empat√≠a**: Nunca sonar rob√≥tico ante el dolor del paciente.

## 3. Protocolo de Agendamiento
Seguir estrictamente este orden:
1. **Consulta**: ¬øQu√© tratamiento necesit√°s?
2. **Disponibilidad**: Ejecutar `check_availability` para la fecha solicitada.
3. **Propuesta**: Ofrecer hasta 3 slots espec√≠ficos.
4. **Confirmaci√≥n**: Pedir confirmaci√≥n expl√≠cita antes de ejecutar `book_appointment`.

## 4. Formato de Servicios
Cuando se use `list_services`, presentar la informaci√≥n de forma limpia:
- **Nombre del tratamiento**
- **Duraci√≥n estimada** (ej: 60 min)
- **Breve descripci√≥n** (opcional)

## 5. Salida para WhatsApp
- Evitar Markdown complejo.
- Usar emojis de forma profesional (ü¶∑, üóìÔ∏è, üè•).
- P√°rrafos cortos y directos.
````

## File: .agent/skills/Skill_Forge_Master/SKILL.md
````markdown
---
name: "Skill_Forge_Master"
description: "Arquitecto y generador de Skills. Define, estructura y registra nuevas capacidades para el agente Antigravity."
trigger: "crear skill, nueva habilidad, skill architect, forge skill, capability, nueva skill"
scope: "META"
auto-invoke: true
---

# Skill Forge Master - Dentalogic

## 1. Concepto: Meta-Cognici√≥n Estructurada

### Filosof√≠a
Una **Skill** no es solo c√≥digo; es un **paquete de conocimiento ejecutable**.
Este Master Skill act√∫a como la "f√°brica" que estandariza c√≥mo el agente aprende nuevas capacidades.

### Proceso de Forjado
1. **Analysis**: Entender qu√© problema resuelve la nueva skill.
2. **Definition**: Determinar scope, triggers y dependencias.
3. **Architecting**: Dise√±ar la estructura de datos y flujos necesarios.
4. **Generation**: Crear el archivo `SKILL.md` con las 10 secciones est√°ndar.
5. **Registration**: Inscribir la skill en `agents.md` para su descubrimiento.

## 2. Estructura Can√≥nica de una Skill

Toda nueva Skill DEBE seguir esta plantilla rigurosa:

### YAML Frontmatter
```yaml
---
name: "Nombre_De_La_Skill" (SnakeCase o PascalCase)
description: "Descripci√≥n concisa en espa√±ol de qu√© hace."
trigger: "palabras, clave, que, activan, la, skill" (lista separada por comas)
scope: "DOMINIO" (BACKEND, FRONTEND, DB, SECURITY, etc.)
auto-invoke: true (casi siempre true)
---
```

### Secciones Obligatorias (Markdown)

1. **Concepto**: Filosof√≠a y arquitectura de alto nivel (Diagramas ASCII).
2. **Modelo de Datos**: Tablas SQL, Schemas Pydantic/TypeScript.
3. **Frontend Implementation**: Componentes, Hooks, Estado.
4. **Backend Implementation**: Endpoints, Servicios, L√≥gica de Negocio.
5. **Integraciones**: APIs externas, Webhooks, Auth flows.
6. **Persistencia**: C√≥mo y d√≥nde se guardan los datos.
7. **Troubleshooting**: Errores comunes y soluciones (Causa -> Soluci√≥n).
8. **Security**: Best practices espec√≠ficas del dominio.
9. **Checklist de Implementaci√≥n**: Lista de tareas verificables.

## 3. Flujo de Generaci√≥n (The Forge Protocol)

### Fase 1: Entrevista de Requerimientos
El usuario pide "Crear una skill para X".
El Forge Master debe identificar:
- **Objetivo**: ¬øQu√© debe lograr?
- **Tecnolog√≠as**: ¬øQu√© APIs o librer√≠as usa?
- **Dependencias**: ¬øRequiere DB, Frontend, Backend o todo?

### Fase 2: Generaci√≥n del Artefacto
Crear el archivo en `.agent/skills/[Skill_Name]/SKILL.md`.

**Reglas de Oro de Generaci√≥n:**
- **Idioma**: Espa√±ol t√©cnico.
- **Formato**: Markdown estricto (headers, code blocks).
- **C√≥digo**: Incluir snippets realistas y funcionales (no placeholders vagos).
- **Rigor**: No omitir secciones. Si no aplica, explicar por qu√©.

### Fase 3: Registro en el Cerebro
Actualizar `.agent/agents.md` agregando la nueva skill en la tabla correspondiente:

```markdown
| **[Nombre_Skill](ruta)** | `triggers` | Descripci√≥n corta |
```

## 4. Ejemplo: "Discount Engine Specialist"

Si el usuario pide una skill para manejar descuentos:

1. **Analizar**: Necesita DB (tablas descuentos), Backend (c√°lculo de precio), Frontend (UI de cupones).
2. **Estructurar**:
   - `discounts` table (code, type, value, valid_until).
   - `apply_discount` service logic.
   - `CartSummary` component update.
3. **Generar**: Escribir `SKILL.md` completo.
4. **Registrar**: Agregar a `agents.md` bajo "Commerce & Integrations".

## 5. Troubleshooting (Meta-Errores)

### "La skill no se activa"
- **Causa**: Triggers mal definidos o no agregada a `agents.md`.
- **Soluci√≥n**: Revisar YAML frontmatter y entrada en `agents.md`.

### "El agente alucina c√≥digo viejo"
- **Causa**: La skill no define claramente los est√°ndares nuevos (ej: usar `useApi` en vez de `fetch`).
- **Soluci√≥n**: Reforzar la secci√≥n de "Anti-Patrones" o "Implementation" en la Skill.

### "Skill demasiado gen√©rica"
- **Causa**: Falta de detalle en la secci√≥n de "Backend/Frontend Implementation".
- **Soluci√≥n**: Re-generar la skill incluyendo nombres de tablas y funciones exactas del proyecto.

## 6. Checklist de Creaci√≥n

- [ ] Carpeta creada: `.agent/skills/[Nombre]/`
- [ ] Archivo `SKILL.md` creado
- [ ] Frontmatter YAML v√°lido
- [ ] 10 Secciones completas
- [ ] C√≥digo de ejemplo verificado con `.antigravity_rules`
- [ ] Registrada en `.agent/agents.md`
- [ ] Usuario notificado

---

**Tip**: Una buena Skill no solo dice *qu√©* hacer, sino *c√≥mo* hacerlo siguiendo la arquitectura soberana del proyecto.
````

## File: .agent/skills/Skill_Sync/SKILL.md
````markdown
---
name: "Skill Synchronizer"
description: "Lee los metadatos de todas las skills y actualiza el √≠ndice en AGENTS.md."
trigger: "Despu√©s de crear o modificar una skill, o cuando el usuario diga 'sincronizar skills'."
scope: "SYSTEM"
auto-invoke: true
---

# Protocolo de Sincronizaci√≥n de Skills

Tu objetivo es mantener el `AGENTS.md` actualizado con un √≠ndice vivo de capacidades.

## 1. Escaneo de Skills
1.  Busca recursivamente en `.agent/skills/`.
2.  Para cada carpeta, lee el archivo `SKILL.md`.
3.  Extrae el bloque YAML (Frontmatter) para obtener: `name`, `description` y `trigger`.

## 2. Generaci√≥n del √çndice
Formatea la informaci√≥n extra√≠da en una tabla Markdown:

| Skill Name | Trigger | Descripci√≥n |
| :--- | :--- | :--- |
| **Sovereign Backend** | *Backend, API, DB* | Experto en FastAPI y Credenciales. |
| **Nexus UI** | *Frontend, React* | Componentes visuales y Hooks. |

## 3. Inyecci√≥n Quir√∫rgica
1.  Lee el archivo `AGENTS.md` en la ra√≠z.
2.  Busca la secci√≥n `## 5. Available Skills Index`.
    - Si no existe, cr√©ala al final del archivo.
3.  Reemplaza **solo** el contenido de esa secci√≥n con la nueva tabla generada.
4.  **IMPORTANTE:** No toques ninguna otra secci√≥n del archivo (Project Identity, Architecture, etc.).

## 4. Confirmaci√≥n
Al finalizar, responde: *"‚úÖ √çndice de Skills sincronizado. [N] habilidades detectadas."*
````

## File: .agent/skills/Sovereign_Auditor/SKILL.md
````markdown
---
name: "Sovereign Code Auditor"
description: "Experto en ciberseguridad y cumplimiento del Protocolo de Soberan√≠a Nexus."
trigger: "Antes de hacer commit, o cuando pida revisar seguridad o aislamiento."
scope: "SECURITY"
auto-invoke: false
---

# Protocolo de Auditor√≠a Soberana

Tu trabajo es encontrar grietas en el aislamiento Multi-Tenant.

1. **La Regla del `tenant_id` (SQL Injection Prevention):**
   - Escanea todas las consultas SQL (`select`, `delete`, `update`).
   - üö® **ALERTA ROJA:** Si ves `where(Model.id == id)` sin acompa√±amiento.
   - ‚úÖ **CORRECCI√ìN:** Debe ser `where(Model.id == id, Model.tenant_id == tenant_id)`.

2. **Detecci√≥n de Fugas de Credenciales:**
   - Busca patrones como `os.getenv("OPENAI_API_KEY")` en el c√≥digo de negocio.
   - Eso est√° **PROHIBIDO**. El c√≥digo debe fallar si no hay llave en la DB (`credentials` table).

3. **Validaci√≥n de Tipos de Identidad:**
   - En Nexus v6, `User.id` es UUID y `Tenant.id` es INTEGER.
   - Si ves c√≥digo que intenta comparar `user.tenant_id` (int) con un string UUID, bloqu√©alo.

4. **Sanitizaci√≥n de Logs:**
   - Verifica que ning√∫n `print()` o `logger.info()` est√© imprimiendo objetos `credential` completos. Los valores deben estar enmascarados (`***`).
````

## File: .agent/skills/Spec_Architect/SKILL.md
````markdown
---
name: "Spec Architect"
description: "Genera y valida archivos de especificaci√≥n (.spec.md) siguiendo el est√°ndar SDD v2.0."
trigger: "Cuando el usuario diga 'crea una especificaci√≥n', 'planifica esta feature' o use el comando '/specify'."
scope: "PLANNING"
auto-invoke: false
---

# Protocolo de Arquitectura de Especificaciones (SDD v2.0)

Tu objetivo es eliminar la ambig√ºedad. No escribes c√≥digo; escribes el *plano* del c√≥digo.

## 1. Fase de Generaci√≥n (/specify)

Cuando el usuario describe una funcionalidad, genera un archivo en `specs/` (cr√©ala si no existe) con el nombre `YYYY-MM-DD_nombre-feature.spec.md`.

**Plantilla Maestra Obligatoria:**

```markdown
# [Nombre del Feature]

## 1. Contexto y Objetivos
- **Problema:** [Descripci√≥n del dolor]
- **Soluci√≥n:** [Descripci√≥n de la funcionalidad]
- **KPIs:** [C√≥mo medimos el √©xito]

## 2. Esquemas de Datos
- **Entradas:** [JSON Schema o Interface TS]
- **Salidas:** [JSON Schema o Interface TS]
- **Persistencia:** [Cambios en DB: Tablas, Columnas, Tipos]

## 3. L√≥gica de Negocio (Invariantes)
- SI [Condici√≥n A] ENTONCES [Resultado B]
- RESTRICCI√ìN: [Regla de seguridad o negocio inviolable]

## 4. Stack y Restricciones
- **Tecnolog√≠a:** [Librer√≠as espec√≠ficas, versiones]
- **Soberan√≠a:** [C√≥mo se garantiza el aislamiento del tenant]

## 5. Criterios de Aceptaci√≥n (Gherkin)
- **Escenario 1:**
  - DADO que [Precondici√≥n]
  - CUANDO [Acci√≥n]
  - ENTONCES [Resultado esperado]
```

## 2. Fase de Refinamiento (/refine)

Antes de dar por buena una especificaci√≥n:

1. **Analiza**: ¬øHay ambig√ºedades? ¬øFaltan casos borde?
2. **Cuestiona**: Pregunta al usuario sobre detalles t√©cnicos no definidos (ej. "¬øQu√© pasa si la API externa falla?").
3. **Valida**: Asegura que cumple con `AGENTS.md` (Protocolo Soberano).

## 3. Fase de Auditor√≠a (/audit)

Si el usuario pide auditar una implementaci√≥n contra su spec:

1. Lee el archivo `.spec.md`.
2. Lee el c√≥digo implementado.
3. Reporta desviaciones ("Spec Drift"):
   - "El c√≥digo usa `float` pero la spec ped√≠a `decimal`."
   - "Falta la validaci√≥n de seguridad definida en la secci√≥n 3."

## 4. Reglas de Oro

1. **La Spec es Ley**: Si el c√≥digo contradice la spec, el c√≥digo est√° mal (o la spec debe actualizarse expl√≠citamente).
2. **Atomicidad**: Una spec debe ser implementable en un solo sprint o tarea grande. Si es muy grande, div√≠dela.
3. **Trazabilidad**: Cada spec debe referenciar el issue/ticket que la origin√≥.
4. **Versionado**: Si una spec cambia, crea una nueva versi√≥n (ej. `v2_nombre-feature.spec.md`) y marca la anterior como `[DEPRECATED]`.

## 5. Comandos Disponibles

### `/specify [idea]`
Genera una nueva especificaci√≥n a partir de una idea vaga.

**Ejemplo**:
```
Usuario: /specify sistema de notificaciones push
Antigravity: [Genera specs/2026-01-27_push-notifications.spec.md]
```

### `/refine [spec_file]`
Revisa una especificaci√≥n existente y sugiere mejoras.

**Ejemplo**:
```
Usuario: /refine specs/2026-01-27_push-notifications.spec.md
Antigravity: [Analiza y pregunta sobre casos borde]
```

### `/audit [spec_file] [code_files]`
Compara la implementaci√≥n contra la especificaci√≥n.

**Ejemplo**:
```
Usuario: /audit specs/2026-01-27_push-notifications.spec.md orchestrator_service/notifications.py
Antigravity: [Reporta desviaciones]
```

## 6. Integraci√≥n con el Flujo de Trabajo

1. **Antes de codificar**: Siempre genera una spec con `/specify`.
2. **Durante el desarrollo**: Si encuentras ambig√ºedades, actualiza la spec (no el c√≥digo).
3. **Despu√©s de implementar**: Ejecuta `/audit` para validar que cumpliste la spec.
4. **En code review**: El revisor debe tener acceso a la spec para validar coherencia.

## 7. Ejemplo Completo

**Usuario dice**: "Necesito un sistema para que los agentes puedan pausar conversaciones temporalmente"

**Antigravity genera**: `specs/2026-01-27_conversation-pause.spec.md`

```markdown
# Sistema de Pausa de Conversaciones

## 1. Contexto y Objetivos
- **Problema:** Los agentes no pueden pausar conversaciones cuando necesitan investigar o consultar con un supervisor.
- **Soluci√≥n:** Agregar un bot√≥n "Pausar" que congela la conversaci√≥n por un tiempo definido.
- **KPIs:** Reducir tiempo de respuesta en casos complejos en 30%.

## 2. Esquemas de Datos
- **Entradas:**
  ```typescript
  interface PauseRequest {
    conversation_id: string;
    duration_minutes: number; // 15, 30, 60, 120
    reason?: string;
  }
  ```
- **Salidas:**
  ```typescript
  interface PauseResponse {
    paused_until: string; // ISO 8601
    status: "paused" | "active";
  }
  ```
- **Persistencia:**
  - Tabla: `chat_conversations`
  - Nueva columna: `paused_until TIMESTAMPTZ NULL`
  - Nueva columna: `pause_reason TEXT NULL`

## 3. L√≥gica de Negocio (Invariantes)
- SI `paused_until > NOW()` ENTONCES el agente IA NO debe responder.
- SI `paused_until <= NOW()` ENTONCES reactivar autom√°ticamente.
- RESTRICCI√ìN: Solo el agente humano que paus√≥ puede despausar manualmente.

## 4. Stack y Restricciones
- **Tecnolog√≠a:** PostgreSQL TIMESTAMPTZ, React useState para UI.
- **Soberan√≠a:** La pausa es por conversaci√≥n, no afecta a otros tenants.

## 5. Criterios de Aceptaci√≥n (Gherkin)
- **Escenario 1: Pausar conversaci√≥n**
  - DADO que soy un agente humano en una conversaci√≥n activa
  - CUANDO hago clic en "Pausar por 30 min"
  - ENTONCES la conversaci√≥n se marca como pausada hasta dentro de 30 minutos
  - Y el agente IA no responde durante ese per√≠odo

- **Escenario 2: Reactivaci√≥n autom√°tica**
  - DADO que una conversaci√≥n est√° pausada hasta las 14:00
  - CUANDO el reloj marca las 14:01
  - ENTONCES la conversaci√≥n se reactiva autom√°ticamente
  - Y el agente IA puede volver a responder
```

---

**Nota**: Esta skill trabaja en conjunto con `/plan` (genera el plan de implementaci√≥n) y `/implement` (ejecuta el c√≥digo).
````

## File: .agent/skills/Template_Transplant_Specialist/SKILL.md
````markdown
---
name: Template Transplant Specialist
description: Extrae y distribuye instrucciones de un system prompt legacy en las capas correctas (Wizard, Tool Config, Sistema Interno).
---

# üß¨ Template Transplant Specialist

## Prop√≥sito

Esta skill te permite **extraer system prompts de proyectos legacy** y distribuirlos correctamente en la arquitectura multi-capa de Dentalogic:

1. **Wizard** (configuraci√≥n del agente en el frontend)
2. **Tool Config** (instrucciones t√°cticas y gu√≠as de respuesta por herramienta)
3. **Interno** (reglas de sistema no editables)

## Cu√°ndo Usar Esta Skill

- Tienes un system prompt legacy de otro proyecto (ej: Pointe Coach, E-commerce Bot)
- Necesitas integrarlo en Dentalogic manteniendo su esencia
- Quieres asegurar que las instrucciones est√©n en los lugares correctos

## Proceso de Trasplante

### Paso 1: An√°lisis del System Prompt

Lee el system prompt completo del proyecto legacy y identifica las 3 capas:

#### üìã WIZARD (Editable por Usuario)
Campos que van en `orchestrator_service/app/api/agents.py` ‚Üí `AGENT_TEMPLATES`:

- **business_name**: Nombre de la tienda/negocio
- **business_context**: Descripci√≥n del rubro
- **tone_and_personality**: Estilo de comunicaci√≥n (tono, puntuaci√≥n, voseo, etc.)
- **synonym_dictionary**: Diccionario de sin√≥nimos (mapeo de t√©rminos informales a categor√≠as base)
- **business_rules**: Reglas de negocio espec√≠ficas (derivaciones, pol√≠ticas, env√≠os, fitting, etc.)
- **catalog_knowledge**: Mapa de categor√≠as y estructura del cat√°logo
- **store_website**: URL de la  tienda

#### üîß TOOL CONFIG (Por Herramienta)
Instrucciones por tool en `orchestrator_service/main.py` ‚Üí `tactical_injections` + `response_guides`:

Para cada herramienta, extra√©:
- **T√°ctica**: Reglas de CU√ÅNDO y C√ìMO usar la tool (gatillos, validaciones, mapeos)
- **Gu√≠a de Respuesta**: Reglas de C√ìMO formatear la salida (estructura, CTAs, limitaciones)

Herramientas t√≠picas:
- `search_specific_products`
- `browse_general_storefront`
- `search_by_category`
- `derivhumano`
- `orders`
- `cupones_list`
- `search_knowledge_base`
- `sendemail`

#### ‚öôÔ∏è INTERNO (Sistema - Hardcoded)
Reglas que van en el core del system prompt (no editables por el usuario):

- **PRIORIDADES**: Orden de ejecuci√≥n (JSON Output, Veracidad, Anti-Repetici√≥n, Anti-Bucle)
- **REGLA DE VERACIDAD**: Prohibiciones de inventar datos (precios, stock, links)
- **REGLAS DE CONTENIDO**: Formato de texto (prohibido markdown, URLs limpias, etc.)
- **FORMAT INSTRUCTIONS**: Esquema JSON de salida

### Paso 2: Extracci√≥n Textual

Cre√° un documento `.md` con la distribuci√≥n extra√≠da:

```markdown
# üé® WIZARD

### business_name
[TEXTO EXTRA√çDO]

### tone_and_personality
[TEXTO EXTRA√çDO]

...

# üîß TOOL CONFIG

### search_specific_products

**T√ÅCTICA:**
[TEXTO EXTRA√çDO]

**GU√çA DE RESPUESTA:**
[TEXTO EXTRA√çDO]

...

# ‚öôÔ∏è INTERNO

### PRIORIDADES
[TEXTO EXTRA√çDO]

...
```

Guard√° este documento en `docs/plantilla_[nombre_proyecto].md`.

### Paso 3: Integraci√≥n en el C√≥digo

#### Opci√≥n A: Hardcoded Template (Legacy/Fallback)

Edit√° `orchestrator_service/app/api/agents.py`:

```python
AGENT_TEMPLATES = {
    "sales": {
        "defaultValue": {
            "agent_name": "[business_name extra√≠do]",
            "agent_tone": "[tone_and_personality extra√≠do]",
            "synonym_dictionary": "[synonym_dictionary extra√≠do]",
            "business_rules": "[business_rules extra√≠do]",
            "catalog_knowledge": "[catalog_knowledge extra√≠do]",
            "store_website": "[store_website extra√≠do]"
        }
    }
}
```

#### Opci√≥n B: Database Template (Recomendado - v7.2+)

Insert√° el template directamente en la base de datos para que sea din√°mico y global:

```sql
INSERT INTO agents (
    name, role, system_prompt_template, config, enabled_tools, 
    is_template, tenant_id, is_active
) VALUES (
    'Nombre del Template', 
    'sales', 
    'Eres un asistente virtual de...', -- Prompt Base
    '{
        "agent_name": "...",
        "agent_tone": "...", 
        "business_rules": "...",
        "synonym_dictionary": "...",
        "store_description": "..."
    }'::jsonb,
    '["search_specific_products", "search_by_category", "orders"]'::jsonb,
    TRUE, -- Marcado como Template
    NULL, -- NULL = Global (Visible para todos)
    FALSE -- Inactivo por defecto
);
```

> [!IMPORTANT]
> Los templates en DB aparecen autom√°ticamente en el Wizard. El Orchestrator los identifica por `is_template = TRUE`. Si `tenant_id` es `NULL`, la plantilla es **Global**.

#### B. Actualizar Tool Instructions

Edit√° `orchestrator_service/main.py`:

```python
tactical_injections = {
    "search_specific_products": """[T√ÅCTICA EXTRA√çDA COMPLETA]""",
    "derivhumano": """[T√ÅCTICA EXTRA√çDA COMPLETA]""",
    # ... resto de tools
}

response_guides = {
    "search_specific_products": """[GU√çA DE RESPUESTA EXTRA√çDA COMPLETA]""",
    "derivhumano": """[GU√çA DE RESPUESTA EXTRA√çDA COMPLETA]""",
    # ... resto de tools
}
```

### Paso 4: Verificaci√≥n

1. **Frontend**: Abr√≠ el Agent Wizard y verific√° que los campos est√©n pre-poblados
2. **Tool Modal**: Abr√≠ "Configurar Herramientas" y verific√° que las instrucciones aparezcan
3. **Chat Test**: Prob√° el agente con consultas t√≠picas del dominio

## Ejemplo Completo: Pointe Coach

Ver `docs/plantilla pointe coach example.md` para referencia completa.

### Extractos Clave

#### Wizard - Tono y Personalidad
```
**Estilo:** Habl√° como una compa√±era de danza experta. Us√° "vos", s√© c√°lida y emp√°tica.
**Puntuaci√≥n (ESTRICTO):** Us√° solo el signo de pregunta al final (`?`), nunca el de apertura (`¬ø`).
**Naturalidad:** Us√° frases puente como "Mir√°", "Te cuento", "Fijate", "Dale".
```

#### Tool Config - search_specific_products

**T√ÅCTICA:**
```
B√öSQUEDA INTELIGENTE: Si piden "Malla Negra", busca solo "Malla" (o "Leotardo") y filtra vos mismo si hay variantes en negro.

REGLA DE MAPEO: Antes de usar esta tool, compar√° la palabra con el Diccionario de Sin√≥nimos.

GATE: Usa `search_specific_products` SIEMPRE que pidan algo espec√≠fico.
```

**GU√çA DE RESPUESTA:**
```
OBJETIVO PRINCIPAL: Mostrar 3 OPCIONES si la tool devuelve suficientes resultados.

FORMATO DE PRESENTACI√ìN (WHATSAPP - LIMPIO):
Secuencia OBLIGATORIA: Intro -> Prod 1 -> Prod 2 -> Prod 3 -> CTA.

REGLA DE CALL TO ACTION:
- CASO 1 (SOLO ZAPATILLAS DE PUNTA): Ofrecer "Fitting"
- CASO 2 (MUCHOS PRODUCTOS): Link a la web
- CASO 3 (POCOS PRODUCTOS): Cierre de servicio
```

## Checklist de Integraci√≥n

- [ ] Documento de plantilla creado en `docs/plantilla_[proyecto].md`
- [ ] `AGENT_TEMPLATES` actualizado en `agents.py` con wizard defaults
- [ ] `tactical_injections` actualizado en `main.py` con t√°cticas completas
- [ ] `response_guides` actualizado en `main.py` con gu√≠as completas
- [ ] Wizard muestra campos pre-poblados
- [ ] Modal "Configurar Herramientas" muestra instrucciones
- [ ] Agente responde seg√∫n la personalidad y reglas del legacy

## Reglas de Oro

1. **COPIA TEXTUAL**: No resumas ni adaptes. Copia el texto EXACTO del legacy.
2. **RESPETA LA DISTRIBUCI√ìN**: Si una instrucci√≥n menciona "SIEMPRE" o es una regla cr√≠tica, va en Tool Config o Interno, NO en Wizard.
3. **M√ÅXIMA FIDELIDAD**: El objetivo es que el agente se comporte ID√âNTICAMENTE al legacy.
4. **DOCUMENTA TODO**: El archivo `.md` de plantilla es la fuente de verdad.

## Troubleshooting

### Problema: Las instrucciones no aparecen en el modal
**Causa**: El endpoint `/admin/tools` no est√° retornando `prompt_injection` y `response_guide`.  
**Soluci√≥n**: Verific√° que `admin_routes.py` ‚Üí `get_tools` est√© usando `SYSTEM_TOOL_INJECTIONS` y `SYSTEM_TOOL_RESPONSE_GUIDES`.

### Problema: El agente no sigue las reglas
**Causa**: Las instrucciones est√°n en el lugar equivocado (ej: reglas cr√≠ticas en Wizard en vez de Interno).  
**Soluci√≥n**: Revis√° la distribuci√≥n y movelas a la capa correcta.

### Problema: El tono no coincide con el legacy
**Causa**: `tone_and_personality` incompleto o gen√©rico.  
**Soluci√≥n**: Extra√© TODO el bloque de "TONO Y PERSONALIDAD" del legacy, incluyendo puntuaci√≥n, voseo, frases puente, y prohibiciones.

## Archivos Clave

| Archivo | Prop√≥sito |
|---------|-----------|
| `docs/plantilla_[proyecto].md` | **Fuente de verdad** del trasplante |
| `orchestrator_service/app/api/agents.py` | Wizard defaults (AGENT_TEMPLATES) |
| `orchestrator_service/main.py` | Tool instructions (tactical_injections + response_guides) |
| `orchestrator_service/admin_routes.py` | Endpoint que sirve las tools con sus instructions |
| `frontend_react/src/views/Stores.tsx` | Modal "Configurar Herramientas" |
````

## File: .agent/skills/Testing_Quality/SKILL.md
````markdown
---
name: "Nexus QA Engineer"
description: "Especialista en Pytest Asyncio y Vitest para arquitecturas aisladas."
trigger: "Cuando pida crear tests, probar una feature o corregir bugs."
scope: "QA"
auto-invoke: true
---

# Est√°ndar de Testing Nexus

1. **Backend Tests (Pytest Asyncio):**
   - **Mocking de B√≥veda:** Nunca uses credenciales reales. Mockea `app.core.credentials.get_decrypted_credential` para devolver una fake key `sk-test-123`.
   - **Database Fixtures:** Usa `conftest.py` para crear un `tenant` de prueba y un `user` de prueba al inicio de la sesi√≥n.
   - **Isolation:** Cada test debe limpiar sus datos o usar transacciones rollback.

2. **Frontend Tests (Vitest/RTL):**
   - **Mocking de useApi:** Los componentes nunca deben llamar al fetch real.
   - Testea que el componente maneje correctamente los estados de error `403 Forbidden` (Soberan√≠a denegada).

3. **Regla de "No Flakiness":**
   - Si un test depende de `Redis`, aseg√∫rate de que el contenedor de prueba est√© levantado o mockeado.
````

## File: .agent/skills/TiendaNube_Commerce_Bridge/SKILL.md
````markdown
---
name: "TiendaNube Commerce Bridge"
description: "Especialista en integraci√≥n con Tienda Nube: OAuth, sincronizaci√≥n de cat√°logo, √≥rdenes y gesti√≥n de productos."
trigger: "tiendanube, tienda nube, e-commerce, products, orders, oauth, catalog, store"
scope: "ECOMMERCE"
auto-invoke: true
---

# TiendaNube Commerce Bridge - Dentalogic

## 1. Concepto: E-Commerce Integration

### Filosof√≠a
Tienda Nube es la **fuente de verdad** para:
- **Cat√°logo de productos** (name, price, stock, variants)
- **√ìrdenes de cliente** (orders, fulfillment)
- **Informaci√≥n de tienda** (store name, currency, timezone)

### Flujo de Integraci√≥n
```
Frontend ‚Üí Redirect to TiendaNube OAuth
    ‚Üì
TiendaNube Authorization
    ‚Üì
Callback with code ‚Üí Backend Exchange
    ‚Üì
Access Token + User ID ‚Üí Vault
    ‚Üì
API Calls (Products, Orders)
```

## 2. OAuth Flow (Redirect-Based)

### App Configuration (Partners Dashboard)
```
App Name: Nexus AI Assistant
Redirect URI: https://yourdomain.com/auth/callback
Scopes: read_products, read_orders, write_products
```

### Frontend: Iniciar OAuth
```tsx
const TiendaNubeConnect: React.FC = () => {
  const handleConnect = () => {
    // Obtener tenant_id actual
    const tenantId = localStorage.getItem('tenant_id');
    
    // Construir URL de autorizaci√≥n
    const clientId = import.meta.env.VITE_TIENDANUBE_CLIENT_ID;
    const redirectUri = `${window.location.origin}/auth/callback`;
    
    const authUrl = new URL('https://www.tiendanube.com/apps/authorize/token');
    authUrl.searchParams.set('client_id', clientId);
    authUrl.searchParams.set('redirect_uri', redirectUri);
    authUrl.searchParams.set('state', tenantId);  // Para identificar tenant
    
    // Redirigir a TiendaNube
    window.location.href = authUrl.toString();
  };
  
  return (
    <button onClick={handleConnect} className="tn-connect-btn">
      Conectar Tienda Nube
    </button>
  );
};
```

### Frontend: Callback Handler
```tsx
// Route: /auth/callback
const TiendaNubeCallback: React.FC = () => {
  const [status, setStatus] = useState('processing');
  
  useEffect(() => {
    handleCallback();
  }, []);
  
  const handleCallback = async () => {
    // Extraer par√°metros de URL
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');
    const tenantId = params.get('state');
    
    if (!code) {
      setStatus('error');
      return;
    }
    
    try {
      // Enviar code al backend
      await useApi({
        method: 'POST',
        url: '/auth/tiendanube/exchange',
        data: {
          code,
          tenant_id: tenantId,
          redirect_uri: `${window.location.origin}/auth/callback`
        }
      });
      
      setStatus('success');
      
      // Redirigir a dashboard
      setTimeout(() => {
        navigate('/dashboard');
      }, 2000);
      
    } catch (error) {
      setStatus('error');
    }
  };
  
  return (
    <div className="callback-handler">
      {status === 'processing' && <p>Conectando con Tienda Nube...</p>}
      {status === 'success' && <p>‚úÖ Conexi√≥n exitosa!</p>}
      {status === 'error' && <p>‚ùå Error en la conexi√≥n</p>}
    </div>
  );
};
```

## 3. Backend: Token Exchange

### Exchange Endpoint
```python
# orchestrator_service/app/api/v1/endpoints/auth.py

@router.post("/auth/tiendanube/exchange")
async def exchange_tiendanube_code(
    payload: TiendaNubeExchange,
    session: AsyncSession = Depends(get_session)
):
    """
    Intercambia authorization code por access_token
    """
    # Validar redirect_uri
    if not payload.redirect_uri.startswith(ALLOWED_ORIGINS[0]):
        raise HTTPException(
            status_code=400,
            detail="Invalid redirect_uri"
        )
    
    # Exchange code por token
    response = requests.post(
        "https://www.tiendanube.com/apps/authorize/token",
        data={
            "client_id": TIENDANUBE_CLIENT_ID,
            "client_secret": TIENDANUBE_CLIENT_SECRET,
            "grant_type": "authorization_code",
            "code": payload.code
        }
    )
    
    if response.status_code != 200:
        raise HTTPException(
            status_code=400,
            detail=f"TiendaNube token exchange failed: {response.text}"
        )
    
    data = response.json()
    access_token = data['access_token']
    user_id = data['user_id']  # Store ID
    
    # Guardar en Vault
    await save_credential(
        tenant_id=payload.tenant_id,
        category="tiendanube",
        name="access_token",
        value=access_token,
        scope="tenant"
    )
    
    await save_credential(
        tenant_id=payload.tenant_id,
        category="tiendanube",
        name="user_id",
        value=str(user_id),
        scope="tenant"
    )
    
    # Actualizar tenant con store info
    await update_tenant_store_info(
        tenant_id=payload.tenant_id,
        user_id=user_id,
        access_token=access_token
    )
    
    return {
        "status": "connected",
        "store_id": user_id
    }
```

## 4. Sincronizaci√≥n de Cat√°logo

### Obtener Productos
```python
async def get_tiendanube_products(
    tenant_id: int,
    page: int = 1,
    per_page: int = 50
) -> List[dict]:
    """
    Obtiene productos de Tienda Nube
    """
    # Obtener credenciales
    access_token = await get_tenant_credential(
        tenant_id=tenant_id,
        category="tiendanube",
        name="access_token"
    )
    
    user_id = await get_tenant_credential(
        tenant_id=tenant_id,
        category="tiendanube",
        name="user_id"
    )
    
    if not access_token or not user_id:
        raise HTTPException(
            status_code=400,
            detail="TiendaNube not connected"
        )
    
    # Llamar API
    response = requests.get(
        f"https://api.tiendanube.com/v1/{user_id}/products",
        headers={
            "Authentication": f"bearer {access_token}",
            "User-Agent": "Nexus AI (contact@nexus.com)"
        },
        params={
            "page": page,
            "per_page": per_page,
            "published": "true"  # Solo productos publicados
        }
    )
    
    if response.status_code == 401:
        raise HTTPException(
            status_code=401,
            detail="TiendaNube token expired. Reconnect your store."
        )
    
    if response.status_code != 200:
        raise HTTPException(
            status_code=response.status_code,
            detail=f"TiendaNube API error: {response.text}"
        )
    
    products = response.json()
    
    return products
```

### Endpoint de Productos
```python
# orchestrator_service/app/api/v1/endpoints/products.py

@router.get("/admin/products")
async def list_products(
    current_user = Depends(verify_admin_token),
    page: int = 1,
    per_page: int = 50
):
    tenant_id = await resolve_tenant(current_user.id)
    
    # Obtener de TiendaNube
    products = await get_tiendanube_products(
        tenant_id=tenant_id,
        page=page,
        per_page=per_page
    )
    
    # Normalizar estructura
    normalized = [
        {
            "id": p['id'],
            "name": p['name']['es'],  # o idioma configurado
            "price": p['variants'][0]['price'] if p['variants'] else 0,
            "stock": sum(v.get('stock', 0) for v in p['variants']),
            "image_url": p['images'][0]['src'] if p['images'] else None,
            "category": p.get('categories', [{}])[0].get('name', {}).get('es'),
            "variants": [
                {
                    "id": v['id'],
                    "name": v.get('values', [{}])[0].get('es', 'Default'),
                    "price": v['price'],
                    "stock": v.get('stock', 0)
                }
                for v in p.get('variants', [])
            ]
        }
        for p in products
    ]
    
    return normalized
```

## 5. B√∫squeda de Productos (Agent Tool)

### search_products Tool
```python
# agent_service/main.py

from langchain.tools import tool

@tool
async def search_products(
    query: str,
    tenant_id: int,
    category: Optional[str] = None
) -> dict:
    """
    Busca productos en el cat√°logo de Tienda Nube.
    Usa este tool cuando el usuario pregunte por un producto espec√≠fico.
    
    Args:
        query: T√©rmino de b√∫squeda (ej: "zapatillas rojas")
        tenant_id: ID del tenant
        category: Filtro opcional de categor√≠a
    
    Returns:
        Lista de productos encontrados con precio y stock
    """
    # Obtener credenciales
    access_token = await get_tenant_credential(
        tenant_id=tenant_id,
        category="tiendanube",
        name="access_token"
    )
    
    user_id = await get_tenant_credential(
        tenant_id=tenant_id,
        category="tiendanube",
        name="user_id"
    )
    
    # Llamar API de b√∫squeda
    response = await httpx.get(
        f"https://api.tiendanube.com/v1/{user_id}/products",
        headers={"Authentication": f"bearer {access_token}"},
        params={
            "q": query,
            "per_page": 10,
            "published": "true"
        }
    )
    
    products = response.json()
    
    # Formatear para el agente
    results = []
    for p in products:
        results.append({
            "id": p['id'],
            "name": p['name']['es'],
            "price": f"${p['variants'][0]['price']}",
            "stock": "Disponible" if sum(v.get('stock', 0) for v in p['variants']) > 0 else "Sin stock",
            "url": p['permalink']
        })
    
    return {
        "found": len(results),
        "products": results
    }
```

## 6. Gesti√≥n de √ìrdenes

### Obtener √ìrdenes
```python
@router.get("/admin/orders")
async def list_orders(
    current_user = Depends(verify_admin_token),
    status: Optional[str] = None,  # 'open', 'closed', 'cancelled'
    page: int = 1
):
    tenant_id = await resolve_tenant(current_user.id)
    
    # Credenciales
    access_token = await get_tenant_credential(
        tenant_id=tenant_id,
        category="tiendanube",
        name="access_token"
    )
    
    user_id = await get_tenant_credential(
        tenant_id=tenant_id,
        category="tiendanube",
        name="user_id"
    )
    
    # Llamar API
    params = {"page": page, "per_page": 20}
    if status:
        params['status'] = status
    
    response = requests.get(
        f"https://api.tiendanube.com/v1/{user_id}/orders",
        headers={"Authentication": f"bearer {access_token}"},
        params=params
    )
    
    orders = response.json()
    
    # Normalizar
    return [
        {
            "id": o['id'],
            "number": o['number'],
            "status": o['status'],
            "total": o['total'],
            "currency": o['currency'],
            "customer_name": o['customer']['name'],
            "created_at": o['created_at'],
            "products": [
                {
                    "name": item['name'],
                    "quantity": item['quantity'],
                    "price": item['price']
                }
                for item in o['products']
            ]
        }
        for o in orders
    ]
```

## 7. Crear Producto (Write Permission)

### create_product Endpoint
```python
@router.post("/admin/products", status_code=201)
async def create_product(
    payload: ProductCreate,
    current_user = Depends(verify_admin_token)
):
    tenant_id = await resolve_tenant(current_user.id)
    
    # Credenciales
    access_token = await get_tenant_credential(
        tenant_id=tenant_id,
        category="tiendanube",
        name="access_token"
    )
    
    user_id = await get_tenant_credential(
        tenant_id=tenant_id,
        category="tiendanube",
        name="user_id"
    )
    
    # Construir payload de TiendaNube
    tn_payload = {
        "name": {"es": payload.name},
        "description": {"es": payload.description},
        "published": True,
        "variants": [
            {
                "price": str(payload.price),
                "stock": payload.stock
            }
        ]
    }
    
    # Crear en TiendaNube
    response = requests.post(
        f"https://api.tiendanube.com/v1/{user_id}/products",
        headers={
            "Authentication": f"bearer {access_token}",
            "Content-Type": "application/json"
        },
        json=tn_payload
    )
    
    if response.status_code != 201:
        raise HTTPException(
            status_code=response.status_code,
            detail=f"Failed to create product: {response.text}"
        )
    
    created_product = response.json()
    
    return {
        "id": created_product['id'],
        "name": created_product['name']['es'],
        "permalink": created_product['permalink']
    }
```

## 8. Webhooks (Opcional)

### Configurar Webhook
```python
async def setup_tiendanube_webhook(
    tenant_id: int,
    event: str  # 'order/created', 'product/updated'
):
    """
    Registra webhook para recibir eventos de TiendaNube
    """
    access_token = await get_tenant_credential(
        tenant_id=tenant_id,
        category="tiendanube",
        name="access_token"
    )
    
    user_id = await get_tenant_credential(
        tenant_id=tenant_id,
        category="tiendanube",
        name="user_id"
    )
    
    # URL del webhook
    webhook_url = f"{BASE_URL}/webhooks/tiendanube/{tenant_id}"
    
    # Crear webhook
    response = requests.post(
        f"https://api.tiendanube.com/v1/{user_id}/webhooks",
        headers={"Authentication": f"bearer {access_token}"},
        json={
            "url": webhook_url,
            "event": event
        }
    )
    
    return response.json()
```

### Recibir Webhook
```python
@router.post("/webhooks/tiendanube/{tenant_id}")
async def handle_tiendanube_webhook(
    tenant_id: int,
    payload: dict = Body(...)
):
    """
    Procesa eventos de TiendaNube
    """
    event = payload.get('event')
    
    if event == 'order/created':
        # Notificar al equipo
        await notify_new_order(tenant_id, payload['object'])
    
    elif event == 'product/updated':
        # Sincronizar cat√°logo
        await sync_product(tenant_id, payload['object'])
    
    return {"status": "received"}
```

## 9. Store Information

### Obtener Info de Tienda
```python
@router.get("/admin/store/info")
async def get_store_info(
    current_user = Depends(verify_admin_token)
):
    tenant_id = await resolve_tenant(current_user.id)
    
    access_token = await get_tenant_credential(
        tenant_id=tenant_id,
        category="tiendanube",
        name="access_token"
    )
    
    user_id = await get_tenant_credential(
        tenant_id=tenant_id,
        category="tiendanube",
        name="user_id"
    )
    
    # Llamar API de Store
    response = requests.get(
        f"https://api.tiendanube.com/v1/{user_id}/store",
        headers={"Authentication": f"bearer {access_token}"}
    )
    
    store = response.json()
    
    return {
        "name": store['name']['es'],
        "url": store['url'],
        "currency": store['currency'],
        "language": store['language'],
        "country": store['country']
    }
```

## 10. Rate Limiting

### TiendaNube Limits
- **2 requests/second** por app
- **10,000 requests/day** por store

### Implementar Throttling
```python
import asyncio
from collections import deque

class TiendaNubeRateLimiter:
    def __init__(self):
        self.requests = deque()
        self.max_per_second = 2
    
    async def wait_if_needed(self):
        now = time.time()
        
        # Limpiar requests antiguos (> 1 segundo)
        while self.requests and self.requests[0] < now - 1:
            self.requests.popleft()
        
        # Si alcanzamos el l√≠mite, esperar
        if len(self.requests) >= self.max_per_second:
            sleep_time = 1 - (now - self.requests[0])
            if sleep_time > 0:
                await asyncio.sleep(sleep_time)
        
        # Registrar request
        self.requests.append(time.time())

limiter = TiendaNubeRateLimiter()

# Uso
await limiter.wait_if_needed()
response = requests.get(...)
```

## 11. Troubleshooting

### "404 No encontramos lo que est√°s buscando"
```
Causa: Redirect URI no coincide exactamente
Soluci√≥n: Verificar en Partners Dashboard ‚Üí Redirect URI
```

### "401 Unauthorized"
```
Causa: Token expirado o revocado
Soluci√≥n: Re-autenticar (TiendaNube tokens no expiran, pero pueden ser revocados)
```

### "Products API returns empty"
```
Causa: Tienda no tiene productos publicados
Soluci√≥n: Verificar en Tienda Nube que productos est√©n published=true
```

### "Rate limit exceeded"
```
Causa: > 2 req/s
Soluci√≥n: Implementar rate limiter (ver secci√≥n 10)
```

## 12. Checklist de Implementaci√≥n

### Frontend
- [ ] Bot√≥n "Conectar Tienda Nube"
- [ ] Callback handler en /auth/callback
- [ ] Estado de conexi√≥n visible
- [ ] Lista de productos con paginaci√≥n
- [ ] B√∫squeda de productos

### Backend
- [ ] OAuth exchange implementado
- [ ] Credenciales guardadas en Vault
- [ ] Endpoint /admin/products
- [ ] Endpoint /admin/orders
- [ ] search_products tool para agentes
- [ ] Rate limiter implementado
- [ ] Error handling (401, 404, 429)

### Configuraci√≥n
- [ ] TIENDANUBE_CLIENT_ID en .env
- [ ] TIENDANUBE_CLIENT_SECRET en .env
- [ ] Redirect URI configurado en Partners
- [ ] Scopes correctos (read_products, read_orders)

---

**Tip**: Para debugging, usar TiendaNube API Explorer: https://tiendanube.github.io/api-documentation/
````

## File: .agent/workflows/advisor.md
````markdown
---
description: Consultor Estrat√©gico. Analiza ideas contra los 3 Pilares (Ciencia, Mercado, Comunidad) antes de permitir que se escriba una sola l√≠nea de c√≥digo.
---

# ü¶∑ Dental Business Advisor

Workflow para validar ideas de crecimiento o automatizaci√≥n en la cl√≠nica.

1.  **Hip√≥tesis de Salud/Negocio**:
    - ¬øC√≥mo mejora esto la atenci√≥n al paciente?
    - ¬øReduce el ausentismo (no-show)?
2.  **An√°lisis de Flujo**:
    - **Pilar M√©dico**: ¬øCumple con la normativa de salud?
    - **Pilar Operativo**: ¬øC√≥mo afecta la agenda de los odont√≥logos?
    - **Pilar Paciente**: ¬øEs f√°cil de usar v√≠a WhatsApp?
3.  **Veredicto**:
    - Informe de viabilidad para el director de la cl√≠nica.
    - Si es viable -> Ejecutar `/plan`.
````

## File: .agent/workflows/audit.md
````markdown
---
description: Detector de Desviaci√≥n de la Especificaci√≥n (Spec Drift). Compara el c√≥digo contra la intenci√≥n original.
---

# üïµÔ∏è Antigravity Audit

Garantiza que el c√≥digo no haya "olvidado" la raz√≥n por la que fue escrito.

1.  **Comparativa**:
    - Lee el `.spec.md` (SSOT).
    - Lee el c√≥digo implementado en los archivos afectados.
2.  **Detecci√≥n de Brechas**:
    - ¬øSe implementaron todos los Criterios de Aceptaci√≥n?
    - ¬øSe respetaron los Esquemas de Datos?
    - ¬øHay l√≥gica extra no pedida que ensucie la arquitectura?
3.  **Informe de Audit**:
    - ‚úÖ **Match**: Todo en orden.
    - ‚ö†Ô∏è **Drift**: Lista las discrepancias encontradas.
4.  **Acci√≥n Correctiva**: Si hay Drift, sugiere crear una tarea de correcci√≥n inmediata.
````

## File: .agent/workflows/bug_fix.md
````markdown
---
description: Workflow para solucionar bugs en Dentalogic
---

# üêõ Bug Fix Workflow - Dentalogic

Proceso estandarizado para diagnosticar y solucionar errores en el sistema de gesti√≥n dental.

## üõ† Skills Recomendadas
- **Backend/Seguridad**: [Backend_Sovereign](../skills/Backend_Sovereign/SKILL.md)
- **Frontend/UI**: [Frontend_Nexus](../skills/Frontend_Nexus/SKILL.md)
- **WhatsApp**: [Omnichannel_Chat_Operator](../skills/Omnichannel_Chat_Operator/SKILL.md)

## Fase 1: Diagn√≥stico (Evidence)

### 1.1. Revisar Logs
```bash
# Logs del orquestador (Principal)
docker logs orchestrator_service --tail 100

# Logs del servicio de WhatsApp (Webhooks YCloud)
docker logs whatsapp_service --tail 100
```

### 1.2. Verificar Integraciones
- [ ] **Google Calendar**: ¬øEl Service Account tiene acceso al calendario?
- [ ] **YCloud**: ¬øEl `YCLOUD_WEBHOOK_SECRET` es correcto?
- [ ] **Base de Datos**: `db.py` conectado al pool de PostgreSQL.

## Fase 2: Reproducci√≥n (Isolation)

### 2.1. Test de Integraci√≥n
Si el error es en una tool (ej: `check_availability`), crear un test en `tests/` que llame a la funci√≥n directamente usando el pool de test.

## Fase 3: Soluci√≥n (Fix)

### 3.1. Patrones de Arreglo
- **Errores de Cita**: Verificar formato ISO en `gcal_service.py`.
- **Errores de IA**: Ajustar el prompt en `main.py` (Protocolo Gala).
- **Errores de Webhook**: Verificar validaci√≥n HMAC en `whatsapp_service/main.py`.

## Fase 4: Verificaci√≥n (Verify)
- [ ] Ejecutar `pytest` si hay tests disponibles.
- [ ] Verificar sincronizaci√≥n con Google Calendar tras el fix.
- [ ] Realizar smoke test desde un dispositivo m√≥vil (Responsive check).
````

## File: .agent/workflows/clarify.md
````markdown
---
description: Ronda de clarificaci√≥n t√©cnica. Identifica lagunas de l√≥gica y ambig√ºedades en la especificaci√≥n antes de planificar.
---

# üîç Antigravity Clarify

Este comando es el "Detector de Ambig√ºedades" para asegurar que la Spec sea perfecta.

1.  **Lectura Profunda**: Lee el archivo `.spec.md` actual.
2.  **An√°lisis Cr√≠tico**: Busca:
    - Casos de borde (edge cases) no contemplados.
    - Suposiciones impl√≠citas del usuario.
    - Contradicciones entre la l√≥gica de negocio y los esquemas de datos.
3.  **Cuestionario de Blindaje**:
    - Genera un m√°ximo de 5 preguntas clave para el usuario.
    - No proceedas al `/plan` hasta que estas dudas est√©n resueltas.
4.  **Actualizaci√≥n**: Incorpora las respuestas directamente en la secci√≥n "Clarificaciones" del `.spec.md`.
````

## File: .agent/workflows/finish.md
````markdown
---
description: Cierre de hito/sprint. Limpia el entorno y registra el √©xito en la memoria global.
---

# üèÅ Antigravity Finish

Protocolo de cierre profesional para cada feature implementada.

1.  **Limpieza de Workspace**:
    - Elimina archivos temporales o logs de depuraci√≥n.
2.  **Registro de Memoria**:
    - Invoca a `@agent-memory-mcp` para archivar el √©xito del proyecto.
    - Actualiza el historial de hitos en `.project_memory.json`.
3.  **Resumen de Entrega**:
    - Muestra al usuario el impacto: "Feature X implementada con [X] tests pasados y [X] de deuda t√©cnica corregida".
4.  **Promoci√≥n**: Sugiere el pr√≥ximo paso l√≥gico (ej: "¬øQuieres documentar esto con `/docs`?").
````

## File: .agent/workflows/gate.md
````markdown
---
description: Umbral de Calidad basado en Confianza. Eval√∫a la viabilidad de la implementaci√≥n antes de ejecutar.
---

# üö™ Antigravity Gate

Punto de control cr√≠tico para evitar el "Vibe Coding" de alto riesgo.

1.  **Evaluaci√≥n de Complejidad**: Analiza el Plan y la Spec.
2.  **C√°lculo de Confianza**:
    - **Alta (90-100%)**: Spec clara, herramientas probadas, ruta conocida.
    - **Media (70-89%)**: Spec buena pero con riesgos t√©cnicos menores.
    - **Baja (< 70%)**: Spec vaga, herramientas experimentales o l√≥gica contradictoria.
3.  **Acci√≥n**:
    - Si es **Baja**: El agente se bloquea y sugiere ejecutar `/clarify` o `/refine`.
    - Si es **Media/Alta**: Presenta los riesgos y pide un "Go" expl√≠cito del usuario para `/implement`.
4.  **Habilitaci√≥n de Skill**: Invoca a `@ai-agents-architect` para validar la estrategia de ejecuci√≥n.
````

## File: .agent/workflows/implement.md
````markdown
---
description: Ejecuta el plan de implementaci√≥n de manera aut√≥noma, escribiendo c√≥digo, pasando tests y registrando cambios.
---

# üöÄ Implement Workflow - Dentalogic

Ejecuci√≥n disciplinada de cambios t√©cnicos.

1.  **Backend Changes**:
    - Modificar `main.py` para tools/agents.
    - Modificar `admin_routes.py` para endpoints.
    - Modificar `db.py` o `gcal_service.py` para l√≥gica de datos.
2.  **Frontend Changes**:
    - Actualizar `views/` o `components/` en `frontend_react`.
3.  **Verification**:
    - Ejecutar `/verify` para asegurar que el sistema sigue √≠ntegro.
    - Reiniciar contenedores: `docker compose up -d --build`.
````

## File: .agent/workflows/new_feature.md
````markdown
---
description: 
---

# Workflow: Crear Nueva Feature en Dentalogic

Este workflow define el proceso para implementar nuevas funcionalidades siguiendo la arquitectura plana y el protocolo "Gala".

## 1. An√°lisis T√©cnico
Antes de codear, valid√°:
- [ ] **Base de Datos**: ¬øRequiere nuevas tablas en PostgreSQL? (Usar `asyncpg` directo en `db.py`).
- [ ] **Google Calendar**: ¬øInvolucra turnos? (Integrar con `gcal_service.py`).
- [ ] **WhatsApp**: ¬øRequiere nuevas respuestas de la IA? (Ajustar prompt en `main.py`).

## 2. Implementaci√≥n Backend (Orchestrator)

### 2.1. Base de Datos
Agreg√° las tablas necesarias v√≠a SQL puro.
```python
# db.py o script temporal
await db.pool.execute("CREATE TABLE IF NOT EXISTS...")
```

### 2.2. L√≥gica de Negocio
Implement√° la funcionalidad en `orchestrator_service/`. Si es administrativa, us√° `admin_routes.py`.

## 3. Implementaci√≥n Frontend
Actualiz√° la UI en `frontend_react/`.
- Usar `axios` desde `src/api/axios.ts`.
- Mantener el dise√±o **Glassmorphism**.

## 4. Verificaci√≥n "Sovereign"
- [ ] Validar que no haya fugas de datos (Isolation).
- [ ] Probar el flujo completo: WhatsApp -> Orquestador -> GCal.
- [ ] Verificar que el personal de la cl√≠nica reciba las notificaciones correctas.
````

## File: .agent/workflows/newproject.md
````markdown
---
description: Scaffolding autom√°tico para nuevos proyectos Antigravity. Vincula Workflows/Skills globales y se contextualiza con la Memoria del Proyecto.
---

# üèóÔ∏è Antigravity New Project Setup

1.  **Preguntar Nombre**: Solicita el nombre del proyecto.
2.  **Crear Directorio**: `mkdir [NombreProyecto]`.
3.  **Vinculaci√≥n H√≠brida (Local + Global)**:
    - // turbo
      `mkdir .agent\workflows, .agent\skills -Force`
    - // turbo
      `New-Item -ItemType Junction -Path ".agent\workflows\global" -Value "$GLOBAL_AGENT_PATH\workflows" -Force`
    - // turbo
      `New-Item -ItemType Junction -Path ".agent\skills\global" -Value "$GLOBAL_AGENT_PATH\skills" -Force`
4.  **Constituci√≥n Global (V√≠nculo Directo)**:
    - // turbo
      `New-Item -ItemType HardLink -Path ".antigravity_rules" -Value "$GLOBAL_AGENT_PATH\.antigravity_rules" -Force`
5.  **Contextualizaci√≥n Inmediata**:
    - **Acci√≥n del Agente**: Debes leer e interpretar obligatoriamente los archivos de reglas globales para asegurar consistencia arquitect√≥nica.
6.  **Estructura de Carpetas**:
    - `src/`: C√≥digo fuente.
    - `docs/specs/`: Especificaciones `.spec.md`.
    - `docs/plans/`: Planes de implementaci√≥n.
7.  **Inicializaci√≥n**:
    - `git init`
    - Inicializar el entorno seg√∫n el lenguaje del proyecto.
8.  **Siguiente Paso**:
    - Invoca autom√°ticamente `/advisor` para empezar a discutir la idea del proyecto.
````

## File: .agent/workflows/plan.md
````markdown
---
description: Transforma un .spec.md en un plan t√©cnico detallado paso a paso para la implementaci√≥n.
---

# üìÖ Plan Workflow - Dentalogic

Convierte la especificaci√≥n t√©cnica en una hoja de ruta ejecutable.

1.  **An√°lisis de la Spec**: Lectura de objetivos y criterios de aceptaci√≥n.
2.  **Generaci√≥n de Tareas**:
    - Desglose en pasos de 5-10 minutos.
    - Definici√≥n de comandos de verificaci√≥n (`pytest`, `verify_backend.ps1`).
3.  **Plan de Base de Datos**: Definir cambios de esquema necesarios.
````

## File: .agent/workflows/push.md
````markdown
---
description: Sincroniza el √©xito local con GitHub. Crea autom√°ticamente un repositorio privado si no existe.
---

# üöÄ Antigravity Push (Auto-Github)

Este comando gestiona la persistencia de tu c√≥digo en la nube con un enfoque de "Privacidad por Defecto".

1.  **Detecci√≥n de Repositorio**:
    - Verifica si la carpeta actual es un repositorio Git (`git status`).
    - Si no lo es, ejecuta `git init`.

2.  **Creaci√≥n Autom√°tica en GitHub**:
    - Verifica si existe un "remote" llamado `origin`.
    - Si **no existe**:
      - Crea un nuevo repositorio en tu cuenta de GitHub con el nombre de la carpeta actual.
      - **CR√çTICO**: El repositorio se crea en modo **PRIVADO** por defecto.
      - Configura el remoto: `git remote add origin [URL]`.

3.  **Preparaci√≥n de Archivos**:
    - Verifica la existencia de un `.gitignore` robusto (basado en el stack detectado).
    - Ejecuta `git add .`.

4.  **Commit y Env√≠o**:
    - Genera un mensaje de commit sem√°ntico (ej: `feat: initial sdd structure` o `fix: according to audit`).
    - Ejecuta `git push -u origin main` (o la rama activa).

5.  **Confirmaci√≥n**:
    - Entrega el link del repositorio privado al usuario.
    - Registra la URL en `.project_memory.json`.

// turbo
_Nota: Este comando asume que el repositorio no existe y lo crea de forma segura._
````

## File: .agent/workflows/review.md
````markdown
---
description: Revisi√≥n t√©cnica multi-perspectiva. Eval√∫a Seguridad, Performance y Clean Code.
---

# üëÅÔ∏è Antigravity Review

Simula una revisi√≥n de c√≥digo (PR Review) por ingenieros senior especializados.

1.  **Activaci√≥n de Mini-Agentes**:
    - **Reviewer A (Arquitectura/Loki)**: Busca violaciones a la arquitectura de la Skill original.
    - **Reviewer B (Seguridad)**: Busca credenciales hardcoded, inyecciones o fugas de datos.
    - **Reviewer C (Clean Code)**: Eval√∫a legibilidad, nombrado y principios SOLID.
2.  **Consolidaci√≥n**: Genera una lista de cambios recomendados (Minor) o bloqueantes (Critical).
3.  **Habilidad Maestra**: Usa `@agent-tool-builder` para sugerir refactorizaciones precisas que mejoren la deuda t√©cnica.
````

## File: .agent/workflows/secuency.md
````markdown
---
description: Mapa de Ruta secuencial de los comandos SDD (Spec-Driven Development).
---

# üó∫Ô∏è Antigravity SDD Secuency

Este es el orden l√≥gico para transformar una idea en realidad usando el ecosistema Antigravity.

### üöÄ Secuencia Maestra de Desarrollo (SDD v2.0)

**Fase A: Preparaci√≥n y Expertos**

1.  **`/newproject`** - Estructura y Constituci√≥n.
2.  **`/advisor`** - Validaci√≥n de 3 Pilares (Ciencia/Mercado/Comunidad).
3.  **`/skills`** - Carga de especialistas de tu biblioteca.

**Fase B: Ingenier√≠a de Especificaci√≥n** 4. **`/specify`** - Crear la SSOT (Requisitos Gherkin). 5. **`/clarify`** - **[NUEVO]** Ronda de preguntas t√©cnicas cr√≠ticas. 6. **`/plan`** - Dise√±o de arquitectura t√©cnica y TDD. 7. **`/gate`** - **[NUEVO]** Validaci√≥n de confianza t√©cnica pre-ejecuci√≥n. 8. **`/tasks`** - Desglose del plan en tickets at√≥micos.

**Fase C: Construcci√≥n y Calidad** 9. **`/implement`** - Escritura de c√≥digo disciplinad con checkpoints. 10. **`/verify`** - **[NUEVO]** Auto-correcci√≥n de tests y validaci√≥n cruzada. 11. **`/audit`** - **[NUEVO]** Detecci√≥n de desviaci√≥n de la especificaci√≥n (Drift). 12. **`/review`** - **[NUEVO]** Revisi√≥n de Seguridad y Clean Code.

**Fase D: Finalizaci√≥n** 13. **`/push`** - Sincron√≠a t√©cnica con GitHub. 14. **`/finish`** - **[NUEVO]** Cierre de hito, limpieza y registro en memoria global.

---

_Tip: Ejecuta los comandos en este orden para garantizar √©xito. Puedes encadenar comandos (ej: `/plan /gate`) si te sientes con confianza._
````

## File: .agent/workflows/specify.md
````markdown
---
description: Genera una especificaci√≥n t√©cnica (.spec.md) rigurosa a partir de requerimientos vagos, usando an√°lisis de 3 pilares.
---

# üìù Specify Workflow - Dentalogic

Transforma requerimientos vagos en una especificaci√≥n t√©cnica rigurosa.

1.  **Entrevista T√©cnica**:
    - Definir Entradas de Datos (ej: Datos del paciente, fechas).
    - Definir Salidas (ej: Cita en GCal, Mensaje de confirmaci√≥n).
2.  **Generaci√≥n de `.spec.md`**:
    - Estructura: Objetivos, Esquema de Datos, L√≥gica "Gala", Criterios de Aceptaci√≥n.
3.  **Soberan√≠a de Datos**:
    - Validar que se cumplan las reglas de aislamiento multi-tenant.
````

## File: .agent/workflows/tasks.md
````markdown
---
description: (Opcional) Descompone un plan masivo en tickets individuales si la complejidad es alta.
---

# üìã Antigravity Tasks

Gesti√≥n de granularidad para proyectos grandes.

1.  **Input**: Plan de implementaci√≥n (`docs/plans/...md`).
2.  **An√°lisis de Complejidad**:
    - Si el plan tiene > 15 pasos.
    - O si involucra m√∫ltiples agentes simult√°neos.
3.  **Generaci√≥n de Tickets**:
    - Crea un archivo JSON o Markdown checklist con estados: `[ ]`, `[IN_PROGRESS]`, `[DONE]`.
4.  **Asignaci√≥n**:
    - Sugiere qu√© agente (Sonnet vs Haiku) es mejor para cada tarea.
````

## File: .agent/workflows/update-docs.md
````markdown
---
description: Actualiza documentaci√≥n y skills usando el protocolo Non-Destructive Fusion
---

# Workflow: Actualizar Documentaci√≥n

Este workflow implementa el protocolo **Non-Destructive Fusion** de la skill Smart Doc Keeper para actualizar documentaci√≥n y skills sin perder contenido previo.

## Cu√°ndo usar este workflow

- Despu√©s de implementar nuevas features que requieren documentaci√≥n
- Cuando se detectan inconsistencias entre c√≥digo y docs
- Al agregar nuevas skills o actualizar existentes
- Para sincronizar cambios arquitect√≥nicos con la documentaci√≥n

## Pasos del Workflow

### 1. Identificar documentos a actualizar

Determina qu√© archivos necesitan actualizaci√≥n:

```bash
# Documentaci√≥n principal
docs/API_REFERENCE.md
docs/INTEGRATIONS_LOGIC_DEEP_DIVE.md
docs/TROUBLESHOOTING.md
docs/YCLOUD_INTEGRATION.md

# Skills
.agent/skills/[nombre_skill]/SKILL.md

# Configuraci√≥n de agentes
.agent/agents.md
```

### 2. Leer el contenido actual

**CR√çTICO**: Siempre lee el contenido completo del archivo antes de actualizar.

```
// Usa view_file para leer el contenido actual
// Identifica las secciones que necesitan actualizaci√≥n
// Preserva todo el contenido que NO necesita cambios
```

### 3. Aplicar protocolo Non-Destructive Fusion

**Reglas obligatorias**:

1. ‚úÖ **NUNCA elimines secciones existentes** sin confirmaci√≥n expl√≠cita del usuario
2. ‚úÖ **Preserva el formato markdown** y la estructura de encabezados
3. ‚úÖ **Agrega nuevas secciones** al final de bloques relacionados
4. ‚úÖ **Actualiza contenido obsoleto** manteniendo el contexto hist√≥rico cuando sea relevante
5. ‚úÖ **Mant√©n los ejemplos de c√≥digo** existentes a menos que est√©n rotos

**T√©cnicas de fusi√≥n**:

- **Agregar**: Inserta nuevas secciones sin tocar las existentes
- **Expandir**: Agrega informaci√≥n a secciones existentes preservando el contenido original
- **Corregir**: Actualiza informaci√≥n incorrecta manteniendo el formato
- **Deprecar**: Marca contenido obsoleto con `> [!WARNING] DEPRECATED` en lugar de eliminarlo

### 4. Actualizar Skills (SKILL.md)

Para actualizar skills, sigue la estructura YAML frontmatter:

```markdown
---
name: Nombre de la Skill
description: Descripci√≥n breve de la skill
---

# [Nombre de la Skill]

## Prop√≥sito
[Descripci√≥n detallada]

## Cu√°ndo usar esta skill
[Lista de casos de uso]

## Protocolo de ejecuci√≥n
[Pasos espec√≠ficos]

## Ejemplos
[Casos de uso concretos]

## Reglas cr√≠ticas
[Restricciones y mejores pr√°cticas]
```

### 5. Sincronizar con AGENTS.md

Despu√©s de actualizar skills, ejecuta:

```bash
python .agent/skills/Skill_Sync/sync_skills.py
```

Esto actualiza autom√°ticamente `.agent/agents.md` con los metadatos de todas las skills.

### 6. Verificar cambios

**Checklist de verificaci√≥n**:

- [ ] El archivo actualizado compila/renderiza correctamente
- [ ] No se elimin√≥ contenido importante sin intenci√≥n
- [ ] Los links internos siguen funcionando
- [ ] Los ejemplos de c√≥digo son v√°lidos
- [ ] El formato markdown es consistente
- [ ] Las secciones est√°n en orden l√≥gico

### 7. Documentar cambios en commit

Usa mensajes de commit descriptivos:

```bash
git add docs/[archivo].md
git commit -m "docs: actualizar [archivo] con [cambio espec√≠fico]"
```

## Ejemplos de uso

### Ejemplo 1: Agregar nueva integraci√≥n a INTEGRATIONS_LOGIC_DEEP_DIVE.md

```markdown
// 1. Lee el archivo completo
// 2. Identifica la secci√≥n de integraciones
// 3. Agrega nueva secci√≥n al final:

## Nueva Integraci√≥n: [Nombre]

### Arquitectura
[Descripci√≥n]

### Endpoints
[Lista de endpoints]

### Flujo de datos
[Diagrama o descripci√≥n]
```

### Ejemplo 2: Actualizar skill existente

```markdown
// 1. Lee SKILL.md actual
// 2. Identifica secci√≥n a actualizar (ej: "Protocolo de ejecuci√≥n")
// 3. Expande la secci√≥n agregando nuevos pasos:

## Protocolo de ejecuci√≥n

[Contenido existente preservado]

### Nuevos pasos (v2.0)
4. [Nuevo paso]
5. [Nuevo paso]
```

### Ejemplo 3: Deprecar contenido obsoleto

```markdown
> [!WARNING]
> **DEPRECATED (2026-01-27)**: Esta secci√≥n describe el m√©todo legacy.
> Ver [Nueva Secci√≥n](#nueva-seccion) para el enfoque actual.

[Contenido obsoleto preservado para referencia hist√≥rica]
```

## Protocolo de emergencia

Si accidentalmente eliminas contenido:

1. **NO hagas commit** inmediatamente
2. Usa `git diff` para ver qu√© se elimin√≥
3. Restaura el contenido desde el historial de Git
4. Aplica los cambios correctamente usando Non-Destructive Fusion

## Mejores pr√°cticas

1. **Siempre lee antes de escribir**: Nunca actualices un archivo sin leerlo primero
2. **Commits at√≥micos**: Un archivo por commit cuando sea posible
3. **Mensajes descriptivos**: Explica QU√â cambi√≥ y POR QU√â
4. **Preserva el contexto**: La documentaci√≥n es historia, no solo estado actual
5. **Valida links**: Aseg√∫rate de que los links internos funcionen despu√©s de cambios

## Archivos cr√≠ticos que requieren cuidado especial

- `docs/API_REFERENCE.md` - Contratos de API, cambios pueden romper integraciones
- `.agent/agents.md` - Auto-generado, no editar manualmente
- `docs/TROUBLESHOOTING.md` - Soluciones hist√≥ricas son valiosas
- `.agent/skills/*/SKILL.md` - Estructura YAML estricta

## Recursos

- Skill: `.agent/skills/Doc_Keeper/SKILL.md`
- Sync script: `.agent/skills/Skill_Sync/sync_skills.py`
- Convenciones de commits: `docs/CONTRIBUTING.md` (si existe)
````

## File: .agent/workflows/verify.md
````markdown
```
---
description: Ciclo de Auto-verificaci√≥n y Correcci√≥n. Ejecuta tests y arregla fallos sin intervenci√≥n humana.
---

# üß™ Verify Workflow - Dentalogic

Ciclo de auto-verificaci√≥n t√©cnica y funcional.

1.  **Backend Verification**:
    - Ejecutar scripts de validaci√≥n:
      ```powershell
      ./verify_backend.ps1
      python verify_phases.py
      ```
    - Correr tests con Pytest: `pytest`.
2.  **Frontend Verification**:
    - Build test: `npm run build` en `frontend_react`.
3.  **Integrations Verification**:
    - Verificar conexi√≥n a PostgreSQL.
    - Test de sincronizaci√≥n GCal (crear/cancelar turno de prueba).
4.  **Security Audit**:
    - Ejecutar `/audit` para detectar drift de especificaci√≥n.
3.  **Cross-Verification**: Prueba manualmente (v√≠a terminal o scripts) que el resultado visual o de datos sea el esperado por la Spec.
4.  **Habilitaci√≥n de Skill**: Si el fallo es persistente, invoca a `@systematic-debugging` para un an√°lisis profundo.
```
````

## File: .agent/agents.md
````markdown
# üß† Dentalogic Brain: Knowledge & Skills Map

Este archivo act√∫a como el √≠ndice maestro de capacidades para los Agentes Aut√≥nomos. Define qu√© Skill utilizar para cada tipo de tarea.

## üåü Core Skills (Infraestructura)
| Skill | Trigger Keywords | Uso Principal |
|-------|------------------|---------------|
| **[Backend_Sovereign](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/Backend_Sovereign/SKILL.md)** | `backend`, `fastapi`, `db`, `auth` | Arquitectura, endpoints, seguridad y base de datos. |
| **[Frontend_Nexus](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/Frontend_Nexus/SKILL.md)** | `frontend`, `react`, `ui`, `hooks` | Componentes React, llamadas API, estado y estilos. |
| **[DB_Evolution](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/DB_Evolution/SKILL.md)** | `schema`, `migration`, `sql`, `rag` | Cambios en DB, gesti√≥n de vectores y migraciones. |

## üí¨ Communication & Integrations
| Skill | Trigger Keywords | Uso Principal |
|-------|------------------|---------------|
| **[Omnichannel_Chat_Operator](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/Omnichannel_Chat_Operator/SKILL.md)** | `chats`, `whatsapp`, `meta`, `msg` | L√≥gica de mensajer√≠a, polling y human handoff. |
| **[Meta_Integration_Diplomat](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/Meta_Integration_Diplomat/SKILL.md)** | `oauth`, `facebook`, `instagram` | Vinculaci√≥n de cuentas Meta y gesti√≥n de tokens. |
| **[TiendaNube_Commerce_Bridge](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/TiendaNube_Commerce_Bridge/SKILL.md)** | `tiendanube`, `products`, `orders` | Sincronizaci√≥n de cat√°logo y OAuth de e-commerce. |

## ü§ñ AI & Onboarding
| Skill | Trigger Keywords | Uso Principal |
|-------|------------------|---------------|
| **[Agent_Configuration_Architect](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/Agent_Configuration_Architect/SKILL.md)** | `agents`, `prompts`, `tools` | Creaci√≥n y configuraci√≥n de agentes IA. |
| **[Magic_Onboarding_Orchestrator](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/Magic_Onboarding_Orchestrator/SKILL.md)** | `magic`, `wizard`, `onboarding` | Proceso de "Hacer Magia" y generaci√≥n de assets. |
| **[Business_Forge_Engineer](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/Business_Forge_Engineer/SKILL.md)** | `forge`, `canvas`, `visuals` | Gesti√≥n de assets generados y Fusion Engine. |
| **[Skill_Forge_Master](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/Skill_Forge_Master/SKILL.md)** | `crear skill`, `skill architect` | Generador y arquitecto de nuevas capacidades. |


## üîí Security
| Skill | Trigger Keywords | Uso Principal |
|-------|------------------|---------------|
| **[Credential_Vault_Specialist](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/Credential_Vault_Specialist/SKILL.md)** | `credentials`, `vault`, `keys` | Gesti√≥n segura de secretos y encriptaci√≥n. |

---

# üèó Sovereign Architecture Context

## 1. Project Identity
**Dentalogic** es un sistema SaaS de Orquestaci√≥n de IA para Cl√≠nicas Odontol√≥gicas (Citas, Triaje y Gesti√≥n de Pacientes).

Cada cl√≠nica posee sus propias credenciales de IA encriptadas en la base de datos y su propia integraci√≥n con Google Calendar.

**Regla de Oro:** NUNCA usar `os.getenv("OPENAI_API_KEY")` para l√≥gica de agentes en producci√≥n. Siempre usar la credencial correspondiente de la base de datos.

## 2. Tech Stack & Standards

### Backend
- **Python 3.10+**: Lenguaje principal
- **FastAPI**: Framework web as√≠ncrono
- **PostgreSQL 14**: Base de datos relacional
- **SQLAlchemy 2.0 / asyncpg**: Acceso as√≠ncrono a datos
- **Google Calendar API**: Sincronizaci√≥n de turnos
- **Redis**: Cache y buffers de mensajes

### Frontend
- **React 18**: Framework UI
- **TypeScript**: Tipado estricto obligatorio
- **Tailwind CSS**: Sistema de estilos
- **Lucide Icons**: Iconograf√≠a

### Infrastructure
- **Docker Compose**: Orquestaci√≥n local
- **EasyPanel**: Deployment cloud
- **WhatsApp Business API (via YCloud)**: Canal de comunicaci√≥n oficial

## 3. Architecture Map

### Core Services

#### `/orchestrator_service` - API Principal
- **Responsabilidad**: Gesti√≥n de turnos, triaje IA, integraci√≥n con Google Calendar.
- **Archivos Cr√≠ticos**:
  - `main.py`: FastAPI app y herramientas de la IA (Dental Tools).
  - `admin_routes.py`: Gesti√≥n de pacientes, profesionales y configuraci√≥n de despliegue.
  - `gcal_service.py`: Integraci√≥n real con Google Calendar (Service Account).
  - `db.py`: Conector de base de datos as√≠ncrono.

#### `/whatsapp_service` - Canal WhatsApp
- **Responsabilidad**: Recepci√≥n de webhooks de YCloud, validaci√≥n de firmas y forwarding al orquestador.
- **Caracter√≠sticas**: Buffer/Debounce de mensajes en Redis.

#### `/frontend_react` - Dashboard SPA
- **Responsabilidad**: Interfaz para administraci√≥n de la cl√≠nica (Agenda, Pacientes, Credenciales).
- **Vistas Cr√≠ticas**:
  - `AgendaView.tsx`: Calendario din√°mico con soporte de bloques de Google.
  - `DashboardView.tsx`: Estad√≠sticas en tiempo real y alertas de triaje cr√≠tico.

## 4. Workflows Disponibles

| Workflow | Descripci√≥n |
|----------|-------------|
| **[bug_fix](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/workflows/bug_fix.md)** | Proceso para solucionar errores con aislamiento dental. |
| **[implement](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/workflows/implement.md)** | Ejecuci√≥n aut√≥noma del plan de implementaci√≥n. |
| **[verify](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/workflows/verify.md)** | Ciclo de auto-verificaci√≥n y correcci√≥n. |
| **[plan](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/workflows/plan.md)** | Transforma especificaciones en un plan t√©cnico. |
| **[specify](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/workflows/specify.md)** | Genera especificaciones t√©cnicas .spec.md. |

## 5. Available Skills Index

| Skill Name | Trigger | Descripci√≥n |
| :--- | :--- | :--- |
| **[AI Behavior Architect](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/Prompt_Architect/SKILL.md)** | `system prompts`, `IA Gala`, `Mercedes` | Ingenier√≠a de prompts y tono argentino Mercedes. |
| **[Agent Configuration Architect](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/Agent_Configuration_Architect/SKILL.md)** | `agents`, `prompts`, `wizard` | Configuraci√≥n de agentes: templates, tools y models. |
| **[Business Forge Engineer](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/Business_Forge_Engineer/SKILL.md)** | `forge`, `canvas`, `visuals` | Gesti√≥n de assets generados y Fusion Engine. |
| **[Credential Vault Specialist](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/Credential_Vault_Specialist/SKILL.md)** | `vault`, `keys`, `encryption` | Gesti√≥n segura de credenciales multi-tenant. |
| **[DB Schema Surgeon](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/DB_Evolution/SKILL.md)** | `sql`, `schema`, `migration` | Gesti√≥n del esquema PostgreSQL y Auto-Healing. |
| **[Deep Researcher](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/Deep_Research/SKILL.md)** | `investigate`, `docs`, `search` | Investiga y valida soluciones t√©cnicas externas. |
| **[EasyPanel DevOps](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/DevOps_EasyPanel/SKILL.md)** | `deployment`, `docker`, `vars` | Dockerizaci√≥n y despliegue en EasyPanel. |
| **[Magic Onboarding Orchestrator](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/Magic_Onboarding_Orchestrator/SKILL.md)** | `magic`, `wizard`, `branding` | Orquestaci√≥n del proceso "Hacer Magia". |
| **[Maintenance Robot Architect](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/Maintenance_Robot_Architect/SKILL.md)** | `auto-migration`, `seed data` | Sistema de auto-migraci√≥n y inicializaci√≥n de BD. |
| **[Meta Integration Diplomat](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/Meta_Integration_Diplomat/SKILL.md)** | `meta`, `facebook`, `instagram` | OAuth Meta y gesti√≥n de activos de negocio. |
| **[Nexus QA Engineer](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/Testing_Quality/SKILL.md)** | `tests`, `pytest`, `vitest` | Especialista en calidad y testing as√≠ncrono. |
| **[Nexus UI Architect](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/Nexus_UI_Architect/SKILL.md)** | `responsive`, `mobile`, `ux` | Dise√±o responsivo y est√°ndar visual Nexus. |
| **[Nexus UI Developer](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/Frontend_Nexus/SKILL.md)** | `frontend`, `react`, `ui-nexus` | Desarrollo Frontend con React y API multi-tenant. |
| **[Omnichannel Chat Operator](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/Omnichannel_Chat_Operator/SKILL.md)** | `chats`, `whatsapp`, `handoff` | Gesti√≥n de conversaciones y alertas de triaje. |
| **[Skill Synchronizer](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/Skill_Sync/SKILL.md)** | `sync skills`, `agents.md` | Actualiza el √≠ndice vivo de capacidades. |
| **[Skill_Forge_Master](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/Skill_Forge_Master/SKILL.md)** | `new skill`, `capability` | Arquitecto y generador de nuevas habilidades. |
| **[Smart Doc Keeper](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/Doc_Keeper/SKILL.md)** | `update doc`, `fusion` | Actualizaci√≥n de documentaci√≥n (Smart Fusion). |
| **[Sovereign Backend Engineer](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/Backend_Sovereign/SKILL.md)** | `backend`, `fastapi`, `api-nexus` | Arquitectura Backend y gesti√≥n de soberan√≠a. |
| **[Sovereign Code Auditor](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/Sovereign_Auditor/SKILL.md)** | `audit`, `security`, `tenant_id` | Auditor√≠a de ciberseguridad y aislamiento. |
| **[Spec Architect](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/Spec_Architect/SKILL.md)** | `specify`, `plan`, `sdd` | Generador de especificaciones SDD v2.0. |
| **[Template Transplant Specialist](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/Template_Transplant_Specialist/SKILL.md)** | `legacy prompt`, `transplant` | Trasplante de prompts en arquitectura multi-capa. |
| **[TiendaNube Commerce Bridge](file:///c:/Users/Asus/Downloads/Clinica%20Dental/.agent/skills/TiendaNube_Commerce_Bridge/SKILL.md)** | `tiendanube`, `catalogue`, `ecommerce` | Integraci√≥n con Tienda Nube (OAuth y Cat√°logo). |
````

## File: bff_service/src/index.ts
````typescript
import express, { Request, Response } from 'express';
import cors from 'cors';
import dotenv from 'dotenv';
import axios from 'axios';

dotenv.config();

const app = express();
const port = process.env.PORT || 3000;
const ORCHESTRATOR_URL = process.env.ORCHESTRATOR_SERVICE_URL || process.env.ORCHESTRATOR_URL || 'http://orchestrator_service:8000';

app.use(cors({
    origin: true,
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS', 'PATCH'],
    allowedHeaders: ['Content-Type', 'Authorization', 'x-admin-token', 'x-tenant-id', 'x-signature']
}));
app.options('*', cors());
app.use(express.json());

// Root Route
app.get('/', (req: Request, res: Response) => {
    res.send('BFF Service is Running');
});

// Health Check
app.get('/health', (req: Request, res: Response) => {
    console.log('[Health] Check received');
    res.json({ status: 'ok', service: 'bff-interface', mode: 'proxy' });
});

// Proxy Middleware (Catch-all)
app.use(async (req: Request, res: Response) => {
    const url = `${ORCHESTRATOR_URL}${req.originalUrl}`;
    console.log(`[Proxy] Forwarding ${req.method} ${req.originalUrl} -> ${url}`);

    try {
        const response = await axios({
            method: req.method,
            url: url,
            data: req.body,
            headers: { ...req.headers, host: undefined }
        });
        res.status(response.status).send(response.data);
    } catch (error: any) {
        console.error(`[Proxy Error] ${error.message}`);
        if (error.response) {
            res.status(error.response.status).send(error.response.data);
        } else {
            res.status(502).json({ error: 'Orchestrator unavailable', details: error.message });
        }
    }
});

app.listen(port, () => {
    console.log(`BFF Service running on port ${port}`);
    console.log(`Proxying to Orchestrator at: ${ORCHESTRATOR_URL}`);
});
````

## File: bff_service/Dockerfile
````
FROM node:22-alpine

WORKDIR /app

COPY package*.json ./
RUN npm install

COPY . .

RUN npm run build

EXPOSE 3000

CMD ["node", "dist/index.js"]
````

## File: bff_service/package.json
````json
{
    "name": "bff-service",
    "version": "1.0.0",
    "description": "Backend for Frontend (BFF) Interface Service for Pointe Coach",
    "main": "dist/index.js",
    "scripts": {
        "start": "node dist/index.js",
        "dev": "ts-node-dev --respawn src/index.ts",
        "build": "tsc"
    },
    "dependencies": {
        "axios": "^1.6.0",
        "cors": "^2.8.5",
        "dotenv": "^16.0.0",
        "express": "^4.18.0"
    },
    "devDependencies": {
        "@types/cors": "^2.8.12",
        "@types/express": "^4.17.17",
        "@types/node": "^20.0.0",
        "ts-node-dev": "^2.0.0",
        "typescript": "^5.0.0"
    }
}
````

## File: bff_service/tsconfig.json
````json
{
    "compilerOptions": {
        "target": "es2018",
        "module": "commonjs",
        "outDir": "./dist",
        "rootDir": "./src",
        "strict": true,
        "esModuleInterop": true,
        "skipLibCheck": true,
        "forceConsistentCasingInFileNames": true
    },
    "include": [
        "src/**/*"
    ],
    "exclude": [
        "node_modules"
    ]
}
````

## File: db/init/dentalogic_schema.sql
````sql
-- ==================================================================================
-- DENTALOGIC - SCHEMA UNIFICADO
-- ==================================================================================
-- Sistema de gesti√≥n dental con IA para Mercedes
-- Versi√≥n: 1.0 (Unificado 2026-02-05)
-- ==================================================================================

-- ==================== CORE TABLES - MESSAGES & CHAT ====================

-- Table for inbound messages (dedupe/idempotency from WhatsApp)
CREATE TABLE IF NOT EXISTS inbound_messages (
    id BIGSERIAL PRIMARY KEY,
    provider TEXT NOT NULL,
    provider_message_id TEXT NOT NULL,
    event_id TEXT NULL,
    from_number TEXT NOT NULL,
    payload JSONB NOT NULL,
    status TEXT NOT NULL CHECK (status IN ('received', 'processing', 'done', 'failed')),
    received_at TIMESTAMPTZ DEFAULT NOW(),
    processed_at TIMESTAMPTZ NULL,
    error TEXT NULL,
    correlation_id TEXT NULL,
    UNIQUE (provider, provider_message_id)
);

CREATE INDEX IF NOT EXISTS idx_inbound_messages_from_number_received_at ON inbound_messages (from_number, received_at DESC);
CREATE INDEX IF NOT EXISTS idx_inbound_messages_status ON inbound_messages (status);

-- Table for chat messages (source-of-truth)
CREATE TABLE IF NOT EXISTS chat_messages (
    id BIGSERIAL PRIMARY KEY,
    from_number TEXT NOT NULL,
    role TEXT NOT NULL CHECK (role IN ('user', 'assistant', 'system', 'tool')),
    content TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    correlation_id TEXT NULL
);

CREATE INDEX IF NOT EXISTS idx_chat_messages_from_number_created_at ON chat_messages (from_number, created_at DESC);

-- ==================== TENANT & CONFIGURATION ====================

-- Tabla de configuraci√≥n de la cl√≠nica (simplificada - single tenant)
CREATE TABLE IF NOT EXISTS tenants (
    id SERIAL PRIMARY KEY,
    clinic_name TEXT NOT NULL DEFAULT 'Cl√≠nica Dental',
    bot_phone_number TEXT UNIQUE NOT NULL,
    owner_email TEXT,
    clinic_location TEXT,
    clinic_website TEXT,
    system_prompt_template TEXT, -- Prompt del agente IA
    
    -- Usage Stats
    total_tokens_used BIGINT DEFAULT 0,
    total_tool_calls BIGINT DEFAULT 0,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Credentials Table (Secrets Management)
CREATE TABLE IF NOT EXISTS credentials (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    value TEXT NOT NULL,
    category TEXT,
    scope TEXT DEFAULT 'global',
    tenant_id INTEGER REFERENCES tenants(id) ON DELETE CASCADE,
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- System Events (For monitoring and debugging)
CREATE TABLE IF NOT EXISTS system_events (
    id BIGSERIAL PRIMARY KEY,
    event_type TEXT NOT NULL,
    severity TEXT DEFAULT 'info',
    message TEXT,
    payload JSONB,
    occurred_at TIMESTAMPTZ DEFAULT NOW()
);

-- Insert Default Tenant (Dentalogic)
INSERT INTO tenants (
    clinic_name, 
    bot_phone_number, 
    clinic_location
) VALUES (
    'Cl√≠nica Dental',
    '5491100000000',
    'Argentina'
) ON CONFLICT (bot_phone_number) DO NOTHING;

-- ==================== TABLA DE USUARIOS (RBAC) ====================

CREATE TABLE IF NOT EXISTS users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role VARCHAR(50) NOT NULL CHECK (role IN ('ceo', 'professional', 'secretary')),
    status VARCHAR(50) NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'active', 'suspended')),
    professional_id INTEGER NULL, -- Se vincula si el rol es professional
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
CREATE INDEX IF NOT EXISTS idx_users_status ON users(status);

-- ==================== TABLA DE PROFESIONALES ====================

CREATE TABLE IF NOT EXISTS professionals (
    id SERIAL PRIMARY KEY,
    tenant_id INTEGER NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    user_id UUID REFERENCES users(id) ON DELETE SET NULL, -- V√≠nculo a la tabla de usuarios
    
    first_name VARCHAR(100) NOT NULL,
    last_name VARCHAR(100) NOT NULL,
    email VARCHAR(255),
    phone_number VARCHAR(20),
    specialty VARCHAR(100),
    registration_id VARCHAR(50), -- Matr√≠cula
    
    is_active BOOLEAN DEFAULT TRUE,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);


CREATE INDEX IF NOT EXISTS idx_professionals_tenant ON professionals(tenant_id);
CREATE INDEX IF NOT EXISTS idx_professionals_active ON professionals(is_active);
CREATE INDEX IF NOT EXISTS idx_professionals_user_id ON professionals(user_id);

-- ==================== TABLA DE PACIENTES ====================

CREATE TABLE IF NOT EXISTS patients (
    id SERIAL PRIMARY KEY,
    tenant_id INTEGER NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    
    -- Identidad del Paciente
    phone_number VARCHAR(20) NOT NULL,
    dni VARCHAR(15) NOT NULL,
    first_name VARCHAR(100) NOT NULL,
    last_name VARCHAR(100) NOT NULL,
    birth_date DATE,
    gender VARCHAR(10),
    
    -- Obra Social (Insurance)
    insurance_provider VARCHAR(100),
    insurance_id VARCHAR(50),
    insurance_valid_until DATE,
    
    -- Anamnesis (JSONB: Historial M√©dico)
    medical_history JSONB DEFAULT '{}',
    
    -- Datos de Contacto
    email VARCHAR(255),
    alternative_phone VARCHAR(20),
    
    -- Estado del Paciente
    status VARCHAR(20) DEFAULT 'active',
    preferred_schedule VARCHAR(50),
    notes TEXT,
    
    -- Human Handoff Support (Chat Management)
    human_handoff_requested BOOLEAN DEFAULT FALSE,
    human_override_until TIMESTAMPTZ DEFAULT NULL,
    last_derivhumano_at TIMESTAMPTZ DEFAULT NULL,
    
    -- Auditor√≠a
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    last_visit TIMESTAMPTZ,
    
    -- Constraints
    UNIQUE (tenant_id, phone_number),
    UNIQUE (tenant_id, dni)
);

CREATE INDEX IF NOT EXISTS idx_patients_tenant_phone ON patients(tenant_id, phone_number);
CREATE INDEX IF NOT EXISTS idx_patients_tenant_dni ON patients(tenant_id, dni);
CREATE INDEX IF NOT EXISTS idx_patients_status ON patients(status);
CREATE INDEX IF NOT EXISTS idx_patients_insurance ON patients(insurance_provider);
CREATE INDEX IF NOT EXISTS idx_patients_handoff ON patients(human_handoff_requested) WHERE human_handoff_requested = TRUE;

COMMENT ON COLUMN patients.human_handoff_requested IS 'Indica si el paciente solicit√≥ hablar con un humano (derivhumano activado)';
COMMENT ON COLUMN patients.human_override_until IS 'Timestamp hasta el cual la IA debe permanecer silenciada (24hs por defecto)';
COMMENT ON COLUMN patients.last_derivhumano_at IS 'Timestamp de la √∫ltima vez que se activ√≥ derivhumano para este paciente';

-- ==================== TABLA DE HISTORIAS CL√çNICAS ====================

CREATE TABLE IF NOT EXISTS clinical_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id INTEGER NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    patient_id INTEGER NOT NULL REFERENCES patients(id) ON DELETE CASCADE,
    
    -- Metadata del Registro
    record_date DATE NOT NULL DEFAULT CURRENT_DATE,
    professional_id INTEGER REFERENCES professionals(id) ON DELETE SET NULL,
    
    -- Odontograma (JSONB: Representaci√≥n gr√°fica de dientes)
    odontogram JSONB DEFAULT '{}',
    
    -- Diagn√≥sticos Principales
    diagnosis TEXT,
    
    -- Tratamientos Realizados
    treatments JSONB DEFAULT '[]',
    
    -- Radiograf√≠as & Documentaci√≥n
    radiographs JSONB DEFAULT '[]',
    
    -- Plan de Tratamiento Futuro
    treatment_plan JSONB DEFAULT '{}',
    
    -- Observaciones Cl√≠nicas
    clinical_notes TEXT,
    recommendations TEXT,
    
    -- Auditor√≠a
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_clinical_records_patient ON clinical_records(patient_id);
CREATE INDEX IF NOT EXISTS idx_clinical_records_tenant ON clinical_records(tenant_id);
CREATE INDEX IF NOT EXISTS idx_clinical_records_date ON clinical_records(record_date DESC);
CREATE INDEX IF NOT EXISTS idx_clinical_records_professional ON clinical_records(professional_id);

-- ==================== TABLA DE TURNOS / CITAS ====================

CREATE TABLE IF NOT EXISTS appointments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id INTEGER NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    patient_id INTEGER NOT NULL REFERENCES patients(id) ON DELETE CASCADE,
    
    -- Datos del Turno
    appointment_datetime TIMESTAMPTZ NOT NULL,
    duration_minutes INTEGER DEFAULT 60,
    
    -- Asignaci√≥n de Recursos
    chair_id INTEGER,
    professional_id INTEGER REFERENCES professionals(id) ON DELETE SET NULL,
    
    -- Tipo de Cita
    appointment_type VARCHAR(50) NOT NULL,
    notes TEXT,
    
    -- Sincronizaci√≥n con Google Calendar
    google_calendar_event_id VARCHAR(255),
    google_calendar_sync_status VARCHAR(20) DEFAULT 'pending',
    
    -- Urgencia (detectada por AI triage)
    urgency_level VARCHAR(20) DEFAULT 'normal',
    urgency_reason TEXT,
    
    -- Estado del Turno
    status VARCHAR(20) DEFAULT 'scheduled',
    cancellation_reason TEXT,
    cancellation_by VARCHAR(50),
    
    -- Source: AI vs Manual booking
    source VARCHAR(20) DEFAULT 'ai',
    
    -- Recordatorio
    reminder_sent BOOLEAN DEFAULT FALSE,
    reminder_sent_at TIMESTAMPTZ,
    
    -- Auditor√≠a
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    completed_at TIMESTAMPTZ
);

CREATE INDEX IF NOT EXISTS idx_appointments_patient ON appointments(patient_id);
CREATE INDEX IF NOT EXISTS idx_appointments_tenant ON appointments(tenant_id);
CREATE INDEX IF NOT EXISTS idx_appointments_datetime ON appointments(appointment_datetime);
CREATE INDEX IF NOT EXISTS idx_appointments_chair ON appointments(chair_id);
CREATE INDEX IF NOT EXISTS idx_appointments_professional ON appointments(professional_id);
CREATE INDEX IF NOT EXISTS idx_appointments_status ON appointments(status);
CREATE INDEX IF NOT EXISTS idx_appointments_urgency ON appointments(urgency_level);
CREATE INDEX IF NOT EXISTS idx_appointments_google_sync ON appointments(google_calendar_sync_status);
CREATE INDEX IF NOT EXISTS idx_appointments_source ON appointments(source);

-- ==================== TABLA DE TRANSACCIONES CONTABLES ====================

CREATE TABLE IF NOT EXISTS accounting_transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id INTEGER NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    patient_id INTEGER REFERENCES patients(id) ON DELETE SET NULL,
    appointment_id UUID REFERENCES appointments(id) ON DELETE SET NULL,
    
    -- Tipo de Transacci√≥n
    transaction_type VARCHAR(50) NOT NULL,
    transaction_date DATE NOT NULL DEFAULT CURRENT_DATE,
    
    -- Monto
    amount NUMERIC(12, 2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'ARS',
    
    -- Detalles del Pago
    payment_method VARCHAR(50),
    description TEXT,
    
    -- Obra Social / Insurance
    insurance_claim_id VARCHAR(100),
    insurance_covered_amount NUMERIC(12, 2) DEFAULT 0,
    patient_paid_amount NUMERIC(12, 2) DEFAULT 0,
    
    -- Estado
    status VARCHAR(20) DEFAULT 'completed',
    
    -- Auditor√≠a
    recorded_by VARCHAR(100),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_accounting_tenant ON accounting_transactions(tenant_id);
CREATE INDEX IF NOT EXISTS idx_accounting_patient ON accounting_transactions(patient_id);
CREATE INDEX IF NOT EXISTS idx_accounting_date ON accounting_transactions(transaction_date DESC);
CREATE INDEX IF NOT EXISTS idx_accounting_type ON accounting_transactions(transaction_type);
CREATE INDEX IF NOT EXISTS idx_accounting_status ON accounting_transactions(status);

-- ==================== TABLA DE CAJA DIARIA ====================

CREATE TABLE IF NOT EXISTS daily_cash_flow (
    id SERIAL PRIMARY KEY,
    tenant_id INTEGER NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    
    -- Fecha
    cash_date DATE NOT NULL,
    
    -- Totales
    total_cash_received NUMERIC(12, 2) DEFAULT 0,
    total_card_received NUMERIC(12, 2) DEFAULT 0,
    total_insurance_claimed NUMERIC(12, 2) DEFAULT 0,
    total_expenses NUMERIC(12, 2) DEFAULT 0,
    
    -- Saldo
    net_balance NUMERIC(12, 2) DEFAULT 0,
    
    -- Registro
    recorded_at TIMESTAMPTZ DEFAULT NOW(),
    recorded_by VARCHAR(100),
    notes TEXT,
    
    -- Constraint: Una sola entrada por fecha/tenant
    UNIQUE (tenant_id, cash_date)
);

CREATE INDEX IF NOT EXISTS idx_daily_cash_flow_tenant ON daily_cash_flow(tenant_id);
CREATE INDEX IF NOT EXISTS idx_daily_cash_flow_date ON daily_cash_flow(cash_date);

-- ==================== GOOGLE CALENDAR INTEGRATION ====================

CREATE TABLE IF NOT EXISTS google_calendar_blocks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id INTEGER NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    
    -- Identificaci√≥n del evento en GCalendar
    google_event_id VARCHAR(255) UNIQUE NOT NULL,
    
    -- Datos del bloqueo
    title VARCHAR(255) NOT NULL,
    description TEXT,
    start_datetime TIMESTAMPTZ NOT NULL,
    end_datetime TIMESTAMPTZ NOT NULL,
    all_day BOOLEAN DEFAULT FALSE,
    
    -- Recursos afectados (opcional)
    professional_id INTEGER REFERENCES professionals(id) ON DELETE CASCADE,
    
    -- Estado de sync
    sync_status VARCHAR(20) DEFAULT 'synced',
    last_sync_at TIMESTAMPTZ DEFAULT NOW(),
    
    -- Auditor√≠a
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_gcalendar_blocks_tenant ON google_calendar_blocks(tenant_id);
CREATE INDEX IF NOT EXISTS idx_gcalendar_blocks_datetime ON google_calendar_blocks(start_datetime, end_datetime);
CREATE INDEX IF NOT EXISTS idx_gcalendar_blocks_professional ON google_calendar_blocks(professional_id);
CREATE INDEX IF NOT EXISTS idx_gcalendar_blocks_sync_status ON google_calendar_blocks(sync_status);

CREATE TABLE IF NOT EXISTS calendar_sync_log (
    id SERIAL PRIMARY KEY,
    tenant_id INTEGER NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    
    sync_type VARCHAR(50) NOT NULL,
    direction VARCHAR(20) NOT NULL,
    
    events_processed INTEGER DEFAULT 0,
    events_created INTEGER DEFAULT 0,
    events_updated INTEGER DEFAULT 0,
    events_deleted INTEGER DEFAULT 0,
    errors_count INTEGER DEFAULT 0,
    
    started_at TIMESTAMPTZ DEFAULT NOW(),
    completed_at TIMESTAMPTZ,
    error_message TEXT
);

CREATE INDEX IF NOT EXISTS idx_calendar_sync_log_tenant ON calendar_sync_log(tenant_id);
CREATE INDEX IF NOT EXISTS idx_calendar_sync_log_date ON calendar_sync_log(started_at DESC);

-- ==================== CONFIGURACI√ìN DE TRATAMIENTOS ====================

CREATE TABLE IF NOT EXISTS treatment_types (
    id SERIAL PRIMARY KEY,
    tenant_id INTEGER NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    
    -- Identificaci√≥n del tratamiento
    code VARCHAR(50) NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    
    -- Configuraci√≥n de duraci√≥n
    default_duration_minutes INTEGER NOT NULL DEFAULT 30,
    min_duration_minutes INTEGER NOT NULL DEFAULT 15,
    max_duration_minutes INTEGER NOT NULL DEFAULT 120,
    
    -- Complejidad del tratamiento
    complexity_level VARCHAR(20) DEFAULT 'medium',
    
    -- Categor√≠a
    category VARCHAR(50),
    
    -- Configuraci√≥n de agendamiento
    requires_multiple_sessions BOOLEAN DEFAULT FALSE,
    session_gap_days INTEGER DEFAULT 0,
    
    -- Estado
    is_active BOOLEAN DEFAULT TRUE,
    is_available_for_booking BOOLEAN DEFAULT TRUE,
    
    -- Notas internas
    internal_notes TEXT,
    
    -- Auditor√≠a
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_treatment_types_tenant ON treatment_types(tenant_id);
CREATE INDEX IF NOT EXISTS idx_treatment_types_code ON treatment_types(code);
CREATE INDEX IF NOT EXISTS idx_treatment_types_category ON treatment_types(category);
CREATE INDEX IF NOT EXISTS idx_treatment_types_active ON treatment_types(is_active, is_available_for_booking);
CREATE UNIQUE INDEX IF NOT EXISTS idx_treatment_types_tenant_code ON treatment_types(tenant_id, code);

-- ==================== DATOS POR DEFECTO: TRATAMIENTOS DENTALES ====================

INSERT INTO treatment_types (
    tenant_id, code, name, description, default_duration_minutes, 
    min_duration_minutes, max_duration_minutes, complexity_level, category,
    requires_multiple_sessions, is_active, is_available_for_booking
)
SELECT 
    t.id, 'checkup', 'Control/Checkup', 'Revisi√≥n general y evaluaci√≥n de salud bucodental',
    20, 15, 30, 'low', 'prevention', FALSE, TRUE, TRUE
FROM tenants t
WHERE NOT EXISTS (SELECT 1 FROM treatment_types tt WHERE tt.tenant_id = t.id AND tt.code = 'checkup');

INSERT INTO treatment_types (tenant_id, code, name, description, default_duration_minutes, min_duration_minutes, max_duration_minutes, complexity_level, category, requires_multiple_sessions, is_active, is_available_for_booking)
SELECT t.id, 'cleaning', 'Limpieza Dental', 'Profilaxis y limpieza profesional', 30, 20, 45, 'low', 'prevention', FALSE, TRUE, TRUE
FROM tenants t WHERE NOT EXISTS (SELECT 1 FROM treatment_types tt WHERE tt.tenant_id = t.id AND tt.code = 'cleaning');

INSERT INTO treatment_types (tenant_id, code, name, description, default_duration_minutes, min_duration_minutes, max_duration_minutes, complexity_level, category, requires_multiple_sessions, is_active, is_available_for_booking)
SELECT t.id, 'emergency', 'Consulta Urgente', 'Atenci√≥n de urgencia odontol√≥gica', 15, 10, 30, 'emergency', 'emergency', FALSE, TRUE, TRUE
FROM tenants t WHERE NOT EXISTS (SELECT 1 FROM treatment_types tt WHERE tt.tenant_id = t.id AND tt.code = 'emergency');

INSERT INTO treatment_types (tenant_id, code, name, description, default_duration_minutes, min_duration_minutes, max_duration_minutes, complexity_level, category, requires_multiple_sessions, is_active, is_available_for_booking)
SELECT t.id, 'extraction', 'Extracci√≥n Dental', 'Extracci√≥n simple o quir√∫rgica de pieza dental', 30, 20, 60, 'medium', 'surgical', FALSE, TRUE, TRUE
FROM tenants t WHERE NOT EXISTS (SELECT 1 FROM treatment_types tt WHERE tt.tenant_id = t.id AND tt.code = 'extraction');

INSERT INTO treatment_types (tenant_id, code, name, description, default_duration_minutes, min_duration_minutes, max_duration_minutes, complexity_level, category, requires_multiple_sessions, is_active, is_available_for_booking)
SELECT t.id, 'root_canal', 'Endodoncia', 'Tratamiento de conducto', 60, 45, 90, 'high', 'restorative', FALSE, TRUE, TRUE
FROM tenants t WHERE NOT EXISTS (SELECT 1 FROM treatment_types tt WHERE tt.tenant_id = t.id AND tt.code = 'root_canal');

INSERT INTO treatment_types (tenant_id, code, name, description, default_duration_minutes, min_duration_minutes, max_duration_minutes, complexity_level, category, requires_multiple_sessions, is_active, is_available_for_booking)
SELECT t.id, 'restoration', 'Restauraci√≥n/Obturaci√≥n', 'Empastes y reconstrucciones', 30, 20, 45, 'medium', 'restorative', FALSE, TRUE, TRUE
FROM tenants t WHERE NOT EXISTS (SELECT 1 FROM treatment_types tt WHERE tt.tenant_id = t.id AND tt.code = 'restoration');

INSERT INTO treatment_types (tenant_id, code, name, description, default_duration_minutes, min_duration_minutes, max_duration_minutes, complexity_level, category, requires_multiple_sessions, session_gap_days, is_active, is_available_for_booking)
SELECT t.id, 'orthodontics', 'Ortodoncia', 'Colocaci√≥n de aparato de ortodoncia', 45, 30, 60, 'high', 'orthodontics', TRUE, 7, TRUE, TRUE
FROM tenants t WHERE NOT EXISTS (SELECT 1 FROM treatment_types tt WHERE tt.tenant_id = t.id AND tt.code = 'orthodontics');

INSERT INTO treatment_types (tenant_id, code, name, description, default_duration_minutes, min_duration_minutes, max_duration_minutes, complexity_level, category, requires_multiple_sessions, is_active, is_available_for_booking)
SELECT t.id, 'consultation', 'Consulta General', 'Primera consulta o evaluaci√≥n', 30, 15, 45, 'low', 'prevention', FALSE, TRUE, TRUE
FROM tenants t WHERE NOT EXISTS (SELECT 1 FROM treatment_types tt WHERE tt.tenant_id = t.id AND tt.code = 'consultation');

-- ==================== FUNCI√ìN PARA OBTENER DURACI√ìN ====================

CREATE OR REPLACE FUNCTION get_treatment_duration(
    p_treatment_code VARCHAR,
    p_tenant_id INTEGER,
    p_urgency_level VARCHAR DEFAULT 'normal'
) RETURNS INTEGER AS $$
DECLARE
    v_duration INTEGER;
    v_min_duration INTEGER;
    v_max_duration INTEGER;
BEGIN
    SELECT default_duration_minutes, min_duration_minutes, max_duration_minutes
    INTO v_duration, v_min_duration, v_max_duration
    FROM treatment_types
    WHERE code = p_treatment_code
      AND tenant_id = p_tenant_id
      AND is_active = TRUE
      AND is_available_for_booking = TRUE;
    
    IF v_duration IS NULL THEN
        RETURN 30;
    END IF;
    
    IF p_urgency_level = 'emergency' THEN
        RETURN LEAST(v_min_duration, v_duration);
    ELSIF p_urgency_level IN ('high', 'normal') THEN
        RETURN v_duration;
    ELSE
        RETURN GREATEST(v_duration, v_max_duration);
    END IF;
END;
$$ LANGUAGE plpgsql;
````

## File: db/models_dental.py
````python
"""
FASE 1: Modelos SQLAlchemy para Plataforma Dental

Este m√≥dulo contiene los modelos ORM que extienden la infraestructura Nexus v3
para soportar la l√≥gica de cl√≠nica dental: pacientes, turnos, historias cl√≠nicas,
contabilidad y profesionales.

Integraci√≥n con la estructura existente:
- Mantiene multi-tenancy (tenant_id en todas las tablas)
- Extiende la clase Base de la DB existente
- Compatible con las migraciones autom√°ticas del lifespan
- Usa JSONB para datos m√©dicos complejos (anamnesis, odontogramas)
- Preserva la infraestructura de WhatsApp y memoria (RedisChatMessageHistory)
"""

from sqlalchemy import (
    Column, Integer, String, Text, Boolean, DateTime, ForeignKey, 
    JSON, JSONB, BigInteger, Numeric, Enum, Index, UniqueConstraint, Date
)
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from datetime import datetime, date
import uuid

# Base is assumed to be imported from db.py in orchestrator_service
# from db import Base

# Para este archivo, definimos la estructura SQL que debe migrarse
DENTAL_MIGRATION_SQL = """

-- ==================== FASE 1: PACIENTES ====================

CREATE TABLE IF NOT EXISTS patients (
    id SERIAL PRIMARY KEY,
    tenant_id INTEGER NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    
    -- Identidad del Paciente
    phone_number VARCHAR(20) NOT NULL,  -- WhatsApp primary key
    dni VARCHAR(15) NOT NULL,            -- Documento Nacional de Identidad (√∫nica validaci√≥n)
    first_name VARCHAR(100) NOT NULL,
    last_name VARCHAR(100) NOT NULL,
    birth_date DATE,
    gender VARCHAR(10),                  -- 'M', 'F', 'Other'
    
    -- Obra Social (Insurance)
    insurance_provider VARCHAR(100),     -- Ej: "OSDE", "SWISS", "Sanatorio Allende"
    insurance_id VARCHAR(50),            -- N√∫mero de afiliado
    insurance_valid_until DATE,          -- Vencimiento de cobertura
    
    -- Anamnesis (JSONB: Historial M√©dico)
    medical_history JSONB DEFAULT '{}',  -- {
                                         --   "allergies": ["Penicilina", "Ibuprofeno"],
                                         --   "medical_conditions": ["Diabetes", "Hipertensi√≥n"],
                                         --   "medications": ["Metformina 1000mg"],
                                         --   "past_treatments": ["Blanqueamiento 2023"],
                                         --   "systemic_diseases": true,
                                         --   "last_checkup": "2024-01-15"
                                         -- }
    
    -- Datos de Contacto
    email VARCHAR(255),
    alternative_phone VARCHAR(20),
    
    -- Estado del Paciente
    status VARCHAR(20) DEFAULT 'active',  -- 'active', 'inactive', 'archived'
    preferred_schedule VARCHAR(50),       -- Ej: "Ma√±ana", "Tarde", "Fin de semana"
    notes TEXT,
    
    -- Auditor√≠a
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    last_visit TIMESTAMPTZ,
    
    -- Constraints
    UNIQUE (tenant_id, phone_number),
    UNIQUE (tenant_id, dni)
);

CREATE INDEX idx_patients_tenant_phone ON patients(tenant_id, phone_number);
CREATE INDEX idx_patients_tenant_dni ON patients(tenant_id, dni);
CREATE INDEX idx_patients_status ON patients(status);
CREATE INDEX idx_patients_insurance ON patients(insurance_provider);

-- ==================== FASE 1: HISTORIAS CL√çNICAS ====================

CREATE TABLE IF NOT EXISTS clinical_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id INTEGER NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    patient_id INTEGER NOT NULL REFERENCES patients(id) ON DELETE CASCADE,
    
    -- Metadata del Registro
    record_date DATE NOT NULL DEFAULT CURRENT_DATE,
    professional_id INTEGER REFERENCES professionals(id) ON DELETE SET NULL,  -- Odont√≥logo responsable
    
    -- Odontograma (JSONB: Representaci√≥n gr√°fica de dientes)
    odontogram JSONB DEFAULT '{}',  -- {
                                    --   "tooth_32": {
                                    --     "number": 32,
                                    --     "quadrant": 3,
                                    --     "tooth_type": "molar",
                                    --     "status": "healthy",           -- 'healthy', 'caries', 'missing', 'implant', 'crowned'
                                    --     "surfaces": {
                                    --       "occlusal": "caries",
                                    --       "mesial": "healthy",
                                    --       "distal": "healthy",
                                    --       "buccal": "healthy",
                                    --       "lingual": "healthy"
                                    --     },
                                    --     "notes": "Caries inicial en superficie oclusal"
                                    --   },
                                    --   ...
                                    -- }
    
    -- Diagn√≥sticos Principales
    diagnosis TEXT,                  -- Texto libre: Ej "Caries m√∫ltiples, gingivitis moderada"
    
    -- Tratamientos Realizados
    treatments JSONB DEFAULT '[]',   -- [
                                     --   {
                                     --     "date": "2025-01-15",
                                     --     "type": "cleaning",
                                     --     "description": "Profilaxis con fluoruro",
                                     --     "teeth": [11, 12, 13],
                                     --     "cost": 500,
                                     --     "insurance_covered": true
                                     --   },
                                     --   ...
                                     -- ]
    
    -- Radiograf√≠as & Documentaci√≥n
    radiographs JSONB DEFAULT '[]',  -- [
                                     --   {
                                     --     "date": "2025-01-15",
                                     --     "type": "panoramic",
                                     --     "storage_url": "s3://bucket/x-ray-123.jpg",
                                     --     "notes": "Radiograf√≠a de seguimiento"
                                     --   },
                                     --   ...
                                     -- ]
    
    -- Plan de Tratamiento Futuro
    treatment_plan JSONB DEFAULT '{}',  -- {
                                        --   "estimated_sessions": 5,
                                        --   "planned_treatments": ["Endodoncia 11", "Corona 12"],
                                        --   "estimated_cost": 15000,
                                        --   "priority": "medium"
                                        -- }
    
    -- Observaciones Cl√≠nicas
    clinical_notes TEXT,
    recommendations TEXT,
    
    -- Auditor√≠a
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_clinical_records_patient ON clinical_records(patient_id);
CREATE INDEX idx_clinical_records_tenant ON clinical_records(tenant_id);
CREATE INDEX idx_clinical_records_date ON clinical_records(record_date DESC);
CREATE INDEX idx_clinical_records_professional ON clinical_records(professional_id);

-- ==================== FASE 1: TURNOS (APPOINTMENTS) ====================

CREATE TABLE IF NOT EXISTS appointments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id INTEGER NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    patient_id INTEGER NOT NULL REFERENCES patients(id) ON DELETE CASCADE,
    
    -- Datos del Turno
    appointment_datetime TIMESTAMPTZ NOT NULL,
    duration_minutes INTEGER DEFAULT 60,
    
    -- Asignaci√≥n de Recursos
    chair_id INTEGER,                 -- Sill√≥n/Box n√∫mero
    professional_id INTEGER REFERENCES professionals(id) ON DELETE SET NULL,  -- Odont√≥logo asignado
    
    -- Tipo de Cita
    appointment_type VARCHAR(50) NOT NULL,  -- 'checkup', 'cleaning', 'treatment', 'emergency', 'followup'
    notes TEXT,
    
    -- Sincronizaci√≥n con Google Calendar
    google_calendar_event_id VARCHAR(255),
    google_calendar_sync_status VARCHAR(20) DEFAULT 'pending',  -- 'pending', 'synced', 'failed'
    
    -- Urgencia (detectada por AI triage)
    urgency_level VARCHAR(20) DEFAULT 'normal',  -- 'low', 'normal', 'high', 'emergency'
    urgency_reason TEXT,                        -- Ej: "Dolor agudo en molar"
    
    -- Estado del Turno
    status VARCHAR(20) DEFAULT 'scheduled',  -- 'scheduled', 'confirmed', 'in-progress', 'completed', 'cancelled', 'no-show'
    cancellation_reason TEXT,
    cancellation_by VARCHAR(50),              -- 'patient', 'clinic', 'system'
    
    -- Recordatorio
    reminder_sent BOOLEAN DEFAULT FALSE,
    reminder_sent_at TIMESTAMPTZ,
    
    -- Auditor√≠a
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    completed_at TIMESTAMPTZ
);

CREATE INDEX idx_appointments_patient ON appointments(patient_id);
CREATE INDEX idx_appointments_tenant ON appointments(tenant_id);
CREATE INDEX idx_appointments_datetime ON appointments(appointment_datetime);
CREATE INDEX idx_appointments_chair ON appointments(chair_id);
CREATE INDEX idx_appointments_professional ON appointments(professional_id);
CREATE INDEX idx_appointments_status ON appointments(status);
CREATE INDEX idx_appointments_urgency ON appointments(urgency_level);
CREATE INDEX idx_appointments_google_sync ON appointments(google_calendar_sync_status);

-- ==================== FASE 1: PROFESIONALES ====================

CREATE TABLE IF NOT EXISTS professionals (
    id SERIAL PRIMARY KEY,
    tenant_id INTEGER NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    
    -- Identidad
    first_name VARCHAR(100) NOT NULL,
    last_name VARCHAR(100) NOT NULL,
    license_number VARCHAR(100) UNIQUE,  -- Matr√≠cula profesional
    specialization VARCHAR(100),          -- Ej: "Endodoncia", "Ortodoncia"
    
    -- Disponibilidad
    is_active BOOLEAN DEFAULT TRUE,
    schedule_json JSONB DEFAULT '{}',     -- {
                                          --   "monday": ["09:00-13:00", "14:00-18:00"],
                                          --   "tuesday": ["09:00-13:00", "14:00-18:00"],
                                          --   ...
                                          -- }
    
    -- Contacto
    email VARCHAR(255),
    phone VARCHAR(20),
    
    -- Auditor√≠a
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_professionals_tenant ON professionals(tenant_id);
CREATE INDEX idx_professionals_active ON professionals(is_active);

-- ==================== FASE 1: CONTABILIDAD ====================

CREATE TABLE IF NOT EXISTS accounting_transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id INTEGER NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    patient_id INTEGER REFERENCES patients(id) ON DELETE SET NULL,
    appointment_id UUID REFERENCES appointments(id) ON DELETE SET NULL,
    
    -- Tipo de Transacci√≥n
    transaction_type VARCHAR(50) NOT NULL,  -- 'payment', 'insurance_claim', 'expense', 'refund'
    transaction_date DATE NOT NULL DEFAULT CURRENT_DATE,
    
    -- Monto
    amount NUMERIC(12, 2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'ARS',
    
    -- Detalles del Pago
    payment_method VARCHAR(50),             -- 'cash', 'card', 'transfer', 'insurance'
    description TEXT,
    
    -- Obra Social / Insurance
    insurance_claim_id VARCHAR(100),        -- Para rastreo OSDE, etc.
    insurance_covered_amount NUMERIC(12, 2) DEFAULT 0,
    patient_paid_amount NUMERIC(12, 2) DEFAULT 0,
    
    -- Estado
    status VARCHAR(20) DEFAULT 'completed',  -- 'pending', 'completed', 'failed'
    
    -- Auditor√≠a
    recorded_by VARCHAR(100),                -- Usuario que registr√≥
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_accounting_tenant ON accounting_transactions(tenant_id);
CREATE INDEX idx_accounting_patient ON accounting_transactions(patient_id);
CREATE INDEX idx_accounting_date ON accounting_transactions(transaction_date DESC);
CREATE INDEX idx_accounting_type ON accounting_transactions(transaction_type);
CREATE INDEX idx_accounting_status ON accounting_transactions(status);

-- ==================== FASE 1: REPORTE DE CAJA DIARIA ====================

CREATE TABLE IF NOT EXISTS daily_cash_flow (
    id SERIAL PRIMARY KEY,
    tenant_id INTEGER NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    
    -- Fecha
    cash_date DATE NOT NULL,
    
    -- Totales
    total_cash_received NUMERIC(12, 2) DEFAULT 0,
    total_card_received NUMERIC(12, 2) DEFAULT 0,
    total_insurance_claimed NUMERIC(12, 2) DEFAULT 0,
    total_expenses NUMERIC(12, 2) DEFAULT 0,
    
    -- Saldo
    net_balance NUMERIC(12, 2) DEFAULT 0,
    
    -- Registro
    recorded_at TIMESTAMPTZ DEFAULT NOW(),
    recorded_by VARCHAR(100),
    notes TEXT,
    
    -- Constraint: Una sola entrada por fecha/tenant
    UNIQUE (tenant_id, cash_date)
);

CREATE INDEX idx_daily_cash_flow_tenant ON daily_cash_flow(tenant_id);
CREATE INDEX idx_daily_cash_flow_date ON daily_cash_flow(cash_date);

"""

# ==================== DEFINICI√ìN DE MODELOS SQLALCHEMY ====================
# (Estos sirven como referencia; la migraci√≥n se ejecuta v√≠a SQL)

from sqlalchemy.orm import declarative_base
Base = declarative_base()

class Patient(Base):
    """Modelo ORM para Pacientes"""
    __tablename__ = "patients"
    
    id = Column(Integer, primary_key=True, index=True)
    tenant_id = Column(Integer, ForeignKey("tenants.id", ondelete="CASCADE"), nullable=False)
    phone_number = Column(String(20), nullable=False, index=True)
    dni = Column(String(15), nullable=False)
    first_name = Column(String(100), nullable=False)
    last_name = Column(String(100), nullable=False)
    birth_date = Column(Date)
    gender = Column(String(10))
    insurance_provider = Column(String(100))
    insurance_id = Column(String(50))
    insurance_valid_until = Column(Date)
    medical_history = Column(JSON, default={})
    email = Column(String(255))
    alternative_phone = Column(String(20))
    status = Column(String(20), default="active", index=True)
    preferred_schedule = Column(String(50))
    notes = Column(Text)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    last_visit = Column(DateTime)
    
    __table_args__ = (
        UniqueConstraint('tenant_id', 'phone_number', name='uq_patient_tenant_phone'),
        UniqueConstraint('tenant_id', 'dni', name='uq_patient_tenant_dni'),
    )


class ClinicalRecord(Base):
    """Modelo ORM para Historias Cl√≠nicas"""
    __tablename__ = "clinical_records"
    
    id = Column(String(36), primary_key=True, default=lambda: str(uuid.uuid4()))
    tenant_id = Column(Integer, ForeignKey("tenants.id", ondelete="CASCADE"), nullable=False, index=True)
    patient_id = Column(Integer, ForeignKey("patients.id", ondelete="CASCADE"), nullable=False, index=True)
    record_date = Column(Date, nullable=False, default=date.today, index=True)
    professional_id = Column(Integer, ForeignKey("professionals.id", ondelete="SET NULL"))
    odontogram = Column(JSON, default={})
    diagnosis = Column(Text)
    treatments = Column(JSON, default=[])
    radiographs = Column(JSON, default=[])
    treatment_plan = Column(JSON, default={})
    clinical_notes = Column(Text)
    recommendations = Column(Text)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)


class Appointment(Base):
    """Modelo ORM para Turnos/Citas"""
    __tablename__ = "appointments"
    
    id = Column(String(36), primary_key=True, default=lambda: str(uuid.uuid4()))
    tenant_id = Column(Integer, ForeignKey("tenants.id", ondelete="CASCADE"), nullable=False, index=True)
    patient_id = Column(Integer, ForeignKey("patients.id", ondelete="CASCADE"), nullable=False, index=True)
    appointment_datetime = Column(DateTime, nullable=False, index=True)
    duration_minutes = Column(Integer, default=60)
    chair_id = Column(Integer)
    professional_id = Column(Integer, ForeignKey("professionals.id", ondelete="SET NULL"))
    appointment_type = Column(String(50), nullable=False)
    notes = Column(Text)
    google_calendar_event_id = Column(String(255))
    google_calendar_sync_status = Column(String(20), default="pending", index=True)
    urgency_level = Column(String(20), default="normal", index=True)
    urgency_reason = Column(Text)
    status = Column(String(20), default="scheduled", index=True)
    cancellation_reason = Column(Text)
    cancellation_by = Column(String(50))
    reminder_sent = Column(Boolean, default=False)
    reminder_sent_at = Column(DateTime)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    completed_at = Column(DateTime)


class Professional(Base):
    """Modelo ORM para Profesionales (Odont√≥logos)"""
    __tablename__ = "professionals"
    
    id = Column(Integer, primary_key=True, index=True)
    tenant_id = Column(Integer, ForeignKey("tenants.id", ondelete="CASCADE"), nullable=False, index=True)
    first_name = Column(String(100), nullable=False)
    last_name = Column(String(100), nullable=False)
    license_number = Column(String(100), unique=True)
    specialization = Column(String(100))
    is_active = Column(Boolean, default=True, index=True)
    schedule_json = Column(JSON, default={})
    email = Column(String(255))
    phone = Column(String(20))
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)


class AccountingTransaction(Base):
    """Modelo ORM para Transacciones Contables"""
    __tablename__ = "accounting_transactions"
    
    id = Column(String(36), primary_key=True, default=lambda: str(uuid.uuid4()))
    tenant_id = Column(Integer, ForeignKey("tenants.id", ondelete="CASCADE"), nullable=False, index=True)
    patient_id = Column(Integer, ForeignKey("patients.id", ondelete="SET NULL"))
    appointment_id = Column(String(36), ForeignKey("appointments.id", ondelete="SET NULL"))
    transaction_type = Column(String(50), nullable=False, index=True)
    transaction_date = Column(Date, nullable=False, default=date.today, index=True)
    amount = Column(Numeric(12, 2), nullable=False)
    currency = Column(String(3), default="ARS")
    payment_method = Column(String(50))
    description = Column(Text)
    insurance_claim_id = Column(String(100))
    insurance_covered_amount = Column(Numeric(12, 2), default=0)
    patient_paid_amount = Column(Numeric(12, 2), default=0)
    status = Column(String(20), default="completed", index=True)
    recorded_by = Column(String(100))
    created_at = Column(DateTime, default=datetime.utcnow)


class DailyCashFlow(Base):
    """Modelo ORM para Reporte de Caja Diaria"""
    __tablename__ = "daily_cash_flow"
    
    id = Column(Integer, primary_key=True, index=True)
    tenant_id = Column(Integer, ForeignKey("tenants.id", ondelete="CASCADE"), nullable=False, index=True)
    cash_date = Column(Date, nullable=False)
    total_cash_received = Column(Numeric(12, 2), default=0)
    total_card_received = Column(Numeric(12, 2), default=0)
    total_insurance_claimed = Column(Numeric(12, 2), default=0)
    total_expenses = Column(Numeric(12, 2), default=0)
    net_balance = Column(Numeric(12, 2), default=0)
    recorded_at = Column(DateTime, default=datetime.utcnow)
    recorded_by = Column(String(100))
    notes = Column(Text)
    
    __table_args__ = (
        UniqueConstraint('tenant_id', 'cash_date', name='uq_daily_cash_flow'),
    )
````

## File: docs/01_architecture.md
````markdown
# Arquitectura del Sistema - Dentalogic

Este documento describe la estructura t√©cnica, el flujo de datos y la interacci√≥n entre los componentes de la plataforma de gesti√≥n cl√≠nica Mercedes.

## 1. Diagrama de Bloques (Conceptual)

```
Usuario WhatsApp (Paciente)
        |
        | Audio/Texto
        v
WhatsApp Service (8002)
  - YCloud Webhook
  - Deduplicaci√≥n (Redis)
  - Transcripci√≥n (Whisper)
        |
        | POST /chat
        v
Orchestrator Service (8000)
  - LangChain Agent (Mercedes)
  - Tools Cl√≠nicas (Agenda, Triaje)
  - Memoria Hist√≥rica (Postgres)
  - Lockout (24h)
  - Socket.IO Server (Real-time)
        |
    ____|____
   /    |    \
  v     v     v
PostgreSQL Redis OpenAI
(Historias)(Locks)(LLM)
   |
   v
Frontend React (5173)
Centro de Operaciones Dental
   |
   | WebSocket (Socket.IO)
   v
AgendaView / Odontograma
   - FullCalendar
   - Real-time updates
```

## 2. Estructura de Microservicios (Dentalogic)

### A. WhatsApp Service (Puerto 8002)

**Tecnolog√≠a:** FastAPI + httpx + Redis

**Funci√≥n:** Interfaz de comunicaci√≥n con pacientes v√≠a YCloud.

**Responsabilidades:**
- **Transcripci√≥n Whisper:** Convierte audios de s√≠ntomas en texto para el an√°lisis de la IA.
- **Deduplicaci√≥n:** Evita procesar el mismo mensaje de WhatsApp m√∫ltiples veces.
- **Buffering:** Agrupa mensajes enviados en r√°faga para dar un contexto completo.
- **Relay de Audio:** Permite que los audios sean escuchados por humanos en el dashboard.

### B. Orchestrator Service (Puerto 8000) - **Coordinador Cl√≠nico**

**Tecnolog√≠a:** FastAPI + LangChain + OpenAI + PostgreSQL

**Funci√≥n:** Procesamiento de lenguaje natural, clasificaci√≥n de urgencias y gesti√≥n de agenda.

**Tools Cl√≠nicas Integradas:**
- `check_availability(date)`: Consulta disponibilidad real en la base de datos.
- `book_appointment(datetime, reason)`: Registra un nuevo turno y emite eventos WebSocket.
- `triage_urgency(symptoms)`: Clasifica el nivel de dolor/gravedad (emergency, high, normal, low).
- `derivhumano(reason)`: Notifica al profesional y silencia el bot por 24h.

**Gesti√≥n de Datos:**
- **Memoria Persistente:** Vincula cada chat con el `patient_id` para mantener la continuidad del tratamiento.
- **Sincronizaci√≥n:** Emite eventos `NEW_APPOINTMENT` v√≠a Socket.IO para actualizar la AgendaView instant√°neamente.
- **Multi-Tenancy:** Soporte para m√∫ltiples consultorios/cl√≠nicas bajo la misma infraestructura.

### C. Frontend React (Puerto 80) - **Centro de Operaciones**

**Tecnolog√≠a:** React + Vite + FullCalendar + Socket.IO

**Carpeta:** `frontend_react/`

**Vistas Principales:**
- **Agenda Inteligente:** Calendario interactivo con sincronizaci√≥n de Google Calendar.
- **Perfil 360¬∞ del Paciente:** Acceso a historias cl√≠nicas, antecedentes y notas de evoluci√≥n.
- **Monitor de Triaje:** Alertas inmediatas cuando la IA detecta una urgencia grave.

## 3. Base de Datos (PostgreSQL)

### Tablas Principales (Esquema Dental)

| Tabla | Funci√≥n |
| :--- | :--- |
| **professionals** | Datos de los odont√≥logos y sus especialidades. |
| **patients** | Registro demogr√°fico y antecedentes m√©dicos (JSONB). |
| **clinical_records** | Evoluciones cl√≠nicas, diagn√≥sticos y odontogramas. |
| **appointments** | Gesti√≥n de turnos, estados y sincronizaci√≥n GCalendar. |
| **accounting_transactions** | Liquidaciones y cobros de prestaciones. |
| **users** | Credenciales, roles y estado de aprobaci√≥n. |

### 3.2 Maintenance Robot (Self-Healing)
El sistema utiliza un **Robot de Mantenimiento** integrado en `orchestrator_service/db.py` que garantiza la integridad del esquema en cada arranque:
- **Foundation**: Si no existe la tabla `tenants`, aplica el esquema base completo.
- **Evolution Pipeline**: Una lista de parches (`patches`) en Python que ejecutan bloques `DO $$` para agregar columnas o tablas nuevas de forma idempotente y segura.
- **Resiliencia**: El motor SQL ignora comentarios y respeta bloques de c√≥digo complejos, evitando errores de sintaxis comunes en despliegues automatizados.

## 4. Seguridad e Identidad (Auth Layer)

Dentalogic implementa una arquitectura de **Seguridad de Triple Capa**:

1.  **Capa de Identidad (JWT)**: Gesti√≥n de sesiones de usuario con tokens firmados (HS256). Define el rol (`ceo`, `professional`, `secretary`) y el `tenant_id`.
2.  **Capa de Infraestructura (X-Admin-Token)**: Las rutas administrativas cr√≠ticas requieren un token est√°tico (`INTERNAL_SECRET_KEY`) para prevenir accesos no autorizados incluso si la sesi√≥n del usuario es v√°lida.
3.  **Capa de Gatekeeper (Aprobaci√≥n)**: Todo registro nuevo entra en estado `pending`. Solo un usuario con rol `ceo` puede activar cuentas desde el panel de control.

## 5. Flujo de una Urgencia

1. **Paciente** env√≠a audio: "Me duele mucho la muela, est√° hinchado".
2. **WhatsApp Service** transcribe v√≠a Whisper.
3. **Orchestrator** recibe texto y ejecuta `triage_urgency()`.
4. **IA** clasifica como `high` (Urgencia) y sugiere turnos pr√≥ximos.
5. **Platform UI** muestra una notificaci√≥n visual roja al administrativo.
6. **Agente** responde: "Entiendo que es un dolor fuerte. Tengo un hueco hoy a las 16hs, ¬øte sirve?".

---

*Documentaci√≥n Dentalogic ¬© 2026*
Ê≥õ
````

## File: docs/02_environment_variables.md
````markdown
# Variables de Entorno - Gu√≠a Completa

Este proyecto se configura completamente mediante variables de entorno. En despliegue de EasyPanel, carga estas variables para cada microservicio.

## 1. Variables Globales (Todos los Servicios)

| Variable | Descripci√≥n | Ejemplo | Requerida |
| :--- | :--- | :--- | :--- |
| `INTERNAL_API_TOKEN` | Token de seguridad entre microservicios | `compu-global-hyper-mega-net` | ‚úÖ |
| `OPENAI_API_KEY` | Clave API de OpenAI (GPT-4o-mini + Whisper) | `sk-proj-xxxxx` | ‚úÖ |
| `REDIS_URL` | URL de conexi√≥n a Redis | `redis://redis:6379` | ‚úÖ |
| `POSTGRES_DSN` | URL de conexi√≥n a PostgreSQL | `postgres://user:pass@db:5432/database` | ‚úÖ |

## 2. Orchestrator Service (8000)

### 2.1 Identidad y Branding (Whitelabel)

| Variable | Descripci√≥n | Ejemplo | Requerida |
| :--- | :--- | :--- | :--- |
| `STORE_NAME` | Nombre de la tienda | `Pointe Coach` | ‚úÖ |
| `BOT_PHONE_NUMBER` | N√∫mero de WhatsApp del bot | `+5493756123456` | ‚úÖ |
| `STORE_LOCATION` | Ciudad/Pa√≠s | `Paran√°, Entre R√≠os, Argentina` | ‚ùå |
| `STORE_WEBSITE` | URL de la tienda online | `https://www.pointecoach.shop` | ‚ùå |
| `STORE_DESCRIPTION` | Qu√© vende la tienda | `Art√≠culos de danza y gimnasia` | ‚ùå |
| `STORE_CATALOG_KNOWLEDGE` | Categor√≠as/marcas principales (para inyectar en prompt) | `Puntas Grishko, Bloch, Capezio...` | ‚ùå |
| `SHIPPING_PARTNERS` | Empresas de env√≠o (comma-separated) | `Andreani, Correo Argentino` | ‚ùå |

**Nota:** El sistema inyecta estas variables en el `system_prompt` del agente LangChain.
   
### 2.2 Integraci√≥n Tienda Nube

| Variable | Descripci√≥n | Ejemplo | Requerida |
| :--- | :--- | :--- | :--- |
| `TIENDANUBE_STORE_ID` | ID num√©rico de la tienda en TN | `123456` | ‚úÖ |
| `TIENDANUBE_ACCESS_TOKEN` | Token de API de Tienda Nube | `t_1234567890...` | ‚úÖ |

### 2.3 Handoff / Derivaci√≥n a Humanos

| Variable | Descripci√≥n | Ejemplo | Requerida |
| :--- | :--- | :--- | :--- |
| `HANDOFF_EMAIL` | Mail que recibe alertas de derivaci√≥n | `soporte@tienda.com` | ‚úÖ (si handoff activo) |
| `SMTP_HOST` | Host del servidor SMTP | `smtp.gmail.com` | ‚úÖ (si handoff activo) |
| `SMTP_PORT` | Puerto del servidor SMTP | `465` | ‚úÖ (si handoff activo) |
| `SMTP_USER` / `SMTP_USERNAME` | Usuario SMTP | `noreply@tienda.com` | ‚úÖ (si handoff activo) |
| `SMTP_PASS` / `SMTP_PASSWORD` | Contrase√±a SMTP | (password de app) | ‚úÖ (si handoff activo) |
| `SMTP_SECURITY` | Tipo de seguridad SMTP | `SSL` o `STARTTLS` | ‚úÖ (si handoff activo) |

### 2.4 Seguridad y RBAC (Nexus v7.6)

| Variable | Descripci√≥n | Ejemplo | Requerida |
| :--- | :--- | :--- | :--- |
| `ADMIN_TOKEN` | Token maestro de protecci√≥n | `admin-secret-token` | ‚úÖ |
| `JWT_SECRET_KEY` | Clave secreta para firmar tokens JWT | `mue-la-se-cre-t-a` | ‚úÖ |
| `JWT_ALGORITHM` | Algoritmo de firma para JWT | `HS256` | `HS256` |
| `ACCESS_TOKEN_EXPIRE_MINUTES` | Duraci√≥n del token de sesi√≥n | `43200` (30 d√≠as) | `30` |
| `PLATFORM_URL` | URL del frontend (para links de activaci√≥n) | `https://ui.clinic.com` | `http://localhost:3000` |
| `CORS_ALLOWED_ORIGINS` | Origins CORS permitidos (comma-separated) | `http://localhost:3000,https://domain.com` | `*` |

## 3. WhatsApp Service (8002)

| Variable | Descripci√≥n | Ejemplo | Requerida |
| :--- | :--- | :--- | :--- |
| `YCLOUD_API_KEY` | API Key de YCloud | `api_key_xxxxx` | ‚úÖ |
| `YCLOUD_WEBHOOK_SECRET` | Secreto para validar webhooks de YCloud | `webhook_secret_xxxxx` | ‚úÖ |
| `ORCHESTRATOR_SERVICE_URL` | URL del Orchestrator (interna) | `http://orchestrator_service:8000` | ‚úÖ |
| `INTERNAL_API_TOKEN` | Token para comunicarse con Orchestrator | (mismo que global) | ‚úÖ |

## 4. Platform UI (80)

| Variable | Descripci√≥n | Ejemplo | Requerida |
| :--- | :--- | :--- | :--- |
| `ORCHESTRATOR_URL` | URL del Orchestrator (para admin panel) | (auto-detecta) | ‚ùå |
| `VITE_ADMIN_TOKEN` | Token de administrador (inyectado en build) | `admin-secret-token` | ‚úÖ |
| `VITE_API_BASE_URL` | URL base para la API del orquestador | (auto-detecta) | ‚ùå |

## 5. Ejemplo de .env (Desarrollo Local)

```bash
# --- Globales ---
INTERNAL_API_TOKEN=super-secret-dev-token
OPENAI_API_KEY=sk-proj-xxxxx
REDIS_URL=redis://redis:6379
POSTGRES_DSN=postgres://postgres:password@localhost:5432/nexus_db

# --- Auth & Platform ---
JWT_SECRET_KEY=mi-llave-maestra-dental
PLATFORM_URL=https://dentalogic-frontend.ugwrjq.easypanel.host
ACCESS_TOKEN_EXPIRE_MINUTES=43200
ADMIN_TOKEN=admin-dev-token

# --- Orchestrator ---
STORE_NAME=Dentalogic
BOT_PHONE_NUMBER=+5493756123456
CORS_ALLOWED_ORIGINS=http://localhost:3000

# --- WhatsApp ---
YCLOUD_API_KEY=yc_api_xxxxx
YCLOUD_WEBHOOK_SECRET=yc_webhook_xxxxx
ORCHESTRATOR_SERVICE_URL=http://orchestrator_service:8000

# --- Frontend (Build Time) ---
VITE_ADMIN_TOKEN=admin-dev-token
VITE_API_URL=http://localhost:8000
```

---

*Gu√≠a de Variables ¬© 2026*
Ê≥õ
````

## File: docs/03_deployment_guide.md
````markdown
# Despliegue en EasyPanel / Docker - Gu√≠a Completa

Este proyecto est√° optimizado para EasyPanel, un orquestador de contenedores basado en Docker.

## 1. Estructura del Proyecto en EasyPanel

### 1.1 Crear un Nuevo Proyecto

```
EasyPanel Dashboard
  ‚Üí New Project
  ‚Üí Select Source: GitHub (o Git Repo)
  ‚Üí Seleccionar este repositorio
```

### 1.2 Agregar Infraestructura (Add-ons)

#### PostgreSQL
```
1. Click "Add Service" ‚Üí Search "PostgreSQL"
2. Configurar:
   - Version: 13+ (recomendado 13 o 15)
   - Username: postgres
   - Password: (strong password)
   - Database: nexus_db
3. Copiar conexi√≥n string: postgres://user:pass@host:5432/nexus_db
4. Asignar a POSTGRES_DSN
```

#### Redis
```
1. Click "Add Service" ‚Üí Search "Redis"
2. Configurar:
   - Version: Alpine (m√°s liviano)
   - Password: (optional pero recomendado)
3. Copiar conexi√≥n string: redis://host:6379
4. Asignar a REDIS_URL
```

## 2. Despliegue de Microservicios

### 2.1 WhatsApp Service (Puerto 8002) - P√öBLICO

```
1. Add Service ‚Üí Docker
2. Nombre: whatsapp-service
3. Dockerfile: whatsapp_service/Dockerfile
4. Puerto: 8002
5. Dominio: wa.tudominio.com (HTTPS autom√°tico con Let's Encrypt)
6. Healthcheck:
   - Path: /health
   - Port: 8002
   - Interval: 30s
   - Timeout: 10s
7. Variables de Entorno:
   - YCLOUD_API_KEY=...
   - YCLOUD_WEBHOOK_SECRET=...
   - INTERNAL_API_TOKEN=...
   - ORCHESTRATOR_SERVICE_URL=http://orchestrator_service:8000
   - REDIS_URL=...
8. Deploy
```

**Importante:** El servicio acepta webhooks en `/webhook` y `/webhook/ycloud` para m√°xima compatibilidad con el panel de YCloud.
```
https://wa.tudominio.com/webhook
```

### 2.2 Orchestrator Service (Puerto 8000) - INTERNO

```
1. Add Service ‚Üí Docker
2. Nombre: orchestrator-service
3. Dockerfile: orchestrator_service/Dockerfile
4. Puerto: 8000
5. Dominio: (OPCIONAL - puedes usar nombre de servicio internamente)
6. Healthcheck:
   - Path: /health
   - Port: 8000
   - Interval: 30s
7. Variables de Entorno:
   - OPENAI_API_KEY=...
   - POSTGRES_DSN=... (copiada de PostgreSQL add-on)
   - REDIS_URL=... (copiada de Redis add-on)
   - INTERNAL_API_TOKEN=...
   - STORE_NAME=...
   - BOT_PHONE_NUMBER=...
   - TIENDANUBE_STORE_ID=...
   - TIENDANUBE_ACCESS_TOKEN=...
   - HANDOFF_EMAIL=...
   - SMTP_HOST=...
   - SMTP_PORT=...
   - SMTP_USER=...
   - SMTP_PASS=...
   - ADMIN_TOKEN=...
   - CORS_ALLOWED_ORIGINS=...
8. Deploy
```

**Nota:** El Orchestrator ejecuta migraciones de BD autom√°ticamente en startup (via lifespan event).

### 2.3 Frontend React (Puerto 80) - P√öBLICO

```
1. Add Service ‚Üí Docker
2. Nombre: frontend-react
3. Dockerfile: frontend_react/Dockerfile
4. Puerto: 80
5. Dominio: admin.tudominio.com (HTTPS)
6. Healthcheck: (la UI es React, puede no tener endpoint /health)
7. Variables de Entorno:
   - ADMIN_TOKEN=... (copia el mismo del Orchestrator)
   - ORCHESTRATOR_URL=http://orchestrator_service:8000 (o deja en blanco para auto-detectar)
8. Deploy
```

**Auto-detecci√≥n de URL:**
Si no especificas `ORCHESTRATOR_URL`, el Frontend React lo detecta autom√°ticamente:
- `localhost` ‚Üí `http://localhost:8000`
- `frontend-react.domain.com` ‚Üí `orchestrator-service.domain.com`

## 3. Mapeo de Puertos y Networking

| Servicio | Puerto Interno | Exposici√≥n P√∫blica | URL |
| :--- | :--- | :--- | :--- |
| whatsapp_service | 8002 | ‚úÖ S√ç | `https://wa.tudominio.com` |
| orchestrator_service | 8000 | ‚ùå NO (interno) | `http://orchestrator_service:8000` (red interna) |
| frontend_react | 80 | ‚úÖ S√ç | `https://admin.tudominio.com` |
| postgres | 5432 | ‚ùå NO (solo desde servicios) | `postgres://...@postgres:5432` |
| redis | 6379 | ‚ùå NO (solo desde servicios) | `redis://redis:6379` |

## 4. Pasos Cr√≠ticos Post-Deploy

### 4.1 Migraciones de Base de Datos

El `orchestrator_service` ejecuta migraciones autom√°ticamente en startup:
```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    # Conecta a DB
    await db.connect()
    
    # Ejecuta schema (dentalogic_schema.sql)
    # El sistema usa un Smart Splitter para ejecutar cada sentencia individualmente
    # garantizando compatibilidad con funciones PL/pgSQL complejas.
    await sync_environment()
```

**Si la BD es nueva:**
- Se crean tablas desde `dentalogic_schema.sql` (ejecutar manualmente)
- Se crea un "default tenant" usando las variables de entorno

**Si ya existe:**
- Las migraciones son idempotentes (CREATE TABLE IF NOT EXISTS)
- No sobreescriben datos existentes (por defecto)

**Para resetear BD (en desarrollo):**
```bash
# Conectar a PostgreSQL (via EasyPanel console)
psql -U postgres -d nexus_db

# Dropear y recrear
DROP TABLE IF EXISTS chat_messages CASCADE;
DROP TABLE IF EXISTS chat_conversations CASCADE;
-- Luego reiniciar orchestrator_service
-- Las migraciones se ejecutan autom√°ticamente
```

### 4.2 Configuraci√≥n de Webhooks (YCloud)

1. Ve a panel de YCloud
2. Busca "Webhook Settings" o "API Configuration"
3. Configura:
   - **URL:** `https://wa.tudominio.com/webhook/ycloud`
   - **Secret:** El valor de `YCLOUD_WEBHOOK_SECRET` (debe coincidir)
   - **Events:** Message, MessageStatus, etc.
4. Prueba webhook (ping test desde panel de YCloud)

### 4.3 Verificar Conectividad

```bash
# Desde la consola de EasyPanel:

# ¬øOrchestrator arranc√≥?
curl http://orchestrator_service:8000/health

# ¬øWhatsApp Service arranc√≥?
curl http://whatsapp_service:8002/health

# ¬øPostgreSQL accesible?
psql -U postgres -h postgres -d nexus_db -c "SELECT 1"

# ¬øRedis accesible?
redis-cli -h redis ping
```

### 4.4 Validar Migraciones de BD

```bash
psql -U postgres -h postgres -d nexus_db

# Ver tablas creadas
\dt

# Ver tenants
SELECT * FROM tenants;

# Ver tabla de conversaciones (debe estar vac√≠a inicialmente)
SELECT COUNT(*) FROM chat_conversations;
```

## 5. Variables de Entorno en EasyPanel

### M√©todo 1: Panel UI
```
Service ‚Üí Settings ‚Üí Environment Variables
  ‚Üí Add
  ‚Üí Key: OPENAI_API_KEY
  ‚Üí Value: sk-proj-xxxxx
  ‚Üí Save
  ‚Üí Deploy
```

### M√©todo 2: Archivo .env
Si el servicio soporta, subir `.env` a la ra√≠z del Dockerfile:
```dockerfile
FROM python:3.11
COPY .env /app/.env
COPY . /app
WORKDIR /app
RUN pip install -r requirements.txt
CMD ["uvicorn", "main:app", "--host", "0.0.0.0"]
```

### M√©todo 3: Secrets (Recomendado para producci√≥n)
EasyPanel puede almacenar secretos encriptados:
```
Project ‚Üí Secrets
  ‚Üí Add Secret
  ‚Üí SMTP_PASS=xxxxx (se almacena encriptado)
  ‚Üí Los servicios acceden v√≠a variable de entorno
```

## 6. Healthchecks y Readiness Probes

### Orchestrator
```
GET /health
Respuesta: 200 {"status": "ok"}

GET /ready
Respuesta: 200 {"status": "ok"} (si DB conectada)
```

### WhatsApp Service
```
GET /health
Respuesta: 200 {"status": "ok"}
```

### Platform UI
```
GET / (p√°gina HTML)
Respuesta: 200 (HTML del dashboard)
```

## 7. Logs y Debugging

### Ver logs en tiempo real (EasyPanel)
```
Service ‚Üí Logs
  ‚Üí Ver output del contenedor
```

### Buscar errores espec√≠ficos
```
Logs ‚Üí Search
  ‚Üí "error"
  ‚Üí "migration_failed"
  ‚Üí "request_failed"
```

### Acceder al contenedor
```
Service ‚Üí Console (SSH)
  ‚Üí Ejecutar comandos
  ‚Üí Ej: curl http://localhost:8000/health
```

## 8. Troubleshooting

### Error: 500 en /chat

**Causa:** Variable de entorno faltante o error de conexi√≥n

**Soluci√≥n:**
```
1. Ver logs de orchestrator_service
2. Buscar "error" o "CRITICAL"
3. Comunes:
   - OPENAI_API_KEY no configurada
   - POSTGRES_DSN no v√°lida
   - TIENDANUBE_ACCESS_TOKEN expirado
```

### Error: Bot no responde

**Causa:** ORCHESTRATOR_SERVICE_URL incorrecto

**Soluci√≥n:**
```
1. Verificar en whatsapp_service que:
   ORCHESTRATOR_SERVICE_URL=http://orchestrator_service:8000
   (Si usas dominio, debe ser resuelto internamente)
2. Hacer curl desde WhatsApp Service:
   curl http://orchestrator_service:8000/health
3. Si falla:
   - Revisar nombre del servicio en EasyPanel
   - Revisar que servicios est√©n en la misma red Docker
```

### Error: Bot responde doble

**Causa:** Deduplicaci√≥n en Redis no funciona

**Soluci√≥n:**
```
1. Verificar REDIS_URL:
   redis://redis:6379 (debe ser resuelto internamente)
2. Validar que Redis est√© corriendo:
   redis-cli -h redis ping
3. Si Redis est√° en otro host:
   REDIS_URL=redis://redis.host.com:6379
```

### Error: SMTP/Mail no se env√≠a

**Causa:** Credenciales SMTP inv√°lidas

**Soluci√≥n:**
```
1. Verificar SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASS
2. Para Gmail:
   - SMTP_HOST=smtp.gmail.com
   - SMTP_PORT=465
   - SMTP_PASS=(contrase√±a de aplicaci√≥n, no contrase√±a normal)
3. Revisar logs en system_events table:
   SELECT * FROM system_events WHERE event_type='smtp_failed';
```

## 9. Performance y Escalabilidad

### Recomendaciones de recursos (EasyPanel)

```
Orchestrator Service:
  - CPU: 2 vCPUs (m√≠nimo 1)
  - RAM: 1GB (m√≠nimo 512MB)
  - Restart policy: Always

WhatsApp Service:
  - CPU: 1 vCPU
  - RAM: 512MB

Platform UI:
  - CPU: 1 vCPU
  - RAM: 256MB

PostgreSQL:
  - CPU: 2 vCPUs
  - RAM: 2GB
  - Storage: 20GB (ajustar seg√∫n uso)

Redis:
  - CPU: 1 vCPU
  - RAM: 512MB
```

### Auto-scaling (si EasyPanel lo soporta)

```
Orchestrator Service:
  - Min replicas: 1
  - Max replicas: 3
  - CPU trigger: 70%
  - RAM trigger: 80%
```

## 10. Despliegue Alternativo: Docker Compose (Desarrollo)

Para desarrollo local:

```bash
# Clonar repo
git clone https://github.com/tu-repo/nexus.git
cd nexus

# Configurar .env
cp .env.example .env
# Editar .env con valores locales

# Levantar servicios
docker-compose up --build

# Acceso:
# - Orchestrator: http://localhost:8000
# - WhatsApp Service: http://localhost:8002
# - Frontend React: http://localhost:5173
```

**docker-compose.yml incluye:**
- orchestrator_service
- whatsapp_service
- frontend_react
- postgres
- redis

---

*Gu√≠a de Despliegue Nexus v3 ¬© 2025*
````

## File: docs/04_agent_logic_and_persona.md
````markdown
# Identidad, L√≥gica y Reglas del Agente Dental

El coraz√≥n del sistema es el Agente de IA (Mercedes), dise√±ado para ser un coordinador cl√≠nico profesional y emp√°tico.

## 1. La Persona: "Asistente Cl√≠nico Profesional"

El bot act√∫a como la primera l√≠nea de atenci√≥n de la cl√≠nica. Su objetivo es facilitar la vida del paciente manteniendo un est√°ndar m√©dico alto.

### 1.1 Tono y Estilo
- **Emp√°tico y Profesional:** Entiende que el paciente puede tener dolor o ansiedad.
- **Voseo argentino (Tono Mercedes):** Usa "vos", "te cuento", "fijate", "mir√°", pero manteniendo el respeto cl√≠nico.
- **Conciso:** Da respuestas directas sobre disponibilidad y s√≠ntomas.

### 1.2 Prohibiciones Estrictas
- ‚ùå NO dar diagn√≥sticos m√©dicos definitivos (usar siempre "evaluaci√≥n pendiente de profesional").
- ‚ùå NO recetar medicamentos.
- ‚ùå NO ser fr√≠o o rob√≥tico.

---

## 2. Reglas Cl√≠nicas (Business Rules)

### 2.1 Triaje Automatizado
**Regla:** Ante menci√≥n de dolor fuerte, sangrado o traumatismo, el agente DEBE priorizar la urgencia.

**Implementaci√≥n:**
- Utiliza la tool `triage_urgency()`.
- Si el nivel es `emergency` o `high`, se debe ofrecer el hueco m√°s pr√≥ximo disponible, incluso si requiere intervenci√≥n humana para forzar la agenda.

### 2.2 Gesti√≥n de Agenda (Anti-Colisiones)
**Regla:** Ning√∫n turno puede ser confirmado sin verificar disponibilidad real.

**Implementaci√≥n:**
- El agente DEBE ejecutar `check_availability()` antes de proponer un horario.
- Si el paciente confirma, se usa `book_appointment()`.

---

## 3. Herramientas (Tools) Disponibles

| Tool | Par√°metros | Funci√≥n |
| :--- | :--- | :--- |
| `check_availability` | `date` | Consulta huecos libres en la BD de la cl√≠nica. |
| `book_appointment` | `datetime, reason` | Registra el turno y dispara la notificaci√≥n al dashboard. |
| `triage_urgency` | `symptoms` | Analiza el texto/audio para determinar la gravedad. |
| `derivhumano` | `reason` | Pasa la conversaci√≥n a un operador y activa el silencio de 24h. |

---

## 4. Mecanismo de Silencio (Lockout 24h)

Para evitar que la IA interfiera con una conversaci√≥n que ya est√° gestionando un humano (ej: una secretaria coordinando algo complejo):

1. **Trigger:** El uso de `derivhumano()` o la respuesta detectada de un administrativo desde el dashboard.
2. **Efecto:** El bot deja de procesar mensajes entrantes para ese paciente durante 24 horas.
3. **Reset:** El administrativo puede reactivar el bot manualmente si el tr√°mite termin√≥.

---

*Gu√≠a de Identidad Dentalogic ¬© 2026*
````

## File: docs/05_developer_notes.md
````markdown
# Gu√≠a para Desarrolladores - Mantenimiento y Extensi√≥n

Este documento contiene tips t√©cnicos para mantener, debugear y extender **Dentalogic**, la plataforma de gesti√≥n cl√≠nica dental.

## 1. Agregar una Nueva Herramienta (Tool)

### Paso 1: Definir la Funci√≥n en main.py

Ubicaci√≥n: `orchestrator_service/main.py`

```python
from langchain.tools import tool

@tool
async def mi_nueva_herramienta(parametro1: str, parametro2: int = 10):
    """
    Descripci√≥n clara de qu√© hace esta herramienta.
    """
    # Tu l√≥gica aqu√≠
    return {"resultado": "ok"}
```

### Paso 2: Agregar a la Lista de Tools

Busca la lista `tools` y agrega la referencia.

## 2. Manejo de Memoria

El sistema carga los √∫ltimos **20 mensajes** de cada conversaci√≥n por defecto. Para cambiarlo, ajusta el `LIMIT` en la consulta SQL de `chat_endpoint`.

## 3. Deduplicaci√≥n de Mensajes

Redis almacena los `message_id` por 2 minutos para evitar procesar dobles webhooks de WhatsApp.

## 4. Debugging 

- **Logs Locales**: `docker-compose logs -f`
- **Logs Producci√≥n**: Panel de EasyPanel ‚Üí Logs.
- **Protocolo Omega**: Los links de activaci√≥n se imprimen en los logs del orquestador si falla el SMTP.

## 10. Versioning y Migraci√≥n (Maintenance Robot)

Si necesitas cambiar la base de datos:
1.  Agrega el cambio en `db/init/dentalogic_schema.sql` (Foundation).
2.  Agrega un parche en `orchestrator_service/db.py` (Evolution). Usa bloques `DO $$` para que sea idempotente.

## 12. Gesti√≥n de Usuarios y Seguridad (Auth Layer)

### 12.1 Ciclo de Vida del Usuario
1.  **Registro**: Crea un usuario `pending`.
2.  **Aprobaci√≥n**: Un CEO activa la cuenta en `/aprobaciones`.
    -   Se vincula/crea un perfil en `professionals`.
3.  **Activaci√≥n**: El usuario ya puede loguearse.

### 12.2 Omega Protocol Prime
En despliegues iniciales, el sistema auto-activa al primer `ceo` registrado para evitar bloqueos.

### 12.3 Headers de Seguridad
-   `Authorization: Bearer <JWT_TOKEN>` (Identidad)
-   `X-Admin-Token: <INTERNAL_ADMIN_TOKEN>` (Infraestructura)

---

*Gu√≠a de Desarrolladores Dentalogic ¬© 2026*
Ê≥õ
````

## File: docs/06_ai_prompt_template.md
````markdown
# Template del System Prompt - Referencia Completa

Este documento muestra c√≥mo se estructura el system prompt que inyecta el Orchestrator al LangChain Agent.

## 1. Estructura General

El system prompt tiene 5 secciones principales:

```
[IDENTIDAD Y PERSONA]
  ‚Üì
[REGLAS DE RESPUESTA]
  ‚Üì
[REGLAS DE NEGOCIO]
  ‚Üì
[HERRAMIENTAS DISPONIBLES]
  ‚Üì
[CONTEXTO DE LA TIENDA]
```

## 2. Secci√≥n: Identidad y Persona

```
Eres el asistente virtual de Pointe Coach.

Tu nombre es "Consultora de Pointe Coach" y trabajas desde Paran√°, Argentina.

PERSONALIDAD:
- Eres c√°lido, amigable e informal
- Hablas como una compa√±era de danza, no como m√°quina
- Usas voseo argentino: "vos", "te cuento", "fijate", "mir√°"
- Puedes usar muletillas como: "Dale", "Genial", "B√°rbaro", "Divino/a", "Ojo que..."
- NUNCA uses "Usted" o "Su"
- NUNCA uses frases de telemarketing: "Es un placer asistirle", "Le comunico que..."

TONO:
- Profesional pero amigable
- Experta en danza
- Curiosa por lo que el usuario busca
```

## 3. Secci√≥n: Reglas de Respuesta

```
SALIDA JSON:
Debes responder SIEMPRE en formato JSON estructurado:
{
  "status": "ok",
  "send": true,
  "messages": [
    {"part": 1, "total": N, "text": "..."},
    {"part": 2, "total": N, "imageUrl": "..."},
    ...
  ]
}

FORMATO DE BURBUJAS:
- Cada "message" es una burbuja en WhatsApp
- Si no hay imagen, no incluyas "imageUrl" (dejar como null)
- Si no hay texto, no incluyas "text" (dejar como null)
- Respeto el "part" y "total" para mantener secuencia

LINKS:
- NUNCA uses formato markdown: [texto](url)
- Escribe la URL completa en su propia l√≠nea:
  INCORRECTO: [Ver en tienda](https://example.com)
  CORRECTO:   Ver en tienda:
              https://example.com

ESTILO DEL CONTENIDO:
- Las respuestas deben parecer naturales, no como datos crudos
- Mant√©n p√°rrafos cortos (m√°ximo 2-3 l√≠neas por burbuja)
- Usa emojis moderadamente (m√°ximo 1-2 por burbuja)
```

## 4. Secci√≥n: Reglas de Negocio

```
REGLA 1: GATE DE CAT√ÅLOGO (Anti-Alucinaci√≥n)
- NUNCA inventes productos, precios, im√°genes o descripciones
- Si el usuario pregunta por un producto ESPEC√çFICO:
  1. Ejecuta "search_specific_products" o "search_by_category"
  2. Usa EXACTAMENTE los datos retornados por la API
  3. Si no hay resultados, adm√≠telo: "No encontr√© eso disponible"
  4. Si hay resultados, muestrados en la estructura de 8 burbujas

REGLA 2: ENV√çOS
- Puedes mencionar estas empresas: Andreani, Correo Argentino
- PROHIBIDO: dar precios de env√≠o o tiempos estimados
- Respuesta obligatoria si preguntan por env√≠o:
  "El costo y tiempo de env√≠o se calculan al final de la compra seg√∫n tu ubicaci√≥n.
   Trabajamos con Andreani y Correo Argentino."

REGLA 3: HANDOFF A HUMANO
- Si el usuario pregunta algo t√©cnico profundo (biomec√°nica, comparativas complejas)
- Si el usuario muestra frustraci√≥n despu√©s de 3+ intentos
- Si solicita expl√≠citamente hablar con humano
- Ejecuta "derivhumano(reason='...')"
- Esto env√≠a un email y activa silencio por 24 horas

REGLA 4: CALL TO ACTION (Toda respuesta debe terminar con acci√≥n)
- Para PUNTAS DE DANZA:
  "¬øTe gustar√≠a que te ayude con un fitting? Podemos hacerlo virtual o presencial.
   Decime y coordinamos!"
- Para OTROS PRODUCTOS:
  "Ver todas las opciones: https://www.pointecoach.shop"
```

## 5. Secci√≥n: Herramientas Disponibles

```
Tienes acceso a las siguientes herramientas:

1. search_specific_products(q: str)
   - Busca productos por keyword
   - Ejemplo: search_specific_products("puntas de danza")
   - Usa esta SIEMPRE que el usuario pregunta por algo espec√≠fico

2. search_by_category(category: str, keyword: str)
   - Busca dentro de una categor√≠a
   - Ejemplo: search_by_category("leotardos", "negro")
   - Usa si conoces la categor√≠a

3. browse_general_storefront()
   - Retorna cat√°logo completo
   - Usa como √∫ltimo recurso

4. orders(q: str)
   - Consulta estado de pedido
   - Par√°metro: ID del pedido (sin #)
   - Ejemplo: orders("TN-123456")

5. derivhumano(reason: str)
   - Activa derivaci√≥n a operador humano
   - Bloquea el bot por 24 horas
   - Par√°metro: Motivo de la derivaci√≥n
   - Ejemplo: derivhumano("Pregunta t√©cnica profunda sobre biomec√°nica")
```

## 6. Secci√≥n: Contexto de la Tienda

```
INFORMACI√ìN DE LA TIENDA:
- Nombre: Pointe Coach
- Ubicaci√≥n: Paran√°, Entre R√≠os, Argentina
- Website: https://www.pointecoach.shop
- Descripci√≥n: Tienda especializada en art√≠culos de danza profesional

CAT√ÅLOGO PRINCIPAL:
Categor√≠as y marcas:
- PUNTAS DE DANZA: Grishko, Bloch, Capezio
  Grishko: Made in Russia, profesional, premium
  Bloch: Made in Australia, calidad superior
  Capezio: Made in USA, est√°ndar de la industria

- LEOTARDOS Y MALLAS: Capezio, Danskin, Body Wrappers
- ACCESORIOS: Cintas, mo√±os, banditas, protecciones

MARCAS PRINCIPALES:
- Grishko: Profesional, Russian pointe shoes
- Bloch: Premium quality, best for advanced
- Capezio: Industry standard
```

## 7. Ejemplo Completo de Prompt Inyectado

```python
# En orchestrator_service/main.py, funci√≥n que arma el prompt:

def get_system_prompt(tenant_config):
    return f"""Eres el asistente virtual de {tenant_config.store_name}.

PERSONALIDAD:
- C√°lido, amigable, informal
- Voseo argentino: "vos", "te cuento", "fijate"
- Nunca uses "Usted" o lenguaje rob√≥tico

SALIDA:
Responde en JSON:
{{
  "status": "ok",
  "send": true,
  "messages": [
    {{"part": 1, "total": N, "text": "..."}},
    ...
  ]
}}

REGLAS:
1. GATE: No inventes productos. Usa tools si preguntan por algo espec√≠fico
2. ENV√çOS: Menciona {tenant_config.shipping_partners}, nunca des precios
   Respuesta: "El costo y tiempo se calculan al final seg√∫n tu ubicaci√≥n"
3. HANDOFF: Si frustrado o t√©cnico profundo, usa derivhumano()
4. CTA: Termina con acci√≥n (Fitting para puntas, Link para otros)

HERRAMIENTAS:
- search_specific_products(q)
- search_by_category(category, keyword)
- browse_general_storefront()
- orders(q)
- derivhumano(reason)

CONTEXTO:
{tenant_config.store_description}
Cat√°logo: {tenant_config.catalog_knowledge}
"""
```

## 8. Secuencia de 8 Burbujas para Productos

Cuando muestras 3 productos, usa exactamente esta estructura:

```json
{
  "status": "ok",
  "send": true,
  "messages": [
    {
      "part": 1,
      "total": 8,
      "text": "Perfecto! Tengo opciones para vos. Te muestro 3 puntas que podr√≠an irte bien..."
    },
    {
      "part": 2,
      "total": 8,
      "imageUrl": "https://tiendanube.com/products/1234/image1.jpg"
    },
    {
      "part": 3,
      "total": 8,
      "text": "Puntas Grishko Modelo 2007\n$2.500\nColores: Rosa, Blanco, Hueso\nTalles: 35-42\nhttps://www.pointecoach.shop/producto/grishko-2007"
    },
    {
      "part": 4,
      "total": 8,
      "imageUrl": "https://tiendanube.com/products/5678/image1.jpg"
    },
    {
      "part": 5,
      "total": 8,
      "text": "Puntas Bloch Serenade\nExcelentes para principiantes y nivel intermedio. Muy c√≥modas.\n$2.800\nColores: Rosa, Negro\nTalles: 34-41\nhttps://www.pointecoach.shop/producto/bloch-serenade"
    },
    {
      "part": 6,
      "total": 8,
      "imageUrl": "https://tiendanube.com/products/9012/image1.jpg"
    },
    {
      "part": 7,
      "total": 8,
      "text": "Puntas Capezio Donatella\nPara nivel avanzado. Punta reforzada, mayor durabilidad.\n$3.200\nColores: Rosa, Rojo\nTalles: 36-41\nhttps://www.pointecoach.shop/producto/capezio-donatella"
    },
    {
      "part": 8,
      "total": 8,
      "text": "¬øCu√°l te late? Podemos hacer un fitting virtual para asegurarnos de que el talle sea el correcto. Decime y coordinamos! üíÉ"
    }
  ]
}
```

## 9. C√≥mo se Inyectan las Variables

**Variables din√°micas que se reemplazan:**

| Variable | Origen | Ejemplo |
| :--- | :--- | :--- |
| `{STORE_NAME}` | tabla `tenants` | "Pointe Coach" |
| `{BOT_PHONE_NUMBER}` | tabla `tenants` | "+5493756123456" |
| `{STORE_LOCATION}` | tabla `tenants` | "Paran√°, Argentina" |
| `{STORE_WEBSITE}` | tabla `tenants` | "https://www.pointecoach.shop" |
| `{STORE_DESCRIPTION}` | tabla `tenants` | "Art√≠culos de danza..." |
| `{SHIPPING_PARTNERS}` | env var | "Andreani, Correo Argentino" |
| `{STORE_CATALOG_KNOWLEDGE}` | tabla `tenants` | "Puntas Grishko, Bloch..." |

**En el c√≥digo:**

```python
def get_system_prompt(tenant):
    return f"""
Eres el asistente virtual de {tenant.store_name}.

Ubicaci√≥n: {tenant.store_location}
Website: {tenant.store_website}

Empresas de env√≠o: {os.getenv('SHIPPING_PARTNERS')}

{tenant.store_description}

Cat√°logo:
{tenant.store_catalog_knowledge}
"""
```

## 10. Personalizaci√≥n Avanzada

### Para agregar instrucciones personalizadas:

1. **Editar el archivo:** `orchestrator_service/main.py`
2. **Buscar:** `sys_template = """`
3. **Modificar:** Las secciones que necesites
4. **Reiniciar:** El servicio para que tome cambios

### Ejemplo: Agregar instrucci√≥n sobre descuentos

```
REGLA 5: DESCUENTOS Y PROMOCIONES
- Si el usuario pregunta por descuentos, usa cupones_list()
- Los cupones son c√≥digos como "VERANO2025" que dan 10-20% off
- Ofrece aplicarlos al checkout
```

---

*Template del System Prompt Nexus v3 ¬© 2025*
````

## File: docs/07_workflow_guide.md
````markdown
# Gu√≠a de Flujo de Trabajo y Colaboraci√≥n

Este documento detalla c√≥mo trabajar efectivamente en el proyecto Nexus v3, asegurando √©xito, estabilidad y escalabilidad.

## 1. Ciclo de Vida de una Tarea

Para cualquier nueva funcionalidad o correcci√≥n, sigue este ciclo:

### 1Ô∏è‚É£ Planificaci√≥n
- **Define el objetivo:** "Arreglar bug X", "Agregar feature Y"
- **Investiga el c√≥digo actual** relacionado
- **Crea un plan** detallando qu√© archivos se tocar√°n
- **Espera aprobaci√≥n** antes de escribir c√≥digo

### 2Ô∏è‚É£ Ejecuci√≥n
- Edita los archivos seg√∫n el plan
- Mant√©n un registro de cambios
- Si encuentras algo inesperado, actualiza el plan

### 3Ô∏è‚É£ Verificaci√≥n
- Prueba el c√≥digo localmente
- Si existen tests, c√≥rrelosy
- Solicita que se pruebe manualmente si es necesario
- Documenta los resultados

### 4Ô∏è‚É£ Commit / Entrega
- Sellamos el trabajo con un commit
```bash
git add .
git commit -m "feat: descripci√≥n clara de cambios"
```

---

## 2. Estrategia de Git

### Rama Principal
- Trabajamos sobre `main` directamente para desarrollo r√°pido
- **Requiere testeo riguroso** antes de cada commit

### Recomendaci√≥n para Tareas Grandes
- Usar feature branches para trabajos significativos:
```bash
git checkout -b feature/nueva-funcionalidad
# ... trabajo ...
git push origin feature/nueva-funcionalidad
```

---

## 3. Documentaci√≥n

### Antes de Codificar
- Actualiza la documentaci√≥n si cambias comportamiento
- Agrega ejemplos si creas una nueva feature

### Despu√©s de Codificar
- Verifica que los docs reflejen los cambios
- Actualiza README.md si es un cambio importante

### Ubicaciones
- **Cambios fundamentales:** actualiza `README.md`
- **Arquitectura:** actualiza `docs/01_architecture.md`
- **Configuraci√≥n:** actualiza `docs/02_environment_variables.md`
- **Despliegue:** actualiza `docs/03_deployment_guide.md`
- **Persona/Reglas:** actualiza `docs/04_agent_logic_and_persona.md`
- **Desarrollo:** actualiza `docs/05_developer_notes.md`
- **Prompt:** actualiza `docs/06_ai_prompt_template.md`

---

## 4. Checklist Pre-Commit

Antes de hacer commit, verifica:

- [ ] El c√≥digo funciona localmente
- [ ] Los tests pasan (si existen)
- [ ] La documentaci√≥n est√° actualizada
- [ ] No hay archivos temporales o .env en el commit
- [ ] El mensaje de commit es claro y descriptivo

---

## 5. Troubleshooting Durante Desarrollo

### El bot no responde
1. Verificar logs: `docker-compose logs -f orchestrator_service`
2. Chequear variables de entorno
3. Verificar conectividad con PostgreSQL y Redis

### Cambios no se reflejan
1. Reiniciar el contenedor: `docker-compose restart orchestrator_service`
2. Verificar que el archivo fue guardado
3. Limpiar cach√© de Redis si es necesario

### Errores de BD
1. Ver logs de PostgreSQL: `docker-compose logs -f postgres`
2. Si est√° corrupta, resetear: `docker-compose down -v && docker-compose up`
3. Las migraciones se ejecutan autom√°ticamente en startup

---

## 6. Comunicaci√≥n Entre Servicios

### Flujo Principal de un Mensaje
```
Usuario WhatsApp
    ‚Üì
YCloud API
    ‚Üì
WhatsApp Service (8002) - validar firma, deduplicar, transcribir
    ‚Üì
POST /chat al Orchestrator (8000)
    ‚Üì
Orchestrator - LangChain agent, ejecutar tools
    ‚Üì
Respuesta JSON con mensajes
    ‚Üì
WhatsApp Service - enviar burbujas a YCloud
    ‚Üì
Usuario recibe mensajes
```

### Tokens y Autenticaci√≥n
- **INTERNAL_API_TOKEN:** Entre microservicios
- **ADMIN_TOKEN:** Para Platform UI ‚Üí Orchestrator
- **YCLOUD_WEBHOOK_SECRET:** Para validar webhooks de YCloud
- **OPENAI_API_KEY:** Para LLM y Whisper

---

## 7. Performance y Optimizaciones

### C√≥mo Hacer M√°s R√°pido
- Reducir STORE_CATALOG_KNOWLEDGE si es muy largo (> 2KB)
- Aumentar `REDIS_URL` connection pool si hay bottleneck
- Cachear b√∫squedas frecuentes en Redis (1 hora TTL)

### Debugging Lento
- Agregar logs con timestamp
- Usar Prometheus metrics para profiling
- Chequear latencia de BD con `EXPLAIN`

---

## 8. Cuando Est√©s Atascado

1. Revisa los logs: `docker-compose logs | grep error`
2. Consulta `docs/03_deployment_guide.md` secci√≥n "Troubleshooting"
3. Revisa `AGENTS.md` para reglas cr√≠ticas
4. Lee el c√≥digo fuente (siempre es la fuente de verdad)

---

*Gu√≠a de Flujo de Trabajo Nexus v3 ¬© 2025*
````

## File: docs/08_troubleshooting_history.md
````markdown
# Hist√≥rico de Problemas y Soluciones

Este documento registra problemas encontrados y sus soluciones para referencia futura.

## Startup, Routing y Persistencia (v4)

**Problema (2026-02-05):**
- **401 Unauthorized**: Frontend fallaba al conectar con Orchestrator por falta de token en build.
- **404 Not Found**: YCloud enviaba webhooks a `/webhook` pero el servicio esperaba `/webhook/ycloud`.
- **422 Unprocessable**: Mismatch de nombres en JSON entre WhatsApp de entrada (`from_number`/`text`) y Orchestrator (`phone`/`message`).
- **500 Internal Error (Bcrypt)**: `passlib` fallaba al chocar con `bcrypt 4.x` en Linux. Esto se manifestaba como un error de CORS en el navegador porque el servidor mor√≠a antes de inyectar los headers.
- **Pantalla en Blanco (Navigation)**: Al navegar a `/agenda` o `/pacientes`, la aplicaci√≥n desaparec√≠a.

**Soluci√≥n Aplicada:**
- **Frontend (CORS/Auth)**: Se inyect√≥ `VITE_ADMIN_TOKEN` en el Dockerfile y se agreg√≥ un `@app.exception_handler(Exception)` global en `main.py` para devolver JSON siempre, asegurando que los headers de CORS est√©n presentes incluso en errores 500.
- **Bcrypt Fix**: Se fij√≥ `bcrypt==3.2.0` en `requirements.txt` y se agreg√≥ truncado de 72 bytes en las contrase√±as para evitar el l√≠mite f√≠sico de la librer√≠a.
- **Navigation Fix**: Se cambi√≥ `path="/"` por `path="/*"` en `App.tsx` para permitir el matching de rutas anidadas en React Router 6.
- **Maintenance Robot (db.py)**: 
  - Se implement√≥ un **Smart SQL Splitter** que divide el schema por `;` (respetando bloques `$$`).
  - Se cre√≥ un sistema de **Evoluci√≥n por Parches** con auto-activaci√≥n de CEO (Omega Prime).

**Estado:**
- ‚úÖ Completamente estabilizado en v7.6 "Sovereign Platinum".

---

*Hist√≥rico de Problemas y Soluciones Nexus v3 ¬© 2026*
Ê≥õ
````

## File: docs/09_fase1_dental_datos_especificacion.md
````markdown
# FASE 1: Evoluci√≥n de Datos - Especificaci√≥n T√©cnica

## üì¢ Estado de Implementaci√≥n (Feb 2026)

| Componente | Estado | Acci√≥n Realizada |
| :--- | :--- | :--- |
| **Esquema DB (004)** | ‚úÖ 100% | Tablas creadas e indexadas. |
| **Modelos SQLALchemy** | ‚úÖ 100% | `models_dental.py` implementado. |
| **Integraci√≥n Tools** | ‚ö†Ô∏è 80% | L√≥gica backend lista; Sincronizaci√≥n GCal simulada. |
| **System Prompt** | ‚úÖ 100% | Persona "Mercedes" activa en el Orchestrator. |

---

## üìã Resumen Ejecutivo

Se han creado **6 nuevas tablas PostgreSQL** que transforman el backend de Tienda Nube en una plataforma dental, manteniendo la infraestructura multi-tenant de Nexus v3 intacta.

| Tabla | Prop√≥sito | Relaciones Clave |
|-------|-----------|------------------|
| `patients` | Almacenar datos de pacientes con anamnesis | tenant_id (multi-tenant) |
| `professionals` | Odont√≥logos disponibles | tenant_id (multi-tenant) |
| `appointments` | Turnos sincronizados con Google Calendar | patient_id, professional_id, tenant_id |
| `clinical_records` | Historias cl√≠nicas con odontogramas JSONB | patient_id, professional_id, tenant_id |
| `accounting_transactions` | Pagos, OSDE, gastos | patient_id, appointment_id, tenant_id |
| `daily_cash_flow` | Reporte diario de caja | tenant_id |

---

## üóÇÔ∏è Estructura Jer√°rquica

```
Tenant (Mercedes)
‚îú‚îÄ‚îÄ Professional (Dr. Garc√≠a)
‚îÇ   ‚îú‚îÄ‚îÄ Appointment (2025-02-15 09:00)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Patient (Juan P√©rez)
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Clinical Record (2025-01-20)
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ Odontogram (JSONB)
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ Treatments (JSONB)
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ Treatment Plan (JSONB)
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ Medical History (JSONB)
‚îÇ   ‚îî‚îÄ‚îÄ Chair 1 (Sill√≥n)
‚îÇ
‚îî‚îÄ‚îÄ Accounting
    ‚îú‚îÄ‚îÄ Transaction (Pago paciente $500)
    ‚îÇ   ‚îî‚îÄ‚îÄ Insurance Claim (OSDE)
    ‚îî‚îÄ‚îÄ Daily Cash Flow (2025-01-20)
```

---

## üîë Dise√±o de Claves

### `patients` Table
```sql
PRIMARY KEY: id (SERIAL)
UNIQUE: (tenant_id, phone_number) -- WhatsApp + Tenant
UNIQUE: (tenant_id, dni)           -- DNI + Tenant (previene duplicados nacionales)
FOREIGN KEY: tenant_id ‚Üí tenants(id)
```

**√çndices Cr√≠ticos:**
- `(tenant_id, phone_number)` ‚Üí B√∫squeda r√°pida por WhatsApp
- `(tenant_id, dni)` ‚Üí Validaci√≥n de identidad
- `status` ‚Üí Filtrado de pacientes activos

---

### `appointments` Table
```sql
PRIMARY KEY: id (UUID)
FOREIGN KEYS:
  - tenant_id ‚Üí tenants(id)
  - patient_id ‚Üí patients(id)
  - professional_id ‚Üí professionals(id)
  - google_calendar_event_id (String, no FK - sincronizaci√≥n unidireccional)

√çNDICES CR√çTICOS:
- (tenant_id, appointment_datetime) ‚Üí Dashboard agenda
- (patient_id, status) ‚Üí B√∫squeda de citas del paciente
- (professional_id, appointment_datetime) ‚Üí Agenda del profesional
- (urgency_level) ‚Üí Filtrado de urgencias en dashboard
- (google_calendar_sync_status) ‚Üí Reintento de sincronizaci√≥n
```

---

### `clinical_records` Table

**Odontograma (JSONB Example):**
```json
{
  "tooth_32": {
    "number": 32,
    "tooth_type": "molar",
    "status": "caries",
    "surfaces": {
      "occlusal": "caries",
      "mesial": "healthy",
      "distal": "healthy",
      "buccal": "healthy",
      "lingual": "healthy"
    },
    "color_code": "red",
    "notes": "Caries inicial, requiere tratamiento"
  },
  "tooth_11": {
    "number": 11,
    "tooth_type": "incisor",
    "status": "crowned",
    "treatment_date": "2024-06-15",
    "notes": "Corona de porcelana"
  }
}
```

**Treatments (JSONB Array):**
```json
[
  {
    "date": "2025-01-15",
    "type": "cleaning",
    "description": "Profilaxis con fluoruro",
    "teeth": [11, 12, 13, 14],
    "duration_minutes": 45,
    "cost": 500,
    "currency": "ARS",
    "insurance_covered": true,
    "professional_id": 1,
    "notes": "Paciente cooperador, sin complicaciones"
  },
  {
    "date": "2025-01-22",
    "type": "filling",
    "description": "Obturaci√≥n amalgama en 32",
    "teeth": [32],
    "duration_minutes": 30,
    "cost": 800,
    "currency": "ARS",
    "insurance_covered": true,
    "professional_id": 1
  }
]
```

**Treatment Plan (JSONB):**
```json
{
  "created_date": "2025-01-15",
  "estimated_sessions": 4,
  "planned_treatments": [
    {
      "treatment": "Endodoncia",
      "teeth": [11],
      "estimated_cost": 3000,
      "priority": "high",
      "estimated_date": "2025-02-10"
    },
    {
      "treatment": "Corona 11",
      "teeth": [11],
      "estimated_cost": 4000,
      "priority": "high",
      "estimated_date": "2025-03-01"
    }
  ],
  "total_estimated_cost": 7000,
  "notes": "Plan consensuado con paciente"
}
```

---

## üìä Integraci√≥n con Nexus v3

### Multi-tenancy Preservation
Todas las tablas nuevas incluyen `tenant_id`:
```python
# En orchestrator_service/main.py, al procesar una solicitud:
current_tenant_id: ContextVar[Optional[int]] = ContextVar("current_tenant_id", default=None)

# Dentro de cualquier handler:
tenant_id = current_tenant_id.get()
# SELECT * FROM patients WHERE tenant_id = ? AND phone_number = ?
```

### Memory & Context Preservation
La infraestructura de memoria (RedisChatMessageHistory) se **mantiene sin cambios**:
- Conversaci√≥n de 20 √∫ltimos mensajes en Redis
- Historial persistente en `chat_messages` (sin cambios)
- `human_override_until` sigue siendo v√°lido (24h lockout)

### WhatsApp Integration
El flujo WhatsApp ‚Üí Orchestrator ‚Üí Respuesta se **mantiene id√©ntico**:
1. `whatsapp_service` recibe webhook de YCloud
2. Env√≠a POST `/chat` a `orchestrator_service`
3. LangChain agent procesa con **nuevas herramientas dentales**

---

## üîå Cambios Necesarios en `orchestrator_service/main.py`

### Paso 1: Agregar Migraci√≥n SQL
En el `lifespan` async context manager, agregar nueva migraci√≥n:

```python
# En la lista migration_steps, despu√©s de la migraci√≥n 003, agregar:
migration_steps = [
    # ... migraci√≥n anterior ...
    # 4. Dental Phase 1 Schema
    open('/db/init/004_dental_phase1_schema.sql').read(),
]
```

### Paso 2: Nuevas Tools (Esqueletos Funcionales)

```python
from langchain.tools import tool

@tool
def check_availability(date_str: str, duration_minutes: int = 60) -> dict:
    """
    Consulta disponibilidad en Google Calendar.
    
    Args:
        date_str: "2025-02-15" (formato ISO)
        duration_minutes: Duraci√≥n del turno
    
    Returns:
        {
            "available_slots": ["09:00", "10:00", "14:00"],
            "next_available": "2025-02-15 09:00"
        }
    """
    # TODO: Implementar integraci√≥n con Google Calendar API
    return {"status": "not_implemented"}

@tool
def book_appointment(patient_phone: str, professional_id: int, datetime_str: str, appointment_type: str) -> dict:
    """
    Agenda un turno en Google Calendar + Database.
    
    Args:
        patient_phone: "+5491123456789"
        professional_id: 1 (Dr. Garc√≠a)
        datetime_str: "2025-02-15T09:00:00"
        appointment_type: "checkup" | "cleaning" | "treatment" | "emergency"
    
    Returns:
        {
            "success": true,
            "appointment_id": "uuid",
            "google_event_id": "calendar_event_id",
            "confirmation_message": "Tu turno est√° agendado para..."
        }
    """
    # TODO: Crear appointment en DB + Google Calendar
    return {"status": "not_implemented"}

@tool
def triage_urgency(user_message: str) -> dict:
    """
    Detecta urgencia en el mensaje del paciente (NLP).
    
    Args:
        user_message: Mensaje del usuario
    
    Returns:
        {
            "urgency_level": "low" | "normal" | "high" | "emergency",
            "reason": "Dolor agudo en molar superior",
            "recommended_action": "Agendar para hoy si es posible"
        }
    """
    # TODO: Implementar clasificaci√≥n NLP simple
    # Por ahora: detectar palabras clave: "dolor", "urgencia", "emergencia", "sangrado"
    return {"urgency_level": "normal", "reason": "No urgency detected"}
```

### Paso 3: Actualizar `sys_template` de Persona

Cambiar de `"Pointe Coach"` a `"Asistente Dental Profesional"`:

```python
SYSTEM_PROMPT_DENTAL = """
Eres un Asistente Dental Profesional de una cl√≠nica odontol√≥gica en Argentina.

## Tono y Personalidad
- C√°lido, profesional, emp√°tico
- Voseo argentino ("¬øC√≥mo est√°s?", "Te recomiendo...", "Mir√°...")
- PROHIBIDO: Lenguaje rob√≥tico, "estimado cliente"
- Experto en odontolog√≠a b√°sica, pero NUNCA diagnostiques

## Responsabilidades
1. **Agendar Turnos**: Usar check_availability() y book_appointment()
2. **Triaje**: Detectar urgencia con triage_urgency()
3. **Informaci√≥n**: Explicar procedimientos, cuidados post-tratamiento
4. **Recordatorios**: Avisar sobre turnos pr√≥ximos

## Prohibiciones
- NO des diagn√≥sticos precisos ("Ten√©s caries" ‚Üí "Deber√≠as venir para que lo vea el Dr.")
- NO alteres historias cl√≠nicas
- NO hagas tratamientos remotamente
- SIEMPRE remite urgencias ("Te vemos hoy mismo")

## CTA Obligatorio
Toda respuesta cierra con una acci√≥n:
- "¬øTe parece agendar un turno?"
- "¬øQuer√©s que te lo anote para esta semana?"
- "Pasate por la cl√≠nica para una evaluaci√≥n"
"""
```

---

## üóÑÔ∏è Estructura de Directorios Actualizada

```
orchestrator_service/
‚îú‚îÄ‚îÄ main.py (actualizar: agregar migraci√≥n + nuevas tools)
‚îú‚îÄ‚îÄ admin_routes.py (sin cambios)
‚îú‚îÄ‚îÄ db.py (sin cambios)
‚îî‚îÄ‚îÄ requirements.txt (agregar: google-auth, google-auth-oauthlib)

db/
‚îú‚îÄ‚îÄ init/
‚îÇ   ‚îú‚îÄ‚îÄ 001_schema.sql
‚îÇ   ‚îú‚îÄ‚îÄ 002_platform_schema.sql
‚îÇ   ‚îú‚îÄ‚îÄ 003_advanced_features.sql
‚îÇ   ‚îî‚îÄ‚îÄ 004_dental_phase1_schema.sql (NUEVO)
‚îú‚îÄ‚îÄ models_dental.py (NUEVO - SQLAlchemy ORM)
‚îî‚îÄ‚îÄ __init__.py

shared/
‚îú‚îÄ‚îÄ models.py (Agregar DTOs para Pacientes, Turnos, etc.)
```

---

## ‚úÖ Checklist de Validaci√≥n

- [ ] Archivo `004_dental_phase1_schema.sql` copiado a `db/init/`
- [ ] `models_dental.py` copiado a `db/`
- [ ] Migraci√≥n agregada a `orchestrator_service/main.py` lifespan
- [ ] Tools esqueleto implementadas (check_availability, book_appointment, triage_urgency)
- [ ] sys_template actualizado con persona "Asistente Dental"
- [ ] Test: Conectar a DB y verificar que las tablas se crean
- [ ] Test: Enviar mensaje a WhatsApp y verificar que se procesa

---

## üìù Pr√≥ximos Pasos (FASE 2)

1. **Google Calendar Integration**
   - Implementar OAuth2 flow
   - Crear eventos en Google Calendar autom√°ticamente
   - Sincronizar disponibilidad

2. **Frontend Refactoring**
   - Dashboard: Cambiar vista "Ventas" ‚Üí "Flujo de Pacientes"
   - Agenda: CSS Grid con sillones (boxes)
   - Historias: SVG interactivo de odontograma

3. **System Prompt Avanzado**
   - Multi-idioma (Espa√±ol/Ingl√©s)
   - Context-aware responses (seg√∫n historial m√©dico)
   - Recomendaciones OSDE integradas

---

**Fecha de Creaci√≥n:** 2025-01-30  
**Versi√≥n:** 1.0  
**Estado:** Especificaci√≥n Completa - Listo para Implementaci√≥n
````

## File: docs/11_gap_analysis_nexus_to_dental.md
````markdown
# üìä An√°lisis de Gaps: Nexus v3 ‚Üí Dentalogic

Este documento detalla el estado actual de la plataforma frente a los requerimientos de la **Plataforma Dental para Mercedes**.

## 1. Backend (L√≥gica y Orquestaci√≥n)

| Requerimiento | Estado | Notas |
| :--- | :--- | :--- |
| **Adaptaci√≥n de Tools** | ‚úÖ Implementado | `check_availability()` y `book_appointment()` existen en `orchestrator_service/main.py`. |
| **Sincronizaci√≥n Google Calendar** | ‚ö†Ô∏è Parcial | La l√≥gica en `admin_routes.py` es simulada. Requiere implementaci√≥n real de OAuth2. |
| **Triaje Automatizado** | ‚úÖ Implementado | Tool `triage_urgency()` funcional con l√≥gica NLP b√°sica. |
| **Procesamiento de Audio** | ‚úÖ Implementado | Integraci√≥n con OpenAI Whisper en `whatsapp_service/main.py`. |
| **Mecanismo de Silencio (Lockout)** | ‚úÖ Implementado | Funcionalidad `human_override_until` de 24h activa. |
| **Relay de Mensajer√≠a** | ‚ö†Ô∏è Pendiente | El `Universal Delivery Relay` para env√≠os masivos no se detect√≥ en la b√∫squeda. |

---

## 2. Frontend (Centro de Operaciones Dental)

| Requerimiento | Estado | Notas |
| :--- | :--- | :--- |
| **Monitor de Actividad** | ‚úÖ Implementado | `DashboardView.tsx` muestra estad√≠sticas de turnos y urgencias. |
| **Agenda Inteligente** | ‚ö†Ô∏è Parcial | `AgendaView.tsx` usa FullCalendar, pero el **Drag & Drop** no est√° habilitado comercialmente. |
| **Odontograma Interactivo** | ‚ùå Faltante | No se encontr√≥ la interfaz gr√°fica de odontograma en `frontend_react`. |
| **Perfil 360¬∞ del Paciente** | ‚úÖ Implementado | `PatientDetail.tsx` incluye historial cl√≠nico, anamnesis y alertas m√©dicas. |
| **M√≥dulo Contable** | ‚ö†Ô∏è Parcial | Existe `accounting_transactions` en DB, pero no la interfaz de usuario completa. |

---

## 3. Database (Persistencia y Estructura)

| Requerimiento | Estado | Notas |
| :--- | :--- | :--- |
| **Evoluci√≥n del Esquema** | ‚úÖ Implementado | Tablas `patients`, `appointments`, `clinical_records` y `accounting` creadas (Migraci√≥n 004). |
| **Gesti√≥n de Alertas M√©dicas** | ‚úÖ Implementado | Campo `medical_history` JSONB en `patients` con detecci√≥n de alertas en el frontend. |
| **Memoria Persistente** | ‚úÖ Implementado | Vinculaci√≥n de `chat_messages` con `patient_id` funcional. |
| **Redis para Efimeridad** | ‚úÖ Implementado | Deduplicaci√≥n y locks en Redis activos en `whatsapp_service`. |
| **B√≥veda de Credenciales** | ‚úÖ Implementado | Sistema de almacenamiento en `credentials_vault` (v√≠a `admin/internal/credentials`). |

---

## üöÄ Resumen de Pr√≥ximos Pasos

1. **Implementar OAuth2 real** para Google Calendar.
2. **Desarrollar el componente de Odontograma** (SVG Interactivo).
3. **Activar Drag & Drop** en la Agenda.
4. **Construir el Dashboard Contable** para liquidaciones de Obras Sociales.
````

## File: docs/12_resumen_funcional_no_tecnico.md
````markdown
# üìñ Gu√≠a Simple: ¬øC√≥mo funciona Dentalogic?

Este documento explica de forma sencilla, sin tecnicismos, qu√© hace este sistema y c√≥mo ayuda a que la cl√≠nica funcione mejor.

---

## 1. El Concepto: Mercedes, la Secretaria Virtual
Imagina que **Mercedes** es una secretaria muy eficiente que nunca duerme. Ella atiende el WhatsApp de la cl√≠nica, responde dudas de los pacientes y anota los turnos. Pero no es solo un bot que repite opciones; ella "entiende" lo que le dicen, ya sea por texto o por audio.

## 2. El "Cerebro" y el "Tablero de Control"
Para que todo funcione, el sistema se divide en dos partes que se hablan todo el tiempo:

*   **El Cerebro (Backend):** Es donde vive Mercedes. Ella recibe los mensajes, consulta la agenda y decide qu√© responder.
*   **El Tablero (Frontend):** Es la pantalla que ven los odont√≥logos y secretarias en la cl√≠nica. Aqu√≠ est√° la agenda visual, las fichas de los pacientes y las alertas.

**¬øC√≥mo se hablan?**
Si un paciente agenda un turno por WhatsApp con Mercedes, Mercedes env√≠a una se√±al instant√°nea al Tablero. En menos de un segundo, el turno aparece dibujado en la agenda de la cl√≠nica sin que nadie tenga que apretar "Refrescar". Es una conversaci√≥n en tiempo real.

## 3. Las Herramientas de Mercedes (IA)
Mercedes tiene "superpoderes" llamados herramientas (tools) que usa seg√∫n lo que necesite el paciente:

1.  **Consultar Disponibilidad:** Cuando alguien pregunta "¬øTen√©s turno para ma√±ana?", Mercedes mira la agenda real de los doctores y le dice al paciente exactamente qu√© horarios est√°n libres.
2.  **Anotar Turno:** Una vez que el paciente elige una hora, Mercedes lo anota oficialmente. Esto crea el registro en la base de datos y lo muestra en el calendario de la cl√≠nica.
3.  **Triaje (Clasificaci√≥n de Urgencia):** Si un paciente dice "Me duele mucho" o "Se me rompi√≥ un diente", Mercedes analiza la gravedad.
    *   **C√≥mo se muestra:** En el Tablero de la cl√≠nica, Mercedes pone un aviso de "Urgencia" resaltado para que el personal sepa que debe darle prioridad a ese mensaje.

## 4. El Trabajo en Equipo: Frontend, Base de Datos y Mercedes
Todos los componentes trabajan juntos para que no se pierda ninguna informaci√≥n:

*   **La Base de Datos (La Memoria):** Aqu√≠ se guarda todo. Mercedes recuerda si un paciente es al√©rgico a la penicilina o si hace mucho que no viene. 
*   **Historias Cl√≠nicas Inteligentes:** Cuando Mercedes charla con un paciente, ella "anota" en su memoria los s√≠ntomas que el paciente mencion√≥. Luego, cuando el doctor abre la ficha del paciente en el **Frontend**, ya puede ver un resumen de lo que el paciente le cont√≥ a la IA antes de entrar al consultorio.
*   **Detecci√≥n de Alertas:** Si el doctor anota que un paciente es diab√©tico en el Frontend, la pr√≥xima vez que ese paciente hable con Mercedes, ella lo sabr√° y podr√° ser m√°s cuidadosa o dar avisos espec√≠ficos.

## 5. El "Freno de Mano" Humano
Si Mercedes no entiende algo o si el paciente pide hablar con una persona, Mercedes se retira (se "silencia" por 24 horas). En el Tablero de la cl√≠nica, aparece un aviso indicando que ese paciente necesita atenci√≥n humana. Una vez que la secretaria de la cl√≠nica responde manualmente, Mercedes se queda tranquila esperando hasta que se le pida volver a intervenir.

---
*En resumen: Dentalogic es Mercedes atendiendo el WhatsApp y un panel inteligente para que los doctores tengan todo bajo control en tiempo real.*
````

## File: docs/Instrucciones para IA.md
````markdown
# **Role: Senior Fullstack Engineer & AI Architect**

# **Context: Transformation of Nexus v3 (E-commerce) to Dental Platform (Mercedes)**

You are an expert developer tasked with refactoring an existing multi-tenant AI agent platform (Nexus v3) into a professional Dental Management Ecosystem.

## **1\. Project Knowledge Base (Reference Docs)**

* Current Backend: Orchestrator (FastAPI/LangChain), WhatsApp Service (YCloud/Whisper).  
* Current Storage: PostgreSQL (Persistence), Redis (Ephemeral/Locks).  
* Current UI: Vanilla JavaScript (Platform UI).  
* New Goal: docs/propuesta\_dental.md (Functional requirements).

## **2\. Transformation Guidelines**

### **A. Backend & Agent Logic**

* **From Store to Clinic:** Replace Tienda Nube tools (search\_products, orders) with Dental Tools.  
* **Required New Tools:**  
  * check\_availability(): Integration with Google Calendar API (Mirror mode).  
  * book\_appointment(): Create events in Calendar and entries in PGSQL.  
  * triage\_urgency(): NLP classification for "Pain/Emergency" to flag in Dashboard.  
* **Memory:** Maintain the 20-message sliding window but adapt the sys\_template to the "Dental Professional" persona (Argentine, warm, but clinical).  
* **Human Silence:** Keep the 24h lockout mechanism (human\_override\_until) for manual intervention.

### **B. Database Schema Evolution (PostgreSQL)**

Refactor the current schema to support:

* patients: (Extending current tenants/users) adding medical history, allergies (anamnesis), and OSDE Token fields.  
* appointments: Linked to Google Calendar IDs and box/chair assignment.  
* clinical\_records: JSONB structure for Odontograms and text for clinical notes.  
* accounting: Tables for payments, insurance claims (OSDE), and daily cash flow.

### **D. Database Evolution (Maintenance Robot)**

* **Self-Healing:** Never execute SQL direct or via external migrations. 
* **Protocol:** Add new columns or tables to the `patches` list in `orchestrator_service/db.py` using `DO $$` blocks with `IF NOT EXISTS`.
* **Synchronize:** Run `./sync-schema.ps1` to update the base foundation after changing the evolution pipeline.

### **C. Frontend Refactoring (Vanilla JS)**

* **Dashboard:** Shift from "Sales" to "Patient Flow". Highlight "Urgencies".  
* **Agenda:** Implement a CSS Grid/Flexbox calendar view (Box-based) with Drag & Drop capability.  
* **CRM:** Create a view for Clinical Records including an SVG-based Odontogram.

## **3\. Implementation Instructions**

When I ask you to write code:

1. **Reuse Nexus v3 infrastructure:** Don't delete the Orchestrator/WhatsApp service bridge.  
2. **Modularize:** Create a new dental\_logic/ directory in the orchestrator if necessary.  
3. **Multi-tenant:** Ensure X-Tenant-ID logic remains intact so Mercedes can scale.  
4. **Safety:** Always prioritize data privacy for medical records.

**Current Task:** \[Insert your specific task here, e.g., "Create the SQLAlchemy model for the new Clinical Records table"\]
````

## File: frontend_react/public/vite.svg
````xml
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="31.88" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 257"><defs><linearGradient id="IconifyId1813088fe1fbc01fb466" x1="-.828%" x2="57.636%" y1="7.652%" y2="78.411%"><stop offset="0%" stop-color="#41D1FF"></stop><stop offset="100%" stop-color="#BD34FE"></stop></linearGradient><linearGradient id="IconifyId1813088fe1fbc01fb467" x1="43.376%" x2="50.316%" y1="2.242%" y2="89.03%"><stop offset="0%" stop-color="#FFEA83"></stop><stop offset="8.333%" stop-color="#FFDD35"></stop><stop offset="100%" stop-color="#FFA800"></stop></linearGradient></defs><path fill="url(#IconifyId1813088fe1fbc01fb466)" d="M255.153 37.938L134.897 252.976c-2.483 4.44-8.862 4.466-11.382.048L.875 37.958c-2.746-4.814 1.371-10.646 6.827-9.67l120.385 21.517a6.537 6.537 0 0 0 2.322-.004l117.867-21.483c5.438-.991 9.574 4.796 6.877 9.62Z"></path><path fill="url(#IconifyId1813088fe1fbc01fb467)" d="M185.432.063L96.44 17.501a3.268 3.268 0 0 0-2.634 3.014l-5.474 92.456a3.268 3.268 0 0 0 3.997 3.378l24.777-5.718c2.318-.535 4.413 1.507 3.936 3.838l-7.361 36.047c-.495 2.426 1.782 4.5 4.151 3.78l15.304-4.649c2.372-.72 4.652 1.36 4.15 3.788l-11.698 56.621c-.732 3.542 3.979 5.473 5.943 2.437l1.313-2.028l72.516-144.72c1.215-2.423-.88-5.186-3.54-4.672l-25.505 4.922c-2.396.462-4.435-1.77-3.759-4.114l16.646-57.705c.677-2.35-1.37-4.583-3.769-4.113Z"></path></svg>
````

## File: frontend_react/src/api/axios.ts
````typescript
import axios, { type AxiosInstance, type AxiosError, type AxiosRequestConfig, type InternalAxiosRequestConfig } from 'axios';

const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000';
export const BACKEND_URL = API_URL;
const MAX_RETRIES = 3;
const BASE_DELAY = 1000;

// ============================================
// MULTI-TENANCY: Tenant ID Management
// ============================================

// Get current tenant ID from storage or context
export const getCurrentTenantId = (): string | null => {
  // Try to get from localStorage first (for persistent sessions)
  const storedTenant = localStorage.getItem('X-Tenant-ID');
  if (storedTenant) return storedTenant;

  // Try to get from session storage
  const sessionTenant = sessionStorage.getItem('X-Tenant-ID');
  if (sessionTenant) return sessionTenant;

  // Default tenant for development (can be overridden by environment)
  return import.meta.env.VITE_DEFAULT_TENANT_ID || 'default';
};

// Set tenant ID for the session
export const setTenantId = (tenantId: string, persist = true): void => {
  if (persist) {
    localStorage.setItem('X-Tenant-ID', tenantId);
  } else {
    sessionStorage.setItem('X-Tenant-ID', tenantId);
  }
};

// Clear tenant ID
export const clearTenantId = (): void => {
  localStorage.removeItem('X-Tenant-ID');
  sessionStorage.removeItem('X-Tenant-ID');
};

// ============================================
// AXIOS INSTANCE
// ============================================

interface RetryConfig {
  retries: number;
  delay: number;
}

// Utility para delay
const delay = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

// Utility para calcular delay exponencial con jitter
const calculateExponentialDelay = (attempt: number): number => {
  const exponentialDelay = BASE_DELAY * Math.pow(2, attempt);
  const jitter = Math.random() * 0.3 * exponentialDelay;
  return Math.min(exponentialDelay + jitter, 10000);
};

interface CustomAxiosConfig extends AxiosRequestConfig {
  _retryCount?: number;
}

// Crear instancia de axios
const api: AxiosInstance = axios.create({
  baseURL: API_URL,
  headers: {
    'Content-Type': 'application/json',
  },
  timeout: 30000,
});

// Request interceptor: agregar token y X-Tenant-ID
api.interceptors.request.use(
  (config: InternalAxiosRequestConfig) => {
    // 1. Get tokens from localStorage
    let adminToken = localStorage.getItem('ADMIN_TOKEN');
    const jwtToken = localStorage.getItem('JWT_TOKEN');

    // Auto-init for Admin Token (Compatibility)
    if (!adminToken) {
      const envToken = import.meta.env.VITE_ADMIN_TOKEN;
      if (envToken) {
        localStorage.setItem('ADMIN_TOKEN', envToken);
        adminToken = envToken;
      }
    }

    if (config.headers) {
      // Layer 1: Infrastructure Security
      if (adminToken) config.headers['X-Admin-Token'] = adminToken;

      // Layer 2: Identity Security (Nexus v7.6)
      if (jwtToken) {
        config.headers['Authorization'] = `Bearer ${jwtToken}`;
      }
    }

    // 2. Get and set X-Tenant-ID header
    const tenantId = getCurrentTenantId();
    if (tenantId && config.headers) {
      config.headers['X-Tenant-ID'] = tenantId;
    }

    // Log request
    console.log(`[API] ${config.method?.toUpperCase()} ${config.url} [Tenant: ${tenantId}]`);

    // Agregar retry count metadata
    (config as any).metadata = { retryCount: 0 };

    return config;
  },
  (error: AxiosError) => {
    console.error('[API] Request error:', error.message);
    return Promise.reject(error);
  }
);

// Response interceptor con exponential backoff y retry autom√°tico
api.interceptors.response.use(
  (response) => {
    console.log(`[API] ‚úÖ ${response.config.method?.toUpperCase()} ${response.config.url} - ${response.status}`);
    return response;
  },
  async (error: AxiosError) => {
    const originalConfig = error.config as CustomAxiosConfig | undefined;

    if (!originalConfig || originalConfig._retryCount === undefined) {
      return Promise.reject(error);
    }

    const retryCount = (originalConfig._retryCount || 0) + 1;

    // Solo hacer retry para errores 5xx o p√©rdida de conexi√≥n
    const status = error.response?.status;
    const shouldRetry =
      status && (status >= 500 || error.code === 'ECONNABORTED') &&
      retryCount <= MAX_RETRIES;

    if (shouldRetry) {
      originalConfig._retryCount = retryCount;
      const delayMs = calculateExponentialDelay(retryCount - 1);

      console.log(`[API] ‚è≥ Retry ${retryCount}/${MAX_RETRIES} para ${originalConfig.url} en ${Math.round(delayMs)}ms`);

      await delay(delayMs);
      return api(originalConfig);
    }

    // Manejo espec√≠fico de errores
    if (status === 401) {
      console.warn('[API] ‚ö†Ô∏è Unauthorized - Limpiando token');
      localStorage.removeItem('ADMIN_TOKEN');

      if (!window.location.pathname.includes('/login')) {
        window.location.href = '/login';
      }
    } else if (status === 403) {
      console.warn('[API] ‚ö†Ô∏è Forbidden - Posible error de tenant');
      // Trigger event for tenant-related errors
      window.dispatchEvent(new CustomEvent('tenant:error', { detail: error }));
    } else if (status === 404) {
      console.error('[API] ‚ùå Recurso no encontrado:', originalConfig?.url);
    } else if (status && status >= 500) {
      console.error('[API] üî• Error del servidor:', status, originalConfig?.url);
    } else if (error.code === 'ECONNABORTED') {
      console.error('[API] ‚è∞ Timeout:', originalConfig?.url);
    } else if (!error.response) {
      console.error('[API] üåê Sin conexi√≥n:', error.message);
    }

    return Promise.reject(error);
  }
);

// ============================================
// API HELPERS
// ============================================

// Helper para GET con cache opcional
export const apiGet = async <T>(url: string, useCache = false): Promise<T> => {
  const cacheKey = `cache_${url}`;

  if (useCache) {
    const cached = localStorage.getItem(cacheKey);
    if (cached) {
      try {
        const { data, timestamp } = JSON.parse(cached);
        const age = Date.now() - timestamp;
        if (age < 60000) {
          console.log(`[API] üì¶ Cache hit: ${url}`);
          return data;
        }
      } catch (e) {
        // Invalid cache, continue
      }
    }
  }

  const response = await api.get<T>(url);

  if (useCache) {
    localStorage.setItem(cacheKey, JSON.stringify({
      data: response.data,
      timestamp: Date.now()
    }));
  }

  return response.data;
};

// Helper para POST sin cache
export const apiPost = <T>(url: string, data?: any): Promise<T> =>
  api.post<T>(url, data).then(res => res.data);

// Helper para PUT
export const apiPut = <T>(url: string, data?: any): Promise<T> =>
  api.put<T>(url, data).then(res => res.data);

// Helper para DELETE
export const apiDelete = <T>(url: string): Promise<T> =>
  api.delete<T>(url).then(res => res.data);

export { api };
export default api;
````

## File: frontend_react/src/assets/react.svg
````xml
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="35.93" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 228"><path fill="#00D8FF" d="M210.483 73.824a171.49 171.49 0 0 0-8.24-2.597c.465-1.9.893-3.777 1.273-5.621c6.238-30.281 2.16-54.676-11.769-62.708c-13.355-7.7-35.196.329-57.254 19.526a171.23 171.23 0 0 0-6.375 5.848a155.866 155.866 0 0 0-4.241-3.917C100.759 3.829 77.587-4.822 63.673 3.233C50.33 10.957 46.379 33.89 51.995 62.588a170.974 170.974 0 0 0 1.892 8.48c-3.28.932-6.445 1.924-9.474 2.98C17.309 83.498 0 98.307 0 113.668c0 15.865 18.582 31.778 46.812 41.427a145.52 145.52 0 0 0 6.921 2.165a167.467 167.467 0 0 0-2.01 9.138c-5.354 28.2-1.173 50.591 12.134 58.266c13.744 7.926 36.812-.22 59.273-19.855a145.567 145.567 0 0 0 5.342-4.923a168.064 168.064 0 0 0 6.92 6.314c21.758 18.722 43.246 26.282 56.54 18.586c13.731-7.949 18.194-32.003 12.4-61.268a145.016 145.016 0 0 0-1.535-6.842c1.62-.48 3.21-.974 4.76-1.488c29.348-9.723 48.443-25.443 48.443-41.52c0-15.417-17.868-30.326-45.517-39.844Zm-6.365 70.984c-1.4.463-2.836.91-4.3 1.345c-3.24-10.257-7.612-21.163-12.963-32.432c5.106-11 9.31-21.767 12.459-31.957c2.619.758 5.16 1.557 7.61 2.4c23.69 8.156 38.14 20.213 38.14 29.504c0 9.896-15.606 22.743-40.946 31.14Zm-10.514 20.834c2.562 12.94 2.927 24.64 1.23 33.787c-1.524 8.219-4.59 13.698-8.382 15.893c-8.067 4.67-25.32-1.4-43.927-17.412a156.726 156.726 0 0 1-6.437-5.87c7.214-7.889 14.423-17.06 21.459-27.246c12.376-1.098 24.068-2.894 34.671-5.345a134.17 134.17 0 0 1 1.386 6.193ZM87.276 214.515c-7.882 2.783-14.16 2.863-17.955.675c-8.075-4.657-11.432-22.636-6.853-46.752a156.923 156.923 0 0 1 1.869-8.499c10.486 2.32 22.093 3.988 34.498 4.994c7.084 9.967 14.501 19.128 21.976 27.15a134.668 134.668 0 0 1-4.877 4.492c-9.933 8.682-19.886 14.842-28.658 17.94ZM50.35 144.747c-12.483-4.267-22.792-9.812-29.858-15.863c-6.35-5.437-9.555-10.836-9.555-15.216c0-9.322 13.897-21.212 37.076-29.293c2.813-.98 5.757-1.905 8.812-2.773c3.204 10.42 7.406 21.315 12.477 32.332c-5.137 11.18-9.399 22.249-12.634 32.792a134.718 134.718 0 0 1-6.318-1.979Zm12.378-84.26c-4.811-24.587-1.616-43.134 6.425-47.789c8.564-4.958 27.502 2.111 47.463 19.835a144.318 144.318 0 0 1 3.841 3.545c-7.438 7.987-14.787 17.08-21.808 26.988c-12.04 1.116-23.565 2.908-34.161 5.309a160.342 160.342 0 0 1-1.76-7.887Zm110.427 27.268a347.8 347.8 0 0 0-7.785-12.803c8.168 1.033 15.994 2.404 23.343 4.08c-2.206 7.072-4.956 14.465-8.193 22.045a381.151 381.151 0 0 0-7.365-13.322Zm-45.032-43.861c5.044 5.465 10.096 11.566 15.065 18.186a322.04 322.04 0 0 0-30.257-.006c4.974-6.559 10.069-12.652 15.192-18.18ZM82.802 87.83a323.167 323.167 0 0 0-7.227 13.238c-3.184-7.553-5.909-14.98-8.134-22.152c7.304-1.634 15.093-2.97 23.209-3.984a321.524 321.524 0 0 0-7.848 12.897Zm8.081 65.352c-8.385-.936-16.291-2.203-23.593-3.793c2.26-7.3 5.045-14.885 8.298-22.6a321.187 321.187 0 0 0 7.257 13.246c2.594 4.48 5.28 8.868 8.038 13.147Zm37.542 31.03c-5.184-5.592-10.354-11.779-15.403-18.433c4.902.192 9.899.29 14.978.29c5.218 0 10.376-.117 15.453-.343c-4.985 6.774-10.018 12.97-15.028 18.486Zm52.198-57.817c3.422 7.8 6.306 15.345 8.596 22.52c-7.422 1.694-15.436 3.058-23.88 4.071a382.417 382.417 0 0 0 7.859-13.026a347.403 347.403 0 0 0 7.425-13.565Zm-16.898 8.101a358.557 358.557 0 0 1-12.281 19.815a329.4 329.4 0 0 1-23.444.823c-7.967 0-15.716-.248-23.178-.732a310.202 310.202 0 0 1-12.513-19.846h.001a307.41 307.41 0 0 1-10.923-20.627a310.278 310.278 0 0 1 10.89-20.637l-.001.001a307.318 307.318 0 0 1 12.413-19.761c7.613-.576 15.42-.876 23.31-.876H128c7.926 0 15.743.303 23.354.883a329.357 329.357 0 0 1 12.335 19.695a358.489 358.489 0 0 1 11.036 20.54a329.472 329.472 0 0 1-11 20.722Zm22.56-122.124c8.572 4.944 11.906 24.881 6.52 51.026c-.344 1.668-.73 3.367-1.15 5.09c-10.622-2.452-22.155-4.275-34.23-5.408c-7.034-10.017-14.323-19.124-21.64-27.008a160.789 160.789 0 0 1 5.888-5.4c18.9-16.447 36.564-22.941 44.612-18.3ZM128 90.808c12.625 0 22.86 10.235 22.86 22.86s-10.235 22.86-22.86 22.86s-22.86-10.235-22.86-22.86s10.235-22.86 22.86-22.86Z"></path></svg>
````

## File: frontend_react/src/components/Layout.tsx
````typescript
import React, { type ReactNode, useState, useEffect, useRef } from 'react';
import { useNavigate } from 'react-router-dom';
import { Sidebar } from './Sidebar';
import { useAuth } from '../context/AuthContext';
import { io, Socket } from 'socket.io-client';
import { BACKEND_URL } from '../api/axios';
import { AlertCircle, X } from 'lucide-react';

interface LayoutProps {
  children: ReactNode;
}

export const Layout: React.FC<LayoutProps> = ({ children }) => {
  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
  const { user } = useAuth();
  const navigate = useNavigate();
  const socketRef = useRef<Socket | null>(null);

  // Notification State
  const [notification, setNotification] = useState<{
    show: boolean;
    phone: string;
    reason: string;
  } | null>(null);

  // Global Socket Listener for Handoffs
  useEffect(() => {
    if (!user) return;

    // Conectar socket si no existe
    if (!socketRef.current) {
      // Connect to root namespace (matching ChatsView.tsx logic)
      socketRef.current = io(BACKEND_URL);
    }

    // Listener
    // Listener
    const handleHandoff = (data: { phone_number: string; reason: string }) => {
      console.log('üîî Global Handoff Notification:', data);

      // Mostrar notificaci√≥n
      setNotification({
        show: true,
        phone: data.phone_number,
        reason: data.reason
      });

      // Auto-ocultar a los 5 segundos
      setTimeout(() => {
        setNotification(null);
      }, 5000);

      // Reproducir sonido (opcional, si el navegador lo permite)
      try {
        const audio = new Audio('/assets/notification.mp3');
        // Fallback or generic sound logic here if asset missing
        audio.play().catch(e => console.log('Audio play blocked', e));
      } catch (e) { }
    };

    socketRef.current.on('HUMAN_HANDOFF', handleHandoff);

    return () => {
      socketRef.current?.off('HUMAN_HANDOFF', handleHandoff);
      // No desconectamos el socket aqu√≠ porque Layout se monta/desmonta poco, 
      // pero si navegamos fuera de app (logout), el socket deber√≠a morir.
      // Ojo: ChatsView tambi√©n crea socket. Idealmente deber√≠a ser un Context.
      // Por ahora para cumplir el requerimiento r√°pido, duplicamos la conexi√≥n (low cost).
    };
  }, [user]);

  const handleNotificationClick = () => {
    if (notification) {
      // Navegar al chat seleccionando el tel√©fono
      navigate('/chats', { state: { selectPhone: notification.phone } });
      setNotification(null);
    }
  };

  return (
    <div className="flex h-screen bg-gray-100 relative">
      {/* Sidebar */}
      <Sidebar
        collapsed={sidebarCollapsed}
        onToggle={() => setSidebarCollapsed(!sidebarCollapsed)}
      />

      {/* Main Content */}
      <main
        className={`flex-1 flex flex-col overflow-hidden transition-all duration-300 ${sidebarCollapsed ? 'ml-16' : 'ml-64'
          }`}
      >
        {/* Top Header */}
        <header className="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 shadow-sm">
          <div className="flex items-center gap-4">
            <h1 className="text-xl font-semibold text-medical-900">
              Sistema de Gesti√≥n Dental
            </h1>
          </div>

          <div className="flex items-center gap-4">
            {/* Tenant Selector */}
            <div className="flex items-center gap-2 px-3 py-1.5 bg-gray-100 rounded-lg text-sm">
              <span className="text-gray-500">Sucursal:</span>
              <span className="font-medium text-medical-900">Principal</span>
            </div>

            {/* User Menu */}
            <div className="flex items-center gap-3">
              <div className="flex flex-col items-end">
                <span className="text-sm font-medium text-medical-900">{user?.email?.split('@')[0]}</span>
                <span className="text-xs text-secondary uppercase">{user?.role}</span>
              </div>
              <div className="w-9 h-9 rounded-full bg-medical-600 flex items-center justify-center text-white font-semibold text-lg border-2 border-white shadow-sm">
                {user?.email?.[0].toUpperCase() || 'U'}
              </div>
            </div>
          </div>
        </header>

        {/* Page Content */}
        <div className="flex-1 overflow-auto bg-gray-100 p-6">
          {children}
        </div>
      </main>

      {/* GLOBAL NOTIFICATION TOAST */}
      {notification && (
        <div
          className="fixed bottom-6 right-6 z-50 max-w-sm w-full bg-white rounded-lg shadow-xl border-l-4 border-orange-500 p-4 transform transition-all duration-300 ease-in-out cursor-pointer hover:bg-gray-50"
          onClick={handleNotificationClick}
        >
          <div className="flex items-start gap-3">
            <div className="flex-shrink-0">
              <AlertCircle className="h-6 w-6 text-orange-500" />
            </div>
            <div className="flex-1">
              <h3 className="text-sm font-medium text-gray-900">üîî Derivaci√≥n Humana</h3>
              <p className="mt-1 text-sm text-gray-500 line-clamp-2">
                {notification.phone}: {notification.reason}
              </p>
              <div className="mt-2 text-xs text-orange-600 font-medium">
                Click para abrir chat
              </div>
            </div>
            <button
              onClick={(e) => { e.stopPropagation(); setNotification(null); }}
              className="text-gray-400 hover:text-gray-600"
            >
              <X size={16} />
            </button>
          </div>
        </div>
      )}
    </div>
  );
};

export default Layout;
````

## File: frontend_react/src/components/Modal.tsx
````typescript
import React, { ReactNode } from 'react';
import { X } from 'lucide-react';

interface ModalProps {
    isOpen: boolean;
    onClose: () => void;
    title: string;
    children: ReactNode;
    size?: 'md' | 'lg' | 'xl';
}

export const Modal: React.FC<ModalProps> = ({ isOpen, onClose, title, children, size = 'lg' }) => {
    if (!isOpen) return null;

    return (
        <div className="modal-overlay" style={{ display: 'flex' }} onClick={(e) => {
            if (e.target === e.currentTarget) onClose();
        }}>
            <div className={`modal modal-${size}`}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                    <h2 style={{ fontSize: '24px', fontWeight: 'bold' }}>{title}</h2>
                    <button onClick={onClose} style={{ background: 'none', border: 'none', color: '#fff', cursor: 'pointer' }}>
                        <X size={24} />
                    </button>
                </div>
                <div className="modal-content">
                    {children}
                </div>
            </div>
        </div>
    );
};
````

## File: frontend_react/src/components/PageTransition.tsx
````typescript
import React, { useEffect, useRef } from 'react';
import { useLocation } from 'react-router-dom';

interface PageTransitionProps {
  children: React.ReactNode;
}

export const PageTransition: React.FC<PageTransitionProps> = ({ children }) => {
  const location = useLocation();
  const previousPath = useRef(location.pathname);

  useEffect(() => {
    // Trigger page transition animation
    const content = document.getElementById('page-content');
    if (content) {
      content.classList.add('page-exit');
      setTimeout(() => {
        content.classList.remove('page-exit');
        content.classList.add('page-enter');
      }, 50);
    }
  }, [location.pathname]);

  return (
    <div 
      id="page-content"
      className="page-enter"
    >
      {children}
    </div>
  );
};

// Hook for staggered list animations
export const useStaggeredAnimation = (itemCount: number, baseDelay = 50) => {
  return Array.from({ length: itemCount }).map((_, i) => ({
    animationDelay: `${i * baseDelay}ms`,
  }));
};

// Animated list item
export const AnimatedListItem: React.FC<{
  children: React.ReactNode;
  index: number;
  className?: string;
}> = ({ children, index, className = '' }) => (
  <div
    className={`animate-slide-up ${className}`}
    style={{ animationDelay: `${index * 75}ms` }}
  >
    {children}
  </div>
);

// Fade in animation component
export const FadeIn: React.FC<{
  children: React.ReactNode;
  delay?: number;
  className?: string;
}> = ({ children, delay = 0, className = '' }) => (
  <div
    className={`animate-fade-in ${className}`}
    style={{ animationDelay: `${delay}ms` }}
  >
    {children}
  </div>
);

// Scale in animation component
export const ScaleIn: React.FC<{
  children: React.ReactNode;
  delay?: number;
  className?: string;
}> = ({ children, delay = 0, className = '' }) => (
  <div
    className={`animate-scale-in ${className}`}
    style={{ animationDelay: `${delay}ms` }}
  >
    {children}
  </div>
);

// Slide in from side
export const SlideIn: React.FC<{
  children: React.ReactNode;
  from?: 'left' | 'right';
  delay?: number;
  className?: string;
}> = ({ children, from = 'left', delay = 0, className = '' }) => (
  <div
    className={`animate-slide-in-${from} ${className}`}
    style={{ animationDelay: `${delay}ms` }}
  >
    {children}
  </div>
);

export default PageTransition;
````

## File: frontend_react/src/components/ProtectedRoute.tsx
````typescript
import React from 'react';
import { Navigate, useLocation } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';

interface ProtectedRouteProps {
    children: React.ReactNode;
    allowedRoles?: string[];
}

const ProtectedRoute: React.FC<ProtectedRouteProps> = ({ children, allowedRoles }) => {
    const { isAuthenticated, user, isLoading } = useAuth();
    const location = useLocation();

    if (isLoading) {
        return (
            <div className="loading-screen">
                <div className="loader"></div>
                <p>Verificando sesi√≥n...</p>
            </div>
        );
    }

    if (!isAuthenticated) {
        // Redirect to login but save the current location
        return <Navigate to="/login" state={{ from: location }} replace />;
    }

    if (allowedRoles && user && !allowedRoles.includes(user.role)) {
        // If user doesn't have the required role, redirect to dashboard or home
        return <Navigate to="/" replace />;
    }

    return <>{children}</>;
};

export default ProtectedRoute;
````

## File: frontend_react/src/components/Sidebar.tsx
````typescript
import React from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import {
  LayoutDashboard,
  Calendar,
  Users,
  MessageSquare,
  Settings,
  Activity,
  ChevronLeft,
  ChevronRight,
  Stethoscope,
  FileText,
  BarChart3,
  Home,
  Clock,
  ShieldCheck,
  LogOut
} from 'lucide-react';
import { useAuth } from '../context/AuthContext';

interface SidebarProps {
  collapsed: boolean;
  onToggle: () => void;
}

export const Sidebar: React.FC<SidebarProps> = ({ collapsed, onToggle }) => {
  const navigate = useNavigate();
  const location = useLocation();
  const { user, logout } = useAuth();

  const menuItems = [
    { id: 'dashboard', label: 'Dashboard', icon: <Home size={20} />, path: '/', roles: ['ceo', 'professional', 'secretary'] },
    { id: 'agenda', label: 'Agenda', icon: <Calendar size={20} />, path: '/agenda', roles: ['ceo', 'professional', 'secretary'] },
    { id: 'patients', label: 'Pacientes', icon: <Users size={20} />, path: '/pacientes', roles: ['ceo', 'professional', 'secretary'] },
    { id: 'chats', label: 'Conversaciones', icon: <MessageSquare size={20} />, path: '/chats', roles: ['ceo', 'professional', 'secretary'] },
    { id: 'approvals', label: 'Aprobaciones', icon: <ShieldCheck size={20} />, path: '/aprobaciones', roles: ['ceo'] },
    { id: 'professionals', label: 'Profesionales', icon: <Stethoscope size={20} />, path: '/profesionales', roles: ['ceo', 'secretary'] },
    { id: 'treatments', label: 'Tratamientos', icon: <Clock size={20} />, path: '/tratamientos', roles: ['ceo', 'secretary'] },
    { id: 'settings', label: 'Configuraci√≥n', icon: <Settings size={20} />, path: '/configuracion', roles: ['ceo'] },
  ];

  const filteredItems = menuItems.filter(item => user && item.roles.includes(user.role));

  const isActive = (path: string) => {
    if (path === '/' && location.pathname !== '/') return false;
    return location.pathname === path;
  };

  return (
    <aside
      className={`fixed left-0 top-0 h-screen bg-medical-900 text-white transition-all duration-300 z-50 ${collapsed ? 'w-16' : 'w-64'
        }`}
    >
      {/* Logo */}
      <div className={`h-16 flex items-center ${collapsed ? 'justify-center' : 'px-6'} border-b border-medical-800`}>
        <div className="flex items-center gap-3">
          <div className="w-8 h-8 rounded-lg bg-white/10 flex items-center justify-center">
            <Stethoscope size={18} className="text-white" />
          </div>
          {!collapsed && (
            <span className="font-semibold text-lg">Dental Clinic</span>
          )}
        </div>
      </div>

      {/* Toggle Button */}
      <button
        onClick={onToggle}
        className={`absolute -right-3 top-20 w-6 h-6 bg-white rounded-full shadow-lg flex items-center justify-center text-medical-900 hover:bg-gray-100 transition-colors ${collapsed ? 'left-1/2 -translate-x-1/2' : ''
          }`}
      >
        {collapsed ? <ChevronRight size={14} /> : <ChevronLeft size={14} />}
      </button>

      {/* Navigation */}
      <nav className={`py-4 ${collapsed ? 'px-2' : 'px-3'}`}>
        {filteredItems.map((item) => (
          <button
            key={item.id}
            onClick={() => navigate(item.path)}
            className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200 mb-1 ${isActive(item.path)
                ? 'bg-white/10 text-white'
                : 'text-gray-400 hover:bg-white/5 hover:text-white'
              }`}
            title={collapsed ? item.label : undefined}
          >
            <span className="flex-shrink-0">{item.icon}</span>
            {!collapsed && <span className="font-medium text-sm">{item.label}</span>}
          </button>
        ))}

        <button
          onClick={logout}
          className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200 mt-4 text-red-400 hover:bg-red-500/10`}
          title={collapsed ? 'Cerrar Sesi√≥n' : undefined}
        >
          <LogOut size={20} />
          {!collapsed && <span className="font-medium text-sm">Cerrar Sesi√≥n</span>}
        </button>
      </nav>

      {/* Tenant Info at Bottom */}
      {!collapsed && (
        <div className="absolute bottom-0 left-0 right-0 p-4 border-t border-medical-800">
          <div className="flex items-center gap-3">
            <div className="w-8 h-8 rounded-full bg-medical-600 flex items-center justify-center text-xs font-medium uppercase">
              {user?.email?.[0] || 'U'}
            </div>
            <div className="flex-1 min-w-0">
              <p className="text-sm font-medium truncate">{user?.email}</p>
              <p className="text-xs text-gray-400 truncate uppercase">{user?.role}</p>
            </div>
          </div>
        </div>
      )}
    </aside>
  );
};

export default Sidebar;
````

## File: frontend_react/src/components/SkeletonLoader.tsx
````typescript
import React from 'react';

// ==================== SKELETON LOADER TYPES ====================

interface SkeletonProps {
  variant?: 'text' | 'circular' | 'rectangular' | 'tooth' | 'calendar' | 'avatar';
  width?: string | number;
  height?: string | number;
  animation?: 'pulse' | 'wave' | 'none';
  className?: string;
}

// ==================== BASE SKELETON COMPONENT ====================

const Skeleton: React.FC<SkeletonProps> = ({
  variant = 'text',
  width,
  height,
  animation = 'pulse',
  className = '',
}) => {
  const baseStyles = 'bg-gradient-to-r from-gray-200 via-gray-100 to-gray-200 bg-[length:200%_100%]';
  
  const variantStyles = {
    text: 'rounded h-4',
    circular: 'rounded-full',
    rectangular: 'rounded-lg',
    tooth: 'rounded-sm',
    calendar: 'rounded-md',
    avatar: 'rounded-full',
  };
  
  const animationStyles = {
    pulse: 'animate-pulse',
    wave: 'animate-[shimmer_1.5s_infinite]',
    none: '',
  };
  
  const style: React.CSSProperties = {
    width: typeof width === 'number' ? `${width}px` : width,
    height: typeof height === 'number' ? `${height}px` : height,
  };
  
  return (
    <div
      className={`${baseStyles} ${variantStyles[variant]} ${animationStyles[animation]} ${className}`}
      style={style}
    />
  );
};

// ==================== MEDICAL SKELETONS ====================

// Tooth-shaped skeleton for dental content
export const ToothSkeleton: React.FC<{ className?: string }> = ({ className = '' }) => (
  <div className={`relative ${className}`}>
    <div className="w-12 h-16 bg-gradient-to-r from-gray-200 via-gray-100 to-gray-200 rounded-sm animate-pulse relative overflow-hidden">
      <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-6 h-8 bg-white/30 rounded-sm" />
    </div>
  </div>
);

// Calendar day skeleton for agenda
export const CalendarDaySkeleton: React.FC<{ hasEvent?: boolean }> = ({ hasEvent = false }) => (
  <div className="p-2 border border-gray-100 rounded-lg">
    <Skeleton variant="text" width="60%" height={12} className="mb-2" />
    {hasEvent && (
      <div className="space-y-1">
        <Skeleton variant="rectangular" width="100%" height={8} />
        <Skeleton variant="rectangular" width="80%" height={8} />
      </div>
    )}
  </div>
);

// Patient card skeleton
export const PatientCardSkeleton: React.FC = () => (
  <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
    <div className="flex items-center gap-4">
      <Skeleton variant="avatar" width={48} height={48} />
      <div className="flex-1 space-y-2">
        <Skeleton variant="text" width="60%" height={16} />
        <Skeleton variant="text" width="40%" height={12} />
      </div>
    </div>
    <div className="mt-4 flex gap-2">
      <Skeleton variant="rectangular" width={80} height={24} className="rounded-full" />
      <Skeleton variant="rectangular" width={80} height={24} className="rounded-full" />
    </div>
  </div>
);

// Agenda event skeleton
export const AgendaEventSkeleton: React.FC = () => (
  <div className="p-3 rounded-lg border border-gray-100 mb-2">
    <div className="flex items-center gap-3">
      <div className="w-1 h-12 rounded-full bg-gradient-to-b from-blue-400 to-blue-600" />
      <div className="flex-1 space-y-2">
        <Skeleton variant="text" width="70%" height={14} />
        <Skeleton variant="text" width="50%" height={12} />
      </div>
    </div>
  </div>
);

// Chat message skeleton
export const ChatMessageSkeleton: React.FC<{ isUser?: boolean }> = ({ isUser = false }) => (
  <div className={`flex gap-3 ${isUser ? 'flex-row-reverse' : ''}`}>
    <Skeleton variant="circular" width={32} height={32} />
    <div className={`max-w-[70%] space-y-2 ${isUser ? 'items-end' : 'items-start'}`}>
      <div className={`${isUser ? 'bg-blue-100' : 'bg-gray-100'} p-3 rounded-2xl rounded-${isUser ? 'tl-none' : 'tr-none'}`}>
        <Skeleton variant="text" width={120} height={12} />
        <Skeleton variant="text" width={80} height={12} className="mt-1" />
      </div>
    </div>
  </div>
);

// Stats card skeleton
export const StatsCardSkeleton: React.FC = () => (
  <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
    <div className="flex items-center justify-between mb-4">
      <Skeleton variant="circular" width={48} height={48} />
      <Skeleton variant="text" width={60} height={24} />
    </div>
    <Skeleton variant="text" width="80%" height={32} />
    <Skeleton variant="text" width="50%" height={14} className="mt-2" />
  </div>
);

// Form field skeleton
export const FormFieldSkeleton: React.FC = () => (
  <div className="space-y-2">
    <Skeleton variant="text" width={100} height={14} />
    <Skeleton variant="rectangular" width="100%" height={40} />
  </div>
);

// Table row skeleton
export const TableRowSkeleton: React.FC<{ columns: number }> = ({ columns }) => (
  <tr className="border-b border-gray-50">
    {Array.from({ length: columns }).map((_, i) => (
      <td key={i} className="px-4 py-3">
        <Skeleton variant="text" width="80%" height={16} />
      </td>
    ))}
  </tr>
);

// Professional avatar skeleton
export const ProfessionalAvatarSkeleton: React.FC = () => (
  <div className="flex items-center gap-3 p-3">
    <Skeleton variant="circular" width={56} height={56} />
    <div className="space-y-2">
      <Skeleton variant="text" width={150} height={18} />
      <Skeleton variant="text" width={100} height={14} />
    </div>
  </div>
);

// ==================== LOADING SCREENS ====================

// Full page loading with dental theme
export const PageLoader: React.FC<{ message?: string }> = ({ message = 'Cargando...' }) => (
  <div className="min-h-[400px] flex flex-col items-center justify-center p-8">
    <div className="relative mb-6">
      {/* Rotating tooth animation */}
      <div className="w-16 h-16 border-4 border-primary/20 border-t-primary rounded-full animate-spin" />
      <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
        <svg className="w-8 h-8 text-primary" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C9.5 2 7 4.5 7 7c0 1.5.5 2.5 1.5 3.5L7 14c0 1.5 1 3 2.5 3h5c1.5 0 2.5-1.5 2.5-3l-1.5-3.5C16.5 9.5 17 8.5 17 7c0-2.5-2.5-5-5-5zm0 2c1.5 0 3 1 3 2.5 0 .5-.5 1.5-1.5 2.5h-3C.5 89 9 7 9 6.5 9 5 10.5 4 12 4z" />
        </svg>
      </div>
    </div>
    <p className="text-gray-500 font-medium">{message}</p>
    <div className="mt-4 flex gap-1">
      <span className="w-2 h-2 bg-primary rounded-full animate-bounce [animation-delay:0s]" />
      <span className="w-2 h-2 bg-primary rounded-full animate-bounce [animation-delay:0.1s]" />
      <span className="w-2 h-2 bg-primary rounded-full animate-bounce [animation-delay:0.2s]" />
    </div>
  </div>
);

// Card grid loader
export const CardGridSkeleton: React.FC<{ count?: number }> = ({ count = 4 }) => (
  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    {Array.from({ length: count }).map((_, i) => (
      <PatientCardSkeleton key={i} />
    ))}
  </div>
);

// Chat list loader
export const ChatListSkeleton: React.FC = () => (
  <div className="space-y-3">
    {Array.from({ length: 5 }).map((_, i) => (
      <div key={i} className="flex items-center gap-3 p-3">
        <Skeleton variant="circular" width={48} height={48} />
        <div className="flex-1 space-y-2">
          <div className="flex justify-between">
            <Skeleton variant="text" width={120} height={14} />
            <Skeleton variant="text" width={40} height={12} />
          </div>
          <Skeleton variant="text" width="80%" height={12} />
        </div>
      </div>
    ))}
  </div>
);

// ==================== UTILITY ====================

export default Skeleton;
````

## File: frontend_react/src/context/AuthContext.tsx
````typescript
import React, { createContext, useContext, useState, useEffect, ReactNode } from 'react';

interface User {
    id: string;
    email: string;
    role: 'ceo' | 'professional' | 'secretary';
}

interface AuthContextType {
    user: User | null;
    token: string | null;
    login: (token: string, user: User) => void;
    logout: () => void;
    isAuthenticated: boolean;
    isLoading: boolean;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export const AuthProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
    const [user, setUser] = useState<User | null>(null);
    const [token, setToken] = useState<string | null>(localStorage.getItem('JWT_TOKEN'));
    const [isLoading, setIsLoading] = useState(true);

    useEffect(() => {
        const savedUser = localStorage.getItem('USER_PROFILE');
        if (savedUser && token) {
            try {
                setUser(JSON.parse(savedUser));
            } catch (e) {
                console.error("Error parsing user profile:", e);
                logout();
            }
        }
        setIsLoading(false);
    }, [token]);

    const login = (newToken: string, profile: User) => {
        localStorage.setItem('JWT_TOKEN', newToken);
        localStorage.setItem('USER_PROFILE', JSON.stringify(profile));
        setToken(newToken);
        setUser(profile);
    };

    const logout = () => {
        localStorage.removeItem('JWT_TOKEN');
        localStorage.removeItem('USER_PROFILE');
        setToken(null);
        setUser(null);
    };

    return (
        <AuthContext.Provider value={{
            user,
            token,
            login,
            logout,
            isAuthenticated: !!token,
            isLoading
        }}>
            {children}
        </AuthContext.Provider>
    );
};

export const useAuth = () => {
    const context = useContext(AuthContext);
    if (context === undefined) {
        throw new Error('useAuth must be used within an AuthProvider');
    }
    return context;
};
````

## File: frontend_react/src/hooks/useApi.ts
````typescript
import { useState, useCallback } from 'react';

const API_BASE = import.meta.env.VITE_API_BASE_URL || detectApiBase();
const ADMIN_TOKEN = import.meta.env.VITE_ADMIN_TOKEN || "";

function detectApiBase() {
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        return 'http://localhost:8000';
    }
    let hostname = window.location.hostname;
    if (hostname.includes('platform-ui')) {
        return window.location.protocol + '//' + hostname.replace('platform-ui', 'orchestrator-service');
    }
    // Fallback for EasyPanel
    if (hostname.includes('frontend-react')) {
        return window.location.protocol + '//' + hostname.replace('frontend-react', 'bff-service').replace('5173', '3000');
    }
    // Default to relative for BFF
    return '/api';
}

interface FetchOptions {
    method?: string;
    body?: any;
    headers?: Record<string, string>;
}

export function useApi() {
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState<string | null>(null);

    const fetchApi = useCallback(async (endpoint: string, options: FetchOptions = {}) => {
        setLoading(true);
        setError(null);
        try {
            const headers: Record<string, string> = {
                'Content-Type': 'application/json',
                'x-admin-token': ADMIN_TOKEN,
                ...options.headers
            };

            // Handle BFF proxying if we use relative paths
            const url = endpoint.startsWith('http') ? endpoint : `${API_BASE}${endpoint}`;

            const response = await fetch(url, {
                method: options.method || 'GET',
                headers,
                body: options.body ? JSON.stringify(options.body) : undefined,
            });

            if (!response.ok) {
                const errorData = await response.text();
                throw new Error(errorData || `HTTP ${response.status}`);
            }

            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return await response.json();
            }
            return await response.text();

        } catch (err: any) {
            setError(err.message);
            throw err;
        } finally {
            setLoading(false);
        }
    }, []);

    return { fetchApi, loading, error };
}
````

## File: frontend_react/src/views/AgendaView.tsx
````typescript
import { useState, useEffect, useRef, useCallback } from 'react';
import { useNavigate } from 'react-router-dom';
import FullCalendar from '@fullcalendar/react';
import dayGridPlugin from '@fullcalendar/daygrid';
import interactionPlugin from '@fullcalendar/interaction';
import timeGridPlugin from '@fullcalendar/timegrid';
import { Calendar, X, User, Stethoscope, Clock, Phone, MessageCircle, AlertTriangle, Wifi, WifiOff, RefreshCw, Cloud, CloudOff, CheckCircle, AlertCircle } from 'lucide-react';
import api from '../api/axios';
import { io, Socket } from 'socket.io-client';
import { BACKEND_URL } from '../api/axios';

// ==================== TYPE DEFINITIONS ====================
interface Appointment {
  id: string;
  patient_id: number;
  professional_id: number;
  appointment_datetime: string;
  end_datetime?: string;
  duration_minutes?: number;
  status: string;
  urgency_level?: string;
  source?: string;
  appointment_type: string;
  notes?: string;
  patient_name?: string;
  patient_phone?: string;
  professional_name?: string;
}

interface GoogleCalendarBlock {
  id: string;
  google_event_id: string;
  title: string;
  description?: string;
  start_datetime: string;
  end_datetime: string;
  all_day?: boolean;
  professional_id?: number;
  sync_status?: string;
}

interface Professional {
  id: number;
  first_name: string;
  last_name?: string;
  name?: string;
  is_active: boolean;
}

interface Patient {
  id: number;
  first_name: string;
  last_name: string;
  phone_number: string;
}

// ==================== SOURCE COLORS ====================
// Colors for appointment sources: AI (blue), Manual (green), GCalendar (gray)
const SOURCE_COLORS: Record<string, { hex: string; label: string; bgClass: string; textClass: string }> = {
  ai: { 
    hex: '#3b82f6', 
    label: 'AI',
    bgClass: 'bg-blue-100',
    textClass: 'text-blue-800'
  },
  manual: { 
    hex: '#22c55e', 
    label: 'Manual',
    bgClass: 'bg-green-100',
    textClass: 'text-green-800'
  },
  gcalendar: { 
    hex: '#6b7280', 
    label: 'GCalendar',
    bgClass: 'bg-gray-100',
    textClass: 'text-gray-800'
  },
};

// Mapeo de IDs de appointment_statuses a colores hexadecimales
// 1: scheduled, 2: confirmed, 3: in_progress, 4: completed, 5: cancelled, 6: no_show
const STATUS_COLORS: Record<number, { hex: string; label: string }> = {
  1: { hex: '#3b82f6', label: 'scheduled' },   // azul - Programado
  2: { hex: '#22c55e', label: 'confirmed' },   // verde - Confirmado
  3: { hex: '#eab308', label: 'in_progress' }, // amarillo - En progreso
  4: { hex: '#6b7280', label: 'completed' },   // gris - Completado
  5: { hex: '#ef4444', label: 'cancelled' },   // rojo - Cancelado
  6: { hex: '#f97316', label: 'no_show' },     // naranja - No asistido
};

// UI colors for buttons and badges
const STATUS_UI_COLORS: Record<string, { bg: string; text: string; border: string }> = {
  scheduled: { bg: 'bg-blue-100 text-blue-800 border-blue-300', text: 'text-blue-800', border: 'border-blue-500' },
  confirmed: { bg: 'bg-green-100 text-green-800 border-green-300', text: 'text-green-800', border: 'border-green-500' },
  in_progress: { bg: 'bg-yellow-100 text-yellow-800 border-yellow-300', text: 'text-yellow-800', border: 'border-yellow-500' },
  completed: { bg: 'bg-gray-100 text-gray-800 border-gray-300', text: 'text-gray-800', border: 'border-gray-500' },
  cancelled: { bg: 'bg-red-100 text-red-800 border-red-300', text: 'text-red-800', border: 'border-red-500' },
  no_show: { bg: 'bg-orange-100 text-orange-800 border-orange-300', text: 'text-orange-800', border: 'border-orange-500' },
};

// Reverse mapping for status string to ID
const STATUS_STRING_TO_ID: Record<string, number> = {
  scheduled: 1,
  confirmed: 2,
  in_progress: 3,
  completed: 4,
  cancelled: 5,
  no_show: 6,
};

// Get status ID from status string
const getStatusId = (status: string): number => STATUS_STRING_TO_ID[status] || 1;

// Get color hex from status (string or ID)
const getStatusColorHex = (status: string | number): string => {
  if (typeof status === 'number') {
    return STATUS_COLORS[status]?.hex || STATUS_COLORS[1].hex;
  }
  const statusId = getStatusId(status);
  return STATUS_COLORS[statusId]?.hex || STATUS_COLORS[1].hex;
};

// Get color based on appointment source (AI vs Manual)
const getSourceColor = (source: string | undefined): string => {
  if (!source) return SOURCE_COLORS.ai.hex; // Default to AI if no source
  return SOURCE_COLORS[source]?.hex || SOURCE_COLORS.ai.hex;
};

// Get source label
const getSourceLabel = (source: string | undefined): string => {
  if (!source) return 'AI';
  return SOURCE_COLORS[source]?.label || source.toUpperCase();
};

export default function AgendaView() {
  const [appointments, setAppointments] = useState<Appointment[]>([]);
  const [googleBlocks, setGoogleBlocks] = useState<GoogleCalendarBlock[]>([]);
  const [professionals, setProfessionals] = useState<Professional[]>([]);
  const [patients, setPatients] = useState<Patient[]>([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [selectedDate, setSelectedDate] = useState<Date | null>(null);
  const [selectedEvent, setSelectedEvent] = useState<Appointment | null>(null);
  const [socketConnected, setSocketConnected] = useState(false);
  const [lastUpdate, setLastUpdate] = useState<Date | null>(null);
  const [syncStatus, setSyncStatus] = useState<{ syncing: boolean; lastSync: Date | null; error: string | null }>({
    syncing: false,
    lastSync: null,
    error: null,
  });
  const [collisionWarning, setCollisionWarning] = useState<{ hasCollision: boolean; message: string } | null>(null);
  const [insuranceStatus, setInsuranceStatus] = useState<{
    status: string;
    requires_token: boolean;
    message: string;
    expiration_days: number | null;
    insurance_provider: string | null;
  } | null>(null);
  const calendarRef = useRef<FullCalendar>(null);
  const socketRef = useRef<Socket | null>(null);
  const eventsRef = useRef<Appointment[]>([]);
  
  const [formData, setFormData] = useState({
    patient_id: '',
    professional_id: '',
    appointment_datetime: '',
    appointment_type: 'checkup',
    notes: '',
  });

  // Fetch Google Calendar blocks
  const fetchGoogleBlocks = useCallback(async (startDate: string, endDate: string) => {
    try {
      const response = await api.get('/admin/calendar/blocks', {
        params: { start_date: startDate, end_date: endDate },
      });
      return response.data;
    } catch (error) {
      console.error('Error fetching Google Calendar blocks:', error);
      return [];
    }
  }, []);

  // Trigger Google Calendar sync
  const handleSyncNow = async () => {
    try {
      setSyncStatus({ ...syncStatus, syncing: true, error: null });
      const response = await api.post('/admin/sync/calendar');
      setSyncStatus({
        syncing: false,
        lastSync: new Date(),
        error: null,
      });
      
      // Refresh calendar data after sync
      fetchData();
      alert(`Sincronizaci√≥n completada: ${response.data.events_processed} eventos procesados`);
    } catch (error: any) {
      console.error('Error syncing calendar:', error);
      setSyncStatus({
        ...syncStatus,
        syncing: false,
        error: error.response?.data?.message || 'Error en sincronizaci√≥n',
      });
      alert(`Error en sincronizaci√≥n: ${syncStatus.error}`);
    }
  };

  // Check for collisions before creating appointment
  const checkCollisions = useCallback(async (professionalId: string, datetimeStr: string): Promise<boolean> => {
    if (!professionalId || !datetimeStr) return false;
    
    try {
      const response = await api.get('/admin/appointments/check-collisions', {
        params: {
          professional_id: professionalId,
          datetime_str: datetimeStr,
          duration_minutes: 60,
        },
      });
      
      if (response.data.has_collisions) {
        const conflicts: string[] = [];
        
        if (response.data.conflicting_appointments?.length > 0) {
          conflicts.push('Turno existente en ese horario');
        }
        if (response.data.conflicting_blocks?.length > 0) {
          conflicts.push(`Bloqueo GCalendar: ${response.data.conflicting_blocks.map((b: any) => b.title).join(', ')}`);
        }
        
        setCollisionWarning({
          hasCollision: true,
          message: `‚ö†Ô∏è Hay conflictos: ${conflicts.join('; ')}`,
        });
        return true;
      } else {
        setCollisionWarning(null);
        return false;
      }
    } catch (error) {
      console.error('Error checking collisions:', error);
      return false;
    }
  }, []);

  // Check insurance status when patient is selected
  const checkInsuranceStatus = useCallback(async (patientId: string) => {
    if (!patientId) {
      setInsuranceStatus(null);
      return;
    }

    try {
      const response = await api.get(`/admin/patients/${patientId}/insurance-status`);
      setInsuranceStatus(response.data);
    } catch (error) {
      console.error('Error checking insurance status:', error);
      setInsuranceStatus(null);
    }
  }, []);

  // Fetch all data
  const fetchData = useCallback(async () => {
    try {
      setLoading(true);
      
      // Get current calendar date range
      let startDate = new Date();
      let endDate = new Date();
      if (calendarRef.current) {
        const calendarApi = calendarRef.current.getApi();
        startDate = calendarApi.view.activeStart;
        endDate = calendarApi.view.activeEnd;
      }
      
      const startDateStr = startDate.toISOString();
      const endDateStr = endDate.toISOString();
      
      const [appointmentsRes, professionalsRes, patientsRes, blocksRes] = await Promise.all([
        api.get('/admin/appointments', { params: { start_date: startDateStr, end_date: endDateStr } }),
        api.get('/admin/professionals'),
        api.get('/admin/patients'),
        fetchGoogleBlocks(startDateStr, endDateStr),
      ]);
      
      const newAppointments = appointmentsRes.data;
      setAppointments(newAppointments);
      eventsRef.current = newAppointments;
      setGoogleBlocks(blocksRes || []);
      setProfessionals(professionalsRes.data.filter((p: Professional) => p.is_active));
      setPatients(patientsRes.data);
      setLastUpdate(new Date());
      
      // Force calendar refetch if calendar instance exists
      if (calendarRef.current) {
        const calendarApi = calendarRef.current.getApi();
        calendarApi.removeAllEvents();
        
        // Add appointment events
        const appointmentEvents = newAppointments.map((apt: Appointment) => ({
          id: apt.id,
          title: `${apt.patient_name} - ${apt.appointment_type}`,
          start: apt.appointment_datetime,
          end: apt.end_datetime || undefined,
          backgroundColor: getSourceColor(apt.source),
          borderColor: getSourceColor(apt.source),
          extendedProps: { ...apt, eventType: 'appointment' },
        }));
        
        // Add Google Calendar block events
        const blockEvents = (blocksRes || []).map((block: GoogleCalendarBlock) => ({
          id: block.id,
          title: `üîí ${block.title}`,
          start: block.start_datetime,
          end: block.end_datetime,
          allDay: block.all_day || false,
          backgroundColor: SOURCE_COLORS.gcalendar.hex,
          borderColor: SOURCE_COLORS.gcalendar.hex,
          extendedProps: { ...block, eventType: 'gcalendar_block' },
        }));
        
        calendarApi.addEventSource([...appointmentEvents, ...blockEvents]);
      }
    } catch (error) {
      console.error('Error fetching data:', error);
    } finally {
      setLoading(false);
    }
  }, [fetchGoogleBlocks]);

  // Setup WebSocket connection and listeners
  useEffect(() => {
    // Fetch initial data
    fetchData();
    
    // Setup WebSocket connection
    socketRef.current = io(BACKEND_URL, {
      transports: ['websocket', 'polling'],
      reconnection: true,
      reconnectionAttempts: 5,
      reconnectionDelay: 1000,
    });

    // Connection status handlers
    socketRef.current.on('connect', () => {
      console.log('WebSocket connected');
      setSocketConnected(true);
    });

    socketRef.current.on('disconnect', () => {
      console.log('WebSocket disconnected');
      setSocketConnected(false);
    });

    socketRef.current.on('connect_error', (error) => {
      console.error('WebSocket connection error:', error);
      setSocketConnected(false);
    });

    // Listen for NEW_APPOINTMENT events - Real-time sync from AI bot
    socketRef.current.on('NEW_APPOINTMENT', (newAppointment: Appointment) => {
      console.log('üìÖ Nuevo turno recibido via WebSocket:', newAppointment);
      
      setAppointments(prevAppointments => {
        const updated = [...prevAppointments, newAppointment];
        eventsRef.current = updated;
        return updated;
      });
      
      setLastUpdate(new Date());
      
      // Add event directly to calendar without refetching
      if (calendarRef.current) {
        const calendarApi = calendarRef.current.getApi();
        calendarApi.addEvent({
          id: newAppointment.id,
          title: `${newAppointment.patient_name} - ${newAppointment.appointment_type}`,
          start: newAppointment.appointment_datetime,
          end: newAppointment.end_datetime || undefined,
          backgroundColor: getSourceColor(newAppointment.source),
          borderColor: getSourceColor(newAppointment.source),
          extendedProps: { ...newAppointment, eventType: 'appointment' },
        });
      }
    });

    // Listen for APPOINTMENT_UPDATED events
    socketRef.current.on('APPOINTMENT_UPDATED', (updatedAppointment: Appointment) => {
      console.log('üîÑ Turno actualizado via WebSocket:', updatedAppointment);
      
      setAppointments(prevAppointments => {
        const updated = prevAppointments.map(apt => 
          apt.id === updatedAppointment.id ? updatedAppointment : apt
        );
        eventsRef.current = updated;
        return updated;
      });
      
      setLastUpdate(new Date());
      
      // Update event in calendar
      if (calendarRef.current) {
        const calendarApi = calendarRef.current.getApi();
        const existingEvent = calendarApi.getEventById(updatedAppointment.id);
        if (existingEvent) {
          existingEvent.setProp('title', `${updatedAppointment.patient_name} - ${updatedAppointment.appointment_type}`);
          existingEvent.setStart(updatedAppointment.appointment_datetime);
          if (updatedAppointment.end_datetime) {
            existingEvent.setEnd(updatedAppointment.end_datetime);
          }
          existingEvent.setProp('backgroundColor', getSourceColor(updatedAppointment.source));
          existingEvent.setProp('borderColor', getSourceColor(updatedAppointment.source));
          existingEvent.setExtendedProp('extendedProps', { ...updatedAppointment, eventType: 'appointment' });
        }
      }
    });

    // Listen for APPOINTMENT_DELETED events
    socketRef.current.on('APPOINTMENT_DELETED', (deletedAppointmentId: string) => {
      console.log('‚ùå Turno eliminado via WebSocket:', deletedAppointmentId);
      
      setAppointments(prevAppointments => {
        const updated = prevAppointments.filter(apt => apt.id !== deletedAppointmentId);
        eventsRef.current = updated;
        return updated;
      });
      
      setLastUpdate(new Date());
      
      // Remove event from calendar
      if (calendarRef.current) {
        const calendarApi = calendarRef.current.getApi();
        const existingEvent = calendarApi.getEventById(deletedAppointmentId);
        if (existingEvent) {
          existingEvent.remove();
        }
      }
    });

    return () => {
      // Cleanup WebSocket connection
      if (socketRef.current) {
        socketRef.current.disconnect();
      }
    };
  }, [fetchData]);

  // Calendar events transformer
  const calendarEvents = [
    ...appointments.map((apt) => ({
      id: apt.id,
      title: `${apt.patient_name} - ${apt.appointment_type}`,
      start: apt.appointment_datetime,
      end: apt.end_datetime || undefined,
      backgroundColor: getSourceColor(apt.source),
      borderColor: getSourceColor(apt.source),
      extendedProps: { ...apt, eventType: 'appointment' },
    })),
    ...googleBlocks.map((block) => ({
      id: block.id,
      title: `üîí ${block.title}`,
      start: block.start_datetime,
      end: block.end_datetime,
      allDay: block.all_day || false,
      backgroundColor: SOURCE_COLORS.gcalendar.hex,
      borderColor: SOURCE_COLORS.gcalendar.hex,
      extendedProps: { ...block, eventType: 'gcalendar_block' },
    })),
  ];

  const handleDateClick = (info: { date: Date }) => {
    setSelectedDate(info.date);
    setSelectedEvent(null);
    setCollisionWarning(null);
    setInsuranceStatus(null);
    setFormData({
      patient_id: '',
      professional_id: professionals[0]?.id?.toString() || '',
      appointment_datetime: info.date.toISOString().slice(0, 16),
      appointment_type: 'checkup',
      notes: '',
    });
    setShowModal(true);
  };

  const handleEventClick = (info: any) => {
    // Check if it's a Google Calendar block
    if (info.event.extendedProps.eventType === 'gcalendar_block') {
      alert(`Bloqueo de Google Calendar:\n\n${info.event.title}\n${new Date(info.event.start).toLocaleString()} - ${new Date(info.event.end).toLocaleString()}`);
      return;
    }
    
    setSelectedEvent(info.event.extendedProps);
    setSelectedDate(info.event.start);
    setShowModal(true);
  };

  const handleProfessionalChange = async (profId: string) => {
    setFormData({ ...formData, professional_id: profId });
    
    // Check for collisions when professional or datetime changes
    if (formData.appointment_datetime && profId) {
      await checkCollisions(profId, formData.appointment_datetime);
    }
  };

  const handleDateTimeChange = async (datetimeStr: string) => {
    setFormData({ ...formData, appointment_datetime: datetimeStr });
    
    // Check for collisions
    if (formData.professional_id && datetimeStr) {
      await checkCollisions(formData.professional_id, datetimeStr);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    // Final collision check before submission
    if (collisionWarning?.hasCollision) {
      if (!confirm('Hay conflictos de horario. ¬øDeseas agendar de todas formas?')) {
        return;
      }
    }
    
    try {
      if (selectedEvent) {
        // Update existing appointment
        await api.put(`/admin/appointments/${selectedEvent.id}`, {
          patient_id: parseInt(formData.patient_id),
          professional_id: parseInt(formData.professional_id),
          appointment_datetime: formData.appointment_datetime,
          appointment_type: formData.appointment_type,
          notes: formData.notes,
        });
      } else {
        // Create new appointment manually (source='manual')
        await api.post('/admin/appointments', {
          patient_id: parseInt(formData.patient_id),
          professional_id: parseInt(formData.professional_id),
          appointment_datetime: formData.appointment_datetime,
          appointment_type: formData.appointment_type,
          notes: formData.notes,
          status: 'confirmed',
          source: 'manual',
        });
      }
      fetchData();
      setShowModal(false);
      setCollisionWarning(null);
      setInsuranceStatus(null);
    } catch (error: any) {
      console.error('Error saving appointment:', error);
      if (error.response?.status === 409) {
        setCollisionWarning({
          hasCollision: true,
          message: `‚ö†Ô∏è ${error.response.data.detail}`,
        });
      } else {
        alert('Error al guardar turno');
      }
    }
  };

  const handleStatusChange = async (status: string) => {
    if (!selectedEvent) return;
    try {
      await api.put(`/admin/appointments/${selectedEvent.id}/status`, { status });
      fetchData();
      setShowModal(false);
    } catch (error) {
      console.error('Error changing status:', error);
      alert('Error al cambiar estado');
    }
  };

  const handleDelete = async () => {
    if (!selectedEvent || !confirm('¬øCancelar este turno?')) return;
    try {
      await api.put(`/admin/appointments/${selectedEvent.id}/status`, { status: 'cancelled' });
      fetchData();
      setShowModal(false);
    } catch (error) {
      console.error('Error cancelling appointment:', error);
    }
  };

  return (
    <div className="p-6">
      {/* Header */}
      <div className="flex justify-between items-center mb-6">
        <div>
          <h1 className="text-2xl font-bold text-gray-800">Agenda</h1>
          <p className="text-gray-500">Gesti√≥n de turnos y citas</p>
        </div>
        
        {/* Connection Status & Controls */}
        <div className="flex items-center gap-4">
          {/* Source Legend */}
          <div className="flex gap-3">
            <div className="flex items-center gap-1">
              <div className="w-3 h-3 rounded-full bg-blue-500"></div>
              <span className="text-xs text-gray-600 hidden sm:inline">AI</span>
            </div>
            <div className="flex items-center gap-1">
              <div className="w-3 h-3 rounded-full bg-green-500"></div>
              <span className="text-xs text-gray-600 hidden sm:inline">Manual</span>
            </div>
            <div className="flex items-center gap-1">
              <div className="w-3 h-3 rounded-full bg-gray-500"></div>
              <span className="text-xs text-gray-600 hidden sm:inline">GCal</span>
            </div>
          </div>
          
          {/* WebSocket Status */}
          <div className="flex items-center gap-2 px-3 py-1.5 bg-gray-100 rounded-full">
            {socketConnected ? (
              <>
                <Wifi size={16} className="text-green-500" />
                <span className="text-xs text-green-600 font-medium">Conectado</span>
              </>
            ) : (
              <>
                <WifiOff size={16} className="text-red-500" />
                <span className="text-xs text-red-600 font-medium">Desconectado</span>
              </>
            )}
          </div>
          
          {/* Sync Status */}
          <div className="flex items-center gap-2">
            {syncStatus.syncing ? (
              <div className="flex items-center gap-2 px-3 py-1.5 bg-yellow-100 rounded-full">
                <RefreshCw size={16} className="text-yellow-600 animate-spin" />
                <span className="text-xs text-yellow-600 font-medium">Sincronizando...</span>
              </div>
            ) : syncStatus.lastSync ? (
              <div className="flex items-center gap-2 px-3 py-1.5 bg-green-100 rounded-full">
                <Cloud size={16} className="text-green-600" />
                <span className="text-xs text-green-600 font-medium">Sincronizado</span>
              </div>
            ) : null}
          </div>
          
          {/* Sync Now Button */}
          <button
            onClick={handleSyncNow}
            disabled={syncStatus.syncing}
            className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-colors ${
              syncStatus.syncing 
                ? 'bg-gray-200 text-gray-400 cursor-not-allowed'
                : 'bg-blue-600 text-white hover:bg-blue-700'
            }`}
            title="Sincronizar con Google Calendar"
          >
            <Cloud size={18} />
            <span className="hidden sm:inline">Sync Now</span>
          </button>
          
          {/* Last Update */}
          {lastUpdate && (
            <div className="flex items-center gap-2 text-xs text-gray-500">
              <RefreshCw size={14} />
              <span>Actualizado: {lastUpdate.toLocaleTimeString()}</span>
            </div>
          )}
          
          {/* Manual Refresh */}
          <button
            onClick={fetchData}
            className="p-2 text-gray-600 hover:text-primary hover:bg-gray-100 rounded-lg transition-colors"
            title="Actualizar agenda"
          >
            <RefreshCw size={20} />
          </button>
        </div>
      </div>

      {/* Calendar */}
      <div className="bg-white rounded-lg shadow p-4">
        {loading && appointments.length === 0 ? (
          <div className="p-8 text-center text-gray-500">
            <div className="animate-spin inline-block w-8 h-8 border-4 border-primary border-t-transparent rounded-full mb-4 mx-auto"></div>
            <p>Cargando agenda...</p>
          </div>
        ) : (
          <FullCalendar
            ref={calendarRef}
            plugins={[dayGridPlugin, timeGridPlugin, interactionPlugin]}
            initialView="dayGridMonth"
            headerToolbar={{
              left: 'prev,next today',
              center: 'title',
              right: 'dayGridMonth,timeGridWeek,timeGridDay',
            }}
            events={calendarEvents}
            dateClick={handleDateClick}
            eventClick={handleEventClick}
            slotMinTime="08:00:00"
            slotMaxTime="20:00:00"
            allDaySlot={false}
            height="auto"
            eventTimeFormat={{
              hour: '2-digit',
              minute: '2-digit',
              meridiem: 'short',
            }}
            slotLabelFormat={{
              hour: '2-digit',
              minute: '2-digit',
              hour12: false,
            }}
            eventContent={(eventInfo) => (
              <div className="p-1 text-xs overflow-hidden">
                {eventInfo.event.extendedProps.eventType === 'gcalendar_block' ? (
                  <div className="font-medium truncate text-gray-700">
                    <CloudOff size={12} className="inline mr-1" />
                    {eventInfo.event.title.replace('üîí ', '')}
                  </div>
                ) : (
                  <>
                    <div className="font-medium truncate">{eventInfo.event.title}</div>
                    {eventInfo.event.extendedProps.professional_name && (
                      <div className="text-xs opacity-75 truncate">
                        Dr. {eventInfo.event.extendedProps.professional_name}
                      </div>
                    )}
                    {/* Source badge */}
                    <div className={`inline-flex px-1 py-0.5 rounded text-[10px] mt-0.5 ${
                      SOURCE_COLORS[eventInfo.event.extendedProps.source || 'ai']?.bgClass || 'bg-blue-100'
                    } ${SOURCE_COLORS[eventInfo.event.extendedProps.source || 'ai']?.textClass || 'text-blue-800'}`}>
                      {getSourceLabel(eventInfo.event.extendedProps.source)}
                    </div>
                  </>
                )}
              </div>
            )}
            eventDidMount={(info) => {
              // Add tooltip with full details
              const { appointment_type, patient_phone, notes, source, professional_name, eventType } = info.event.extendedProps;
              
              if (eventType === 'gcalendar_block') {
                const startDate = info.event.start;
                if (startDate) {
                  info.el.title = `üîí ${info.event.title}\n${startDate.toLocaleString()}`;
                }
              } else {
                const tooltipContent = `
                  ${info.event.title}
                  ${source ? `\nüìç Origen: ${getSourceLabel(source)}` : ''}
                  ${patient_phone ? `\nüìû ${patient_phone}` : ''}
                  ${professional_name ? `\nüë®‚Äç‚öïÔ∏è Dr. ${professional_name}` : ''}
                  ${notes ? `\nüìù ${notes}` : ''}
                `.trim();
                info.el.title = tooltipContent;
              }
            }}
          />
        )}
      </div>

      {/* Modal */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between items-center p-4 border-b sticky top-0 bg-white rounded-t-lg">
              <h2 className="text-xl font-bold">
                {selectedEvent ? `Turno: ${selectedEvent.patient_name}` : 'Nuevo Turno'}
              </h2>
              <button onClick={() => { setShowModal(false); setCollisionWarning(null); setInsuranceStatus(null); }} className="text-gray-500 hover:text-gray-700">
                <X size={24} />
              </button>
            </div>

            {/* Collision Warning */}
            {collisionWarning?.hasCollision && (
              <div className="m-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                <div className="flex items-center gap-2 mb-1">
                  <AlertCircle className="text-red-600" size={18} />
                  <span className="text-sm font-medium text-red-800">Conflicto de horario</span>
                </div>
                <p className="text-sm text-red-700">{collisionWarning.message}</p>
              </div>
            )}

            {/* Insurance Status Warning */}
            {insuranceStatus && (insuranceStatus.status === 'warning' || insuranceStatus.status === 'expired' || insuranceStatus.requires_token) && (
              <div className="m-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                <div className="flex items-center gap-2 mb-1">
                  <AlertTriangle className="text-yellow-600" size={18} />
                  <span className="text-sm font-medium text-yellow-800">
                    {insuranceStatus.status === 'expired' ? 'Credencial Vencida' : 
                     insuranceStatus.status === 'warning' ? 'Credencial Pr√≥xima a Vencer' : 
                     'Validaci√≥n Requerida'}
                  </span>
                </div>
                <p className="text-sm text-yellow-700">{insuranceStatus.message}</p>
                {insuranceStatus.requires_token && (
                  <p className="text-xs text-yellow-600 mt-1">‚ö†Ô∏è Requiere validaci√≥n de Token OSDE</p>
                )}
              </div>
            )}

            {selectedEvent ? (
              // View/Edit existing appointment
              <div className="p-4">
                {/* Source Badge */}
                <div className="mb-4">
                  <span className={`inline-flex px-3 py-1 rounded-full text-sm ${
                    SOURCE_COLORS[selectedEvent.source || 'ai']?.bgClass || 'bg-blue-100'
                  } ${SOURCE_COLORS[selectedEvent.source || 'ai']?.textClass || 'text-blue-800'}`}>
                    Origen: {getSourceLabel(selectedEvent.source)}
                  </span>
                </div>

                <div className="grid grid-cols-2 gap-4 mb-4">
                  <div className="flex items-center gap-2">
                    <User className="text-gray-400" size={20} />
                    <div>
                      <p className="text-xs text-gray-500">Paciente</p>
                      <span className="font-medium">{selectedEvent.patient_name}</span>
                    </div>
                  </div>
                  <div className="flex items-center gap-2">
                    <Phone className="text-gray-400" size={20} />
                    <div>
                      <p className="text-xs text-gray-500">Tel√©fono</p>
                      <span className="font-medium">{selectedEvent.patient_phone || 'No disponible'}</span>
                    </div>
                  </div>
                  <div className="flex items-center gap-2">
                    <Stethoscope className="text-gray-400" size={20} />
                    <div>
                      <p className="text-xs text-gray-500">Profesional</p>
                      <span className="font-medium">Dr. {selectedEvent.professional_name}</span>
                    </div>
                  </div>
                  <div className="flex items-center gap-2">
                    <Clock className="text-gray-400" size={20} />
                    <div>
                      <p className="text-xs text-gray-500">Fecha y Hora</p>
                      <span className="font-medium">
                        {new Date(selectedEvent.appointment_datetime).toLocaleString()}
                      </span>
                    </div>
                  </div>
                </div>

                <div className="flex items-center gap-2 mb-4 p-3 bg-gray-50 rounded-lg">
                  <Calendar className="text-gray-400" size={20} />
                  <div>
                    <p className="text-xs text-gray-500">Tipo de Turno</p>
                    <span className="font-medium capitalize">{selectedEvent.appointment_type}</span>
                  </div>
                </div>

                {selectedEvent.notes && (
                  <div className="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <div className="flex items-center gap-2 mb-1">
                      <MessageCircle className="text-yellow-600" size={16} />
                      <span className="text-sm font-medium text-yellow-800">Notas</span>
                    </div>
                    <p className="text-sm text-yellow-700">{selectedEvent.notes}</p>
                  </div>
                )}

                {/* Status Badge */}
                <div className="mb-4">
                  <p className="text-sm font-medium text-gray-700 mb-2">Estado Actual</p>
                  <div className={`inline-flex px-3 py-1 rounded-full text-sm capitalize ${
                    STATUS_UI_COLORS[selectedEvent.status]?.bg || STATUS_UI_COLORS.scheduled.bg
                  }`}>
                    {selectedEvent.status?.replace('_', ' ')}
                  </div>
                </div>

                <div className="border-t pt-4">
                  <p className="text-sm font-medium text-gray-700 mb-2">Cambiar Estado:</p>
                  <div className="flex flex-wrap gap-2">
                    {Object.entries(STATUS_UI_COLORS).map(([status, colors]) => (
                      <button
                        key={status}
                        onClick={() => handleStatusChange(status)}
                        className={`px-3 py-1 rounded-full text-sm capitalize border transition-all ${
                          selectedEvent.status === status 
                            ? `${colors.bg} ${colors.border} ring-2 ring-offset-2 ring-primary` 
                            : `${colors.bg} ${colors.border} hover:opacity-80`
                        }`}
                      >
                        {status.replace('_', ' ')}
                      </button>
                    ))}
                  </div>
                </div>

                <div className="flex justify-end gap-3 mt-6">
                  <button
                    onClick={handleDelete}
                    className="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 flex items-center gap-2"
                  >
                    <AlertTriangle size={18} />
                    Cancelar Turno
                  </button>
                  <button
                    onClick={() => { setShowModal(false); setCollisionWarning(null); setInsuranceStatus(null); }}
                    className="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200"
                  >
                    Cerrar
                  </button>
                </div>
              </div>
            ) : (
              // Create new appointment
              <form onSubmit={handleSubmit} className="p-4">
                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-1">Fecha y Hora</label>
                  <input
                    type="datetime-local"
                    required
                    value={formData.appointment_datetime}
                    onChange={(e) => handleDateTimeChange(e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                  />
                </div>

                <div className="grid grid-cols-2 gap-4 mb-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Paciente *</label>
                    <select
                      required
                      value={formData.patient_id}
                      onChange={(e) => {
                        setFormData({ ...formData, patient_id: e.target.value });
                        checkInsuranceStatus(e.target.value);
                      }}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                    >
                      <option value="">Seleccionar paciente</option>
                      {patients.map((patient) => (
                        <option key={patient.id} value={patient.id}>
                          {patient.first_name} {patient.last_name} ({patient.phone_number})
                        </option>
                      ))}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Profesional *</label>
                    <select
                      required
                      value={formData.professional_id}
                      onChange={(e) => handleProfessionalChange(e.target.value)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                    >
                      <option value="">Seleccionar profesional</option>
                      {professionals.map((prof) => (
                        <option key={prof.id} value={prof.id}>
                          Dr. {prof.first_name} {prof.last_name}
                        </option>
                      ))}
                    </select>
                  </div>
                </div>

                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-1">Tipo de Turno *</label>
                  <select
                    required
                    value={formData.appointment_type}
                    onChange={(e) => setFormData({ ...formData, appointment_type: e.target.value })}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                  >
                    <option value="checkup">Control/Checkup</option>
                    <option value="cleaning">Limpieza</option>
                    <option value="extraction">Extracci√≥n</option>
                    <option value="restoration">Restauraci√≥n</option>
                    <option value="orthodontics">Ortodoncia</option>
                    <option value="emergency">Urgencia</option>
                    <option value="consultation">Consulta</option>
                  </select>
                </div>

                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-1">Notas</label>
                  <textarea
                    value={formData.notes}
                    onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                    rows={3}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                    placeholder="Observaciones del turno..."
                  />
                </div>

                {/* Source indicator for new appointment */}
                <div className="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                  <div className="flex items-center gap-2">
                    <CheckCircle className="text-green-600" size={18} />
                    <span className="text-sm font-medium text-green-800">Turno Manual</span>
                  </div>
                  <p className="text-xs text-green-700 mt-1">
                    Este turno ser√° marcado como creado manualmente (verde)
                  </p>
                </div>

                <div className="flex justify-end gap-3">
                  <button
                    type="button"
                    onClick={() => { setShowModal(false); setCollisionWarning(null); }}
                    className="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200"
                  >
                    Cancelar
                  </button>
                  <button
                    type="submit"
                    className={`px-4 py-2 text-white rounded-lg hover:flex items-center gap-2 ${
                      collisionWarning?.hasCollision 
                        ? 'bg-yellow-600 hover:bg-yellow-700'
                        : 'bg-primary hover:bg-primary-dark'
                    }`}
                  >
                    <Calendar size={18} />
                    {collisionWarning?.hasCollision ? 'Agendar Igualmente' : 'Agendar Turno'}
                  </button>
                </div>
              </form>
            )}
          </div>
        </div>
      )}
    </div>
  );
}
````

## File: frontend_react/src/views/ChatsView.tsx
````typescript
import { useState, useEffect, useRef, useCallback } from 'react';
import {
  MessageCircle, Send, Phone, Calendar, User, Activity,
  Pause, Play, AlertCircle, Clock, ChevronLeft, MoreVertical,
  Search, CheckCircle, XCircle, Bell, Volume2, VolumeX
} from 'lucide-react';
import api, { BACKEND_URL } from '../api/axios';
import { io, Socket } from 'socket.io-client';

// ============================================
// INTERFACES
// ============================================

interface ChatSession {
  phone_number: string;
  patient_id?: number;
  patient_name?: string;
  last_message: string;
  last_message_time: string;
  unread_count: number;
  status: 'active' | 'human_handling' | 'paused' | 'silenced';
  human_override_until?: string;
  urgency_level?: 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';
  last_derivhumano_at?: string;
  is_window_open?: boolean;
  last_user_message_time?: string;
}

interface ChatMessage {
  id: number;
  from_number: string;
  role: 'user' | 'assistant' | 'system';
  content: string;
  created_at: string;
  is_derivhumano?: boolean;
}

interface PatientContext {
  patient_id?: number;
  patient_name?: string;
  last_appointment?: {
    date: string;
    type: string;
    professional: string;
  };
  upcoming_appointment?: {
    date: string;
    type: string;
    professional: string;
  };
  treatment_plan?: string;
  last_appointment_type?: string;
}

interface Toast {
  id: string;
  type: 'info' | 'warning' | 'error' | 'success';
  title: string;
  message: string;
}

// ============================================

export default function ChatsView() {
  // Estados principales
  const [sessions, setSessions] = useState<ChatSession[]>([]);
  const [selectedSession, setSelectedSession] = useState<ChatSession | null>(null);
  const [messages, setMessages] = useState<ChatMessage[]>([]);
  const [patientContext, setPatientContext] = useState<PatientContext | null>(null);
  const [loading, setLoading] = useState(true);
  const [sending, setSending] = useState(false);
  const [newMessage, setNewMessage] = useState('');
  const [searchTerm, setSearchTerm] = useState('');

  // Estados de UI
  const [soundEnabled, setSoundEnabled] = useState(true);
  const [showToast, setShowToast] = useState<Toast | null>(null);
  const [highlightedSession, setHighlightedSession] = useState<string | null>(null);

  // Refs
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const socketRef = useRef<Socket | null>(null);
  const audioRef = useRef<HTMLAudioElement | null>(null);

  // ============================================
  // WEBSOCKET - CONEXI√ìN EN TIEMPO REAL
  // ============================================

  useEffect(() => {
    // Conectar al WebSocket
    socketRef.current = io(BACKEND_URL);

    // Evento: Nueva derivaci√≥n humana (derivhumano)
    socketRef.current.on('HUMAN_HANDOFF', (data: { phone_number: string; reason: string }) => {
      setSessions(prev => prev.map(s =>
        s.phone_number === data.phone_number
          ? {
            ...s,
            status: 'human_handling' as const,
            human_override_until: new Date(Date.now() + 86400000).toISOString(),
            last_derivhumano_at: new Date().toISOString()
          }
          : s
      ));

      // Resaltar el chat en la lista
      setHighlightedSession(data.phone_number);
      setTimeout(() => setHighlightedSession(null), 5000);

      // Mostrar toast
      setShowToast({
        id: Date.now().toString(),
        type: 'warning',
        title: 'üîî Derivaci√≥n Humana',
        message: `El bot deriv√≥ a ${data.phone_number}: ${data.reason}`,
      });

      // Reproducir sonido
      if (soundEnabled) {
        playNotificationSound();
      }
    });

    // Evento: Nuevo mensaje en chat
    socketRef.current.on('NEW_MESSAGE', (data: { phone_number: string; message: string; role: string }) => {
      setSessions(prev => {
        const updatedSessions = prev.map(s =>
          s.phone_number === data.phone_number
            ? {
              ...s,
              last_message: data.message,
              last_message_time: new Date().toISOString(),
              unread_count: s.phone_number === selectedSession?.phone_number ? 0 : s.unread_count + 1,
              is_window_open: data.role === 'user' ? true : s.is_window_open
            }
            : s
        );

        // Re-ordenar: √∫ltimo mensaje arriba
        const sortedSessions = [...updatedSessions].sort((a, b) => {
          const timeA = new Date(a.last_message_time || 0).getTime();
          const timeB = new Date(b.last_message_time || 0).getTime();
          return timeB - timeA;
        });

        // Si la sesi√≥n seleccionada recibi√≥ un mensaje, actualizarla para refrescar la UI (banner/input)
        if (data.phone_number === selectedSession?.phone_number) {
          const current = sortedSessions.find(s => s.phone_number === data.phone_number);
          if (current) {
            setSelectedSession(current);
          }
        }

        return sortedSessions;
      });

      // Si es del chat seleccionado, agregar mensaje si no existe
      if (data.phone_number === selectedSession?.phone_number) {
        setMessages(prev => {
          // Evitar duplicados (chequeo simple por contenido y timestamp reciente o id si viniera)
          const isDuplicate = prev.some(m =>
            m.role === data.role &&
            m.content === data.message &&
            new Date(m.created_at).getTime() > Date.now() - 5000
          );

          if (isDuplicate) return prev;

          return [...prev, {
            id: Date.now(), // ID temporal
            role: data.role as 'user' | 'assistant' | 'system',
            content: data.message,
            created_at: new Date().toISOString(),
            from_number: data.phone_number
          }];
        });
      }
    });

    // Evento: Estado de override cambiado
    socketRef.current.on('HUMAN_OVERRIDE_CHANGED', (data: { phone_number: string; enabled: boolean; until?: string }) => {
      setSessions(prev => {
        const updated = prev.map(s =>
          s.phone_number === data.phone_number
            ? {
              ...s,
              status: data.enabled ? 'silenced' as const : 'active' as const,
              human_override_until: data.until
            }
            : s
        );

        // Sincronizar selectedSession si es el actual
        if (selectedSession?.phone_number === data.phone_number) {
          const current = updated.find(s => s.phone_number === data.phone_number);
          if (current) setSelectedSession(current);
        }

        return updated;
      });
    });

    // Evento: Chat seleccionado actualizado (para sincronizaci√≥n)
    socketRef.current.on('CHAT_UPDATED', (data: Partial<ChatSession> & { phone_number: string }) => {
      setSessions(prev => {
        const updated = prev.map(s =>
          s.phone_number === data.phone_number ? { ...s, ...data } : s
        );

        // Sincronizar selectedSession si es el actual
        if (selectedSession?.phone_number === data.phone_number) {
          const current = updated.find(s => s.phone_number === data.phone_number);
          if (current) setSelectedSession(current);
        }

        return updated;
      });
    });

    // Cleanup
    return () => {
      if (socketRef.current) {
        socketRef.current.disconnect();
      }
    };
  }, [selectedSession, soundEnabled]);

  // ============================================
  // DATOS - CARGAR SESIONES Y MENSAJES
  // ============================================

  useEffect(() => {
    fetchSessions();
  }, []);

  useEffect(() => {
    if (selectedSession) {
      fetchMessages(selectedSession.phone_number);
      fetchPatientContext(selectedSession.phone_number);
      // Marcar como le√≠do
      markAsRead(selectedSession.phone_number);
    }
  }, [selectedSession]);

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  // ============================================
  // FUNCIONES DE DATOS
  // ============================================

  const fetchSessions = async () => {
    try {
      setLoading(true);
      const response = await api.get('/admin/chat/sessions');
      setSessions(response.data);

      // Deep Link Logic: Si venimos de notificaci√≥n
      const state = location.state as { selectPhone?: string } | null;
      if (state?.selectPhone) {
        const targetPhone = state.selectPhone;
        const targetSession = response.data.find((s: ChatSession) => s.phone_number === targetPhone);
        if (targetSession) {
          setSelectedSession(targetSession);
          // Limpiar state para evitar re-selecci√≥n futura
          window.history.replaceState({}, document.title);
        }
      }

    } catch (error) {
      console.error('Error fetching sessions:', error);
      setSessions([]);
      setShowToast({
        id: Date.now().toString(),
        type: 'error',
        title: 'Error de Conexi√≥n',
        message: 'No se pudieron cargar las conversaciones. Verific√° la conexi√≥n con el servidor.',
      });
    } finally {
      setLoading(false);
    }
  };

  const fetchMessages = async (phone: string) => {
    try {
      const response = await api.get(`/admin/chat/messages/${phone}`);
      setMessages(response.data);
    } catch (error) {
      console.error('Error fetching messages:', error);
      setMessages([]);
    }
  };

  const fetchPatientContext = async (phone: string) => {
    try {
      const response = await api.get(`/admin/patients/phone/${phone}/context`);
      setPatientContext(response.data);
    } catch (error) {
      console.error('Error fetching patient context:', error);
      setPatientContext(null);
    }
  };

  const markAsRead = async (phone: string) => {
    try {
      await api.put(`/admin/chat/sessions/${phone}/read`);
      setSessions(prev => prev.map(s =>
        s.phone_number === phone ? { ...s, unread_count: 0 } : s
      ));
    } catch (error) {
      console.error('Error marking as read:', error);
    }
  };

  // ============================================
  // ACCIONES
  // ============================================

  const handleSendMessage = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!newMessage.trim() || !selectedSession) return;

    setSending(true);
    try {
      await api.post('/admin/chat/send', {
        phone: selectedSession.phone_number,
        message: newMessage,
      });
      setNewMessage('');
      fetchMessages(selectedSession.phone_number);

      // Emitir evento de mensaje manual
      socketRef.current?.emit('MANUAL_MESSAGE', {
        phone: selectedSession.phone_number,
        message: newMessage,
      });
    } catch (error) {
      console.error('Error sending message:', error);
    } finally {
      setSending(false);
    }
  };

  const handleToggleHumanMode = async () => {
    if (!selectedSession) return;

    const isCurrentlyHandled = selectedSession.status === 'human_handling' || selectedSession.status === 'silenced';
    const activate = !isCurrentlyHandled;

    try {
      await api.post('/admin/chat/human-intervention', {
        phone: selectedSession.phone_number,
        activate,
        duration: 24 * 60 * 60 * 1000, // 24 horas
      });

      // Actualizaci√≥n local inmediata para respuesta instant√°nea
      const until = activate ? new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString() : undefined;
      const updatedStatus = activate ? 'silenced' as const : 'active' as const;

      const updateFn = (s: ChatSession) => s.phone_number === selectedSession.phone_number
        ? { ...s, status: updatedStatus, human_override_until: until }
        : s;

      setSessions(prev => prev.map(updateFn));
      setSelectedSession(prev => prev ? updateFn(prev) : null);

      // El evento socket redundante HUMAN_OVERRIDE_TOGGLE ya es manejado por el backend emitiendo HUMAN_OVERRIDE_CHANGED
    } catch (error) {
      console.error('Error toggling human mode:', error);
    }
  };

  const handleRemoveSilence = async () => {
    if (!selectedSession || !selectedSession.human_override_until) return;

    try {
      await api.post('/admin/chat/remove-silence', {
        phone: selectedSession.phone_number,
      });

      // Actualizaci√≥n local inmediata
      const updateFn = (s: ChatSession) => s.phone_number === selectedSession.phone_number
        ? { ...s, status: 'active' as const, human_override_until: undefined, last_derivhumano_at: undefined }
        : s;

      setSessions(prev => prev.map(updateFn));
      setSelectedSession(prev => prev ? updateFn(prev) : null);
    } catch (error) {
      console.error('Error removing silence:', error);
    }
  };

  const playNotificationSound = () => {
    if (audioRef.current) {
      audioRef.current.play().catch(() => { });
    }
  };

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  // ============================================
  // UTILIDADES
  // ============================================

  const filteredSessions = sessions.filter(session =>
    session.patient_name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
    session.phone_number.includes(searchTerm)
  );

  const formatTime = (dateStr: string) => {
    const date = new Date(dateStr);
    const now = new Date();
    const diff = now.getTime() - date.getTime();

    if (diff < 60000) return 'Ahora';
    if (diff < 3600000) return `${Math.floor(diff / 60000)}m`;
    if (diff < 86400000) return `${Math.floor(diff / 3600000)}h`;
    return date.toLocaleDateString();
  };

  const getStatusConfig = (session: ChatSession) => {
    if (session.status === 'human_handling' || session.status === 'silenced') {
      return {
        badge: (
          <span className="flex items-center gap-1 text-xs font-medium">
            {session.status === 'silenced' ? (
              <VolumeX size={12} className="text-red-500" />
            ) : (
              <User size={12} className="text-orange-500" />
            )}
            {session.status === 'silenced' ? 'Silenciado' : 'Manual'}
          </span>
        ),
        avatarBg: session.urgency_level === 'HIGH' || session.urgency_level === 'CRITICAL'
          ? 'bg-red-500 animate-pulse'
          : 'bg-orange-500',
        cardBorder: session.last_derivhumano_at ? 'border-l-4 border-orange-500' : '',
      };
    }
    return {
      badge: (
        <span className="flex items-center gap-1 text-xs text-green-600">
          <Activity size={12} /> IA Activa
        </span>
      ),
      avatarBg: 'bg-primary',
      cardBorder: '',
    };
  };

  const getUrgencyBadge = (level?: string) => {
    if (!level) return null;

    const colors = {
      LOW: 'bg-green-100 text-green-800',
      MEDIUM: 'bg-yellow-100 text-yellow-800',
      HIGH: 'bg-orange-100 text-orange-800',
      CRITICAL: 'bg-red-100 text-red-800',
    };

    return (
      <span className={`text-xs px-2 py-0.5 rounded-full ${colors[level as keyof typeof colors]}`}>
        {level}
      </span>
    );
  };

  // ============================================
  // RENDER
  // ============================================

  return (
    <div className="h-[calc(100vh-100px)] flex relative">
      {/* Audio para notificaciones */}
      <audio ref={audioRef} src="/notification.mp3" preload="auto" />

      {/* ======================================== */}
      {/* TOAST DE DERIVACI√ìN HUMANA */}
      {/* ======================================== */}
      {showToast && (
        <div className="fixed top-4 right-4 z-50 animate-slide-in">
          <div className="bg-orange-500 text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-3">
            <Bell className="w-5 h-5" />
            <div>
              <p className="font-semibold">{showToast.title}</p>
              <p className="text-sm opacity-90">{showToast.message}</p>
            </div>
            <button
              onClick={() => setShowToast(null)}
              className="ml-4 hover:opacity-80"
            >
              <XCircle size={18} />
            </button>
          </div>
        </div>
      )}

      {/* Chat List */}
      <div className="w-80 border-r bg-white flex flex-col">
        <div className="p-4 border-b">
          <div className="flex justify-between items-center mb-3">
            <h2 className="text-lg font-bold">Conversaciones</h2>
            <button
              onClick={() => setSoundEnabled(!soundEnabled)}
              className="p-2 rounded-lg hover:bg-gray-100"
              title={soundEnabled ? 'Silenciar notificaciones' : 'Activar sonido'}
            >
              {soundEnabled ? <Volume2 size={18} /> : <VolumeX size={18} />}
            </button>
          </div>
          <div className="relative">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={16} />
            <input
              type="text"
              placeholder="Buscar por nombre o tel√©fono..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full pl-9 pr-4 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary"
            />
          </div>
        </div>

        <div className="flex-1 overflow-y-auto">
          {loading ? (
            <div className="p-4 text-center text-gray-500">Cargando...</div>
          ) : filteredSessions.length === 0 ? (
            <div className="p-4 text-center text-gray-500">No hay conversaciones</div>
          ) : (
            filteredSessions.map(session => {
              const { badge, avatarBg, cardBorder } = getStatusConfig(session);
              const isHighlighted = highlightedSession === session.phone_number;

              return (
                <div
                  key={session.phone_number}
                  onClick={() => setSelectedSession(session)}
                  className={`p-4 border-b cursor-pointer transition-all ${selectedSession?.phone_number === session.phone_number
                    ? 'bg-primary-light'
                    : 'hover:bg-gray-50'
                    } ${isHighlighted ? 'bg-orange-50 animate-pulse' : ''} ${cardBorder}`}
                >
                  <div className="flex items-start gap-3">
                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white font-medium ${avatarBg}`}>
                      {(session.patient_name || session.phone_number).charAt(0)}
                    </div>
                    <div className="flex-1 min-w-0">
                      <div className="flex justify-between items-start">
                        <div className="flex items-center gap-2">
                          <span className="font-medium truncate">
                            {session.patient_name || 'Sin nombre'}
                          </span>
                          {getUrgencyBadge(session.urgency_level)}
                        </div>
                        <span className="text-xs text-gray-400">{formatTime(session.last_message_time)}</span>
                      </div>
                      <p className="text-sm text-gray-500 truncate">{session.last_message}</p>
                      {badge}
                    </div>
                    {session.unread_count > 0 && (
                      <span className="bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">
                        {session.unread_count}
                      </span>
                    )}
                    {session.last_derivhumano_at && (
                      <div className="absolute right-4 top-1/2 -translate-y-1/2">
                        <AlertCircle size={16} className="text-orange-500" />
                      </div>
                    )}
                  </div>
                </div>
              );
            })
          )}
        </div>
      </div>

      {/* Chat Detail */}
      {selectedSession ? (
        <>
          {/* Messages */}
          <div className="flex-1 flex flex-col">
            {/* Header */}
            <div className="p-4 border-b bg-white flex justify-between items-center">
              <div className="flex items-center gap-3">
                <button
                  onClick={() => setSelectedSession(null)}
                  className="lg:hidden p-2 hover:bg-gray-100 rounded"
                >
                  <ChevronLeft size={20} />
                </button>
                <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white font-medium ${selectedSession.status === 'human_handling' || selectedSession.status === 'silenced'
                  ? 'bg-orange-500'
                  : 'bg-primary'
                  }`}>
                  {(selectedSession.patient_name || selectedSession.phone_number).charAt(0)}
                </div>
                <div>
                  <h3 className="font-medium">{selectedSession.patient_name || 'Sin nombre'}</h3>
                  <p className="text-sm text-gray-500">{selectedSession.phone_number}</p>
                </div>
              </div>

              <div className="flex items-center gap-2">
                {/* Mostrar estado de silencio override */}
                {selectedSession.human_override_until && (
                  <div className="flex items-center gap-2 px-3 py-1 bg-red-50 text-red-700 rounded-lg text-sm">
                    <VolumeX size={14} />
                    <span>
                      Silenciado hasta {new Date(selectedSession.human_override_until).toLocaleTimeString()}
                    </span>
                  </div>
                )}

                {/* Bot√≥n de control */}
                <button
                  onClick={handleToggleHumanMode}
                  className={`flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${selectedSession.status === 'human_handling' || selectedSession.status === 'silenced'
                    ? 'bg-green-100 text-green-700 hover:bg-green-200'
                    : 'bg-orange-100 text-orange-700 hover:bg-orange-200'
                    }`}
                >
                  {selectedSession.status === 'human_handling' || selectedSession.status === 'silenced' ? (
                    <><Play size={16} /> Activar IA</>
                  ) : (
                    <><Pause size={16} /> Modo Manual</>
                  )}
                </button>
              </div>
            </div>

            {/* Alert Banner para derivhumano */}
            {selectedSession.last_derivhumano_at ? (
              <div className="bg-orange-50 border-b border-orange-200 px-4 py-2 flex items-center gap-2">
                <AlertCircle size={16} className="text-orange-500" />
                <span className="text-sm text-orange-700">
                  ‚ö†Ô∏è Derivaci√≥n Autom√°tica: El bot deriv√≥ este chat a las {new Date(selectedSession.last_derivhumano_at).toLocaleTimeString()}
                </span>
                <button
                  onClick={handleRemoveSilence}
                  className="ml-auto text-xs text-orange-600 hover:underline"
                >
                  Quitar silencio
                </button>
              </div>
            ) : (selectedSession.status === 'silenced' || selectedSession.status === 'human_handling') && (
              <div className="bg-blue-50 border-b border-blue-200 px-4 py-2 flex items-center gap-2">
                <Pause size={16} className="text-blue-500" />
                <span className="text-sm text-blue-700">
                  ‚úã Modo Manual Activo. El asistente no responder√°.
                </span>
                <button
                  onClick={handleToggleHumanMode}
                  className="ml-auto text-xs text-blue-600 hover:underline"
                >
                  Activar IA
                </button>
              </div>
            )}

            {/* Banner de Ventana de 24hs Cerrada */}
            {selectedSession.is_window_open === false && (
              <div className="bg-yellow-50 border-b border-yellow-200 px-4 py-2 flex items-center gap-2">
                <Clock size={16} className="text-yellow-600" />
                <span className="text-sm text-yellow-700">
                  ‚è≥ <strong>Ventana de 24hs cerrada:</strong> No puedes enviar mensajes manuales hasta que el paciente te escriba de nuevo.
                </span>
              </div>
            )}

            {/* Messages Area */}
            <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
              {messages.map((message) => (
                <div
                  key={message.id}
                  className={`flex ${message.role === 'user' ? 'justify-start' : 'justify-end'}`}
                >
                  <div
                    className={`max-w-[70%] rounded-lg px-4 py-3 ${message.role === 'user'
                      ? 'bg-white shadow-sm'
                      : message.is_derivhumano
                        ? 'bg-orange-100 border border-orange-300 shadow-sm text-gray-800'
                        : 'bg-blue-600 text-white shadow-sm'
                      }`}
                  >
                    {message.is_derivhumano && (
                      <div className="flex items-center gap-1 text-xs text-orange-600 mb-1">
                        <User size={12} />
                        <span className="font-medium">Derivaci√≥n autom√°tica</span>
                      </div>
                    )}
                    <p className="text-sm">{message.content}</p>
                    <p className={`text-xs mt-1 ${message.role === 'user' ? 'text-gray-400' : 'text-blue-200'
                      }`}>
                      {new Date(message.created_at).toLocaleTimeString()}
                    </p>
                  </div>
                </div>
              ))}
              <div ref={messagesEndRef} />
            </div>

            {/* Input */}
            <form onSubmit={handleSendMessage} className="p-4 border-t bg-white">
              <div className="flex gap-2">
                <input
                  type="text"
                  value={newMessage}
                  onChange={(e) => setNewMessage(e.target.value)}
                  placeholder={selectedSession.is_window_open === false ? "Ventana cerrada - Esperando paciente..." : "Escribe un mensaje..."}
                  disabled={selectedSession.is_window_open === false}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                      e.preventDefault();
                      handleSendMessage(e as any);
                    }
                  }}
                  className={`flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-medical-500 bg-white text-gray-900 ${selectedSession.is_window_open === false ? 'bg-gray-100 cursor-not-allowed opacity-75' : ''}`}
                />
                <button
                  type="submit"
                  disabled={sending || !newMessage.trim() || selectedSession.is_window_open === false}
                  className="p-2 bg-medical-600 text-white rounded-lg hover:bg-medical-700 disabled:opacity-50 flex items-center justify-center transition-colors min-w-[44px]"
                  title={selectedSession.is_window_open === false ? "Ventana de 24hs cerrada" : "Enviar mensaje"}
                >
                  <Send size={20} />
                </button>
              </div>
            </form>
          </div>

          {/* Clinical Context Panel */}
          <div className="w-80 border-l bg-white overflow-y-auto">
            <div className="p-4 border-b">
              <h3 className="font-medium flex items-center gap-2">
                <Activity size={18} className="text-primary" />
                Contexto Cl√≠nico
              </h3>
            </div>

            <div className="p-4 space-y-4">
              {/* AI Status */}
              <div className={`p-3 rounded-lg ${selectedSession.status === 'human_handling' || selectedSession.status === 'silenced'
                ? 'bg-orange-50 border border-orange-200'
                : 'bg-green-50 border border-green-200'
                }`}>
                <div className="flex items-center gap-2 mb-1">
                  {selectedSession.status === 'human_handling' || selectedSession.status === 'silenced' ? (
                    <User size={16} className="text-orange-600" />
                  ) : (
                    <Activity size={16} className="text-green-600" />
                  )}
                  <span className="font-medium text-sm">
                    Estado del Bot
                  </span>
                </div>
                <p className="text-sm text-gray-600">
                  {selectedSession.status === 'human_handling'
                    ? 'Atendido por persona'
                    : selectedSession.status === 'silenced'
                      ? 'Silenciado (24h override)'
                      : 'IA activa'}
                </p>
                {selectedSession.human_override_until && (
                  <p className="text-xs text-gray-500 mt-1">
                    Hasta: {new Date(selectedSession.human_override_until).toLocaleString()}
                  </p>
                )}
              </div>

              {/* Patient Info */}
              <div className="p-3 bg-gray-50 rounded-lg">
                <h4 className="text-xs font-medium text-gray-500 mb-2">PACIENTE</h4>
                <p className="font-medium">{patientContext?.patient_name || selectedSession.patient_name}</p>
                <p className="text-sm text-gray-500">{selectedSession.phone_number}</p>
              </div>

              {/* Last Appointment */}
              <div className="p-3 bg-gray-50 rounded-lg">
                <h4 className="text-xs font-medium text-gray-500 mb-2 flex items-center gap-1">
                  <Calendar size={12} /> √öLTIMA CITA
                </h4>
                {patientContext?.last_appointment ? (
                  <div>
                    <p className="text-sm">{patientContext.last_appointment.type}</p>
                    <p className="text-xs text-gray-500">
                      {new Date(patientContext.last_appointment.date).toLocaleDateString()}
                    </p>
                    <p className="text-xs text-gray-400">
                      Dr. {patientContext.last_appointment.professional}
                    </p>
                  </div>
                ) : (
                  <p className="text-sm text-gray-400">Sin citas previas</p>
                )}
              </div>

              {/* Upcoming Appointment */}
              <div className="p-3 bg-gray-50 rounded-lg">
                <h4 className="text-xs font-medium text-gray-500 mb-2 flex items-center gap-1">
                  <Clock size={12} /> PR√ìXIMA CITA
                </h4>
                {patientContext?.upcoming_appointment ? (
                  <div>
                    <p className="text-sm">{patientContext.upcoming_appointment.type}</p>
                    <p className="text-xs text-primary">
                      {new Date(patientContext.upcoming_appointment.date).toLocaleDateString()}
                    </p>
                    <p className="text-xs text-gray-400">
                      Dr. {patientContext.upcoming_appointment.professional}
                    </p>
                  </div>
                ) : (
                  <p className="text-sm text-gray-400">Sin citas programadas</p>
                )}
              </div>

              {/* Treatment Plan */}
              <div className="p-3 bg-gray-50 rounded-lg">
                <h4 className="text-xs font-medium text-gray-500 mb-2">TRATAMIENTO ACTUAL</h4>
                {patientContext?.treatment_plan ? (
                  <p className="text-sm">{patientContext.treatment_plan}</p>
                ) : (
                  <p className="text-sm text-gray-400">Sin plan de tratamiento</p>
                )}
              </div>
            </div>
          </div>
        </>
      ) : (
        <div className="flex-1 flex items-center justify-center bg-gray-50">
          <div className="text-center text-gray-400">
            <MessageCircle size={64} className="mx-auto mb-4 opacity-50" />
            <p className="text-lg">Selecciona una conversaci√≥n</p>
            <p className="text-sm mt-1">para ver los mensajes</p>
          </div>
        </div>
      )}

      {/* ======================================== */}
      {/* CSS for animations */}
      {/* ======================================== */}
      <style>{`
        @keyframes slide-in {
          from {
            transform: translateX(100%);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }
        
        .animate-slide-in {
          animation: slide-in 0.3s ease-out;
        }
      `}</style>
    </div>
  );
}
````

## File: frontend_react/src/views/Credentials.tsx
````typescript
import React, { useEffect, useState } from 'react';
import { useApi } from '../hooks/useApi';
import { Modal } from '../components/Modal';
import { Key, Globe, Store, Trash2, Edit2, Plus } from 'lucide-react';

interface Credential {
    id?: number;
    name: string;
    value: string;
    category: string;
    description: string;
    scope: 'global' | 'tenant';
    tenant_id?: number | null;
}

interface Tenant {
    id: number;
    store_name: string;
}

export const Credentials: React.FC = () => {
    const { fetchApi, loading } = useApi();
    const [credentials, setCredentials] = useState<Credential[]>([]);
    const [tenants, setTenants] = useState<Tenant[]>([]);
    const [deploymentConfig, setDeploymentConfig] = useState<any>(null);
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [editingCred, setEditingCred] = useState<Credential | null>(null);

    // Form State
    const [formData, setFormData] = useState<Credential>({
        name: '',
        value: '',
        category: 'openai',
        description: '',
        scope: 'global',
        tenant_id: null
    });

    const loadData = async () => {
        try {
            const [credsData, tenantsData, deployData] = await Promise.all([
                fetchApi('/admin/credentials'),
                fetchApi('/admin/tenants'),
                fetchApi('/admin/config/deployment')
            ]);
            setCredentials(credsData);
            setTenants(tenantsData);
            setDeploymentConfig(deployData);
        } catch (e) {
            console.error(e);
        }
    };

    useEffect(() => {
        loadData();
    }, []);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        try {
            if (editingCred?.id) {
                // Update logic would go here if backend supported PUT /credentials/{id}
                // For now assuming the backend might only have POST/DELETE or I need to check admin_routes
                // Based on app.js, it seems we might just recreate or update.
                // Actually app.js didn't have explicit update for credentials, just create/delete?
                // Wait, editCredential in app.js fetches data but where does it save?
                // Ah, it populates the form which submits to /admin/credentials (POST).
                // So POST handles both create and update (upsert) or just create?
                // Logic in app.js: "const res = await adminFetch('/admin/credentials', 'POST', data);"
                // So it's a POST.
                await fetchApi('/admin/credentials', { method: 'POST', body: formData });
            } else {
                await fetchApi('/admin/credentials', { method: 'POST', body: formData });
            }
            setIsModalOpen(false);
            loadData();
        } catch (e) {
            alert('Error al guardar credencial: ' + e.message);
        }
    };

    const handleDelete = async (id: number) => {
        if (!confirm('¬øEliminar credencial?')) return;
        try {
            await fetchApi(`/admin/credentials/${id}`, { method: 'DELETE' });
            loadData();
        } catch (e) {
            alert('Error al eliminar: ' + e.message);
        }
    };

    const openEdit = (cred: Credential) => {
        setEditingCred(cred);
        setFormData(cred);
        setIsModalOpen(true);
    };

    const openNew = () => {
        setEditingCred(null);
        setFormData({
            name: '',
            value: '',
            category: 'openai',
            description: '',
            scope: 'global',
            tenant_id: null
        });
        setIsModalOpen(true);
    };

    return (
        <div className="view active">
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '30px' }}>
                <h1 className="view-title" style={{ margin: 0 }}>Gesti√≥n de Credenciales</h1>
                <button className="btn-primary" onClick={openNew}>
                    <Plus size={18} style={{ marginRight: '8px' }} />
                    Nueva Credencial
                </button>
            </div>

            {deploymentConfig && (
                <div className="glass" style={{ padding: '20px', marginBottom: '20px', borderLeft: '4px solid var(--accent)' }}>
                    <h3 style={{ marginBottom: '15px', display: 'flex', alignItems: 'center', gap: '10px' }}>
                        <Globe size={18} color="var(--accent)" /> Configuraci√≥n de Despliegue
                    </h3>
                    <div className="form-group">
                        <label>YCloud Webhook URL</label>
                        <div style={{ display: 'flex', gap: '10px' }}>
                            <input
                                readOnly
                                value={deploymentConfig.webhook_ycloud_url}
                                style={{ flex: 1, background: 'rgba(0,0,0,0.2)' }}
                            />
                            <button
                                className="btn-secondary"
                                onClick={() => {
                                    navigator.clipboard.writeText(deploymentConfig.webhook_ycloud_url);
                                    alert('URL copiada!');
                                }}
                            >
                                Copiar
                            </button>
                        </div>
                        <p style={{ fontSize: '11px', color: '#a1a1aa', marginTop: '5px' }}>
                            Peg√° esta URL en tu panel de YCloud para recibir mensajes. (Puerto interno: {deploymentConfig.webhook_ycloud_internal_port})
                        </p>
                    </div>
                </div>
            )}

            <div className="glass" style={{ padding: '20px' }}>
                <h3 style={{ borderBottom: '1px solid rgba(255,255,255,0.1)', paddingBottom: '10px', marginBottom: '20px', display: 'flex', alignItems: 'center', gap: '10px' }}>
                    <Globe size={18} color="var(--accent)" /> Globales (Heredadas)
                </h3>
                <div style={{ display: 'grid', gap: '10px', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))' }}>
                    {credentials.filter(c => c.scope === 'global').map(cred => (
                        <div key={cred.id} className="stat-card" style={{ padding: '15px', background: 'rgba(255,255,255,0.03)' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px' }}>
                                <span style={{ fontWeight: 600 }}>{cred.name}</span>
                                <span style={{ fontSize: '11px', background: 'rgba(255,255,255,0.1)', padding: '2px 8px', borderRadius: '10px' }}>{cred.category}</span>
                            </div>
                            <div style={{ fontSize: '12px', color: '#a1a1aa', marginBottom: '15px', fontFamily: 'monospace' }}>
                                ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢
                            </div>
                            <div style={{ display: 'flex', gap: '10px' }}>
                                <button className="btn-secondary" style={{ padding: '5px 10px', fontSize: '12px' }} onClick={() => openEdit(cred)}><Edit2 size={12} /></button>
                                <button className="btn-delete" style={{ padding: '5px 10px', fontSize: '12px' }} onClick={() => handleDelete(cred.id!)}><Trash2 size={12} /></button>
                            </div>
                        </div>
                    ))}
                </div>

                <h3 style={{ borderBottom: '1px solid rgba(255,255,255,0.1)', paddingBottom: '10px', marginBottom: '20px', marginTop: '40px', display: 'flex', alignItems: 'center', gap: '10px' }}>
                    <Store size={18} color="var(--success)" /> Espec√≠ficas por Tienda
                </h3>
                <div style={{ display: 'grid', gap: '10px', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))' }}>
                    {credentials.filter(c => c.scope === 'tenant').map(cred => (
                        <div key={cred.id} className="stat-card" style={{ padding: '15px', background: 'rgba(255,255,255,0.03)' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px' }}>
                                <span style={{ fontWeight: 600 }}>{cred.name}</span>
                                <span style={{ fontSize: '11px', background: 'rgba(0, 230, 118, 0.1)', color: 'var(--success)', padding: '2px 8px', borderRadius: '10px' }}>
                                    {tenants.find(t => t.id === cred.tenant_id)?.store_name || 'Tienda Desconocida'}
                                </span>
                            </div>
                            <div style={{ fontSize: '12px', color: '#a1a1aa', marginBottom: '15px', fontFamily: 'monospace' }}>
                                ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢
                            </div>
                            <div style={{ display: 'flex', gap: '10px' }}>
                                <button className="btn-secondary" style={{ padding: '5px 10px', fontSize: '12px' }} onClick={() => openEdit(cred)}><Edit2 size={12} /></button>
                                <button className="btn-delete" style={{ padding: '5px 10px', fontSize: '12px' }} onClick={() => handleDelete(cred.id!)}><Trash2 size={12} /></button>
                            </div>
                        </div>
                    ))}
                </div>
            </div>

            <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title={editingCred ? 'Editar Credencial' : 'Nueva Credencial'}>
                <form onSubmit={handleSubmit}>
                    <div className="form-group">
                        <label>Nombre Identificador</label>
                        <input
                            required
                            value={formData.name}
                            onChange={e => setFormData({ ...formData, name: e.target.value })}
                            placeholder="Ej: OpenAI Key Principal"
                        />
                    </div>
                    <div className="form-group">
                        <label>Valor (Token/Key)</label>
                        <input
                            required
                            type="password"
                            value={formData.value}
                            onChange={e => setFormData({ ...formData, value: e.target.value })}
                            placeholder="sk-..."
                        />
                    </div>
                    <div className="form-grid">
                        <div className="form-group">
                            <label>Categor√≠a</label>
                            <select
                                value={formData.category}
                                onChange={e => setFormData({ ...formData, category: e.target.value })}
                            >
                                <option value="openai">OpenAI</option>
                                <option value="whatsapp_cloud">WhatsApp Cloud API</option>
                                <option value="tiendanube">Tienda Nube</option>
                                <option value="database">Database</option>
                                <option value="other">Otro</option>
                            </select>
                        </div>
                        <div className="form-group">
                            <label>Alcance (Scope)</label>
                            <select
                                value={formData.scope}
                                onChange={e => setFormData({ ...formData, scope: e.target.value as 'global' | 'tenant' })}
                            >
                                <option value="global">Global (Todas las tiendas)</option>
                                <option value="tenant">Espec√≠fico por Tienda</option>
                            </select>
                        </div>
                    </div>

                    {formData.scope === 'tenant' && (
                        <div className="form-group">
                            <label>Asignar a Tienda</label>
                            <select
                                required
                                value={formData.tenant_id?.toString() || ''}
                                onChange={e => setFormData({ ...formData, tenant_id: parseInt(e.target.value) })}
                            >
                                <option value="">Seleccionar Tienda...</option>
                                {tenants.map(t => (
                                    <option key={t.id} value={t.id}>{t.store_name}</option>
                                ))}
                            </select>
                        </div>
                    )}

                    <div className="form-group">
                        <label>Descripci√≥n (Opcional)</label>
                        <textarea
                            value={formData.description}
                            onChange={e => setFormData({ ...formData, description: e.target.value })}
                            rows={3}
                        />
                    </div>

                    <div style={{ marginTop: '20px', display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                        <button type="button" className="btn-secondary" onClick={() => setIsModalOpen(false)}>Cancelar</button>
                        <button type="submit" className="btn-primary">Guardar Credencial</button>
                    </div>
                </form>
            </Modal>
        </div>
    );
};
````

## File: frontend_react/src/views/Dashboard.tsx
````typescript
import React, { useEffect, useState } from 'react';
import { useApi } from '../hooks/useApi';
import { Activity, Server, MessageSquare, Users } from 'lucide-react';

interface Stats {
    active_tenants: number;
    total_messages: number;
    processed_messages: number;
}

interface HealthCheck {
    name: string;
    status: 'OK' | 'FAIL' | 'WARN';
    details?: string;
}

interface HealthData {
    status: string;
    checks: HealthCheck[];
}

export const Dashboard: React.FC = () => {
    const { fetchApi, loading } = useApi();
    const [stats, setStats] = useState<Stats | null>(null);
    const [health, setHealth] = useState<HealthData | null>(null);
    const [lastSync, setLastSync] = useState<string>('Nunca');

    useEffect(() => {
        const loadData = async () => {
            try {
                const [statsData, healthData] = await Promise.all([
                    fetchApi('/admin/stats'),
                    fetchApi('/admin/diagnostics/healthz')
                ]);
                setStats(statsData);
                setHealth(healthData);
                setLastSync(new Date().toLocaleTimeString());
            } catch (e) {
                console.error(e);
            }
        };
        loadData();
        const interval = setInterval(loadData, 30000); // Refresh every 30s
        return () => clearInterval(interval);
    }, [fetchApi]);

    const getServiceStatus = (serviceName: string) => {
        const check = health?.checks?.find(c => c.name === serviceName);
        if (!check) return { color: 'var(--text-secondary)', status: 'UNKNOWN' };
        if (check.status === 'OK') return { color: 'var(--success)', status: 'OK' };
        if (check.status === 'FAIL') return { color: '#ff4d4d', status: 'FAIL' };
        return { color: '#ffc107', status: 'WARN' };
    };

    return (
        <div className="view active">
            <div className="top-bar" style={{ marginBottom: '20px' }}>
                <div className="health-strip">
                    {['orchestrator', 'whatsapp_service', 'database', 'redis'].map(svc => {
                        const { color, status } = getServiceStatus(svc);
                        return (
                            <div key={svc} className="service-pill" style={{ borderColor: color }}>
                                <div className="pill-dot" style={{ backgroundColor: color }}></div>
                                {svc.replace('_service', '')}: {status}
                            </div>
                        );
                    })}
                </div>
                <div className="last-signals">
                    <span className="signal-label">√öltima sinc: {lastSync}</span>
                </div>
            </div>

            <h1 className="view-title">Panel General</h1>

            <div className="stats-grid">
                <div className="stat-card glass accent">
                    <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                        <span className="stat-label">Tenants Activos</span>
                        <Users className="stat-icon" size={20} color="var(--accent)" />
                    </div>
                    <span className="stat-value">{stats?.active_tenants || 0}</span>
                    <span className="stat-meta">Tiendas conectadas</span>
                </div>

                <div className="stat-card glass">
                    <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                        <span className="stat-label">Total Mensajes</span>
                        <MessageSquare className="stat-icon" size={20} color="var(--text-secondary)" />
                    </div>
                    <span className="stat-value">{stats?.total_messages || 0}</span>
                    <span className="stat-meta">Procesados hoy</span>
                </div>

                <div className="stat-card glass">
                    <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                        <span className="stat-label">Tasa de √âxito</span>
                        <Activity className="stat-icon" size={20} color="var(--success)" />
                    </div>
                    <span className="stat-value">
                        {stats?.total_messages ? Math.round((stats.processed_messages / stats.total_messages) * 100) : 0}%
                    </span>
                    <span className="stat-meta">Respuestas generadas</span>
                </div>
            </div>
        </div>
    );
};
````

## File: frontend_react/src/views/DashboardView.tsx
````typescript
import { useEffect, useState, useRef, useCallback } from 'react';
import { io, Socket } from 'socket.io-client';
import { useNavigate } from 'react-router-dom';
import { 
  Activity, AlertTriangle, AlertCircle, CheckCircle, 
  XCircle, Pause, Play, Bell, BellOff, ShieldAlert,
  Users, Calendar, MessageSquare, TrendingUp, Clock, Plus
} from 'lucide-react';
import api, { BACKEND_URL } from '../api/axios';

// ============================================
// INTERFACES
// ============================================

interface TriageNotification {
  id: string;
  patient_id: number;
  patient_name: string;
  phone_number: string;
  urgency_level: 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';
  symptoms: string[];
  message_preview: string;
  timestamp: string;
  read: boolean;
}

interface DashboardStats {
  today_appointments: number;
  pending_confirmations: number;
  high_urgency_alerts: number;
  total_patients: number;
  messages_today: number;
  completed_today: number;
}

interface Toast {
  id: string;
  type: 'info' | 'warning' | 'error' | 'success';
  title: string;
  message: string;
  timestamp: Date;
}

interface TimeSlot {
  slot_start: string;
  slot_end: string;
  duration_minutes: number;
  professional_id: number;
  professional_name: string;
}

// ============================================

export default function DashboardView() {
  const navigate = useNavigate();
  
  // Estado de alertas de triaje
  const [notifications, setNotifications] = useState<TriageNotification[]>([]);
  const [unreadCount, setUnreadCount] = useState(0);
  
  // Estado de slots disponibles (Smart Availability Widget)
  const [availableSlots, setAvailableSlots] = useState<TimeSlot[]>([]);
  const [loadingSlots, setLoadingSlots] = useState(true);
  
  // Estado del bot
  const [botEnabled, setBotEnabled] = useState(true);
  const [botStatus, setBotStatus] = useState<'connected' | 'disconnected' | 'paused'>('connected');
  
  // Estado de estad√≠sticas
  const [stats, setStats] = useState<DashboardStats>({
    today_appointments: 0,
    pending_confirmations: 0,
    high_urgency_alerts: 0,
    total_patients: 0,
    messages_today: 0,
    completed_today: 0,
  });
  
  // Estado de toasts
  const [toasts, setToasts] = useState<Toast[]>([]);
  const [showToastContainer, setShowToastContainer] = useState(true);
  
  // Refs
  const socketRef = useRef<Socket | null>(null);
  const toastsRef = useRef<HTMLDivElement>(null);

  // ============================================
  // FUNCIONES DE TOAST
  // ============================================

  const addToast = useCallback((type: Toast['type'], title: string, message: string) => {
    const newToast: Toast = {
      id: Date.now().toString(),
      type,
      title,
      message,
      timestamp: new Date(),
    };
    setToasts(prev => [...prev, newToast]);
    
    // Auto-remove after 8 seconds
    setTimeout(() => {
      setToasts(prev => prev.filter(t => t.id !== newToast.id));
    }, 8000);
  }, []);

  const removeToast = useCallback((id: string) => {
    setToasts(prev => prev.filter(t => t.id !== id));
  }, []);

  const getToastStyles = (type: Toast['type']) => {
    switch (type) {
      case 'warning':
      case 'error':
        return 'bg-red-50 border-red-200 text-red-800';
      case 'success':
        return 'bg-green-50 border-green-200 text-green-800';
      default:
        return 'bg-blue-50 border-blue-200 text-blue-800';
    }
  };

  const getToastIcon = (type: Toast['type']) => {
    switch (type) {
      case 'warning':
        return <AlertTriangle className="w-5 h-5 text-red-500" />;
      case 'error':
        return <XCircle className="w-5 h-5 text-red-500" />;
      case 'success':
        return <CheckCircle className="w-5 h-5 text-green-500" />;
      default:
        return <Activity className="w-5 h-5 text-blue-500" />;
    }
  };

  // ============================================
  // WEBSOCKET - CONEXI√ìN DE TRIAGE
  // ============================================

  useEffect(() => {
    // Conectar al WebSocket
    socketRef.current = io(BACKEND_URL);
    
    // Evento: Nueva alerta de triaje de alta urgencia
    socketRef.current.on('HIGH_URGENCY_TRIAGE', (data: TriageNotification) => {
      setNotifications(prev => [data, ...prev]);
      setUnreadCount(prev => prev + 1);
      
      // Mostrar toast de urgencia alta
      addToast('warning', 'URGENCIA ALTA', `${data.patient_name}: ${data.symptoms.slice(0, 2).join(', ')}`);
      
      // Actualizar contador de alertas
      setStats(prev => ({ ...prev, high_urgency_alerts: prev.high_urgency_alerts + 1 }));
    });

    // Evento: Nueva alerta cr√≠tica
    socketRef.current.on('CRITICAL_TRIAGE', (data: TriageNotification) => {
      setNotifications(prev => [data, ...prev]);
      setUnreadCount(prev => prev + 1);
      
      // Mostrar toast cr√≠tico (m√°s persistente)
      addToast('error', 'CRITICO', `${data.patient_name} requiere atenci√≥n inmediata`);
      
      setStats(prev => ({ ...prev, high_urgency_alerts: prev.high_urgency_alerts + 1 }));
    });

    // Evento: Notificaci√≥n general
    socketRef.current.on('NEW_APPOINTMENT', (data: any) => {
      addToast('info', 'Nuevo Turno', `Turno programado para ${data.patient_name}`);
    });

    // Evento: Estado del bot actualizado
    socketRef.current.on('BOT_STATUS_CHANGED', (data: { enabled: boolean; status: string }) => {
      setBotEnabled(data.enabled);
      setBotStatus(data.status as 'connected' | 'disconnected' | 'paused');
      addToast(
        data.enabled ? 'success' : 'warning',
        data.enabled ? 'Bot Activado' : 'Bot Pausado',
        data.enabled ? 'El agente de IA puede responder mensajes' : 'El bot esta pausado manualmente'
      );
    });

    // Limpieza al desmontar
    return () => {
      if (socketRef.current) {
        socketRef.current.disconnect();
      }
    };
  }, [addToast]);

  // ============================================
  // DATOS - CARGAR ESTAD√çSTICAS
  // ============================================

  useEffect(() => {
    const fetchStats = async () => {
      try {
        const [statsRes, notificationsRes] = await Promise.all([
          api.get('/admin/dashboard/stats'),
          api.get('/admin/triage/notifications'),
        ]);
        
        if (statsRes.data) {
          setStats(prev => ({
            ...prev,
            ...statsRes.data,
            high_urgency_alerts: notificationsRes.data.filter((n: TriageNotification) => 
              n.urgency_level === 'HIGH' || n.urgency_level === 'CRITICAL'
            ).length,
          }));
        }
        
        if (notificationsRes.data) {
          setNotifications(notificationsRes.data);
          setUnreadCount(notificationsRes.data.filter((n: TriageNotification) => !n.read).length);
        }
      } catch (error) {
        console.error('Error fetching dashboard stats:', error);
        // Datos de prueba para desarrollo
        setStats({
          today_appointments: 12,
          pending_confirmations: 5,
          high_urgency_alerts: 2,
          total_patients: 156,
          messages_today: 47,
          completed_today: 8,
        });
      }
    };

    fetchStats();
    
    // Refresh cada 60 segundos
    const interval = setInterval(fetchStats, 60000);
    return () => clearInterval(interval);
  }, []);

  // ============================================
  // CONTROL DEL BOT
  // ============================================

  const toggleBot = async () => {
    const newState = !botEnabled;
    setBotEnabled(newState);
    
    try {
      await api.put('/admin/bot/toggle', { enabled: newState });
      setBotStatus(newState ? 'connected' : 'paused');
    } catch (error) {
      console.error('Error toggling bot:', error);
      // Revertir estado si falla
      setBotEnabled(!newState);
      addToast('error', 'Error', 'No se pudo cambiar el estado del bot');
    }
  };

  // ============================================
  // MARCAR NOTIFICACI√ìN COMO LE√çDA
  // ============================================

  const markAsRead = async (id: string) => {
    setNotifications(prev => 
      prev.map(n => n.id === id ? { ...n, read: true } : n)
    );
    setUnreadCount(prev => Math.max(0, prev - 1));
    
    try {
      await api.put(`/admin/triage/notifications/${id}/read`);
    } catch (error) {
      console.error('Error marking notification as read:', error);
    }
  };

  // ============================================
  // SMART AVAILABILITY WIDGET
  // ============================================

  const fetchAvailableSlots = useCallback(async () => {
    try {
      setLoadingSlots(true);
      const response = await api.get('/admin/appointments/next-slots', {
        params: { days_ahead: 3, slot_duration_minutes: 20 }
      });
      setAvailableSlots(response.data || []);
    } catch (error) {
      console.error('Error fetching available slots:', error);
      setAvailableSlots([]);
    } finally {
      setLoadingSlots(false);
    }
  }, []);

  useEffect(() => {
    fetchAvailableSlots();
    
    // Refresh slots every 2 minutes
    const interval = setInterval(fetchAvailableSlots, 120000);
    return () => clearInterval(interval);
  }, [fetchAvailableSlots]);

  const handleForceOverturn = () => {
    // Navigate to agenda with quick edit mode
    navigate('/agenda?mode=quick-edit&urgency=high');
  };

  const formatSlotTime = (slotStart: string) => {
    const date = new Date(slotStart);
    return date.toLocaleTimeString('es-AR', { 
      hour: '2-digit', 
      minute: '2-digit',
      weekday: 'short'
    });
  };

  const getRelativeTime = (slotStart: string) => {
    const date = new Date(slotStart);
    const now = new Date();
    const diffMs = date.getTime() - now.getTime();
    const diffMins = Math.round(diffMs / 60000);
    
    if (diffMins < 0) {
      return 'Pasado';
    } else if (diffMins < 60) {
      return `En ${diffMins} min`;
    } else if (diffMins < 1440) {
      const hours = Math.floor(diffMins / 60);
      return `En ${hours}h`;
    } else {
      return date.toLocaleDateString('es-AR', { weekday: 'short', day: 'numeric' });
    }
  };

  // ============================================
  // OBTENER COLOR DE URGENCIA
  // ============================================

  const getUrgencyColor = (level: TriageNotification['urgency_level']) => {
    switch (level) {
      case 'CRITICAL':
        return 'bg-red-600 text-white';
      case 'HIGH':
        return 'bg-orange-500 text-white';
      case 'MEDIUM':
        return 'bg-yellow-500 text-black';
      default:
        return 'bg-green-500 text-white';
    }
  };

  const getUrgencyIcon = (level: TriageNotification['urgency_level']) => {
    switch (level) {
      case 'CRITICAL':
        return <ShieldAlert className="w-5 h-5" />;
      case 'HIGH':
        return <AlertTriangle className="w-5 h-5" />;
      case 'MEDIUM':
        return <AlertCircle className="w-5 h-5" />;
      default:
        return <CheckCircle className="w-5 h-5" />;
    }
  };

  // ============================================
  // RENDER
  // ============================================

  return (
    <div className="p-6 relative">
      {/* ======================================== */}
      {/* TOAST NOTIFICATIONS */}
      {/* ======================================== */}
      {showToastContainer && (
        <div 
          ref={toastsRef}
          className="fixed top-4 right-4 z-50 flex flex-col gap-3 max-w-sm"
        >
          {toasts.map(toast => (
            <div
              key={toast.id}
              className={`
                p-4 rounded-lg shadow-lg border-l-4 animate-slide-in
                ${getToastStyles(toast.type)}
              `}
            >
              <div className="flex items-start gap-3">
                {getToastIcon(toast.type)}
                <div className="flex-1">
                  <p className="font-semibold text-sm">{toast.title}</p>
                  <p className="text-sm mt-1 opacity-90">{toast.message}</p>
                </div>
                <button
                  onClick={() => removeToast(toast.id)}
                  className="opacity-50 hover:opacity-100 transition-opacity"
                >
                  <XCircle className="w-4 h-4" />
                </button>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* ======================================== */}
      {/* HEADER */}
      {/* ======================================== */}
      <div className="flex justify-between items-center mb-8">
        <div>
          <h1 className="text-3xl font-bold text-gray-800">Dashboard</h1>
          <p className="text-gray-500 mt-1">Panel de control en tiempo real</p>
        </div>
        
        {/* Bot Control Switch */}
        <div className="flex items-center gap-4 bg-white px-4 py-3 rounded-xl shadow-sm border">
          <div className="flex items-center gap-3">
            <div className={`
              w-3 h-3 rounded-full transition-colors duration-300
              ${botEnabled ? 'bg-green-500' : 'bg-red-500'}
              ${botStatus === 'paused' ? 'animate-pulse' : ''}
            `}></div>
            <span className="font-medium text-gray-700">
              Bot IA: {botEnabled ? 'Activo' : 'Pausado'}
            </span>
          </div>
          
          <button
            onClick={toggleBot}
            className={`
              relative inline-flex h-8 w-14 items-center rounded-full transition-all duration-300
              ${botEnabled ? 'bg-green-500' : 'bg-gray-300'}
            `}
          >
            <span
              className={`
                inline-block h-6 w-6 transform rounded-full bg-white shadow-lg transition-transform duration-300
                ${botEnabled ? 'translate-x-7' : 'translate-x-1'}
              `}
            />
          </button>
          
          <button
            onClick={() => setShowToastContainer(!showToastContainer)}
            className="p-2 rounded-lg hover:bg-gray-100 transition-colors"
            title={showToastContainer ? 'Ocultar notificaciones' : 'Mostrar notificaciones'}
          >
            {showToastContainer ? <BellOff size={20} /> : <Bell size={20} />}
          </button>
        </div>
      </div>

      {/* ======================================== */}
      {/* STATS GRID */}
      {/* ======================================== */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div className="bg-white rounded-xl shadow-sm p-6 border-l-4 border-blue-500">
          <div className="flex justify-between items-start">
            <div>
              <p className="text-sm text-gray-500">Turnos Hoy</p>
              <p className="text-3xl font-bold text-gray-800 mt-1">{stats.today_appointments}</p>
            </div>
            <Calendar className="w-8 h-8 text-blue-500 opacity-20" />
          </div>
          <div className="mt-4 flex items-center gap-2 text-sm text-green-600">
            <TrendingUp className="w-4 h-4" />
            <span>+3 vs ayer</span>
          </div>
        </div>

        <div className="bg-white rounded-xl shadow-sm p-6 border-l-4 border-yellow-500">
          <div className="flex justify-between items-start">
            <div>
              <p className="text-sm text-gray-500">Pendientes</p>
              <p className="text-3xl font-bold text-gray-800 mt-1">{stats.pending_confirmations}</p>
            </div>
            <Activity className="w-8 h-8 text-yellow-500 opacity-20" />
          </div>
          <div className="mt-4 flex items-center gap-2 text-sm text-gray-500">
            <span>Confirmaciones esperando</span>
          </div>
        </div>

        <div className="bg-white rounded-xl shadow-sm p-6 border-l-4 border-red-500">
          <div className="flex justify-between items-start">
            <div>
              <p className="text-sm text-gray-500">Urgencias</p>
              <p className="text-3xl font-bold text-gray-800 mt-1">{stats.high_urgency_alerts}</p>
            </div>
            <AlertTriangle className="w-8 h-8 text-red-500 opacity-20" />
          </div>
          <div className="mt-4 flex items-center gap-2 text-sm text-red-600">
            <span>Alertas de alta prioridad</span>
          </div>
        </div>

        <div className="bg-white rounded-xl shadow-sm p-6 border-l-4 border-green-500">
          <div className="flex justify-between items-start">
            <div>
              <p className="text-sm text-gray-500">Mensajes Hoy</p>
              <p className="text-3xl font-bold text-gray-800 mt-1">{stats.messages_today}</p>
            </div>
            <MessageSquare className="w-8 h-8 text-green-500 opacity-20" />
          </div>
          <div className="mt-4 flex items-center gap-2 text-sm text-green-600">
            <CheckCircle className="w-4 h-4" />
            <span>{stats.completed_today} resueltos</span>
          </div>
        </div>
      </div>

      {/* ======================================== */}
      {/* SMART AVAILABILITY WIDGET */}
      {/* ======================================== */}
      <div className="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl shadow-lg p-6 mb-8 text-white">
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-3">
            <div className="p-2 bg-white/20 rounded-lg">
              <Clock className="w-6 h-6" />
            </div>
            <div>
              <h2 className="text-xl font-bold">Disponibilidad para Urgencias</h2>
              <p className="text-white/80 text-sm">Pr√≥ximos huecos de 15-20 min para triage</p>
            </div>
          </div>
          <button 
            onClick={fetchAvailableSlots}
            disabled={loadingSlots}
            className="p-2 bg-white/20 rounded-lg hover:bg-white/30 transition-colors disabled:opacity-50"
            title="Refrescar"
          >
            <Clock className={`w-5 h-5 ${loadingSlots ? 'animate-spin' : ''}`} />
          </button>
        </div>
        
        {loadingSlots ? (
          <div className="flex items-center gap-2 py-4">
            <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
            <span>Buscando huecos disponibles...</span>
          </div>
        ) : availableSlots.length > 0 ? (
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            {availableSlots.slice(0, 3).map((slot, index) => (
              <button
                key={index}
                onClick={() => navigate(`/agenda?mode=quick-edit&slot=${encodeURIComponent(slot.slot_start)}`)}
                className="bg-white/10 hover:bg-white/20 rounded-lg p-4 text-left transition-all duration-200 hover:scale-[1.02] backdrop-blur-sm"
              >
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-2xl font-bold">{formatSlotTime(slot.slot_start)}</p>
                    <p className="text-white/80 text-sm">{slot.professional_name}</p>
                  </div>
                  <div className="text-right">
                    <p className="text-xs bg-white/20 px-2 py-1 rounded-full">
                      {getRelativeTime(slot.slot_start)}
                    </p>
                    <p className="text-xs text-white/60 mt-1">{slot.duration_minutes} min</p>
                  </div>
                </div>
              </button>
            ))}
          </div>
        ) : (
          <div className="text-center py-6">
            <div className="bg-white/10 rounded-lg p-6 mb-4">
              <Clock className="w-12 h-12 mx-auto mb-3 opacity-50" />
              <p className="text-lg font-medium mb-2">No hay huecos disponibles</p>
              <p className="text-white/70 text-sm mb-4">
                No se encontraron espacios de 15-20 min en los pr√≥ximos d√≠as
              </p>
              <button
                onClick={handleForceOverturn}
                className="inline-flex items-center gap-2 bg-yellow-500 hover:bg-yellow-400 text-gray-900 px-4 py-2 rounded-lg font-medium transition-colors"
              >
                <Plus className="w-5 h-5" />
                Forzar Sobreturno
              </button>
            </div>
          </div>
        )}
      </div>

      {/* ======================================== */}
      {/* TRIAGE ALERTS SECTION */}
      {/* ======================================== */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        {/* Notificaciones de Triaje */}
        <div className="bg-white rounded-xl shadow-sm overflow-hidden">
          <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
            <div className="flex items-center gap-2">
              <ShieldAlert className="w-5 h-5 text-red-500" />
              <h2 className="font-semibold text-gray-800">Alertas de Triaje</h2>
              {unreadCount > 0 && (
                <span className="bg-red-500 text-white text-xs px-2 py-1 rounded-full">
                  {unreadCount}
                </span>
              )}
            </div>
            <button 
              onClick={() => setNotifications([])}
              className="text-sm text-gray-500 hover:text-gray-700"
            >
              Limpiar
            </button>
          </div>
          
          <div className="max-h-96 overflow-y-auto">
            {notifications.length === 0 ? (
              <div className="p-8 text-center text-gray-500">
                <CheckCircle className="w-12 h-12 mx-auto mb-3 text-green-500 opacity-50" />
                <p>No hay alertas pendientes</p>
                <p className="text-sm mt-1">Todo esta bajo control</p>
              </div>
            ) : (
              <div className="divide-y">
                {notifications.map(notification => (
                  <div
                    key={notification.id}
                    onClick={() => markAsRead(notification.id)}
                    className={`
                      p-4 cursor-pointer transition-all duration-200 hover:bg-gray-50
                      ${notification.read ? 'opacity-60' : ''}
                    `}
                  >
                    <div className="flex items-start gap-3">
                      <div className={`
                        p-2 rounded-lg ${getUrgencyColor(notification.urgency_level)}
                      `}>
                        {getUrgencyIcon(notification.urgency_level)}
                      </div>
                      <div className="flex-1">
                        <div className="flex justify-between items-start">
                          <div>
                            <p className="font-medium text-gray-800">{notification.patient_name}</p>
                            <p className="text-sm text-gray-500">{notification.phone_number}</p>
                          </div>
                          <span className="text-xs text-gray-400">
                            {new Date(notification.timestamp).toLocaleTimeString()}
                          </span>
                        </div>
                        <div className="mt-2 flex flex-wrap gap-1">
                          {notification.symptoms.slice(0, 3).map((symptom, idx) => (
                            <span
                              key={idx}
                              className="text-xs px-2 py-0.5 bg-gray-100 rounded-full text-gray-600"
                            >
                              {symptom}
                            </span>
                          ))}
                        </div>
                        <p className="text-sm text-gray-600 mt-2 italic">
                          "{notification.message_preview}"
                        </p>
                      </div>
                      {!notification.read && (
                        <div className="w-2 h-2 bg-blue-500 rounded-full mt-2"></div>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>

        {/* Resumen de Actividad */}
        <div className="bg-white rounded-xl shadow-sm p-6">
          <h2 className="font-semibold text-gray-800 mb-4 flex items-center gap-2">
            <Users className="w-5 h-5 text-blue-500" />
            Resumen de Actividad
          </h2>
          
          <div className="space-y-4">
            <div className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
              <div className="flex items-center gap-3">
                <Users className="w-5 h-5 text-gray-400" />
                <span className="text-gray-700">Total Pacientes</span>
              </div>
              <span className="font-semibold text-gray-800">{stats.total_patients}</span>
            </div>
            
            <div className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
              <div className="flex items-center gap-3">
                <Calendar className="w-5 h-5 text-gray-400" />
                <span className="text-gray-700">Turnos Confirmados</span>
              </div>
              <span className="font-semibold text-green-600">
                {stats.today_appointments - stats.pending_confirmations}
              </span>
            </div>
            
            <div className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
              <div className="flex items-center gap-3">
                <MessageSquare className="w-5 h-5 text-gray-400" />
                <span className="text-gray-700">Tasa de Resolucion</span>
              </div>
              <span className="font-semibold text-blue-600">
                {stats.messages_today > 0 
                  ? Math.round((stats.completed_today / stats.messages_today) * 100)
                  : 0}%
              </span>
            </div>
          </div>

          {/* Estado de Servicios */}
          <div className="mt-6 pt-6 border-t">
            <h3 className="font-medium text-gray-700 mb-3">Estado de Servicios</h3>
            <div className="flex gap-2 flex-wrap">
              <div className="flex items-center gap-2 px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">
                <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                WhatsApp: OK
              </div>
              <div className="flex items-center gap-2 px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">
                <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                AI: OK
              </div>
              <div className="flex items-center gap-2 px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">
                <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                DB: OK
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* ======================================== */}
      {/* CSS for animations */}
      {/* ======================================== */}
      <style>{`
        @keyframes slide-in {
          from {
            transform: translateX(100%);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }
        
        .animate-slide-in {
          animation: slide-in 0.3s ease-out;
        }
      `}</style>
    </div>
  );
}
````

## File: frontend_react/src/views/LoginView.tsx
````typescript
import React, { useState } from 'react';
import { useNavigate, useLocation } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';
import api from '../api/axios';
import { Lock, Mail, Shield, AlertCircle, CheckCircle } from 'lucide-react';

const LoginView: React.FC = () => {
  const { login } = useAuth();
  const navigate = useNavigate();
  const location = useLocation();
  const [isRegistering, setIsRegistering] = useState(false);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [firstName, setFirstName] = useState('');
  const [role, setRole] = useState('professional');
  const [error, setError] = useState<string | null>(null);
  const [message, setMessage] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  const from = location.state?.from?.pathname || "/";

  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);
    setLoading(true);
    try {
      const response = await api.post('/auth/login', { email, password });
      login(response.data.access_token, response.data.user);
      navigate(from, { replace: true });
    } catch (err: any) {
      setError(err.response?.data?.detail || "Error al iniciar sesi√≥n. Verifique sus credenciales.");
    } finally {
      setLoading(false);
    }
  };

  const handleRegister = async (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);
    setMessage(null);
    setLoading(true);
    try {
      await api.post('/auth/register', {
        email,
        password,
        role,
        first_name: firstName,
        last_name: ""
      });
      setMessage("Registro solicitado con √©xito. Un CEO debe aprobar tu cuenta antes de que puedas ingresar.");
      setIsRegistering(false);
    } catch (err: any) {
      setError(err.response?.data?.detail || "Error al registrarse. Intente nuevamente.");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="login-container">
      <div className="login-card glass">
        <div className="login-header">
          <div className="logo-icon">
            <Shield size={32} color="var(--accent)" />
          </div>
          <h1>Dentalogic</h1>
          <p>{isRegistering ? 'Solicitud de acceso a la plataforma' : 'Bienvenido de nuevo'}</p>
        </div>

        {error && (
          <div className="auth-alert error">
            <AlertCircle size={18} />
            <span>{error}</span>
          </div>
        )}

        {message && (
          <div className="auth-alert success">
            <CheckCircle size={18} />
            <span>{message}</span>
          </div>
        )}

        <form onSubmit={isRegistering ? handleRegister : handleLogin} className="auth-form">
          {isRegistering && (
            <div className="input-group">
              <label>Nombre</label>
              <div className="input-wrapper">
                <input
                  type="text"
                  value={firstName}
                  onChange={(e) => setFirstName(e.target.value)}
                  placeholder="Tu nombre completo"
                  required
                />
              </div>
            </div>
          )}

          <div className="input-group">
            <label>Correo Electr√≥nico</label>
            <div className="input-wrapper">
              <Mail className="input-icon" size={18} />
              <input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                placeholder="ejemplo@clinica.com"
                required
              />
            </div>
          </div>

          <div className="input-group">
            <label>Contrase√±a</label>
            <div className="input-wrapper">
              <Lock className="input-icon" size={18} />
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                required
              />
            </div>
          </div>

          {isRegistering && (
            <div className="input-group">
              <label>Rol solicitado</label>
              <select value={role} onChange={(e) => setRole(e.target.value)}>
                <option value="professional">Profesional Dental</option>
                <option value="secretary">Secretar√≠a / Administraci√≥n</option>
                <option value="ceo">Director / CEO</option>
              </select>
            </div>
          )}

          <button type="submit" className="btn-primary auth-btn" disabled={loading}>
            {loading ? 'Procesando...' : (isRegistering ? 'Solicitar Registro' : 'Ingresar')}
          </button>
        </form>

        <div className="auth-footer">
          <button
            type="button"
            className="btn-link"
            onClick={() => {
              setIsRegistering(!isRegistering);
              setError(null);
              setMessage(null);
            }}
          >
            {isRegistering ? '¬øYa tienes cuenta? Ingresa aqu√≠' : '¬øNo tienes acceso? Solicitalo ahora'}
          </button>
        </div>
      </div>

      <style>{`
        .login-container {
          display: flex;
          justify-content: center;
          align-items: center;
          min-height: 100vh;
          background: radial-gradient(circle at top right, #1a1a2e, #0f0f1a);
          padding: 20px;
        }
        .login-card {
          width: 100%;
          max-width: 400px;
          padding: 40px;
          border-radius: 24px;
          text-align: center;
          animation: slideUp 0.6s ease-out;
        }
        .login-header h1 {
          font-size: 2rem;
          margin: 10px 0 5px;
          color: white;
          letter-spacing: -0.5px;
        }
        .login-header p {
          color: var(--text-secondary);
          margin-bottom: 30px;
        }
        .logo-icon {
          background: rgba(var(--accent-rgb), 0.1);
          width: 64px;
          height: 64px;
          border-radius: 16px;
          display: flex;
          align-items: center;
          justify-content: center;
          margin: 0 auto 20px;
        }
        .auth-form {
          text-align: left;
        }
        .input-group {
          margin-bottom: 20px;
        }
        .input-group label {
          display: block;
          font-size: 0.85rem;
          color: var(--text-secondary);
          margin-bottom: 8px;
        }
        .input-wrapper {
          position: relative;
        }
        .input-icon {
          position: absolute;
          left: 12px;
          top: 50%;
          transform: translateY(-50%);
          color: rgba(255, 255, 255, 0.4);
        }
        .input-wrapper input, .input-group select {
          width: 100%;
          padding: 12px 12px 12px 40px;
          background: rgba(255, 255, 255, 0.05);
          border: 1px solid rgba(255, 255, 255, 0.1);
          border-radius: 12px;
          color: white;
          transition: all 0.3s;
        }
        .input-group select {
           padding-left: 12px;
        }
        .input-wrapper input:focus {
          border-color: var(--accent);
          background: rgba(255, 255, 255, 0.08);
          outline: none;
        }
        .auth-btn {
          width: 100%;
          padding: 14px;
          font-weight: 600;
          margin-top: 10px;
        }
        .auth-alert {
          display: flex;
          align-items: center;
          gap: 10px;
          padding: 12px;
          border-radius: 12px;
          margin-bottom: 20px;
          font-size: 0.9rem;
          text-align: left;
        }
        .auth-alert.error {
          background: rgba(255, 77, 77, 0.1);
          border: 1px solid rgba(255, 77, 77, 0.2);
          color: #ff4d4d;
        }
        .auth-alert.success {
          background: rgba(77, 255, 140, 0.1);
          border: 1px solid rgba(77, 255, 140, 0.2);
          color: #4dff8c;
        }
        .btn-link {
          background: none;
          border: none;
          color: #4da6ff; /* Higher contrast blue */
          font-size: 0.95rem;
          cursor: pointer;
          margin-top: 20px;
          text-decoration: none;
          font-weight: 500;
          transition: all 0.3s;
        }
        .btn-link:hover {
          color: white;
          text-decoration: underline;
        }
        .input-group select option {
          background: #1a1a2e;
          color: white;
        }
        @keyframes slideUp {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
        }
      `}</style>
    </div>
  );
};

export default LoginView;
````

## File: frontend_react/src/views/Logs.tsx
````typescript
import React, { useEffect, useState } from 'react';
import { useApi } from '../hooks/useApi';
import { ScrollText, RefreshCw } from 'lucide-react';

interface LogEntry {
    timestamp: string;
    level: string;
    message: string;
    source: string;
}

export const Logs: React.FC = () => {
    const { fetchApi, loading } = useApi();
    const [logs, setLogs] = useState<LogEntry[]>([]);

    const loadLogs = async () => {
        try {
            // Note: The specific endpoint might vary, using a standard convention or 
            // what was hinted in app.js as 'loadLogs' -> adminFetch('/admin/logs')?
            // If /admin/logs doesn't exist, we might need to fallback to console events
            const data = await fetchApi('/admin/logs?limit=50');
            if (Array.isArray(data)) {
                setLogs(data);
            } else if (data.logs) {
                setLogs(data.logs);
            }
        } catch (e) {
            console.error("Failed to load logs", e);
        }
    };

    useEffect(() => {
        loadLogs();
        const interval = setInterval(loadLogs, 5000); // Live poll
        return () => clearInterval(interval);
    }, []);

    return (
        <div className="view active">
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                <h1 className="view-title" style={{ margin: 0 }}>Live History</h1>
                <button className="btn-secondary" onClick={loadLogs} disabled={loading}>
                    <RefreshCw size={14} className={loading ? 'spin' : ''} style={{ marginRight: '6px' }} />
                    Actualizar
                </button>
            </div>

            <div className="glass" style={{ padding: '0', overflow: 'hidden' }}>
                <div className="table-responsive" style={{ maxHeight: '600px', overflowY: 'auto' }}>
                    <table className="data-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Nivel</th>
                                <th>Origen</th>
                                <th>Mensaje</th>
                            </tr>
                        </thead>
                        <tbody>
                            {logs.map((log, i) => (
                                <tr key={i}>
                                    <td style={{ whiteSpace: 'nowrap', fontSize: '11px', color: '#a1a1aa' }}>
                                        {new Date(log.timestamp).toLocaleString()}
                                    </td>
                                    <td>
                                        <span className={`service-pill ${log.level === 'ERROR' ? 'error' : log.level === 'WARN' ? 'warning' : 'ok'}`} style={{ fontSize: '10px' }}>
                                            {log.level}
                                        </span>
                                    </td>
                                    <td style={{ fontSize: '12px' }}>{log.source || 'Orchestrator'}</td>
                                    <td style={{ fontFamily: 'monospace', fontSize: '12px' }}>{log.message}</td>
                                </tr>
                            ))}
                            {logs.length === 0 && (
                                <tr>
                                    <td colSpan={4} style={{ textAlign: 'center', padding: '30px', color: '#666' }}>
                                        No hay registros recientes.
                                    </td>
                                </tr>
                            )}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
};
````

## File: frontend_react/src/views/PatientDetail.tsx
````typescript
import { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import {
  ArrowLeft, User, Phone, Mail, Calendar, AlertTriangle,
  FileText, Plus, Activity, Heart, Pill, Stethoscope, Clock
} from 'lucide-react';
import api from '../api/axios';

interface Patient {
  id: number;
  first_name: string;
  last_name?: string;
  phone_number: string;
  email?: string;
  dni?: string;
  obra_social?: string;
  obra_social_number?: string;
  birth_date?: string;
  created_at: string;
  status?: string;
  medical_notes?: string; // Antecedentes m√©dicos
}

interface ClinicalRecord {
  id: number;
  patient_id: number;
  professional_id: number;
  professional_name: string;
  appointment_id?: number;
  record_type: string;
  chief_complaint?: string;
  diagnosis?: string;
  treatment_plan?: string;
  notes?: string;
  vital_signs?: Record<string, string>;
  created_at: string;
}

const criticalConditions = [
  'diabetes', 'hipertension', 'cardiopatia', 'hemofilia',
  'alergia penicilina', 'embarazo', ' anticoagulacion',
  'vih', 'hepatitis', 'asma severa'
];

export default function PatientDetail() {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const [patient, setPatient] = useState<Patient | null>(null);
  const [records, setRecords] = useState<ClinicalRecord[]>([]);
  const [loading, setLoading] = useState(true);
  const [showNoteForm, setShowNoteForm] = useState(false);
  const [criticalConditionsFound, setCriticalConditionsFound] = useState<string[]>([]);

  const [formData, setFormData] = useState({
    record_type: 'evolution',
    chief_complaint: '',
    diagnosis: '',
    treatment_plan: '',
    notes: '',
    blood_pressure: '',
    heart_rate: '',
    temperature: '',
  });

  useEffect(() => {
    if (id) {
      fetchPatientData();
    }
  }, [id]);

  const fetchPatientData = async () => {
    try {
      setLoading(true);
      const [patientRes, recordsRes] = await Promise.all([
        api.get(`/admin/patients/${id}`),
        api.get(`/admin/patients/${id}/records`),
      ]);
      setPatient(patientRes.data);
      setRecords(recordsRes.data);
      
      // Check for critical medical conditions
      if (patientRes.data.medical_notes) {
        const notes = patientRes.data.medical_notes.toLowerCase();
        const found = criticalConditions.filter(condition =>
          notes.includes(condition.toLowerCase())
        );
        setCriticalConditionsFound(found);
      }
    } catch (error) {
      console.error('Error fetching patient data:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      const payload = {
        patient_id: parseInt(id!),
        record_type: formData.record_type,
        chief_complaint: formData.chief_complaint,
        diagnosis: formData.diagnosis,
        treatment_plan: formData.treatment_plan,
        notes: formData.notes,
        vital_signs: {
          blood_pressure: formData.blood_pressure,
          heart_rate: formData.heart_rate,
          temperature: formData.temperature,
        },
      };

      await api.post('/admin/clinical-records', payload);
      fetchPatientData();
      setShowNoteForm(false);
      setFormData({
        record_type: 'evolution',
        chief_complaint: '',
        diagnosis: '',
        treatment_plan: '',
        notes: '',
        blood_pressure: '',
        heart_rate: '',
        temperature: '',
      });
    } catch (error) {
      console.error('Error saving clinical record:', error);
      alert('Error al guardar el registro');
    }
  };

  const getRecordIcon = (type: string) => {
    switch (type) {
      case 'initial': return <Stethoscope className="text-blue-500" size={18} />;
      case 'evolution': return <Activity className="text-green-500" size={18} />;
      case 'procedure': return <Heart className="text-purple-500" size={18} />;
      case 'prescription': return <Pill className="text-orange-500" size={18} />;
      default: return <FileText className="text-gray-500" size={18} />;
    }
  };

  const getRecordTypeLabel = (type: string) => {
    const labels: Record<string, string> = {
      initial: 'Consulta Inicial',
      evolution: 'Evoluci√≥n',
      procedure: 'Procedimiento',
      prescription: 'Receta',
    };
    return labels[type] || type;
  };

  if (loading) {
    return (
      <div className="p-6 text-center text-gray-500">
        Cargando datos del paciente...
      </div>
    );
  }

  if (!patient) {
    return (
      <div className="p-6 text-center text-gray-500">
        Paciente no encontrado
      </div>
    );
  }

  return (
    <div className="p-6">
      {/* Header */}
      <div className="flex items-center gap-4 mb-6">
        <button
          onClick={() => navigate('/pacientes')}
          className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
        >
          <ArrowLeft size={20} />
        </button>
        <div>
          <h1 className="text-2xl font-bold text-gray-800">
            {patient.first_name} {patient.last_name}
          </h1>
          <p className="text-gray-500">Historia Cl√≠nica Digital</p>
        </div>
        {criticalConditionsFound.length > 0 && (
          <div className="ml-auto flex items-center gap-2 bg-red-100 text-red-800 px-3 py-1 rounded-full">
            <AlertTriangle size={16} />
            <span className="text-sm font-medium">Antecedentes Cr√≠ticos</span>
          </div>
        )}
      </div>

      <div className="grid grid-cols-3 gap-6">
        {/* Patient Profile */}
        <div className="col-span-1 space-y-4">
          {/* Basic Info */}
          <div className="bg-white rounded-lg shadow p-4">
            <div className="flex items-center gap-3 mb-4">
              <div className="w-12 h-12 bg-primary rounded-full flex items-center justify-center text-white text-xl font-bold">
                {patient.first_name?.charAt(0)}
              </div>
              <div>
                <div className="font-medium text-gray-900">
                  {patient.first_name} {patient.last_name}
                </div>
                <div className="text-sm text-gray-500">Paciente</div>
              </div>
            </div>

            <div className="space-y-3">
              <div className="flex items-center gap-2 text-sm">
                <Phone className="text-gray-400" size={16} />
                <span>{patient.phone_number}</span>
              </div>
              {patient.email && (
                <div className="flex items-center gap-2 text-sm">
                  <Mail className="text-gray-400" size={16} />
                  <span>{patient.email}</span>
                </div>
              )}
              {patient.dni && (
                <div className="flex items-center gap-2 text-sm">
                  <User className="text-gray-400" size={16} />
                  <span>DNI: {patient.dni}</span>
                </div>
              )}
              {patient.obra_social && (
                <div className="flex items-center gap-2 text-sm">
                  <FileText className="text-gray-400" size={16} />
                  <span>{patient.obra_social} {patient.obra_social_number}</span>
                </div>
              )}
              <div className="flex items-center gap-2 text-sm">
                <Calendar className="text-gray-400" size={16} />
                <span>Alta: {new Date(patient.created_at).toLocaleDateString()}</span>
              </div>
            </div>
          </div>

          {/* Medical Notes / Antecedentes */}
          {patient.medical_notes && (
            <div className="bg-white rounded-lg shadow p-4 border-l-4 border-red-500">
              <div className="flex items-center gap-2 mb-2">
                <AlertTriangle className="text-red-500" size={18} />
                <h3 className="font-medium text-gray-900">Antecedentes M√©dicos</h3>
              </div>
              <p className="text-sm text-gray-600 whitespace-pre-wrap">
                {patient.medical_notes}
              </p>
              {criticalConditionsFound.length > 0 && (
                <div className="mt-3 pt-3 border-t">
                  <p className="text-xs font-medium text-red-600 mb-2">Condiciones Cr√≠ticas:</p>
                  <div className="flex flex-wrap gap-1">
                    {criticalConditionsFound.map((condition) => (
                      <span key={condition} className="text-xs bg-red-100 text-red-800 px-2 py-0.5 rounded">
                        {condition}
                      </span>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Add Note Button */}
          <button
            onClick={() => setShowNoteForm(true)}
            className="w-full flex items-center justify-center gap-2 bg-primary text-white py-3 rounded-lg hover:bg-primary-dark transition-colors"
          >
            <Plus size={18} />
            Agregar Evoluci√≥n
          </button>
        </div>

        {/* Clinical Records Timeline */}
        <div className="col-span-2">
          <div className="bg-white rounded-lg shadow">
            <div className="p-4 border-b">
              <h2 className="font-medium text-gray-900">L√≠nea de Tiempo Cl√≠nica</h2>
              <p className="text-sm text-gray-500">{records.length} registros</p>
            </div>

            <div className="p-4">
              {records.length === 0 ? (
                <div className="text-center py-8 text-gray-500">
                  <FileText size={48} className="mx-auto mb-2 opacity-50" />
                  <p>No hay registros cl√≠nicos a√∫n</p>
                </div>
              ) : (
                <div className="space-y-4">
                  {records.map((record, index) => (
                    <div key={record.id} className="relative pl-8 pb-4">
                      {/* Timeline line */}
                      {index < records.length - 1 && (
                        <div className="absolute left-[11px] top-6 bottom-0 w-0.5 bg-gray-200"></div>
                      )}
                      
                      {/* Timeline dot */}
                      <div className="absolute left-0 top-1 w-6 h-6 bg-white border-2 border-gray-200 rounded-full flex items-center justify-center">
                        {getRecordIcon(record.record_type)}
                      </div>

                      {/* Content */}
                      <div className="bg-gray-50 rounded-lg p-4">
                        <div className="flex justify-between items-start mb-2">
                          <div>
                            <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-blue-100 text-blue-800 text-xs rounded-full">
                              {getRecordTypeLabel(record.record_type)}
                            </span>
                            <span className="ml-2 text-sm text-gray-500">
                              {new Date(record.created_at).toLocaleString()}
                            </span>
                          </div>
                          <span className="text-xs text-gray-400">
                            Dr. {record.professional_name}
                          </span>
                        </div>

                        {record.chief_complaint && (
                          <div className="mb-2">
                            <p className="text-xs font-medium text-gray-500">Motivo de consulta</p>
                            <p className="text-sm">{record.chief_complaint}</p>
                          </div>
                        )}

                        {record.diagnosis && (
                          <div className="mb-2">
                            <p className="text-xs font-medium text-gray-500">Diagn√≥stico</p>
                            <p className="text-sm">{record.diagnosis}</p>
                          </div>
                        )}

                        {record.treatment_plan && (
                          <div className="mb-2">
                            <p className="text-xs font-medium text-gray-500">Plan de tratamiento</p>
                            <p className="text-sm">{record.treatment_plan}</p>
                          </div>
                        )}

                        {record.notes && (
                          <div className="mb-2">
                            <p className="text-xs font-medium text-gray-500">Notas</p>
                            <p className="text-sm text-gray-600">{record.notes}</p>
                          </div>
                        )}

                        {record.vital_signs && (
                          <div className="flex gap-4 mt-2 pt-2 border-t">
                            {record.vital_signs.blood_pressure && (
                              <div className="text-xs">
                                <span className="text-gray-400">PA: </span>
                                <span>{record.vital_signs.blood_pressure}</span>
                              </div>
                            )}
                            {record.vital_signs.heart_rate && (
                              <div className="text-xs">
                                <span className="text-gray-400">FC: </span>
                                <span>{record.vital_signs.heart_rate} ppm</span>
                              </div>
                            )}
                            {record.vital_signs.temperature && (
                              <div className="text-xs">
                                <span className="text-gray-400">T¬∞: </span>
                                <span>{record.vital_signs.temperature}¬∞C</span>
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>
      </div>

      {/* Add Note Modal */}
      {showNoteForm && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between items-center p-4 border-b sticky top-0 bg-white">
              <h2 className="text-xl font-bold">Nueva Evoluci√≥n Cl√≠nica</h2>
              <button
                onClick={() => setShowNoteForm(false)}
                className="text-gray-500 hover:text-gray-700"
              >
                ‚úï
              </button>
            </div>

            <form onSubmit={handleSubmit} className="p-4">
              <div className="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Tipo de Registro
                  </label>
                  <select
                    value={formData.record_type}
                    onChange={(e) => setFormData({ ...formData, record_type: e.target.value })}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                  >
                    <option value="initial">Consulta Inicial</option>
                    <option value="evolution">Evoluci√≥n</option>
                    <option value="procedure">Procedimiento</option>
                    <option value="prescription">Receta</option>
                  </select>
                </div>
              </div>

              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Motivo de Consulta
                </label>
                <input
                  type="text"
                  value={formData.chief_complaint}
                  onChange={(e) => setFormData({ ...formData, chief_complaint: e.target.value })}
                  placeholder="Ej: Dolor de muela, revisi√≥n de rutina..."
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                />
              </div>

              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Diagn√≥stico
                </label>
                <textarea
                  value={formData.diagnosis}
                  onChange={(e) => setFormData({ ...formData, diagnosis: e.target.value })}
                  rows={2}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                />
              </div>

              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Plan de Tratamiento
                </label>
                <textarea
                  value={formData.treatment_plan}
                  onChange={(e) => setFormData({ ...formData, treatment_plan: e.target.value })}
                  rows={2}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                />
              </div>

              {/* Vital Signs */}
              <div className="mb-4 p-4 bg-gray-50 rounded-lg">
                <h3 className="text-sm font-medium text-gray-700 mb-2">Signos Vitales</h3>
                <div className="grid grid-cols-3 gap-4">
                  <div>
                    <label className="block text-xs text-gray-500 mb-1">Presi√≥n Arterial</label>
                    <input
                      type="text"
                      placeholder="120/80"
                      value={formData.blood_pressure}
                      onChange={(e) => setFormData({ ...formData, blood_pressure: e.target.value })}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                    />
                  </div>
                  <div>
                    <label className="block text-xs text-gray-500 mb-1">Frecuencia Card√≠aca</label>
                    <input
                      type="text"
                      placeholder="72"
                      value={formData.heart_rate}
                      onChange={(e) => setFormData({ ...formData, heart_rate: e.target.value })}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                    />
                  </div>
                  <div>
                    <label className="block text-xs text-gray-500 mb-1">Temperatura</label>
                    <input
                      type="text"
                      placeholder="36.5"
                      value={formData.temperature}
                      onChange={(e) => setFormData({ ...formData, temperature: e.target.value })}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                    />
                  </div>
                </div>
              </div>

              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Notas Adicionales
                </label>
                <textarea
                  value={formData.notes}
                  onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                  rows={3}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                />
              </div>

              <div className="flex justify-end gap-3">
                <button
                  type="button"
                  onClick={() => setShowNoteForm(false)}
                  className="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200"
                >
                  Cancelar
                </button>
                <button
                  type="submit"
                  className="px-4 py-2 text-white bg-primary rounded-lg hover:bg-primary-dark"
                >
                  Guardar Registro
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
}
````

## File: frontend_react/src/views/PatientsView.tsx
````typescript
import { useState, useEffect } from 'react';
import { Search, Plus, Edit, Trash2, Eye, X, FileText, Calendar, MessageSquare, User, Brain } from 'lucide-react';
import api from '../api/axios';

interface Patient {
  id: number;
  first_name: string;
  last_name?: string;
  phone_number: string;
  email?: string;
  obra_social?: string;
  dni?: string;
  created_at: string;
  status?: string;
  health_conditions?: string[];
}

export default function PatientsView() {
  const [patients, setPatients] = useState<Patient[]>([]);
  const [filteredPatients, setFilteredPatients] = useState<Patient[]>([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [semanticSearchTerm, setSemanticSearchTerm] = useState('');
  const [semanticResults, setSemanticResults] = useState<Patient[]>([]);
  const [loading, setLoading] = useState(true);
  const [semanticLoading, setSemanticLoading] = useState(false);
  const [showModal, setShowModal] = useState(false);
  const [editingPatient, setEditingPatient] = useState<Patient | null>(null);
  const [formData, setFormData] = useState({
    first_name: '',
    last_name: '',
    phone_number: '',
    email: '',
    obra_social: '',
    dni: '',
  });

  // Fetch patients on mount
  useEffect(() => {
    fetchPatients();
  }, []);

  // Filter patients when search term changes
  useEffect(() => {
    const filtered = patients.filter((patient) => {
      const searchLower = searchTerm.toLowerCase();
      return (
        patient.first_name?.toLowerCase().includes(searchLower) ||
        patient.last_name?.toLowerCase().includes(searchLower) ||
        patient.phone_number?.includes(searchTerm) ||
        patient.dni?.includes(searchTerm) ||
        patient.email?.toLowerCase().includes(searchLower)
      );
    });
    setFilteredPatients(filtered);
  }, [searchTerm, patients]);

  const fetchPatients = async () => {
    try {
      setLoading(true);
      const response = await api.get('/admin/patients');
      setPatients(response.data);
      setFilteredPatients(response.data);
    } catch (error) {
      console.error('Error fetching patients:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleSemanticSearch = async (value: string) => {
    setSemanticSearchTerm(value);
    
    if (!value.trim()) {
      setSemanticResults([]);
      setFilteredPatients(patients);
      return;
    }

    setSemanticLoading(true);
    
    try {
      const response = await api.get('/admin/patients/search-semantic', {
        params: { query: value }
      });
      
      setSemanticResults(response.data);
      
      if (response.data.length > 0) {
        setFilteredPatients(response.data);
      }
    } catch (error) {
      console.error('Error in semantic search:', error);
      setSemanticResults([]);
      setFilteredPatients(patients);
    } finally {
      setSemanticLoading(false);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      if (editingPatient) {
        await api.put(`/admin/patients/${editingPatient.id}`, formData);
      } else {
        await api.post('/admin/patients', formData);
      }
      fetchPatients();
      closeModal();
    } catch (error) {
      console.error('Error saving patient:', error);
      alert('Error al guardar paciente');
    }
  };

  const handleDelete = async (id: number) => {
    if (!confirm('¬øEst√°s seguro de eliminar este paciente?')) return;
    try {
      await api.delete(`/admin/patients/${id}`);
      fetchPatients();
    } catch (error) {
      console.error('Error deleting patient:', error);
      alert('Error al eliminar paciente');
    }
  };

  const openEditModal = (patient: Patient) => {
    setEditingPatient(patient);
    setFormData({
      first_name: patient.first_name || '',
      last_name: patient.last_name || '',
      phone_number: patient.phone_number || '',
      email: patient.email || '',
      obra_social: patient.obra_social || '',
      dni: patient.dni || '',
    });
    setShowModal(true);
  };

  const openCreateModal = () => {
    setEditingPatient(null);
    setFormData({
      first_name: '',
      last_name: '',
      phone_number: '',
      email: '',
      obra_social: '',
      dni: '',
    });
    setShowModal(true);
  };

  const closeModal = () => {
    setShowModal(false);
    setEditingPatient(null);
  };

  return (
    <div className="p-6">
      {/* Header */}
      <div className="flex justify-between items-center mb-6">
        <div>
          <h1 className="text-2xl font-bold text-gray-800">Pacientes</h1>
          <p className="text-gray-500">Gestiona los pacientes de la cl√≠nica</p>
        </div>
        <button
          onClick={openCreateModal}
          className="flex items-center gap-2 bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded-lg transition-colors"
        >
          <Plus size={20} />
          Nuevo Paciente
        </button>
      </div>

      {/* Search */}
      <div className="mb-6 space-y-4">
        <div className="relative max-w-md">
          <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={20} />
          <input
            type="text"
            placeholder="Buscar por nombre, DNI o tel√©fono..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
          />
        </div>
        
        {/* Semantic Search */}
        <div className="relative max-w-md">
          <Brain className="absolute left-3 top-1/2 transform -translate-y-1/2 text-purple-500" size={20} />
          <input
            type="text"
            placeholder="Buscar por s√≠ntomas (IA)..."
            value={semanticSearchTerm}
            onChange={(e) => handleSemanticSearch(e.target.value)}
            className="w-full pl-10 pr-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
          />
          {semanticLoading && (
            <div className="absolute right-3 top-1/2 transform -translate-y-1/2">
              <div className="w-4 h-4 border-2 border-purple-500 border-t-transparent rounded-full animate-spin"></div>
            </div>
          )}
          {semanticResults.length > 0 && (
            <div className="absolute right-3 top-1/2 transform -translate-y-1/2 text-green-500">
              <Search size={20} />
            </div>
          )}
        </div>
      </div>

      {/* Table */}
      <div className="bg-white rounded-lg shadow overflow-hidden">
        {loading ? (
          <div className="p-8 text-center text-gray-500">Cargando pacientes...</div>
        ) : filteredPatients.length === 0 ? (
          <div className="p-8 text-center text-gray-500">
            No se encontraron pacientes
          </div>
        ) : (
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Paciente
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Contacto
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    DNI / Obra Social
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Salud
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Fecha Alta
                  </th>
                  <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Acciones
                  </th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {filteredPatients.map((patient) => (
                  <tr key={patient.id} className="hover:bg-gray-50">
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="flex items-center">
                        <div className="flex-shrink-0 h-10 w-10 bg-primary-light rounded-full flex items-center justify-center text-white font-medium">
                          {patient.first_name?.charAt(0).toUpperCase()}
                        </div>
                        <div className="ml-4">
                          <div className="flex items-center gap-2">
                            <div className="text-sm font-medium text-gray-900">
                              {patient.first_name} {patient.last_name}
                            </div>
                            {semanticResults.some(r => r.id === patient.id) && (
                              <Brain 
                                size={16} 
                                className="text-purple-500" 
                              />
                            )}
                          </div>
                        </div>
                      </div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="text-sm text-gray-900">{patient.phone_number}</div>
                      <div className="text-sm text-gray-500">{patient.email}</div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="text-sm text-gray-900">{patient.dni || '-'}</div>
                      <div className="text-sm text-gray-500">{patient.obra_social || '-'}</div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      {new Date(patient.created_at).toLocaleDateString('es-AR')}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                      <div className="flex justify-end gap-2">
                        <button
                          onClick={() => window.location.href = `/pacientes/${patient.id}`}
                          className="p-2 text-gray-600 hover:text-primary hover:bg-gray-100 rounded"
                          title="Ver Ficha"
                        >
                          <FileText size={18} />
                        </button>
                        <button
                          onClick={() => openEditModal(patient)}
                          className="p-2 text-gray-600 hover:text-primary hover:bg-gray-100 rounded"
                          title="Editar"
                        >
                          <Edit size={18} />
                        </button>
                        <button
                          onClick={() => handleDelete(patient.id)}
                          className="p-2 text-gray-600 hover:text-red-600 hover:bg-gray-100 rounded"
                          title="Eliminar"
                        >
                          <Trash2 size={18} />
                        </button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>

      {/* Modal */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg w-full max-w-md mx-4">
            <div className="flex justify-between items-center p-4 border-b">
              <h2 className="text-xl font-bold">
                {editingPatient ? 'Editar Paciente' : 'Nuevo Paciente'}
              </h2>
              <button onClick={closeModal} className="text-gray-500 hover:text-gray-700">
                <X size={24} />
              </button>
            </div>
            <form onSubmit={handleSubmit} className="p-4">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Nombre *
                  </label>
                  <input
                    type="text"
                    required
                    value={formData.first_name}
                    onChange={(e) => setFormData({ ...formData, first_name: e.target.value })}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Apellido
                  </label>
                  <input
                    type="text"
                    value={formData.last_name}
                    onChange={(e) => setFormData({ ...formData, last_name: e.target.value })}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Tel√©fono *
                  </label>
                  <input
                    type="tel"
                    required
                    value={formData.phone_number}
                    onChange={(e) => setFormData({ ...formData, phone_number: e.target.value })}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    DNI
                  </label>
                  <input
                    type="text"
                    value={formData.dni}
                    onChange={(e) => setFormData({ ...formData, dni: e.target.value })}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Email
                  </label>
                  <input
                    type="email"
                    value={formData.email}
                    onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Obra Social
                  </label>
                  <input
                    type="text"
                    value={formData.obra_social}
                    onChange={(e) => setFormData({ ...formData, obra_social: e.target.value })}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                  />
                </div>
              </div>
              <div className="flex justify-end gap-3 mt-6">
                <button
                  type="button"
                  onClick={closeModal}
                  className="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
                >
                  Cancelar
                </button>
                <button
                  type="submit"
                  className="px-4 py-2 text-white bg-primary rounded-lg hover:bg-primary-dark transition-colors"
                >
                  {editingPatient ? 'Guardar Cambios' : 'Crear Paciente'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
}
````

## File: frontend_react/src/views/ProfessionalsView.tsx
````typescript
import { useState, useEffect } from 'react';
import {
  User, Plus, Edit, Clock, Calendar, Mail, Phone,
  ChevronDown, ChevronUp, CheckCircle, XCircle, Save, X
} from 'lucide-react';
import api from '../api/axios';

interface Professional {
  id: number;
  name: string;
  email?: string;
  phone?: string;
  specialty?: string;
  license_number?: string;
  is_active: boolean;
  availability?: ProfessionalAvailability;
}

interface ProfessionalAvailability {
  monday: TimeSlot[];
  tuesday: TimeSlot[];
  wednesday: TimeSlot[];
  thursday: TimeSlot[];
  friday: TimeSlot[];
  saturday: TimeSlot[];
  sunday: TimeSlot[];
}

interface TimeSlot {
  start: string;  // HH:mm
  end: string;    // HH:mm
}

const DAYS = [
  { key: 'monday', label: 'Lunes' },
  { key: 'tuesday', label: 'Martes' },
  { key: 'wednesday', label: 'Mi√©rcoles' },
  { key: 'thursday', label: 'Jueves' },
  { key: 'friday', label: 'Viernes' },
  { key: 'saturday', label: 'S√°bado' },
  { key: 'sunday', label: 'Domingo' },
];

const SPECIALTIES = [
  'Odontolog√≠a General',
  'Ortodoncia',
  'Endodoncia',
  'Periodoncia',
  'Cirug√≠a Oral',
  'Pr√≥tesis Dental',
  'Odontopediatr√≠a',
  'Implantolog√≠a',
  'Est√©tica Dental',
];

export default function ProfessionalsView() {
  const [professionals, setProfessionals] = useState<Professional[]>([]);
  const [loading, setLoading] = useState(true);
  const [editingProfessional, setEditingProfessional] = useState<Professional | null>(null);
  const [expandedDays, setExpandedDays] = useState<Record<number, string[]>>({});

  const [formData, setFormData] = useState({
    name: '',
    email: '',
    phone: '',
    specialty: '',
    license_number: '',
    is_active: true,
    availability: createEmptyAvailability(),
  });

  function createEmptyAvailability(): ProfessionalAvailability {
    const availability: ProfessionalAvailability = {} as ProfessionalAvailability;
    DAYS.forEach(day => {
      availability[day.key as keyof ProfessionalAvailability] = [];
    });
    return availability;
  }

  useEffect(() => {
    fetchProfessionals();
  }, []);

  const fetchProfessionals = async () => {
    try {
      setLoading(true);
      const response = await api.get('/admin/professionals');
      setProfessionals(response.data);
    } catch (error) {
      console.error('Error fetching professionals:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      if (editingProfessional) {
        await api.put(`/admin/professionals/${editingProfessional.id}`, formData);
      } else {
        await api.post('/admin/professionals', formData);
      }
      fetchProfessionals();
      closeModal();
    } catch (error) {
      console.error('Error saving professional:', error);
      alert('Error al guardar profesional');
    }
  };

  const handleToggleActive = async (professional: Professional) => {
    try {
      await api.put(`/admin/professionals/${professional.id}`, {
        is_active: !professional.is_active,
      });
      fetchProfessionals();
    } catch (error) {
      console.error('Error toggling active status:', error);
    }
  };

  const openEditModal = (professional: Professional) => {
    setEditingProfessional(professional);
    setFormData({
      name: professional.name,
      email: professional.email || '',
      phone: professional.phone || '',
      specialty: professional.specialty || '',
      license_number: professional.license_number || '',
      is_active: professional.is_active,
      availability: professional.availability || createEmptyAvailability(),
    });
    setExpandedDays({});
  };

  const openCreateModal = () => {
    setEditingProfessional(null);
    setFormData({
      name: '',
      email: '',
      phone: '',
      specialty: '',
      license_number: '',
      is_active: true,
      availability: createEmptyAvailability(),
    });
    setExpandedDays({});
  };

  const closeModal = () => {
    setEditingProfessional(null);
  };

  const toggleDay = (professionalId: number, day: string) => {
    setExpandedDays(prev => {
      const current = prev[professionalId] || [];
      if (current.includes(day)) {
        return { ...prev, [professionalId]: current.filter(d => d !== day) };
      }
      return { ...prev, [professionalId]: [...current, day] };
    });
  };

  const addTimeSlot = (dayKey: string) => {
    setFormData(prev => ({
      ...prev,
      availability: {
        ...prev.availability,
        [dayKey]: [
          ...(prev.availability[dayKey as keyof ProfessionalAvailability] || []),
          { start: '09:00', end: '17:00' }
        ],
      },
    }));
  };

  const removeTimeSlot = (dayKey: string, index: number) => {
    setFormData(prev => ({
      ...prev,
      availability: {
        ...prev.availability,
        [dayKey]: prev.availability[dayKey as keyof ProfessionalAvailability].filter((_, i) => i !== index),
      },
    }));
  };

  const updateTimeSlot = (dayKey: string, index: number, field: 'start' | 'end', value: string) => {
    setFormData(prev => ({
      ...prev,
      availability: {
        ...prev.availability,
        [dayKey]: prev.availability[dayKey as keyof ProfessionalAvailability].map((slot, i) =>
          i === index ? { ...slot, [field]: value } : slot
        ),
      },
    }));
  };

  const getActiveProfessionals = () => professionals.filter(p => p.is_active).length;

  const getTotalSlots = (availability?: ProfessionalAvailability) => {
    if (!availability) return 0;
    return DAYS.reduce((total, day) => {
      return total + (availability[day.key as keyof ProfessionalAvailability]?.length || 0);
    }, 0);
  };

  return (
    <div className="p-6">
      {/* Header */}
      <div className="flex justify-between items-center mb-6">
        <div>
          <h1 className="text-2xl font-bold text-gray-800">Profesionales</h1>
          <p className="text-gray-500">Gesti√≥n del staff m√©dico y disponibilidad</p>
        </div>
        <button
          onClick={openCreateModal}
          className="flex items-center gap-2 bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded-lg transition-colors"
        >
          <Plus size={20} />
          Nuevo Profesional
        </button>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-3 gap-4 mb-6">
        <div className="bg-white rounded-lg shadow p-4">
          <div className="text-sm text-gray-500">Total</div>
          <div className="text-2xl font-bold">{professionals.length}</div>
        </div>
        <div className="bg-white rounded-lg shadow p-4">
          <div className="text-sm text-gray-500">Activos</div>
          <div className="text-2xl font-bold text-green-600">{getActiveProfessionals()}</div>
        </div>
        <div className="bg-white rounded-lg shadow p-4">
          <div className="text-sm text-gray-500">Inactivos</div>
          <div className="text-2xl font-bold text-gray-400">
            {professionals.length - getActiveProfessionals()}
          </div>
        </div>
      </div>

      {/* Professionals List */}
      <div className="bg-white rounded-lg shadow">
        {loading ? (
          <div className="p-8 text-center text-gray-500">Cargando profesionales...</div>
        ) : professionals.length === 0 ? (
          <div className="p-8 text-center text-gray-500">
            No hay profesionales registrados
          </div>
        ) : (
          <div className="divide-y">
            {professionals.map((professional) => (
              <div key={professional.id} className="p-4">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-4">
                    <div className={`w-12 h-12 rounded-full flex items-center justify-center text-white font-bold ${
                      professional.is_active ? 'bg-primary' : 'bg-gray-400'
                    }`}>
                      {professional.name.charAt(0)}
                    </div>
                    <div>
                      <div className="flex items-center gap-2">
                        <h3 className="font-medium text-gray-900">
                          Dr. {professional.name}
                        </h3>
                        {professional.is_active ? (
                          <CheckCircle className="text-green-500" size={16} />
                        ) : (
                          <XCircle className="text-gray-400" size={16} />
                        )}
                      </div>
                      <div className="text-sm text-gray-500">
                        {professional.specialty || 'Sin especialidad'}
                      </div>
                      <div className="flex gap-4 mt-1 text-xs text-gray-400">
                        {professional.email && (
                          <span className="flex items-center gap-1">
                            <Mail size={12} /> {professional.email}
                          </span>
                        )}
                        {professional.phone && (
                          <span className="flex items-center gap-1">
                            <Phone size={12} /> {professional.phone}
                          </span>
                        )}
                      </div>
                    </div>
                  </div>

                  <div className="flex items-center gap-4">
                    <div className="text-right">
                      <div className="flex items-center gap-1 text-sm text-gray-500">
                        <Clock size={14} />
                        {getTotalSlots(professional.availability)} bloques
                      </div>
                    </div>
                    <button
                      onClick={() => openEditModal(professional)}
                      className="p-2 text-gray-600 hover:text-primary hover:bg-gray-100 rounded"
                    >
                      <Edit size={18} />
                    </button>
                    <button
                      onClick={() => handleToggleActive(professional)}
                      className={`p-2 rounded ${
                        professional.is_active
                          ? 'text-gray-600 hover:text-red-600 hover:bg-red-50'
                          : 'text-gray-400 hover:text-green-600 hover:bg-green-50'
                      }`}
                    >
                      {professional.is_active ? <XCircle size={18} /> : <CheckCircle size={18} />}
                    </button>
                  </div>
                </div>

                {/* Availability Preview */}
                {professional.availability && getTotalSlots(professional.availability) > 0 && (
                  <div className="mt-3 ml-16">
                    <button
                      onClick={() => toggleDay(professional.id, 'toggle')}
                      className="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-700"
                    >
                      <Calendar size={14} />
                      Ver disponibilidad
                      {(expandedDays[professional.id] || []).includes('toggle') ? (
                        <ChevronUp size={14} />
                      ) : (
                        <ChevronDown size={14} />
                      )}
                    </button>
                    {(expandedDays[professional.id] || []).includes('toggle') && (
                      <div className="mt-2 flex flex-wrap gap-2">
                        {DAYS.map(day => {
                          const slots = professional.availability?.[day.key as keyof ProfessionalAvailability];
                          if (slots && slots.length > 0) {
                            return (
                              <span key={day.key} className="text-xs bg-secondary text-primary px-2 py-1 rounded">
                                {day.label}: {slots.map(s => `${s.start}-${s.end}`).join(', ')}
                              </span>
                            );
                          }
                          return null;
                        })}
                      </div>
                    )}
                  </div>
                )}
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Modal */}
      {editingProfessional !== null && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
          <div className="bg-white rounded-lg w-full max-w-2xl mx-4 my-8">
            <div className="flex justify-between items-center p-4 border-b sticky top-0 bg-white">
              <h2 className="text-xl font-bold">
                {editingProfessional ? `Editar: Dr. ${editingProfessional.name}` : 'Nuevo Profesional'}
              </h2>
              <button onClick={closeModal} className="text-gray-500 hover:text-gray-700">
                <X size={24} />
              </button>
            </div>

            <form onSubmit={handleSubmit} className="p-4">
              <div className="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Nombre *
                  </label>
                  <input
                    type="text"
                    required
                    value={formData.name}
                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Especialidad
                  </label>
                  <select
                    value={formData.specialty}
                    onChange={(e) => setFormData({ ...formData, specialty: e.target.value })}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                  >
                    <option value="">Seleccionar...</option>
                    {SPECIALTIES.map(spec => (
                      <option key={spec} value={spec}>{spec}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Email
                  </label>
                  <input
                    type="email"
                    value={formData.email}
                    onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Tel√©fono
                  </label>
                  <input
                    type="tel"
                    value={formData.phone}
                    onChange={(e) => setFormData({ ...formData, phone: e.target.value })}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Matr√≠cula
                  </label>
                  <input
                    type="text"
                    value={formData.license_number}
                    onChange={(e) => setFormData({ ...formData, license_number: e.target.value })}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                  />
                </div>
                <div className="flex items-center">
                  <label className="flex items-center gap-2 cursor-pointer">
                    <input
                      type="checkbox"
                      checked={formData.is_active}
                      onChange={(e) => setFormData({ ...formData, is_active: e.target.checked })}
                      className="w-4 h-4 text-primary rounded"
                    />
                    <span className="text-sm font-medium text-gray-700">Profesional activo</span>
                  </label>
                </div>
              </div>

              {/* Availability */}
              <div className="mb-4">
                <h3 className="font-medium text-gray-700 mb-2 flex items-center gap-2">
                  <Clock size={18} />
                  Disponibilidad para Agendamiento
                </h3>
                <p className="text-xs text-gray-500 mb-3">
                  Define los horarios disponibles. El bot de IA usar√° esta informaci√≥n para ofrecer turnos.
                </p>

                <div className="space-y-2">
                  {DAYS.map(day => (
                    <div key={day.key} className="border rounded-lg overflow-hidden">
                      <button
                        type="button"
                        onClick={() => toggleDay(-1, day.key)}
                        className="w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100"
                      >
                        <span className="font-medium text-sm">{day.label}</span>
                        <span className="text-xs text-gray-500">
                          {formData.availability[day.key as keyof ProfessionalAvailability]?.length || 0} bloques
                        </span>
                      </button>
                      <div className="p-3 bg-white">
                        {formData.availability[day.key as keyof ProfessionalAvailability]?.map((slot, index) => (
                          <div key={index} className="flex items-center gap-2 mb-2">
                            <input
                              type="time"
                              value={slot.start}
                              onChange={(e) => updateTimeSlot(day.key, index, 'start', e.target.value)}
                              className="px-2 py-1 border rounded text-sm"
                            />
                            <span className="text-gray-400">-</span>
                            <input
                              type="time"
                              value={slot.end}
                              onChange={(e) => updateTimeSlot(day.key, index, 'end', e.target.value)}
                              className="px-2 py-1 border rounded text-sm"
                            />
                            <button
                              type="button"
                              onClick={() => removeTimeSlot(day.key, index)}
                              className="p-1 text-red-500 hover:bg-red-50 rounded"
                            >
                              <X size={14} />
                            </button>
                          </div>
                        ))}
                        <button
                          type="button"
                          onClick={() => addTimeSlot(day.key)}
                          className="text-xs text-primary hover:underline"
                        >
                          + Agregar bloque horario
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              <div className="flex justify-end gap-3">
                <button
                  type="button"
                  onClick={closeModal}
                  className="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200"
                >
                  Cancelar
                </button>
                <button
                  type="submit"
                  className="px-4 py-2 text-white bg-primary rounded-lg hover:bg-primary-dark flex items-center gap-2"
                >
                  <Save size={18} />
                  Guardar
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
}
````

## File: frontend_react/src/views/Setup.tsx
````typescript
import React, { useState } from 'react';
import { useApi } from '../hooks/useApi';
import { ArrowRight, ArrowLeft, CheckCircle, Smartphone, ShoppingBag, Send } from 'lucide-react';

export const Setup: React.FC = () => {
    const { fetchApi, loading } = useApi();
    const [currentStep, setCurrentStep] = useState(1);
    const [formData, setFormData] = useState({
        bot_phone_number: '',
        store_name: '',
        store_website: '',
        tiendanube_store_id: '',
        tiendanube_token: ''
    });
    const [testResult, setTestResult] = useState<any>(null);

    const handleNext = async () => {
        setTestResult(null);
        if (currentStep === 1) {
            // Validate step 1?
        }
        if (currentStep === 2) {
            // Validate step 2
        }
        if (currentStep < 5) setCurrentStep(c => c + 1);
        else {
            // Finalize
            alert('Setup Completo!');
            window.location.href = '/';
        }
    };

    const handlePrev = () => {
        setTestResult(null);
        if (currentStep > 1) setCurrentStep(c => c - 1);
    };

    const runTest = async (step: number) => {
        try {
            setTestResult({ status: 'loading', message: 'Probando...' });

            if (step === 3) {
                // Create storee if needed
                const payload = {
                    store_name: formData.store_name,
                    bot_phone_number: formData.bot_phone_number,
                    store_website: formData.store_website,
                    tiendanube_store_id: formData.tiendanube_store_id,
                    tiendanube_access_token: formData.tiendanube_token
                };
                await fetchApi('/admin/tenants', { method: 'POST', body: payload });
                setTestResult({ status: 'success', message: 'Tienda creada/actualizada correctamente.' });
            } else if (step === 4) {
                await fetchApi('/admin/diagnostics/healthz');
                setTestResult({ status: 'success', message: 'Conexi√≥n con Orquestador: OK' });
            } else if (step === 5) {
                // Send test msg
                await fetchApi(`/admin/tenants/${formData.bot_phone_number}/test-message`, { method: 'POST' });
                setTestResult({ status: 'success', message: 'Mensaje enviado a tu WhatsApp.' });
            }

        } catch (e) {
            setTestResult({ status: 'error', message: e.message });
        }
    };

    return (
        <div className="view active">
            <h1 className="view-title">Asistente de Configuraci√≥n</h1>

            <div className="glass" style={{ padding: '40px', maxWidth: '800px', margin: '0 auto' }}>
                {/* Progress Bar */}
                <div style={{ marginBottom: '40px' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px' }}>
                        {[1, 2, 3, 4, 5].map(step => (
                            <div key={step} style={{
                                width: '30px', height: '30px', borderRadius: '50%',
                                background: step <= currentStep ? 'var(--accent)' : 'rgba(255,255,255,0.1)',
                                display: 'flex', alignItems: 'center', justifyContent: 'center',
                                fontSize: '14px', fontWeight: 'bold'
                            }}>
                                {step < currentStep ? <CheckCircle size={16} /> : step}
                            </div>
                        ))}
                    </div>
                    <div style={{ height: '4px', background: 'rgba(255,255,255,0.1)', borderRadius: '2px' }}>
                        <div style={{ height: '100%', width: `${((currentStep - 1) / 4) * 100}%`, background: 'var(--accent)', transition: 'width 0.3s' }}></div>
                    </div>
                </div>

                <div className="setup-content" style={{ minHeight: '300px' }}>
                    {currentStep === 1 && (
                        <div className="fade-in">
                            <h2 style={{ marginBottom: '20px' }}>Crear Tienda</h2>
                            <p style={{ color: '#a1a1aa', marginBottom: '30px' }}>Configura los datos b√°sicos de tu primera tienda.</p>
                            <div className="form-group">
                                <label>N√∫mero de WhatsApp (Bot)</label>
                                <div style={{ position: 'relative' }}>
                                    <Smartphone size={18} style={{ position: 'absolute', top: '14px', left: '12px', color: '#a1a1aa' }} />
                                    <input style={{ paddingLeft: '40px' }} value={formData.bot_phone_number} onChange={e => setFormData({ ...formData, bot_phone_number: e.target.value })} placeholder="54911..." />
                                </div>
                            </div>
                            <div className="form-group">
                                <label>Nombre de la Tienda</label>
                                <div style={{ position: 'relative' }}>
                                    <ShoppingBag size={18} style={{ position: 'absolute', top: '14px', left: '12px', color: '#a1a1aa' }} />
                                    <input style={{ paddingLeft: '40px' }} value={formData.store_name} onChange={e => setFormData({ ...formData, store_name: e.target.value })} placeholder="Mi Tienda" />
                                </div>
                            </div>
                            <div className="form-group">
                                <label>Sitio Web</label>
                                <input value={formData.store_website} onChange={e => setFormData({ ...formData, store_website: e.target.value })} placeholder="https://..." />
                            </div>
                        </div>
                    )}

                    {currentStep === 2 && (
                        <div className="fade-in">
                            <h2 style={{ marginBottom: '20px' }}>Conectar Tienda Nube</h2>
                            <p style={{ color: '#a1a1aa', marginBottom: '30px' }}>Ingresa tus credenciales de Tienda Nube para sincronizar el cat√°logo.</p>
                            <div className="form-group">
                                <label>ID de Tienda</label>
                                <input value={formData.tiendanube_store_id} onChange={e => setFormData({ ...formData, tiendanube_store_id: e.target.value })} placeholder="123456" />
                            </div>
                            <div className="form-group">
                                <label>Access Token</label>
                                <input type="password" value={formData.tiendanube_token} onChange={e => setFormData({ ...formData, tiendanube_token: e.target.value })} placeholder="Token API" />
                            </div>
                        </div>
                    )}

                    {currentStep === 3 && (
                        <div className="fade-in">
                            <h2 style={{ marginBottom: '20px' }}>Guardar Configuraci√≥n</h2>
                            <p style={{ color: '#a1a1aa', marginBottom: '30px' }}>Vamos a guardar tu tienda en la base de datos.</p>
                            <button className="btn-secondary" onClick={() => runTest(3)} disabled={loading}>
                                {loading ? 'Guardando...' : 'Guardar y Verificar'}
                            </button>
                        </div>
                    )}

                    {currentStep === 4 && (
                        <div className="fade-in">
                            <h2 style={{ marginBottom: '20px' }}>Verificar Servicios</h2>
                            <p style={{ color: '#a1a1aa', marginBottom: '30px' }}>Comprobando estado del sistema...</p>
                            <button className="btn-secondary" onClick={() => runTest(4)} disabled={loading}>
                                {loading ? 'Verificando...' : 'Verificar Salud'}
                            </button>
                        </div>
                    )}

                    {currentStep === 5 && (
                        <div className="fade-in">
                            <h2 style={{ marginBottom: '20px' }}>Prueba Final</h2>
                            <p style={{ color: '#a1a1aa', marginBottom: '30px' }}>Enviaremos un mensaje de prueba a tu WhatsApp: {formData.bot_phone_number}</p>
                            <button className="btn-primary" onClick={() => runTest(5)} disabled={loading}>
                                <Send size={18} style={{ marginRight: '8px' }} />
                                {loading ? 'Enviando...' : 'Enviar Mensaje de Prueba'}
                            </button>
                        </div>
                    )}

                    {testResult && (
                        <div className={`preflight-check ${testResult.status === 'success' ? 'check-pass' : 'check-fail'}`} style={{ marginTop: '20px' }}>
                            <div className="check-header">
                                <span className="check-name">{testResult.message}</span>
                            </div>
                        </div>
                    )}

                </div>

                <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '40px', paddingTop: '20px', borderTop: '1px solid rgba(255,255,255,0.1)' }}>
                    <button className="btn-secondary" onClick={handlePrev} disabled={currentStep === 1} style={{ display: currentStep === 1 ? 'none' : 'flex', alignItems: 'center', gap: '8px' }}>
                        <ArrowLeft size={18} /> Anterior
                    </button>
                    <button className="btn-primary" onClick={handleNext} style={{ display: 'flex', alignItems: 'center', gap: '8px', marginLeft: 'auto' }}>
                        {currentStep === 5 ? 'Finalizar' : 'Siguiente'} <ArrowRight size={18} />
                    </button>
                </div>
            </div>
        </div>
    );
};
````

## File: frontend_react/src/views/Stores.tsx
````typescript
import React, { useEffect, useState } from 'react';
import { useApi } from '../hooks/useApi';
import { Modal } from '../components/Modal';
import { Store, ShoppingBag, Plus, Trash2, Edit2, CheckCircle, XCircle } from 'lucide-react';

interface Tenant {
    id?: number;
    store_name: string;
    bot_phone_number: string;
    tiendanube_store_id?: string;
    tiendanube_access_token?: string;
    owner_email?: string;
    store_website?: string;
}

export const Stores: React.FC = () => {
    const { fetchApi } = useApi();
    const [tenants, setTenants] = useState<Tenant[]>([]);
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [editingTenant, setEditingTenant] = useState<Tenant | null>(null);

    const [formData, setFormData] = useState<Tenant>({
        store_name: '',
        bot_phone_number: '',
        tiendanube_store_id: '',
        tiendanube_access_token: '',
        owner_email: '',
        store_website: ''
    });

    const loadTenants = async () => {
        try {
            const data = await fetchApi('/admin/tenants');
            setTenants(data);
        } catch (e) {
            console.error(e);
        }
    };

    useEffect(() => {
        loadTenants();
    }, []);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        try {
            await fetchApi('/admin/tenants', { method: 'POST', body: formData });
            setIsModalOpen(false);
            loadTenants();
        } catch (e) {
            alert('Error al guardar tienda: ' + e.message);
        }
    };

    const handleDelete = async (phone: string) => {
        if (!confirm('¬øEliminar tienda y todos sus datos?')) return;
        try {
            await fetchApi(`/admin/tenants/${phone}`, { method: 'DELETE' });
            loadTenants();
        } catch (e) {
            alert('Error al eliminar: ' + e.message);
        }
    }

    const openEdit = (tenant: Tenant) => {
        setEditingTenant(tenant);
        setFormData(tenant);
        setIsModalOpen(true);
    };

    const openNew = () => {
        setEditingTenant(null);
        setFormData({
            store_name: '',
            bot_phone_number: '',
            tiendanube_store_id: '',
            tiendanube_access_token: '',
            owner_email: '',
            store_website: ''
        });
        setIsModalOpen(true);
    };


    return (
        <div className="view active">
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '30px' }}>
                <h1 className="view-title" style={{ margin: 0 }}>Mis Tiendas</h1>
                <button className="btn-primary" onClick={openNew}>
                    <Plus size={18} style={{ marginRight: '8px' }} />
                    Nueva Tienda
                </button>
            </div>

            <div className="glass">
                <div className="table-responsive">
                    <table className="data-table">
                        <thead>
                            <tr>
                                <th>Tienda / Due√±o</th>
                                <th>WhatsApp Bot</th>
                                <th>Tienda Nube ID</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {tenants.map(t => (
                                <tr key={t.id || t.bot_phone_number}>
                                    <td>
                                        <div style={{ fontWeight: 600, display: 'flex', alignItems: 'center', gap: '8px' }}>
                                            <ShoppingBag size={14} color="var(--accent)" /> {t.store_name}
                                        </div>
                                        <div style={{ fontSize: '11px', color: '#a1a1aa', marginLeft: '22px' }}>{t.owner_email || 'Sin email'}</div>
                                    </td>
                                    <td>{t.bot_phone_number}</td>
                                    <td>{t.tiendanube_store_id || 'N/A'}</td>
                                    <td>
                                        {t.tiendanube_store_id ? (
                                            <span className="service-pill ok"><CheckCircle size={10} /> Conectado</span>
                                        ) : (
                                            <span className="service-pill error"><XCircle size={10} /> Sin Configurar</span>
                                        )}
                                    </td>
                                    <td>
                                        <div style={{ display: 'flex', gap: '8px' }}>
                                            <button className="btn-secondary" style={{ padding: '6px' }} onClick={() => openEdit(t)} title="Editar"><Edit2 size={14} /></button>
                                            <button className="btn-delete" style={{ padding: '6px' }} onClick={() => handleDelete(t.bot_phone_number)} title="Eliminar"><Trash2 size={14} /></button>
                                        </div>
                                    </td>
                                </tr>
                            ))}
                            {tenants.length === 0 && (
                                <tr>
                                    <td colSpan={5} style={{ textAlign: 'center', padding: '40px', color: '#666' }}>
                                        No tienes tiendas configuradas. ¬°Agrega la primera!
                                    </td>
                                </tr>
                            )}
                        </tbody>
                    </table>
                </div>
            </div>

            <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title={editingTenant ? 'Editar Tienda' : 'Nueva Tienda'}>
                <form onSubmit={handleSubmit}>
                    <div className="form-grid">
                        <div className="form-group">
                            <label>Nombre de la Tienda</label>
                            <input required value={formData.store_name} onChange={e => setFormData({ ...formData, store_name: e.target.value })} placeholder="Ej: Mi E-commerce" />
                        </div>
                        <div className="form-group">
                            <label>Tel√©fono del Bot (WhatsApp)</label>
                            <input required value={formData.bot_phone_number} onChange={e => setFormData({ ...formData, bot_phone_number: e.target.value })} placeholder="Ej: 54911..." />
                        </div>
                    </div>

                    <h4 style={{ color: 'var(--accent)', margin: '20px 0 10px', fontSize: '14px' }}>Integraci√≥n Tienda Nube</h4>
                    <div className="form-grid">
                        <div className="form-group">
                            <label>Store ID</label>
                            <input type="number" value={formData.tiendanube_store_id} onChange={e => setFormData({ ...formData, tiendanube_store_id: e.target.value })} placeholder="123456" />
                        </div>
                        <div className="form-group">
                            <label>Access Token</label>
                            <input type="password" value={formData.tiendanube_access_token} onChange={e => setFormData({ ...formData, tiendanube_access_token: e.target.value })} placeholder="Token de API" />
                        </div>
                    </div>

                    <div className="form-group" style={{ marginTop: '20px' }}>
                        <label>Email del Due√±o</label>
                        <input value={formData.owner_email} onChange={e => setFormData({ ...formData, owner_email: e.target.value })} placeholder="admin@store.com" />
                    </div>

                    <div className="form-group">
                        <label>Website URL</label>
                        <input value={formData.store_website} onChange={e => setFormData({ ...formData, store_website: e.target.value })} placeholder="https://..." />
                    </div>

                    <div style={{ marginTop: '30px', display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                        <button type="button" className="btn-secondary" onClick={() => setIsModalOpen(false)}>Cancelar</button>
                        <button type="submit" className="btn-primary">Guardar Tienda</button>
                    </div>
                </form>
            </Modal>
        </div>
    );
};
````

## File: frontend_react/src/views/Tools.tsx
````typescript
import React, { useEffect, useState } from 'react';
import { useApi } from '../hooks/useApi';
import { Modal } from '../components/Modal';
import { Wrench, Plus, Settings } from 'lucide-react';

interface Tool {
    name: string;
    type: string;
    service_url?: string;
    config?: any;
}

export const Tools: React.FC = () => {
    const { fetchApi } = useApi();
    const [tools, setTools] = useState<Tool[]>([]);
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [formData, setFormData] = useState<Tool>({ name: '', type: 'http', service_url: '', config: {} });

    const loadTools = async () => {
        try {
            const data = await fetchApi('/admin/tools');
            setTools(data || []);
        } catch (e) {
            console.error(e);
        }
    };

    useEffect(() => {
        loadTools();
    }, []);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        try {
            await fetchApi('/admin/tools', { method: 'POST', body: formData });
            setIsModalOpen(false);
            loadTools();
        } catch (e) {
            alert('Error al guardar herramienta');
        }
    };

    return (
        <div className="view active">
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                <h1 className="view-title" style={{ margin: 0 }}>Herramientas Disponibles</h1>
                <button className="btn-primary" onClick={() => setIsModalOpen(true)}>
                    <Plus size={18} style={{ marginRight: '8px' }} />
                    Nueva Herramienta
                </button>
            </div>

            <div className="glass">
                <table className="data-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Tipo</th>
                            <th>URL de Servicio</th>
                            <th>Configuraci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        {tools.map((t, i) => (
                            <tr key={i}>
                                <td style={{ fontWeight: 600 }}>{t.name}</td>
                                <td><span className="badge type">{t.type}</span></td>
                                <td style={{ fontSize: '12px', color: '#a1a1aa' }}>{t.service_url || 'N/A'}</td>
                                <td>
                                    <button className="btn-secondary" style={{ padding: '4px 8px', fontSize: '11px' }}>
                                        <Settings size={12} style={{ marginRight: '4px' }} /> Configurar
                                    </button>
                                </td>
                            </tr>
                        ))}
                        {tools.length === 0 && (
                            <tr>
                                <td colSpan={4} style={{ textAlign: 'center', padding: '30px', color: '#666' }}>
                                    No hay herramientas configuradas. Las herramientas permiten extender las capacidades de la IA.
                                </td>
                            </tr>
                        )}
                    </tbody>
                </table>
            </div>

            <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title="Nueva Herramienta">
                <form onSubmit={handleSubmit}>
                    <div className="form-group">
                        <label>Nombre de la Herramienta</label>
                        <input required value={formData.name} onChange={e => setFormData({ ...formData, name: e.target.value })} placeholder="Ej: Buscador de Productos" />
                    </div>
                    <div className="form-group">
                        <label>Tipo</label>
                        <select value={formData.type} onChange={e => setFormData({ ...formData, type: e.target.value })}>
                            <option value="http">HTTP Request (API)</option>
                            <option value="tienda_nube">Tienda Nube Action</option>
                            <option value="function">Function Call</option>
                        </select>
                    </div>
                    {formData.type === 'http' && (
                        <div className="form-group">
                            <label>Service URL</label>
                            <input value={formData.service_url} onChange={e => setFormData({ ...formData, service_url: e.target.value })} placeholder="https://api.example.com/v1/search" />
                        </div>
                    )}
                    <div style={{ marginTop: '30px', display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                        <button type="button" className="btn-secondary" onClick={() => setIsModalOpen(false)}>Cancelar</button>
                        <button type="submit" className="btn-primary">Crear Herramienta</button>
                    </div>
                </form>
            </Modal>
        </div>
    );
};
````

## File: frontend_react/src/views/TreatmentsView.tsx
````typescript
import { useState, useEffect } from 'react';
import { Clock, AlertCircle, CheckCircle, Edit2, Save, X, Zap, Shield, Heart, Activity, Stethoscope } from 'lucide-react';
import api from '../api/axios';

interface TreatmentType {
  id: number;
  code: string;
  name: string;
  description: string;
  default_duration_minutes: number;
  min_duration_minutes: number;
  max_duration_minutes: number;
  complexity_level: string;
  category: string;
  requires_multiple_sessions: boolean;
  session_gap_days: number;
  is_active: boolean;
  is_available_for_booking: boolean;
  internal_notes: string;
}

// Category icons mapping
const categoryIcons: Record<string, React.ReactNode> = {
  prevention: <Heart size={16} className="text-green-600" />,
  restorative: <Activity size={16} className="text-blue-600" />,
  surgical: <Zap size={16} className="text-red-600" />,
  orthodontics: <Shield size={16} className="text-purple-600" />,
  emergency: <AlertCircle size={16} className="text-orange-600" />,
};

// Complexity colors
const complexityColors: Record<string, { bg: string; text: string }> = {
  low: { bg: 'bg-green-100', text: 'text-green-800' },
  medium: { bg: 'bg-yellow-100', text: 'text-yellow-800' },
  high: { bg: 'bg-red-100', text: 'text-red-800' },
  emergency: { bg: 'bg-orange-100', text: 'text-orange-800' },
};

export default function TreatmentsView() {
  const [treatments, setTreatments] = useState<TreatmentType[]>([]);
  const [loading, setLoading] = useState(true);
  const [editingId, setEditingId] = useState<number | null>(null);
  const [editForm, setEditForm] = useState<Partial<TreatmentType>>({});
  const [saving, setSaving] = useState(false);

  const fetchTreatments = async () => {
    try {
      setLoading(true);
      const response = await api.get('/admin/treatment-types');
      setTreatments(response.data);
    } catch (error) {
      console.error('Error fetching treatments:', error);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchTreatments();
  }, []);

  const handleEdit = (treatment: TreatmentType) => {
    setEditingId(treatment.id);
    setEditForm({ ...treatment });
  };

  const handleCancel = () => {
    setEditingId(null);
    setEditForm({});
  };

  const handleSave = async (code: string) => {
    if (!editForm.code) return;
    
    try {
      setSaving(true);
      await api.put(`/admin/treatment-types/${code}`, {
        name: editForm.name,
        description: editForm.description,
        default_duration_minutes: editForm.default_duration_minutes,
        min_duration_minutes: editForm.min_duration_minutes,
        max_duration_minutes: editForm.max_duration_minutes,
        complexity_level: editForm.complexity_level,
        category: editForm.category,
        requires_multiple_sessions: editForm.requires_multiple_sessions,
        session_gap_days: editForm.session_gap_days,
        is_active: editForm.is_active,
        is_available_for_booking: editForm.is_available_for_booking,
        internal_notes: editForm.internal_notes,
      });
      
      await fetchTreatments();
      setEditingId(null);
      setEditForm({});
    } catch (error) {
      console.error('Error saving treatment:', error);
      alert('Error al guardar cambios');
    } finally {
      setSaving(false);
    }
  };

  const handleDurationChange = (field: 'min' | 'default' | 'max', value: string) => {
    const numValue = parseInt(value) || 0;
    setEditForm(prev => ({
      ...prev,
      [field === 'min' ? 'min_duration_minutes' : field === 'default' ? 'default_duration_minutes' : 'max_duration_minutes']: numValue
    }));
  };

  // Group treatments by category
  const groupedTreatments = treatments.reduce((acc, treatment) => {
    if (!acc[treatment.category]) {
      acc[treatment.category] = [];
    }
    acc[treatment.category].push(treatment);
    return acc;
  }, {} as Record<string, TreatmentType[]>);

  return (
    <div className="p-6">
      {/* Header */}
      <div className="mb-6">
        <h1 className="text-2xl font-bold text-gray-800">Configuraci√≥n de Tratamientos</h1>
        <p className="text-gray-500">Definir duraciones y complejidad para agENDAMIENTO inteligente</p>
      </div>

      {/* Quick Reference */}
      <div className="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <h3 className="font-medium text-blue-800 mb-2">üìã Duraciones Recomendadas</h3>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
          <div className="flex items-center gap-2">
            <Clock size={16} className="text-blue-600" />
            <span className="text-blue-700">Consulta Urgente: <strong>15 min</strong></span>
          </div>
          <div className="flex items-center gap-2">
            <Clock size={16} className="text-green-600" />
            <span className="text-green-700">Limpieza: <strong>30 min</strong></span>
          </div>
          <div className="flex items-center gap-2">
            <Clock size={16} className="text-red-600" />
            <span className="text-red-700">Endodoncia: <strong>60 min</strong></span>
          </div>
        </div>
      </div>

      {/* Treatments by Category */}
      {loading ? (
        <div className="p-8 text-center text-gray-500">
          <div className="animate-spin inline-block w-8 h-8 border-4 border-primary border-t-transparent rounded-full mb-4 mx-auto"></div>
          <p>Cargando configuraciones...</p>
        </div>
      ) : (
        <div className="space-y-6">
          {Object.entries(groupedTreatments).map(([category, categoryTreatments]) => (
            <div key={category} className="bg-white rounded-lg shadow">
              <div className="p-4 border-b bg-gray-50 flex items-center gap-2">
                {categoryIcons[category] || <Stethoscope size={16} className="text-gray-600" />}
                <h2 className="font-semibold text-gray-700 capitalize">{category}</h2>
                <span className="text-sm text-gray-500">({categoryTreatments.length} tratamientos)</span>
              </div>
              
              <div className="divide-y">
                {categoryTreatments.map((treatment) => (
                  <div key={treatment.id} className="p-4">
                    {editingId === treatment.id ? (
                      // Edit Mode
                      <div className="space-y-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                            <input
                              type="text"
                              value={editForm.name || ''}
                              onChange={(e) => setEditForm({ ...editForm, name: e.target.value })}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">C√≥digo</label>
                            <input
                              type="text"
                              value={editForm.code || ''}
                              disabled
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100"
                            />
                          </div>
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n</label>
                          <textarea
                            value={editForm.description || ''}
                            onChange={(e) => setEditForm({ ...editForm, description: e.target.value })}
                            rows={2}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                          />
                        </div>

                        {/* Duration Settings */}
                        <div className="p-4 bg-yellow-50 rounded-lg">
                          <h4 className="font-medium text-yellow-800 mb-3 flex items-center gap-2">
                            <Clock size={16} />
                            Configuraci√≥n de Duraci√≥n (minutos)
                          </h4>
                          <div className="grid grid-cols-3 gap-4">
                            <div>
                              <label className="block text-xs text-yellow-700 mb-1">M√≠nima</label>
                              <input
                                type="number"
                                value={editForm.min_duration_minutes || ''}
                                onChange={(e) => handleDurationChange('min', e.target.value)}
                                className="w-full px-3 py-2 border border-yellow-300 rounded-lg"
                              />
                            </div>
                            <div>
                              <label className="block text-xs text-yellow-700 mb-1 font-medium">Por Defecto</label>
                              <input
                                type="number"
                                value={editForm.default_duration_minutes || ''}
                                onChange={(e) => handleDurationChange('default', e.target.value)}
                                className="w-full px-3 py-2 border border-yellow-400 rounded-lg font-medium"
                              />
                            </div>
                            <div>
                              <label className="block text-xs text-yellow-700 mb-1">M√°xima</label>
                              <input
                                type="number"
                                value={editForm.max_duration_minutes || ''}
                                onChange={(e) => handleDurationChange('max', e.target.value)}
                                className="w-full px-3 py-2 border border-yellow-300 rounded-lg"
                              />
                            </div>
                          </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Complejidad</label>
                            <select
                              value={editForm.complexity_level || 'medium'}
                              onChange={(e) => setEditForm({ ...editForm, complexity_level: e.target.value })}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                            >
                              <option value="low">Baja</option>
                              <option value="medium">Media</option>
                              <option value="high">Alta</option>
                              <option value="emergency">Urgencia</option>
                            </select>
                          </div>
                          <div className="flex items-center">
                            <label className="flex items-center gap-2 cursor-pointer">
                              <input
                                type="checkbox"
                                checked={editForm.requires_multiple_sessions || false}
                                onChange={(e) => setEditForm({ ...editForm, requires_multiple_sessions: e.target.checked })}
                                className="w-4 h-4 text-primary border-gray-300 rounded"
                              />
                              <span className="text-sm text-gray-700">Requiere m√∫ltiples sesiones</span>
                            </label>
                          </div>
                          <div className="flex items-center gap-4">
                            <label className="flex items-center gap-2 cursor-pointer">
                              <input
                                type="checkbox"
                                checked={editForm.is_active || false}
                                onChange={(e) => setEditForm({ ...editForm, is_active: e.target.checked })}
                                className="w-4 h-4 text-primary border-gray-300 rounded"
                              />
                              <span className="text-sm text-gray-700">Activo</span>
                            </label>
                            <label className="flex items-center gap-2 cursor-pointer">
                              <input
                                type="checkbox"
                                checked={editForm.is_available_for_booking || false}
                                onChange={(e) => setEditForm({ ...editForm, is_available_for_booking: e.target.checked })}
                                className="w-4 h-4 text-primary border-gray-300 rounded"
                              />
                              <span className="text-sm text-gray-700">Disponible</span>
                            </label>
                          </div>
                        </div>

                        <div className="flex justify-end gap-3">
                          <button
                            onClick={handleCancel}
                            className="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 flex items-center gap-2"
                          >
                            <X size={18} />
                            Cancelar
                          </button>
                          <button
                            onClick={() => handleSave(treatment.code)}
                            disabled={saving}
                            className="px-4 py-2 text-white bg-primary rounded-lg hover:bg-primary-dark flex items-center gap-2"
                          >
                            <Save size={18} />
                            {saving ? 'Guardando...' : 'Guardar'}
                          </button>
                        </div>
                      </div>
                    ) : (
                      // View Mode
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className="flex items-center gap-3 mb-2">
                            <h3 className="font-medium text-gray-800">{treatment.name}</h3>
                            <span className={`inline-flex px-2 py-0.5 rounded text-xs font-medium ${complexityColors[treatment.complexity_level]?.bg} ${complexityColors[treatment.complexity_level]?.text}`}>
                              {treatment.complexity_level}
                            </span>
                            {treatment.requires_multiple_sessions && (
                              <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs bg-purple-100 text-purple-800">
                                <CheckCircle size={12} />
                                M√∫ltiples sesiones
                              </span>
                            )}
                          </div>
                          
                          {treatment.description && (
                            <p className="text-sm text-gray-600 mb-3">{treatment.description}</p>
                          )}
                          
                          <div className="flex items-center gap-6 text-sm">
                            <div className="flex items-center gap-2">
                              <Clock size={14} className="text-gray-400" />
                              <span className="text-gray-600">
                                <strong>{treatment.default_duration_minutes}</strong> min (por defecto)
                              </span>
                            </div>
                            <div className="text-gray-400">|</div>
                            <div className="text-gray-500">
                              Rango: {treatment.min_duration_minutes} - {treatment.max_duration_minutes} min
                            </div>
                            {treatment.session_gap_days > 0 && (
                              <>
                                <div className="text-gray-400">|</div>
                                <div className="text-gray-500">
                                  {treatment.session_gap_days} d√≠as entre sesiones
                                </div>
                              </>
                            )}
                          </div>
                          
                          <div className="flex items-center gap-4 mt-3">
                            <span className={`inline-flex items-center gap-1 px-2 py-1 rounded text-xs ${
                              treatment.is_active ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'
                            }`}>
                              {treatment.is_active ? 'Activo' : 'Inactivo'}
                            </span>
                            <span className={`inline-flex items-center gap-1 px-2 py-1 rounded text-xs ${
                              treatment.is_available_for_booking ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-500'
                            }`}>
                              {treatment.is_available_for_booking ? 'Disponible' : 'No disponible'}
                            </span>
                          </div>
                        </div>
                        
                        <button
                          onClick={() => handleEdit(treatment)}
                          className="p-2 text-gray-500 hover:text-primary hover:bg-gray-100 rounded-lg transition-colors"
                          title="Editar configuraci√≥n"
                        >
                          <Edit2 size={18} />
                        </button>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </div>
          ))}
        </div>
      )}

      {/* Empty State */}
      {!loading && treatments.length === 0 && (
        <div className="p-8 text-center text-gray-500 bg-white rounded-lg shadow">
          <AlertCircle size={48} className="mx-auto mb-4 text-gray-300" />
          <p>No hay configuraciones de tratamientos disponibles.</p>
          <p className="text-sm mt-2">Ejecuta la migraci√≥n 006_treatment_config.sql para crear los tratamientos por defecto.</p>
        </div>
      )}
    </div>
  );
}
````

## File: frontend_react/src/views/UserApprovalView.tsx
````typescript
import React, { useState, useEffect } from 'react';
import api from '../api/axios';
import { UserCheck, UserX, Clock, ShieldCheck, Mail, AlertTriangle } from 'lucide-react';

interface PendingUser {
    id: string;
    email: string;
    role: string;
    status: string;
    created_at: string;
}

const UserApprovalView: React.FC = () => {
    const [users, setUsers] = useState<PendingUser[]>([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);

    useEffect(() => {
        fetchPendingUsers();
    }, []);

    const fetchPendingUsers = async () => {
        try {
            setLoading(true);
            // Backend should have an endpoint for this. Assuming /admin/users/pending
            const response = await api.get('/admin/users/pending');
            setUsers(response.data);
        } catch (err: any) {
            setError("No se pudieron cargar los usuarios pendientes. Aseg√∫rese de tener permisos de CEO.");
        } finally {
            setLoading(false);
        }
    };

    const handleAction = async (userId: string, action: 'active' | 'suspended') => {
        try {
            await api.post(`/admin/users/${userId}/status`, { status: action });
            setUsers(users.filter(u => u.id !== userId));
        } catch (err: any) {
            alert("Error al procesar la solicitud.");
        }
    };

    if (loading) return <div className="p-6">Cargando usuarios...</div>;

    return (
        <div className="view active p-6">
            <div className="flex justify-between items-center mb-8">
                <div>
                    <h1 className="view-title flex items-center gap-3">
                        <ShieldCheck color="var(--accent)" />
                        Aprobaci√≥n de Usuarios
                    </h1>
                    <p className="text-secondary">Gestione las solicitudes de acceso a la plataforma.</p>
                </div>
            </div>

            {error ? (
                <div className="glass p-6 text-center border-red-500/20">
                    <AlertTriangle color="#ff4d4d" size={48} className="mx-auto mb-4" />
                    <p className="text-red-400">{error}</p>
                </div>
            ) : users.length === 0 ? (
                <div className="glass p-12 text-center">
                    <Clock size={48} className="mx-auto mb-4 opacity-50" />
                    <h3 className="text-xl font-medium mb-2">No hay solicitudes pendientes</h3>
                    <p className="text-secondary">Todos los usuarios han sido procesados.</p>
                </div>
            ) : (
                <div className="grid gap-4">
                    {users.map(user => (
                        <div key={user.id} className="glass p-5 flex items-center justify-between animate-fadeIn">
                            <div className="flex items-center gap-4">
                                <div className="role-badge" data-role={user.role}>
                                    {user.role.toUpperCase()}
                                </div>
                                <div>
                                    <div className="font-medium flex items-center gap-2">
                                        <Mail size={14} className="opacity-50" />
                                        {user.email}
                                    </div>
                                    <div className="text-sm text-secondary">
                                        Solicitado: {new Date(user.created_at).toLocaleDateString()}
                                    </div>
                                </div>
                            </div>

                            <div className="flex gap-2">
                                <button
                                    onClick={() => handleAction(user.id, 'active')}
                                    className="btn-icon-labeled success"
                                >
                                    <UserCheck size={18} />
                                    Aprobar
                                </button>
                                <button
                                    onClick={() => handleAction(user.id, 'suspended')}
                                    className="btn-icon-labeled danger"
                                >
                                    <UserX size={18} />
                                    Rechazar
                                </button>
                            </div>
                        </div>
                    ))}
                </div>
            )}

            <style>{`
        .role-badge {
          padding: 4px 10px;
          border-radius: 8px;
          font-size: 0.7rem;
          font-weight: 700;
          background: rgba(255,255,255,0.05);
          letter-spacing: 0.5px;
        }
        .role-badge[data-role='ceo'] { color: #ffc107; background: rgba(255,193,7,0.1); }
        .role-badge[data-role='professional'] { color: var(--accent); background: rgba(var(--accent-rgb), 0.1); }
        .role-badge[data-role='secretary'] { color: #4dff8c; background: rgba(77,255,140,0.1); }

        .btn-icon-labeled {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 8px 16px;
          border-radius: 10px;
          font-size: 0.9rem;
          font-weight: 500;
          border: 1px solid rgba(255,255,255,0.1);
          background: rgba(255,255,255,0.05);
          transition: all 0.3s;
          color: white;
        }
        .btn-icon-labeled:hover {
          background: rgba(255,255,255,0.1);
          transform: translateY(-1px);
        }
        .btn-icon-labeled.success:hover {
          border-color: #4dff8c;
          color: #4dff8c;
          background: rgba(77,255,140,0.05);
        }
        .btn-icon-labeled.danger:hover {
          border-color: #ff4d4d;
          color: #ff4d4d;
          background: rgba(255,77,77,0.05);
        }
        .animate-fadeIn {
          animation: fadeIn 0.4s ease-out;
        }
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
      `}</style>
        </div>
    );
};

export default UserApprovalView;
````

## File: frontend_react/src/App.tsx
````typescript
import { BrowserRouter as Router, Routes, Route, Navigate } from 'react-router-dom';
import { Layout } from './components/Layout';
import { Dashboard } from './views/Dashboard';
import AgendaView from './views/AgendaView';
import PatientsView from './views/PatientsView';
import PatientDetail from './views/PatientDetail';
import ProfessionalsView from './views/ProfessionalsView';
import ChatsView from './views/ChatsView';
import TreatmentsView from './views/TreatmentsView';
import LoginView from './views/LoginView';
import UserApprovalView from './views/UserApprovalView';
import { AuthProvider } from './context/AuthContext';
import ProtectedRoute from './components/ProtectedRoute';

function App() {
  return (
    <Router>
      <AuthProvider>
        <Routes>
          <Route path="/login" element={<LoginView />} />

          <Route path="/*" element={
            <ProtectedRoute>
              <Layout>
                <Routes>
                  <Route index element={<Dashboard />} />
                  <Route path="agenda" element={<AgendaView />} />
                  <Route path="pacientes" element={<PatientsView />} />
                  <Route path="pacientes/:id" element={<PatientDetail />} />
                  <Route path="chats" element={<ChatsView />} />
                  <Route path="profesionales" element={<ProfessionalsView />} />
                  <Route path="tratamientos" element={<TreatmentsView />} />
                  <Route path="aprobaciones" element={
                    <ProtectedRoute allowedRoles={['ceo']}>
                      <UserApprovalView />
                    </ProtectedRoute>
                  } />
                  <Route path="configuracion" element={<div className="p-6"><h1 className="text-2xl font-bold">Configuraci√≥n</h1><p className="text-gray-500">Pr√≥ximamente...</p></div>} />
                  <Route path="*" element={<Navigate to="/" replace />} />
                </Routes>
              </Layout>
            </ProtectedRoute>
          } />
          Ê≥õ        </Routes>
      </AuthProvider>
    </Router>
  );
}

export default App;
````

## File: frontend_react/src/index.css
````css
@tailwind base;
@tailwind components;
@tailwind utilities;

/* ============================================
   MEDICAL PREMIUM THEME - Clean & Professional
   ============================================ */

:root {
  /* Medical Premium Palette */
  --medical-900: #003366;
  --medical-800: #004080;
  --medical-700: #004d99;
  --medical-600: #0059b3;
  --medical-500: #0066cc;
  --medical-400: #0073e6;
  --medical-300: #3385ff;
  
  /* Clean Whites & Grays */
  --white-50: #ffffff;
  --white-100: #f8f9fa;
  --white-200: #f4f7f6;
  --white-300: #e9ecef;
  
  /* Semantic Colors */
  --success: #28a745;
  --warning: #ffc107;
  --danger: #dc3545;
  --info: #17a2b8;
  
  /* Shadows */
  --shadow-soft: 0 2px 15px -3px rgba(0, 0, 0, 0.07), 0 10px 20px -2px rgba(0, 0, 0, 0.04);
  --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
  --shadow-elevated: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', system-ui, -apple-system, sans-serif;
  background-color: var(--white-100);
  color: #1a1a1a;
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* ============================================
   UTILITY CLASSES
   ============================================ */

.glass-container {
  display: flex;
  min-height: 100vh;
}

/* Custom Scrollbar */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: var(--white-100);
}

::-webkit-scrollbar-thumb {
  background: #c4c4c4;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

/* Focus States */
*:focus-visible {
  outline: 2px solid var(--medical-600);
  outline-offset: 2px;
}

/* Transitions */
.transition-base {
  transition: all 0.2s ease-in-out;
}

/* ============================================
   CARD STYLES
   ============================================ */

.card {
  @apply bg-white rounded-xl shadow-card p-6;
}

.card-header {
  @apply flex items-center justify-between mb-4;
}

.card-title {
  @apply text-lg font-semibold text-gray-800;
}

/* ============================================
   BUTTON STYLES
   ============================================ */

.btn {
  @apply inline-flex items-center justify-center px-4 py-2 rounded-lg font-medium transition-colors duration-200;
}

.btn-primary {
  @apply bg-medical-600 text-white hover:bg-medical-700 active:bg-medical-800;
}

.btn-secondary {
  @apply bg-gray-100 text-gray-700 hover:bg-gray-200 active:bg-gray-300;
}

.btn-success {
  @apply bg-success text-white hover:bg-success/90;
}

.btn-danger {
  @apply bg-danger text-white hover:bg-danger/90;
}

/* ============================================
   INPUT STYLES
   ============================================ */

.input {
  @apply w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-medical-500 focus:border-transparent transition-all;
}

.input-error {
  @apply border-danger focus:ring-danger;
}

/* ============================================
   TABLE STYLES
   ============================================ */

.table-container {
  @apply overflow-x-auto rounded-xl border border-gray-200;
}

.table {
  @apply w-full text-sm;
}

.table th {
  @apply px-4 py-3 text-left font-medium text-gray-600 bg-gray-50 border-b;
}

.table td {
  @apply px-4 py-3 border-b border-gray-100;
}

.table tr:hover td {
  @apply bg-gray-50;
}

/* ============================================
   BADGE STYLES
   ============================================ */

.badge {
  @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium;
}

.badge-success {
  @apply bg-green-100 text-green-800;
}

.badge-warning {
  @apply bg-yellow-100 text-yellow-800;
}

.badge-danger {
  @apply bg-red-100 text-red-800;
}

.badge-info {
  @apply bg-blue-100 text-blue-800;
}

/* ============================================
   ANIMATIONS
   ============================================ */

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes slideUp {
  from { transform: translateY(10px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.animate-fade-in {
  animation: fadeIn 0.3s ease-out;
}

.animate-slide-in {
  animation: slideIn 0.3s ease-out;
}

.animate-slide-up {
  animation: slideUp 0.3s ease-out;
}

/* ============================================
   LOADING STATES
   ============================================ */

.skeleton {
  @apply bg-gray-200 animate-pulse rounded;
}

/* ============================================
   MODAL STYLES
   ============================================ */

.modal-overlay {
  @apply fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4;
}

.modal-content {
  @apply bg-white rounded-2xl shadow-elevated max-w-lg w-full max-h-[90vh] overflow-y-auto;
}

.modal-header {
  @apply flex items-center justify-between p-4 border-b;
}

.modal-body {
  @apply p-4;
}

.modal-footer {
  @apply flex justify-end gap-3 p-4 border-t bg-gray-50 rounded-b-2xl;
}

/* ============================================
   TOAST NOTIFICATIONS
   ============================================ */

.toast-container {
  @apply fixed top-4 right-4 z-50 flex flex-col gap-3;
}

.toast {
  @apply p-4 rounded-lg shadow-lg border-l-4 animate-slide-in;
}

.toast-success {
  @apply bg-green-50 border-green-500 text-green-800;
}

.toast-warning {
  @apply bg-yellow-50 border-yellow-500 text-yellow-800;
}

.toast-error {
  @apply bg-red-50 border-red-500 text-red-800;
}

.toast-info {
  @apply bg-blue-50 border-blue-500 text-blue-800;
}
````

## File: frontend_react/src/main.tsx
````typescript
import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import './index.css'
import App from './App.tsx'

createRoot(document.getElementById('root')!).render(
  <StrictMode>
    <App />
  </StrictMode>,
)
````

## File: frontend_react/.gitignore
````
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
````

## File: frontend_react/Dockerfile
````
# Stage 1: Build
FROM node:22-alpine as builder
WORKDIR /app
COPY package*.json ./
# Relaxed install (ignoring peer deps conflicts if any persist)
RUN npm install --legacy-peer-deps
COPY . .

# Build arguments for environment variables
ARG VITE_API_URL
ARG VITE_API_BASE_URL
ARG VITE_BFF_URL
ARG VITE_WS_URL
ARG VITE_ADMIN_TOKEN
ARG VITE_APP_NAME=Dentalogic

# Map ARGs to ENVs so they are available to the build process
ENV VITE_API_URL=$VITE_API_URL
ENV VITE_API_BASE_URL=$VITE_API_BASE_URL
ENV VITE_BFF_URL=$VITE_BFF_URL
ENV VITE_WS_URL=$VITE_WS_URL
ENV VITE_ADMIN_TOKEN=$VITE_ADMIN_TOKEN
ENV VITE_APP_NAME=$VITE_APP_NAME

# Skip type checking during build for stability if needed, 
# but here package.json has tsc && vite build
RUN npm run build

# Stage 2: Serve
FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
````

## File: frontend_react/eslint.config.js
````javascript
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import tseslint from 'typescript-eslint'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      js.configs.recommended,
      tseslint.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
  },
])
````

## File: frontend_react/index.html
````html
<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>frontend_react</title>
</head>

<body class="dark-theme">
  <div id="root"></div>
  <script type="module" src="/src/main.tsx"></script>
</body>

</html>
````

## File: frontend_react/nginx.conf
````ini
server {
    listen 80;
    server_name _;

    root /usr/share/nginx/html;
    index index.html;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json;

    # Handle client-side routing
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Cache static assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}
````

## File: frontend_react/package.json
````json
{
  "name": "nexus-dental-frontend",
  "private": true,
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "lint": "eslint . --ext ts,tsx --report-unused-disable-directives --max-warnings 0",
    "preview": "vite preview"
  },
  "dependencies": {
    "@fullcalendar/core": "^6.1.10",
    "@fullcalendar/daygrid": "^6.1.10",
    "@fullcalendar/interaction": "^6.1.10",
    "@fullcalendar/react": "^6.1.10",
    "@fullcalendar/timegrid": "^6.1.10",
    "axios": "^1.6.7",
    "socket.io-client": "^4.7.4",
    "lucide-react": "^0.300.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^6.21.0"
  },
  "devDependencies": {
    "@types/node": "^20.10.0",
    "@types/react": "^18.2.43",
    "@types/react-dom": "^18.2.17",
    "@typescript-eslint/eslint-plugin": "^6.14.0",
    "@typescript-eslint/parser": "^6.14.0",
    "@vitejs/plugin-react": "^4.2.1",
    "autoprefixer": "^10.4.16",
    "eslint": "^8.55.0",
    "eslint-plugin-react-hooks": "^4.6.0",
    "eslint-plugin-react-refresh": "^0.4.5",
    "postcss": "^8.4.32",
    "tailwindcss": "^3.4.0",
    "typescript": "^5.2.2",
    "vite": "^5.0.8"
  }
}
````

## File: frontend_react/postcss.config.js
````javascript
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
````

## File: frontend_react/README.md
````markdown
# React + TypeScript + Vite

This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.

Currently, two official plugins are available:

- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react) uses [Babel](https://babeljs.io/) (or [oxc](https://oxc.rs) when used in [rolldown-vite](https://vite.dev/guide/rolldown)) for Fast Refresh
- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh

## React Compiler

The React Compiler is not enabled on this template because of its impact on dev & build performances. To add it, see [this documentation](https://react.dev/learn/react-compiler/installation).

## Expanding the ESLint configuration

If you are developing a production application, we recommend updating the configuration to enable type-aware lint rules:

```js
export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      // Other configs...

      // Remove tseslint.configs.recommended and replace with this
      tseslint.configs.recommendedTypeChecked,
      // Alternatively, use this for stricter rules
      tseslint.configs.strictTypeChecked,
      // Optionally, add this for stylistic rules
      tseslint.configs.stylisticTypeChecked,

      // Other configs...
    ],
    languageOptions: {
      parserOptions: {
        project: ['./tsconfig.node.json', './tsconfig.app.json'],
        tsconfigRootDir: import.meta.dirname,
      },
      // other options...
    },
  },
])
```

You can also install [eslint-plugin-react-x](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-x) and [eslint-plugin-react-dom](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-dom) for React-specific lint rules:

```js
// eslint.config.js
import reactX from 'eslint-plugin-react-x'
import reactDom from 'eslint-plugin-react-dom'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      // Other configs...
      // Enable lint rules for React
      reactX.configs['recommended-typescript'],
      // Enable lint rules for React DOM
      reactDom.configs.recommended,
    ],
    languageOptions: {
      parserOptions: {
        project: ['./tsconfig.node.json', './tsconfig.app.json'],
        tsconfigRootDir: import.meta.dirname,
      },
      // other options...
    },
  },
])
```
````

## File: frontend_react/tailwind.config.js
````javascript
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      colors: {
        // Medical Premium Palette
        medical: {
          900: '#003366', // Deep Blue - Primary brand
          800: '#004080',
          700: '#004d99',
          600: '#0059b3',
          500: '#0066cc',
          400: '#0073e6',
          300: '#3385ff',
          200: '#66a3ff',
          100: '#99c2ff',
          50: '#e6f0ff',
        },
        // Clean White
        white: {
          DEFAULT: '#ffffff',
          50: '#ffffff',
          100: '#f8f9fa',
          200: '#f4f7f6', // Custom grey
          300: '#e9ecef',
          400: '#dee2e6',
          500: '#ced4da',
        },
        // Semantic colors
        success: {
          DEFAULT: '#28a745',
          light: '#34c759',
          dark: '#1e7e34',
        },
        warning: {
          DEFAULT: '#ffc107',
          dark: '#e0a800',
        },
        danger: {
          DEFAULT: '#dc3545',
          light: '#e4606d',
          dark: '#c82333',
        },
        info: {
          DEFAULT: '#17a2b8',
          light: '#38b2ac',
          dark: '#117a8b',
        },
      },
      fontFamily: {
        sans: ['Inter', 'system-ui', 'sans-serif'],
        display: ['Outfit', 'sans-serif'],
      },
      boxShadow: {
        'soft': '0 2px 15px -3px rgba(0, 0, 0, 0.07), 0 10px 20px -2px rgba(0, 0, 0, 0.04)',
        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)',
        'elevated': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
      },
      borderRadius: {
        'xl': '1rem',
        '2xl': '1.5rem',
        '3xl': '2rem',
      },
      animation: {
        'fade-in': 'fadeIn 0.3s ease-out',
        'slide-in': 'slideIn 0.3s ease-out',
        'pulse-soft': 'pulseSoft 2s ease-in-out infinite',
      },
      keyframes: {
        fadeIn: {
          '0%': { opacity: '0' },
          '100%': { opacity: '1' },
        },
        slideIn: {
          '0%': { transform: 'translateX(100%)', opacity: '0' },
          '100%': { transform: 'translateX(0)', opacity: '1' },
        },
        pulseSoft: {
          '0%, 100%': { opacity: '1' },
          '50%': { opacity: '0.7' },
        },
      },
    },
  },
  plugins: [],
}
````

## File: frontend_react/tsconfig.app.json
````json
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "target": "ES2022",
    "useDefineForClassFields": true,
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "types": ["vite/client"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["src"]
}
````

## File: frontend_react/tsconfig.json
````json
{
  "files": [],
  "references": [
    { "path": "./tsconfig.app.json" },
    { "path": "./tsconfig.node.json" }
  ]
}
````

## File: frontend_react/tsconfig.node.json
````json
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
    "target": "ES2023",
    "lib": ["ES2023"],
    "module": "ESNext",
    "types": ["node"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["vite.config.ts"]
}
````

## File: frontend_react/vite.config.ts
````typescript
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// https://vite.dev/config/
export default defineConfig({
  plugins: [react()],
  server: {
    allowedHosts: true
  },
})
````

## File: orchestrator_service/db/init/dentalogic_schema.sql
````sql
-- ==================================================================================
-- DENTALOGIC - SCHEMA UNIFICADO
-- ==================================================================================
-- Sistema de gesti√≥n dental con IA para Mercedes
-- Versi√≥n: 1.0 (Unificado 2026-02-05)
-- ==================================================================================

-- ==================== CORE TABLES - MESSAGES & CHAT ====================

-- Table for inbound messages (dedupe/idempotency from WhatsApp)
CREATE TABLE IF NOT EXISTS inbound_messages (
    id BIGSERIAL PRIMARY KEY,
    provider TEXT NOT NULL,
    provider_message_id TEXT NOT NULL,
    event_id TEXT NULL,
    from_number TEXT NOT NULL,
    payload JSONB NOT NULL,
    status TEXT NOT NULL CHECK (status IN ('received', 'processing', 'done', 'failed')),
    received_at TIMESTAMPTZ DEFAULT NOW(),
    processed_at TIMESTAMPTZ NULL,
    error TEXT NULL,
    correlation_id TEXT NULL,
    UNIQUE (provider, provider_message_id)
);

CREATE INDEX IF NOT EXISTS idx_inbound_messages_from_number_received_at ON inbound_messages (from_number, received_at DESC);
CREATE INDEX IF NOT EXISTS idx_inbound_messages_status ON inbound_messages (status);

-- Table for chat messages (source-of-truth)
CREATE TABLE IF NOT EXISTS chat_messages (
    id BIGSERIAL PRIMARY KEY,
    from_number TEXT NOT NULL,
    role TEXT NOT NULL CHECK (role IN ('user', 'assistant', 'system', 'tool')),
    content TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    correlation_id TEXT NULL
);

CREATE INDEX IF NOT EXISTS idx_chat_messages_from_number_created_at ON chat_messages (from_number, created_at DESC);

-- ==================== TENANT & CONFIGURATION ====================

-- Tabla de configuraci√≥n de la cl√≠nica (simplificada - single tenant)
CREATE TABLE IF NOT EXISTS tenants (
    id SERIAL PRIMARY KEY,
    clinic_name TEXT NOT NULL DEFAULT 'Cl√≠nica Dental',
    bot_phone_number TEXT UNIQUE NOT NULL,
    owner_email TEXT,
    clinic_location TEXT,
    clinic_website TEXT,
    system_prompt_template TEXT, -- Prompt del agente IA
    
    -- Usage Stats
    total_tokens_used BIGINT DEFAULT 0,
    total_tool_calls BIGINT DEFAULT 0,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Credentials Table (Secrets Management)
CREATE TABLE IF NOT EXISTS credentials (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    value TEXT NOT NULL,
    category TEXT,
    scope TEXT DEFAULT 'global',
    tenant_id INTEGER REFERENCES tenants(id) ON DELETE CASCADE,
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- System Events (For monitoring and debugging)
CREATE TABLE IF NOT EXISTS system_events (
    id BIGSERIAL PRIMARY KEY,
    event_type TEXT NOT NULL,
    severity TEXT DEFAULT 'info',
    message TEXT,
    payload JSONB,
    occurred_at TIMESTAMPTZ DEFAULT NOW()
);

-- Insert Default Tenant (Dentalogic)
INSERT INTO tenants (
    clinic_name, 
    bot_phone_number, 
    clinic_location
) VALUES (
    'Cl√≠nica Dental',
    '5491100000000',
    'Argentina'
) ON CONFLICT (bot_phone_number) DO NOTHING;

-- ==================== TABLA DE USUARIOS (RBAC) ====================

CREATE TABLE IF NOT EXISTS users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role VARCHAR(50) NOT NULL CHECK (role IN ('ceo', 'professional', 'secretary')),
    status VARCHAR(50) NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'active', 'suspended')),
    professional_id INTEGER NULL, -- Se vincula si el rol es professional
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
CREATE INDEX IF NOT EXISTS idx_users_status ON users(status);

-- ==================== TABLA DE PROFESIONALES ====================

CREATE TABLE IF NOT EXISTS professionals (
    id SERIAL PRIMARY KEY,
    tenant_id INTEGER NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    user_id UUID REFERENCES users(id) ON DELETE SET NULL, -- V√≠nculo a la tabla de usuarios
    
    first_name VARCHAR(100) NOT NULL,
    last_name VARCHAR(100) NOT NULL,
    email VARCHAR(255),
    phone_number VARCHAR(20),
    specialty VARCHAR(100),
    registration_id VARCHAR(50), -- Matr√≠cula
    
    is_active BOOLEAN DEFAULT TRUE,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);


CREATE INDEX IF NOT EXISTS idx_professionals_tenant ON professionals(tenant_id);
CREATE INDEX IF NOT EXISTS idx_professionals_active ON professionals(is_active);
CREATE INDEX IF NOT EXISTS idx_professionals_user_id ON professionals(user_id);

-- ==================== TABLA DE PACIENTES ====================

CREATE TABLE IF NOT EXISTS patients (
    id SERIAL PRIMARY KEY,
    tenant_id INTEGER NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    
    -- Identidad del Paciente
    phone_number VARCHAR(20) NOT NULL,
    dni VARCHAR(15) NOT NULL,
    first_name VARCHAR(100) NOT NULL,
    last_name VARCHAR(100) NOT NULL,
    birth_date DATE,
    gender VARCHAR(10),
    
    -- Obra Social (Insurance)
    insurance_provider VARCHAR(100),
    insurance_id VARCHAR(50),
    insurance_valid_until DATE,
    
    -- Anamnesis (JSONB: Historial M√©dico)
    medical_history JSONB DEFAULT '{}',
    
    -- Datos de Contacto
    email VARCHAR(255),
    alternative_phone VARCHAR(20),
    
    -- Estado del Paciente
    status VARCHAR(20) DEFAULT 'active',
    preferred_schedule VARCHAR(50),
    notes TEXT,
    
    -- Human Handoff Support (Chat Management)
    human_handoff_requested BOOLEAN DEFAULT FALSE,
    human_override_until TIMESTAMPTZ DEFAULT NULL,
    last_derivhumano_at TIMESTAMPTZ DEFAULT NULL,
    
    -- Auditor√≠a
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    last_visit TIMESTAMPTZ,
    
    -- Constraints
    UNIQUE (tenant_id, phone_number),
    UNIQUE (tenant_id, dni)
);

CREATE INDEX IF NOT EXISTS idx_patients_tenant_phone ON patients(tenant_id, phone_number);
CREATE INDEX IF NOT EXISTS idx_patients_tenant_dni ON patients(tenant_id, dni);
CREATE INDEX IF NOT EXISTS idx_patients_status ON patients(status);
CREATE INDEX IF NOT EXISTS idx_patients_insurance ON patients(insurance_provider);
CREATE INDEX IF NOT EXISTS idx_patients_handoff ON patients(human_handoff_requested) WHERE human_handoff_requested = TRUE;

COMMENT ON COLUMN patients.human_handoff_requested IS 'Indica si el paciente solicit√≥ hablar con un humano (derivhumano activado)';
COMMENT ON COLUMN patients.human_override_until IS 'Timestamp hasta el cual la IA debe permanecer silenciada (24hs por defecto)';
COMMENT ON COLUMN patients.last_derivhumano_at IS 'Timestamp de la √∫ltima vez que se activ√≥ derivhumano para este paciente';

-- ==================== TABLA DE HISTORIAS CL√çNICAS ====================

CREATE TABLE IF NOT EXISTS clinical_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id INTEGER NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    patient_id INTEGER NOT NULL REFERENCES patients(id) ON DELETE CASCADE,
    
    -- Metadata del Registro
    record_date DATE NOT NULL DEFAULT CURRENT_DATE,
    professional_id INTEGER REFERENCES professionals(id) ON DELETE SET NULL,
    
    -- Odontograma (JSONB: Representaci√≥n gr√°fica de dientes)
    odontogram JSONB DEFAULT '{}',
    
    -- Diagn√≥sticos Principales
    diagnosis TEXT,
    
    -- Tratamientos Realizados
    treatments JSONB DEFAULT '[]',
    
    -- Radiograf√≠as & Documentaci√≥n
    radiographs JSONB DEFAULT '[]',
    
    -- Plan de Tratamiento Futuro
    treatment_plan JSONB DEFAULT '{}',
    
    -- Observaciones Cl√≠nicas
    clinical_notes TEXT,
    recommendations TEXT,
    
    -- Auditor√≠a
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_clinical_records_patient ON clinical_records(patient_id);
CREATE INDEX IF NOT EXISTS idx_clinical_records_tenant ON clinical_records(tenant_id);
CREATE INDEX IF NOT EXISTS idx_clinical_records_date ON clinical_records(record_date DESC);
CREATE INDEX IF NOT EXISTS idx_clinical_records_professional ON clinical_records(professional_id);

-- ==================== TABLA DE TURNOS / CITAS ====================

CREATE TABLE IF NOT EXISTS appointments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id INTEGER NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    patient_id INTEGER NOT NULL REFERENCES patients(id) ON DELETE CASCADE,
    
    -- Datos del Turno
    appointment_datetime TIMESTAMPTZ NOT NULL,
    duration_minutes INTEGER DEFAULT 60,
    
    -- Asignaci√≥n de Recursos
    chair_id INTEGER,
    professional_id INTEGER REFERENCES professionals(id) ON DELETE SET NULL,
    
    -- Tipo de Cita
    appointment_type VARCHAR(50) NOT NULL,
    notes TEXT,
    
    -- Sincronizaci√≥n con Google Calendar
    google_calendar_event_id VARCHAR(255),
    google_calendar_sync_status VARCHAR(20) DEFAULT 'pending',
    
    -- Urgencia (detectada por AI triage)
    urgency_level VARCHAR(20) DEFAULT 'normal',
    urgency_reason TEXT,
    
    -- Estado del Turno
    status VARCHAR(20) DEFAULT 'scheduled',
    cancellation_reason TEXT,
    cancellation_by VARCHAR(50),
    
    -- Source: AI vs Manual booking
    source VARCHAR(20) DEFAULT 'ai',
    
    -- Recordatorio
    reminder_sent BOOLEAN DEFAULT FALSE,
    reminder_sent_at TIMESTAMPTZ,
    
    -- Auditor√≠a
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    completed_at TIMESTAMPTZ
);

CREATE INDEX IF NOT EXISTS idx_appointments_patient ON appointments(patient_id);
CREATE INDEX IF NOT EXISTS idx_appointments_tenant ON appointments(tenant_id);
CREATE INDEX IF NOT EXISTS idx_appointments_datetime ON appointments(appointment_datetime);
CREATE INDEX IF NOT EXISTS idx_appointments_chair ON appointments(chair_id);
CREATE INDEX IF NOT EXISTS idx_appointments_professional ON appointments(professional_id);
CREATE INDEX IF NOT EXISTS idx_appointments_status ON appointments(status);
CREATE INDEX IF NOT EXISTS idx_appointments_urgency ON appointments(urgency_level);
CREATE INDEX IF NOT EXISTS idx_appointments_google_sync ON appointments(google_calendar_sync_status);
CREATE INDEX IF NOT EXISTS idx_appointments_source ON appointments(source);

-- ==================== TABLA DE TRANSACCIONES CONTABLES ====================

CREATE TABLE IF NOT EXISTS accounting_transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id INTEGER NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    patient_id INTEGER REFERENCES patients(id) ON DELETE SET NULL,
    appointment_id UUID REFERENCES appointments(id) ON DELETE SET NULL,
    
    -- Tipo de Transacci√≥n
    transaction_type VARCHAR(50) NOT NULL,
    transaction_date DATE NOT NULL DEFAULT CURRENT_DATE,
    
    -- Monto
    amount NUMERIC(12, 2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'ARS',
    
    -- Detalles del Pago
    payment_method VARCHAR(50),
    description TEXT,
    
    -- Obra Social / Insurance
    insurance_claim_id VARCHAR(100),
    insurance_covered_amount NUMERIC(12, 2) DEFAULT 0,
    patient_paid_amount NUMERIC(12, 2) DEFAULT 0,
    
    -- Estado
    status VARCHAR(20) DEFAULT 'completed',
    
    -- Auditor√≠a
    recorded_by VARCHAR(100),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_accounting_tenant ON accounting_transactions(tenant_id);
CREATE INDEX IF NOT EXISTS idx_accounting_patient ON accounting_transactions(patient_id);
CREATE INDEX IF NOT EXISTS idx_accounting_date ON accounting_transactions(transaction_date DESC);
CREATE INDEX IF NOT EXISTS idx_accounting_type ON accounting_transactions(transaction_type);
CREATE INDEX IF NOT EXISTS idx_accounting_status ON accounting_transactions(status);

-- ==================== TABLA DE CAJA DIARIA ====================

CREATE TABLE IF NOT EXISTS daily_cash_flow (
    id SERIAL PRIMARY KEY,
    tenant_id INTEGER NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    
    -- Fecha
    cash_date DATE NOT NULL,
    
    -- Totales
    total_cash_received NUMERIC(12, 2) DEFAULT 0,
    total_card_received NUMERIC(12, 2) DEFAULT 0,
    total_insurance_claimed NUMERIC(12, 2) DEFAULT 0,
    total_expenses NUMERIC(12, 2) DEFAULT 0,
    
    -- Saldo
    net_balance NUMERIC(12, 2) DEFAULT 0,
    
    -- Registro
    recorded_at TIMESTAMPTZ DEFAULT NOW(),
    recorded_by VARCHAR(100),
    notes TEXT,
    
    -- Constraint: Una sola entrada por fecha/tenant
    UNIQUE (tenant_id, cash_date)
);

CREATE INDEX IF NOT EXISTS idx_daily_cash_flow_tenant ON daily_cash_flow(tenant_id);
CREATE INDEX IF NOT EXISTS idx_daily_cash_flow_date ON daily_cash_flow(cash_date);

-- ==================== GOOGLE CALENDAR INTEGRATION ====================

CREATE TABLE IF NOT EXISTS google_calendar_blocks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id INTEGER NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    
    -- Identificaci√≥n del evento en GCalendar
    google_event_id VARCHAR(255) UNIQUE NOT NULL,
    
    -- Datos del bloqueo
    title VARCHAR(255) NOT NULL,
    description TEXT,
    start_datetime TIMESTAMPTZ NOT NULL,
    end_datetime TIMESTAMPTZ NOT NULL,
    all_day BOOLEAN DEFAULT FALSE,
    
    -- Recursos afectados (opcional)
    professional_id INTEGER REFERENCES professionals(id) ON DELETE CASCADE,
    
    -- Estado de sync
    sync_status VARCHAR(20) DEFAULT 'synced',
    last_sync_at TIMESTAMPTZ DEFAULT NOW(),
    
    -- Auditor√≠a
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_gcalendar_blocks_tenant ON google_calendar_blocks(tenant_id);
CREATE INDEX IF NOT EXISTS idx_gcalendar_blocks_datetime ON google_calendar_blocks(start_datetime, end_datetime);
CREATE INDEX IF NOT EXISTS idx_gcalendar_blocks_professional ON google_calendar_blocks(professional_id);
CREATE INDEX IF NOT EXISTS idx_gcalendar_blocks_sync_status ON google_calendar_blocks(sync_status);

CREATE TABLE IF NOT EXISTS calendar_sync_log (
    id SERIAL PRIMARY KEY,
    tenant_id INTEGER NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    
    sync_type VARCHAR(50) NOT NULL,
    direction VARCHAR(20) NOT NULL,
    
    events_processed INTEGER DEFAULT 0,
    events_created INTEGER DEFAULT 0,
    events_updated INTEGER DEFAULT 0,
    events_deleted INTEGER DEFAULT 0,
    errors_count INTEGER DEFAULT 0,
    
    started_at TIMESTAMPTZ DEFAULT NOW(),
    completed_at TIMESTAMPTZ,
    error_message TEXT
);

CREATE INDEX IF NOT EXISTS idx_calendar_sync_log_tenant ON calendar_sync_log(tenant_id);
CREATE INDEX IF NOT EXISTS idx_calendar_sync_log_date ON calendar_sync_log(started_at DESC);

-- ==================== CONFIGURACI√ìN DE TRATAMIENTOS ====================

CREATE TABLE IF NOT EXISTS treatment_types (
    id SERIAL PRIMARY KEY,
    tenant_id INTEGER NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    
    -- Identificaci√≥n del tratamiento
    code VARCHAR(50) NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    
    -- Configuraci√≥n de duraci√≥n
    default_duration_minutes INTEGER NOT NULL DEFAULT 30,
    min_duration_minutes INTEGER NOT NULL DEFAULT 15,
    max_duration_minutes INTEGER NOT NULL DEFAULT 120,
    
    -- Complejidad del tratamiento
    complexity_level VARCHAR(20) DEFAULT 'medium',
    
    -- Categor√≠a
    category VARCHAR(50),
    
    -- Configuraci√≥n de agendamiento
    requires_multiple_sessions BOOLEAN DEFAULT FALSE,
    session_gap_days INTEGER DEFAULT 0,
    
    -- Estado
    is_active BOOLEAN DEFAULT TRUE,
    is_available_for_booking BOOLEAN DEFAULT TRUE,
    
    -- Notas internas
    internal_notes TEXT,
    
    -- Auditor√≠a
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_treatment_types_tenant ON treatment_types(tenant_id);
CREATE INDEX IF NOT EXISTS idx_treatment_types_code ON treatment_types(code);
CREATE INDEX IF NOT EXISTS idx_treatment_types_category ON treatment_types(category);
CREATE INDEX IF NOT EXISTS idx_treatment_types_active ON treatment_types(is_active, is_available_for_booking);
CREATE UNIQUE INDEX IF NOT EXISTS idx_treatment_types_tenant_code ON treatment_types(tenant_id, code);

-- ==================== DATOS POR DEFECTO: TRATAMIENTOS DENTALES ====================

INSERT INTO treatment_types (
    tenant_id, code, name, description, default_duration_minutes, 
    min_duration_minutes, max_duration_minutes, complexity_level, category,
    requires_multiple_sessions, is_active, is_available_for_booking
)
SELECT 
    t.id, 'checkup', 'Control/Checkup', 'Revisi√≥n general y evaluaci√≥n de salud bucodental',
    20, 15, 30, 'low', 'prevention', FALSE, TRUE, TRUE
FROM tenants t
WHERE NOT EXISTS (SELECT 1 FROM treatment_types tt WHERE tt.tenant_id = t.id AND tt.code = 'checkup');

INSERT INTO treatment_types (tenant_id, code, name, description, default_duration_minutes, min_duration_minutes, max_duration_minutes, complexity_level, category, requires_multiple_sessions, is_active, is_available_for_booking)
SELECT t.id, 'cleaning', 'Limpieza Dental', 'Profilaxis y limpieza profesional', 30, 20, 45, 'low', 'prevention', FALSE, TRUE, TRUE
FROM tenants t WHERE NOT EXISTS (SELECT 1 FROM treatment_types tt WHERE tt.tenant_id = t.id AND tt.code = 'cleaning');

INSERT INTO treatment_types (tenant_id, code, name, description, default_duration_minutes, min_duration_minutes, max_duration_minutes, complexity_level, category, requires_multiple_sessions, is_active, is_available_for_booking)
SELECT t.id, 'emergency', 'Consulta Urgente', 'Atenci√≥n de urgencia odontol√≥gica', 15, 10, 30, 'emergency', 'emergency', FALSE, TRUE, TRUE
FROM tenants t WHERE NOT EXISTS (SELECT 1 FROM treatment_types tt WHERE tt.tenant_id = t.id AND tt.code = 'emergency');

INSERT INTO treatment_types (tenant_id, code, name, description, default_duration_minutes, min_duration_minutes, max_duration_minutes, complexity_level, category, requires_multiple_sessions, is_active, is_available_for_booking)
SELECT t.id, 'extraction', 'Extracci√≥n Dental', 'Extracci√≥n simple o quir√∫rgica de pieza dental', 30, 20, 60, 'medium', 'surgical', FALSE, TRUE, TRUE
FROM tenants t WHERE NOT EXISTS (SELECT 1 FROM treatment_types tt WHERE tt.tenant_id = t.id AND tt.code = 'extraction');

INSERT INTO treatment_types (tenant_id, code, name, description, default_duration_minutes, min_duration_minutes, max_duration_minutes, complexity_level, category, requires_multiple_sessions, is_active, is_available_for_booking)
SELECT t.id, 'root_canal', 'Endodoncia', 'Tratamiento de conducto', 60, 45, 90, 'high', 'restorative', FALSE, TRUE, TRUE
FROM tenants t WHERE NOT EXISTS (SELECT 1 FROM treatment_types tt WHERE tt.tenant_id = t.id AND tt.code = 'root_canal');

INSERT INTO treatment_types (tenant_id, code, name, description, default_duration_minutes, min_duration_minutes, max_duration_minutes, complexity_level, category, requires_multiple_sessions, is_active, is_available_for_booking)
SELECT t.id, 'restoration', 'Restauraci√≥n/Obturaci√≥n', 'Empastes y reconstrucciones', 30, 20, 45, 'medium', 'restorative', FALSE, TRUE, TRUE
FROM tenants t WHERE NOT EXISTS (SELECT 1 FROM treatment_types tt WHERE tt.tenant_id = t.id AND tt.code = 'restoration');

INSERT INTO treatment_types (tenant_id, code, name, description, default_duration_minutes, min_duration_minutes, max_duration_minutes, complexity_level, category, requires_multiple_sessions, session_gap_days, is_active, is_available_for_booking)
SELECT t.id, 'orthodontics', 'Ortodoncia', 'Colocaci√≥n de aparato de ortodoncia', 45, 30, 60, 'high', 'orthodontics', TRUE, 7, TRUE, TRUE
FROM tenants t WHERE NOT EXISTS (SELECT 1 FROM treatment_types tt WHERE tt.tenant_id = t.id AND tt.code = 'orthodontics');

INSERT INTO treatment_types (tenant_id, code, name, description, default_duration_minutes, min_duration_minutes, max_duration_minutes, complexity_level, category, requires_multiple_sessions, is_active, is_available_for_booking)
SELECT t.id, 'consultation', 'Consulta General', 'Primera consulta o evaluaci√≥n', 30, 15, 45, 'low', 'prevention', FALSE, TRUE, TRUE
FROM tenants t WHERE NOT EXISTS (SELECT 1 FROM treatment_types tt WHERE tt.tenant_id = t.id AND tt.code = 'consultation');

-- ==================== FUNCI√ìN PARA OBTENER DURACI√ìN ====================

CREATE OR REPLACE FUNCTION get_treatment_duration(
    p_treatment_code VARCHAR,
    p_tenant_id INTEGER,
    p_urgency_level VARCHAR DEFAULT 'normal'
) RETURNS INTEGER AS $$
DECLARE
    v_duration INTEGER;
    v_min_duration INTEGER;
    v_max_duration INTEGER;
BEGIN
    SELECT default_duration_minutes, min_duration_minutes, max_duration_minutes
    INTO v_duration, v_min_duration, v_max_duration
    FROM treatment_types
    WHERE code = p_treatment_code
      AND tenant_id = p_tenant_id
      AND is_active = TRUE
      AND is_available_for_booking = TRUE;
    
    IF v_duration IS NULL THEN
        RETURN 30;
    END IF;
    
    IF p_urgency_level = 'emergency' THEN
        RETURN LEAST(v_min_duration, v_duration);
    ELSIF p_urgency_level IN ('high', 'normal') THEN
        RETURN v_duration;
    ELSE
        RETURN GREATEST(v_duration, v_max_duration);
    END IF;
END;
$$ LANGUAGE plpgsql;
````

## File: orchestrator_service/admin_routes.py
````python
import os
import uuid
import json
import asyncpg
import httpx
import logging
import re
from datetime import datetime, timedelta, date
from typing import List, Optional, Dict, Any
from fastapi import APIRouter, HTTPException, Header, Depends, Request, status, BackgroundTasks
from pydantic import BaseModel
from db import db
from gcal_service import gcal_service

logger = logging.getLogger(__name__)

# Configuraci√≥n
ADMIN_TOKEN = os.getenv("ADMIN_TOKEN", "admin-secret-token")
INTERNAL_API_TOKEN = os.getenv("INTERNAL_API_TOKEN", "internal-secret-token")
WHATSAPP_SERVICE_URL = os.getenv("WHATSAPP_SERVICE_URL", "http://whatsapp:8002")

router = APIRouter(prefix="/admin", tags=["Dental Admin"])

def normalize_phone(phone: str) -> str:
    """Asegura que el n√∫mero tenga el formato +123456789 (E.164)"""
    clean = re.sub(r'\D', '', phone)
    if not phone.startswith('+'):
        return '+' + clean
    return '+' + clean

# --- Helper para emitir eventos de Socket.IO ---
async def emit_appointment_event(event_type: str, data: Dict[str, Any], request: Request):
    """Emit appointment events via Socket.IO through the app state."""
    if hasattr(request.app.state, 'emit_appointment_event'):
        await request.app.state.emit_appointment_event(event_type, data)

# --- Background Task para env√≠o a WhatsApp ---
async def send_to_whatsapp_task(phone: str, message: str, business_number: str):
    """Tarea en segundo plano para no bloquear la UI mientras se env√≠a el mensaje."""
    normalized = normalize_phone(phone)
    logger.info(f"üì§ Intentando env√≠o manual a WhatsApp: {normalized} via {WHATSAPP_SERVICE_URL}")
    try:
        async with httpx.AsyncClient(timeout=15.0) as client:
            ws_resp = await client.post(
                f"{WHATSAPP_SERVICE_URL}/send",
                json={
                    "to": normalized,
                    "message": message
                },
                headers={
                    "X-Internal-Token": INTERNAL_API_TOKEN,
                    "X-Correlation-Id": str(uuid.uuid4())
                },
                params={"from_number": business_number}
            )
            if ws_resp.status_code != 200:
                logger.error(f"‚ùå Error en WhatsApp Service ({ws_resp.status_code}): {ws_resp.text}")
            else:
                logger.info(f"‚úÖ WhatsApp background send success for {normalized}")
    except Exception as e:
        logger.error(f"‚ùå WhatsApp background send CRITICAL failed for {normalized}: {str(e)}")

# --- Dependencia de Seguridad (Triple Capa Nexus v7.6) ---
async def verify_admin_token(
    request: Request,
    x_admin_token: str = Header(None),
    authorization: str = Header(None)
):
    """
    Implementa la validaci√≥n de doble factor para administraci√≥n:
    1. Validar Token JWT (Identidad y Sesi√≥n)
    2. Validar X-Admin-Token (Autorizaci√≥n Est√°tica de Infraestructura)
    """
    # 1. Validar X-Admin-Token
    if not ADMIN_TOKEN:
        logger.warning("‚ö†Ô∏è ADMIN_TOKEN no configurado. Validaci√≥n est√°tica omitida.")
    elif x_admin_token != ADMIN_TOKEN:
        raise HTTPException(status_code=401, detail="Token de infraestructura (X-Admin-Token) inv√°lido.")

    # 2. Validar JWT (Capa de Identidad)
    if not authorization or not authorization.startswith("Bearer "):
        raise HTTPException(status_code=status.HTTP_401_UNAUTHORIZED, detail="Sesi√≥n no v√°lida. Token JWT requerido.")
    
    token = authorization.split(" ")[1]
    from auth_service import auth_service
    user_data = auth_service.decode_token(token)
    
    if not user_data:
        raise HTTPException(status_code=401, detail="Token de sesi√≥n expirado o inv√°lido.")
    
    # 3. Validar Rol (Solo CEOs pueden acceder a /admin global)
    # Algunas rutas podr√≠an permitir 'secretary', pero por defecto restringimos a 'ceo'
    if user_data.role not in ['ceo', 'secretary']:
        raise HTTPException(status_code=403, detail="No tienes permisos suficientes para realizar esta acci√≥n.")

    # Inyectar datos del usuario en el request state para uso posterior
    request.state.user = user_data
    return user_data

# --- Modelos Pydantic ---

class StatusUpdate(BaseModel):
    status: str # active, suspended, pending

# --- RUTAS DE ADMINISTRACI√ìN DE USUARIOS ---

@router.get("/users/pending")
async def get_pending_users(user_data = Depends(verify_admin_token)):
    """ Retorna la lista de usuarios con estado 'pending' (Solo CEO) """
    if user_data.role != 'ceo':
        raise HTTPException(status_code=403, detail="Solo los CEOs pueden gestionar aprobaciones.")
        
    users = await db.fetch("""
        SELECT id, email, role, status, created_at 
        FROM users 
        WHERE status = 'pending'
        ORDER BY created_at DESC
    """)
    return [dict(u) for u in users]

@router.post("/users/{user_id}/status")
async def update_user_status(user_id: str, payload: StatusUpdate, user_data = Depends(verify_admin_token)):
    """ Actualiza el estado de un usuario (Aprobaci√≥n/Suspensi√≥n) """
    if user_data.role != 'ceo':
        raise HTTPException(status_code=403, detail="Solo los CEOs pueden cambiar estados de usuario.")

    # Validar que el usuario exista
    target_user = await db.fetchrow("SELECT email, role FROM users WHERE id = $1", user_id)
    if not target_user:
        raise HTTPException(status_code=404, detail="Usuario no encontrado.")

    # Actualizar estado
    await db.execute("UPDATE users SET status = $1, updated_at = NOW() WHERE id = $2", payload.status, user_id)

    # Si se aprueba un profesional, activar su perfil m√©dico tambi√©n
    if payload.status == 'active' and target_user['role'] == 'professional':
        await db.execute("UPDATE professionals SET is_active = TRUE WHERE user_id = $1", uuid.UUID(user_id))

    return {"message": f"Usuario {target_user['email']} actualizado a {payload.status}."}

class PatientCreate(BaseModel):
    first_name: str
    last_name: Optional[str] = ""
    phone_number: str
    email: Optional[str] = None
    dni: Optional[str] = None
    insurance: Optional[str] = None # Obra Social

class AppointmentCreate(BaseModel):
    patient_id: Optional[int] = None
    patient_phone: Optional[str] = None # Si es paciente nuevo r√°pido
    professional_id: int
    datetime: datetime
    type: str = "checkup"
    notes: Optional[str] = None
    check_collisions: bool = True # Por defecto verificar colisiones

class GCalendarBlockCreate(BaseModel):
    google_event_id: str
    title: str
    description: Optional[str] = None
    start_datetime: datetime
    end_datetime: datetime
    all_day: bool = False
    professional_id: Optional[int] = None

class ClinicalNote(BaseModel):
    content: str
    odontogram_data: Optional[Dict] = None

class ProfessionalUpdate(BaseModel):
    name: str
    specialty: str
    active: bool

class ChatSendMessage(BaseModel):
    phone: str
    message: str

class HumanInterventionToggle(BaseModel):
    phone: str
    activate: bool
    duration: Optional[int] = 86400000  # 24 horas en ms

# ==================== ENDPOINTS CHAT MANAGEMENT ====================

@router.get("/chat/sessions", dependencies=[Depends(verify_admin_token)])
async def get_chat_sessions():
    """
    Obtiene todas las sesiones de chat activas con su estado.
    Devuelve informaci√≥n de paciente, √∫ltimo mensaje, y estado de intervenci√≥n humana.
    """
    rows = await db.pool.fetch("""
        SELECT * FROM (
            SELECT DISTINCT ON (p.phone_number)
                p.phone_number,
                p.id as patient_id,
                p.first_name || ' ' || COALESCE(p.last_name, '') as patient_name,
                cm.content as last_message,
                cm.created_at as last_message_time,
                p.human_handoff_requested,
                p.human_override_until,
                p.last_derivhumano_at,
                CASE 
                    WHEN p.human_handoff_requested AND p.human_override_until > NOW() THEN 'human_handling'
                    WHEN p.human_override_until > NOW() THEN 'silenced'
                    ELSE 'active'
                END as status,
                urgency.urgency_level
            FROM patients p
            LEFT JOIN LATERAL (
                SELECT content, created_at, role
                FROM chat_messages
                WHERE from_number = p.phone_number
                ORDER BY created_at DESC
                LIMIT 1
            ) cm ON true
            LEFT JOIN LATERAL (
                SELECT urgency_level
                FROM appointments
                WHERE patient_id = p.id
                ORDER BY created_at DESC
                LIMIT 1
            ) urgency ON true
            WHERE EXISTS (
                SELECT 1 FROM chat_messages 
                WHERE from_number = p.phone_number
            )
            ORDER BY p.phone_number, cm.created_at DESC
        ) sub
        ORDER BY last_message_time DESC NULLS LAST
    """)
    
    sessions = []
    for row in rows:
        # Calcular mensajes no le√≠dos
        unread = await db.pool.fetchval("""
            SELECT COUNT(*) 
            FROM chat_messages 
            WHERE from_number = $1 
            AND role = 'user' 
            AND created_at > COALESCE(
                (SELECT created_at FROM chat_messages 
                 WHERE from_number = $1 AND role = 'assistant' 
                 ORDER BY created_at DESC LIMIT 1),
                '1970-01-01'::timestamptz
            )
        """, row['phone_number'])

        # Calcular si la ventana de 24hs est√° abierta (√∫ltimo mensaje del USUARIO)
        last_user_msg = await db.pool.fetchval("""
            SELECT created_at FROM chat_messages 
            WHERE from_number = $1 AND role = 'user' 
            ORDER BY created_at DESC LIMIT 1
        """, row['phone_number'])
        
        is_window_open = False
        if last_user_msg:
            is_window_open = (datetime.now(last_user_msg.tzinfo) - last_user_msg) < timedelta(hours=24)
        
        sessions.append({
            "phone_number": row['phone_number'],
            "patient_id": row['patient_id'],
            "patient_name": row['patient_name'],
            "last_message": row['last_message'] or "",
            "last_message_time": row['last_message_time'].isoformat() if row['last_message_time'] else None,
            "unread_count": unread or 0,
            "status": row['status'],
            "human_override_until": row['human_override_until'].isoformat() if row['human_override_until'] else None,
            "urgency_level": row['urgency_level'],
            "last_derivhumano_at": row['last_derivhumano_at'].isoformat() if row['last_derivhumano_at'] else None,
            "is_window_open": is_window_open,
            "last_user_message_time": last_user_msg.isoformat() if last_user_msg else None
        })
    
    return sessions


@router.get("/chat/messages/{phone}", dependencies=[Depends(verify_admin_token)])
async def get_chat_messages(phone: str, limit: int = 100):
    """Obtiene el historial de mensajes para un n√∫mero de tel√©fono espec√≠fico."""
    rows = await db.pool.fetch("""
        SELECT id, from_number, role, content, created_at, correlation_id
        FROM chat_messages
        WHERE from_number = $1
        ORDER BY created_at ASC
        LIMIT $2
    """, phone, limit)
    
    messages = []
    for row in rows:
        # Detectar si es un mensaje de derivhumano (sistema indica handoff)
        is_derivhumano = row['role'] == 'assistant' and 'representante humano' in row['content'].lower()
        
        messages.append({
            "id": row['id'],
            "from_number": row['from_number'],
            "role": row['role'],
            "content": row['content'],
            "created_at": row['created_at'].isoformat(),
            "is_derivhumano": is_derivhumano
        })
    
    return messages




@router.post("/chat/human-intervention", dependencies=[Depends(verify_admin_token)])
async def toggle_human_intervention(payload: HumanInterventionToggle, request: Request):
    """
    Activa o desactiva la intervenci√≥n humana para un chat espec√≠fico.
    Cuando est√° activo, la IA permanece silenciada por la duraci√≥n especificada.
    """
    if payload.activate:
        # Activar intervenci√≥n humana
        override_until = datetime.now() + timedelta(milliseconds=payload.duration)
        
        await db.pool.execute("""
            UPDATE patients 
            SET human_handoff_requested = TRUE,
                human_override_until = $1,
                last_derivhumano_at = NULL,
                updated_at = NOW()
            WHERE phone_number = $2
        """, override_until, payload.phone)
        
        logger.info(f"üë§ Intervenci√≥n humana activada para {payload.phone} hasta {override_until}")
        
        # Notificar v√≠a Socket
        await emit_appointment_event('HUMAN_OVERRIDE_CHANGED', {
            'phone_number': payload.phone,
            'enabled': True,
            'until': override_until.isoformat()
        }, request)
        
        return {
            "status": "activated",
            "phone": payload.phone,
            "until": override_until.isoformat()
        }
    else:
        # Desactivar intervenci√≥n humana
        await db.pool.execute("""
            UPDATE patients 
            SET human_handoff_requested = FALSE,
                human_override_until = NULL,
                updated_at = NOW()
            WHERE phone_number = $1
        """, payload.phone)
        
        logger.info(f"ü§ñ IA reactivada para {payload.phone}")
        
        # Notificar v√≠a Socket
        await emit_appointment_event('HUMAN_OVERRIDE_CHANGED', {
            'phone_number': payload.phone,
            'enabled': False
        }, request)
        
        return {
            "status": "deactivated",
            "phone": payload.phone
        }


@router.post("/chat/remove-silence", dependencies=[Depends(verify_admin_token)])
async def remove_silence(payload: dict, request: Request):
    """Remueve el silencio de la IA para un n√∫mero espec√≠fico."""
    phone = payload.get("phone")
    if not phone:
        raise HTTPException(status_code=400, detail="Phone number required")
    
    await db.pool.execute("""
        UPDATE patients 
        SET human_handoff_requested = FALSE,
            human_override_until = NULL,
            updated_at = NOW()
        WHERE phone_number = $1
    """, phone)
    
    # Notificar v√≠a Socket
    await emit_appointment_event('HUMAN_OVERRIDE_CHANGED', {
        'phone_number': phone,
        'enabled': False
    }, request)
    
    return {"status": "removed", "phone": phone}


@router.get("/internal/credentials/{name}")
async def get_internal_credential(name: str, x_internal_token: str = Header(None)):
    """Permite a servicios internos obtener credenciales de forma segura."""
    if not INTERNAL_API_TOKEN or x_internal_token != INTERNAL_API_TOKEN:
        raise HTTPException(status_code=401, detail="Internal token invalid")
    
    # Mapeo de nombres a variables de entorno o valores de BD
    creds = {
        "YCLOUD_API_KEY": os.getenv("YCLOUD_API_KEY"),
        "YCLOUD_WEBHOOK_SECRET": os.getenv("YCLOUD_WEBHOOK_SECRET"),
        "OPENAI_API_KEY": os.getenv("OPENAI_API_KEY"),
        "YCLOUD_Phone_Number_ID": os.getenv("YCLOUD_Phone_Number_ID") or os.getenv("BOT_PHONE_NUMBER")
    }
    
    val = creds.get(name)
    if val is None: # Solo 404 si la clave no existe en nuestro mapeo
        raise HTTPException(status_code=404, detail=f"Credential '{name}' not supported by this endpoint")
        
    return {"name": name, "value": val}


@router.post("/chat/send", dependencies=[Depends(verify_admin_token)])
async def send_chat_message(payload: ChatSendMessage, request: Request, background_tasks: BackgroundTasks):
    """Env√≠a un mensaje manual por WhatsApp y lo guarda en BD."""
    try:
        # 0. Verificar ventana de 24hs (WhatsApp Policy)
        last_user_msg = await db.pool.fetchval("""
            SELECT created_at FROM chat_messages 
            WHERE from_number = $1 AND role = 'user' 
            ORDER BY created_at DESC LIMIT 1
        """, payload.phone)
        
        if not last_user_msg:
             raise HTTPException(status_code=403, detail="No se puede enviar un mensaje si el usuario nunca ha escrito.")
             
        diff = datetime.now(last_user_msg.tzinfo) - last_user_msg
        if diff > timedelta(hours=24):
             raise HTTPException(status_code=403, detail="La ventana de 24hs de WhatsApp ha expirado. El paciente debe escribir primero.")

        # 1. Guardar en Base de Datos
        correlation_id = str(uuid.uuid4())
        await db.append_chat_message(
            from_number=payload.phone,
            role='assistant',
            content=payload.message,
            correlation_id=correlation_id
        )
        
        # 2. Notificar al Frontend v√≠a Socket
        if hasattr(request.app.state, 'emit_appointment_event'):
            await request.app.state.emit_appointment_event('NEW_MESSAGE', {
                'phone_number': payload.phone,
                'message': payload.message,
                'role': 'assistant'
            })

        # 3. Enviar a WhatsApp Service (Segundo plano para evitar latencia)
        business_number = os.getenv("YCLOUD_Phone_Number_ID") or os.getenv("BOT_PHONE_NUMBER") or "default"
        background_tasks.add_task(send_to_whatsapp_task, payload.phone, payload.message, business_number)
            
        return {"status": "sent", "correlation_id": correlation_id}
        
    except Exception as e:
        logger.error(f"Error sending manual message: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))


# ==================== ENDPOINTS DASHBOARD ====================

@router.get("/stats/summary", dependencies=[Depends(verify_admin_token)])
async def get_dashboard_stats():
    """Devuelve m√©tricas clave para el dashboard principal."""
    today = date.today()
    
    # 1. Turnos de hoy
    appointments_today = await db.pool.fetchval("""
        SELECT COUNT(*) FROM appointments 
        WHERE DATE(appointment_datetime) = $1 AND status != 'cancelled'
    """, today)

    # 2. Urgencias pendientes (detectadas por IA)
    urgencies = await db.pool.fetchval("""
        SELECT COUNT(*) FROM appointments 
        WHERE urgency_level IN ('high', 'emergency') AND status = 'scheduled'
    """)

    # 3. Pacientes totales
    total_patients = await db.pool.fetchval("SELECT COUNT(*) FROM patients")

    return {
        "appointments_today": appointments_today,
        "active_urgencies": urgencies,
        "total_patients": total_patients,
        "system_status": "online"
    }

@router.get("/config/deployment", dependencies=[Depends(verify_admin_token)])
async def get_deployment_config(request: Request):
    """Retorna configuraci√≥n din√°mica de despliegue (Webhooks, URLs)."""
    # Detectamos la URL base actual si no est√° forzada en ENV
    host = request.headers.get("host", "localhost:8000")
    protocol = "https" if request.headers.get("x-forwarded-proto") == "https" else "http"
    base_url = f"{protocol}://{host}"
    
    return {
        "webhook_ycloud_url": f"{base_url}/webhook/ycloud",
        "webhook_ycloud_internal_port": os.getenv("WHATSAPP_SERVICE_PORT", "8002"),
        "orchestrator_url": base_url,
        "environment": os.getenv("ENVIRONMENT", "development")
    }

# ==================== ENDPOINTS B√öSQUEDA SEM√ÅNTICA ====================

@router.get("/patients/search-semantic", dependencies=[Depends(verify_admin_token)])
async def search_patients_by_symptoms(
    query: str,
    limit: int = 20
):
    """
    B√∫squeda sem√°ntica de pacientes por s√≠ntomas mencionados en chats IA.
    Busca coincidencias de texto en la tabla chat_messages relacionadas con s√≠ntomas.
    
    Args:
        query: Texto a buscar (ej: "dolor de muela", "gingivitis")
        limit: N√∫mero m√°ximo de resultados
        
    Returns:
        Lista de pacientes con matches sem√°nticos
    """
    try:
        # Buscar mensajes de chat que contengan el query (case-insensitive)
        chat_matches = await db.pool.fetch("""
            SELECT DISTINCT patient_id
            FROM chat_messages
            WHERE content ILIKE $1
            ORDER BY created_at DESC
            LIMIT $2
        """, f"%{query}%", limit)
        
        patient_ids = [row['patient_id'] for row in chat_matches if row['patient_id'] is not None]
        
        if not patient_ids:
            return []
            
        # Obtener datos de pacientes
        patients = await db.pool.fetch("""
            SELECT id, first_name, last_name, phone_number, email, insurance_provider, dni, created_at
            FROM patients
            WHERE id = ANY($1::int[])
            AND status = 'active'
        """, patient_ids)
        
        return [dict(row) for row in patients]
        
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Error en b√∫squeda sem√°ntica: {str(e)}")

# ==================== ENDPOINTS SEGURO / OBRAS SOCIALES ====================

@router.get("/patients/{patient_id}/insurance-status", dependencies=[Depends(verify_admin_token)])
async def get_patient_insurance_status(patient_id: int):
    """
    Verifica el estado de la credencial de obra social de un paciente.
    
    Returns:
        - status: 'ok' | 'warning' | 'expired'
        - requires_token: boolean (ej: OSDE requiere token)
        - message: string con descripci√≥n del estado
        - expiration_days: d√≠as hasta el vencimiento (negativo = vencido)
        - insurance_provider: nombre de la obra social
    """
    try:
        # Obtener datos del paciente y su obra social
        patient = await db.pool.fetchrow("""
            SELECT id, first_name, last_name, phone_number, insurance_provider, 
                   insurance_number, insurance_expiry_date, insurance_verified
            FROM patients
            WHERE id = $1 AND status = 'active'
        """, patient_id)
        
        if not patient:
            raise HTTPException(status_code=404, detail="Paciente no encontrado")
        
        insurance_provider = patient.get('insurance_provider') or ''
        expiry_date = patient.get('insurance_expiry_date')
        
        # Si no tiene obra social configurada
        if not insurance_provider:
            return {
                "status": "ok",
                "requires_token": False,
                "message": "Sin obra social configurada",
                "expiration_days": None,
                "insurance_provider": None
            }
        
        # Verificar si requiere token (algunas obras sociales espec√≠ficas)
        requires_token = insurance_provider.upper() in ['OSDE', 'SWISS MEDICAL', 'GALENO', 'MEDICINA PREPAGA']
        
        # Calcular d√≠as hasta vencimiento
        expiration_days = None
        if expiry_date:
            if isinstance(expiry_date, str):
                expiry_date = datetime.fromisoformat(expiry_date.split('T')[0])
            
            today = date.today()
            delta = expiry_date - today
            expiration_days = delta.days
        
        # Determinar estado
        if expiration_days is not None and expiration_days < 0:
            # Credencial vencida
            return {
                "status": "expired",
                "requires_token": requires_token,
                "message": f"Credencial vencida hace {abs(expiration_days)} d√≠as. Requiere renovaci√≥n.",
                "expiration_days": expiration_days,
                "insurance_provider": insurance_provider
            }
        elif expiration_days is not None and expiration_days <= 30:
            # Credencial pr√≥xima a vencer (30 d√≠as)
            return {
                "status": "warning",
                "requires_token": requires_token,
                "message": f"Credencial vence en {expiration_days} d√≠as. Considera renovar.",
                "expiration_days": expiration_days,
                "insurance_provider": insurance_provider
            }
        else:
            # Todo bien
            message = "Credencial vigente"
            if requires_token:
                message += ". Requiere validaci√≥n de token"
            
            return {
                "status": "ok",
                "requires_token": requires_token,
                "message": message,
                "expiration_days": expiration_days,
                "insurance_provider": insurance_provider
            }
            
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Error verificando seguro: {str(e)}")

# ==================== ENDPOINTS PACIENTES ====================

@router.get("/patients", dependencies=[Depends(verify_admin_token)])
async def list_patients(search: str = None, limit: int = 50):
    """Listar pacientes con b√∫squeda por nombre o DNI."""
    query = """
        SELECT id, first_name, last_name, phone_number, email, insurance_provider 
        FROM patients 
        WHERE status = 'active'
    """
    params = []
    
    if search:
        query += " AND (first_name ILIKE $1 OR last_name ILIKE $1 OR phone_number ILIKE $1)"
        params.append(f"%{search}%")
    
    query += " ORDER BY created_at DESC LIMIT 50"
    
    if not search:
        rows = await db.pool.fetch(query)
    else:
        rows = await db.pool.fetch(query, params[0])
        
    return [dict(row) for row in rows]

@router.post("/patients", dependencies=[Depends(verify_admin_token)])
async def create_patient(p: PatientCreate):
    """Crear un nuevo paciente manualmente."""
    try:
        # Verificar si existe el paciente
        existing_row = await db.pool.fetchrow(
            "SELECT id, status FROM patients WHERE phone_number = $1",
            p.phone_number
        )
        
        if existing_row:
            # Si existe como 'guest' (creado por chat), lo actualizamos a 'active'
            if existing_row['status'] == 'guest':
                await db.pool.execute("""
                    UPDATE patients 
                    SET first_name = $1, last_name = $2, email = $3, insurance_provider = $4, status = 'active', updated_at = NOW()
                    WHERE id = $5
                """, p.first_name, p.last_name, p.email, p.insurance, existing_row['id'])
                return {"id": existing_row['id'], "status": "upgraded", "phone": p.phone_number}
            else:
                # Si ya es 'active', es un duplicado real
                raise HTTPException(status_code=409, detail="Ya existe un paciente activo con ese n√∫mero de tel√©fono")
        
        # Crear nuevo si no existe
        row = await db.pool.fetchrow("""
            INSERT INTO patients (
                phone_number, first_name, last_name, email, insurance_provider, status, created_at
            ) VALUES ($1, $2, $3, $4, $5, 'active', NOW())
            RETURNING id
        """, p.phone_number, p.first_name, p.last_name, p.email, p.insurance)
        
        return {"id": row['id'], "status": "created", "phone": p.phone_number}

    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=400, detail=f"Error creando paciente: {str(e)}")

@router.get("/patients/{id}/records", dependencies=[Depends(verify_admin_token)])
async def get_clinical_records(id: int):
    """Obtener historia cl√≠nica de un paciente."""
    rows = await db.pool.fetch("""
        SELECT id, appointment_id, diagnosis, treatment_plan, created_at 
        FROM clinical_records 
        WHERE patient_id = $1 
        ORDER BY created_at DESC
    """, id)
    return [dict(row) for row in rows]

@router.post("/patients/{id}/records", dependencies=[Depends(verify_admin_token)])
async def add_clinical_note(id: int, note: ClinicalNote):
    """Agregar una evoluci√≥n/nota a la historia cl√≠nica."""
    await db.pool.execute("""
        INSERT INTO clinical_records (id, patient_id, diagnosis, odontogram, created_at)
        VALUES ($1, $2, $3, $4, NOW())
    """, str(uuid.uuid4()), id, note.content, json.dumps(note.odontogram_data) if note.odontogram_data else None)
    return {"status": "ok"}

# ==================== ENDPOINTS TURNOS (AGENDA) ====================

@router.get("/appointments", dependencies=[Depends(verify_admin_token)])
async def list_appointments(start_date: str, end_date: str):
    """Obtener turnos para el calendario con source (AI vs Manual)."""
    rows = await db.pool.fetch("""
        SELECT a.id, a.appointment_datetime, a.duration_minutes, a.status, a.urgency_level,
               a.source, a.appointment_type, a.notes,
               p.first_name, p.last_name, p.phone_number,
               prof.first_name as professional_name, prof.id as professional_id
        FROM appointments a
        JOIN patients p ON a.patient_id = p.id
        LEFT JOIN professionals prof ON a.professional_id = prof.id
        WHERE a.appointment_datetime BETWEEN $1 AND $2
        ORDER BY a.appointment_datetime ASC
    """, datetime.fromisoformat(start_date), datetime.fromisoformat(end_date))
    
    return [dict(row) for row in rows]


# ==================== ENDPOINT COLISION DETECTION ====================

@router.get("/appointments/check-collisions", dependencies=[Depends(verify_admin_token)])
async def check_collisions(
    professional_id: int,
    datetime_str: str,
    duration_minutes: int = 60,
    exclude_appointment_id: str = None
):
    """Verificar si hay colisiones de horario para un profesional."""
    target_datetime = datetime.fromisoformat(datetime_str)
    target_end = target_datetime + timedelta(minutes=duration_minutes)
    
    # Query para buscar turnos que se solapan
    overlap_query = """
        SELECT id, appointment_datetime, duration_minutes, status, source
        FROM appointments
        WHERE professional_id = $1
        AND status NOT IN ('cancelled', 'no-show')
        AND appointment_datetime < $3
        AND appointment_datetime + (duration_minutes || ' minutes')::interval > $2
    """
    params = [professional_id, target_datetime, target_end]
    
    if exclude_appointment_id:
        overlap_query += " AND id != $4"
        params.append(exclude_appointment_id)
    
    overlapping = await db.pool.fetch(overlap_query, *params)
    
    # Verificar tambi√©n bloques de GCalendar
    gcal_blocks = await db.pool.fetch("""
        SELECT id, title, start_datetime, end_datetime
        FROM google_calendar_blocks
        WHERE professional_id = $1 OR professional_id IS NULL
        AND start_datetime < $3
        AND end_datetime > $2
    """, professional_id, target_datetime, target_end)
    
    has_collisions = len(overlapping) > 0 or len(gcal_blocks) > 0
    
    return {
        "has_collisions": has_collisions,
        "conflicting_appointments": [dict(row) for row in overlapping],
        "conflicting_blocks": [dict(row) for row in gcal_blocks]
    }

@router.post("/appointments", dependencies=[Depends(verify_admin_token)])
async def create_appointment_manual(apt: AppointmentCreate, request: Request):
    """Agendar turno manualmente desde el admin."""
    
    try:
        # 0. Verificar colisiones si est√° habilitado
        if apt.check_collisions:
            collision_response = await check_collisions(
                apt.professional_id,
                apt.datetime.isoformat(),
                60,
                None
            )
            if collision_response["has_collisions"]:
                conflicts = []
                for apt_conflict in collision_response["conflicting_appointments"]:
                    conflicts.append(f"Turno existente: {apt_conflict['appointment_datetime']}")
                for block in collision_response["conflicting_blocks"]:
                    conflicts.append(f"Bloqueo GCalendar: {block['title']} ({block['start_datetime']})")
                raise HTTPException(
                    status_code=409, 
                    detail=f"Hay colisiones de horario: {'; '.join(conflicts)}"
                )
        
        # 1. Validar que professional_id existe
        prof_exists = await db.pool.fetchval(
            "SELECT id FROM professionals WHERE id = $1 AND is_active = true",
            apt.professional_id
        )
        if not prof_exists:
            raise HTTPException(status_code=400, detail="Profesional inv√°lido o inactivo")
        
        # 2. Resolver patient_id
        pid = apt.patient_id
        if not pid and apt.patient_phone:
            # Buscar por tel√©fono
            exist = await db.pool.fetchrow("SELECT id FROM patients WHERE phone_number = $1", apt.patient_phone)
            if exist:
                pid = exist['id']
            else:
                # Crear paciente temporal
                new_p = await db.pool.fetchrow(
                    "INSERT INTO patients (phone_number, first_name, created_at) VALUES ($1, $2, NOW()) RETURNING id",
                    apt.patient_phone,
                    "Paciente Manual"
                )
                pid = new_p['id']
        
        if not pid:
            raise HTTPException(status_code=400, detail="Se requiere ID de paciente o tel√©fono v√°lido.")
        
        # 3. Validar que patient_id existe
        patient_exists = await db.pool.fetchval("SELECT id FROM patients WHERE id = $1", pid)
        if not patient_exists:
            raise HTTPException(status_code=400, detail="Paciente no encontrado")
        
        # 4. Crear turno (source='manual')
        new_id = str(uuid.uuid4())
        await db.pool.execute("""
            INSERT INTO appointments (
                id, patient_id, professional_id, appointment_datetime, 
                duration_minutes, appointment_type, status, urgency_level, source, created_at
            ) VALUES ($1, $2, $3, $4, 60, $5, 'confirmed', 'normal', 'manual', NOW())
        """, new_id, pid, apt.professional_id, apt.datetime, apt.type)
        
        # 5. Sincronizar con Google Calendar
        try:
            summary = f"Cita Dental: {appointment_data['first_name']} {appointment_data['last_name'] or ''} - {apt.type}"
            start_time = apt.datetime.isoformat()
            end_time = (apt.datetime + timedelta(minutes=60)).isoformat()
            
            gcal_event = gcal_service.create_event(
                summary=summary,
                start_time=start_time,
                end_time=end_time,
                description=f"Paciente: {appointment_data['first_name']}\nTel: {appointment_data['phone_number']}\nNotas: {apt.notes or ''}"
            )
            
            if gcal_event:
                await db.pool.execute(
                    "UPDATE appointments SET google_calendar_event_id = $1, google_calendar_sync_status = 'synced' WHERE id = $2",
                    gcal_event['id'], new_id
                )
        except Exception as ge:
            print(f"Error syncing with GCal: {ge}")

        # 6. Emitir evento de Socket.IO para actualizaci√≥n en tiempo real
        if appointment_data:
            await emit_appointment_event("NEW_APPOINTMENT", dict(appointment_data), request)
        
        return {"id": new_id, "status": "confirmed", "patient_id": pid, "source": "manual"}
        
    except asyncpg.ForeignKeyViolationError:
        raise HTTPException(status_code=400, detail="ID de profesional o paciente no v√°lido")
    except asyncpg.UniqueViolationError:
        raise HTTPException(status_code=409, detail="Turno duplicado para ese horario")
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Error creando turno: {str(e)}")

@router.patch("/appointments/{id}/status", dependencies=[Depends(verify_admin_token)])
async def update_appointment_status(id: str, status: str, request: Request):
    """Cambiar estado: confirmed, cancelled, attended, no_show."""
    await db.pool.execute("UPDATE appointments SET status = $1 WHERE id = $2", status, id)
    
    # Obtener datos actualizados del turno para emitir evento
    appointment_data = await db.pool.fetchrow("""
        SELECT a.id, a.patient_id, a.professional_id, a.appointment_datetime, 
               a.appointment_type, a.status, a.urgency_level,
               p.first_name, p.last_name, p.phone_number,
               prof.first_name as professional_name,
               a.google_calendar_event_id, a.google_calendar_sync_status
        FROM appointments a
        JOIN patients p ON a.patient_id = p.id
        JOIN professionals prof ON a.professional_id = prof.id
        WHERE a.id = $1
    """, id)
    
    if appointment_data:
        # 1. Sincronizar cancelaci√≥n con Google Calendar
        if status == 'cancelled' and appointment_data['google_calendar_event_id']:
            try:
                gcal_service.delete_event(appointment_data['google_calendar_event_id'])
                await db.pool.execute(
                    "UPDATE appointments SET google_calendar_sync_status = 'cancelled' WHERE id = $1",
                    id
                )
            except Exception as ge:
                print(f"Error deleting GCal event: {ge}")

        # 2. Emitir evento seg√∫n el nuevo estado
        if status == 'cancelled':
            await emit_appointment_event("APPOINTMENT_DELETED", {"id": id}, request)
        else:
            await emit_appointment_event("APPOINTMENT_UPDATED", dict(appointment_data), request)
    
    return {"status": "updated"}

# ==================== ENDPOINTS SLOTS DISPONIBLES ====================

class NextSlotsResponse(BaseModel):
    slot_start: str
    slot_end: str
    duration_minutes: int
    professional_id: int
    professional_name: str

@router.get("/appointments/next-slots", response_model=List[NextSlotsResponse], dependencies=[Depends(verify_admin_token)])
async def get_next_available_slots(
    days_ahead: int = 3,
    slot_duration_minutes: int = 20
):
    """
    Obtiene los pr√≥ximos huecos disponibles para urgencias (triaje de 15-20 minutos).
    
    Busca gaps en la agenda de los pr√≥ximos N d√≠as considerando:
    - Turnos existentes
    - Bloques de Google Calendar
    - Horario laboral: 9:00 a 18:00
    
    Returns:
        Lista de los pr√≥ximos 3-5 huecos disponibles
    """
    import random
    
    # Obtener profesionales activos
    professionals = await db.pool.fetch("""
        SELECT id, first_name, last_name 
        FROM professionals 
        WHERE is_active = true
    """)
    
    if not professionals:
        return []
    
    available_slots: List[Dict[str, Any]] = []
    today = datetime.now().replace(hour=0, minute=0, second=0, microsecond=0)
    
    for day_offset in range(days_ahead + 1):
        current_date = today + timedelta(days=day_offset)
        
        # Skip weekends
        if current_date.weekday() >= 5:
            continue
            
        day_start = current_date.replace(hour=9, minute=0, second=0, microsecond=0)
        day_end = current_date.replace(hour=18, minute=0, second=0, microsecond=0)
        
        for prof in professionals:
            prof_id = prof['id']
            prof_name = f"{prof['first_name']} {prof.get('last_name', '')}".strip()
            
            # Obtener turnos del d√≠a para este profesional
            appointments = await db.pool.fetch("""
                SELECT appointment_datetime, duration_minutes
                FROM appointments
                WHERE professional_id = $1
                AND DATE(appointment_datetime) = $2
                AND status NOT IN ('cancelled', 'no-show')
                ORDER BY appointment_datetime ASC
            """, prof_id, current_date.date())
            
            # Obtener bloques de GCalendar del d√≠a
            gcal_blocks = await db.pool.fetch("""
                SELECT start_datetime, end_datetime
                FROM google_calendar_blocks
                WHERE (professional_id = $1 OR professional_id IS NULL)
                AND DATE(start_datetime) = $2
                ORDER BY start_datetime ASC
            """, prof_id, current_date.date())
            
            # Crear lista de busy periods (turnos + bloques)
            busy_periods = []
            
            for apt in appointments:
                apt_start = apt['appointment_datetime']
                apt_end = apt_start + timedelta(minutes=apt.get('duration_minutes', 60))
                busy_periods.append((apt_start, apt_end))
            
            for block in gcal_blocks:
                busy_periods.append((block['start_datetime'], block['end_datetime']))
            
            # Ordenar por inicio
            busy_periods.sort(key=lambda x: x[0])
            
            # Encontrar gaps
            current_time = day_start
            
            for busy_start, busy_end in busy_periods:
                # Verificar gap antes del primer ocupado
                if current_time < busy_start:
                    gap_duration = int((busy_start - current_time).total_seconds() / 60)
                    if gap_duration >= slot_duration_minutes - 5:  # Allow 5 min tolerance
                        slot_start = current_time
                        slot_end = slot_start + timedelta(minutes=slot_duration_minutes)
                        available_slots.append({
                            "slot_start": slot_start.isoformat(),
                            "slot_end": slot_end.isoformat(),
                            "duration_minutes": slot_duration_minutes,
                            "professional_id": prof_id,
                            "professional_name": prof_name
                        })
                
                current_time = max(current_time, busy_end)
            
            # Verificar gap despu√©s del √∫ltimo ocupado hasta fin del d√≠a
            if current_time < day_end:
                gap_duration = int((day_end - current_time).total_seconds() / 60)
                if gap_duration >= slot_duration_minutes - 5:
                    slot_start = current_time
                    slot_end = slot_start + timedelta(minutes=slot_duration_minutes)
                    available_slots.append({
                        "slot_start": slot_start.isoformat(),
                        "slot_end": slot_end.isoformat(),
                        "duration_minutes": slot_duration_minutes,
                        "professional_id": prof_id,
                        "professional_name": prof_name
                    })
    
    # Ordenar por fecha y hora, tomar los primeros 5
    available_slots.sort(key=lambda x: x['slot_start'])
    return available_slots[:5]


# ==================== ENDPOINTS PROFESIONALES ====================

@router.get("/professionals", dependencies=[Depends(verify_admin_token)])
async def list_professionals():
    rows = await db.pool.fetch("SELECT id, first_name, last_name, specialization, is_active FROM professionals")
    return [dict(row) for row in rows]

# ==================== ENDPOINTS GOOGLE CALENDAR ====================

@router.get("/calendar/blocks", dependencies=[Depends(verify_admin_token)])
async def get_calendar_blocks(start_date: str, end_date: str):
    """Obtener bloques de Google Calendar para el per√≠odo."""
    try:
        rows = await db.pool.fetch("""
            SELECT id, google_event_id, title, description,
                   start_datetime, end_datetime, all_day,
                   professional_id, sync_status
            FROM google_calendar_blocks
            WHERE start_datetime BETWEEN $1 AND $2
            ORDER BY start_datetime ASC
        """, datetime.fromisoformat(start_date), datetime.fromisoformat(end_date))
        
        return [dict(row) for row in rows]
    except Exception:
        # Si la tabla no existe, retornar array vac√≠o (para desarrollo)
        return []


@router.post("/calendar/blocks", dependencies=[Depends(verify_admin_token)])
async def create_calendar_block(block: GCalendarBlockCreate):
    """Crear un bloque de calendario (simulado para desarrollo)."""
    try:
        new_id = str(uuid.uuid4())
        await db.pool.execute("""
            INSERT INTO google_calendar_blocks (
                id, google_event_id, title, description,
                start_datetime, end_datetime, all_day, professional_id, sync_status, created_at
            ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, 'synced', NOW())
        """, new_id, block.google_event_id, block.title, block.description,
             block.start_datetime, block.end_datetime, block.all_day, block.professional_id)
        
        return {"id": new_id, "status": "created"}
    except Exception as e:
        # Si la tabla no existe, retornar success simulado
        return {"id": str(uuid.uuid4()), "status": "simulated", "message": str(e)}


@router.delete("/calendar/blocks/{block_id}", dependencies=[Depends(verify_admin_token)])
async def delete_calendar_block(block_id: str):
    """Eliminar un bloque de Google Calendar."""
    await db.pool.execute("DELETE FROM google_calendar_blocks WHERE id = $1", block_id)
    return {"status": "deleted"}


@router.post("/sync/calendar", dependencies=[Depends(verify_admin_token)])
async def trigger_sync():
    """
    Sincronizaci√≥n REAL con Google Calendar.
    Trae eventos de GCal que NO son appointments y los guarda como bloqueos.
    """
    try:
        # 1. Obtener eventos de los pr√≥ximos 30 d√≠as
        time_min = datetime.now().isoformat() + 'Z'
        time_max = (datetime.now() + timedelta(days=30)).isoformat() + 'Z'
        
        events = gcal_service.list_events(time_min=time_min, time_max=time_max)
        
        created = 0
        updated = 0
        
        # Obtener IDs de eventos que ya tenemos para saber si es update o create
        existing_google_ids = await db.pool.fetch("SELECT google_event_id FROM google_calendar_blocks")
        existing_ids_set = {row['google_event_id'] for row in existing_google_ids}
        
        # Tambien obtener los IDs de eventos que son APPOINTMENTS para no duplicarlos
        appointment_google_ids = await db.pool.fetch("SELECT google_calendar_event_id FROM appointments WHERE google_calendar_event_id IS NOT NULL")
        apt_ids_set = {row['google_calendar_event_id'] for row in appointment_google_ids}

        tenant_id = await db.pool.fetchval("SELECT id FROM tenants LIMIT 1")

        for event in events:
            g_id = event['id']
            
            # Si el evento es un turno nuestro, lo ignoramos para no duplicarlo como "bloqueo"
            if g_id in apt_ids_set:
                continue
                
            summary = event.get('summary', 'Bloqueo GCal')
            description = event.get('description', '')
            start = event['start'].get('dateTime') or event['start'].get('date')
            end = event['end'].get('dateTime') or event['end'].get('date')
            all_day = 'date' in event['start']
            
            if g_id in existing_ids_set:
                await db.pool.execute("""
                    UPDATE google_calendar_blocks SET
                        title = $1, description = $2, start_datetime = $3, end_datetime = $4,
                        all_day = $5, updated_at = NOW()
                    WHERE google_event_id = $6
                """, summary, description, datetime.fromisoformat(start.replace('Z', '+00:00')), 
                     datetime.fromisoformat(end.replace('Z', '+00:00')), all_day, g_id)
                updated += 1
            else:
                await db.pool.execute("""
                    INSERT INTO google_calendar_blocks (
                        tenant_id, google_event_id, title, description,
                        start_datetime, end_datetime, all_day
                    ) VALUES ($1, $2, $3, $4, $5, $6, $7)
                """, tenant_id, g_id, summary, description, 
                     datetime.fromisoformat(start.replace('Z', '+00:00')), 
                     datetime.fromisoformat(end.replace('Z', '+00:00')), all_day)
                created += 1
        
        # Registrar sync en log
        await db.pool.execute("""
            INSERT INTO calendar_sync_log (
                tenant_id, sync_type, direction, events_processed, 
                events_created, events_updated, completed_at
            ) VALUES ($1, 'manual', 'inbound', $2, $3, $4, NOW())
        """, tenant_id, len(events), created, updated)
        
        return {
            "status": "success",
            "events_processed": len(events),
            "created": created,
            "updated": updated,
            "message": f"Sincronizaci√≥n completada. {created} nuevos, {updated} actualizados."
        }
    except Exception as e:
        return {
            "status": "error",
            "message": f"Error en sincronizaci√≥n: {str(e)}"
        }
# --- Funci√≥n Helper de Entorno (Legacy support) ---
async def sync_environment():
    """Crea el tenant default si no existe (Necesario para que arranque main.py)."""
    # Esta funci√≥n es llamada por main.py en el startup
    exists = await db.pool.fetchval("SELECT id FROM tenants LIMIT 1")
    if not exists:
        await db.pool.execute("""
            INSERT INTO tenants (store_name, bot_phone_number) 
            VALUES ('Cl√≠nica Dental', '5491100000000')
        """)
# ==================== ENDPOINTS TRATAMIENTOS ====================

class TreatmentTypeUpdate(BaseModel):
    name: str
    description: Optional[str] = None
    default_duration_minutes: int
    min_duration_minutes: int
    max_duration_minutes: int
    complexity_level: str
    category: str
    requires_multiple_sessions: bool = False
    session_gap_days: int = 0
    is_active: bool = True
    is_available_for_booking: bool = True
    internal_notes: Optional[str] = None


@router.get("/treatment-types", dependencies=[Depends(verify_admin_token)])
async def list_treatment_types():
    """Listar tipos de tratamiento con sus duraciones."""
    rows = await db.pool.fetch("""
        SELECT id, code, name, description, default_duration_minutes,
               min_duration_minutes, max_duration_minutes, complexity_level,
               category, requires_multiple_sessions, session_gap_days,
               is_active, is_available_for_booking, internal_notes
        FROM treatment_types
        ORDER BY category, name
    """)
    return [dict(row) for row in rows]


@router.get("/treatment-types/{code}", dependencies=[Depends(verify_admin_token)])
async def get_treatment_type(code: str):
    """Obtener un tipo de tratamiento espec√≠fico."""
    row = await db.pool.fetchrow("""
        SELECT id, code, name, description, default_duration_minutes,
               min_duration_minutes, max_duration_minutes, complexity_level,
               category, requires_multiple_sessions, session_gap_days,
               is_active, is_available_for_booking, internal_notes
        FROM treatment_types
        WHERE code = $1
    """, code)
    
    if not row:
        raise HTTPException(status_code=404, detail="Tipo de tratamiento no encontrado")
    
    return dict(row)


@router.put("/treatment-types/{code}", dependencies=[Depends(verify_admin_token)])
async def update_treatment_type(code: str, treatment: TreatmentTypeUpdate):
    """Actualizar configuraci√≥n de un tipo de tratamiento."""
    result = await db.pool.execute("""
        UPDATE treatment_types SET
            name = $1,
            description = $2,
            default_duration_minutes = $3,
            min_duration_minutes = $4,
            max_duration_minutes = $5,
            complexity_level = $6,
            category = $7,
            requires_multiple_sessions = $8,
            session_gap_days = $9,
            is_active = $10,
            is_available_for_booking = $11,
            internal_notes = $12,
            updated_at = NOW()
        WHERE code = $13
    """, treatment.name, treatment.description, treatment.default_duration_minutes,
        treatment.min_duration_minutes, treatment.max_duration_minutes,
        treatment.complexity_level, treatment.category, treatment.requires_multiple_sessions,
        treatment.session_gap_days, treatment.is_active, treatment.is_available_for_booking,
        treatment.internal_notes, code)
    
    if result == "UPDATE 0":
        raise HTTPException(status_code=404, detail="Tipo de tratamiento no encontrado")
    
    return {"status": "updated", "code": code}


@router.get("/treatment-types/{code}/duration", dependencies=[Depends(verify_admin_token)])
async def get_treatment_duration(code: str, urgency_level: str = "normal"):
    """
    Obtener duraci√≥n calculada para un tratamiento seg√∫n urgencia.
    
    Args:
        code: C√≥digo del tratamiento (ej: 'root_canal', 'cleaning')
        urgency_level: 'low', 'normal', 'high', 'emergency'
    
    Returns:
        duration_minutes: Duraci√≥n calculada en minutos
    """
    row = await db.pool.fetchrow("""
        SELECT default_duration_minutes, min_duration_minutes, max_duration_minutes
        FROM treatment_types
        WHERE code = $1 AND is_active = TRUE AND is_available_for_booking = TRUE
    """, code)
    
    if not row:
        # Return default duration if treatment not found
        return {"duration_minutes": 30, "source": "default"}
    
    default_duration = row['default_duration_minutes']
    min_duration = row['min_duration_minutes']
    max_duration = row['max_duration_minutes']
    
    # Calculate duration based on urgency
    if urgency_level == 'emergency':
        calculated_duration = min(min_duration, default_duration)
    elif urgency_level == 'high':
        calculated_duration = default_duration
    elif urgency_level == 'normal':
        calculated_duration = default_duration
    else:  # low
        calculated_duration = max(default_duration, max_duration)
    
    return {
        "duration_minutes": calculated_duration,
        "source": "calculated",
        "treatment_code": code,
        "urgency_level": urgency_level,
        "details": {
            "default": default_duration,
            "min": min_duration,
            "max": max_duration
        }
    }
````

## File: orchestrator_service/auth_routes.py
````python
from fastapi import APIRouter, HTTPException, Depends, Request, status
from pydantic import BaseModel, EmailStr
from typing import Optional
import uuid
import logging
from db import db
from auth_service import auth_service

router = APIRouter(prefix="/auth", tags=["Nexus Auth"])
logger = logging.getLogger("auth_routes")

# --- MODELS ---

class UserLogin(BaseModel):
    email: EmailStr
    password: str

class UserRegister(BaseModel):
    email: EmailStr
    password: str
    role: str = "professional" # Default for self-reg if enabled
    first_name: str
    last_name: Optional[str] = ""

class TokenResponse(BaseModel):
    access_token: str
    token_type: str
    user: dict

# --- ROUTES ---

@router.post("/register")
async def register(payload: UserRegister):
    """
    Registers a new user in 'pending' status.
    Implements Protocol Omega for fail-safe activation.
    """
    # 1. Check if user exists
    existing = await db.fetchval("SELECT id FROM users WHERE email = $1", payload.email)
    if existing:
        raise HTTPException(status_code=400, detail="El correo ya se encuentra registrado.")

    # 2. Hash password
    password_hash = auth_service.get_password_hash(payload.password)
    user_id = str(uuid.uuid4())
    
    # 3. Save User
    try:
        await db.execute("""
            INSERT INTO users (id, email, password_hash, role, status)
            VALUES ($1, $2, $3, $4, 'pending')
        """, user_id, payload.email, password_hash, payload.role)
        
        # 4. If professional, create profile record
        if payload.role == "professional":
            await db.execute("""
                INSERT INTO professionals (tenant_id, user_id, first_name, last_name, email, is_active)
                VALUES (1, $1, $2, $3, $4, FALSE)
            """, user_id, payload.first_name, payload.last_name, payload.email)

        # 5. Protocol Omega: Log activation token (simulated for now)
        activation_token = str(uuid.uuid4())
        auth_service.log_protocol_omega_activation(payload.email, activation_token)
        
        return {
            "status": "pending",
            "message": "Registro exitoso. Tu cuenta est√° pendiente de aprobaci√≥n por el CEO.",
            "user_id": user_id
        }
    except Exception as e:
        logger.error(f"Error registering user: {e}")
        raise HTTPException(status_code=500, detail="Error interno durante el registro.")

@router.post("/login", response_model=TokenResponse)
async def login(payload: UserLogin):
    """ Authenticates user and returns JWT. Checks for 'active' status. """
    user = await db.fetchrow("SELECT * FROM users WHERE email = $1", payload.email)
    
    if not user:
        raise HTTPException(status_code=401, detail="Credenciales inv√°lidas.")
    
    if not auth_service.verify_password(payload.password, user['password_hash']):
        raise HTTPException(status_code=401, detail="Credenciales inv√°lidas.")
    
    if user['status'] != 'active':
        raise HTTPException(
            status_code=403, 
            detail=f"Tu cuenta est√° en estado '{user['status']}'. Contact√° al administrador."
        )

    # Success: Generate Token
    # For now, tenant_id is 1 (Nexus Universal)
    token_data = {
        "user_id": str(user['id']),
        "email": user['email'],
        "role": user['role'],
        "tenant_id": 1 
    }
    
    token = auth_service.create_access_token(token_data)
    
    return {
        "access_token": token,
        "token_type": "bearer",
        "user": {
            "id": str(user['id']),
            "email": user['email'],
            "role": user['role']
        }
    }

@router.get("/me")
async def get_me(request: Request):
    """ Returns the current authenticated user data. """
    auth_header = request.headers.get("Authorization")
    if not auth_header or not auth_header.startswith("Bearer "):
        raise HTTPException(status_code=status.HTTP_401_UNAUTHORIZED, detail="Not authenticated")
    
    token = auth_header.split(" ")[1]
    token_data = auth_service.decode_token(token)
    
    if not token_data:
        raise HTTPException(status_code=status.HTTP_401_UNAUTHORIZED, detail="Invalid token")
        
    return token_data
````

## File: orchestrator_service/auth_service.py
````python
import os
import logging
import jwt
from datetime import datetime, timedelta
from typing import Optional, Dict, Any
from passlib.context import CryptContext
from pydantic import BaseModel

logger = logging.getLogger("auth_service")

# --- SETTINGS ---
SECRET_KEY = os.getenv("INTERNAL_SECRET_KEY", "nexus-super-secret-key-v7.6")
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 60 * 24 * 7  # 1 week

# Password Hashing context
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

class TokenData(BaseModel):
    user_id: str
    email: str
    role: str
    tenant_id: int

class AuthService:
    @staticmethod
    def get_password_hash(password: str) -> str:
        # Bcrypt has a 72-byte limit. We truncate to ensure stability.
        # This is safe as anything beyond 72 is ignored by bcrypt anyway.
        safe_password = password[:72]
        return pwd_context.hash(safe_password)

    @staticmethod
    def verify_password(plain_password: str, hashed_password: str) -> bool:
        safe_password = plain_password[:72]
        return pwd_context.verify(safe_password, hashed_password)

    @staticmethod
    def create_access_token(data: Dict[str, Any], expires_delta: Optional[timedelta] = None) -> str:
        to_encode = data.copy()
        if expires_delta:
            expire = datetime.utcnow() + expires_delta
        else:
            expire = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
        
        to_encode.update({"exp": expire})
        encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)
        return encoded_jwt

    @staticmethod
    def decode_token(token: str) -> Optional[TokenData]:
        try:
            payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
            user_id: str = payload.get("user_id")
            email: str = payload.get("email")
            role: str = payload.get("role")
            tenant_id: int = payload.get("tenant_id")
            
            if user_id is None or email is None or role is None or tenant_id is None:
                return None
                
            return TokenData(
                user_id=user_id,
                email=email,
                role=role,
                tenant_id=tenant_id
            )
        except Exception as e:
            logger.error(f"Error decoding token: {e}")
            return None

    @staticmethod
    def log_protocol_omega_activation(email: str, activation_token: str):
        """
        Nexus Protocol Omega: 
        Always log the activation link in case of SMTP failure.
        """
        # Try to use PLATFORM_URL from env, otherwise fallback to frontend production URL
        base_url = os.getenv("PLATFORM_URL", "https://dentalogic-frontend.ugwrjq.easypanel.host")
        activation_url = f"{base_url}/activate?token={activation_token}&email={email}"
        
        logger.warning("üõ°Ô∏è [PROTOCOL OMEGA] ACTIVATION LINK GENERATED (SMTP FAIL-SAFE)")
        logger.warning(f"üõ°Ô∏è User: {email}")
        logger.warning(f"üõ°Ô∏è Link: {activation_url}")
        logger.warning("üõ°Ô∏è ---------------------------------------------------------")

auth_service = AuthService()
````

## File: orchestrator_service/db.py
````python
import asyncpg
import os
import json
from typing import List, Tuple, Optional

POSTGRES_DSN = os.getenv("POSTGRES_DSN")

class Database:
    def __init__(self):
        self.pool: Optional[asyncpg.Pool] = None

    async def connect(self):
        """Conecta al pool de PostgreSQL y ejecuta auto-migraciones."""
        if not self.pool:
            if not POSTGRES_DSN:
                print("‚ùå ERROR: POSTGRES_DSN environment variable is not set!")
                return

            # asyncpg no soporta el esquema 'postgresql+asyncpg', solo 'postgresql' o 'postgres'
            dsn = POSTGRES_DSN.replace("postgresql+asyncpg://", "postgresql://")
            
            try:
                self.pool = await asyncpg.create_pool(dsn)
            except Exception as e:
                print(f"‚ùå ERROR: Failed to create database pool: {e}")
                return
            
            # Auto-Migration: Ejecutar dentalogic_schema.sql si las tablas no existen
            await self._run_auto_migrations()
    
    async def _run_auto_migrations(self):
        """
        Sistema de Auto-Migraci√≥n (Maintenance Robot / Schema Surgeon).
        Se asegura de que la base de datos est√© siempre actualizada y saludable.
        """
        import logging
        logger = logging.getLogger("db")
        
        try:
            # 1. Auditor√≠a de Salud: ¬øExiste la base m√≠nima?
            async with self.pool.acquire() as conn:
                schema_exists = await conn.fetchval("""
                    SELECT EXISTS (
                        SELECT FROM information_schema.tables 
                        WHERE table_name = 'tenants'
                    )
                """)
            
            # 2. Aplicar Base (Foundation) si es un Fresh Install
            if not schema_exists:
                logger.warning("‚ö†Ô∏è Base de datos vac√≠a, aplicando Foundation...")
                await self._apply_foundation(logger)
            
            # 3. Evoluci√≥n Continua (Pipeline de Cirug√≠a)
            # Aqu√≠ agregamos parches espec√≠ficos que deben correr siempre de forma segura
            await self._run_evolution_pipeline(logger)
            
            logger.info("‚úÖ Base de datos verificada y actualizada (Maintenance Robot OK)")
            
        except Exception as e:
            import traceback
            logger.error(f"‚ùå Error en Maintenance Robot: {e}")
            logger.error(traceback.format_exc())

    async def _apply_foundation(self, logger):
        """Ejecuta el esquema base dentalogic_schema.sql"""
        possible_paths = [
            os.path.join(os.path.dirname(__file__), "..", "db", "init", "dentalogic_schema.sql"),
            os.path.join(os.path.dirname(__file__), "db", "init", "dentalogic_schema.sql"),
            "/app/db/init/dentalogic_schema.sql"
        ]
        
        schema_path = next((p for p in possible_paths if os.path.exists(p)), None)
        if not schema_path:
            logger.error("‚ùå Foundation schema not found!")
            return

        with open(schema_path, "r", encoding="utf-8") as f:
            schema_sql = f.read()

        # Limpiar comentarios y separar sentencias respetando $$
        clean_lines = [line.split('--')[0].rstrip() for line in schema_sql.splitlines()]
        clean_sql = "\n".join(clean_lines)
        
        statements = []
        current_stmt = []
        in_dollar = False
        for line in clean_sql.splitlines():
            if "$$" in line:
                in_dollar = not in_dollar if line.count("$$") % 2 != 0 else in_dollar
            current_stmt.append(line)
            if not in_dollar and ";" in line:
                full = "\n".join(current_stmt).strip()
                if full: statements.append(full)
                current_stmt = []
        
        if current_stmt:
            leftover = "\n".join(current_stmt).strip()
            if leftover: statements.append(leftover)

        async with self.pool.acquire() as conn:
            async with conn.transaction():
                for i, stmt in enumerate(statements):
                    await conn.execute(stmt)
        logger.info(f"‚úÖ Foundation aplicada ({len(statements)} sentencias)")

    async def _run_evolution_pipeline(self, logger):
        """
        Pipeline de Cirug√≠a: Parches acumulativos e independientes.
        Agrega aqu√≠ bloques DO $$ que aseguren la evoluci√≥n del esquema.
        """
        patches = [
            # Parche 1: Asegurar tabla 'users' y columna 'user_id' en 'professionals'
            """
            DO $$ 
            BEGIN 
                -- Asegurar columna user_id en professionals
                IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='professionals' AND column_name='user_id') THEN
                    ALTER TABLE professionals ADD COLUMN user_id UUID REFERENCES users(id) ON DELETE SET NULL;
                END IF;
            END $$;
            """,
            # Parche 2: Auto-activaci√≥n del primer CEO (Protocolo Omega Prime)
            """
            DO $$ 
            BEGIN 
                -- Si existe un usuario CEO en estado pending, lo activamos
                UPDATE users SET status = 'active' 
                WHERE role = 'ceo' AND status = 'pending';
                
                -- Aseguramos que su perfil profesional tambi√©n est√© activo
                UPDATE professionals SET is_active = TRUE 
                WHERE email IN (SELECT email FROM users WHERE role = 'ceo' AND status = 'active');
            END $$;
            """,
            # Agrega m√°s parches aqu√≠ en el futuro...
            # Parche 3: Permitir DNI y Apellido nulos para 'guests' (Chat Users)
            """
            DO $$ 
            BEGIN 
                -- Hacer dni nullable
                ALTER TABLE patients ALTER COLUMN dni DROP NOT NULL;
                
                -- Hacer last_name nullable
                ALTER TABLE patients ALTER COLUMN last_name DROP NOT NULL;
                
                -- El constraint de unique dni debe ignorar nulos (Postgres lo hace por defecto, pero revisamos index)
            EXCEPTION
                WHEN others THEN null; -- Ignorar si ya se aplic√≥ o falla
            END $$;
            """,
        ]

        async with self.pool.acquire() as conn:
            async with conn.transaction():
                for i, patch in enumerate(patches):
                    try:
                        await conn.execute(patch)
                    except Exception as e:
                        logger.error(f"‚ùå Error aplicando parche evolutivo {i+1}: {e}")
                        # En evoluci√≥n, a veces es mejor fallar r√°pido para no corromper
                        raise e

    async def disconnect(self):
        if self.pool:
            await self.pool.close()

    async def try_insert_inbound(self, provider: str, provider_message_id: str, event_id: str, from_number: str, payload: dict, correlation_id: str) -> bool:
        """Try to insert inbound message. Returns True if inserted, False if duplicate."""
        query = """
        INSERT INTO inbound_messages (provider, provider_message_id, event_id, from_number, payload, status, correlation_id)
        VALUES ($1, $2, $3, $4, $5, 'received', $6)
        ON CONFLICT (provider, provider_message_id) DO NOTHING
        RETURNING id
        """
        async with self.pool.acquire() as conn:
            result = await conn.fetchval(query, provider, provider_message_id, event_id, from_number, json.dumps(payload), correlation_id)
            return result is not None

    async def mark_inbound_processing(self, provider: str, provider_message_id: str):
        query = "UPDATE inbound_messages SET status = 'processing' WHERE provider = $1 AND provider_message_id = $2"
        async with self.pool.acquire() as conn:
            await conn.execute(query, provider, provider_message_id)

    async def mark_inbound_done(self, provider: str, provider_message_id: str):
        query = "UPDATE inbound_messages SET status = 'done', processed_at = NOW() WHERE provider = $1 AND provider_message_id = $2"
        async with self.pool.acquire() as conn:
            await conn.execute(query, provider, provider_message_id)

    async def mark_inbound_failed(self, provider: str, provider_message_id: str, error: str):
        query = "UPDATE inbound_messages SET status = 'failed', processed_at = NOW(), error = $3 WHERE provider = $1 AND provider_message_id = $2"
        async with self.pool.acquire() as conn:
            await conn.execute(query, provider, provider_message_id, error)

    async def append_chat_message(self, from_number: str, role: str, content: str, correlation_id: str):
        query = "INSERT INTO chat_messages (from_number, role, content, correlation_id) VALUES ($1, $2, $3, $4)"
        async with self.pool.acquire() as conn:
            await conn.execute(query, from_number, role, content, correlation_id)

    async def ensure_patient_exists(self, phone_number: str, first_name: str = 'Visitante'):
        """Ensures a patient record exists for the given phone number."""
        query = """
        INSERT INTO patients (tenant_id, phone_number, first_name, status, created_at)
        VALUES (1, $1, $2, 'guest', NOW())
        ON CONFLICT (tenant_id, phone_number) 
        DO UPDATE SET first_name = EXCLUDED.first_name, updated_at = NOW() 
        WHERE patients.status = 'guest'
        RETURNING id
        """
        async with self.pool.acquire() as conn:
            await conn.execute(query, phone_number, first_name)

    async def get_chat_history(self, from_number: str, limit: int = 15) -> List[dict]:
        """Returns list of {'role': ..., 'content': ...} in chronological order."""
        query = "SELECT role, content FROM chat_messages WHERE from_number = $1 ORDER BY created_at DESC LIMIT $2"
        async with self.pool.acquire() as conn:
            rows = await conn.fetch(query, from_number, limit)
            return [dict(row) for row in reversed(rows)]

    # --- WRAPPER METHODS PARA TOOLS (acceso directo al pool) ---
    async def fetch(self, query: str, *args):
        """Wrapper para pool.fetch - usado por check_availability."""
        async with self.pool.acquire() as conn:
            return await conn.fetch(query, *args)
    
    async def fetchrow(self, query: str, *args):
        """Wrapper para pool.fetchrow - usado por book_appointment."""
        async with self.pool.acquire() as conn:
            return await conn.fetchrow(query, *args)
    
    async def fetchval(self, query: str, *args):
        """Wrapper para pool.fetchval."""
        async with self.pool.acquire() as conn:
            return await conn.fetchval(query, *args)
    
    async def execute(self, query: str, *args):
        """Wrapper para pool.execute - usado por book_appointment."""
        async with self.pool.acquire() as conn:
            return await conn.execute(query, *args)

# Global instance
db = Database()
````

## File: orchestrator_service/debug_creds.py
````python
import asyncio
import os
from db import db
from dotenv import load_dotenv

async def check():
    load_dotenv()
    await db.connect()
    tenants = await db.pool.fetch("SELECT * FROM tenants")
    print(f"Tenants in DB: {len(tenants)}")
    for t in tenants:
        print(f"ID: {t['id']}, Name: {t['store_name']}, Phone: {t['bot_phone_number']}")
    
    creds = await db.pool.fetch("SELECT name, value, scope FROM credentials WHERE name = 'OPENAI_API_KEY'")
    for c in creds:
        val = c['value']
        masked = val[:7] + "..." + val[-4:] if val else "None"
        print(f"Cred: {c['name']}, Scope: {c['scope']}, Value: {masked}")
    
    env_key = os.getenv("OPENAI_API_KEY")
    masked_env = env_key[:7] + "..." + env_key[-4:] if env_key else "None"
    print(f"Env Key: {masked_env}")
    
    await db.disconnect()

if __name__ == "__main__":
    asyncio.run(check())
````

## File: orchestrator_service/debug_db_check.py
````python
import asyncio
import asyncpg
import os

# Usamos la DSN directa para evitar problemas de importaci√≥n
DSN = 'postgresql://postgres:password@localhost:5432/clinica_dental_db'

async def main():
    print(f"Connecting to {DSN}...")
    try:
        pool = await asyncpg.create_pool(DSN)
        async with pool.acquire() as conn:
            print("\n--- PATIENTS ---")
            patients = await conn.fetch("SELECT id, phone_number, first_name, last_name FROM patients")
            if not patients:
                print("No patients found.")
            for p in patients:
                print(dict(p))
            
            print("\n--- CHAT MESSAGES (Last 10) ---")
            messages = await conn.fetch("SELECT id, from_number, role, content FROM chat_messages ORDER BY created_at DESC LIMIT 10")
            if not messages:
                print("No messages found.")
            for m in messages:
                print(dict(m))
                
        await pool.close()
    except Exception as e:
        print(f"Error: {e}")

if __name__ == "__main__":
    asyncio.run(main())
````

## File: orchestrator_service/Dockerfile
````
FROM python:3.11-slim

ENV PYTHONUNBUFFERED=1

WORKDIR /app

COPY requirements.txt .

RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

CMD ["uvicorn", "main:socket_app", "--host", "0.0.0.0", "--port", "8000"]
````

## File: orchestrator_service/email_service.py
````python
import os
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
import logging

logger = logging.getLogger("email_service")

class EmailService:
    def __init__(self):
        self.smtp_host = os.getenv("SMTP_HOST", "")
        self.smtp_port = int(os.getenv("SMTP_PORT", "587"))
        self.smtp_user = os.getenv("SMTP_USER", "")
        self.smtp_pass = os.getenv("SMTP_PASS", "")
        self.smtp_sender = os.getenv("SMTP_SENDER", "")

    def send_handoff_email(self, to_email: str, patient_name: str, phone: str, reason: str, chat_history_preview: str = ""):
        """
        Env√≠a un correo de notificaci√≥n de derivaci√≥n humana.
        """
        if not self.smtp_host or not self.smtp_user:
            logger.warning("‚ö†Ô∏è SMTP not configured. Skipping email.")
            return False

        try:
            msg = MIMEMultipart("alternative")
            msg["Subject"] = f"üîî Derivaci√≥n Humana: {patient_name} ({phone})"
            msg["From"] = self.smtp_sender
            msg["To"] = to_email

            # Create WhatsApp Link
            wa_link = f"https://wa.me/{phone.replace('+', '')}"

            html_content = f"""
            <html>
            <body style="font-family: Arial, sans-serif; color: #333;">
                <div style="background-color: #f8f9fa; padding: 20px; text-align: center;">
                    <h2 style="color: #0d6efd;">Nueva Derivaci√≥n de IA</h2>
                </div>
                <div style="padding: 20px;">
                    <p>Hola,</p>
                    <p>El agente de IA ha derivado un chat que requiere atenci√≥n humana.</p>
                    
                    <div style="background-color: #e9ecef; padding: 15px; border-radius: 5px; margin: 15px 0;">
                        <p><strong>Paciente:</strong> {patient_name}</p>
                        <p><strong>Tel√©fono:</strong> {phone}</p>
                        <p><strong>Motivo:</strong> {reason}</p>
                    </div>

                    <p><strong>√öltima interacci√≥n:</strong></p>
                    <blockquote style="border-left: 3px solid #ccc; padding-left: 10px; color: #666;">
                        {chat_history_preview}
                    </blockquote>

                    <br/>
                    <a href="{wa_link}" style="background-color: #25D366; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; font-weight: bold;">
                        Abrir Chat en WhatsApp
                    </a>
                    
                    <p style="margin-top: 20px; font-size: 12px; color: #999;">
                        Este es un mensaje autom√°tico del sistema Dentalogic.
                    </p>
                </div>
            </body>
            </html>
            """

            msg.attach(MIMEText(html_content, "html"))

            if self.smtp_port == 465:
                # SSL connection (Implicit SSL)
                server = smtplib.SMTP_SSL(self.smtp_host, self.smtp_port)
            else:
                # TLS connection (STARTTLS)
                server = smtplib.SMTP(self.smtp_host, self.smtp_port)
                server.starttls()

            server.login(self.smtp_user, self.smtp_pass)
            server.sendmail(self.smtp_sender, to_email, msg.as_string())
            server.quit()
            
            logger.info(f"üìß Email de derivaci√≥n enviado a {to_email}")
            return True

        except Exception as e:
            logger.error(f"‚ùå Error sending email: {e}")
            return False

email_service = EmailService()
````

## File: orchestrator_service/fix_orphaned_chats.py
````python
import asyncio
import os
# Force 127.0.0.1 to avoid Windows localhost/IPv6 issues
if not os.getenv("POSTGRES_DSN"):
    os.environ["POSTGRES_DSN"] = "postgresql://postgres:password@127.0.0.1:5432/clinica_dental_db"

from db import db

async def main():
    print("üîå Conectando a Base de Datos (127.0.0.1)...")
    await db.connect()
    
    # Find unique numbers in chat_messages that are NOT in patients
    print("üîç Buscando conversaciones hu√©rfanas...")
    rows = await db.pool.fetch("""
        SELECT DISTINCT from_number 
        FROM chat_messages 
        WHERE from_number NOT IN (SELECT phone_number FROM patients)
    """)
    
    print(f"‚ö†Ô∏è Encontrados {len(rows)} n√∫meros sin ficha de paciente.")
    
    for row in rows:
        phone = row['from_number']
        print(f"üõ†Ô∏è Restaurando ficha para: {phone}")
        await db.ensure_patient_exists(phone)
        
    print("‚úÖ Reparaci√≥n completada.")
    await db.disconnect()

if __name__ == "__main__":
    asyncio.run(main())
````

## File: orchestrator_service/gcal_service.py
````python
import os
import json
import logging
from datetime import datetime
from google.oauth2 import service_account
from googleapiclient.discovery import build
from googleapiclient.errors import HttpError

logger = logging.getLogger(__name__)

# ==================== CONFIGURATION ====================
# The credentials can be a path to a file or a JSON string in environment variable
GOOGLE_CREDENTIALS_JSON = os.getenv("GOOGLE_CREDENTIALS")
GOOGLE_CALENDAR_ID = os.getenv("GOOGLE_CALENDAR_ID", "primary")

class GCalService:
    def __init__(self):
        self.service = self._authenticate()

    def _authenticate(self):
        """
        Authenticates with Google Calendar API using Service Account.
        """
        if not GOOGLE_CREDENTIALS_JSON:
            logger.warning("GOOGLE_CREDENTIALS not found in environment variables. GCal integration disabled.")
            return None

        try:
            # Parse the JSON string
            creds_info = json.loads(GOOGLE_CREDENTIALS_JSON)
            scopes = ['https://www.googleapis.com/auth/calendar']
            
            creds = service_account.Credentials.from_service_account_info(
                creds_info, scopes=scopes
            )
            return build('calendar', 'v3', credentials=creds)
        except Exception as e:
            logger.error(f"Error authenticating with Google Calendar: {e}")
            return None

    def list_events(self, time_min=None, time_max=None, calendar_id=None):
        """
        Lists events from the specified calendar.
        """
        if not self.service:
            return []

        cal_id = calendar_id or GOOGLE_CALENDAR_ID
        try:
            events_result = self.service.events().list(
                calendarId=cal_id,
                timeMin=time_min,
                timeMax=time_max,
                singleEvents=True,
                orderBy='startTime'
            ).execute()
            return events_result.get('items', [])
        except HttpError as error:
            logger.error(f"An error occurred: {error}")
            return []

    def create_event(self, summary, start_time, end_time, description=None, calendar_id=None):
        """
        Creates a new event in the specified calendar.
        summary: Title of the event
        start_time: ISO format string (e.g., '2025-05-28T09:00:00Z')
        end_time: ISO format string
        """
        if not self.service:
            return None

        cal_id = calendar_id or GOOGLE_CALENDAR_ID
        event = {
            'summary': summary,
            'description': description,
            'start': {
                'dateTime': start_time,
                'timeZone': 'America/Argentina/Buenos_Aires',
            },
            'end': {
                'dateTime': end_time,
                'timeZone': 'America/Argentina/Buenos_Aires',
            },
        }

        try:
            event = self.service.events().insert(calendarId=cal_id, body=event).execute()
            logger.info(f"Event created: {event.get('htmlLink')}")
            return event
        except HttpError as error:
            logger.error(f"An error occurred while creating event: {error}")
            return None

    def delete_event(self, event_id, calendar_id=None):
        """
        Deletes an event from the specified calendar.
        """
        if not self.service:
            return False

        cal_id = calendar_id or GOOGLE_CALENDAR_ID
        try:
            self.service.events().delete(calendarId=cal_id, eventId=event_id).execute()
            logger.info(f"Event deleted: {event_id}")
            return True
        except HttpError as error:
            logger.error(f"An error occurred while deleting event: {error}")
            return False

# Singleton instance
gcal_service = GCalService()
````

## File: orchestrator_service/main.py
````python
import os
import json
import logging
import asyncio
import uuid
from datetime import datetime, timedelta, date, timezone
from typing import List, Optional, Dict, Any
from contextvars import ContextVar
from contextlib import asynccontextmanager
from dateutil.parser import parse as dateutil_parse
import re
from gcal_service import gcal_service

from fastapi import FastAPI, Request, HTTPException, Depends
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse
from pydantic import BaseModel, Field
from sqlalchemy.engine import make_url
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
from sqlalchemy.orm import sessionmaker, declarative_base
from sqlalchemy import text

from langchain_openai import ChatOpenAI
# Busca la l√≠nea que falla y reempl√°zala por estas:
from langchain.agents import AgentExecutor
from langchain.agents import create_openai_tools_agent

from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain_core.messages import SystemMessage, HumanMessage, AIMessage
from langchain.tools import tool

import socketio
from db import db
from admin_routes import router as admin_router
from auth_routes import router as auth_router
from email_service import email_service

# --- CONFIGURACI√ìN ---
LOG_LEVEL = os.getenv("LOG_LEVEL", "INFO").upper()
logging.basicConfig(level=LOG_LEVEL)
logger = logging.getLogger("orchestrator")

OPENAI_API_KEY = os.getenv("OPENAI_API_KEY", "")
POSTGRES_DSN = os.getenv("POSTGRES_DSN", "")
CLINIC_NAME = os.getenv("CLINIC_NAME", "Consultorio Dental")
CLINIC_LOCATION = os.getenv("CLINIC_LOCATION", "Buenos Aires, Argentina")

# ContextVars para rastrear el usuario en la sesi√≥n de LangChain
current_customer_phone: ContextVar[Optional[str]] = ContextVar("current_customer_phone", default=None)
current_patient_id: ContextVar[Optional[int]] = ContextVar("current_patient_id", default=None)

# --- DATABASE SETUP ---
engine = create_async_engine(POSTGRES_DSN, echo=False)
AsyncSessionLocal = sessionmaker(engine, class_=AsyncSession, expire_on_commit=False)

# --- MODELOS DE DATOS (API) ---
class ChatRequest(BaseModel):
    # Support both internal naming and WhatsApp service naming
    message: Optional[str] = None
    text: Optional[str] = None
    phone: Optional[str] = None
    from_number: Optional[str] = None
    name: Optional[str] = "Paciente"
    customer_name: Optional[str] = None
    media: List[Dict[str, Any]] = Field(default_factory=list)

    @property
    def final_message(self) -> str:
        return self.message or self.text or ""

    @property
    def final_phone(self) -> str:
        return self.phone or self.from_number or ""
    
    @property
    def final_name(self) -> str:
        return self.customer_name or self.name or "Paciente"

# --- HELPERS PARA PARSING DE FECHAS ---

def get_next_weekday(target_weekday: int) -> date:
    """Obtiene el pr√≥ximo d√≠a de la semana (0=lunes, 6=domingo)."""
    today = datetime.now()
    days_ahead = target_weekday - today.weekday()
    if days_ahead <= 0:
        days_ahead += 7
    return (today + timedelta(days=days_ahead)).date()

def parse_date(date_query: str) -> date:
    """Convierte 'ma√±ana', 'lunes', '2025-02-05' a date."""
    query = date_query.lower().strip()
    
    # Palabras clave espa√±olas/inglesas
    day_map = {
        'ma√±ana': lambda: (datetime.now() + timedelta(days=1)).date(),
        'tomorrow': lambda: (datetime.now() + timedelta(days=1)).date(),
        'hoy': lambda: datetime.now().date(),
        'today': lambda: datetime.now().date(),
        'lunes': lambda: get_next_weekday(0),
        'monday': lambda: get_next_weekday(0),
        'martes': lambda: get_next_weekday(1),
        'tuesday': lambda: get_next_weekday(1),
        'mi√©rcoles': lambda: get_next_weekday(2),
        'wednesday': lambda: get_next_weekday(2),
        'jueves': lambda: get_next_weekday(3),
        'thursday': lambda: get_next_weekday(3),
        'viernes': lambda: get_next_weekday(4),
        'friday': lambda: get_next_weekday(4),
        's√°bado': lambda: get_next_weekday(5),
        'saturday': lambda: get_next_weekday(5),
        'domingo': lambda: get_next_weekday(6),
        'sunday': lambda: get_next_weekday(6),
    }
    
    if query in day_map:
        return day_map[query]()
    
    # Intentar parsear como fecha
    try:
        return dateutil_parse(query, dayfirst=True).date()
    except:
        return datetime.now().date()

def parse_datetime(datetime_query: str) -> datetime:
    """Convierte 'ma√±ana 14:00', '2025-02-05 14:30' a datetime."""
    try:
        dt = dateutil_parse(datetime_query, dayfirst=True)
        return dt
    except:
        # Fallback: ma√±ana a las 14:00
        tomorrow = datetime.now() + timedelta(days=1)
        return tomorrow.replace(hour=14, minute=0, second=0, microsecond=0)

def generate_free_slots(target_date: date, busy_times: List[tuple], 
                       start_hour=9, end_hour=18, interval_minutes=30) -> List[str]:
    """Genera lista de horarios disponibles (30min intervals)."""
    slots = []
    current = datetime.combine(target_date, datetime.min.time()).replace(hour=start_hour)
    end = datetime.combine(target_date, datetime.min.time()).replace(hour=end_hour)
    
    # Convertir busy_times a set de horas
    busy_hours = set()
    for busy_start, duration in busy_times:
        busy_hours.add(busy_start.hour + (busy_start.minute / 60))
    
    while current < end:
        # Saltar almuerzo 13:00-14:00
        if current.hour >= 13 and current.hour < 14:
            current += timedelta(minutes=interval_minutes)
            continue
        
        # Verificar que no est√° ocupado
        hour_decimal = current.hour + (current.minute / 60)
        if hour_decimal not in busy_hours:
            slots.append(current.strftime("%H:%M"))
        
        current += timedelta(minutes=interval_minutes)
    
    return slots[:5]  # Retornar primeros 5

# --- TOOLS DENTALES ---

@tool
async def check_availability(date_query: str):
    """
    Consulta la disponibilidad REAL de turnos en la BD para una fecha.
    date_query: Descripci√≥n de la fecha (ej: 'ma√±ana', 'lunes', '2025-05-10')
    Devuelve: Horarios disponibles con profesionales
    """
    try:
        target_date = parse_date(date_query)
        
        # Query BD: obtener turnos confirmados para esa fecha
        busy_appointments = await db.pool.fetch("""
            SELECT appointment_datetime, duration_minutes, professional_id
            FROM appointments
            WHERE DATE(appointment_datetime) = $1
            AND status IN ('scheduled', 'confirmed')
            ORDER BY appointment_datetime ASC
        """, target_date)
        
        # Extraer times ocupados
        busy_times = [(row['appointment_datetime'], row['duration_minutes']) 
                      for row in busy_appointments]
        
        # Generar slots libres
        available_slots = generate_free_slots(target_date, busy_times)
        
        if available_slots:
            slots_str = ", ".join(available_slots)
            return f"Tenemos disponibilidad para {date_query}: {slots_str} (30 min cada turno)."
        else:
            return f"No hay disponibilidad para {date_query}. ¬øTe interesa otro d√≠a?"
            
    except Exception as e:
        logger.error(f"Error en check_availability: {e}")
        return f"No pude consultar disponibilidad. Prueba diciendo 'Quiero agendar ma√±ana'."

@tool
async def book_appointment(date_time: str, treatment_reason: str):
    """
    Registra un turno en la BD. √ösalo cuando el paciente confirma fecha, hora y motivo.
    date_time: Fecha y hora del turno (ej: 'ma√±ana 14:00')
    treatment_reason: Tipo de tratamiento (checkup, cleaning, etc.)
    """
    phone = current_customer_phone.get()
    
    if not phone:
        return "‚ùå Error: No pude identificar tu tel√©fono. Reinicia la conversaci√≥n."
    
    try:
        # 1. Parsear datetime
        apt_datetime = parse_datetime(date_time)
        
        # 2. Buscar paciente por tel√©fono, o crear uno
        patient = await db.pool.fetchrow(
            "SELECT id FROM patients WHERE phone_number = $1",
            phone
        )
        
        if not patient:
            # Crear paciente nuevo
            patient = await db.pool.fetchrow("""
                INSERT INTO patients (phone_number, first_name, status, created_at)
                VALUES ($1, 'Chat User', 'active', NOW())
                RETURNING id
            """, phone)
            logger.info(f"Paciente nuevo creado: {phone}")
        
        # 3. Obtener profesional activo (ej: ID 1)
        professional = await db.pool.fetchrow(
            "SELECT id FROM professionals WHERE is_active = true LIMIT 1"
        )
        
        if not professional:
            return "‚ùå No hay profesionales disponibles en este momento. Contacta directamente."
        
        # 4. Verificar que no hay sobrelapamiento
        overlap = await db.pool.fetchval("""
            SELECT COUNT(*) FROM appointments
            WHERE professional_id = $1
            AND DATE(appointment_datetime) = $2
            AND status IN ('scheduled', 'confirmed')
        """, professional['id'], apt_datetime.date())
        
        if overlap > 0:
            return f"‚ùå No hay disponibilidad exacta en {date_time}. ¬øProb√°s con otro horario?"
        
        # 5. Insertar turno
        apt_id = str(uuid.uuid4())
        await db.pool.execute("""
            INSERT INTO appointments 
            (id, patient_id, professional_id, appointment_datetime, appointment_type, status, urgency_level, created_at)
            VALUES ($1, $2, $3, $4, $5, 'scheduled', 'normal', NOW())
        """, apt_id, patient['id'], professional['id'], apt_datetime, treatment_reason)
        
        logger.info(f"‚úÖ Turno registrado: {apt_id} para {phone}")
        current_patient_id.set(patient['id'])
        
        # 6. Obtener datos completos del turno para emitir evento y sincronizar GCal
        appointment_data = await db.pool.fetchrow("""
            SELECT a.id, a.patient_id, a.professional_id, a.appointment_datetime, 
                   a.appointment_type, a.status, a.urgency_level,
                   p.first_name, p.last_name, p.phone_number,
                   prof.first_name as professional_name
            FROM appointments a
            JOIN patients p ON a.patient_id = p.id
            JOIN professionals prof ON a.professional_id = prof.id
            WHERE a.id = $1
        """, apt_id)

        # 7. Sincronizar con Google Calendar
        try:
            summary = f"Cita Dental AI: {appointment_data['first_name']} {appointment_data['last_name'] or ''} - {treatment_reason}"
            start_time = apt_datetime.isoformat()
            end_time = (apt_datetime + timedelta(minutes=60)).isoformat()
            
            gcal_event = gcal_service.create_event(
                summary=summary,
                start_time=start_time,
                end_time=end_time,
                description=f"Paciente: {appointment_data['first_name']}\nTel: {appointment_data['phone_number']}\nMotivo: {treatment_reason}\nCreado por Asistente IA"
            )
            
            if gcal_event:
                await db.pool.execute(
                    "UPDATE appointments SET google_calendar_event_id = $1, google_calendar_sync_status = 'synced' WHERE id = $2",
                    gcal_event['id'], apt_id
                )
        except Exception as ge:
            logger.error(f"Error sincronizando con GCal (AI Tool): {ge}")

        if appointment_data:
            # Re-definir localmente para evitar problemas de request o importar
            from main import sio
            await sio.emit("NEW_APPOINTMENT", dict(appointment_data))
        
        from main import CLINIC_NAME
        return f"‚úÖ ¬°Turno confirmado para {apt_datetime.strftime('%d/%m/%Y a las %H:%M')}! Te esperamos en {CLINIC_NAME}. Confirmaci√≥n: #{apt_id[:8]}"
        
    except Exception as e:
        logger.error(f"Error en book_appointment: {e}")
        return f"‚ùå No pude registrar el turno: {str(e)}. Por favor, contacta directamente."

@tool
async def triage_urgency(symptoms: str):
    """
    Analiza s√≠ntomas para clasificar urgencia.
    Devuelve: Nivel de urgencia (emergency, high, normal, low) + recomendaci√≥n
    """
    urgency_keywords = {
        'emergency': ['dolor fuerte', 'sangrado', 'traumatismo', 'accidente', 'golpe', 'roto', 'fractura'],
        'high': ['dolor', 'hinchaz√≥n', 'inflamaci√≥n', 'infecci√≥n'],
        'normal': ['revisi√≥n', 'limpieza', 'control', 'checkup'],
    }
    
    symptoms_lower = symptoms.lower()
    
    # Clasificar urgencia
    urgency_level = 'low'
    for level, keywords in urgency_keywords.items():
        if any(kw in symptoms_lower for kw in keywords):
            urgency_level = level
            break
    
    responses = {
        'emergency': "üö® URGENCIA DETECTADA. Deber√≠as venir HOY mismo. Si es muy grave, llama directamente: Llam√° al consultorio.",
        'high': "‚ö†Ô∏è Deber√≠as agendar un turno lo antes posible, preferentemente esta semana.",
        'normal': "‚úÖ Puedes agendar un turno en la fecha que te venga bien.",
        'low': "‚ÑπÔ∏è Puedes agendar una revisi√≥n de rutina cuando lo necesites."
    }
    
    return responses.get(urgency_level, responses['normal'])

@tool
async def cancel_appointment(date_query: str):
    """
    Cancela un turno existente. 
    date_query: Fecha del turno a cancelar (ej: 'ma√±ana', '2025-05-10')
    """
    phone = current_customer_phone.get()
    if not phone:
        return "‚ö†Ô∏è No pude identificar tu tel√©fono. Por favor, contactame de nuevo."

    try:
        target_date = parse_date(date_query)
        
        # Buscar el turno en la BD
        apt = await db.pool.fetchrow("""
            SELECT id, google_calendar_event_id FROM appointments
            WHERE phone_number = $1 AND DATE(appointment_datetime) = $2
            AND status IN ('scheduled', 'confirmed')
        """, phone, target_date)
        
        if not apt:
            return f"No encontr√© ning√∫n turno activo para el d√≠a {date_query}. ¬øQuer√©s que revisemos otra fecha?"

        # 1. Cancelar en GCal
        if apt['google_calendar_event_id']:
            gcal_service.delete_event(apt['google_calendar_event_id'])
            
        # 2. Marcar como cancelado en BD
        await db.pool.execute("""
            UPDATE appointments SET status = 'cancelled', google_calendar_sync_status = 'cancelled'
            WHERE id = $1
        """, apt['id'])
        
        logger.info(f"üö´ Turno cancelado por IA: {apt['id']} ({phone})")
        return f"Entendido. He cancelado tu turno del {date_query}. ¬øTe puedo ayudar con algo m√°s?"
        
    except Exception as e:
        logger.error(f"Error en cancel_appointment: {e}")
        return "‚ö†Ô∏è Hubo un error al intentar cancelar el turno. Por favor, intenta nuevamente."

@tool
async def reschedule_appointment(original_date: str, new_date_time: str):
    """
    Reprograma un turno existente a una nueva fecha/hora.
    original_date: Fecha del turno actual (ej: 'hoy', 'lunes')
    new_date_time: Nueva fecha y hora deseada (ej: 'ma√±ana 15:00')
    """
    phone = current_customer_phone.get()
    if not phone:
        return "‚ö†Ô∏è No pude identificar tu tel√©fono."

    try:
        orig_date = parse_date(original_date)
        new_dt = parse_datetime(new_date_time)
        
        # 1. Buscar turno original
        apt = await db.pool.fetchrow("""
            SELECT id, google_calendar_event_id FROM appointments
            WHERE phone_number = $1 AND DATE(appointment_datetime) = $2
            AND status IN ('scheduled', 'confirmed')
        """, phone, orig_date)
        
        if not apt:
            return f"No encontr√© tu turno para el {original_date}. ¬øPodr√≠as confirmarme la fecha original?"

        # 2. Verificar disponibilidad para el nuevo horario
        # (Llamamos a la l√≥gica de overlap directamente)
        prof = await db.pool.fetchrow("SELECT id FROM professionals WHERE is_active = true LIMIT 1")
        overlap = await db.pool.fetchval("""
            SELECT COUNT(*) FROM appointments
            WHERE professional_id = $1 AND appointment_datetime = $2
            AND status IN ('scheduled', 'confirmed') AND id != $3
        """, prof['id'], new_dt, apt['id'])
        
        if overlap > 0:
            return f"Lo siento, el horario {new_date_time} ya est√° ocupado. ¬øProbamos con otro?"

        # 3. Actualizar GCal
        if apt['google_calendar_event_id']:
            # Podr√≠amos usar gcal_service.update_event si existiera, o delete/create
            # Para simplificar, borramos el viejo y creamos uno nuevo (o implementamos update en el service)
            gcal_service.delete_event(apt['google_calendar_event_id'])
            
        summary = f"Cita Dental AI (Reprogramada): {phone}"
        new_gcal = gcal_service.create_event(
            summary=summary,
            start_time=new_dt.isoformat(),
            end_time=(new_dt + timedelta(minutes=60)).isoformat()
        )
        
        # 4. Actualizar BD
        await db.pool.execute("""
            UPDATE appointments SET 
                appointment_datetime = $1, 
                google_calendar_event_id = $2,
                google_calendar_sync_status = 'synced',
                updated_at = NOW()
            WHERE id = $3
        """, new_dt, new_gcal['id'] if new_gcal else None, apt['id'])
        
        logger.info(f"üîÑ Turno reprogramado por IA: {apt['id']} para {new_dt}")
        return f"¬°Listo! Tu turno ha sido reprogramado para el {new_date_time}. Te esperamos."

    except Exception as e:
        logger.error(f"Error en reschedule_appointment: {e}")
        return "‚ö†Ô∏è No pude reprogramar el turno. Por favor, intenta de nuevo."

@tool
async def list_services(category: str = None):
    """
    Lista los servicios/tratamientos dentales disponibles.
    category: Filtro opcional (prevention, restorative, surgical, orthodontics, emergency)
    """
    try:
        query = "SELECT code, name, description, default_duration_minutes FROM treatment_types WHERE is_active = true"
        params = []
        if category:
            query += " AND category = $1"
            params.append(category)
        
        rows = await db.pool.fetch(query, *params)
        if not rows:
            return "No encontr√© servicios disponibles en esa categor√≠a."
        
        res = "ü¶∑ Nuestros servicios:\n"
        for r in rows:
            res += f"‚Ä¢ {r['name']} ({r['default_duration_minutes']} min): {r['description']}\n"
        return res
    except Exception as e:
        logger.error(f"Error en list_services: {e}")
        return "‚ö†Ô∏è Error al consultar servicios."

@tool
async def derivhumano(reason: str):
    """
    Deriva la conversaci√≥n a un humano cuando la IA no puede ayudar, el paciente lo solicita 
    o hay una situaci√≥n que requiere atenci√≥n personalizada.
    reason: El motivo de la derivaci√≥n.
    """
    phone = current_customer_phone.get()
    try:
        # 1. Definir bloqueo de 24hs
        override_until = datetime.now(timezone.utc) + timedelta(hours=24)
        
        # 2. Marcar conversaci√≥n para intervenci√≥n humana (Lockout)
        # Seteamos last_derivhumano_at para que aparezca el banner "El bot deriv√≥..."
        await db.pool.execute("""
            UPDATE patients SET 
                human_handoff_requested = true, 
                human_override_until = $1,
                last_derivhumano_at = NOW(),
                updated_at = NOW()
            WHERE phone_number = $2
        """, override_until, phone)
        
        logger.info(f"üë§ Derivaci√≥n humana solicitada para {phone}: {reason}")
        
        # 3. Notificar v√≠a Socket (para que aparezca en el dashboard en tiempo real)
        # Import local to avoid circular import
        # Import local to avoid circular import
        from main import sio
        await sio.emit("HUMAN_HANDOFF", {"phone_number": phone, "reason": reason})

        # 4. Enviar Email (Protocolo SMTP Global)
        # Recuperar datos del paciente
        patient = await db.pool.fetchrow("SELECT first_name, last_name, email FROM patients WHERE phone_number = $1", phone)
        patient_name = f"{patient['first_name']} {patient['last_name'] or ''}".strip()
        
        # Recuperar historial (√∫ltimos 5 mensajes para contexto)
        history = await db.pool.fetch("""
            SELECT role, content, created_at FROM chat_messages 
            WHERE from_number = $1 ORDER BY created_at DESC LIMIT 5
        """, phone)
        
        history_text = "<br>".join([f"<b>{msg['role']}:</b> {msg['content']}" for msg in reversed(history)])
        
        # Obtener email destino (del tenant o env var)
        destination_email = os.getenv("NOTIFICATIONS_EMAIL", "gamarradrian200@gmail.com")
        
        email_sent = email_service.send_handoff_email(
            to_email=destination_email, 
            patient_name=patient_name, 
            phone=phone, 
            reason=reason,
            chat_history_preview=history_text
        )
        
        if email_sent:
            return "He notificado a un asesor humano. Te contactar√° por WhatsApp en breve."
        else:
            return "Ya he solicitado que un humano revise tu caso. Aguardanos un momento."
            
    except Exception as e:
        logger.error(f"Error en derivhumano: {e}")
        return "Hubo un problema al derivarte, pero ya he dejado el aviso en el sistema."

DENTAL_TOOLS = [check_availability, book_appointment, triage_urgency, cancel_appointment, reschedule_appointment, list_services, derivhumano]

# --- SYSTEM PROMPT (DENTALOGIC V3 - GALA INSPIRED) ---
sys_template = f"""REGLA DE ORO DE IDENTIDAD: En tu primer mensaje de cada conversaci√≥n, DEB√âS presentarte con esta frase exacta: "Hola! Soy la asistente de la Dra. Laura Delgado, es un gusto saludarte. üòä".
Sos la asistente virtual de la Dra. Laura Delgado. No sos un bot corporativo ni de ninguna otra cl√≠nica.

POL√çTICA DE PUNTUACI√ìN (ESTRICTA):
‚Ä¢ NUNCA uses los signos de apertura ¬ø ni ¬°. 
‚Ä¢ SOLAMENTE us√° los signos de cierre ? y ! al final de las frases (ej: "C√≥mo est√°s?", "Qu√© alegr√≠a!"). 
‚Ä¢ El incumplimiento de esta regla rompe la ilusi√≥n de humanidad en WhatsApp.

Tu objetivo es ayudar a pacientes a: (a) informarse sobre tratamientos, (b) consultar disponibilidad, (c) agendar/reprogramar/cancelar turnos y (d) realizar triaje inicial de urgencias.

IDENTIDAD Y TONO ARGENTINO (FUNDAMENTAL):
‚Ä¢ PERSONALIDAD: Sos una persona real, c√°lida, que se preocupa por el paciente. 
‚Ä¢ TONO: Us√° voseo natural y cercano (voseo rioplatense). "Che", "viste", "contame", "fijate", "dale", "mir√°". 
‚Ä¢ CERCAN√çA: Si el paciente est√° de acuerdo, us√° su nombre ("Dale, Martin, te cuento..."). Gener√° confianza y curiosidad sobre su salud bucal.

POL√çTICAS DURAS:
‚Ä¢ NUNCA INVENTES: No inventes horarios ni disponibilidad. Siempre us√° 'check_availability'.
‚Ä¢ NO DIAGNOSTICAR: Ante dudas cl√≠nicas, dec√≠: "La Dra. Laura va a tener que evaluarte ac√° en el consultorio para darte un diagn√≥stico certero y ver bien qu√© necesit√°s".
‚Ä¢ ZONA HORARIA: America/Argentina/Buenos_Aires. 
‚Ä¢ HORARIOS DE ATENCI√ìN: Lunes a S√°bados de 09:00 a 13:00 y 14:00 a 18:00 (Domingos cerrado).
‚Ä¢ DERIVACI√ìN (Human Handoff): 
  - Us√° 'derivhumano' INMEDIATAMENTE si: 
    (a) Hay una URGENCIA cr√≠tica (sangrado, trauma, mucho dolor) detectada por 'triage_urgency'.
    (b) El paciente est√° frustrado o enojado.
    (c) Pide hablar con una persona.
  - CR√çTICO: Si decid√≠s derivar, **DEBES USAR LA TOOL**.

PRESENTACI√ìN DE SERVICIOS (ENFOQUE EN VALOR):
‚Ä¢ No solo listes nombres. Explic√° c√≥mo le cambia la vida al paciente. 
  - Ejemplo: "Hacemos limpiezas profundas que no solo te dejan los dientes blancos, sino que te aseguran que tus enc√≠as est√©n sanas para evitar problemas a futuro".
‚Ä¢ S√© simple y claro. Menos tecnicismos, m√°s beneficios reales.

FLUJO DE AGENDAMIENTO:
1. Disponibilidad: Siempre us√° 'check_availability'. Ofrec√© 3 opciones claras.
2. Informaci√≥n: Necesit√°s Nombre completo y Motivo. Pedilo con naturalidad.
3. Confirmaci√≥n: Us√° 'book_appointment' solo ante confirmaci√≥n expl√≠cita.

TRIAJE Y URGENCIAS:
‚Ä¢ Ante dolor o accidentes, 'triage_urgency' es siempre lo primero.
‚Ä¢ Si es 'emergency' o 'high', conten√© al paciente: "Tranquilo/a, ya me encargo de avisar a la Dra. para darte prioridad".

Usa solo las tools proporcionadas. Siempre termin√° con una pregunta o frase que invite a seguir la charla y demuestre inter√©s por el paciente.
"""

# --- AGENT SETUP ---
def get_agent_executable():
    llm = ChatOpenAI(model="gpt-4o-mini", temperature=0, openai_api_key=OPENAI_API_KEY)
    prompt = ChatPromptTemplate.from_messages([
        ("system", sys_template),
        MessagesPlaceholder(variable_name="chat_history"),
        ("human", "{input}"),
        MessagesPlaceholder(variable_name="agent_scratchpad"),
    ])
    agent = create_openai_tools_agent(llm, DENTAL_TOOLS, prompt)
    return AgentExecutor(agent=agent, tools=DENTAL_TOOLS, verbose=False)

agent_executor = get_agent_executable()

# --- API ENDPOINTS ---

@asynccontextmanager
async def lifespan(app: FastAPI):
    """Manage app lifecycle: startup and shutdown."""
    # Startup
    logger.info("üöÄ Iniciando orquestador dental...")
    await db.connect()
    logger.info("‚úÖ Base de datos conectada")
    
    yield
    
    # Shutdown
    logger.info("üî¥ Cerrando orquestador dental...")
    await db.disconnect()
    logger.info("‚úÖ Desconexi√≥n completada")

app = FastAPI(title=f"{CLINIC_NAME} Orchestrator", lifespan=lifespan)

# Configurar CORS
allowed_origins_str = os.getenv("CORS_ALLOWED_ORIGINS", "")
origins = [
    "http://localhost:3000",
    "http://localhost:5173",
    "https://dentalogic-frontend.ugwrjq.easypanel.host",
    "https://dentalogic-orchestrator.ugwrjq.easypanel.host",
]

if allowed_origins_str:
    extra_origins = [o.strip() for o in allowed_origins_str.split(",") if o.strip()]
    origins.extend(extra_origins)

# Eliminar duplicados manteniendo el orden l√≥gico
origins = list(dict.fromkeys(origins))

# --- MIDDLEWARE & EXCEPTION HANDLERS ---

@app.exception_handler(Exception)
async def global_exception_handler(request: Request, exc: Exception):
    logger.error(f"üî• UNHANDLED ERROR: {str(exc)}", exc_info=True)
    return JSONResponse(
        status_code=500,
        content={
            "detail": "Error interno del servidor. El equipo t√©cnico ha sido notificado.",
            "error_type": type(exc).__name__
        }
    )

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# --- RUTAS ---
app.include_router(auth_router)
app.include_router(admin_router)

# --- SOCKET.IO CONFIGURATION ---
# Create Socket.IO instance with async mode
sio = socketio.AsyncServer(async_mode='asgi', cors_allowed_origins=origins)
socket_app = socketio.ASGIApp(sio, app)

# Socket.IO event handlers
@sio.event
async def connect(sid, environ):
    logger.info(f"üîå Client connected: {sid}")

@sio.event
async def disconnect(sid):
    logger.info(f"üîå Client disconnected: {sid}")

# Helper function to emit appointment events (can be imported by admin_routes)
async def emit_appointment_event(event_type: str, data: Dict[str, Any]):
    """Emit appointment-related events to all connected clients."""
    await sio.emit(event_type, data)
    logger.info(f"üì° Socket event emitted: {event_type} - {data}")

# Make the emit function available to other modules
app.state.emit_appointment_event = emit_appointment_event

@app.post("/chat")
async def chat_endpoint(req: ChatRequest):
    """Endpoint de chat que persiste historial en BD."""
    current_customer_phone.set(req.final_phone)
    correlation_id = str(uuid.uuid4())
    
    # 0. A) Ensure patient reference exists (Fix for visibility + Name)
    try:
        await db.ensure_patient_exists(req.final_phone, req.final_name)
        
        # 1. Guardar mensaje del usuario PRIMERO (para no perderlo si hay error)
        await db.append_chat_message(
            from_number=req.final_phone,
            role='user',
            content=req.final_message,
            correlation_id=correlation_id
        )
        
        # --- Notificar al Frontend (Real-time) ---
        await sio.emit('NEW_MESSAGE', {
            'phone_number': req.final_phone,
            'message': req.final_message,
            'role': 'user'
        })
        # -----------------------------------------

        # 0. B) Verificar si hay intervenci√≥n humana activa
        handoff_check = await db.pool.fetchrow("""
            SELECT human_handoff_requested, human_override_until 
            FROM patients 
            WHERE phone_number = $1
        """, req.final_phone)
        
        if handoff_check:
            is_handoff_active = handoff_check['human_handoff_requested']
            override_until = handoff_check['human_override_until']
            
            # Si hay override activo y no ha expirado, la IA permanece silenciosa
            if is_handoff_active and override_until:
                # Fix: Robust comparison (Normalize to UTC)
                now_utc = datetime.now(timezone.utc)
                
                # Ensure override_until is aware
                if override_until.tzinfo is None:
                    # Assume stored as naive UTC (or local, but safe fallback to UTC)
                    override_until = override_until.replace(tzinfo=timezone.utc)
                else:
                    override_until = override_until.astimezone(timezone.utc)
                
                if override_until > now_utc:
                    logger.info(f"üîá IA silenciada para {req.final_phone} hasta {override_until}")
                    # Ya guardamos el mensaje arriba, solo retornamos silencio
                    return {
                        "output": "",  # Sin respuesta
                        "correlation_id": correlation_id,
                        "status": "silenced",
                        "reason": "human_intervention_active"
                    }
                else:
                    # Override expirado, limpiar flags
                    await db.pool.execute("""
                        UPDATE patients 
                        SET human_handoff_requested = FALSE, 
                            human_override_until = NULL 
                        WHERE phone_number = $1
                    """, req.final_phone)
        
        # 2. Cargar historial de BD (√∫ltimos 20 mensajes)
        chat_history = await db.get_chat_history(req.final_phone, limit=20)
        
        # Convertir a formato LangChain
        messages = []
        # El √∫ltimo mensaje ya fue guardado en el paso 1, pero get_chat_history lo traer√° si fue commit inmediato.
        # LangChain necesita historial + input actual. 
        # Si get_chat_history trae el √∫ltimo, lo duplicar√≠amos al pasarlo como input separado?
        # get_chat_history trae "√∫ltimos N", ordenados cronol√≥gicamente.
        # Si acabamos de insertar, deber√≠a estar ah√≠.
        
        # Soluci√≥n de limpieza: Filtramos el mensaje actual del historial si aparece duplicado o
        # simplemente confiamos en que LangChain maneja el contexto.
        # Pero standard: input es "current query", chat_history es "past context".
        
        # Vamos a remover el √∫ltimo mensaje del historial si es id√©ntico al actual, 
        # para no pasarlo como contexto Y como input.
        if chat_history and chat_history[-1]['content'] == req.final_message and chat_history[-1]['role'] == 'user':
            chat_history.pop() 

        for msg in chat_history:
            if msg['role'] == 'user':
                messages.append(HumanMessage(content=msg['content']))
            else:
                messages.append(AIMessage(content=msg['content']))
        
        # 3. Invocar agente
        response = await agent_executor.ainvoke({
            "input": req.final_message,
            "chat_history": messages
        })
        
        assistant_response = response.get("output", "Error procesando respuesta")
        
        # 4. Guardar respuesta del asistente
        await db.append_chat_message(
            from_number=req.final_phone,
            role='assistant',
            content=assistant_response,
            correlation_id=correlation_id
        )
        
        # --- Notificar al Frontend (Real-time AI) ---
        await sio.emit('NEW_MESSAGE', {
            'phone_number': req.final_phone,
            'message': assistant_response,
            'role': 'assistant'
        })
        # --------------------------------------------
        
        logger.info(f"‚úÖ Chat procesado para {req.final_phone} (correlation_id={correlation_id})")
        
        return {
            "status": "ok",
            "send": True,
            "text": assistant_response,
            "correlation_id": correlation_id
        }
        
    except Exception as e:
        logger.error(f"‚ùå Error en chat para {req.final_phone}: {str(e)}")
        await db.append_chat_message(
            from_number=req.final_phone,
            role='system',
            content=f"Error interno: {str(e)}",
            correlation_id=correlation_id
        )
        return JSONResponse(
            status_code=500,
            content={"error": "Error interno del orquestador", "correlation_id": correlation_id}
        )

@app.get("/health")
async def health():
    return {"status": "ok", "service": "dental-orchestrator"}

if __name__ == "__main__":
    import uvicorn
    # Use socket_app instead of app to support Socket.IO
    uvicorn.run(socket_app, host="0.0.0.0", port=8000)
````

## File: orchestrator_service/requirements.txt
````
fastapi
uvicorn
pydantic
httpx
tenacity
structlog
asyncpg
redis
langchain==0.1.0
langchain-openai==0.0.5
langchain-community==0.0.13
python-dotenv
prometheus-client
requests
python-dateutil
python-socketio
aiofiles
google-api-python-client
google-auth
google-auth-httplib2
google-auth-oauthlib
passlib[bcrypt]
bcrypt==3.2.0
python-jose[cryptography]
python-multipart
pyjwt
email-validator
````

## File: orchestrator_service/utils.py
````python
import os
import base64
from itertools import cycle

# Simple Encryption Helper (Standard Lib only)
ENCRYPTION_KEY = os.getenv("ENCRYPTION_KEY", "agente-js-secret-key-2024")

def encrypt_password(password: str) -> str:
    """Simple XOR + Base64 encryption."""
    if not password: return ""
    xored = ''.join(chr(ord(c) ^ ord(k)) for c, k in zip(password, cycle(ENCRYPTION_KEY)))
    return base64.b64encode(xored.encode()).decode()

def decrypt_password(encrypted: str) -> str:
    """Simple XOR + Base64 decryption."""
    if not encrypted: return ""
    try:
        decoded = base64.b64decode(encrypted).decode()
        return ''.join(chr(ord(c) ^ ord(k)) for c, k in zip(decoded, cycle(ENCRYPTION_KEY)))
    except:
        return ""
````

## File: platform_ui/app.js
````javascript
// Auto-detect API_BASE from current location (subdomain inference for self-hosted deployments)
function detectApiBase() {
    const currentLocation = window.location;

    // If explicitly set via window.API_BASE, use it
    if (window.API_BASE) return window.API_BASE;

    // For localhost/development
    if (currentLocation.hostname === 'localhost' || currentLocation.hostname === '127.0.0.1') {
        return `${currentLocation.protocol}//${currentLocation.hostname}:8000`;
    }

    // For production: infer api URL
    // Examples: 
    // - domain.com -> api.domain.com
    // - platform-ui.domain.com -> orchestrator-service.domain.com
    // - docker-platform-ui.host.com -> docker-orchestrator-service.host.com

    let hostname = currentLocation.hostname;
    let apiHostname = hostname;

    if (hostname.includes('platform-ui')) {
        apiHostname = hostname.replace('platform-ui', 'orchestrator-service');
    } else if (hostname.startsWith('ui.')) {
        apiHostname = hostname.replace('ui.', 'api.');
    } else {
        // Fallback for custom domains: assume 'api.' prefix if not found
        apiHostname = `api.${hostname}`;
    }

    return `${currentLocation.protocol}//${apiHostname}`;
}

const API_BASE = detectApiBase();
const ADMIN_TOKEN = window.ADMIN_TOKEN || ""; // ‚Üê Aseg√∫rate de que coincida con tu env

console.log('API_BASE detected:', API_BASE);
console.log('Current location:', window.location.href);

let currentView = 'overview';
let activeChatId = null;
let allChats = []; // Global store for chat metadata
let renderedMessageIds = new Set();
let pollingInterval = null;

// Navigation
function showView(viewId, event = null) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

    // Reset mobile chat layout if switching views
    const layout = document.querySelector('.chats-layout');
    if (layout) layout.classList.remove('mobile-chat-active');


    document.getElementById(`view-${viewId}`).classList.add('active');

    // Add active class to clicked element if event provided
    if (event && event.currentTarget) {
        event.currentTarget.classList.add('active');
    } else {
        // For programmatic calls, find and activate the corresponding nav item
        const navItem = document.querySelector(`[onclick*="showView('${viewId}')"]`);
        if (navItem) {
            navItem.classList.add('active');
        }
    }

    currentView = viewId;

    if (viewId === 'stores') loadTenants();
    if (viewId === 'logs') loadLogs();
    if (viewId === 'credentials') {
        loadCredentials();
        loadCredentialFilters();
    }
    if (viewId === 'tools') {
        loadTools();
        initHandoffConfig();
    }
    if (viewId === 'analytics') loadAnalytics();
    if (viewId === 'console') loadConsoleEvents();
    if (viewId === 'chats') loadChats();
}

// Modal handling
function openModal(id) {
    document.getElementById(id).style.display = 'flex';

    if (id === 'ycloud-config-modal') {
        loadTenantSelector('ycloud-tenant-select').then(() => {
            loadYCloudConfig();
        });
    }
    if (id === 'whatsapp-meta-modal') {
        loadTenantSelector('whatsapp-meta-tenant-select').then(() => {
            loadMetaConfig();
        });
    }
}

function closeModal(id) {
    document.getElementById(id).style.display = 'none';
}

function handleModalClick(event, modalId) {
    if (event.target.id === modalId) {
        closeModal(modalId);
        if (modalId === 'cred-modal') {
            resetCredentialModal();
        }
    }
}

function showNotification(success, title, message) {
    const icon = success ? '‚úÖ' : '‚ùå';
    document.getElementById('notification-icon').textContent = icon;
    document.getElementById('notification-title').textContent = title;
    document.getElementById('notification-message').textContent = message;
    openModal('notification-modal');
}

// Data Fetching
async function adminFetch(endpoint, method = 'GET', body = null, tenantId = null) {
    const headers = {
        'x-admin-token': ADMIN_TOKEN,
        'Content-Type': 'application/json'
    };

    // Add tenant header if provided
    if (tenantId) {
        headers['x-tenant-id'] = tenantId;
    }

    // Add HMAC signature for sensitive endpoints
    if (endpoint.includes('/whatsapp-meta') && method !== 'GET') {
        const timestamp = Math.floor(Date.now() / 1000);
        const bodyStr = body ? JSON.stringify(body) : '';
        const payload = `${timestamp}.${bodyStr}`;
        // Note: In production, this would need crypto libraries for proper HMAC
        // For now, we'll rely on HTTPS and internal network security
        headers['x-signature'] = `t=${timestamp},s=dummy_signature`;
    }

    const options = {
        method,
        headers,
        credentials: 'include', // Ensure cookies/headers are sent for CORS
    };
    if (body) options.body = JSON.stringify(body);

    console.log(`üîó API Call: ${method} ${API_BASE}${endpoint}`); // Debug log
    if (body) console.log('üì§ Request Body:', body); // Debug log

    try {
        const response = await fetch(`${API_BASE}${endpoint}`, options);
        console.log(`Response status: ${response.status}`); // Debug log

        if (!response.ok) {
            // Try to get error message from response
            let errorText = response.statusText;
            let errorData = '';
            try {
                errorData = await response.text();
                console.log('Error response body:', errorData);
                // Try to parse as JSON
                const errorJson = JSON.parse(errorData);
                errorText = errorJson.detail || errorJson.message || errorJson.error || errorText;
            } catch (parseError) {
                // If not JSON, use text
                if (errorData) errorText = errorData;
            }
            const error = new Error(`HTTP ${response.status}: ${errorText}`);
            error.response = response;
            error.responseText = errorData;
            throw error;
        }

        // Check content type
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            const data = await response.json();
            console.log('Response data:', data); // Debug log
            return data;
        } else {
            // Handle non-JSON responses
            const text = await response.text();
            console.log('Response text:', text);
            return { status: 'ok', message: text }; // Fallback
        }
    } catch (e) {
        console.error("Fetch Error:", e);
        throw e; // Re-throw to catch in handlers
    }
}

// Health Strip Update from Diagnostics
function updateHealthStripFromDiagnostics(healthData) {
    const services = {
        'orchestrator': 'orchestrator-status',
        'whatsapp_service': 'whatsapp-status',
        'tiendanube_service': 'tiendanube-status',
        'database': 'database-status',
        'redis': 'redis-status'
    };

    if (healthData.checks) {
        healthData.checks.forEach(check => {
            const elementId = services[check.name];
            if (elementId) {
                const element = document.getElementById(elementId);
                element.classList.remove('ok', 'error', 'warning');

                if (check.status === 'OK') {
                    element.classList.add('ok');
                } else if (check.status === 'FAIL') {
                    element.classList.add('error');
                } else {
                    element.classList.add('warning');
                }
            }
        });
    }
}

// Dashboard Stats
async function updateStats() {
    let stats = null;
    let health = null;
    let bootstrap = null;

    try {
        stats = await adminFetch('/admin/stats');
    } catch (error) {
        console.warn('Failed to fetch stats:', error);
        showNotification(false, 'Error de Estad√≠sticas', 'No se pudieron cargar las estad√≠sticas del sistema');
    }

    try {
        health = await adminFetch('/admin/diagnostics/healthz');
    } catch (error) {
        console.warn('Failed to fetch health:', error);
        showNotification(false, 'Error de Salud', 'No se pudieron cargar los indicadores de salud');
    }

    try {
        bootstrap = await adminFetch('/admin/bootstrap');
    } catch (error) {
        console.warn('Bootstrap failed, continuing with health and stats:', error);
        showNotification(false, 'Error de Bootstrap', 'No se pudieron cargar datos de bootstrap, continuando con indicadores b√°sicos');
        // Continue without bootstrap data
    }

    if (stats) {
        document.getElementById('stat-active-tenants').innerText = stats.active_tenants || 0;
        document.getElementById('stat-total-messages').innerText = stats.total_messages || 0;

        const rate = stats.total_messages > 0
            ? Math.round((stats.processed_messages / stats.total_messages) * 100)
            : 0;
        document.getElementById('stat-success-rate').innerText = `${rate}%`;
    }

    if (health) {
        // Update health strip with detailed service checks
        updateHealthStripFromDiagnostics(health);
    }

    if (bootstrap) {
        // Update last signals
        const lastInbound = bootstrap.last_inbound_at ?
            new Date(bootstrap.last_inbound_at).toLocaleString() : 'Nunca';
        const lastOutbound = bootstrap.last_outbound_at ?
            new Date(bootstrap.last_outbound_at).toLocaleString() : 'Nunca';

        document.getElementById('last-inbound').textContent = lastInbound;
        document.getElementById('last-outbound').textContent = lastOutbound;

        // Update version
        if (bootstrap.version) {
            document.getElementById('version-badge').textContent = `v${bootstrap.version}`;
        }

        // Update activity widgets
        const tenantsStatus = bootstrap.tenants_count > 0 ?
            `${bootstrap.tenants_count} tenants configurados` :
            'No hay tenants configurados';
        document.getElementById('tenants-status').textContent = tenantsStatus;
        document.getElementById('tenants-status').className = bootstrap.tenants_count > 0 ? 'alert-item success' : 'alert-item warning';
    } else {
        // Bootstrap failed, set defaults
        document.getElementById('last-inbound').textContent = 'Desconocido';
        document.getElementById('last-outbound').textContent = 'Desconocido';
        document.getElementById('version-badge').textContent = 'v?';
        document.getElementById('tenants-status').textContent = 'Estado desconocido';
        document.getElementById('tenants-status').className = 'alert-item warning';
    }
}

// Tenants Management
async function loadTenants() {
    const tenants = await adminFetch('/admin/tenants');
    const container = document.getElementById('tenants-list');
    container.innerHTML = '';

    if (tenants) {
        tenants.forEach(t => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <div style="font-weight: 600">${t.store_name}</div>
                    <div style="font-size: 11px; color: #a1a1aa">${t.owner_email || 'No email'}</div>
                </td>
                <td>${t.bot_phone_number}</td>
                <td>${t.tiendanube_store_id || 'N/A'}</td>
                <td><span class="status-badge ${t.tiendanube_store_id ? 'ok' : 'error'}" style="background: ${t.tiendanube_store_id ? 'rgba(0,230,118,0.1)' : 'rgba(244,67,54,0.1)'}; color: ${t.tiendanube_store_id ? '#00e676' : '#f44336'}">${t.tiendanube_store_id ? 'Activo' : 'Sin Configurar'}</span></td>
                <td>
                    <button class="btn-secondary" style="padding: 5px 12px; font-size: 12px" onclick="editTenant('${t.bot_phone_number}')">Editar</button>
                    <button class="btn-secondary" style="padding: 5px 12px; font-size: 12px" onclick="testTenantConnection('${t.bot_phone_number}', '${t.tiendanube_store_id}', '${t.tiendanube_access_token}')">Test</button>
                    <button class="btn-delete" style="padding: 5px 12px; font-size: 12px" onclick="deleteTenant('${t.bot_phone_number}')">Eliminar</button>
                </td>
            `;
            container.appendChild(tr);
        });
    }
}

// Live Logs
async function loadLogs() {
    const logs = await adminFetch('/admin/logs');
    const container = document.getElementById('logs-list');

    if (logs) {
        container.innerHTML = '';
        logs.forEach(log => {
            const entry = document.createElement('div');
            entry.className = 'log-entry';

            const time = new Date(log.received_at).toLocaleTimeString();
            let payloadText = "";
            try {
                const p = JSON.parse(log.payload);
                payloadText = p.text || "Mensaje sin texto";
            } catch (e) { payloadText = log.payload; }

            entry.innerHTML = `
                <div class="log-meta">
                    [${time}] User: ${log.from_number} ‚Üí Bot: ${log.to_number} | Status: ${log.status}
                </div>
                <div class="log-text"><strong>Usuario:</strong> ${payloadText}</div>
                ${log.ai_response ? `<div class="log-response"><strong>IA:</strong> ${log.ai_response}</div>` : ''}
            `;
            container.appendChild(entry);
        });
    }
}

// Credentials Management
async function loadCredentials() {
    console.log('Loading credentials...');
    try {
        const creds = await adminFetch('/admin/credentials');
        const container = document.getElementById('creds-list');

        if (!container) return;

        // Get filter values
        const tenantFilter = document.getElementById('cred-filter-tenant').value;
        const typeFilter = document.getElementById('cred-filter-type').value;

        container.innerHTML = '';

        if (creds && Array.isArray(creds) && creds.length > 0) {
            // Apply Filters
            const filteredCreds = creds.filter(c => {
                if (tenantFilter && String(c.tenant_id) !== tenantFilter) return false;
                if (typeFilter && c.category !== typeFilter) return false;
                return true;
            });

            if (filteredCreds.length === 0) {
                container.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: var(--text-secondary);">No hay credenciales que coincidan con los filtros</td></tr>';
                return;
            }

            console.log(`Rendering ${filteredCreds.length} credentials`);
            filteredCreds.forEach(c => {
                const scopeDisplay = c.scope === 'global' ?
                    '<span class="badge global" style="background: rgba(147, 51, 234, 0.2); color: #c084fc; padding: 2px 8px; border-radius: 4px; font-size: 11px;">Global</span>' :
                    '<span class="badge tenant" style="background: rgba(16, 185, 129, 0.2); color: #34d399; padding: 2px 8px; border-radius: 4px; font-size: 11px;">Tenant</span>';

                const tenantDisplay = c.scope === 'global' ?
                    '<span style="opacity: 0.5">-</span>' :
                    (c.tenant_name || `ID: ${c.tenant_id}`);

                const categoryDisplay = c.category ?
                    `<span class="badge type" style="background: rgba(59, 130, 246, 0.2); color: #60a5fa; padding: 2px 8px; border-radius: 4px; font-size: 11px;">${c.category}</span>` : '-';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${c.name}</strong></td>
                    <td style="font-family: monospace; letter-spacing: 2px;">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</td>
                    <td>${categoryDisplay}</td>
                    <td>${tenantDisplay}</td>
                    <td>${scopeDisplay}</td>
                    <td>
                         <button class="btn-secondary" style="padding: 5px 12px; font-size: 12px; margin-right: 5px;" onclick="viewCredentialInfo(${c.id})">Info</button>
                        <button class="btn-secondary" style="padding: 5px 12px; font-size: 12px; margin-right: 5px;" onclick="editCredential(${c.id})">Editar</button>
                        <button class="btn-delete" style="padding: 5px 12px; font-size: 12px" onclick="deleteCredential(${c.id})">Borrar</button>
                    </td>
                `;
                container.appendChild(tr);
            });
        } else {
            container.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: var(--text-secondary);">No hay credenciales configuradas</td></tr>';
        }
    } catch (error) {
        console.error('Error loading credentials:', error);
        const container = document.getElementById('creds-list');
        if (container) {
            container.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 20px; color: var(--error);">Error cargando credenciales: ${error.message}</td></tr>`;
        }
    }
}

async function loadCredentialFilters() {
    try {
        const tenants = await adminFetch('/admin/tenants');
        const select = document.getElementById('cred-filter-tenant');

        if (!select) return;

        // Keep first option "Todos los Tenants" and remove others
        while (select.options.length > 1) {
            select.remove(1);
        }

        if (tenants) {
            tenants.forEach(t => {
                const option = document.createElement('option');
                option.value = t.id;
                option.textContent = t.store_name;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error("Error loading tenant filter:", error);
    }
}

function viewCredentialInfo(id) {
    adminFetch(`/admin/credentials/${id}`).then(c => {
        alert(`Detalles de Credencial:\n\nNombre: ${c.name}\nScope: ${c.scope}\nTenant: ${c.tenant_name || '-'}\nTipo: ${c.category || '-'}\nDescripci√≥n: ${c.description || 'Sin descripci√≥n'}`);
    });
}

// Tools Management
async function loadTools() {
    const tools = await adminFetch('/admin/tools');
    const container = document.getElementById('tools-list');
    container.innerHTML = '';

    if (tools) {
        tools.forEach(t => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${t.name}</td>
                <td>${t.type}</td>
                <td>${t.service_url || 'N/A'}</td>
                <td>
                    <button class="btn-secondary" style="padding: 5px 12px; font-size: 12px" onclick="configureTool('${t.name}')">Configurar</button>
                    <button class="btn-delete" style="padding: 5px 12px; font-size: 12px" onclick="deleteTool('${t.name}')">Eliminar</button>
                </td>
            `;
            container.appendChild(tr);
        });
    }
}

function configureTool(name) {
    if (name === 'derivhumano') {
        const section = document.querySelector('.handoff-config-section');
        if (section) {
            section.scrollIntoView({ behavior: 'smooth' });
            // Highlight the section briefly
            section.style.backgroundColor = 'rgba(255, 255, 0, 0.1)';
            setTimeout(() => section.style.backgroundColor = '', 2000);
            return;
        }
    }
    // Current tools are hardcoded in backend, so we just show an info for now
    openModal('tool-modal');
    // Pre-fill name if editing
    const form = document.getElementById('tool-form');
    form.elements['name'].value = name;
}

async function deleteTool(name) {
    if (confirm(`¬øEst√°s seguro de eliminar la herramienta ${name}?`)) {
        showNotification(true, 'Procesando', 'Las herramientas predefinidas no se pueden eliminar en esta versi√≥n.');
    }
}

// --- Human Handoff Configuration ---

function toggleHandoffUI() {
    const isEnabled = document.getElementById('handoff-enabled').checked;
    const container = document.getElementById('handoff-form-container');
    if (isEnabled) {
        container.style.opacity = '1';
        container.style.pointerEvents = 'all';
    } else {
        container.style.opacity = '0.5';
        container.style.pointerEvents = 'none';
    }
}

async function updateHandoffTenantSelect() {
    const select = document.getElementById('handoff-tenant-select');
    const tenants = await adminFetch('/admin/tenants');
    if (!tenants) return;

    const currentValue = select.value;
    select.innerHTML = '<option value="">Seleccionar Tenant...</option>';
    tenants.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = `${t.store_name} (${t.bot_phone_number})`;
        select.appendChild(opt);
    });
    if (currentValue) select.value = currentValue;
}

// Triggered when switching to 'tools' view
async function initHandoffConfig() {
    await updateHandoffTenantSelect();
    const select = document.getElementById('handoff-tenant-select');

    // Auto-select first tenant if available
    if (select.options.length > 1 && !select.value) {
        select.selectedIndex = 1;
        loadHandoffSettings();
    }
}

// Add event listener for tenant change
document.getElementById('handoff-tenant-select')?.addEventListener('change', loadHandoffSettings);

async function loadHandoffSettings() {
    const tenantId = document.getElementById('handoff-tenant-select').value;
    if (!tenantId) return;

    try {
        const config = await adminFetch(`/admin/handoff/${tenantId}`);

        if (config) {
            document.getElementById('handoff-enabled').checked = config.enabled;
            document.getElementById('handoff-target-email').value = config.destination_email || '';
            document.getElementById('handoff-instructions').value = config.handoff_instructions || '';
            document.getElementById('handoff-message').value = config.handoff_message || '';

            // Triggers
            const triggers = config.triggers || {};
            document.getElementById('rule-fitting').checked = triggers.rule_fitting || false;
            document.getElementById('rule-reclamo').checked = triggers.rule_reclamo || false;
            document.getElementById('rule-dolor').checked = triggers.rule_dolor || false;
            document.getElementById('rule-talle').checked = triggers.rule_talle || false;
            document.getElementById('rule-especial').checked = triggers.rule_especial || false;

            // Context
            const ctx = config.email_context || {};
            document.getElementById('ctx-name').checked = ctx.ctx_name !== false;
            document.getElementById('ctx-phone').checked = ctx.ctx_phone !== false;
            document.getElementById('ctx-history').checked = ctx.ctx_history || false;
            document.getElementById('ctx-id').checked = ctx.ctx_id || false;

            // SMTP
            document.getElementById('smtp-host').value = config.smtp_host || '';
            document.getElementById('smtp-port').value = config.smtp_port || '';
            document.getElementById('smtp-security').value = config.smtp_security || 'SSL';
            document.getElementById('smtp-user').value = config.smtp_username || '';
            document.getElementById('smtp-pass').value = config.smtp_password || '********';

            toggleHandoffUI();
        } else {
            // Reset for new tenant
            document.getElementById('handoff-enabled').checked = true;
            document.getElementById('handoff-target-email').value = '';
            document.getElementById('handoff-instructions').value = '';
            document.getElementById('handoff-message').value = '';
            document.getElementById('smtp-host').value = '';
            document.getElementById('smtp-port').value = '465';
            document.getElementById('smtp-security').value = 'SSL';
            document.getElementById('smtp-user').value = '';
            document.getElementById('smtp-pass').value = '';
            toggleHandoffUI();
        }
    } catch (e) {
        console.error("Error loading handoff config:", e);
    }
}

async function saveHandoffSettings() {
    const tenantId = document.getElementById('handoff-tenant-select').value;
    if (!tenantId) {
        showNotification(false, 'Validaci√≥n', 'Por favor selecciona un tenant primero.');
        return;
    }

    const payload = {
        tenant_id: tenantId,
        enabled: document.getElementById('handoff-enabled').checked,
        destination_email: document.getElementById('handoff-target-email').value,
        handoff_instructions: document.getElementById('handoff-instructions').value,
        handoff_message: document.getElementById('handoff-message').value,
        smtp_host: document.getElementById('smtp-host').value,
        smtp_port: parseInt(document.getElementById('smtp-port').value),
        smtp_security: document.getElementById('smtp-security').value,
        smtp_username: document.getElementById('smtp-user').value,
        smtp_password: document.getElementById('smtp-pass').value,
        triggers: {
            rule_fitting: document.getElementById('rule-fitting').checked,
            rule_reclamo: document.getElementById('rule-reclamo').checked,
            rule_dolor: document.getElementById('rule-dolor').checked,
            rule_talle: document.getElementById('rule-talle').checked,
            rule_especial: document.getElementById('rule-especial').checked
        },
        email_context: {
            ctx_name: document.getElementById('ctx-name').checked,
            ctx_phone: document.getElementById('ctx-phone').checked,
            ctx_history: document.getElementById('ctx-history').checked,
            ctx_id: document.getElementById('ctx-id').checked
        }
    };

    try {
        const res = await adminFetch('/admin/handoff', 'POST', payload);

        if (res) {
            showNotification(true, '√âxito', 'Configuraci√≥n de derivaci√≥n guardada correctamente.');
            // Reload to mask password
            await loadHandoffSettings();
        }
    } catch (e) {
        showNotification(false, 'Error', 'No se pudo guardar la configuraci√≥n.');
    }
}

async function saveCredential(name, value, category, scope, tenantId) {
    return await adminFetch('/admin/credentials', 'POST', {
        name, value, category, scope, tenant_id: tenantId
    });
}

// Analytics Management
async function loadAnalytics() {
    const tenantFilter = document.getElementById('analytics-tenant-filter').value;
    const timeFilter = document.getElementById('analytics-time-filter').value;

    // Calculate date range
    const endDate = new Date().toISOString().split('T')[0];
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - parseInt(timeFilter || '7'));
    const startDateStr = startDate.toISOString().split('T')[0];

    try {
        // Load analytics summary
        const summary = await adminFetch(`/admin/analytics/summary?tenant_id=${tenantFilter || 1}&from_date=${startDateStr}&to_date=${endDate}`);
        displayAnalyticsSummary(summary);

        // Load recent events
        const events = await adminFetch(`/admin/telemetry/events?tenant_id=${tenantFilter || 1}&from_date=${startDateStr}&to_date=${endDate}&page_size=20`);
        displayAnalyticsEvents(events);

    } catch (error) {
        console.error('Error loading analytics:', error);
        showNotification(false, 'Error', 'No se pudieron cargar las m√©tricas');
    }
}

function displayAnalyticsSummary(summary) {
    if (!summary || !summary.kpis) {
        // Show empty state
        document.getElementById('kpi-conversations').textContent = '0';
        document.getElementById('kpi-messages').textContent = '0';
        document.getElementById('kpi-success-rate').textContent = '0%';
        document.getElementById('kpi-avg-response').textContent = '0ms';
        return;
    }

    const kpis = summary.kpis;

    // Update KPIs
    document.getElementById('kpi-conversations').textContent = kpis.conversations?.value || 0;
    document.getElementById('kpi-messages').textContent = kpis.orders_lookup?.requested || 0;
    document.getElementById('kpi-success-rate').textContent = `${Math.round((kpis.orders_lookup?.success_rate || 0) * 100)}%`;

    // Calculate average response time (placeholder - would need actual timing data)
    document.getElementById('kpi-avg-response').textContent = '150ms'; // Placeholder
}

function displayAnalyticsEvents(events) {
    const container = document.getElementById('analytics-events');

    if (!events || !events.items || events.items.length === 0) {
        container.innerHTML = `
            <tr>
                <td colspan="4" class="empty-row">
                    <div class="table-empty">
                        <div class="empty-icon">üìã</div>
                        <p>No hay eventos recientes</p>
                        <small>Los eventos del sistema aparecer√°n aqu√≠</small>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    container.innerHTML = '';
    events.items.slice(0, 10).forEach(event => {
        const tr = document.createElement('tr');
        const timestamp = new Date(event.occurred_at).toLocaleString();
        const severityClass = `severity-${event.severity || 'info'}`;

        tr.innerHTML = `
            <td>${timestamp}</td>
            <td>${event.event_type}</td>
            <td><span class="severity-badge ${severityClass}">${event.severity || 'info'}</span></td>
            <td>${event.error_message || event.payload?.message || 'N/A'}</td>
        `;
        container.appendChild(tr);
    });
}

async function loadAnalyticsTenants() {
    try {
        const tenants = await adminFetch('/admin/tenants');
        const select = document.getElementById('analytics-tenant-filter');

        // Clear existing options except "All"
        while (select.options.length > 1) {
            select.remove(1);
        }

        if (tenants) {
            tenants.forEach(tenant => {
                const option = document.createElement('option');
                option.value = tenant.id;
                option.textContent = tenant.store_name;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading analytics tenants:', error);
    }
}

function updateToolConfig() {
    const type = document.querySelector('[name="type"]').value;
    const configDiv = document.getElementById('tool-config');
    configDiv.innerHTML = '';

    if (type === 'http') {
        configDiv.innerHTML = `
            <div class="form-group full">
                <label>Configuraci√≥n HTTP (JSON)</label>
                <textarea name="config" rows="3" placeholder='{"default_method": "GET"}'></textarea>
            </div>
        `;
    } else if (type === 'tienda_nube') {
        configDiv.innerHTML = `
            <div class="form-group">
                <label>Store ID</label>
                <input type="text" name="store_id" placeholder="12345">
            </div>
            <div class="form-group">
                <label>Access Token</label>
                <input type="password" name="access_token">
            </div>
        `;
    }
}

// Tenant Edit/Delete
let editingTenant = null;

function resetTenantModal() {
    editingTenant = null;
    document.getElementById('tenant-modal-title').textContent = 'Configuraci√≥n de Tienda';
    document.getElementById('delete-tenant-btn').style.display = 'none';
    document.getElementById('tenant-form').reset();
    document.getElementById('tenant-credentials-list').innerHTML = '';
}

function editTenant(botPhoneNumber) {
    console.log('Edit tenant called with:', botPhoneNumber); // Debug log

    // Fetch tenant data
    adminFetch(`/admin/tenants/${botPhoneNumber}`).then(tenant => {
        console.log('Tenant data received:', tenant); // Debug log

        if (tenant) {
            // Pre-fill form
            const form = document.getElementById('tenant-form');
            if (form) {
                form.dataset.tenantId = tenant.id;
                form.elements['store_name'].value = tenant.store_name || '';
                form.elements['bot_phone_number'].value = tenant.bot_phone_number || '';
                form.elements['tiendanube_store_id'].value = tenant.tiendanube_store_id || '';
                form.elements['tiendanube_access_token'].value = tenant.tiendanube_access_token || '';
                form.elements['store_description'].value = tenant.store_description || '';
                form.elements['store_catalog_knowledge'].value = tenant.store_catalog_knowledge || '';
                form.elements['store_location'].value = tenant.store_location || '';
                form.elements['store_website'].value = tenant.store_website || '';
                form.elements['owner_email'].value = tenant.owner_email || '';

                editingTenant = botPhoneNumber;
                const title = document.getElementById('tenant-modal-title');
                if (title) title.textContent = 'Editar Tienda';

                const deleteBtn = document.getElementById('delete-tenant-btn');
                if (deleteBtn) deleteBtn.style.display = 'inline-block';

                openModal('tenant-modal');
                // Render associated credentials
                if (tenant.id) {
                    renderTenantCredentials(tenant.id);
                }
                console.log('Modal opened successfully'); // Debug log
            } else {
                console.error('Tenant form not found');
                showNotification(false, 'Error', 'No se pudo encontrar el formulario de edici√≥n');
            }
        } else {
            console.error('No tenant data received');
            showNotification(false, 'Error', 'No se pudieron cargar los datos de la tienda');
        }
    }).catch(error => {
        console.error('Error fetching tenant:', error);
        showNotification(false, 'Error', 'Error al cargar los datos de la tienda');
    });
}

async function deleteTenant(phoneNumber) {
    const idToDelete = phoneNumber || editingTenant;
    if (!idToDelete) return;

    if (!confirm(`¬øEst√°s seguro de que quieres eliminar esta tienda? Esta acci√≥n no se puede deshacer.`)) return;

    try {
        const res = await adminFetch(`/admin/tenants/${encodeURIComponent(idToDelete)}`, 'DELETE');
        if (res && res.status === 'ok') {
            showNotification(true, 'Tienda Eliminada', 'La tienda se elimin√≥ correctamente.');
            closeModal('tenant-modal');
            loadTenants();
            if (typeof updateStats === 'function') updateStats();

            // Call step reset if it exists
            if (typeof checkAndResetStep3 === 'function') checkAndResetStep3();
        } else {
            showNotification(false, 'Error', 'No se pudo eliminar la tienda.');
        }
    } catch (error) {
        showNotification(false, 'Error de Conexi√≥n', `Error: ${error.message}`);
    }
}

// Render credentials in Tenant Modal
async function renderTenantCredentials(tenantId) {
    const listContainer = document.getElementById('tenant-credentials-list');
    listContainer.innerHTML = '<div style="text-align: center; color: #aaa; padding: 10px;">Cargando credenciales...</div>';

    try {
        const creds = await adminFetch('/admin/credentials');
        listContainer.innerHTML = '';

        if (!creds || creds.length === 0) {
            listContainer.innerHTML = '<div style="text-align: center; color: #666; padding: 10px;">No hay credenciales disponibles.</div>';
            return;
        }

        // Filter for this tenant
        const tenantSpecific = creds.filter(c => c.scope === 'tenant' && c.tenant_id == tenantId);
        const globalCreds = creds.filter(c => c.scope === 'global');

        // Helper to render a group
        const renderGroup = (title, items, isGlobal) => {
            if (items.length === 0) return '';

            let html = `<h4 style="color: #888; margin: 15px 0 10px; font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px;">${title}</h4>`;
            items.forEach(c => {
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.03); padding: 8px 12px; border-radius: 6px; margin-bottom: 5px; border: 1px solid rgba(255,255,255,0.05);">
                        <div style="display: flex; flex-direction: column;">
                            <span style="font-weight: 500; color: #e4e4e7;">${c.name}</span>
                            <span style="font-size: 0.8em; color: #a1a1aa; margin-top: 2px;">${c.category || 'Sin categor√≠a'}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-family: monospace; letter-spacing: 2px; color: #71717a;">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                            ${isGlobal ?
                        '<span class="badge global" style="font-size: 0.7em; opacity: 0.7;">Global</span>' :
                        `<button class="btn-delete" style="padding: 2px 8px; font-size: 10px;" onclick="deleteCredential(${c.id})">Borrar</button>`
                    }
                        </div>
                    </div>
                `;
            });
            return html;
        };

        let content = '';
        content += renderGroup('Tenant-Specific', tenantSpecific, false);
        content += renderGroup('Global (Heredadas)', globalCreds, true);

        if (content === '') {
            content = '<div style="text-align: center; color: #666; padding: 10px;">No hay credenciales asociadas.</div>';
        }

        listContainer.innerHTML = content;

    } catch (error) {
        console.error('Error rendering tenant credentials:', error);
        listContainer.innerHTML = `<div style="color: var(--error); padding: 10px;">Error al cargar credenciales: ${error.message}</div>`;
    }
}

// Form Submission
document.getElementById('tenant-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;

    // Loading state
    submitBtn.disabled = true;
    submitBtn.textContent = 'Guardando...';

    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());

    try {
        const res = await adminFetch('/admin/tenants', 'POST', data);
        if (res && res.status === 'ok') {
            const message = editingTenant ? 'La tienda se actualiz√≥ correctamente.' : 'La tienda se cre√≥ correctamente.';
            showNotification(true, editingTenant ? 'Tienda Actualizada' : 'Tienda Creada', message);
            closeModal('tenant-modal');
            resetTenantModal();
            loadTenants();
            updateStats();
        } else {
            showNotification(false, 'Error', 'No se pudo guardar la tienda. Verifica los datos e intenta de nuevo.');
        }
    } catch (error) {
        showNotification(false, 'Error de Conexi√≥n', `Error: ${error.message}. Verifica la URL del API.`);
    } finally {
        // Reset button
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
});

// Credentials Management Variables
let editingCredential = null;

// Reset Credentials Modal
function resetCredentialModal() {
    editingCredential = null;
    document.getElementById('cred-modal').querySelector('h2').textContent = 'Agregar/Editar Credencial';
    document.getElementById('cred-form').reset();
    document.getElementById('tenant-selector').style.display = 'none';
    // Always load tenant selector
    loadTenantSelector();
}

// Edit Credential
async function editCredential(id) {
    try {
        // Fetch the credential data
        const credential = await adminFetch(`/admin/credentials/${id}`);
        if (!credential) {
            showNotification(false, 'Error', 'Credencial no encontrada');
            return;
        }

        editingCredential = id;
        document.getElementById('cred-modal').querySelector('h2').textContent = `Editar Credencial`;

        // Populate form with existing data
        const form = document.getElementById('cred-form');
        form.elements['name'].value = credential.name || '';
        form.elements['value'].value = credential.value || ''; // Note: This exposes the actual value
        form.elements['category'].value = credential.category || '';
        form.elements['description'].value = credential.description || '';
        form.elements['scope'].value = credential.scope || 'global';

        // Handle tenant selector
        toggleTenantSelector();

        if (credential.scope === 'tenant') {
            form.elements['tenant_id'].value = credential.tenant_id || '';
        }

        openModal('cred-modal');
    } catch (error) {
        showNotification(false, 'Error', 'No se pudo cargar la credencial para editar');
        console.error('Error loading credential:', error);
    }
}

// Delete Credential
async function deleteCredential(id) {
    if (confirm(`¬øEst√°s seguro de que quieres eliminar esta credencial? Esta acci√≥n no se puede deshacer.`)) {
        try {
            const res = await adminFetch(`/admin/credentials/${id}`, 'DELETE');
            if (res && res.status === 'ok') {
                showNotification(true, 'Credencial Eliminada', 'La credencial se elimin√≥ correctamente.');

                // Reload main list
                loadCredentials();

                // Reload tenant modal list if open
                const tenantModal = document.getElementById('tenant-modal');
                const tenantForm = document.getElementById('tenant-form');
                if (tenantModal && tenantModal.style.display === 'flex' && tenantForm && tenantForm.dataset.tenantId) {
                    renderTenantCredentials(tenantForm.dataset.tenantId);
                }
            } else {
                showNotification(false, 'Error', 'No se pudo eliminar la credencial.');
            }
        } catch (error) {
            showNotification(false, 'Error de Conexi√≥n', `Error: ${error.message}`);
        }
    }
}

// Toggle Tenant Selector
function toggleTenantSelector() {
    const scope = document.getElementById('cred-form').elements['scope'].value;
    const tenantSelector = document.getElementById('tenant-selector');

    if (scope === 'tenant') {
        tenantSelector.style.display = 'block';
        loadTenantSelector();
    } else {
        tenantSelector.style.display = 'none';
        document.getElementById('cred-tenant-select').value = '';
    }
}

// Load Tenant Selector
async function loadTenantSelector(selectId = 'cred-tenant-select') {
    const select = document.getElementById(selectId);
    select.innerHTML = '<option value="">Seleccionar tenant...</option>';

    try {
        const tenants = await adminFetch('/admin/tenants');
        if (tenants) {
            tenants.forEach(tenant => {
                const option = document.createElement('option');
                option.value = tenant.id;
                option.textContent = tenant.store_name;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading tenants:', error);
    }
}

// Credentials Form
document.getElementById('cred-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;

    submitBtn.disabled = true;
    submitBtn.textContent = 'Guardando...';

    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());

    // Validate tenant selection for tenant-scoped credentials
    if (data.scope === 'tenant' && !data.tenant_id) {
        showNotification(false, 'Error', 'Debes seleccionar un tenant para credenciales con scope "tenant".');
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
        return;
    }

    // Handle tenant_id conversion
    if (data.scope === 'global') {
        // For global scope, remove tenant_id or set to null
        data.tenant_id = null;
    } else if (data.tenant_id) {
        // For tenant scope, convert to int
        try {
            data.tenant_id = parseInt(data.tenant_id);
            if (isNaN(data.tenant_id)) {
                throw new Error('Invalid tenant_id');
            }
        } catch (error) {
            showNotification(false, 'Error', 'El tenant_id debe ser un n√∫mero v√°lido.');
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            return;
        }
    }

    try {
        console.log('Submitting credential data:', data); // Debug log

        let res;
        if (editingCredential) {
            // Update existing credential
            res = await adminFetch(`/admin/credentials/${editingCredential}`, 'PUT', data);
        } else {
            // Create new credential
            res = await adminFetch('/admin/credentials', 'POST', data);
        }

        console.log('Credential save response:', res); // Debug log

        if (res && res.status === 'ok') {
            const message = editingCredential ?
                'La credencial se actualiz√≥ correctamente.' :
                'La credencial se almacen√≥ correctamente.';
            showNotification(true, editingCredential ? 'Credencial Actualizada' : 'Credencial Guardada', message);
            closeModal('cred-modal');
            resetCredentialModal();
            loadCredentials();
        } else {
            const errorMsg = res?.detail || res?.message || 'Respuesta inesperada del servidor';
            showNotification(false, 'Error al Guardar', `No se pudo guardar la credencial: ${errorMsg}`);
        }
    } catch (error) {
        console.error('Credential save error:', error);
        let errorMsg = error.message || 'Error desconocido';

        // Try to extract more detailed error from response
        if (error.responseText) {
            try {
                const errorData = JSON.parse(error.responseText);
                errorMsg = errorData.error || errorData.detail || errorMsg;
            } catch (parseError) {
                // If not JSON, use the raw text
                if (error.responseText) {
                    errorMsg = error.responseText;
                }
            }
        }

        showNotification(false, 'Error al Guardar', `Error: ${errorMsg}`);
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
});

// YCloud Form
document.getElementById('ycloud-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;

    submitBtn.disabled = true;
    submitBtn.textContent = 'Guardando...';

    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());

    try {
        // Save both keys to credentials table
        const tenant_id = data.tenant_id ? parseInt(data.tenant_id) : null;
        const scope = tenant_id ? 'tenant' : 'global';

        await adminFetch('/admin/credentials', 'POST', {
            name: "YCLOUD_API_KEY",
            value: data.api_key || data.YCLOUD_API_KEY,
            category: "whatsapp_ycloud",
            scope: scope,
            tenant_id: tenant_id,
            description: "YCloud API Key for WhatsApp"
        });

        await adminFetch('/admin/credentials', 'POST', {
            name: "YCLOUD_WEBHOOK_SECRET",
            value: data.webhook_secret || data.YCLOUD_WEBHOOK_SECRET,
            category: "whatsapp_ycloud",
            scope: scope,
            tenant_id: tenant_id,
            description: "YCloud Webhook Secret"
        });

        showNotification(true, 'YCloud Configurado', 'La configuraci√≥n de WhatsApp (YCloud) se guard√≥ correctamente.');
        closeModal('ycloud-config-modal');
        if (typeof loadCredentials === 'function') loadCredentials();
    } catch (error) {
        showNotification(false, 'Error de Conexi√≥n', `Error: ${error.message}`);
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
});

// Tool Form
document.getElementById('tool-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());

    // Build config object
    let config = {};
    if (data.type === 'http') {
        config = data.config ? JSON.parse(data.config) : {};
    } else if (data.type === 'tienda_nube') {
        config = {
            store_id: data.store_id,
            access_token: data.access_token
        };
    }

    const toolData = {
        name: data.name,
        type: data.type,
        config: config,
        service_url: data.service_url || null
    };

    try {
        const res = await adminFetch('/admin/tools', 'POST', toolData);
        if (res && res.status === 'ok') {
            showNotification(true, 'Herramienta Creada', 'La herramienta se cre√≥ correctamente.');
            closeModal('tool-modal');
            loadTools();
        } else {
            showNotification(false, 'Error', 'No se pudo crear la herramienta.');
        }
    } catch (error) {
        showNotification(false, 'Error de Conexi√≥n', `Error: ${error.message}`);
    }
});

// Tour System
const tourSteps = [
    {
        icon: "üìä",
        title: "Panel General",
        content: "Aqu√≠ ver√°s m√©tricas clave: tiendas activas, mensajes totales y √©xito de la IA. Monitorea el rendimiento de tus bots en tiempo real."
    },
    {
        icon: "üèòÔ∏è",
        title: "Mis Tiendas",
        content: "Gestiona tus tiendas conectadas a Tienda Nube. Crea nuevas tiendas configurando nombre, n√∫mero de WhatsApp, ID de Tienda Nube y tokens. Cada tienda puede tener su propio branding y cat√°logo."
    },
    {
        icon: "üîê",
        title: "Credenciales",
        content: "Almacena de forma segura tus API keys y tokens. Incluye credenciales globales como OpenAI, YCloud, y tokens espec√≠ficos por tienda para Tienda Nube."
    },
    {
        icon: "üì±",
        title: "WhatsApp (YCloud)",
        content: "Conecta tu cuenta de WhatsApp Business. Para configurar:<br><br>1. Crea una cuenta en <a href='https://developers.facebook.com' target='_blank'>Meta for Developers</a><br>2. Configura un Portfolio y agrega WhatsApp<br>3. Crea una app de WhatsApp Business<br>4. Obt√©n API Key y Webhook Secret<br>5. Configura webhooks apuntando a tu dominio:8002<br>6. Escanea el QR en Meta para verificar el n√∫mero<br><br>Nota: Asegura coexistencia con WhatsApp personal activando 'Coexistencia' en la app."
    },
    {
        icon: "üìú",
        title: "Live History",
        content: "Visualiza mensajes en tiempo real. Ve conversaciones entre usuarios y la IA, con respuestas generadas. √ötil para debugging y monitoreo."
    },
    {
        icon: "üìà",
        title: "M√©tricas Avanzadas",
        content: "An√°lisis detallado de rendimiento: tasas de respuesta, tiempos de procesamiento, errores y patrones de uso. Pr√≥ximamente disponible."
    }
];

let currentTourStep = 0;

function startTour() {
    if (localStorage.getItem('codexy_tour_completed')) return;
    currentTourStep = 0;
    showTourStep();
    document.getElementById('tour-overlay').style.display = 'flex';
}

function showTourStep() {
    const step = tourSteps[currentTourStep];
    document.getElementById('tour-icon').textContent = step.icon;
    document.getElementById('tour-title').textContent = step.title;
    document.getElementById('tour-content').innerHTML = step.content;

    const nextBtn = document.getElementById('tour-next');
    nextBtn.textContent = currentTourStep === tourSteps.length - 1 ? 'Finalizar' : 'Siguiente';
}

function nextTourStep() {
    currentTourStep++;
    if (currentTourStep >= tourSteps.length) {
        endTour();
    } else {
        showTourStep();
    }
}

function endTour() {
    document.getElementById('tour-overlay').style.display = 'none';
    localStorage.setItem('codexy_tour_completed', 'true');
}

document.getElementById('tour-next').addEventListener('click', nextTourStep);
document.getElementById('tour-skip').addEventListener('click', endTour);

// Connection and Diagnostics
function connectInstance() {
    const apiStatus = document.getElementById('api-status');
    apiStatus.textContent = 'Conectando...';
    apiStatus.className = 'card-status';

    // Test connection
    checkConnection().then(success => {
        if (success) {
            apiStatus.textContent = 'Conectado ‚úì';
            apiStatus.classList.add('ok');
            updateWelcomeFromBootstrap();
        } else {
            apiStatus.textContent = 'Error de conexi√≥n';
            apiStatus.classList.add('error');
        }
    });
}

function checkConnection() {
    return adminFetch('/health').then(() => {
        return adminFetch('/admin/bootstrap');
    }).then(bootstrap => {
        // Connection status is now verified on each page load
        // No localStorage caching to prevent stale data
        updateWelcomeFromBootstrap(bootstrap);
        return true;
    }).catch(error => {
        console.error('Connection error:', error);
        return false;
    });
}

function updateWelcomeFromBootstrap(bootstrap) {
    if (!bootstrap) return;

    // Update webhook URL
    const webhookUrl = bootstrap.suggested_webhook_url || 'No disponible';
    document.getElementById('webhook-url-display').textContent = webhookUrl;

    // Update checklist
    updateChecklist(bootstrap);
}

function updateChecklist(bootstrap) {
    const tenantCheck = document.getElementById('check-tenant');
    const tnCheck = document.getElementById('check-tiendanube');
    const openaiCheck = document.getElementById('check-openai');

    // Tenant check
    if (bootstrap.tenants_count > 0) {
        tenantCheck.querySelector('.check-status').textContent = '‚úÖ';
        tenantCheck.style.color = 'var(--success)';
    }

    // Tienda Nube check
    if (bootstrap.configured_services && bootstrap.configured_services.includes('tiendanube')) {
        tnCheck.querySelector('.check-status').textContent = '‚úÖ';
        tnCheck.style.color = 'var(--success)';
    }

    // OpenAI check
    if (bootstrap.configured_services && bootstrap.configured_services.includes('openai')) {
        openaiCheck.querySelector('.check-status').textContent = '‚úÖ';
        openaiCheck.style.color = 'var(--success)';
    }

    // WhatsApp YCloud check
    const ycloudCheck = document.getElementById('check-ycloud');
    if (ycloudCheck && bootstrap.configured_services && bootstrap.configured_services.includes('whatsapp_ycloud')) {
        ycloudCheck.querySelector('.check-status').textContent = '‚úÖ';
        ycloudCheck.style.color = 'var(--success)';
    }

    // WhatsApp Meta check
    const metaCheck = document.getElementById('check-meta');
    if (metaCheck && bootstrap.configured_services && bootstrap.configured_services.includes('whatsapp_meta')) {
        metaCheck.querySelector('.check-status').textContent = '‚úÖ';
        metaCheck.style.color = 'var(--success)';
    }
}

function copyWebhookUrl() {
    const webhookUrl = document.getElementById('webhook-url-display').textContent;
    navigator.clipboard.writeText(webhookUrl).then(() => {
        showNotification(true, 'Copiado', 'URL del webhook copiada al portapapeles');
    });
}

async function testWhatsAppMetaConnection() {
    const resultDiv = document.getElementById('meta-test-result');
    resultDiv.innerHTML = '<div style="color: var(--text-secondary)">Probando conexi√≥n con WhatsApp Meta API...</div>';

    try {
        // Check if credentials exist
        const status = await adminFetch('/admin/whatsapp-meta/status', 'GET', null, 'default');
        if (status && status.connected) {
            resultDiv.innerHTML = '<div style="color: var(--success)">‚úÖ Conexi√≥n exitosa - Credenciales v√°lidas</div>';
            showNotification(true, 'Conexi√≥n Exitosa', 'WhatsApp Meta API est√° correctamente configurado.');
        } else {
            resultDiv.innerHTML = '<div style="color: var(--accent)">‚ùå Credenciales no encontradas - Configura primero las credenciales arriba</div>';
            showNotification(false, 'Credenciales Faltantes', 'Guarda las credenciales de WhatsApp Meta API primero.');
        }
    } catch (error) {
        resultDiv.innerHTML = `<div style="color: var(--accent)">‚ùå Error de conexi√≥n: ${error.message}</div>`;
        showNotification(false, 'Error de Conexi√≥n', 'No se pudo verificar la conexi√≥n con WhatsApp Meta API.');
    }
}

async function testTenantConnection(phone, storeId, token) {
    showNotification(false, 'Probando...', `Verificando conexi√≥n para ${phone}...`);
    try {
        const res = await adminFetch(`/admin/tenants/${phone}/test-message`, 'POST');
        if (res && res.status === 'ok') {
            showNotification(true, 'Test Exitoso', 'El mensaje de prueba se encol√≥ correctamente.');
        } else {
            showNotification(false, 'Error en Test', 'El servidor retorn√≥ un error al intentar enviar el mensaje.');
        }
    } catch (error) {
        showNotification(false, 'Error de Conexi√≥n', error.message);
    }
}

function verifyWebhook() {
    showNotification(false, 'Verificando...', 'Env√≠a un mensaje de prueba a tu n√∫mero de WhatsApp');

    // Poll for new inbound events
    const initialInbound = document.getElementById('last-inbound').textContent;

    setTimeout(() => {
        updateStats(); // Refresh last signals
        setTimeout(() => {
            const newInbound = document.getElementById('last-inbound').textContent;
            if (newInbound !== initialInbound && newInbound !== 'Nunca') {
                showNotification(true, 'Webhook Verificado', '¬°Evento recibido exitosamente!');
            } else {
                showNotification(false, 'Sin Eventos', 'No se detectaron nuevos eventos. Verifica la configuraci√≥n del webhook.');
            }
        }, 2000);
    }, 3000);
}

function showStatus(message, isError) {
    const statusEl = document.getElementById('connect-status');
    statusEl.textContent = message;
    statusEl.classList.toggle('error', isError);
}

function runDiagnostics() {
    openModal('diagnostics-modal');
    document.getElementById('diagnostics-content').innerHTML = '<p>Verificando servicios...</p>';
    adminFetch('/health').then(() => {
        document.getElementById('diagnostics-content').innerHTML = '<p style="color: var(--success)">‚úì Orquestador operativo</p><p style="color: var(--text-secondary)">Otros servicios requieren verificaci√≥n manual</p>';
    }).catch(() => {
        document.getElementById('diagnostics-content').innerHTML = '<p style="color: var(--accent)">‚úó Problemas de conexi√≥n con el orquestador</p>';
    });
}

// Initial Load - Always verify connection fresh
checkConnection().then(success => {
    if (success) {
        showView('overview');
        updateStats();
        loadAnalyticsTenants(); // Load tenants for analytics filter
        setInterval(updateStats, 10000);
        setInterval(() => {
            if (currentView === 'logs') loadLogs();
        }, 5000);
        startTour();
    } else {
        // Stay on welcome with error state
        document.getElementById('api-status').textContent = 'Error de conexi√≥n';
        document.getElementById('api-status').classList.add('error');
    }
});

// Event listeners
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('config-btn')) {
        const phone = e.target.getAttribute('data-phone');
        editTenant(phone);
    }
});

// Setup Wizard
let currentSetupStep = 1;
const totalSetupSteps = 5; // Simplified to essential steps

function startSetupWizard() {
    currentSetupStep = 1;
    showView('setup');
    renderSetupStep();
}

function renderSetupStep() {
    const content = document.getElementById('setup-content');
    const progress = ((currentSetupStep - 1) / (totalSetupSteps - 1)) * 100;
    document.getElementById('progress-fill').style.width = progress + '%';

    // Update step indicators
    for (let i = 1; i <= totalSetupSteps; i++) {
        const stepEl = document.getElementById('step-' + i);
        stepEl.classList.remove('active', 'completed');
        if (i < currentSetupStep) {
            stepEl.classList.add('completed');
        } else if (i === currentSetupStep) {
            stepEl.classList.add('active');
        }
    }

    // Update buttons
    document.getElementById('prev-btn').style.display = currentSetupStep > 1 ? 'inline-block' : 'none';
    document.getElementById('test-btn').style.display = [2, 3].includes(currentSetupStep) ? 'inline-block' : 'none';
    document.getElementById('next-btn').textContent = currentSetupStep === totalSetupSteps ? 'Finalizar' : 'Siguiente';

    // Render step content
    switch (currentSetupStep) {
        case 1:
            renderStep1();
            break;
        case 2:
            renderStep2();
            break;
        case 3:
            renderStep3();
            break;
        case 4:
            renderStep4();
            break;
        case 5:
            renderStep5();
            break;
        default:
            content.innerHTML = '<h2>Paso ' + currentSetupStep + '</h2><p>Pr√≥ximamente...</p>';
    }
}

function renderStep1() {
    const content = document.getElementById('setup-content');
    content.innerHTML = `
        <h2 class="setup-step-title">Crear Tienda</h2>
        <p class="setup-step-description">Configura tu primera tienda para comenzar. Necesitar√°s un n√∫mero de WhatsApp √∫nico.</p>
        <div class="setup-form">
            <div class="form-group">
                <label>N√∫mero de WhatsApp del Bot</label>
                <input type="text" id="setup-bot-phone" placeholder="5491234567890" required>
            </div>
            <div class="form-group">
                <label>Nombre de la Tienda</label>
                <input type="text" id="setup-store-name" placeholder="Mi Tienda Online" required>
            </div>
            <div class="form-group">
                <label>Sitio Web</label>
                <input type="url" id="setup-store-website" placeholder="https://mitienda.com">
            </div>
        </div>
    `;
}

function renderStep2() {
    const content = document.getElementById('setup-content');
    content.innerHTML = `
        <h2 class="setup-step-title">Conectar Tienda Nube</h2>
        <p class="setup-step-description">Integra con tu tienda Tienda Nube para acceder a productos y pedidos.</p>
        <div class="setup-form">
            <div class="form-group">
                <label>ID de Tienda Nube</label>
                <input type="text" id="setup-tn-store-id" placeholder="123456" required>
            </div>
            <div class="form-group">
                <label>Token de Acceso</label>
                <input type="password" id="setup-tn-token" required>
            </div>
        </div>
        <div id="tn-test-result"></div>
    `;
}

function renderStep4() {
    const content = document.getElementById('setup-content');
    content.innerHTML = `
        <h2 class="setup-step-title">Verificar Conexi√≥n</h2>
        <p class="setup-step-description">Comprobamos que todos los servicios est√©n conectados y funcionando.</p>
        <div class="setup-form">
            <button class="btn-primary" id="test-connection-btn">Verificar Conexi√≥n</button>
        </div>
        <div id="connection-test-result"></div>
    `;

    // Add event listener
    const testBtn = document.getElementById('test-connection-btn');
    if (testBtn) {
        testBtn.addEventListener('click', () => runStepTest(4));
    }
}

function renderStep5() {
    const content = document.getElementById('setup-content');
    content.innerHTML = `
        <h2 class="setup-step-title">Enviar Mensaje de Prueba</h2>
        <p class="setup-step-description">Env√≠a un mensaje de prueba a tu n√∫mero de WhatsApp para verificar que todo funciona.</p>
        <div class="setup-form">
            <button class="btn-primary" id="send-test-btn">Enviar Mensaje de Prueba</button>
        </div>
        <div id="test-message-result"></div>
    `;

    // Add event listener
    const testBtn = document.getElementById('send-test-btn');
    if (testBtn) {
        testBtn.addEventListener('click', () => runStepTest(5));
    }
}

async function renderStep3() {
    const content = document.getElementById('setup-content');

    // Check if any tenants exist
    let tenants = [];
    try {
        const response = await adminFetch('/admin/tenants');
        tenants = response || [];
    } catch (e) {
        console.error('Error fetching tenants:', e);
    }

    // If no tenants, prompt to create one
    if (!tenants || tenants.length === 0) {
        content.innerHTML = `
            <h2 class="setup-step-title">Crear Primera Tienda</h2>
            <p class="setup-step-description">No tienes tiendas configuradas. Crea tu primera tienda para continuar con el setup.</p>
            <div class="setup-form">
                <button class="btn-primary" onclick="showView('stores'); closeModal('setup-modal')">Ir a Mis Tiendas</button>
            </div>
            <div style="margin-top: 20px; padding: 15px; background: rgba(255,165,0,0.1); border: 1px solid orange; color: #ff8c00; border-radius: 8px;">
                <strong>üí° Tip:</strong> Ve a "Mis Tiendas" en el men√∫ lateral para crear tu primera tienda con WhatsApp y Tienda Nube.
            </div>
        `;
        return;
    }

    // If tenants exist, show success
    content.innerHTML = `
        <h2 class="setup-step-title">Tienda Configurada</h2>
        <p class="setup-step-description">¬°Excelente! Ya tienes ${tenants.length} tienda(s) configurada(s). El setup puede continuar.</p>
        <div class="setup-form">
            <button class="btn-primary" id="test-tenant-btn">Verificar Tienda</button>
        </div>
        <div id="tenant-test-result"></div>
    `;

    // Add event listener
    const testBtn = document.getElementById('test-tenant-btn');
    if (testBtn) {
        testBtn.addEventListener('click', () => runStepTest(3));
    }
}

function updateTestButton() {
    const select = document.getElementById('setup-tn-store-select');
    const selectedOption = select.options[select.selectedIndex];
    const storeId = selectedOption.value;
    const token = selectedOption.getAttribute('data-token');

    // Update test button text
    const testBtn = document.getElementById('test-btn');
    if (testBtn) {
        testBtn.textContent = storeId === 'global' ? 'Probar Tienda Global' : `Probar ${selectedOption.text}`;
    }
}

function nextStep() {
    // Mark current step as completed
    stepStatuses[currentSetupStep] = 'ok';
    updateStepUI();
    saveSetupProgress();

    if (currentSetupStep < totalSetupSteps) {
        currentSetupStep++;
        renderSetupStep();
    } else {
        // Complete setup
        showNotification(true, 'Configuraci√≥n Completa', 'Tu bot est√° listo para usar. Ve al Overview para monitorear.');
        showView('overview');
    }
}

function prevStep() {
    if (currentSetupStep > 1) {
        currentSetupStep--;
        renderSetupStep();
    }
}

async function testCurrentStep() {
    if (currentSetupStep === 1) {
        await runStepTest(1);
    } else if (currentSetupStep === 2) {
        await runStepTest(2);
    } else if (currentSetupStep === 3) {
        await runStepTest(3);
    } else if (currentSetupStep === 4) {
        await runStepTest(4);
    } else if (currentSetupStep === 5) {
        await runStepTest(5);
    }
}

async function testTiendaNube() {
    // First check if there are any stores to test
    const stores = await adminFetch('/admin/setup/tiendanube/stores');
    if (!stores || stores.stores.length === 0) {
        // No stores available, prompt to create one
        if (confirm('No tienes tiendas Tienda Nube configuradas. ¬øQuieres crear una ahora?')) {
            openModal('tenant-modal');
            resetTenantModal();
        }
        return;
    }

    const select = document.getElementById('setup-tn-store-select');
    if (!select) {
        showTestResult('tn-test-result', 'Selector no encontrado', true);
        return;
    }

    const selectedValue = select.value;
    if (!selectedValue || selectedValue === 'create-new') {
        showTestResult('tn-test-result', 'Selecciona una tienda para probar', true);
        return;
    }

    showTestResult('tn-test-result', 'Probando conexi√≥n...', false);

    try {
        const response = await adminFetch(`/admin/setup/tiendanube/stores/${selectedValue}/test`, 'POST');

        if (response && response.status === 'OK') {
            showTestResult('tn-test-result', `‚úì Conexi√≥n exitosa - ${response.store_name}`, false);
            // Mark as active and update step
            await adminFetch(`/admin/setup/tiendanube/stores/${selectedValue}/activate`, 'POST');
            // Update UI status
            const option = select.querySelector(`option[value="${selectedValue}"]`);
            if (option) {
                option.textContent = option.textContent.replace('(inactive)', '(active)');
            }
            // Mark step as passed
            stepStatuses[3] = 'ok';
            updateStepUI();
            saveSetupProgress();
        } else {
            showTestResult('tn-test-result', `‚úó Error: ${response?.error || 'Conexi√≥n fallida'}`, true);
        }
    } catch (error) {
        showTestResult('tn-test-result', `‚úó Error de conexi√≥n: ${error.message}`, true);
    }
}

async function testYCloud() {
    const apiKey = document.getElementById('setup-ycloud-key').value;
    const secret = document.getElementById('setup-ycloud-secret').value;

    if (!apiKey || !secret) {
        showTestResult('ycloud-test-result', 'Completa todos los campos', true);
        return;
    }

    showTestResult('ycloud-test-result', 'Esperando webhook... Env√≠a un mensaje de prueba a tu n√∫mero', false);

    // This would poll for webhook events
    // For now, just show instruction
}

function showTestResult(elementId, message, isError) {
    const el = document.getElementById(elementId);
    el.innerHTML = `<div class="test-result ${isError ? 'error' : ''}">${message}</div>`;
}

function showTestResultWithCTA(elementId, message, subtitle, actions, isError) {
    const el = document.getElementById(elementId);
    let html = `<div class="test-result ${isError ? 'error' : ''}">`;
    html += `<div class="test-message">${message}</div>`;
    if (subtitle) {
        html += `<div class="test-subtitle">${subtitle}</div>`;
    }
    html += '<div class="test-actions">';

    actions.forEach(action => {
        if (action.url) {
            html += `<button class="btn-cta" onclick="window.open('${action.url}', '_blank')">${action.icon} ${action.text}</button>`;
        } else if (action.action === 'focus' && action.target) {
            html += `<button class="btn-cta" onclick="document.getElementById('${action.target}').focus()">${action.icon} ${action.text}</button>`;
        } else if (action.action === 'redirect' && action.target) {
            html += `<button class="btn-cta" onclick="showView('${action.target}')">${action.icon} ${action.text}</button>`;
        } else if (action.action === 'help') {
            html += `<button class="btn-cta" onclick="showTiendaNubeHelp()">${action.icon} ${action.text}</button>`;
        } else {
            html += `<button class="btn-cta">${action.icon} ${action.text}</button>`;
        }
    });

    html += '</div></div>';
    el.innerHTML = html;
}

function showTiendaNubeHelp() {
    const helpContent = `
        <h4>¬øC√≥mo obtener credenciales de Tienda Nube?</h4>
        <ol>
            <li>Ve a <a href="https://www.tiendanube.com" target="_blank">tiendanube.com</a> y accede a tu tienda</li>
            <li>Ve a Configuraci√≥n ‚Üí API ‚Üí Aplicaciones</li>
            <li>Crea una nueva aplicaci√≥n o edita una existente</li>
            <li>En "Permisos", marca: Productos (lectura), Pedidos (lectura), Cupones (lectura)</li>
            <li>Genera el Access Token y c√≥pialo inmediatamente</li>
            <li>El ID de tienda est√° en Configuraci√≥n ‚Üí C√≥digo de inserci√≥n</li>
        </ol>
    `;
    showNotification(false, 'Ayuda - Tienda Nube', helpContent);
}

// Tenant Edit/Delete Functions
function resetTenantModal() {
    document.getElementById('tenant-modal-title').textContent = 'Configuraci√≥n de Tienda';
    document.getElementById('tenant-form').reset();
    document.getElementById('delete-tenant-btn').style.display = 'none';
    document.getElementById('delete-tenant-btn').onclick = null;
    populateTNStoreDropdown();
}

async function populateTNStoreDropdown() {
    const select = document.getElementById('tn-store-preset');
    if (!select) return; // Safety check

    // Clear existing options except the first two
    while (select.options.length > 2) {
        select.remove(2);
    }

    try {
        const tenants = await adminFetch('/admin/tenants');
        const storesWithTN = tenants.filter(t => t.tiendanube_store_id);

        // Note: In tenant modal, we don't add "Create new" since we're already creating a tenant
        // The dropdown is just for pre-filling with existing TN credentials

        // Add existing stores
        storesWithTN.forEach(tenant => {
            const option = document.createElement('option');
            option.value = `existing-${tenant.bot_phone_number}`;
            option.textContent = `${tenant.store_name} (${tenant.tiendanube_store_id})`;
            option.setAttribute('data-store-id', tenant.tiendanube_store_id);
            option.setAttribute('data-token', tenant.tiendanube_access_token || '');
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading Tienda Nube stores:', error);
    }
}

function updateTNFields() {
    const select = document.getElementById('tn-store-preset');
    const manualFields = document.getElementById('tn-manual-fields');
    const selectedValue = select.value;

    if (selectedValue === 'custom' || selectedValue === 'create-new') {
        manualFields.style.display = 'block';
        // Clear any pre-filled values
        document.querySelector('[name="tiendanube_store_id"]').value = '';
        document.querySelector('[name="tiendanube_access_token"]').value = '';
        if (selectedValue === 'create-new') {
            // Open tenant modal for creating new store
            closeModal('tenant-modal'); // Close current modal
            setTimeout(() => {
                openModal('tenant-modal');
                resetTenantModal();
            }, 100);
        }
    } else if (selectedValue.startsWith('existing-')) {
        manualFields.style.display = 'block';
        const selectedOption = select.options[select.selectedIndex];
        document.querySelector('[name="tiendanube_store_id"]').value = selectedOption.getAttribute('data-store-id');
        document.querySelector('[name="tiendanube_access_token"]').value = selectedOption.getAttribute('data-token');
    } else {
        manualFields.style.display = 'none';
    }
}

async function editTenant(phoneNumber) {
    console.log('Edit tenant called with:', phoneNumber); // Debug log

    try {
        const tenant = await adminFetch(`/admin/tenants/${phoneNumber}`);
        console.log('Tenant data received:', tenant); // Debug log

        if (tenant) {
            // Populate form
            const form = document.getElementById('tenant-form');
            if (form) {
                form.elements['store_name'].value = tenant.store_name || '';
                form.elements['bot_phone_number'].value = tenant.bot_phone_number || '';
                form.elements['tiendanube_store_id'].value = tenant.tiendanube_store_id || '';
                form.elements['tiendanube_access_token'].value = tenant.tiendanube_access_token || '';
                form.elements['store_description'].value = tenant.store_description || '';
                form.elements['store_catalog_knowledge'].value = tenant.store_catalog_knowledge || '';
                form.elements['store_location'].value = tenant.store_location || '';
                form.elements['store_website'].value = tenant.store_website || '';
                form.elements['owner_email'].value = tenant.owner_email || '';

                editingTenant = phoneNumber;
                const title = document.getElementById('tenant-modal-title');
                if (title) title.textContent = 'Editar Tienda';

                const deleteBtn = document.getElementById('delete-tenant-btn');
                if (deleteBtn) {
                    deleteBtn.style.display = 'inline-block';
                    deleteBtn.onclick = () => deleteTenant(phoneNumber);
                }

                openModal('tenant-modal');
                console.log('Modal opened successfully'); // Debug log
            } else {
                console.error('Tenant form not found');
                showNotification(false, 'Error', 'No se pudo encontrar el formulario de edici√≥n');
            }
        } else {
            console.error('No tenant data received');
            showNotification(false, 'Error', 'No se pudieron cargar los datos de la tienda');
        }
    } catch (error) {
        console.error('Error fetching tenant:', error);
        showNotification(false, 'Error', 'Error al cargar los datos de la tienda');
    }
}

// Consolidated deleteTenant above at line 648

async function testTenantConnection(botPhoneNumber) {
    if (!botPhoneNumber) return;

    showNotification(true, 'Iniciando Test', 'Enviando mensaje de prueba al bot...');

    try {
        const res = await adminFetch(`/admin/tenants/${botPhoneNumber}/test-message`, 'POST');
        if (res && res.status === 'ok') {
            showNotification(true, 'Test Exitoso', 'El mensaje de prueba se proces√≥ correctamente.');
        } else {
            showNotification(false, 'Error de Test', 'El orquestador no pudo procesar el mensaje de prueba.');
        }
    } catch (error) {
        showNotification(false, 'Error de Conexi√≥n', `Error: ${error.message}`);
    }
}


async function deleteAllTenants() {
    if (!confirm('¬øEst√°s seguro de que quieres ELIMINAR TODAS las tiendas? Esta acci√≥n no se puede deshacer.')) return;

    try {
        const result = await adminFetch('/admin/tenants', 'DELETE');
        if (result && result.status === 'ok') {
            showNotification(true, 'Todas las Tiendas Eliminadas', 'Base de datos limpia. Puedes empezar de cero.');
            loadTenants();
            updateStats();

            // Reset step 3 since no stores available
            resetStep3IfNeeded();
        } else {
            showNotification(false, 'Error', 'No se pudieron eliminar las tiendas');
        }
    } catch (error) {
        showNotification(false, 'Error', 'Error al eliminar tiendas');
    }
}

function checkAndResetStep3() {
    // Check if there are any tenants with Tienda Nube configured
    adminFetch('/admin/tenants').then(tenants => {
        const hasTNConfigured = tenants.some(t => t.tiendanube_store_id);
        if (!hasTNConfigured && stepStatuses[3] === 'ok') {
            // Reset step 3 to pending
            stepStatuses[3] = 'pending';
            updateStepUI();
            saveSetupProgress();
            showNotification(false, 'Paso 3 Reiniciado', 'Se elimin√≥ la tienda conectada. El Paso 3 vuelve a pendiente.');
        }
    }).catch(error => {
        console.error('Error checking tenants for step reset:', error);
    });
}

function resetStep3IfNeeded() {
    if (stepStatuses[3] === 'ok') {
        stepStatuses[3] = 'pending';
        updateStepUI();
        saveSetupProgress();
        showNotification(false, 'Paso 3 Reiniciado', 'No hay tiendas con Tienda Nube configurada. El Paso 3 vuelve a pendiente.');
    }
}

// Mobile UI Functions
function toggleCollapsible(id) {
    const element = document.getElementById(id);
    element.classList.toggle('collapsed');
}

function toggleSidebar() {
    const sidebar = document.querySelector('.sidebar');
    const toggleBtn = document.getElementById('sidebar-toggle');

    if (sidebar.classList.contains('visible')) {
        sidebar.classList.remove('visible');
        toggleBtn.style.transform = 'translateX(-50%)';
    } else {
        sidebar.classList.add('visible');
        toggleBtn.style.transform = 'translateX(-50%) translateY(-10px)';
    }
}

// Auto-hide sidebar after 3 seconds of inactivity on mobile
let sidebarTimeout;
function resetSidebarTimeout() {
    if (window.innerWidth <= 768) {
        clearTimeout(sidebarTimeout);
        sidebarTimeout = setTimeout(() => {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar.classList.contains('visible')) {
                toggleSidebar();
            }
        }, 3000);
    }
}

// Add touch gesture for sidebar
let touchStartY = 0;
document.addEventListener('touchstart', (e) => {
    if (window.innerWidth <= 768) {
        touchStartY = e.touches[0].clientY;
    }
});

document.addEventListener('touchend', (e) => {
    if (window.innerWidth <= 768) {
        const touchEndY = e.changedTouches[0].clientY;
        const diff = touchStartY - touchEndY;

        // Swipe up gesture (more than 50px)
        if (diff > 50) {
            const toggleBtn = document.getElementById('sidebar-toggle');
            const rect = toggleBtn.getBoundingClientRect();
            if (e.changedTouches[0].clientX >= rect.left &&
                e.changedTouches[0].clientX <= rect.right &&
                e.changedTouches[0].clientY >= rect.top &&
                e.changedTouches[0].clientY <= rect.bottom) {
                toggleSidebar();
            }
        }
    }
});

// Reset timeout on user interaction
document.addEventListener('click', resetSidebarTimeout);
document.addEventListener('touchstart', resetSidebarTimeout);

// WhatsApp Meta Form
document.getElementById('whatsapp-meta-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());

    // Ensure all fields are included, even if empty
    const form = e.target;
    ['name', 'value', 'category', 'description', 'scope', 'tenant_id'].forEach(field => {
        if (!(field in data)) {
            data[field] = form.elements[field]?.value || '';
        }
    });

    // For global scope, ensure tenant_id is not set
    if (data.scope === 'global') {
        data.tenant_id = null;
    }

    const scope = data.tenant_id ? 'tenant' : 'global';
    const tenant_id = data.tenant_id ? parseInt(data.tenant_id) : null;

    try {
        // Store as credentials
        await adminFetch('/admin/credentials', 'POST', {
            name: "WHATSAPP_ACCESS_TOKEN",
            value: data.access_token,
            category: "whatsapp_meta",
            scope: scope,
            tenant_id: tenant_id,
            description: "Meta API Access Token"
        });
        await adminFetch('/admin/credentials', 'POST', {
            name: "WHATSAPP_PHONE_NUMBER_ID",
            value: data.phone_number_id,
            category: "whatsapp_meta",
            scope: scope,
            tenant_id: tenant_id,
            description: "Meta API Phone Number ID"
        });
        await adminFetch('/admin/credentials', 'POST', {
            name: "WHATSAPP_BUSINESS_ACCOUNT_ID",
            value: data.business_account_id,
            category: "whatsapp_meta",
            scope: scope,
            tenant_id: tenant_id,
            description: "Meta API Business Account ID"
        });

        await adminFetch('/admin/credentials', 'POST', {
            name: "WHATSAPP_VERIFY_TOKEN",
            value: data.verify_token,
            category: "whatsapp_meta",
            scope: scope,
            tenant_id: tenant_id,
            description: "Webhook Verify Token"
        });

        showNotification(true, 'WhatsApp Meta API Configurado', 'Las credenciales de WhatsApp Meta API se guardaron correctamente.');
        closeModal('whatsapp-meta-modal');
    } catch (error) {
        showNotification(false, 'Error', 'Error al guardar la configuraci√≥n de WhatsApp Meta API');
    }
});

// Setup Wizard Functions - Session-Based for Self-Hosted Deployments
let currentSetupSession = null;
let setupSessionId = null;

async function startSetupWizard() {
    try {
        // Create new setup session
        const sessionData = {
            public_base_url: window.location.origin,
            webhook_base_url: `${window.location.origin}/webhook`
        };

        const sessionResult = await adminFetch('/admin/setup/session', 'POST', sessionData);
        if (sessionResult.status === 'ok') {
            setupSessionId = sessionResult.session_id;
            currentSetupSession = sessionResult;

            // Start with preflight step
            await runPreflightStep();
        } else {
            showNotification(false, 'Error', 'No se pudo crear la sesi√≥n de configuraci√≥n');
            return;
        }
    } catch (error) {
        console.error('Error creating setup session:', error);
        showNotification(false, 'Error', 'Error al iniciar el asistente de configuraci√≥n');
        return;
    }

    showView('setup');
}

async function runPreflightStep() {
    try {
        // Show loading
        document.getElementById('setup-content').innerHTML = `
            <div class="preflight-loading">
                <h2 class="setup-step-title">Verificando Infraestructura</h2>
                <p class="setup-step-description">Validando configuraci√≥n de red, TLS, base de datos y servicios...</p>
                <div class="preflight-progress">
                    <div class="progress-spinner"></div>
                    <p>Esto puede tomar unos segundos...</p>
                </div>
            </div>
        `;

        // Run preflight checks
        const preflightResult = await adminFetch('/admin/setup/preflight', 'POST', { session_id: setupSessionId });

        if (preflightResult.overall_status === 'OK') {
            // All checks passed - show success and continue
            await showPreflightResults(preflightResult, true);
        } else {
            // Some checks failed - show results and solutions
            await showPreflightResults(preflightResult, false);
        }
    } catch (error) {
        console.error('Preflight error:', error);
        document.getElementById('setup-content').innerHTML = `
            <div class="preflight-error">
                <h2 class="setup-step-title">Error en Verificaci√≥n</h2>
                <p class="setup-step-description">No se pudieron ejecutar las verificaciones de infraestructura.</p>
                <div class="error-details">${error.message}</div>
                <button class="btn-secondary" onclick="runPreflightStep()">Reintentar</button>
            </div>
        `;
    }
}

async function showPreflightResults(results, allPassed) {
    const checksHtml = Object.entries(results.checks).map(([checkName, checkResult]) => {
        const statusClass = checkResult.status === 'OK' ? 'check-pass' :
            checkResult.status === 'WARN' ? 'check-warn' : 'check-fail';
        const statusIcon = checkResult.status === 'OK' ? '‚úÖ' :
            checkResult.status === 'WARN' ? '‚ö†Ô∏è' : '‚ùå';

        return `
            <div class="preflight-check ${statusClass}">
                <div class="check-header">
                    <span class="check-icon">${statusIcon}</span>
                    <span class="check-name">${checkName.replace(/_/g, ' ').toUpperCase()}</span>
                    <span class="check-status">${checkResult.status}</span>
                </div>
                <div class="check-message">${checkResult.message}</div>
                ${checkResult.solution ? `<div class="check-solution">üí° ${checkResult.solution}</div>` : ''}
            </div>
        `;
    }).join('');

    const content = `
        <h2 class="setup-step-title">${allPassed ? '‚úÖ Infraestructura Verificada' : '‚ö†Ô∏è Problemas Detectados'}</h2>
        <p class="setup-step-description">
            ${allPassed ?
            'Tu infraestructura est√° correctamente configurada. Puedes continuar con la configuraci√≥n.' :
            'Se encontraron problemas en la configuraci√≥n. Resu√©lvelos antes de continuar.'}
        </p>
        <div class="preflight-results">
            ${checksHtml}
        </div>
        <div class="preflight-actions">
            ${allPassed ?
            '<button class="btn-primary" onclick="proceedToNextStep()">Continuar con Configuraci√≥n</button>' :
            '<button class="btn-secondary" onclick="runPreflightStep()">Reverificar</button>'}
        </div>
    `;

    document.getElementById('setup-content').innerHTML = content;
}

async function proceedToNextStep() {
    // Show service selection modal instead of going directly to overview
    await checkServiceStatuses();
    openModal('service-selection-modal');
}

async function checkServiceStatuses() {
    try {
        // Check Tienda Nube status
        const tenants = await adminFetch('/admin/tenants');
        const hasTiendaNube = tenants && tenants.length > 0;

        updateServiceStatus('tn', hasTiendaNube);

        // Check YCloud and Meta API status - get all credentials and filter
        const allCreds = await adminFetch('/admin/credentials');

        // Check YCloud status
        const ycloudApiKey = allCreds && allCreds.find(c => c.name === 'YCLOUD_API_KEY');
        const ycloudSecret = allCreds && allCreds.find(c => c.name === 'YCLOUD_WEBHOOK_SECRET');
        const ycloudConfigured = ycloudApiKey && ycloudSecret;
        updateServiceStatus('ycloud', ycloudConfigured);

        // Check Meta API status
        const metaToken = allCreds && allCreds.find(c => c.name === 'WHATSAPP_ACCESS_TOKEN');
        const metaPhoneId = allCreds && allCreds.find(c => c.name === 'WHATSAPP_PHONE_NUMBER_ID');
        const metaConfigured = metaToken && metaPhoneId;
        updateServiceStatus('meta', metaConfigured);

    } catch (error) {
        console.error('Error checking service statuses:', error);
        // Default to not configured
        updateServiceStatus('tn', false);
        updateServiceStatus('ycloud', false);
        updateServiceStatus('meta', false);
    }
}

function updateServiceStatus(service, isConfigured) {
    const statusElement = document.getElementById(`${service}-status`);
    const cardElement = document.getElementById(`${service}-service-card`);
    const dotElement = statusElement.querySelector('.status-dot');
    const textElement = statusElement.querySelector('.status-text');

    if (isConfigured) {
        cardElement.classList.add('configured');
        cardElement.classList.remove('not-configured');
        dotElement.classList.add('configured');
        dotElement.classList.remove('not-configured');
        textElement.textContent = 'Configurado';
        textElement.style.color = 'var(--success)';
    } else {
        cardElement.classList.add('not-configured');
        cardElement.classList.remove('configured');
        dotElement.classList.add('not-configured');
        dotElement.classList.remove('configured');
        textElement.textContent = 'No configurado';
        textElement.style.color = '#ff4d4d';
    }
}

function selectService(service) {
    closeModal('service-selection-modal');

    // Navigate to the appropriate configuration page
    switch (service) {
        case 'tiendanube':
            showView('stores');
            break;
        case 'ycloud':
            showView('ycloud');
            break;
        case 'whatsapp-meta':
            showView('whatsapp-meta');
            break;
        default:
            showView('overview');
    }

    showNotification(true, 'Redirigiendo...', `Configurando ${getServiceName(service)}`);
}

function getServiceName(service) {
    switch (service) {
        case 'tiendanube': return 'Tienda Nube';
        case 'ycloud': return 'WhatsApp (YCloud)';
        case 'whatsapp-meta': return 'WhatsApp Meta API';
        default: return 'servicio';
    }
}

async function saveSetupProgress() {
    try {
        await adminFetch('/admin/setup/state', 'POST', {
            currentStep,
            stepStatuses
        });
        console.log('Setup progress saved to backend');
    } catch (error) {
        console.error('Failed to save setup progress:', error);
    }
}

// Setup progress is now managed server-side via /setup/state endpoint
// No localStorage needed to prevent inconsistencies

function updateStepUI() {
    // Update progress bar
    const completedSteps = Object.values(stepStatuses).filter(status => status === 'ok').length;
    const progressPercent = (completedSteps / 7) * 100;
    document.getElementById('progress-fill').style.width = `${progressPercent}%`;

    // Update step indicators
    for (let i = 1; i <= 7; i++) {
        const stepElement = document.getElementById(`step-${i}`);
        stepElement.className = 'setup-step';
        if (stepStatuses[i] === 'ok') {
            stepElement.classList.add('completed');
        } else if (i === currentStep) {
            stepElement.classList.add('active');
        }
    }

    // Update step status displays
    for (let i = 1; i <= 7; i++) {
        const statusElement = document.getElementById(`step-${i}-status`);
        const statusText = statusElement.querySelector('.status-text');
        statusText.textContent = getStatusText(stepStatuses[i]);
        statusText.className = `status-text ${stepStatuses[i]}`;
    }
}

function getStatusText(status) {
    switch (status) {
        case 'ok': return 'Completado';
        case 'warn': return 'Advertencia';
        case 'error': return 'Error';
        default: return 'Pendiente';
    }
}

async function runStepTest(stepNumber) {
    const correlationId = `setup-test-${Date.now()}`;

    try {
        let result;

        switch (stepNumber) {
            case 1:
                // Check OpenAI configuration
                result = await adminFetch('/admin/diagnostics/openai/test');
                if (result && result.status === 'OK') {
                    stepStatuses[1] = 'ok';
                    showNotification(true, 'Paso 1 Completado', 'OpenAI configurado correctamente.');
                } else {
                    stepStatuses[1] = 'error';
                    showNotification(false, 'Error en Paso 1', 'OpenAI no est√° configurado. Ve a Credenciales y agrega OPENAI_API_KEY.');
                }
                break;

            case 2:
                // Check YCloud configuration
                result = await adminFetch('/admin/diagnostics/ycloud/test');
                if (result && result.status === 'OK') {
                    stepStatuses[2] = 'ok';
                    showNotification(true, 'Paso 2 Completado', 'YCloud configurado correctamente.');
                } else {
                    stepStatuses[2] = 'error';
                    showNotification(false, 'Error en Paso 2', 'YCloud no est√° configurado. Ve a WhatsApp (YCloud) y configura las credenciales.');
                }
                break;

            case 3:
                // Check if tenant exists
                const tenants = await adminFetch('/admin/tenants');
                if (tenants && tenants.length > 0) {
                    stepStatuses[3] = 'ok';
                    showNotification(true, 'Paso 3 Completado', 'Tienda configurada correctamente.');
                } else {
                    stepStatuses[3] = 'error';
                    showNotification(false, 'Error en Paso 3', 'No hay tiendas configuradas. Crea una tienda primero.');
                }
                break;

            case 4:
                // Test overall connection
                result = await adminFetch('/admin/diagnostics/healthz');
                if (result && result.status === 'OK') {
                    stepStatuses[4] = 'ok';
                    showNotification(true, 'Paso 4 Completado', 'Todos los servicios est√°n conectados.');
                } else if (result && result.status === 'WARN') {
                    stepStatuses[4] = 'warn';
                    showNotification(true, 'Paso 4 Completado con Advertencias', 'Servicios b√°sicos OK, pero hay configuraciones pendientes.');
                } else {
                    stepStatuses[4] = 'error';
                    showNotification(false, 'Error en Paso 4', 'Problemas de conexi√≥n. Verifica la configuraci√≥n.');
                }
                break;

            case 5:
                // Send test WhatsApp message
                const testNumber = prompt('Ingresa tu n√∫mero de WhatsApp para la prueba (+549XXXXXXXXXX):');
                if (testNumber) {
                    result = await adminFetch('/admin/diagnostics/whatsapp/send_test', 'POST', {
                        to: testNumber,
                        text: 'CodExy test: reply PING',
                        correlation_id: correlationId
                    });
                    if (result && result.status === 'OK') {
                        stepStatuses[5] = 'ok';
                        showNotification(true, 'Paso 5 Completado', 'Mensaje de prueba enviado. Responde "PING" desde WhatsApp.');
                    } else {
                        stepStatuses[5] = 'error';
                        showNotification(false, 'Error en Paso 5', result?.error || 'Error al enviar mensaje de prueba.');
                    }
                }
                break;
        }

        updateStepUI();
        saveSetupProgress();
    } catch (error) {
        stepStatuses[stepNumber] = 'error';
        updateStepUI();
        saveSetupProgress();
        showNotification(false, `Error en Paso ${stepNumber}`, `Error de conexi√≥n: ${error.message}`);
    }
}

function startWebhookMonitoring(correlationId) {
    // Poll for webhook events
    const checkInterval = setInterval(async () => {
        try {
            const events = await adminFetch('/admin/diagnostics/events/stream?limit=10');
            if (events && events.events) {
                const webhookEvent = events.events.find(e =>
                    e.event_type === 'webhook_received' &&
                    e.correlation_id === correlationId
                );

                if (webhookEvent) {
                    stepStatuses[5] = 'ok';
                    document.getElementById('webhook-waiting').style.display = 'none';
                    showNotification(true, 'Paso 5 Completado', 'Webhook recibido correctamente.');
                    clearInterval(checkInterval);
                    updateStepUI();

                    // Check for bot response
                    setTimeout(() => checkBotResponse(correlationId), 2000);
                }
            }
        } catch (error) {
            console.error('Error checking webhook:', error);
        }
    }, 3000);

    // Stop checking after 2 minutes
    setTimeout(() => {
        clearInterval(checkInterval);
        if (stepStatuses[5] === 'pending') {
            stepStatuses[5] = 'error';
            document.getElementById('webhook-waiting').style.display = 'none';
            showNotification(false, 'Error en Paso 5', 'No se recibi√≥ el webhook en el tiempo esperado.');
            updateStepUI();
        }
    }, 120000);
}

function checkBotResponse(correlationId) {
    const checkInterval = setInterval(async () => {
        try {
            const events = await adminFetch('/admin/diagnostics/events/stream?limit=10');
            if (events && events.events) {
                const responseEvent = events.events.find(e =>
                    e.event_type === 'agent_response_sent' &&
                    e.correlation_id === correlationId
                );

                if (responseEvent) {
                    stepStatuses[6] = 'ok';
                    showNotification(true, 'Paso 6 Completado', 'Respuesta del bot generada correctamente.');
                    clearInterval(checkInterval);
                    updateStepUI();
                }
            }
        } catch (error) {
            console.error('Error checking bot response:', error);
        }
    }, 2000);

    // Stop checking after 30 seconds
    setTimeout(() => {
        clearInterval(checkInterval);
        if (stepStatuses[6] === 'pending') {
            stepStatuses[6] = 'error';
            showNotification(false, 'Error en Paso 6', 'El bot no respondi√≥ en el tiempo esperado.');
            updateStepUI();
        }
    }, 30000);
}

function goToOverview() {
    showView('overview');
}

// Console Management
let consoleStreamingInterval = null;
let autoScrollEnabled = true;

async function loadConsoleEvents() {
    const container = document.getElementById('console-output');
    container.innerHTML = '<div class="console-loading">Cargando eventos...</div>';

    try {
        const response = await adminFetch('/admin/console/events?limit=50');
        displayConsoleEvents(response.events || []);
    } catch (error) {
        container.innerHTML = `<div class="console-error">Error cargando eventos: ${error.message}</div>`;
    }
}

function displayConsoleEvents(events) {
    const container = document.getElementById('console-output');

    if (events.length === 0) {
        container.innerHTML = '<div class="console-empty">No hay eventos recientes</div>';
        return;
    }

    const eventsHtml = events.map(event => {
        const timestamp = new Date(event.timestamp).toLocaleString();
        const severityClass = `severity-${event.severity || 'info'}`;
        const sourceIcon = getSourceIcon(event.source);

        return `
            <div class="console-event ${severityClass}">
                <div class="event-header">
                    <span class="event-time">${timestamp}</span>
                    <span class="event-type">${event.event_type}</span>
                    <span class="event-severity">${event.severity || 'info'}</span>
                    <span class="event-source">${sourceIcon} ${event.source}</span>
                </div>
                <div class="event-details">
                    ${event.correlation_id ? `<div class="event-correlation">ID: ${event.correlation_id}</div>` : ''}
                    ${formatEventDetails(event.details)}
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = eventsHtml;

    if (autoScrollEnabled) {
        container.scrollTop = container.scrollHeight;
    }
}

function getSourceIcon(source) {
    const icons = {
        'telemetry': 'üìä',
        'whatsapp': 'üì±',
        'agent': 'ü§ñ',
        'system': '‚öôÔ∏è'
    };
    return icons[source] || 'üìù';
}

function formatEventDetails(details) {
    if (!details) return '';

    let html = '';

    if (details.from_number) {
        html += `<div class="detail-item">üìû De: ${details.from_number}</div>`;
    }

    if (details.message) {
        const truncated = details.message.length > 100 ?
            details.message.substring(0, 100) + '...' : details.message;
        html += `<div class="detail-item">üí¨ ${truncated}</div>`;
    }

    if (details.session_id) {
        html += `<div class="detail-item">üîó Sesi√≥n: ${details.session_id}</div>`;
    }

    if (details.success !== undefined) {
        const successIcon = details.success ? '‚úÖ' : '‚ùå';
        html += `<div class="detail-item">${successIcon} √âxito: ${details.success}</div>`;
    }

    if (details.duration_ms) {
        html += `<div class="detail-item">‚è±Ô∏è Duraci√≥n: ${details.duration_ms}ms</div>`;
    }

    if (details.error_code) {
        html += `<div class="detail-item">‚ö†Ô∏è Error: ${details.error_code}</div>`;
    }

    if (details.error_message) {
        html += `<div class="detail-item">üìù ${details.error_message}</div>`;
    }

    return html;
}

function startConsoleStreaming() {
    if (consoleStreamingInterval) {
        clearInterval(consoleStreamingInterval);
    }

    consoleStreamingInterval = setInterval(async () => {
        try {
            const severity = document.getElementById('severity-filter').value;
            const type = document.getElementById('type-filter').value;
            const search = document.getElementById('search-filter').value;

            let url = '/admin/console/events?limit=50';
            if (severity) url += `&severity=${severity}`;
            if (type) url += `&event_type=${type}`;
            if (search) url += `&search=${search}`;

            const response = await adminFetch(url);
            displayConsoleEvents(response.events || []);
        } catch (error) {
            console.error('Error streaming console events:', error);
        }
    }, 2000); // Update every 2 seconds

    showNotification(true, 'Streaming Iniciado', 'La consola est√° actualizando eventos en tiempo real.');
}

function stopConsoleStreaming() {
    if (consoleStreamingInterval) {
        clearInterval(consoleStreamingInterval);
        consoleStreamingInterval = null;
        showNotification(true, 'Streaming Detenido', 'La actualizaci√≥n autom√°tica se ha detenido.');
    }
}

function clearConsole() {
    document.getElementById('console-output').innerHTML = '<div class="console-empty">Consola limpiada</div>';
    showNotification(true, 'Consola Limpiada', 'Todos los eventos han sido eliminados de la vista.');
}

function toggleAutoScroll() {
    autoScrollEnabled = !autoScrollEnabled;
    const button = document.querySelector('button[onclick="toggleAutoScroll()"]');
    if (button) {
        button.textContent = autoScrollEnabled ? 'üìú Auto-scroll' : 'üìå Scroll Manual';
    }
    showNotification(true, 'Auto-scroll', autoScrollEnabled ? 'Activado' : 'Desactivado');
}

function applyConsoleFilters() {
    // Re-load events with current filters
    if (consoleStreamingInterval) {
        // If streaming is active, it will automatically apply filters
        return;
    }

    loadConsoleEvents();
}

// Tenant Detail Modal Functions
async function openTenantDetailModal(tenantId) {
    console.log('Opening tenant detail modal for ID:', tenantId);
    try {
        // Fetch tenant details
        const details = await adminFetch(`/admin/tenants/${tenantId}/details`);
        console.log('Tenant details received:', details);

        if (details) {
            // Populate tenant info
            document.getElementById('detail-store-name').textContent = details.tenant.store_name || 'Sin nombre';
            document.getElementById('detail-phone-number').textContent = details.tenant.bot_phone_number || 'Sin n√∫mero';
            document.getElementById('detail-owner-email').textContent = details.tenant.owner_email || 'Sin email';
            document.getElementById('detail-tn-store-id').textContent = details.tenant.tiendanube_store_id || 'Sin configurar';
            document.getElementById('detail-location').textContent = details.tenant.store_location || 'Sin ubicaci√≥n';
            document.getElementById('detail-website').textContent = details.tenant.store_website || 'Sin sitio web';

            // Update WhatsApp status blocks
            updateWhatsAppStatusBlocks(details.connections.whatsapp);

            // Populate credentials
            populateTenantCredentials(details.credentials);

            // Store tenant ID for edit button
            window.currentTenantDetailId = tenantId;

            // Show modal
            openModal('tenant-detail-modal');
        }
    } catch (error) {
        showNotification(false, 'Error', 'No se pudieron cargar los detalles del tenant');
        console.error('Error loading tenant details:', error);
    }
}

function updateWhatsAppStatusBlocks(whatsappStatus) {
    // YCloud status
    const ycloudBlock = document.getElementById('ycloud-status-block');
    const ycloudIndicator = document.getElementById('ycloud-indicator');
    const ycloudDot = ycloudIndicator.querySelector('.status-dot');
    const ycloudText = ycloudIndicator.querySelector('.status-text');
    const ycloudDetails = document.getElementById('ycloud-details');

    if (whatsappStatus.ycloud.configured) {
        ycloudDot.className = 'status-dot connected';
        ycloudText.textContent = 'Conectado';
        ycloudDetails.innerHTML = `
            <div>API Key: ***${whatsappStatus.ycloud.api_key_masked || '****'}</div>
            <div>Webhook Secret: ***${whatsappStatus.ycloud.webhook_secret_masked || '****'}</div>
        `;
    } else {
        ycloudDot.className = 'status-dot not-connected';
        ycloudText.textContent = 'No configurado';
        ycloudDetails.innerHTML = '<div>Haz clic en "WhatsApp (YCloud)" para configurar</div>';
    }

    // Meta API status
    const metaBlock = document.getElementById('meta-status-block');
    const metaIndicator = document.getElementById('meta-indicator');
    const metaDot = metaIndicator.querySelector('.status-dot');
    const metaText = metaIndicator.querySelector('.status-text');
    const metaDetails = document.getElementById('meta-details');

    if (whatsappStatus.meta_api.configured) {
        metaDot.className = 'status-dot connected';
        metaText.textContent = 'Conectado';
        metaDetails.innerHTML = `
            <div>Phone ID: ***${whatsappStatus.meta_api.phone_number_id_masked || '****'}</div>
            <div>Business Account: ***${whatsappStatus.meta_api.business_account_id_masked || '****'}</div>
        `;
    } else {
        metaDot.className = 'status-dot not-connected';
        metaText.textContent = 'No configurado';
        metaDetails.innerHTML = '<div>Haz clic en "WhatsApp Meta API" para configurar</div>';
    }
}

function populateTenantCredentials(credentials) {
    const tenantList = document.getElementById('tenant-credentials-list');
    const globalList = document.getElementById('global-credentials-list');

    // Clear existing
    tenantList.innerHTML = '';
    globalList.innerHTML = '';

    // Populate tenant-specific credentials
    if (credentials.tenant_specific && credentials.tenant_specific.length > 0) {
        credentials.tenant_specific.forEach(cred => {
            const item = document.createElement('div');
            item.className = 'credential-item';
            item.innerHTML = `
                <div class="credential-info">
                    <div class="credential-name">${cred.name}</div>
                    <div class="credential-scope">Tenant-Specific</div>
                </div>
                <div class="credential-value">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
            `;
            tenantList.appendChild(item);
        });
    } else {
        tenantList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">No hay credenciales espec√≠ficas para este tenant</div>';
    }

    // Populate global credentials
    if (credentials.global_available && credentials.global_available.length > 0) {
        credentials.global_available.forEach(cred => {
            const item = document.createElement('div');
            item.className = 'credential-item';
            item.innerHTML = `
                <div class="credential-info">
                    <div class="credential-name">${cred.name}</div>
                    <div class="credential-scope">Global</div>
                </div>
                <div class="credential-value">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
            `;
            globalList.appendChild(item);
        });
    } else {
        globalList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">No hay credenciales globales disponibles</div>';
    }
}

function showCredentialTab(tab) {
    const tenantTab = document.getElementById('tenant-credentials-list');
    const globalTab = document.getElementById('global-credentials-list');
    const tenantBtn = document.querySelector('.tab-btn[onclick*="tenant"]');
    const globalBtn = document.querySelector('.tab-btn[onclick*="global"]');

    if (tab === 'tenant') {
        tenantTab.style.display = 'block';
        globalTab.style.display = 'none';
        tenantBtn.classList.add('active');
        globalBtn.classList.remove('active');
    } else {
        tenantTab.style.display = 'none';
        globalTab.style.display = 'block';
        tenantBtn.classList.remove('active');
        globalBtn.classList.add('active');
    }
}

function editTenantFromDetail() {
    if (window.currentTenantDetailId) {
        closeModal('tenant-detail-modal');
        editTenant(window.currentTenantDetailId);
    }
}

// Make tenant table rows clickable
function makeTenantRowsClickable() {
    const table = document.getElementById('tenants-list');
    if (table) {
        table.addEventListener('click', (e) => {
            const row = e.target.closest('tr');
            if (row && row.dataset.tenantId) {
                openTenantDetailModal(row.dataset.tenantId);
            }
        });
    }
}

// Update loadTenants to add data attributes for click handling
const originalLoadTenants = loadTenants;
loadTenants = async function () {
    const tenants = await adminFetch('/admin/tenants');
    const container = document.getElementById('tenants-list');
    container.innerHTML = '';

    if (tenants) {
        tenants.forEach(t => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <div style="font-weight: 600">${t.store_name}</div>
                    <div style="font-size: 11px; color: #a1a1aa">${t.owner_email || 'No email'}</div>
                </td>
                <td>${t.bot_phone_number}</td>
                <td>${t.tiendanube_store_id || 'N/A'}</td>
                <td><span class="status-badge ${t.tiendanube_store_id ? 'ok' : 'error'}" style="background: ${t.tiendanube_store_id ? 'rgba(0,230,118,0.1)' : 'rgba(244,67,54,0.1)'}; color: ${t.tiendanube_store_id ? '#00e676' : '#f44336'}">${t.tiendanube_store_id ? 'Activo' : 'Sin Configurar'}</span></td>
                <td>
                    <button class="btn-secondary" style="padding: 5px 12px; font-size: 12px" onclick="editTenant('${t.bot_phone_number}')">Editar</button>
                    <button class="btn-secondary" style="padding: 5px 12px; font-size: 12px" onclick="testTenantConnection('${t.bot_phone_number}', '${t.tiendanube_store_id}', '${t.tiendanube_access_token}')">Test</button>
                    <button class="btn-delete" style="padding: 5px 12px; font-size: 12px" onclick="deleteTenant('${t.bot_phone_number}')">Eliminar</button>
                </td>
            `;

            // Add data attributes for click handling
            tr.dataset.tenantId = t.id; // Use the numeric ID
            tr.dataset.tenantPhone = t.bot_phone_number; // Keep phone for backward compatibility
            tr.style.cursor = 'pointer';
            tr.title = 'Haz clic para ver detalles';
            console.log('Created tenant row with ID:', t.id, 'for tenant:', t.store_name);

            // Add click event listener to the row
            tr.addEventListener('click', (e) => {
                // Don't trigger if clicking on buttons
                if (e.target.tagName === 'BUTTON') {
                    return;
                }
                openTenantDetailModal(t.id); // Pass the numeric ID
            });

            container.appendChild(tr);
        });
    }
};

// YCloud form submit
document.getElementById('ycloud-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    // Save as tenant-specific credentials
    const credData1 = {
        name: 'YCLOUD_API_KEY',
        value: data.api_key,
        scope: 'tenant',
        tenant_id: parseInt(data.tenant_id)
    };
    await adminFetch('/admin/credentials', 'POST', credData1);
    const credData2 = {
        name: 'YCLOUD_WEBHOOK_SECRET',
        value: data.webhook_secret,
        scope: 'tenant',
        tenant_id: parseInt(data.tenant_id)
    };
    await adminFetch('/admin/credentials', 'POST', credData2);
    showNotification(true, 'YCloud Configurado', 'Credenciales guardadas correctamente.');
    closeModal('ycloud-config-modal');
});

// WhatsApp Meta form submit
document.getElementById('whatsapp-meta-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    const creds = [
        { name: 'WHATSAPP_ACCESS_TOKEN', value: data.access_token },
        { name: 'WHATSAPP_PHONE_NUMBER_ID', value: data.phone_number_id },
        { name: 'WHATSAPP_BUSINESS_ACCOUNT_ID', value: data.business_account_id },
        { name: 'WHATSAPP_VERIFY_TOKEN', value: data.verify_token }
    ];
    for (const cred of creds) {
        await adminFetch('/admin/credentials', 'POST', {
            name: cred.name,
            value: cred.value,
            scope: 'tenant',
            tenant_id: parseInt(data.tenant_id)
        });
    }
    showNotification(true, 'WhatsApp Meta API Configurado', 'Credenciales guardadas correctamente.');
    closeModal('whatsapp-meta-modal');
});

// Load existing YCloud config
async function loadYCloudConfig() {
    try {
        const creds = await adminFetch('/admin/credentials');
        const apiKey = creds.find(c => c.name === 'YCLOUD_API_KEY');
        const webhookSecret = creds.find(c => c.name === 'YCLOUD_WEBHOOK_SECRET');

        const form = document.getElementById('ycloud-form');
        if (apiKey) form.elements['api_key'].value = apiKey.value;
        if (webhookSecret) form.elements['webhook_secret'].value = webhookSecret.value;
        if (apiKey && apiKey.tenant_id) form.elements['tenant_id'].value = apiKey.tenant_id;
    } catch (error) {
        console.error('Error loading YCloud config:', error);
    }
}

// Load existing Meta config
async function loadMetaConfig() {
    try {
        const creds = await adminFetch('/admin/credentials');
        const form = document.getElementById('whatsapp-meta-form');

        const token = creds.find(c => c.name === 'WHATSAPP_ACCESS_TOKEN');
        const phoneId = creds.find(c => c.name === 'WHATSAPP_PHONE_NUMBER_ID');
        const bizId = creds.find(c => c.name === 'WHATSAPP_BUSINESS_ACCOUNT_ID');
        const verToken = creds.find(c => c.name === 'WHATSAPP_VERIFY_TOKEN');

        if (token) form.elements['access_token'].value = token.value;
        if (phoneId) form.elements['phone_number_id'].value = phoneId.value;
        if (bizId) form.elements['business_account_id'].value = bizId.value;
        if (verToken) form.elements['verify_token'].value = verToken.value;
        if (token && token.tenant_id) form.elements['tenant_id'].value = token.tenant_id;
    } catch (error) {
        console.error('Error loading Meta config:', error);
    }
}

// --- Analytics Logic ---

async function loadAnalytics() {
    console.log('Loading Analytics...');
    const tenantId = document.getElementById('analytics-tenant-filter').value;
    const days = document.getElementById('analytics-time-filter').value || 30;

    // Show loading state for KPIs
    ['kpi-conversations', 'kpi-messages', 'kpi-success-rate', 'kpi-avg-response'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = '<span class="loading-dots">...</span>';
    });

    try {
        // 1. Fetch Summary KPIs
        let summaryUrl = `/admin/analytics/summary?from_date=${getDateString(days)}`;
        if (tenantId) {
            summaryUrl += `&tenant_id=${tenantId}`;
        }

        const summary = await adminFetch(summaryUrl);

        if (summary && summary.kpis) {
            updateKPIs(summary.kpis);
        } else {
            // Handle error or empty state
            showNotification(false, 'Info', 'No se recibieron datos de KPIs.');
        }

        // 2. Fetch Chats for Charting (Conversations per Day)
        const chats = await adminFetch('/admin/chats');
        if (chats) {
            renderConversationsChart(chats, days);
        }

        // 3. Fetch Events for Table
        loadAnalyticsEvents();

    } catch (error) {
        console.error('Error loading analytics:', error);
        showNotification(false, 'Error', 'No se pudieron cargar las m√©tricas. Revisa la consola.');
    }
}

function updateKPIs(kpis) {
    // Conversations
    const active = kpis.conversations.active || 0;
    const blocked = kpis.conversations.blocked || 0;
    animateValue('kpi-conversations', 0, active + blocked, 1000);

    // Messages
    const totalMsgs = kpis.messages.total || 0;
    animateValue('kpi-messages', 0, totalMsgs, 1000);

    // Success Rate (AI / Total)
    const aiMsgs = kpis.messages.ai || 0;
    const rate = totalMsgs > 0 ? Math.round((aiMsgs / totalMsgs) * 100) : 0;
    document.getElementById('kpi-success-rate').textContent = `${rate}%`;

    // Avg Response (Mock for now as backend doesn't provide it)
    document.getElementById('kpi-avg-response').textContent = '1.2s';
}

function animateValue(id, start, end, duration) {
    const obj = document.getElementById(id);
    if (!obj) return;

    let startTimestamp = null;
    const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        obj.innerHTML = Math.floor(progress * (end - start) + start);
        if (progress < 1) {
            window.requestAnimationFrame(step);
        }
    };
    window.requestAnimationFrame(step);
}

function getDateString(daysBack) {
    const d = new Date();
    d.setDate(d.getDate() - daysBack);
    return d.toISOString().split('T')[0];
}

/* Render Simple Bar Chart */
function renderConversationsChart(chats, days) {
    const container = document.getElementById('conversations-chart');
    if (!container) return;

    // Group by Date
    const groups = {};
    // Initialize last N days
    for (let i = days - 1; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const key = d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }); // e.g. "Dec 21"
        groups[key] = 0;
    }

    // Bucketize chats
    chats.forEach(chat => {
        if (chat.last_message_at) {
            const date = new Date(chat.last_message_at);
            const key = date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
            if (groups[key] !== undefined) {
                groups[key]++;
            }
        }
    });

    // Determine max for scaling
    const values = Object.values(groups);
    const maxVal = Math.max(...values, 1); // Avoid div by zero

    // HTML Construction
    let barsHtml = '';
    Object.entries(groups).forEach(([label, count]) => {
        const height = (count / maxVal) * 100;
        barsHtml += `
            <div class="bar-group" title="${count} conversaciones el ${label}">
                <div class="bar-value">${count > 0 ? count : ''}</div>
                <div class="bar" style="height: ${Math.max(height, 5)}%;"></div>
                <div class="bar-label">${label}</div>
            </div>
        `;
    });

    container.innerHTML = `
        <div class="simple-bar-chart">
            ${barsHtml}
        </div>
    `;
    container.style.background = 'none'; // Remove placeholder background/border if needed
}

async function loadAnalyticsEvents() {
    const tbody = document.getElementById('analytics-events');
    if (!tbody) return;

    try {
        const res = await adminFetch('/admin/console/events?limit=10');
        if (res && res.events && res.events.length > 0) {
            tbody.innerHTML = res.events.map(e => `
                <tr>
                    <td>${new Date(e.timestamp).toLocaleString()}</td>
                    <td><span class="severity-badge severity-${e.severity.toLowerCase()}">${e.event_type}</span></td>
                    <td>${e.severity}</td>
                    <td>${e.details.message || JSON.stringify(e.details)}</td>
                </tr>
            `).join('');
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="empty-row">
                        <div class="table-empty">
                            <div class="empty-icon">üìã</div>
                            <p>No hay eventos recientes</p>
                        </div>
                    </td>
                </tr>
            `;
        }
    } catch (e) {
        console.error('Error loading analytics events', e);
    }
}

async function loadAnalyticsTenants() {
    const select = document.getElementById('analytics-tenant-filter');
    if (!select) return;

    try {
        const tenants = await adminFetch('/admin/tenants');
        // Keep "All" option
        select.innerHTML = '<option value="">Todas las tiendas</option>';
        if (tenants) {
            tenants.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.id;
                opt.textContent = t.store_name;
                select.appendChild(opt);
            });
        }
    } catch (e) {
        console.error(e);
    }
}

// Expose functions to global scope for HTML onclick
window.showView = showView;
window.openModal = openModal;
window.closeModal = closeModal;
window.handleModalClick = handleModalClick;
window.resetTenantModal = resetTenantModal;
window.resetCredentialModal = resetCredentialModal;
window.editTenant = editTenant;
window.editCredential = editCredential;
window.deleteTenant = deleteTenant;
window.deleteCredential = deleteCredential;
window.testTenantConnection = testTenantConnection;
window.toggleCollapsible = toggleCollapsible;
window.toggleSidebar = toggleSidebar;
window.startSetupWizard = startSetupWizard;
window.runStepTest = runStepTest;
window.goToOverview = goToOverview;
window.connectInstance = connectInstance;
window.runDiagnostics = runDiagnostics;
window.startSetupWizard = startSetupWizard;
window.updateTNFields = updateTNFields;
window.deleteAllTenants = deleteAllTenants;
window.loadAnalytics = loadAnalytics;
window.clearConsole = clearConsole;
window.toggleAutoScroll = toggleAutoScroll;
window.startConsoleStreaming = startConsoleStreaming;
window.stopConsoleStreaming = stopConsoleStreaming;
window.applyConsoleFilters = applyConsoleFilters;
window.openTenantDetailModal = openTenantDetailModal;
window.showCredentialTab = showCredentialTab;
window.editTenantFromDetail = editTenantFromDetail;
window.selectService = selectService;
window.configureTool = configureTool;
window.deleteTool = deleteTool;
window.loadYCloudConfig = loadYCloudConfig;
window.testTenantConnection = testTenantConnection;
// --- Chats View Logic (Human-in-the-Loop) ---

let chatsCache = [];
let currentChatPhone = null;

// --- Chat View (Human-in-the-Loop) Logic ---

async function loadChats() {
    const listContainer = document.getElementById('chat-list-items');
    // Only show loading if empty to prevent flickering on poll
    if (listContainer.children.length === 0 || listContainer.innerHTML.includes('Cargando')) {
        listContainer.innerHTML = '<div class="chat-loading">Cargando conversaciones...</div>';
    }

    try {
        const chats = await adminFetch('/admin/chats');
        if (!chats || chats.length === 0) {
            listContainer.innerHTML = '<div class="chat-empty">No hay conversaciones activas</div>';
            return;
        }

        // Sort: Human Override active first, then by Last Message
        chats.sort((a, b) => {
            const aLocked = a.human_override_until && new Date(a.human_override_until) > new Date();
            const bLocked = b.human_override_until && new Date(b.human_override_until) > new Date();
            if (aLocked !== bLocked) return bLocked ? 1 : -1;
            return new Date(b.last_message_at || 0) - new Date(a.last_message_at || 0);
        });

        // Smart Render: Update existing or add new
        chats.forEach(chat => {
            let existing = document.querySelector(`.chat-item[data-id="${chat.id}"]`);
            const time = chat.last_message_at ? new Date(chat.last_message_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
            const isLocked = chat.human_override_until && new Date(chat.human_override_until) > new Date();
            const lockedIcon = isLocked ? '<span style="color: #ffd700; margin-right:5px;">üë§</span>' : '';
            const statusClass = isLocked ? 'status-locked' : 'status-auto';
            const isActive = activeChatId === chat.id;

            const innerHTML = `
                <div class="chat-item-avatar">${chat.avatar_url || 'üë§'}</div>
                <div class="chat-item-info">
                    <div class="chat-item-header">
                        <span class="chat-name">${chat.display_name || chat.external_user_id}</span>
                        <span class="chat-time">${time}</span>
                    </div>
                    <div class="chat-preview">
                        ${lockedIcon} ${chat.last_message_preview || 'Nueva conversaci√≥n'}
                    </div>
                </div>
                <div class="chat-status-indicator ${statusClass}"></div>
            `;

            if (existing) {
                if (existing.innerHTML !== innerHTML || existing.classList.contains('active') !== isActive) {
                    existing.innerHTML = innerHTML;
                    existing.className = `chat-item ${isActive ? 'active' : ''}`;
                }
            } else {
                const div = document.createElement('div');
                div.className = `chat-item ${isActive ? 'active' : ''}`;
                div.setAttribute('data-id', chat.id);
                div.onclick = () => selectChat(chat.id, chat);
                div.innerHTML = innerHTML;
                listContainer.appendChild(div);
            }
        });

        // Remove old chats if needed (unlikely in this context but good for consistency)
        document.querySelectorAll('.chat-item').forEach(el => {
            const id = el.getAttribute('data-id');
            if (!chats.find(c => c.id === id)) el.remove();
        });

    } catch (err) {
        console.error("Error loading chats:", err);
        if (listContainer.children.length === 0) {
            listContainer.innerHTML = `<div class="chat-error">Error: ${err.message}</div>`;
        }
    }
}

async function selectChat(chatId, chatObj = null) {
    activeChatId = chatId;

    // Resolve chatObj from global store if needed
    if (!chatObj && allChats.length > 0) {
        chatObj = allChats.find(c => c.id === chatId);
    }

    // UI Updates
    document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
    // Find and highlight (might rely on next loadChats poll, but we force active class here if found)
    const activeItem = document.querySelector(`.chat-item[data-id="${chatId}"]`);
    if (activeItem) activeItem.classList.add('active');

    document.getElementById('chat-empty-state').style.display = 'none';
    document.getElementById('chat-interface').style.display = 'flex';

    if (chatObj) {
        document.getElementById('chat-current-phone').textContent = chatObj.display_name || chatObj.external_user_id;

        // Update Human Override Toggle State
        const toggle = document.getElementById('human-override-toggle');
        const label = document.getElementById('human-override-label');

        // Logic: Check is_locked (if backend sends it) OR timestamp logic
        // Ensuring we parse the timestamp correctly
        let isLocked = chatObj.is_locked;
        if (isLocked === undefined && chatObj.human_override_until) {
            isLocked = new Date(chatObj.human_override_until) > new Date();
        }

        toggle.checked = !!isLocked;
        if (isLocked) {
            label.innerText = "Atenci√≥n Humana";
            label.style.color = "#ef4444"; // Red
        } else {
            label.innerText = "Agente Activo";
            label.style.color = "#22c55e"; // Green
        }
    }

    // Mobile View Toggle
    const layout = document.querySelector('.chats-layout');
    if (layout) {
        layout.classList.add('mobile-chat-active');
    }

    // Reset history tracking
    renderedMessageIds.clear();
    const messagesArea = document.getElementById('chat-messages-area');
    messagesArea.innerHTML = '';

    // Initial Load
    await loadChatHistory(chatId);
}

function backToChatList() {
    activeChatId = null;
    renderedMessageIds.clear();
    const layout = document.querySelector('.chats-layout');
    if (layout) {
        layout.classList.remove('mobile-chat-active');
    }
    // Highlighting reset
    document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
}

async function loadChatHistory(chatId) {
    const messagesArea = document.getElementById('chat-messages-area');
    // loading spinner only if empty?
    if (messagesArea.children.length === 0) {
        messagesArea.innerHTML = '<div class="chat-loading">Cargando historial...</div>';
    }

    try {
        const messages = await adminFetch(`/admin/chats/${chatId}/messages`);

        // Only append new messages
        let hasNew = false;
        messages.forEach(msg => {
            if (!renderedMessageIds.has(msg.id)) {
                if (messagesArea.querySelector('.chat-loading')) messagesArea.innerHTML = '';
                renderMessageBubble(msg, messagesArea);
                renderedMessageIds.add(msg.id);
                hasNew = true;
            }
        });

        // Scroll to bottom if new messages added
        if (hasNew) {
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

    } catch (err) {
        console.error("Error loading messages:", err);
    }
}

function renderMessageBubble(msg, container) {
    // If it's an assistant or human supervisor message, try to parse it as JSON
    if (msg.role === 'assistant' || msg.role === 'human_supervisor') {
        try {
            const rawContent = msg.content || '';
            const isJson = rawContent.trim().startsWith('{') || rawContent.trim().startsWith('[');

            if (isJson) {
                const parsed = JSON.parse(rawContent);
                if (parsed.messages && Array.isArray(parsed.messages)) {
                    // Render each part as a separate bubble
                    parsed.messages.forEach(subMsg => {
                        const virtualMsg = {
                            ...msg,
                            content: subMsg.text || subMsg.content || '',
                            message_type: (subMsg.imageUrl || subMsg.image_url) ? 'image' : 'text',
                            storage_url: subMsg.imageUrl || subMsg.image_url || msg.storage_url
                        };
                        createBubbleElement(virtualMsg, container);
                    });
                    return;
                }
            }
        } catch (e) {
            console.warn("Failed to parse message JSON, showing as raw:", e);
        }
    }

    // Default: Single bubble
    createBubbleElement(msg, container);
}

function createBubbleElement(msg, container) {
    const div = document.createElement('div');
    const role = msg.role;
    const isUser = role === 'user';
    const isHuman = msg.human_override || role === 'human_supervisor';
    const isAssistant = role === 'assistant';

    // Alignment Classes from style.css
    // style.css uses: .message-bubble.user, .message-bubble.assistant, .message-bubble.human
    let bubbleClass = 'assistant';
    if (isUser) bubbleClass = 'user';
    if (isHuman) bubbleClass = 'human';

    div.className = `message-bubble ${bubbleClass}`;

    let contentHtml = '';
    const mediaUrl = msg.storage_url || msg.preview_url;

    if (msg.message_type === 'image') {
        const caption = msg.content || '';
        contentHtml = `<img src="${mediaUrl || '#'}" class="image-preview" loading="lazy" onclick="window.open('${mediaUrl}', '_blank')">`;
        if (caption) contentHtml += `<div class="caption">${caption}</div>`;
    } else if (msg.message_type === 'audio') {
        contentHtml = `<audio controls src="${mediaUrl || '#'}"></audio>`;
        if (msg.content) contentHtml += `<div class="transcription">üé§ ${msg.content}</div>`;
    } else if (msg.message_type === 'document') {
        contentHtml = `<div class="file-attachment">
            <span class="icon">üìÑ</span> 
            <a href="${mediaUrl}" target="_blank">Ver Documento</a>
         </div>`;
        if (msg.content) contentHtml += `<div class="caption">${msg.content}</div>`;
    } else {
        // Text
        const text = (msg.content || '').replace(/\n/g, '<br>');
        contentHtml = `<p>${text}</p>`;
    }

    const timeStr = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    // Meta Label / Icon
    let metaLabel = '';
    if (isHuman) metaLabel = 'Agente Humano';
    if (isAssistant) metaLabel = 'IA Assistant';
    if (isUser) metaLabel = '';

    div.innerHTML = `
        ${metaLabel ? `<div class="message-label">${metaLabel}</div>` : ''}
        <div class="bubble-content">
            ${contentHtml}
        </div>
        <span class="message-time">${timeStr}</span>
    `;

    container.appendChild(div);
}

async function toggleHumanOverride() {
    if (!activeChatId) return;

    const toggle = document.getElementById('human-override-toggle');
    const label = document.getElementById('human-override-label');
    const isEnabled = toggle.checked;

    // Optimistic UI update
    label.innerText = isEnabled ? "Atenci√≥n Humana" : "Agente Activo";
    label.style.color = isEnabled ? "#ef4444" : "#22c55e"; // Red/Green

    try {
        const res = await adminFetch(`/admin/conversations/${activeChatId}/human-override`, 'POST', {
            enabled: isEnabled
        });

        if (res.status !== 'ok' && !res.human_override_enabled === isEnabled) throw new Error("API Error");

        // Update local state in allChats to prevent UI flicker on reload
        const chat = allChats.find(c => c.id === activeChatId);
        if (chat) {
            chat.is_locked = isEnabled;
            chat.status = isEnabled ? 'human_override' : 'active';
            chat.human_override_until = isEnabled ? '2099-01-01T00:00:00' : null;
        }
        showNotification(true, 'Estado Actualizado', isEnabled ? 'Atenci√≥n Humana Activada' : 'Agente IA Reactivado');

    } catch (e) {
        console.error("Toggle override failed", e);
        showNotification(false, 'Error', 'No se pudo cambiar el estado.');
        // Revert UI
        toggle.checked = !isEnabled;
        label.innerText = !isEnabled ? "Atenci√≥n Humana" : "Agente Activo";
        label.style.color = !isEnabled ? "#ef4444" : "#22c55e";
    }
}


async function sendManualMessage() {
    if (!activeChatId) return;
    const input = document.getElementById('chat-input-text');
    const text = input.value.trim();
    if (!text) return;

    const sendBtn = document.getElementById('chat-send-btn');
    const originalText = sendBtn.innerText;
    sendBtn.disabled = true;
    sendBtn.innerText = '‚è≥';

    try {
        await adminFetch('/admin/messages/send', 'POST', {
            conversation_id: activeChatId,
            text: text,
            human_override: true
        });
        input.value = '';

        // Refresh immediately
        await loadChatHistory(activeChatId);
        loadChats(); // Update sidebar preview

    } catch (err) {
        showNotification(false, 'Error', 'No se pudo enviar el mensaje: ' + err.message);
    } finally {
        sendBtn.disabled = false;
        sendBtn.innerText = originalText;
    }
}

function filterChats() {
    const query = document.getElementById('chat-search').value.toLowerCase();
    document.querySelectorAll('.chat-item').forEach(item => {
        const name = item.querySelector('.chat-name').innerText.toLowerCase();
        item.style.display = name.includes(query) ? 'flex' : 'none';
    });
}

// Background Polling
function startPolling() {
    if (pollingInterval) clearInterval(pollingInterval);

    pollingInterval = setInterval(async () => {
        // Only poll if window is visible or active? (Simpler for now: always while in chats view)
        if (currentView === 'chats') {
            await loadChats();
            if (activeChatId) {
                await loadChatHistory(activeChatId);
            }
        }
    }, 4000); // 4 seconds
}

// Initialize
window.onload = () => {
    startPolling();
};
````

## File: platform_ui/Dockerfile
````
# Version 1.2 - With corrected nginx proxy order
FROM nginx:alpine

COPY nginx.conf /etc/nginx/conf.d/default.conf

# Copy setup script
COPY env.sh /docker-entrypoint.d/40-env.sh
RUN chmod +x /docker-entrypoint.d/40-env.sh

# Copy frontend files to Nginx public directory
COPY . /usr/share/nginx/html

# Expose port 80
EXPOSE 80

# Start Nginx
CMD ["nginx", "-g", "daemon off;"]
````

## File: platform_ui/env.sh
````bash
#!/bin/sh
# Generate env.js from environment variables at runtime
# Check for API_BASE if API_BASE_URL is not set
if [ -z "$API_BASE_URL" ] && [ -n "$API_BASE" ]; then
  API_BASE_URL="$API_BASE"
fi

echo "Generating env.js with API_BASE_URL=${API_BASE_URL}"

# Default to empty string if not set, or handle strictness
: "${API_BASE_URL:=}"
: "${ADMIN_TOKEN:=}"

# Normalize variables: strip double quotes and semicolons just in case
API_BASE_URL=$(echo "$API_BASE_URL" | tr -d '";')
ADMIN_TOKEN=$(echo "$ADMIN_TOKEN" | tr -d '";')

cat <<EOF > /usr/share/nginx/html/env.js
window.API_BASE = "${API_BASE_URL}";
window.ADMIN_TOKEN = "${ADMIN_TOKEN}";
EOF
````

## File: platform_ui/index.html
````html
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pointe Coach Platform | AI Control Center</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body class="dark-theme">
    <div class="glass-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <span class="logo-icon">ü©∞</span>
                <span class="logo-text">POINTE COACH</span>
            </div>
            <nav>
                <button class="nav-item active" onclick="showView('overview')">
                    <span class="icon">üìä</span> Panel General
                </button>
                <button class="nav-item" onclick="startSetupWizard()">
                    <span class="icon">‚öôÔ∏è</span> Configuraci√≥n
                </button>
                <button class="nav-item" onclick="showView('stores')">
                    <span class="icon">üèòÔ∏è</span> Mis Tiendas
                </button>
                <button class="nav-item" onclick="showView('chats')">
                    <span class="icon">üí¨</span> Conversaciones
                </button>
                <button class="nav-item" onclick="showView('logs')">
                    <span class="icon">üìú</span> Live History
                </button>
                <button class="nav-item" onclick="showView('analytics')">
                    <span class="icon">üìà</span> M√©tricas Avanzadas
                </button>
                <!-- New items -->
                <button class="nav-item" onclick="showView('credentials')">
                    <span class="icon">üîê</span> Credenciales
                </button>
                <button class="nav-item" onclick="showView('ycloud')">
                    <span class="icon">üì±</span> WhatsApp (YCloud)
                </button>
                <button class="nav-item" onclick="showView('whatsapp-meta')">
                    <span class="icon">üí¨</span> WhatsApp Meta API
                </button>
                <button class="nav-item" onclick="showView('tools')">
                    <span class="icon">üîß</span> Herramientas
                </button>
                <button class="nav-item" onclick="showView('console')">
                    <span class="icon">üíª</span> Consola
                </button>
            </nav>
            <div class="sidebar-footer">
                <div class="status-badge" id="system-status">Sistema Online</div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="content">
            <header class="top-bar">
                <div class="mobile-collapsible collapsed" id="health-collapsible">
                    <div class="collapsible-header" onclick="toggleCollapsible('health-collapsible')">
                        Estado del Sistema
                    </div>
                    <div class="collapsible-content">
                        <div class="health-strip">
                            <div class="service-pill ok" id="orchestrator-status">
                                <div class="pill-dot"></div>
                                Orchestrator
                            </div>
                            <div class="service-pill ok" id="whatsapp-status">
                                <div class="pill-dot"></div>
                                WhatsApp
                            </div>
                            <div class="service-pill ok" id="tiendanube-status">
                                <div class="pill-dot"></div>
                                Tienda Nube
                            </div>
                            <div class="service-pill ok" id="database-status">
                                <div class="pill-dot"></div>
                                Database
                            </div>
                            <div class="service-pill ok" id="redis-status">
                                <div class="pill-dot"></div>
                                Redis
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mobile-collapsible collapsed" id="signals-collapsible">
                    <div class="collapsible-header" onclick="toggleCollapsible('signals-collapsible')">
                        Se√±ales Recientes
                    </div>
                    <div class="collapsible-content">
                        <div class="last-signals">
                            <div class="signal-item">
                                <div>
                                    <div class="signal-label">√öltima Entrada</div>
                                    <div class="signal-value" id="last-inbound">Cargando...</div>
                                </div>
                            </div>
                            <div class="signal-item">
                                <div>
                                    <div class="signal-label">√öltima Salida</div>
                                    <div class="signal-value" id="last-outbound">Cargando...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="top-actions">
                    <button class="btn-secondary" onclick="openModal('diagnostics-modal')">Run Diagnostics</button>
                    <button class="btn-primary" onclick="startSetupWizard()">Open Setup</button>
                    <div class="version-badge" id="version-badge">v1.0.0</div>
                </div>
            </header>

            <!-- Views -->
            <section id="view-overview" class="view">
                <h1 class="view-title">Dashboard Master</h1>
                <div class="stats-grid">
                    <div class="stat-card glass">
                        <span class="stat-label">Tiendas Activas</span>
                        <span class="stat-value" id="stat-active-tenants">0</span>
                        <div class="stat-meta">+1 esta semana</div>
                    </div>
                    <div class="stat-card glass accent">
                        <span class="stat-label">Mensajes Totales</span>
                        <span class="stat-value" id="stat-total-messages">0</span>
                        <div class="stat-meta">Interacciones totales</div>
                    </div>
                    <div class="stat-card glass">
                        <span class="stat-label">√âxito IA</span>
                        <span class="stat-value" id="stat-success-rate">0%</span>
                        <div class="stat-meta">Status: √ìptimo</div>
                    </div>
                </div>

                <div class="activity-row">
                    <div class="activity-card glass">
                        <h3>√öltima Actividad</h3>
                        <div id="last-activity">
                            <div class="activity-item">
                                <span class="activity-time" id="last-inbound-time">Nunca</span>
                                <span class="activity-desc">√öltimo mensaje recibido</span>
                            </div>
                            <div class="activity-item">
                                <span class="activity-time" id="last-outbound-time">Nunca</span>
                                <span class="activity-desc">√öltimo mensaje enviado</span>
                            </div>
                        </div>
                    </div>
                    <div class="alerts-card glass">
                        <h3>Estado del Sistema</h3>
                        <div id="system-alerts">
                            <div class="alert-item info">Sistema operativo</div>
                            <div class="alert-item success" id="tenants-status">Cargando tenants...</div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="view-stores" class="view">
                <div class="view-header">
                    <h1 class="view-title">Gesti√≥n de Tiendas</h1>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-secondary" onclick="deleteAllTenants()"
                            style="background: #f44336; color: white;">üóëÔ∏è Eliminar Todas</button>
                        <button class="btn-primary" onclick="resetTenantModal(); openModal('tenant-modal')">+ Nueva
                            Tienda</button>
                    </div>
                </div>
                <div class="stores-table-container glass">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Tienda</th>
                                <th>WhatsApp</th>
                                <th>Tienda Nube ID</th>
                                <th>Status</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tenants-list">
                            <!-- JS populated -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- New view: Chats (Human-in-the-Loop) -->
            <section id="view-chats" class="view">
                <div class="chats-layout">
                    <!-- Left Column: Chat List -->
                    <div class="chat-list-container glass">
                        <div class="chat-list-header">
                            <input type="text" id="chat-search" placeholder="Buscar..." onkeyup="filterChats()">
                            <button onclick="loadChats()" class="btn-icon">üîÑ</button>
                        </div>
                        <div class="chat-list" id="chat-list-items">
                            <!-- Populated by JS -->
                            <div class="chat-loading">Cargando conversaciones...</div>
                        </div>
                    </div>

                    <!-- Right Column: Chat Window -->
                    <div class="chat-window-container glass">
                        <div id="chat-empty-state" class="chat-empty-state">
                            <div class="empty-icon">üí¨</div>
                            <h3>Selecciona una conversaci√≥n</h3>
                            <p>Aqu√≠ ver√°s el historial y podr√°s intervenir manualmente.</p>
                        </div>

                        <div id="chat-interface" style="display: none;">
                            <div class="chat-header">
                                <button class="btn-back" onclick="backToChatList()" style="display: none;">‚Üê</button>
                                <div class="chat-avatar">üë§</div>
                                <div class="chat-info">
                                    <h3 id="chat-current-phone">Loading...</h3>
                                    <span class="chat-role-badge">WhatsApp User</span>
                                </div>
                                <div class="chat-controls"
                                    style="margin-left: auto; display: flex; align-items: center; gap: 10px;">
                                    <label class="switch-toggle"
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <span id="human-override-label"
                                            style="font-size: 13px; color: var(--text-secondary);">Agente Activo</span>
                                        <div class="toggle-wrapper"
                                            style="position: relative; width: 44px; height: 24px;">
                                            <input type="checkbox" id="human-override-toggle"
                                                onchange="toggleHumanOverride()">
                                            <span class="slider round"></span>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <div class="chat-messages" id="chat-messages-area">
                                <!-- Messages -->
                            </div>

                            <div class="chat-input-area">
                                <textarea id="chat-input-text"
                                    placeholder="Escribe un mensaje manual (Human Override)..."></textarea>
                                <button onclick="sendManualMessage()" id="chat-send-btn" class="btn-primary">‚û§</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="view-logs" class="view">
                <h1 class="view-title">Historia Viva de Mensajes</h1>
                <div class="logs-container glass">
                    <div class="logs-feed" id="logs-list">
                        <!-- JS populated -->
                    </div>
                </div>
            </section>

            <!-- New view: Credenciales -->
            <section id="view-credentials" class="view">
                <div class="view-header">
                    <h1 class="view-title">Gesti√≥n de Credenciales</h1>
                    <div class="credentials-controls" style="display: flex; gap: 10px; align-items: center;">
                        <select id="cred-filter-tenant" onchange="loadCredentials()"
                            style="padding: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: var(--text-primary);">
                            <option value="">Todos los Tenants</option>
                        </select>
                        <select id="cred-filter-type" onchange="loadCredentials()"
                            style="padding: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: var(--text-primary);">
                            <option value="">Todos los Tipos</option>
                            <option value="OpenAI">OpenAI</option>
                            <option value="WhatsApp API">WhatsApp API</option>
                            <option value="YCloud">YCloud</option>
                            <option value="Tienda Nube">Tienda Nube</option>
                            <option value="Redis">Redis</option>
                            <option value="Postgres">Postgres</option>
                            <option value="Other">Otro</option>
                        </select>
                        <button class="btn-primary" onclick="resetCredentialModal(); openModal('cred-modal')">+ Nueva
                            Credencial</button>
                    </div>
                </div>
                <div class="creds-table-container glass">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Valor</th>
                                    <th>Tipo</th>
                                    <th>Tenant</th>
                                    <th>√Åmbito</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="creds-list">
                                <!-- JS populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- New view: WhatsApp (YCloud) -->
            <section id="view-ycloud" class="view">
                <div class="view-header">
                    <h1 class="view-title">Configuraci√≥n de WhatsApp (YCloud)</h1>
                    <button class="btn-primary" onclick="openModal('ycloud-config-modal')">Configurar YCloud</button>
                </div>
                <div class="ycloud-info glass">
                    <p>En esta secci√≥n puedes agregar la API Key y el Webhook Secret de YCloud. Despu√©s de guardar,
                        reinicia el servicio de WhatsApp para que los cambios surtan efecto.</p>
                </div>
            </section>

            <!-- New view: WhatsApp Meta API -->
            <section id="view-whatsapp-meta" class="view">
                <div class="view-header">
                    <h1 class="view-title">Configuraci√≥n de WhatsApp Meta API</h1>
                    <button class="btn-primary" onclick="openModal('whatsapp-meta-modal')">Configurar Meta API</button>
                </div>
                <div class="whatsapp-meta-info glass">
                    <h3>Gu√≠a de Configuraci√≥n - WhatsApp Business API</h3>
                    <div class="setup-steps">
                        <div class="step">
                            <div class="service-icon">1</div>
                            <h4>Crear App en Meta for Developers</h4>
                            <p>Ve a <a href="https://developers.facebook.com" target="_blank">Meta for Developers</a> y
                                crea una nueva app de tipo "Business".</p>
                            <div class="service-status">
                                <span class="status-dot configured"></span>
                                <span class="status-text">Paso 1</span>
                            </div>
                        </div>
                        <div class="step">
                            <div class="service-icon">2</div>
                            <h4>Agregar WhatsApp Product</h4>
                            <p>En tu app, ve a "Add Product" y selecciona "WhatsApp". Esto te dar√° acceso a la Business
                                API.</p>
                            <div class="service-status">
                                <span class="status-dot configured"></span>
                                <span class="status-text">Paso 2</span>
                            </div>
                        </div>
                        <div class="step">
                            <div class="service-icon">3</div>
                            <h4>Configurar Webhook</h4>
                            <p>En WhatsApp ‚Üí Settings, configura la URL del webhook y el verify token. La URL debe ser
                                accesible p√∫blicamente.</p>
                            <div class="service-status">
                                <span class="status-dot configured"></span>
                                <span class="status-text">Paso 3</span>
                            </div>
                        </div>
                        <div class="step">
                            <div class="service-icon">4</div>
                            <h4>Obtener Access Token</h4>
                            <p>Genera un access token permanente desde WhatsApp ‚Üí Settings ‚Üí API. Este token no expira.
                            </p>
                            <div class="service-status">
                                <span class="status-dot configured"></span>
                                <span class="status-text">Paso 4</span>
                            </div>
                        </div>
                        <div class="step">
                            <div class="service-icon">5</div>
                            <h4>Verificar N√∫mero de Tel√©fono</h4>
                            <p>Asocia y verifica el n√∫mero de tel√©fono que usar√°s como bot. Meta enviar√° un c√≥digo de
                                verificaci√≥n.</p>
                            <div class="service-status">
                                <span class="status-dot configured"></span>
                                <span class="status-text">Paso 5</span>
                            </div>
                        </div>
                        <div class="step">
                            <div class="service-icon">6</div>
                            <h4>Configurar Plantilla de Mensajes</h4>
                            <p>Crea plantillas de mensajes aprobadas por Meta para iniciar conversaciones con clientes.
                            </p>
                            <div class="service-status">
                                <span class="status-dot configured"></span>
                                <span class="status-text">Paso 6</span>
                            </div>
                        </div>
                        <div class="step">
                            <div class="service-icon">7</div>
                            <h4>Probar Conexi√≥n</h4>
                            <p>Una vez configurado todo, guarda las credenciales arriba y prueba la conexi√≥n.</p>
                            <div class="service-status">
                                <span class="status-dot configured"></span>
                                <span class="status-text">Paso 7</span>
                            </div>
                        </div>
                    </div>

                    <div class="step-actions">
                        <button class="btn-secondary" onclick="copyWebhookUrl()">Copiar URL del Webhook</button>
                        <button class="btn-primary" onclick="testWhatsAppMetaConnection()">Probar Conexi√≥n Meta
                            API</button>
                    </div>

                    <div id="meta-test-result" class="test-result-container"></div>

                    <div class="warning-note">
                        <strong>‚ö†Ô∏è Importante:</strong> La Meta WhatsApp API requiere aprobaci√≥n de Meta y tiene costos
                        asociados. Aseg√∫rate de cumplir con las pol√≠ticas de WhatsApp Business.
                    </div>
                </div>
            </section>

            <!-- New view: Analytics -->
            <section id="view-analytics" class="view">
                <div class="view-header">
                    <h1 class="view-title">M√©tricas Avanzadas</h1>
                    <div class="analytics-controls">
                        <select id="analytics-tenant-filter" onchange="loadAnalytics()">
                            <option value="">Todas las tiendas</option>
                        </select>
                        <select id="analytics-time-filter" onchange="loadAnalytics()">
                            <option value="7">√öltimos 7 d√≠as</option>
                            <option value="30">√öltimos 30 d√≠as</option>
                            <option value="90">√öltimos 90 d√≠as</option>
                        </select>
                        <button class="btn-secondary" onclick="loadAnalytics()">üîÑ Actualizar</button>
                    </div>
                </div>

                <!-- KPIs Summary -->
                <div class="analytics-kpis glass">
                    <h3>Indicadores Clave de Rendimiento</h3>
                    <div class="kpis-grid" id="analytics-kpis">
                        <div class="kpi-card">
                            <div class="kpi-value" id="kpi-conversations">0</div>
                            <div class="kpi-label">Conversaciones</div>
                            <div class="kpi-meta">Total de chats iniciados</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-value" id="kpi-messages">0</div>
                            <div class="kpi-label">Mensajes</div>
                            <div class="kpi-meta">Total de mensajes</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-value" id="kpi-success-rate">0%</div>
                            <div class="kpi-label">Tasa de √âxito</div>
                            <div class="kpi-meta">Mensajes procesados</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-value" id="kpi-avg-response">0ms</div>
                            <div class="kpi-label">Tiempo Respuesta</div>
                            <div class="kpi-meta">Promedio IA</div>
                        </div>
                    </div>
                </div>

                <!-- Charts Container -->
                <div class="analytics-charts">
                    <div class="chart-container glass">
                        <h3>Conversaciones por D√≠a</h3>
                        <div class="chart-placeholder" id="conversations-chart">
                            <div class="chart-empty">
                                <div class="empty-icon">üìä</div>
                                <p>No hay datos de conversaciones disponibles</p>
                                <small>Los datos aparecer√°n aqu√≠ cuando haya actividad en el sistema</small>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container glass">
                        <h3>Intent Distribution</h3>
                        <div class="chart-placeholder" id="intent-chart">
                            <div class="chart-empty">
                                <div class="empty-icon">üéØ</div>
                                <p>No hay datos de intents disponibles</p>
                                <small>Los datos aparecer√°n aqu√≠ cuando la IA detecte intents</small>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container glass">
                        <h3>Top Error Codes</h3>
                        <div class="chart-placeholder" id="errors-chart">
                            <div class="chart-empty">
                                <div class="empty-icon">‚ö†Ô∏è</div>
                                <p>No hay errores registrados</p>
                                <small>¬°Excelente! El sistema est√° funcionando sin errores</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Tables -->
                <div class="analytics-tables">
                    <div class="table-section glass">
                        <h3>Eventos Recientes</h3>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Fecha/Hora</th>
                                        <th>Evento</th>
                                        <th>Severidad</th>
                                        <th>Descripci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody id="analytics-events">
                                    <tr>
                                        <td colspan="4" class="empty-row">
                                            <div class="table-empty">
                                                <div class="empty-icon">üìã</div>
                                                <p>No hay eventos recientes</p>
                                                <small>Los eventos del sistema aparecer√°n aqu√≠</small>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- New view: Herramientas -->
            <section id="view-tools" class="view">
                <div class="view-header">
                    <h1 class="view-title">Gesti√≥n de Herramientas</h1>
                    <button class="btn-primary" onclick="openModal('tool-modal')">+ Nueva Herramienta</button>
                </div>
                <div class="tools-table-container glass">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Tipo</th>
                                <th>URL Servicio</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tools-list">
                            <!-- JS populated -->
                        </tbody>
                    </table>
                </div>

                <!-- Human Handoff Configuration -->
                <div class="handoff-config-section glass" style="margin-top: 30px; padding: 30px;">
                    <div class="section-header"
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <div>
                            <h2 style="color: var(--accent); margin-bottom: 5px;">ü§ù Derivaci√≥n a Humano (derivhumano)
                            </h2>
                            <p style="color: var(--text-secondary); font-size: 14px;">Define cu√°ndo la IA debe ceder el
                                control al equipo humano y c√≥mo debe notificar.</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="handoff-enabled" onchange="toggleHandoffUI()">
                            <span class="slider round"></span>
                        </label>
                    </div>

                    <div id="handoff-form-container"
                        style="opacity: 0.5; pointer-events: none; transition: var(--transition);">
                        <!-- Granular Policy Rules -->
                        <div class="policy-grid"
                            style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                            <div class="policy-box glass" style="padding: 20px;">
                                <h3 style="font-size: 15px; margin-bottom: 15px; color: var(--accent);">üéØ ¬øCu√°ndo
                                    Derivar? (Policy)</h3>
                                <div class="checkbox-group" style="display: flex; flex-direction: column; gap: 10px;">
                                    <label class="checkbox-container">
                                        <input type="checkbox" id="rule-fitting"> Solicitud de Fitting / Asesora / Turno
                                    </label>
                                    <label class="checkbox-container">
                                        <input type="checkbox" id="rule-reclamo"> Reclamos o tono negativo
                                    </label>
                                    <label class="checkbox-container">
                                        <input type="checkbox" id="rule-dolor"> Dolor / Lesi√≥n / Incomodidad
                                    </label>
                                    <label class="checkbox-container">
                                        <input type="checkbox" id="rule-talle"> Ambig√ºedad de talle no resuelta
                                    </label>
                                    <label class="checkbox-container">
                                        <input type="checkbox" id="rule-especial"> Coordinaci√≥n especial / Retiros
                                    </label>
                                </div>
                            </div>
                            <div class="policy-box glass" style="padding: 20px;">
                                <h3 style="font-size: 15px; margin-bottom: 15px; color: var(--accent-secondary);">‚úâÔ∏è
                                    ¬øQu√© incluir en el Email?</h3>
                                <div class="checkbox-group" style="display: flex; flex-direction: column; gap: 10px;">
                                    <label class="checkbox-container">
                                        <input type="checkbox" id="ctx-name" checked> Nombre del usuario
                                    </label>
                                    <label class="checkbox-container">
                                        <input type="checkbox" id="ctx-phone" checked> Tel√©fono / WhatsApp ID
                                    </label>
                                    <label class="checkbox-container">
                                        <input type="checkbox" id="ctx-history"> Resumen de √∫ltimos mensajes
                                    </label>
                                    <label class="checkbox-container">
                                        <input type="checkbox" id="ctx-id"> Conversation ID & Timestamp
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="form-group full">
                                <label>Instrucciones Adicionales (AI Instructions)</label>
                                <textarea id="handoff-instructions" rows="3"
                                    placeholder="Instrucciones espec√≠ficas adicionales para el agente..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>Email de Destino (Recepci√≥n)</label>
                                <input type="email" id="handoff-target-email" placeholder="ejemplo@correo.com">
                            </div>
                            <div class="form-group">
                                <label>Mensaje al Cliente (Feedback)</label>
                                <input type="text" id="handoff-message"
                                    placeholder="Te derivo con una persona del equipo...">
                            </div>
                        </div>

                        <!-- SMTP Config Box -->
                        <div class="smtp-config-box glass"
                            style="margin-top: 30px; padding: 25px; border: 1px solid rgba(255,255,255,0.05);">
                            <h3 style="font-size: 15px; margin-bottom: 20px; color: var(--accent);">‚öôÔ∏è Configuraci√≥n
                                SMTP (Admin)</h3>
                            <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div class="form-group">
                                    <label>Host SMTP</label>
                                    <input type="text" id="smtp-host" placeholder="smtp.ejemplo.com">
                                </div>
                                <div class="form-group">
                                    <label>Puerto SMTP</label>
                                    <input type="number" id="smtp-port" placeholder="465">
                                </div>
                                <div class="form-group">
                                    <label>Seguridad (Security)</label>
                                    <select id="smtp-security">
                                        <option value="SSL">SSL (Recom. 465)</option>
                                        <option value="STARTTLS">STARTTLS (Recom. 587)</option>
                                        <option value="NONE">NONE</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Usuario SMTP</label>
                                    <input type="text" id="smtp-user" placeholder="usuario@ejemplo.com">
                                </div>
                                <div class="form-group">
                                    <label>Contrase√±a SMTP</label>
                                    <input type="password" id="smtp-pass" placeholder="********">
                                    <small style="color: var(--text-secondary); font-size: 11px;">Escribe para
                                        cambiarla, deja ******** para mantener.</small>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 30px; text-align: right;">
                            <select id="handoff-tenant-select"
                                style="background: var(--bg-card); color: white; border: 1px solid var(--border-glass); border-radius: 8px; padding: 8px;">
                                <option value="">Seleccionar Tenant...</option>
                            </select>
                            <button class="btn btn-primary" onclick="saveHandoffSettings()">
                                <span>üíæ Guardar Configuraci√≥n de Derivaci√≥n</span>
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- New view: Consola -->
            <section id="view-console" class="view">
                <div class="view-header">
                    <h1 class="view-title">Consola del Sistema</h1>
                    <div class="console-controls">
                        <button class="btn-secondary" onclick="clearConsole()">üóëÔ∏è Limpiar</button>
                        <button class="btn-secondary" onclick="toggleAutoScroll()">üìú Auto-scroll</button>
                        <button class="btn-primary" onclick="startConsoleStreaming()">‚ñ∂Ô∏è Iniciar Streaming</button>
                        <button class="btn-secondary" onclick="stopConsoleStreaming()">‚è∏Ô∏è Detener</button>
                    </div>
                </div>
                <div class="console-filters glass">
                    <div class="filter-group">
                        <label>Filtro por Severidad:</label>
                        <select id="severity-filter" onchange="applyConsoleFilters()">
                            <option value="">Todas</option>
                            <option value="debug">Debug</option>
                            <option value="info">Info</option>
                            <option value="warn">Warning</option>
                            <option value="error">Error</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Filtro por Tipo:</label>
                        <input type="text" id="type-filter" placeholder="Ej: message.incoming"
                            onkeyup="applyConsoleFilters()">
                    </div>
                    <div class="filter-group">
                        <label>Buscar:</label>
                        <input type="text" id="search-filter" placeholder="Buscar en eventos..."
                            onkeyup="applyConsoleFilters()">
                    </div>
                </div>
                <div class="console-container glass">
                    <div class="console-output" id="console-output">
                        <!-- Real-time events will appear here -->
                        <div class="console-welcome">
                            <div class="welcome-icon">üíª</div>
                            <h3>Consola del Sistema CodExy</h3>
                            <p>Haz clic en "Iniciar Streaming" para ver eventos en tiempo real del sistema.</p>
                            <div class="console-tips">
                                <strong>Tips de Debug:</strong>
                                <ul>
                                    <li>üì± <strong>WhatsApp:</strong> Eventos de mensajes entrantes/salientes</li>
                                    <li>ü§ñ <strong>IA:</strong> Procesamiento de respuestas del agente</li>
                                    <li>üõ†Ô∏è <strong>Herramientas:</strong> Llamadas a APIs externas</li>
                                    <li>‚ö†Ô∏è <strong>Errores:</strong> Problemas y excepciones</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Welcome / Connect View -->
            <section id="view-welcome" class="view active">
                <div class="welcome-container">
                    <h1 class="view-title">Bienvenido a CodExy</h1>
                    <p class="welcome-description">Verifica la conexi√≥n y configura tu bot de WhatsApp para Tienda Nube.
                    </p>

                    <div class="welcome-cards">
                        <!-- Card 1: Conectar API -->
                        <div class="welcome-card glass">
                            <div class="card-icon">üîó</div>
                            <h3>Conectar API</h3>
                            <p>Verifica la conexi√≥n con el orquestador</p>
                            <div class="card-status" id="api-status">Pendiente</div>
                            <button class="btn-primary" onclick="connectInstance()">Conectar</button>
                        </div>

                        <!-- Card 2: Webhook URL -->
                        <div class="welcome-card glass">
                            <div class="card-icon">üì°</div>
                            <h3>Webhook URL</h3>
                            <p>URL para configurar en YCloud</p>
                            <div class="webhook-display">
                                <code id="webhook-url-display">Cargando...</code>
                                <button class="btn-secondary" onclick="copyWebhookUrl()">Copiar</button>
                            </div>
                            <button class="btn-secondary" onclick="verifyWebhook()">Verificar Entrada</button>
                        </div>

                        <!-- Card 3: Checklist -->
                        <div class="welcome-card glass">
                            <div class="card-icon">‚úÖ</div>
                            <h3>Estado de Configuraci√≥n</h3>
                            <div class="checklist">
                                <div class="check-item" id="check-tenant">
                                    <span class="check-status">‚ùå</span> Tienda configurada
                                </div>
                                <div class="check-item" id="check-tiendanube">
                                    <span class="check-status">‚ùå</span> Tienda Nube conectada
                                </div>
                                <div class="check-item" id="check-openai">
                                    <span class="check-status">‚ùå</span> OpenAI configurado
                                </div>
                                <div class="check-item" id="check-ycloud">
                                    <span class="check-status">‚≠ï</span> WhatsApp YCloud ok
                                </div>
                                <div class="check-item" id="check-meta">
                                    <span class="check-status">‚≠ï</span> WhatsApp Meta API ok
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="welcome-actions">
                        <button class="btn-primary" onclick="startSetupWizard()">Comenzar Configuraci√≥n</button>
                    </div>
                </div>
            </section>

            <!-- Setup Wizard View - Session-Based for Self-Hosted -->
            <section id="view-setup" class="view">
                <div class="setup-container">
                    <h1 class="view-title">Asistente de Despliegue - CodExy</h1>
                    <p class="welcome-description">Verificaremos tu infraestructura antes de configurar WhatsApp y Meta.
                        Esto garantiza que todo funcione correctamente en tu entorno self-hosted.</p>

                    <!-- Dynamic content loaded by JavaScript -->
                    <div id="setup-content">
                        <div class="setup-loading">
                            <div class="progress-spinner"></div>
                            <h3>Iniciando verificaci√≥n...</h3>
                            <p>Preparando el asistente de despliegue</p>
                        </div>
                    </div>

                    <div class="setup-info">
                        <div class="info-card glass">
                            <h4>üîç ¬øQu√© verifica este asistente?</h4>
                            <ul>
                                <li>‚úÖ Configuraci√≥n de dominio p√∫blico y TLS</li>
                                <li>‚úÖ Conectividad de webhooks y APIs</li>
                                <li>‚úÖ Base de datos y persistencia</li>
                                <li>‚úÖ Reloj del servidor (NTP)</li>
                                <li>‚úÖ Credenciales requeridas</li>
                                <li>‚úÖ Reverse proxy y puertos</li>
                            </ul>
                        </div>

                        <div class="info-card glass">
                            <h4>üéØ ¬øPor qu√© es importante?</h4>
                            <p>En despliegues self-hosted, los problemas m√°s comunes son de infraestructura, no de
                                c√≥digo. Este asistente previene configuraciones rotas y reduce tickets de soporte.</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Sidebar Toggle Button (Mobile) -->
    <div class="sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebar()"></div>

    <!-- Modals -->
    <div id="tenant-modal" class="modal-overlay">
        <div class="modal glass">
            <h2 id="tenant-modal-title">Configuraci√≥n de Tienda</h2>
            <form id="tenant-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nombre de la Tienda</label>
                        <input type="text" name="store_name" required>
                    </div>
                    <div class="form-group">
                        <label>N√∫mero de WhatsApp Bot</label>
                        <input type="text" name="bot_phone_number" required placeholder="5411...">
                    </div>
                    <div class="form-group">
                        <label>Email del Propietario</label>
                        <input type="email" name="owner_email" placeholder="email@ejemplo.com">
                    </div>
                    <div class="form-group">
                        <label>Ubicaci√≥n de la Tienda</label>
                        <input type="text" name="store_location" placeholder="Ciudad, Pa√≠s">
                    </div>
                    <div class="form-group">
                        <label>Sitio Web</label>
                        <input type="url" name="store_website" placeholder="https://tu-tienda.com">
                    </div>
                    <div class="form-group">
                        <label>Tienda Nube</label>
                        <select name="tiendanube_store_preset" id="tn-store-preset" onchange="updateTNFields()">
                            <option value="">Seleccionar tienda existente...</option>
                            <option value="custom">Configurar manualmente</option>
                        </select>
                    </div>
                    <div id="tn-manual-fields" style="display: none;">
                        <div class="form-group">
                            <label>Tienda Nube ID</label>
                            <input type="text" name="tiendanube_store_id">
                        </div>
                        <div class="form-group">
                            <label>Tienda Nube Token</label>
                            <input type="password" name="tiendanube_access_token">
                        </div>
                    </div>
                    <div class="form-group full">
                        <label>Descripci√≥n / Branding (IA Context)</label>
                        <textarea name="store_description" rows="3"></textarea>
                    </div>
                    <div class="form-group full">
                        <label>Conocimiento de Cat√°logo</label>
                        <textarea name="store_catalog_knowledge" rows="5"
                            placeholder="Listado de categor√≠as, marcas, etc..."></textarea>
                    </div>
                </div>

                <!-- Credentials Section in Tenant Modal -->
                <div class="tenant-credentials-section"
                    style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <h3>Credenciales Asociadas</h3>
                    <div id="tenant-credentials-list" class="credentials-list-compact">
                        <!-- Populated by JS -->
                        <div style="text-align: center; color: #aaa; padding: 10px;">Cargando credenciales...</div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeModal('tenant-modal')">Cancelar</button>
                    <button type="button" id="delete-tenant-btn" class="btn-delete" onclick="deleteTenant()"
                        style="display: none;">üóëÔ∏è Eliminar</button>
                    <button type="submit" class="btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Credentials -->
    <div id="cred-modal" class="modal-overlay" onclick="handleModalClick(event, 'cred-modal')">
        <div class="modal glass">
            <h2>Agregar/Editar Credencial</h2>
            <form id="cred-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nombre</label>
                        <input type="text" name="name" required placeholder="e.g., OPENAI_API_KEY">
                    </div>
                    <div class="form-group">
                        <label>Valor</label>
                        <input type="password" name="value" required>
                    </div>
                    <div class="form-group">
                        <label>Tipo (Categor√≠a)</label>
                        <select name="category" required>
                            <option value="OpenAI">OpenAI</option>
                            <option value="WhatsApp API">WhatsApp API</option>
                            <option value="YCloud">YCloud</option>
                            <option value="Tienda Nube">Tienda Nube</option>
                            <option value="Redis">Redis</option>
                            <option value="Postgres">Postgres</option>
                            <option value="Other">Otro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>√Åmbito</label>
                        <select name="scope" required onchange="toggleTenantSelector()">
                            <option value="global">Global</option>
                            <option value="tenant">Tenant</option>
                        </select>
                    </div>
                    <div class="form-group" id="tenant-selector" style="display: none;">
                        <label>Tenant</label>
                        <select name="tenant_id" id="cred-tenant-select">
                            <option value="">Seleccionar tenant...</option>
                        </select>
                    </div>
                    <div class="form-group full">
                        <label>Descripci√≥n (opcional)</label>
                        <textarea name="description" rows="2"
                            placeholder="Describe el prop√≥sito de esta credencial..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary"
                        onclick="closeModal('cred-modal'); resetCredentialModal();">Cancelar</button>
                    <button type="submit" class="btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for YCloud Config -->
    <div id="ycloud-config-modal" class="modal-overlay">
        <div class="modal glass">
            <h2>Configurar YCloud</h2>
            <form id="ycloud-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label>API Key</label>
                        <input type="password" name="api_key" required>
                    </div>
                    <div class="form-group">
                        <label>Webhook Secret</label>
                        <input type="password" name="webhook_secret" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Tenant</label>
                    <select name="tenant_id" id="ycloud-tenant-select" required>
                        <option value="">Seleccionar tenant...</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary"
                        onclick="closeModal('ycloud-config-modal')">Cancelar</button>
                    <button type="submit" class="btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for WhatsApp Meta API Config -->
    <div id="whatsapp-meta-modal" class="modal-overlay">
        <div class="modal glass">
            <h2>Configurar WhatsApp Meta API</h2>
            <form id="whatsapp-meta-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Access Token</label>
                        <input type="password" name="access_token" required placeholder="EAA...">
                    </div>
                    <div class="form-group">
                        <label>Phone Number ID</label>
                        <input type="text" name="phone_number_id" required placeholder="123456789">
                    </div>
                    <div class="form-group">
                        <label>Business Account ID</label>
                        <input type="text" name="business_account_id" required placeholder="123456789">
                    </div>
                    <div class="form-group">
                        <label>Verify Token</label>
                        <input type="password" name="verify_token" required placeholder="tu_verify_token">
                    </div>
                </div>
                <div class="form-group">
                    <label>Tenant</label>
                    <select name="tenant_id" id="whatsapp-meta-tenant-select" required>
                        <option value="">Seleccionar tenant...</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary"
                        onclick="closeModal('whatsapp-meta-modal')">Cancelar</button>
                    <button type="submit" class="btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Tools -->
    <div id="tool-modal" class="modal-overlay">
        <div class="modal glass">
            <h2>Crear Nueva Herramienta</h2>
            <form id="tool-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nombre</label>
                        <input type="text" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>Tipo</label>
                        <select name="type" required onchange="updateToolConfig()">
                            <option value="http">HTTP</option>
                            <option value="tienda_nube">Tienda Nube</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>URL del Servicio</label>
                        <input type="text" name="service_url" placeholder="http://service:8000">
                    </div>
                </div>
                <div id="tool-config" class="form-grid">
                    <!-- Dynamic config fields -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeModal('tool-modal')">Cancelar</button>
                    <button type="submit" class="btn-primary">Crear Herramienta</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Tenant Details -->
    <div id="tenant-detail-modal" class="modal-overlay">
        <div class="modal glass" style="max-width: 900px;">
            <div class="modal-header">
                <h2 id="tenant-detail-title">Detalles del Tenant</h2>
                <button class="btn-close" onclick="closeModal('tenant-detail-modal')">√ó</button>
            </div>

            <div id="tenant-detail-content">
                <!-- Tenant Info -->
                <div class="tenant-info-section glass">
                    <h3>Informaci√≥n del Tenant</h3>
                    <div class="tenant-info-grid">
                        <div class="info-item">
                            <label>Nombre de Tienda:</label>
                            <span id="detail-store-name">-</span>
                        </div>
                        <div class="info-item">
                            <label>N√∫mero WhatsApp:</label>
                            <span id="detail-phone-number">-</span>
                        </div>
                        <div class="info-item">
                            <label>Email:</label>
                            <span id="detail-owner-email">-</span>
                        </div>
                        <div class="info-item">
                            <label>Tienda Nube ID:</label>
                            <span id="detail-tn-store-id">-</span>
                        </div>
                        <div class="info-item">
                            <label>Ubicaci√≥n:</label>
                            <span id="detail-location">-</span>
                        </div>
                        <div class="info-item">
                            <label>Sitio Web:</label>
                            <span id="detail-website">-</span>
                        </div>
                    </div>
                </div>

                <!-- WhatsApp Status -->
                <div class="whatsapp-status-section glass">
                    <h3>Estado de WhatsApp</h3>
                    <div class="status-blocks">
                        <div class="status-block" id="ycloud-status-block">
                            <div class="status-icon">üì±</div>
                            <div class="status-info">
                                <h4>YCloud</h4>
                                <div class="status-indicator" id="ycloud-indicator">
                                    <span class="status-dot"></span>
                                    <span class="status-text">Verificando...</span>
                                </div>
                                <div class="status-details" id="ycloud-details"></div>
                            </div>
                        </div>

                        <div class="status-block" id="meta-status-block">
                            <div class="status-icon">üí¨</div>
                            <div class="status-info">
                                <h4>Meta API</h4>
                                <div class="status-indicator" id="meta-indicator">
                                    <span class="status-dot"></span>
                                    <span class="status-text">Verificando...</span>
                                </div>
                                <div class="status-details" id="meta-details"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Credentials -->
                <div class="credentials-section glass">
                    <h3>Credenciales</h3>
                    <div class="credentials-tabs">
                        <button class="tab-btn active" onclick="showCredentialTab('tenant')">Tenant-Specific</button>
                        <button class="tab-btn" onclick="showCredentialTab('global')">Global</button>
                    </div>
                    <div id="tenant-credentials-list" class="credentials-list">
                        <!-- Tenant credentials will be populated here -->
                    </div>
                    <div id="global-credentials-list" class="credentials-list" style="display: none;">
                        <!-- Global credentials will be populated here -->
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('tenant-detail-modal')">Cerrar</button>
                <button class="btn-primary" onclick="editTenantFromDetail()">Editar Tenant</button>
            </div>
        </div>
    </div>

    <!-- Diagnostics Modal -->
    <div id="diagnostics-modal" class="modal-overlay" style="display: none;">
        <div class="modal glass">
            <h2>Diagn√≥stico del Sistema</h2>
            <div id="diagnostics-content">
                <p>Verificando servicios...</p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('diagnostics-modal')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Tour Overlay -->
    <div id="tour-overlay" class="tour-overlay" style="display: none;">
        <div class="tour-card">
            <div id="tour-icon">üìä</div>
            <h2 id="tour-title">Bienvenido a CodExy</h2>
            <div id="tour-content">Comenzaremos un tour guiado para que conozcas todas las funcionalidades de la
                plataforma.</div>
            <div class="tour-buttons">
                <button id="tour-skip" class="tour-skip">Omitir Tour</button>
                <button id="tour-next" class="tour-next">Comenzar</button>
            </div>
        </div>
    </div>

    <!-- Service Selection Modal -->
    <div id="service-selection-modal" class="modal-overlay" style="display: none;">
        <div class="modal glass">
            <h2>Configurar Servicios</h2>
            <p class="modal-description">Selecciona qu√© servicios deseas configurar. Los servicios ya configurados
                aparecen en verde.</p>
            <div class="service-cards-grid">
                <div class="service-card" id="tn-service-card" onclick="selectService('tiendanube')">
                    <div class="service-icon">üè™</div>
                    <h3>Tienda Nube</h3>
                    <p>Conecta tu tienda online para acceder a productos y pedidos</p>
                    <div class="service-status" id="tn-status">
                        <span class="status-dot"></span>
                        <span class="status-text">Verificando...</span>
                    </div>
                </div>
                <div class="service-card" id="ycloud-service-card" onclick="selectService('ycloud')">
                    <div class="service-icon">üì±</div>
                    <h3>WhatsApp (YCloud)</h3>
                    <p>Configura WhatsApp Business con YCloud para mensajer√≠a</p>
                    <div class="service-status" id="ycloud-status">
                        <span class="status-dot"></span>
                        <span class="status-text">Verificando...</span>
                    </div>
                </div>
                <div class="service-card" id="meta-service-card" onclick="selectService('whatsapp-meta')">
                    <div class="service-icon">üí¨</div>
                    <h3>WhatsApp Meta API</h3>
                    <p>Usa la API oficial de WhatsApp Business de Meta</p>
                    <div class="service-status" id="meta-status">
                        <span class="status-dot"></span>
                        <span class="status-text">Verificando...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('service-selection-modal')">Omitir y
                    Continuar</button>
                <button class="btn-primary" onclick="goToOverview()">Ir al Dashboard</button>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notification-modal" class="modal-overlay" style="display: none;">
        <div class="modal glass" style="text-align: center;">
            <div id="notification-icon" style="font-size: 48px; margin-bottom: 20px;">‚úÖ</div>
            <h2 id="notification-title">√âxito</h2>
            <p id="notification-message">Operaci√≥n completada correctamente.</p>
            <div class="modal-footer" style="justify-content: center;">
                <button class="btn-primary" onclick="closeModal('notification-modal')">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- Runtime Config -->
    <script src="env.js"></script>
    <script src="app.js"></script>
</body>

</html>
````

## File: platform_ui/nginx.conf
````ini
server {
    listen 80;
    server_name localhost;

    location /api/ {
        # This proxy is often redundant if API_BASE is set to a full URL in the browser,
        # but if used, it should point to the internal service name in Docker.
        proxy_pass http://orchestrator_service:8000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
}
````

## File: platform_ui/style.css
````css
:root {
    --bg-dark: #0a0a0c;
    --bg-card: rgba(255, 255, 255, 0.03);
    --border-glass: rgba(255, 255, 255, 0.1);
    --accent: #7c4dff;
    --accent-glow: rgba(124, 77, 255, 0.3);
    --success: #00e676;
    --text-primary: #f5f5f7;
    --text-secondary: #a1a1aa;
    --sidebar-width: 260px;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Outfit', sans-serif;
}

body {
    background: var(--bg-dark);
    color: var(--text-primary);
    overflow: hidden;
    background-image:
        radial-gradient(circle at 20% 20%, #1a1a2e 0%, transparent 40%),
        radial-gradient(circle at 80% 80%, #16213e 0%, transparent 40%);
}

.dark-theme {
    height: 100vh;
    width: 100vw;
}

/* Glassmorphism Container */
.glass-container {
    display: flex;
    height: 100vh;
    padding: 20px;
    gap: 20px;
}

/* Sidebar Styling */
.sidebar {
    width: var(--sidebar-width);
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border-glass);
    border-radius: 24px;
    display: flex;
    flex-direction: column;
    padding: 30px 15px;
}

.logo {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 50px;
    padding-left: 15px;
}

.logo-icon {
    font-size: 24px;
    background: var(--accent);
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
    box-shadow: 0 0 20px var(--accent-glow);
}

.logo-text {
    font-weight: 800;
    font-size: 20px;
    letter-spacing: 1px;
    background: linear-gradient(to right, #fff, var(--accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.nav-item {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    width: 100%;
    padding: 14px 20px;
    margin-bottom: 8px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    font-size: 15px;
    font-weight: 400;
    transition: var(--transition);
    text-align: left;
}

.nav-item:hover {
    background: rgba(255, 255, 255, 0.05);
    color: #fff;
}

.nav-item.active {
    background: var(--accent);
    color: #fff;
    box-shadow: 0 10px 20px var(--accent-glow);
}

/* Main Content area */
.content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 20px;
    height: 100%;
}

.top-bar {
    height: 70px;
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border-glass);
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 25px;
    gap: 20px;
}

.health-strip {
    display: flex;
    gap: 15px;
    flex: 1;
}

.service-pill {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: var(--text-secondary);
    padding: 6px 12px;
    border-radius: 20px;
    background: rgba(255, 255, 255, 0.05);
}

.service-pill.ok {
    background: rgba(0, 230, 118, 0.1);
    color: var(--success);
}

.service-pill.error {
    background: rgba(255, 77, 77, 0.1);
    color: #ff4d4d;
}

.service-pill.warning {
    background: rgba(255, 193, 7, 0.1);
    color: #ffc107;
}

.pill-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--text-secondary);
}

.service-pill.ok .pill-dot {
    background: var(--success);
}

.service-pill.error .pill-dot {
    background: #ff4d4d;
}

.service-pill.warning .pill-dot {
    background: #ffc107;
}

.last-signals {
    display: flex;
    gap: 20px;
}

.signal-item {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
}

.signal-label {
    font-size: 10px;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.signal-value {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-primary);
}

.top-actions {
    display: flex;
    gap: 10px;
}

.version-badge {
    background: var(--accent);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

.search-bar input {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-glass);
    padding: 10px 20px;
    border-radius: 50px;
    color: #fff;
    width: 300px;
    outline: none;
}

.view {
    display: none;
    flex: 1;
    overflow-y: auto;
    padding: 10px;
}

.view.active {
    display: block;
    animation: fadeIn 0.4s ease-out;
}

.view-title {
    font-size: 28px;
    font-weight: 800;
    margin-bottom: 30px;
}

/* Stat Cards */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.glass {
    background: var(--bg-card);
    backdrop-filter: blur(40px);
    border: 1px solid var(--border-glass);
    border-radius: 20px;
}

.stat-card {
    padding: 25px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    position: relative;
    overflow: hidden;
}

.stat-card.accent::after {
    content: '';
    position: absolute;
    top: -50px;
    right: -50px;
    width: 100px;
    height: 100px;
    background: var(--accent);
    filter: blur(60px);
}

.stat-label {
    color: var(--text-secondary);
    font-weight: 400;
    font-size: 14px;
}

.stat-value {
    font-size: 36px;
    font-weight: 800;
}

.stat-meta {
    font-size: 12px;
    color: var(--success);
}

/* Data Table */
.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th {
    text-align: left;
    padding: 20px;
    color: var(--text-secondary);
    font-weight: 400;
    border-bottom: 1px solid var(--border-glass);
}

.data-table td {
    padding: 20px;
    border-bottom: 1px solid var(--border-glass);
}

/* Table Responsive Container */
.table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

/* Modal */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(5px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
}

.modal {
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    padding: 40px;
    overflow-y: auto;
}

.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin: 20px 0;
}

.form-group.full {
    grid-column: span 2;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    color: var(--text-secondary);
    font-size: 14px;
}

.form-group input,
.form-group textarea {
    width: 100%;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--border-glass);
    padding: 12px;
    border-radius: 12px;
    color: #fff;
    outline: none;
}

.btn-primary {
    background: var(--accent);
    color: #fff;
    border: none;
    padding: 12px 24px;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 10px 20px var(--accent-glow);
}

.btn-secondary {
    background: rgba(255, 255, 255, 0.05);
    color: #fff;
    border: 1px solid var(--border-glass);
    padding: 12px 24px;
    border-radius: 12px;
    cursor: pointer;
}

/* Select dropdown styling */
.form-group select {
    width: 100%;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--border-glass);
    padding: 12px;
    border-radius: 12px;
    color: #fff;
    outline: none;
    transition: var(--transition);
}

.form-group select:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(124, 77, 255, 0.1);
}

.form-group select option {
    background: var(--bg-dark);
    color: #fff;
    padding: 8px;
}

/* Enhanced form animations */
.form-group input,
.form-group textarea,
.form-group select {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(124, 77, 255, 0.15);
}

/* Preflight Check Styles */
.preflight-loading {
    text-align: center;
    padding: 40px 20px;
}

.preflight-progress {
    margin: 30px 0;
}

.progress-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255, 255, 255, 0.1);
    border-top: 4px solid var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    0% {
        transform: rotate(0deg);
    }

    100% {
        transform: rotate(360deg);
    }
}

.preflight-results {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin: 30px 0;
}

.preflight-check {
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border-glass);
    border-radius: 12px;
    padding: 20px;
    transition: all 0.3s ease;
}

.preflight-check.check-pass {
    border-color: var(--success);
    background: rgba(0, 230, 118, 0.05);
}

.preflight-check.check-warn {
    border-color: #ffc107;
    background: rgba(255, 193, 7, 0.05);
}

.preflight-check.check-fail {
    border-color: #ff4d4d;
    background: rgba(255, 77, 77, 0.05);
}

.check-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 10px;
}

.check-icon {
    font-size: 20px;
}

.check-name {
    font-weight: 600;
    flex: 1;
}

.check-status {
    font-size: 12px;
    font-weight: 600;
    padding: 4px 12px;
    border-radius: 20px;
    text-transform: uppercase;
}

.check-pass .check-status {
    background: rgba(0, 230, 118, 0.1);
    color: var(--success);
}

.check-warn .check-status {
    background: rgba(255, 193, 7, 0.1);
    color: #ffc107;
}

.check-fail .check-status {
    background: rgba(255, 77, 77, 0.1);
    color: #ff4d4d;
}

.check-message {
    color: var(--text-primary);
    margin-bottom: 8px;
}

.check-solution {
    color: var(--text-secondary);
    font-size: 14px;
    font-style: italic;
}

.preflight-actions {
    text-align: center;
    margin-top: 30px;
}

.preflight-error {
    text-align: center;
    padding: 40px 20px;
}

.error-details {
    background: rgba(255, 77, 77, 0.1);
    border: 1px solid #ff4d4d;
    border-radius: 8px;
    padding: 15px;
    margin: 20px 0;
    color: #ff4d4d;
}

/* Setup Info Cards */
.setup-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 40px;
}

.info-card {
    padding: 25px;
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border-glass);
    border-radius: 16px;
}

.info-card h4 {
    color: var(--accent);
    margin-bottom: 15px;
    font-size: 16px;
}

.info-card ul {
    list-style: none;
    padding: 0;
}

.info-card li {
    padding: 8px 0;
    color: var(--text-secondary);
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.info-card li:last-child {
    border-bottom: none;
}

.info-card p {
    color: var(--text-secondary);
    line-height: 1.6;
}

.setup-loading {
    text-align: center;
    padding: 60px 20px;
}

.setup-loading h3 {
    color: var(--text-primary);
    margin: 20px 0 10px;
}

.setup-loading p {
    color: var(--text-secondary);
}

.form-group label {
    transition: all 0.3s ease;
}

.form-group input:focus+label,
.form-group textarea:focus+label,
.form-group select:focus+label {
    color: var(--accent);
}

/* Button hover effects */
.btn-primary:hover,
.btn-secondary:hover,
.btn-cta:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(124, 77, 255, 0.2);
}

/* Modal animations */
.modal {
    animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
    }

    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* Loading states */
.btn-primary:disabled,
.btn-secondary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

/* Success animations */
@keyframes successPulse {
    0% {
        box-shadow: 0 0 0 0 rgba(0, 230, 118, 0.7);
    }

    70% {
        box-shadow: 0 0 0 10px rgba(0, 230, 118, 0);
    }

    100% {
        box-shadow: 0 0 0 0 rgba(0, 230, 118, 0);
    }
}

.success-animation {
    animation: successPulse 1s ease-out;
}

.btn-delete {
    background: #ff4757;
    color: #fff;
    border: none;
    padding: 12px 24px;
    border-radius: 12px;
    cursor: pointer;
    box-shadow: 0 10px 20px rgba(255, 71, 87, 0.3);
}

/* Logs Feed */
.logs-feed {
    padding: 20px;
    max-height: 60vh;
    overflow-y: auto;
}

.log-entry {
    background: rgba(255, 255, 255, 0.02);
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    border-left: 4px solid var(--accent);
}

.log-meta {
    font-size: 11px;
    color: var(--text-secondary);
    margin-bottom: 5px;
}

.log-text {
    font-size: 14px;
}

.log-response {
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px dashed var(--border-glass);
    color: var(--success);
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Tour Styles */
.tour-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    z-index: 2000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.tour-card {
    background: var(--bg-card);
    backdrop-filter: blur(40px);
    border: 1px solid var(--border-glass);
    border-radius: 24px;
    padding: 40px;
    max-width: 500px;
    text-align: center;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    animation: tourFadeIn 0.5s ease-out;
}

.tour-icon {
    font-size: 48px;
    margin-bottom: 20px;
}

.tour-title {
    font-size: 24px;
    font-weight: 800;
    margin-bottom: 15px;
    background: linear-gradient(to right, #fff, var(--accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.tour-content {
    color: var(--text-secondary);
    line-height: 1.6;
    margin-bottom: 30px;
}

.tour-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
}

.tour-skip {
    background: rgba(255, 255, 255, 0.05);
    color: var(--text-secondary);
    border: 1px solid var(--border-glass);
    padding: 12px 24px;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 500;
}

.tour-next {
    background: var(--accent);
    color: #fff;
    border: none;
    padding: 12px 24px;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 10px 20px var(--accent-glow);
}

@keyframes tourFadeIn {
    from {
        opacity: 0;
        transform: scale(0.9) translateY(20px);
    }

    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

/* Test Result Styles */
.test-result {
    padding: 15px;
    border-radius: 12px;
    margin: 10px 0;
    animation: fadeIn 0.3s ease-out;
}

.test-result.error {
    background: rgba(244, 67, 54, 0.1);
    border: 1px solid rgba(244, 67, 54, 0.3);
}

.test-message {
    font-weight: 600;
    margin-bottom: 8px;
}

.test-subtitle {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 12px;
}

.test-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.btn-cta {
    background: var(--accent);
    color: #fff;
    border: none;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 5px;
}

.btn-cta:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px var(--accent-glow);
}

.test-result.error .btn-cta {
    background: var(--accent);
}

/* WhatsApp Meta Setup Styles */
.whatsapp-meta-info {
    padding: 30px 0;
    text-align: center;
    max-width: 100%;
    margin: 0 auto;
}

.whatsapp-meta-info h3 {
    color: var(--accent);
    margin-bottom: 20px;
    font-size: 20px;
}

.setup-steps {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-bottom: 30px;
    align-items: center;
}

.setup-steps .step {
    background: rgba(255, 255, 255, 0.03);
    padding: 20px;
    border-radius: 12px;
    border: 1px solid var(--border-glass);
    text-align: center;
    max-width: 600px;
    margin: 0 auto;
}

.setup-steps .step .service-icon {
    font-size: 32px;
    color: var(--accent);
    margin-bottom: 10px;
    display: block;
    margin-left: auto;
    margin-right: auto;
}

.setup-steps .step h4 {
    color: var(--accent);
    margin-bottom: 10px;
    font-size: 16px;
    text-align: center;
}

.setup-steps .step p {
    color: var(--text-secondary);
    line-height: 1.5;
    margin-bottom: 10px;
    text-align: center;
    max-width: 100%;
}

.setup-steps .step .service-status {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: 10px;
}

.setup-steps .step .btn-secondary {
    margin-top: 10px;
}

.warning-note {
    background: rgba(255, 193, 7, 0.1);
    border: 1px solid rgba(255, 193, 7, 0.3);
    border-radius: 12px;
    padding: 20px;
    color: #ffc107;
    font-weight: 500;
    text-align: center;
    margin: 30px auto;
    max-width: 600px;
}

/* Welcome Cards */
.welcome-container {
    max-width: 1200px;
    margin: 0 auto;
    text-align: center;
}

.welcome-description {
    font-size: 18px;
    color: var(--text-secondary);
    margin-bottom: 40px;
}

.welcome-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 30px;
    margin-bottom: 40px;
}

.welcome-card {
    padding: 30px;
    text-align: center;
    border-radius: 20px;
}

.card-icon {
    font-size: 48px;
    margin-bottom: 20px;
}

.welcome-card h3 {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 10px;
}

.welcome-card p {
    color: var(--text-secondary);
    margin-bottom: 20px;
}

.card-status {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 15px;
    padding: 5px 15px;
    border-radius: 20px;
    display: inline-block;
}

.card-status.ok {
    background: rgba(0, 230, 118, 0.1);
    color: var(--success);
}

.card-status.error {
    background: rgba(255, 77, 77, 0.1);
    color: #ff4d4d;
}

.webhook-display {
    background: rgba(255, 255, 255, 0.05);
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 15px;
}

.webhook-display code {
    font-family: 'Courier New', monospace;
    font-size: 12px;
    word-break: break-all;
    display: block;
    margin-bottom: 10px;
}

.checklist {
    text-align: left;
}

.check-item {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
    font-size: 14px;
}

.check-status {
    font-size: 16px;
}

.welcome-actions {
    margin-top: 30px;
}

/* Welcome and Connection Styles */
.welcome-container {
    max-width: 600px;
    margin: 0 auto;
    text-align: center;
    padding: 40px;
}

.welcome-description {
    color: var(--text-secondary);
    margin-bottom: 30px;
    font-size: 16px;
    line-height: 1.6;
}

.connect-form {
    display: grid;
    gap: 20px;
    margin-bottom: 30px;
}

.status-message {
    min-height: 20px;
    color: var(--success);
    font-weight: 500;
}

.status-message.error {
    color: var(--accent);
}

/* Top Bar Enhancements */
.health-indicator {
    font-size: 14px;
    color: var(--text-secondary);
    margin-right: 20px;
}

.top-actions {
    margin-right: 20px;
}

.top-actions .btn-secondary {
    padding: 8px 16px;
    font-size: 14px;
}

/* Setup Wizard Styles */
.setup-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 40px 20px;
}

.setup-progress {
    margin-bottom: 40px;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: var(--bg-card);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 20px;
}

.progress-fill {
    height: 100%;
    background: var(--accent);
    transition: width 0.3s ease;
}

.progress-steps {
    display: flex;
    justify-content: space-between;
    position: relative;
}

.setup-step {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--bg-card);
    border: 2px solid var(--border-glass);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    color: var(--text-secondary);
    transition: all 0.3s ease;
}

.setup-step.active {
    background: var(--accent);
    color: #fff;
    border-color: var(--accent);
}

.setup-step.completed {
    background: var(--success);
    color: #fff;
    border-color: var(--success);
}

.setup-content {
    background: var(--bg-card);
    backdrop-filter: blur(40px);
    border: 1px solid var(--border-glass);
    border-radius: 20px;
    padding: 40px;
    margin-bottom: 30px;
    min-height: 300px;
}

.setup-step-title {
    font-size: 24px;
    font-weight: 800;
    margin-bottom: 15px;
    background: linear-gradient(to right, #fff, var(--accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.setup-step-description {
    color: var(--text-secondary);
    margin-bottom: 30px;
    line-height: 1.6;
}

.setup-form {
    display: grid;
    gap: 20px;
}

.setup-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.test-result {
    margin-top: 20px;
    padding: 15px;
    border-radius: 12px;
    background: rgba(0, 230, 118, 0.1);
    border: 1px solid rgba(0, 230, 118, 0.3);
}

.test-result.error {
    background: rgba(255, 77, 77, 0.1);
    border-color: rgba(255, 77, 77, 0.3);
}

/* Activity Widgets */
.activity-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 30px;
}

.activity-card,
.alerts-card {
    padding: 25px;
}

.activity-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid var(--border-glass);
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-time {
    font-weight: 600;
    color: var(--accent);
}

.activity-desc {
    color: var(--text-secondary);
    font-size: 14px;
}

/* Setup Wizard Styles */
.setup-steps-list {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-bottom: 40px;
}

.setup-step {
    background: var(--bg-card);
    backdrop-filter: blur(40px);
    border: 1px solid var(--border-glass);
    border-radius: 16px;
    padding: 24px;
    transition: all 0.3s ease;
}

.setup-step:hover {
    border-color: var(--accent);
    box-shadow: 0 8px 25px rgba(124, 77, 255, 0.1);
}

.step-header {
    display: flex;
    align-items: flex-start;
    gap: 16px;
    margin-bottom: 16px;
}

.step-number {
    width: 40px;
    height: 40px;
    background: var(--accent);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 16px;
    flex-shrink: 0;
}

.step-info {
    flex: 1;
}

.step-info h3 {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 4px;
    color: var(--text-primary);
}

.step-info p {
    color: var(--text-secondary);
    font-size: 14px;
    line-height: 1.4;
}

.step-status {
    flex-shrink: 0;
}

.status-text {
    font-size: 12px;
    font-weight: 600;
    padding: 4px 12px;
    border-radius: 20px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-text.ok {
    background: rgba(0, 230, 118, 0.1);
    color: var(--success);
}

.status-text.warn {
    background: rgba(255, 193, 7, 0.1);
    color: #ffc107;
}

.status-text.error {
    background: rgba(255, 77, 77, 0.1);
    color: #ff4d4d;
}

.status-text.pending {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-secondary);
}

.step-content {
    color: var(--text-secondary);
    line-height: 1.6;
}

.step-content p {
    margin-bottom: 16px;
}

.webhook-waiting {
    text-align: center;
    padding: 20px;
    background: rgba(124, 77, 255, 0.1);
    border-radius: 12px;
    margin-top: 16px;
}

.waiting-indicator {
    color: var(--accent);
    font-weight: 600;
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
    .glass-container {
        flex-direction: column;
        padding: 0;
        height: 100vh;
    }

    .top-bar {
        flex-direction: column;
        height: auto;
        padding: 10px;
        gap: 10px;
    }

    .mobile-collapsible {
        width: 100%;
        background: var(--bg-card);
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-glass);
        border-radius: 12px;
        overflow: hidden;
    }

    .collapsible-header {
        padding: 12px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
    }

    .collapsible-header::after {
        content: '‚ñº';
        transition: transform 0.3s ease;
        font-size: 12px;
    }

    .mobile-collapsible.collapsed .collapsible-header::after {
        transform: rotate(-90deg);
    }

    .collapsible-content {
        max-height: 200px;
        overflow-y: auto;
        transition: max-height 0.3s ease;
    }

    .mobile-collapsible.collapsed .collapsible-content {
        max-height: 0;
    }

    .health-strip {
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
        padding: 10px;
    }

    .service-pill {
        font-size: 11px;
        padding: 4px 8px;
    }

    .last-signals {
        flex-direction: column;
        gap: 8px;
        align-items: stretch;
        padding: 10px;
    }

    .signal-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .signal-label {
        font-size: 9px;
    }

    .signal-value {
        font-size: 11px;
    }

    .top-actions {
        justify-content: center;
        padding: 10px;
        gap: 15px;
    }

    .version-badge {
        align-self: center;
        font-size: 11px;
        padding: 3px 8px;
    }

    .sidebar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        padding: 10px;
        background: var(--bg-card);
        backdrop-filter: blur(20px);
        border-top: 1px solid var(--border-glass);
        border-radius: 20px 20px 0 0;
        z-index: 100;
        display: flex;
        flex-direction: column;
        height: auto;
        max-height: 60vh;
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        transform: translateY(100%);
    }

    .sidebar.visible {
        transform: translateY(0);
    }

    .sidebar-toggle {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 50px;
        height: 50px;
        background: var(--accent);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 101;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
    }

    .sidebar-toggle::before {
        content: '‚ò∞';
        color: white;
        font-size: 20px;
        transition: transform 0.3s ease;
    }

    .sidebar .logo {
        display: flex;
        justify-content: flex-start;
        margin-bottom: 15px;
        padding-left: 10px;
    }

    .sidebar nav {
        display: flex;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        gap: 10px;
        padding: 0 10px;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    .sidebar nav::-webkit-scrollbar {
        display: none;
    }

    .nav-item {
        flex: 0 0 auto;
        text-align: center;
        padding: 12px 8px;
        margin: 0;
        font-size: 11px;
        flex-direction: column;
        gap: 4px;
        min-width: 70px;
        scroll-snap-align: start;
        border-radius: 12px;
        transition: all 0.2s ease;
    }

    .nav-item:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .nav-item.active {
        background: var(--accent);
        color: white;
    }

    .nav-item .icon {
        font-size: 20px;
    }

    .sidebar-footer {
        display: none;
    }

    .content {
        flex: 1;
        overflow-y: auto;
        padding-bottom: 80px;
    }

    .view {
        padding-bottom: 20px;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .form-grid {
        grid-template-columns: 1fr;
    }

    .form-group.full {
        grid-column: span 1;
    }

    .tour-card {
        padding: 30px 20px;
        max-width: 90%;
    }

    .tour-buttons {
        flex-direction: column;
        gap: 10px;
    }

    .tour-skip,
    .tour-next {
        width: 100%;
    }

    /* Credentials Mobile Styles */
    .creds-table-container {
        padding: 15px;
    }

    .data-table th,
    .data-table td {
        padding: 12px 8px;
        font-size: 14px;
    }

    .data-table th:nth-child(4),
    .data-table td:nth-child(4) {
        min-width: 120px;
    }
}

/* END OF MOBILE MEDIA QUERY - VITAL FIX */

/* Analytics Styles */
.analytics-controls {
    display: flex;
    gap: 15px;
    align-items: center;
    margin-bottom: 30px;
    justify-content: center;
}

.analytics-controls select {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-glass);
    padding: 10px 15px;
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 14px;
    min-width: 150px;
}

.analytics-kpis {
    padding: 30px;
    margin-bottom: 40px;
}

.analytics-kpis h3 {
    margin-bottom: 30px;
    color: var(--text-primary);
    text-align: center;
    font-size: 24px;
    font-weight: 600;
}

.kpis-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 25px;
    max-width: 1200px;
    margin: 0 auto;
}

.kpi-card {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--border-glass);
    border-radius: 16px;
    padding: 25px;
    text-align: center;
    transition: var(--transition);
}

.kpi-card:hover {
    background: rgba(255, 255, 255, 0.05);
    transform: translateY(-2px);
}

.kpi-value {
    font-size: 36px;
    font-weight: 800;
    color: var(--accent);
    margin-bottom: 10px;
    display: block;
}

.kpi-label {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 6px;
}

.kpi-meta {
    font-size: 13px;
    color: var(--text-secondary);
}

.analytics-charts {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
    gap: 30px;
    margin-bottom: 40px;
    max-width: 1400px;
    margin-left: auto;
    margin-right: auto;
}

.chart-container {
    padding: 25px;
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid var(--border-glass);
    border-radius: 16px;
}

.chart-container h3 {
    margin-bottom: 25px;
    color: var(--text-primary);
    text-align: center;
    font-size: 20px;
    font-weight: 600;
}

.chart-placeholder {
    height: 280px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.01);
    border-radius: 12px;
    border: 1px solid var(--border-glass);
}

.chart-empty {
    text-align: center;
    color: var(--text-secondary);
}

.empty-icon {
    font-size: 56px;
    margin-bottom: 15px;
    opacity: 0.4;
}

.analytics-tables {
    margin-bottom: 30px;
}

.table-section {
    padding: 25px;
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid var(--border-glass);
    border-radius: 16px;
    max-width: 1400px;
    margin: 0 auto;
}

.table-section h3 {
    margin-bottom: 25px;
    color: var(--text-primary);
    text-align: center;
    font-size: 20px;
    font-weight: 600;
}

.empty-row {
    text-align: center;
    padding: 40px 20px;
}

.table-empty {
    color: var(--text-secondary);
}

.table-empty .empty-icon {
    font-size: 32px;
    margin-bottom: 10px;
}

/* Severity Badges */
.severity-badge {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
}

.severity-info {
    background: rgba(0, 123, 255, 0.1);
    color: #007bff;
}

.severity-warn {
    background: rgba(255, 193, 7, 0.1);
    color: #ffc107;
}

.severity-error {
    background: rgba(220, 53, 69, 0.1);
    color: #dc3545;
}

.severity-debug {
    background: rgba(108, 117, 125, 0.1);
    color: #6c757d;
}

/* Analytics Mobile Styles */
@media (max-width: 768px) {
    .analytics-controls {
        flex-direction: column;
        align-items: stretch;
    }

    .analytics-controls select {
        width: 100%;
    }

    .kpis-grid {
        grid-template-columns: 1fr;
    }

    .analytics-charts {
        grid-template-columns: 1fr;
    }

    .chart-container {
        padding: 15px;
    }
}

/* WhatsApp Meta API Styles */
.whatsapp-meta-info {
    padding: 30px;
    max-width: 100%;
}

.whatsapp-meta-info h3 {
    text-align: center;
    margin-bottom: 30px;
    color: var(--text-primary);
    font-size: 24px;
    font-weight: 600;
}

.setup-steps {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.step {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--border-glass);
    border-radius: 12px;
    padding: 20px;
    transition: var(--transition);
    text-align: center;
    max-width: 600px;
    margin: 0 auto;
}

.step:hover {
    background: rgba(255, 255, 255, 0.05);
    transform: translateY(-2px);
}

.step h4 {
    color: var(--accent);
    margin-bottom: 10px;
    font-size: 16px;
    font-weight: 600;
    text-align: center;
}

.step p {
    color: var(--text-secondary);
    line-height: 1.5;
    margin-bottom: 10px;
    font-size: 14px;
    text-align: center;
}

.step p a {
    color: var(--accent);
    text-decoration: none;
}

.step p a:hover {
    text-decoration: underline;
}

.step-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.test-result-container {
    margin-bottom: 20px;
    min-height: 40px;
}

.warning-note {
    background: rgba(255, 193, 7, 0.1);
    border: 1px solid rgba(255, 193, 7, 0.3);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    color: #ffc107;
    font-size: 14px;
    line-height: 1.5;
}

.warning-note strong {
    display: block;
    margin-bottom: 10px;
    font-size: 16px;
}

/* WhatsApp Meta API Mobile Styles */
@media (max-width: 768px) {
    .whatsapp-meta-info {
        padding: 20px;
    }

    .whatsapp-meta-info h3 {
        font-size: 20px;
        margin-bottom: 20px;
    }

    .setup-steps {
        gap: 15px;
    }

    .step {
        padding: 15px;
    }

    .step-actions {
        flex-direction: column;
        align-items: stretch;
    }

    .step-actions .btn-secondary,
    .step-actions .btn-primary {
        width: 100%;
    }

    .warning-note {
        padding: 15px;
        font-size: 13px;
    }
}


/* Console Styles */
.console-controls {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.console-filters {
    padding: 20px;
    margin-bottom: 20px;
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    align-items: center;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
    min-width: 200px;
}

.filter-group label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.filter-group input,
.filter-group select {
    padding: 8px 12px;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-glass);
    color: var(--text-primary);
    font-size: 14px;
}

.console-container {
    height: 70vh;
    overflow: hidden;
    position: relative;
}

.console-output {
    height: 100%;
    overflow-y: auto;
    padding: 20px;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    line-height: 1.4;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
}

.console-welcome {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-secondary);
}

.welcome-icon {
    font-size: 48px;
    margin-bottom: 20px;
}

.console-tips {
    margin-top: 30px;
    text-align: left;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
}

.console-tips ul {
    list-style: none;
    padding: 0;
}

.console-tips li {
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.console-event {
    margin-bottom: 15px;
    padding: 12px 15px;
    border-radius: 8px;
    border-left: 4px solid var(--accent);
    background: rgba(255, 255, 255, 0.02);
    transition: all 0.2s ease;
}

.console-event:hover {
    background: rgba(255, 255, 255, 0.05);
    transform: translateX(2px);
}

.console-event.severity-debug {
    border-left-color: #666;
}

.console-event.severity-info {
    border-left-color: var(--success);
}

.console-event.severity-warn {
    border-left-color: #ffc107;
    background: rgba(255, 193, 7, 0.05);
}

.console-event.severity-error {
    border-left-color: #ff4d4d;
    background: rgba(255, 77, 77, 0.05);
}

.event-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 8px;
    flex-wrap: wrap;
}

.event-time {
    font-size: 11px;
    color: var(--text-secondary);
    font-weight: 600;
}

.event-type {
    background: var(--accent);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.event-severity {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 8px;
    text-transform: uppercase;
    font-weight: 600;
}

.event-severity.info {
    background: rgba(0, 230, 118, 0.2);
    color: var(--success);
}

.event-severity.warn {
    background: rgba(255, 193, 7, 0.2);
    color: #ffc107;
}

.event-severity.error {
    background: rgba(255, 77, 77, 0.2);
    color: #ff4d4d;
}

.event-severity.debug {
    background: rgba(102, 102, 102, 0.2);
    color: #666;
}

.event-source {
    font-size: 11px;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 4px;
}

.event-details {
    margin-left: 10px;
}

.event-correlation {
    font-size: 11px;
    color: var(--accent);
    margin-bottom: 5px;
    font-family: 'Courier New', monospace;
}

.detail-item {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 3px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.console-loading,
.console-error,
.console-empty {
    text-align: center;
    padding: 40px;
    color: var(--text-secondary);
}

.console-error {
    color: #ff4d4d;
}

.console-empty {
    color: var(--text-secondary);
}

/* Console Animations */
@keyframes consoleFadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.console-event {
    animation: consoleFadeIn 0.3s ease-out;
}

/* Console Scrollbar */
.console-output::-webkit-scrollbar {
    width: 8px;
}

.console-output::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
}

.console-output::-webkit-scrollbar-thumb {
    background: var(--accent);
    border-radius: 4px;
}

.console-output::-webkit-scrollbar-thumb:hover {
    background: var(--accent-glow);
}

@media (max-width: 768px) {
    .console-filters {
        flex-direction: column;
        align-items: stretch;
    }

    .filter-group {
        min-width: auto;
    }

    .console-controls {
        justify-content: center;
    }

    .event-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
    }

    .console-container {
        height: 60vh;
    }
}

@media (max-width: 480px) {
    .sidebar {
        padding: 15px 5px;
    }

    .nav-item {
        padding: 12px 15px;
        font-size: 14px;
    }

    .logo-text {
        font-size: 18px;
    }

    .view-title {
        font-size: 24px;
    }

    .stat-card {
        padding: 20px;
    }

    .stat-value {
        font-size: 28px;
    }

    .data-table th,
    .data-table td {
        padding: 15px 10px;
        font-size: 14px;
    }

    .modal {
        width: 95%;
        padding: 30px 20px;
    }

    .console-filters {
        padding: 15px;
        gap: 15px;
    }

    .console-controls {
        flex-direction: column;
        align-items: stretch;
    }

    .console-controls .btn-primary,
    .console-controls .btn-secondary {
        width: 100%;
    }

    /* WhatsApp Meta API Mobile Styles */
    .whatsapp-meta-info {
        padding: 20px 15px;
    }

    .setup-steps .step {
        padding: 15px;
        gap: 10px;
    }

    .setup-steps .step .service-icon {
        font-size: 28px;
    }

    .setup-steps .step h4 {
        font-size: 14px;
    }

    .setup-steps .step p {
        font-size: 13px;
        line-height: 1.4;
    }

    .warning-note {
        padding: 15px;
        margin: 20px 15px;
    }

    /* --- Mobile Stores Table (Card Layout) --- */
    /* Force table to be not a table */
    .data-table,
    .data-table tbody,
    .data-table tr,
    .data-table td {
        display: block;
        width: 100%;
    }

    /* Hide headers */
    .data-table thead {
        display: none;
    }

    /* Card Style for Rows */
    .data-table tr {
        margin-bottom: 20px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border-glass);
        border-radius: 16px;
        padding: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    /* Cell Style */
    .data-table td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        text-align: right;
        padding: 12px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        min-height: 40px;
        font-size: 14px;
        overflow-wrap: break-word;
        word-break: break-all;
        /* Safety for long IDs */
    }

    .data-table td:last-child {
        border-bottom: none;
        flex-direction: column;
        gap: 10px;
        justify-content: center;
        padding-top: 20px;
    }

    /* Inject Labels via CSS */
    .data-table td:nth-of-type(1)::before {
        content: "Tienda";
        font-weight: 600;
        color: var(--text-secondary);
        text-align: left;
        margin-right: 10px;
        flex-shrink: 0;
    }

    .data-table td:nth-of-type(2)::before {
        content: "WhatsApp";
        font-weight: 600;
        color: var(--text-secondary);
        text-align: left;
        margin-right: 10px;
        flex-shrink: 0;
    }

    .data-table td:nth-of-type(3)::before {
        content: "Tienda Nube ID";
        font-weight: 600;
        color: var(--text-secondary);
        text-align: left;
        margin-right: 10px;
        flex-shrink: 0;
    }

    .data-table td:nth-of-type(4)::before {
        content: "Status";
        font-weight: 600;
        color: var(--text-secondary);
        text-align: left;
        margin-right: 10px;
        flex-shrink: 0;
    }

    /* No label for Actions */

    /* Action Buttons Adjustments */
    .data-table td button {
        width: 100%;
        /* Full width buttons for touch targets */
        margin: 5px 0;
    }

    /* Global Horizontal Overflow Protection for Mobile */
    body,
    .glass-container,
    .content,
    .view,
    .stores-table-container {
        overflow-x: hidden !important;
        max-width: 100vw;
    }
}

/* Service Selection Modal Styles */
.service-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin: 30px 0;
}

.service-card {
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.service-card:hover {
    background: rgba(255, 255, 255, 0.05);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(124, 77, 255, 0.15);
}

.service-card.configured {
    border-color: var(--success);
    background: rgba(0, 230, 118, 0.05);
}

.service-card.not-configured {
    border-color: rgba(255, 77, 77, 0.3);
    background: rgba(255, 77, 77, 0.05);
}

.service-icon {
    font-size: 48px;
    margin-bottom: 16px;
    display: block;
}

.service-card h3 {
    color: var(--text-primary);
    margin-bottom: 8px;
    font-size: 18px;
    font-weight: 600;
}

.service-card p {
    color: var(--text-secondary);
    font-size: 14px;
    line-height: 1.4;
    margin-bottom: 16px;
}

.service-status {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: 16px;
}

.status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--text-secondary);
    transition: all 0.3s ease;
}

.status-dot.configured {
    background: var(--success);
    box-shadow: 0 0 10px rgba(0, 230, 118, 0.3);
}

.status-dot.not-configured {
    background: #ff4d4d;
    box-shadow: 0 0 10px rgba(255, 77, 77, 0.3);
}

.status-text {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.modal-description {
    color: var(--text-secondary);
    text-align: center;
    margin-bottom: 20px;
    font-size: 16px;
}

/* Tenant Detail Modal Styles */
.tenant-info-section,
.whatsapp-status-section,
.credentials-section {
    margin-bottom: 20px;
    padding: 20px;
}

.tenant-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.info-item label {
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.info-item span {
    color: var(--text-primary);
    font-size: 14px;
}

.status-blocks {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 15px;
}

.status-block {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 20px;
    background: rgba(255, 255, 255, 0.02);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.status-icon {
    font-size: 32px;
    opacity: 0.8;
}

.status-info {
    flex: 1;
}

.status-info h4 {
    margin: 0 0 10px 0;
    color: var(--text-primary);
    font-size: 16px;
    font-weight: 600;
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--text-secondary);
}

.status-dot.connected {
    background: var(--success);
    box-shadow: 0 0 10px rgba(0, 230, 118, 0.3);
}

.status-dot.not-connected {
    background: var(--accent);
}

.status-dot.error {
    background: #ff4d4d;
}

.status-text {
    font-size: 14px;
    color: var(--text-secondary);
}

.status-details {
    font-size: 12px;
    color: var(--text-secondary);
    line-height: 1.4;
}

.credentials-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.tab-btn {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    padding: 10px 15px;
    border-radius: 8px 8px 0 0;
    cursor: pointer;
    transition: var(--transition);
}

.tab-btn.active {
    background: var(--accent);
    color: white;
}

.credentials-list {
    max-height: 300px;
    overflow-y: auto;
}

.credential-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: rgba(255, 255, 255, 0.02);
    border-radius: 8px;
    margin-bottom: 8px;
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.credential-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.credential-name {
    font-weight: 600;
    color: var(--text-primary);
}

.credential-scope {
    font-size: 12px;
    color: var(--text-secondary);
    text-transform: uppercase;
}

.credential-value {
    font-family: monospace;
    color: var(--accent);
    font-size: 14px;
}

/* --- Human Handoff Configuration Styles --- */
.handoff-config-section {
    border: 1px solid var(--border-glass);
    animation: fadeIn 0.5s ease-out;
}

.help-text {
    display: block;
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 5px;
    font-style: italic;
}

.smtp-config-box {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 12px;
}

.switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    -webkit-transition: .4s;
    transition: .4s;
}

.slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    -webkit-transition: .4s;
    transition: .4s;
}

input:checked+.slider {
    background-color: var(--accent);
}

input:focus+.slider {
    box-shadow: 0 0 1px var(--accent);
}

input:checked+.slider:before {
    -webkit-transform: translateX(26px);
    -ms-transform: translateX(26px);
    transform: translateX(26px);
}

.slider.round {
    border-radius: 34px;
}

.slider.round:before {
    border-radius: 50%;
}

.btn-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: var(--transition);
}

.btn-close:hover {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-primary);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

/* Chats View Styles */
.chats-layout {
    display: flex;
    height: calc(100vh - 140px);
    /* Adjust based on top bar height */
    gap: 20px;
}

.chat-list-container {
    width: 350px;
    display: flex;
    flex-direction: column;
    padding: 20px;
}

.chat-list-header {
    margin-bottom: 20px;
    display: flex;
    gap: 10px;
}

.chat-list-header input {
    flex: 1;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-glass);
    padding: 10px;
    border-radius: 12px;
    color: #fff;
    outline: none;
}

.chat-list {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.chat-item {
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid transparent;
    border-radius: 12px;
    padding: 15px;
    cursor: pointer;
    transition: var(--transition);
}

.chat-item:hover {
    background: rgba(255, 255, 255, 0.05);
}

.chat-item.active {
    background: rgba(124, 77, 255, 0.1);
    border-color: var(--accent);
}

.chat-item-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
}

.chat-item-phone {
    font-weight: 600;
    color: #fff;
}

.chat-item-date {
    font-size: 11px;
    color: var(--text-secondary);
}

.chat-item-preview {
    font-size: 13px;
    color: var(--text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.chat-window-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 0;
    overflow: hidden;
}

.chat-empty-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--text-secondary);
    text-align: center;
}

.chat-empty-state .empty-icon {
    font-size: 48px;
    margin-bottom: 20px;
    opacity: 0.5;
}

#chat-interface {
    display: flex;
    flex-direction: column;
    height: 100%;
}

.chat-header {
    padding: 20px;
    border-bottom: 1px solid var(--border-glass);
    display: flex;
    align-items: center;
    gap: 15px;
    background: rgba(0, 0, 0, 0.2);
}

.chat-avatar {
    width: 40px;
    height: 40px;
    background: var(--accent);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    /* Fix: Prevent horizontal scroll */
    width: 100%;
    /* Fix: Constrain width */
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.message-bubble {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 16px;
    position: relative;
    font-size: 14px;
    line-height: 1.5;

    /* Fix: Word break rules */
    overflow-wrap: break-word;
    word-wrap: break-word;
    word-break: break-word;
    hyphens: auto;
    min-width: 0;
    /* Flexbox safety */
}

/* Fix: Internal Content Safety */
.bubble-content p,
.bubble-content a {
    overflow-wrap: break-word;
    word-break: break-word;
}

.bubble-content img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    display: block;
    /* Remove inline spacing */
}

/* Fix: Technical Text / Code Blocks */
.bubble-content pre,
.bubble-content code {
    white-space: pre-wrap;
    word-break: break-word;
    overflow-x: hidden;
    max-width: 100%;
}

.message-bubble.user {
    align-self: flex-start;
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    border-bottom-left-radius: 4px;
}

.message-bubble.assistant {
    align-self: flex-end;
    background: var(--accent);
    color: #fff;
    border-bottom-right-radius: 4px;
}

/* Human Supervisor Styling */
.message-bubble.human {
    align-self: flex-end;
    background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
    color: #000;
    border-bottom-right-radius: 4px;
    font-weight: 500;
    box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2);
}

.message-label {
    font-size: 10px;
    margin-bottom: 4px;
    opacity: 0.8;
    text-transform: uppercase;
    font-weight: 700;
}

.message-time {
    font-size: 10px;
    opacity: 0.6;
    margin-top: 4px;
    text-align: right;
    display: block;
}

.chat-input-area {
    padding: 20px;
    background: rgba(0, 0, 0, 0.2);
    border-top: 1px solid var(--border-glass);
    display: flex;
    gap: 10px;
}

.chat-input-area textarea {
    flex: 1;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-glass);
    padding: 12px;
    border-radius: 12px;
    color: #fff;
    outline: none;
    resize: none;
    height: 50px;
}

.chat-input-area textarea:focus {
    border-color: var(--accent);
}

.btn-icon {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 8px;
    border-radius: 8px;
    transition: var(--transition);
}

.btn-icon:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
}

.image-preview {
    max-width: 100%;
    border-radius: 8px;
    margin-top: 5px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

/* Mobile Chat Adaptation (WhatsApp Style) */
@media (max-width: 768px) {
    .chats-layout {
        gap: 0;
        height: calc(100vh - 80px);
        /* Tighter for mobile */
    }

    .chat-list-container {
        width: 100%;
        border: none;
        padding: 10px;
    }

    .chat-window-container {
        width: 100%;
        height: 100%;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1000;
        background: var(--bg-dark);
        display: none;
        /* Hidden by default on mobile */
    }

    /* When a chat is active on mobile */
    .chats-layout.mobile-chat-active .chat-list-container {
        display: none;
    }

    .chats-layout.mobile-chat-active .chat-window-container {
        display: flex;
    }

    /* Mobile Chat Header */
    .chat-header {
        padding: 15px;
        display: flex;
        align-items: center;
        gap: 12px;
        background: rgba(0, 0, 0, 0.4);
    }

    .btn-back {
        display: flex !important;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: none;
        color: #fff;
        font-size: 24px;
        cursor: pointer;
        padding: 5px;
        margin-right: 5px;
    }

    .chat-avatar {
        width: 35px;
        height: 35px;
    }

    .chat-info h3 {
        font-size: 16px;
    }

    /* Chat Messages optimization */
    .chat-messages {
        padding: 15px;
    }

    .message-bubble {
        max-width: 85%;
        font-size: 15px;
    }

    /* Input Area Fixed */
    .chat-input-area {
        padding: 10px;
        position: sticky;
        bottom: 0;
        background: var(--bg-dark);
    }
}

/* Simple CSS Bar Chart */
.simple-bar-chart {
    display: flex;
    align-items: flex-end;
    /* justify-content: space-around; REMOVED to allow scrolling */
    height: 100%;
    gap: 15px;
    /* Increased gap */
    padding-top: 20px;
    padding-bottom: 30px;
    position: relative;
    overflow-x: auto;
    /* Allow horizontal scroll */
    padding-left: 10px;
    padding-right: 10px;
    width: 100%;
    /* Ensure it takes full width */
}

/* Scrollbar for chart */
.simple-bar-chart::-webkit-scrollbar {
    height: 6px;
}

.simple-bar-chart::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
}

.bar-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 0 0 auto;
    /* Don't shrink, allow scroll */
    width: 40px;
    /* Fixed width per bar group */
    height: 100%;
    justify-content: flex-end;
    position: relative;
    cursor: pointer;
}

.bar {
    width: 24px;
    /* Fixed bar width */
    background: var(--accent);
    border-radius: 4px 4px 0 0;
    transition: height 0.5s ease;
    opacity: 0.8;
    position: relative;
}

.bar:hover {
    opacity: 1;
    transform: scaleY(1.05);
    transform-origin: bottom;
}

.bar-value {
    position: absolute;
    top: -25px;
    font-size: 11px;
    color: #fff;
    font-weight: 600;
}

.bar-label {
    position: absolute;
    bottom: -25px;
    font-size: 11px;
    color: var(--text-secondary);
    text-align: center;
    width: 100%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.chart-legend {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 15px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 12px;
    color: var(--text-secondary);
}

.legend-color {
    width: 12px;
    height: 12px;
    border-radius: 3px;
}
````

## File: shared/__init__.py
````python
# Shared models and utilities for microservices
````

## File: shared/models_dental.py
````python
"""
MODELOS PYDANTIC - FASE 1: Dental Platform DTOs

Extensi√≥n de shared/models.py con tipos para pacientes, turnos, historias cl√≠nicas
y transacciones. Estos DTOs se usan en:
- Solicitudes API (FastAPI request/response)
- Validaci√≥n de datos
- Serializaci√≥n JSON

Estos modelos son agn√≥sticos a la base de datos (no usan SQLAlchemy).
"""

from typing import Any, Dict, List, Optional, Union, Literal
from pydantic import BaseModel, Field, EmailStr, validator
from datetime import datetime, date
from decimal import Decimal


# ==================== PACIENTES ====================

class PatientMedicalHistory(BaseModel):
    """Anamnesis del paciente"""
    allergies: List[str] = Field(default=[], description="Alergias conocidas")
    medical_conditions: List[str] = Field(default=[], description="Condiciones m√©dicas")
    medications: List[str] = Field(default=[], description="Medicamentos actuales")
    past_treatments: List[str] = Field(default=[], description="Tratamientos previos")
    systemic_diseases: bool = Field(default=False, description="¬øEnfermedades sist√©micas?")
    last_checkup: Optional[str] = Field(default=None, description="√öltima revisi√≥n (ISO date)")
    notes: Optional[str] = Field(default=None)
    
    class Config:
        schema_extra = {
            "example": {
                "allergies": ["Penicilina", "Ibuprofeno"],
                "medical_conditions": ["Diabetes Tipo 2", "Hipertensi√≥n"],
                "medications": ["Metformina 1000mg", "Losart√°n 50mg"],
                "systemic_diseases": True,
                "last_checkup": "2024-10-15"
            }
        }


class PatientCreate(BaseModel):
    """Crear un nuevo paciente"""
    phone_number: str = Field(..., description="N√∫mero de WhatsApp")
    dni: str = Field(..., description="Documento Nacional de Identidad")
    first_name: str
    last_name: str
    birth_date: Optional[date] = None
    gender: Optional[Literal["M", "F", "Other"]] = None
    email: Optional[str] = None
    alternative_phone: Optional[str] = None
    insurance_provider: Optional[str] = None
    insurance_id: Optional[str] = None
    insurance_valid_until: Optional[date] = None
    medical_history: Optional[PatientMedicalHistory] = None
    preferred_schedule: Optional[str] = None
    notes: Optional[str] = None


class PatientUpdate(BaseModel):
    """Actualizar datos de paciente"""
    first_name: Optional[str] = None
    last_name: Optional[str] = None
    birth_date: Optional[date] = None
    gender: Optional[Literal["M", "F", "Other"]] = None
    email: Optional[str] = None
    alternative_phone: Optional[str] = None
    insurance_provider: Optional[str] = None
    insurance_id: Optional[str] = None
    insurance_valid_until: Optional[date] = None
    medical_history: Optional[PatientMedicalHistory] = None
    preferred_schedule: Optional[str] = None
    notes: Optional[str] = None
    status: Optional[Literal["active", "inactive", "archived"]] = None


class PatientResponse(BaseModel):
    """Respuesta GET paciente"""
    id: int
    tenant_id: int
    phone_number: str
    dni: str
    first_name: str
    last_name: str
    birth_date: Optional[date] = None
    gender: Optional[str] = None
    email: Optional[str] = None
    alternative_phone: Optional[str] = None
    insurance_provider: Optional[str] = None
    insurance_id: Optional[str] = None
    insurance_valid_until: Optional[date] = None
    medical_history: Dict[str, Any] = {}
    preferred_schedule: Optional[str] = None
    notes: Optional[str] = None
    status: str
    last_visit: Optional[datetime] = None
    created_at: datetime
    updated_at: datetime
    
    class Config:
        from_attributes = True


# ==================== PROFESIONALES ====================

class ProfessionalSchedule(BaseModel):
    """Horarios del profesional por d√≠a"""
    monday: List[str] = Field(default=[], example=["09:00-13:00", "14:00-18:00"])
    tuesday: List[str] = Field(default=[])
    wednesday: List[str] = Field(default=[])
    thursday: List[str] = Field(default=[])
    friday: List[str] = Field(default=[])
    saturday: Optional[List[str]] = Field(default=None)
    sunday: Optional[List[str]] = Field(default=None)


class ProfessionalCreate(BaseModel):
    """Crear un profesional"""
    first_name: str
    last_name: str
    license_number: str = Field(..., description="Matr√≠cula profesional")
    specialization: Optional[str] = Field(None, example="Endodoncia")
    email: Optional[str] = None
    phone: Optional[str] = None
    schedule_json: Optional[ProfessionalSchedule] = None


class ProfessionalResponse(BaseModel):
    """Respuesta GET profesional"""
    id: int
    tenant_id: int
    first_name: str
    last_name: str
    license_number: str
    specialization: Optional[str]
    email: Optional[str]
    phone: Optional[str]
    is_active: bool
    schedule_json: Dict[str, Any]
    created_at: datetime
    updated_at: datetime
    
    class Config:
        from_attributes = True


# ==================== ODONTOGRAMA (Tooth Data) ====================

class ToothSurface(BaseModel):
    """Estado de una superficie del diente"""
    occlusal: Optional[Literal["healthy", "caries", "treated"]] = "healthy"
    mesial: Optional[Literal["healthy", "caries", "treated"]] = "healthy"
    distal: Optional[Literal["healthy", "caries", "treated"]] = "healthy"
    buccal: Optional[Literal["healthy", "caries", "treated"]] = "healthy"
    lingual: Optional[Literal["healthy", "caries", "treated"]] = "healthy"


class ToothData(BaseModel):
    """Datos de un diente en el odontograma"""
    number: int = Field(..., description="N√∫mero FDI del diente (11-48)")
    tooth_type: Optional[Literal["incisor", "canine", "premolar", "molar"]] = None
    status: Literal["healthy", "caries", "missing", "implant", "crowned", "extracted", "root_canal"] = "healthy"
    surfaces: Optional[ToothSurface] = None
    color_code: Optional[str] = Field(None, description="C√≥digo de color para visualizaci√≥n")
    notes: Optional[str] = None
    treatment_date: Optional[date] = None


# ==================== HISTORIAS CL√çNICAS ====================

class ClinicalTreatment(BaseModel):
    """Un tratamiento realizado"""
    date: date
    type: Literal["cleaning", "filling", "extraction", "root_canal", "crown", "whitening", "scaling", "other"]
    description: str
    teeth: List[int] = Field(..., description="N√∫meros FDI de dientes tratados")
    duration_minutes: Optional[int] = None
    cost: Optional[Decimal] = None
    currency: Optional[str] = "ARS"
    insurance_covered: Optional[bool] = None
    professional_id: Optional[int] = None
    notes: Optional[str] = None


class Radiograph(BaseModel):
    """Una radiograf√≠a"""
    date: date
    type: Literal["panoramic", "intraoral", "bitewing", "periapical", "cephalometric"]
    storage_url: str = Field(..., description="URL de almacenamiento (S3, etc.)")
    preview_url: Optional[str] = None
    notes: Optional[str] = None


class TreatmentPlan(BaseModel):
    """Plan de tratamiento futuro"""
    created_date: Optional[date] = None
    estimated_sessions: Optional[int] = None
    planned_treatments: List[Dict[str, Any]] = Field(default=[])
    total_estimated_cost: Optional[Decimal] = None
    priority: Optional[Literal["low", "medium", "high"]] = None
    notes: Optional[str] = None


class ClinicalRecordCreate(BaseModel):
    """Crear historia cl√≠nica"""
    patient_id: int
    record_date: date
    professional_id: Optional[int] = None
    diagnosis: str
    clinical_notes: Optional[str] = None
    recommendations: Optional[str] = None
    odontogram: Optional[Dict[int, ToothData]] = None
    treatments: Optional[List[ClinicalTreatment]] = None
    radiographs: Optional[List[Radiograph]] = None
    treatment_plan: Optional[TreatmentPlan] = None


class ClinicalRecordResponse(BaseModel):
    """Respuesta GET historia cl√≠nica"""
    id: str
    tenant_id: int
    patient_id: int
    record_date: date
    professional_id: Optional[int]
    diagnosis: str
    clinical_notes: Optional[str]
    recommendations: Optional[str]
    odontogram: Dict[str, Any]
    treatments: List[Dict[str, Any]]
    radiographs: List[Dict[str, Any]]
    treatment_plan: Dict[str, Any]
    created_at: datetime
    updated_at: datetime
    
    class Config:
        from_attributes = True


# ==================== TURNOS / CITAS ====================

class AppointmentCreate(BaseModel):
    """Agendar un turno"""
    patient_id: int
    appointment_datetime: datetime
    duration_minutes: int = 60
    professional_id: Optional[int] = None
    chair_id: Optional[int] = None
    appointment_type: Literal["checkup", "cleaning", "treatment", "emergency", "followup"]
    notes: Optional[str] = None


class AppointmentUpdate(BaseModel):
    """Actualizar turno"""
    appointment_datetime: Optional[datetime] = None
    duration_minutes: Optional[int] = None
    professional_id: Optional[int] = None
    chair_id: Optional[int] = None
    appointment_type: Optional[str] = None
    notes: Optional[str] = None
    status: Optional[Literal["scheduled", "confirmed", "in-progress", "completed", "cancelled", "no-show"]] = None
    cancellation_reason: Optional[str] = None
    cancellation_by: Optional[str] = None


class AppointmentResponse(BaseModel):
    """Respuesta GET turno"""
    id: str
    tenant_id: int
    patient_id: int
    appointment_datetime: datetime
    duration_minutes: int
    professional_id: Optional[int]
    chair_id: Optional[int]
    appointment_type: str
    notes: Optional[str]
    google_calendar_event_id: Optional[str]
    google_calendar_sync_status: str
    urgency_level: str
    urgency_reason: Optional[str]
    status: str
    cancellation_reason: Optional[str]
    cancellation_by: Optional[str]
    reminder_sent: bool
    created_at: datetime
    updated_at: datetime
    completed_at: Optional[datetime]
    
    class Config:
        from_attributes = True


# ==================== HERRAMIENTAS (TOOLS RESPONSES) ====================

class AvailabilitySlot(BaseModel):
    """Un slot disponible"""
    datetime: datetime
    professional_id: Optional[int] = None
    chair_id: Optional[int] = None
    duration_minutes: int = 60


class CheckAvailabilityRequest(BaseModel):
    """Solicitud check_availability()"""
    date_str: str = Field(..., description="Fecha ISO: 2025-02-15")
    duration_minutes: int = 60
    professional_id: Optional[int] = None


class CheckAvailabilityResponse(BaseModel):
    """Respuesta check_availability()"""
    status: Literal["ok", "error"]
    available_slots: List[AvailabilitySlot] = []
    next_available: Optional[datetime] = None
    message: Optional[str] = None


class BookAppointmentRequest(BaseModel):
    """Solicitud book_appointment()"""
    patient_phone: str
    professional_id: int
    datetime_str: str = Field(..., description="ISO datetime: 2025-02-15T09:00:00")
    appointment_type: Literal["checkup", "cleaning", "treatment", "emergency", "followup"] = "checkup"
    duration_minutes: int = 60
    notes: Optional[str] = None


class BookAppointmentResponse(BaseModel):
    """Respuesta book_appointment()"""
    success: bool
    appointment_id: Optional[str] = None
    google_event_id: Optional[str] = None
    confirmation_message: str
    error: Optional[str] = None


class TriageUrgencyRequest(BaseModel):
    """Solicitud triage_urgency()"""
    user_message: str
    patient_id: Optional[int] = None


class TriageUrgencyResponse(BaseModel):
    """Respuesta triage_urgency()"""
    urgency_level: Literal["low", "normal", "high", "emergency"]
    reason: str
    recommended_action: str
    should_escalate: bool = False


# ==================== TRANSACCIONES ====================

class AccountingTransactionCreate(BaseModel):
    """Registrar una transacci√≥n contable"""
    patient_id: Optional[int] = None
    appointment_id: Optional[str] = None
    transaction_type: Literal["payment", "insurance_claim", "expense", "refund"]
    transaction_date: date
    amount: Decimal
    currency: str = "ARS"
    payment_method: Optional[str] = None
    description: Optional[str] = None
    insurance_claim_id: Optional[str] = None
    insurance_covered_amount: Decimal = Decimal("0")
    patient_paid_amount: Decimal = Decimal("0")
    recorded_by: Optional[str] = None


class AccountingTransactionResponse(BaseModel):
    """Respuesta GET transacci√≥n"""
    id: str
    tenant_id: int
    patient_id: Optional[int]
    appointment_id: Optional[str]
    transaction_type: str
    transaction_date: date
    amount: Decimal
    currency: str
    payment_method: Optional[str]
    description: Optional[str]
    status: str
    created_at: datetime
    
    class Config:
        from_attributes = True


class DailyCashFlowResponse(BaseModel):
    """Reporte de caja diaria"""
    id: int
    tenant_id: int
    cash_date: date
    total_cash_received: Decimal
    total_card_received: Decimal
    total_insurance_claimed: Decimal
    total_expenses: Decimal
    net_balance: Decimal
    recorded_by: Optional[str]
    notes: Optional[str]
    recorded_at: datetime
    
    class Config:
        from_attributes = True


# ==================== RESPUESTAS GEN√âRICAS ====================

class ErrorResponse(BaseModel):
    """Respuesta de error"""
    error: str
    code: str
    details: Optional[Dict[str, Any]] = None


class SuccessResponse(BaseModel):
    """Respuesta gen√©rica de √©xito"""
    success: bool = True
    message: str
    data: Optional[Dict[str, Any]] = None
````

## File: shared/models.py
````python
from typing import Any, Dict, List, Optional, Union, Literal
from pydantic import BaseModel, Field


# Tool response est√°ndar
class ToolError(BaseModel):
    code: str = Field(..., description="Error code, e.g., TN_RATE_LIMIT, TN_TIMEOUT, etc.")
    message: str
    retryable: bool
    details: Optional[Dict[str, Any]] = None


class ToolResponse(BaseModel):
    ok: bool
    data: Optional[Any] = None
    error: Optional[ToolError] = None
    meta: Optional[Dict[str, Any]] = None


# Webhook models (N8N envelope)
class InboundWebhookEnvelope(BaseModel):
    headers: Dict[str, str]
    body: Dict[str, Any]


class YCloudInboundMessage(BaseModel):
    id: str
    wamid: Optional[str] = None
    from_field: str = Field(..., alias="from")
    customerProfile: Dict[str, Any]
    type: str
    text: Optional[Dict[str, str]] = None
    audio: Optional[Dict[str, Any]] = None


class YCloudEvent(BaseModel):
    id: str
    type: str
    apiVersion: str
    createTime: str
    whatsappInboundMessage: YCloudInboundMessage


# Modelo para el forward al orquestador
class InboundChatEvent(BaseModel):
    provider: str
    event_id: str
    provider_message_id: str
    from_number: str
    text: str
    customer_name: Optional[str] = None
    event_type: str
    correlation_id: str


# Respuesta del orquestador al whatsapp_service
class OrchestratorResult(BaseModel):
    status: Literal["ok", "duplicate", "ignored", "error"]
    send: bool
    text: Optional[str] = None
    meta: Optional[Dict[str, Any]] = None
````

## File: tests/conftest.py
````python
import pytest
import os
from unittest.mock import MagicMock

# Set env vars before importing apps
os.environ["YCLOUD_API_KEY"] = "test_ycloud_key"
os.environ["YCLOUD_WEBHOOK_SECRET"] = "test_webhook_secret"
os.environ["INTERNAL_API_TOKEN"] = "test_internal_token"
os.environ["TIENDANUBE_API_KEY"] = "test_tn_key"
os.environ["OPENAI_API_KEY"] = "test_openai_key"
os.environ["POSTGRES_DSN"] = "postgresql://test:test@localhost:5432/test"
os.environ["REDIS_URL"] = "redis://localhost:6379"

@pytest.fixture
def mock_redis():
    mock = MagicMock()
    # Mock redis lock context manager
    mock.lock.return_value.acquire.return_value = True
    return mock

@pytest.fixture
def mock_db_pool():
    mock = MagicMock()
    return mock
````

## File: tests/test_orchestrator.py
````python
import pytest
from fastapi.testclient import TestClient
from unittest.mock import patch, AsyncMock, MagicMock

# Must mock dependencies before import because they are init at module level
with patch('redis.from_url'), \
     patch('db.db.connect', new_callable=AsyncMock), \
     patch('langchain_openai.ChatOpenAI'), \
     patch('orchestrator_service.main.db', new_callable=MagicMock) as mock_db_instance: # Mocking the 'db' IMPORTED in main
    
    from orchestrator_service.main import app
    
    # We need to ensure startup event works or is mocked?
    # TestClient doesn't run startup events by default unless using Asyncclient with lifespan, 
    # but for unit tests we often just need endpoints.
    # However, 'db' is global. We mocked it above.
    
    client = TestClient(app)

    @pytest.mark.asyncio
    async def test_auth_internal_required():
        # Using async client or standard client? Standard client is sync but calls async endpoints fine (fastapi magic)
        response = client.post("/chat", json={
            "provider": "test",
            "event_id": "1",
            "provider_message_id": "1",
            "from_number": "123",
            "text": "hola",
            "event_type": "text",
            "correlation_id": "1"
        })
        assert response.status_code == 422 # Missing header
        
        response = client.post("/chat", json={
            "provider": "test",
            "event_id": "1",
            "provider_message_id": "1",
            "from_number": "123",
            "text": "hola",
            "event_type": "text",
            "correlation_id": "1"
        }, headers={"X-Internal-Token": "wrong"})
        assert response.status_code == 401

    @patch("orchestrator_service.main.db.try_insert_inbound", new_callable=AsyncMock)
    @patch("orchestrator_service.main.db.mark_inbound_processing", new_callable=AsyncMock)
    @patch("orchestrator_service.main.db.append_chat_message", new_callable=AsyncMock)
    @patch("orchestrator_service.main.db.mark_inbound_done", new_callable=AsyncMock)
    @patch("orchestrator_service.main.redis_client.lock")
    @patch("orchestrator_service.main.AgentExecutor")
    def test_dedupe_option_a(mock_agent_executor, mock_lock, mock_mark_done, mock_append, mock_mark_proc, mock_try_insert):
        # Setup mocks
        mock_try_insert.return_value = True # First time: is_new = True
        mock_lock.return_value.acquire.return_value = True
        
        mock_agent_instance = MagicMock()
        mock_agent_instance.ainvoke = AsyncMock(return_value={"output": "Response from agent"})
        mock_agent_executor.return_value = mock_agent_instance

        payload = {
            "provider": "test",
            "event_id": "evt_1",
            "provider_message_id": "msg_1",
            "from_number": "12345",
            "text": "hola",
            "event_type": "text",
            "correlation_id": "corr_1"
        }
        headers = {"X-Internal-Token": "test_internal_token"}

        # First call: OK
        response = client.post("/chat", json=payload, headers=headers)
        assert response.status_code == 200
        data = response.json()
        assert data["status"] == "ok"
        assert data["send"] is True
        assert data["text"] == "Response from agent"
        
        # Second call: Duplicate
        mock_try_insert.return_value = False # is_new = False
        response = client.post("/chat", json=payload, headers=headers)
        assert response.status_code == 200
        data = response.json()
        assert data["status"] == "duplicate"
        assert data["send"] is False
````

## File: tests/test_quick.py
````python
#!/usr/bin/env python3
"""
Quick test script para validar que backend funciona.
Ejecutar: python tests/test_quick.py
"""

import asyncio
import sys
import os

# Agregar parent dir al path
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

async def test_date_parsing():
    """Prueba que los helpers de parsing de fechas funcionan."""
    from datetime import date, datetime
    from dateutil.parser import parse as dateutil_parse
    
    def get_next_weekday(target_weekday: int) -> date:
        today = datetime.now()
        days_ahead = target_weekday - today.weekday()
        if days_ahead <= 0:
            days_ahead += 7
        return (today + __import__('datetime').timedelta(days=days_ahead)).date()
    
    # Test 1: get_next_weekday
    monday = get_next_weekday(0)
    print(f"‚úÖ get_next_weekday(0=Monday): {monday}")
    
    # Test 2: dateutil parsing
    try:
        dt = dateutil_parse("2025-02-15 14:30", dayfirst=True)
        print(f"‚úÖ dateutil_parse('2025-02-15 14:30'): {dt}")
    except Exception as e:
        print(f"‚ùå dateutil parsing failed: {e}")
        return False
    
    return True

async def test_helpers():
    """Prueba helpers de slots."""
    from datetime import date, datetime, timedelta
    
    def generate_free_slots(target_date: date, busy_times: list, 
                           start_hour=9, end_hour=18, interval_minutes=30) -> list:
        slots = []
        current = datetime.combine(target_date, datetime.min.time()).replace(hour=start_hour)
        end = datetime.combine(target_date, datetime.min.time()).replace(hour=end_hour)
        
        busy_hours = set()
        for busy_start, duration in busy_times:
            busy_hours.add(busy_start.hour + (busy_start.minute / 60))
        
        while current < end:
            if current.hour >= 13 and current.hour < 14:
                current += timedelta(minutes=interval_minutes)
                continue
            
            hour_decimal = current.hour + (current.minute / 60)
            if hour_decimal not in busy_hours:
                slots.append(current.strftime("%H:%M"))
            
            current += timedelta(minutes=interval_minutes)
        
        return slots[:5]
    
    target_date = date.today()
    busy_times = [
        (datetime.combine(target_date, datetime.min.time()).replace(hour=10), 30),
        (datetime.combine(target_date, datetime.min.time()).replace(hour=14), 30),
    ]
    
    slots = generate_free_slots(target_date, busy_times)
    print(f"‚úÖ generate_free_slots: {slots}")
    
    return len(slots) > 0

async def test_fastapi_imports():
    """Valida que FastAPI y LangChain se pueden importar."""
    try:
        from fastapi import FastAPI
        print("‚úÖ FastAPI OK")
    except ImportError as e:
        print(f"‚ùå FastAPI import failed: {e}")
        return False
    
    try:
        from langchain_openai import ChatOpenAI
        print("‚úÖ LangChain OK")
    except ImportError as e:
        print(f"‚ùå LangChain import failed: {e}")
        return False
    
    try:
        from langchain.tools import tool
        print("‚úÖ LangChain tools OK")
    except ImportError as e:
        print(f"‚ùå LangChain tools import failed: {e}")
        return False
    
    return True

async def test_pydantic_models():
    """Valida que los modelos Pydantic se definen correctamente."""
    try:
        from pydantic import BaseModel
        
        class TestModel(BaseModel):
            name: str
            age: int
        
        obj = TestModel(name="Test", age=25)
        print(f"‚úÖ Pydantic models OK: {obj}")
        return True
    except Exception as e:
        print(f"‚ùå Pydantic failed: {e}")
        return False

async def main():
    print("üß™ Backend Quick Test Suite")
    print("=" * 50)
    
    tests = [
        ("FastAPI + LangChain imports", test_fastapi_imports),
        ("Date parsing helpers", test_date_parsing),
        ("Free slots generation", test_helpers),
        ("Pydantic models", test_pydantic_models),
    ]
    
    results = []
    for test_name, test_func in tests:
        print(f"\n[Testing] {test_name}...")
        try:
            result = await test_func()
            results.append((test_name, result))
        except Exception as e:
            print(f"‚ùå Exception in {test_name}: {e}")
            results.append((test_name, False))
    
    print("\n" + "=" * 50)
    print("üìä Test Results:")
    for test_name, result in results:
        status = "‚úÖ" if result else "‚ùå"
        print(f"{status} {test_name}")
    
    passed = sum(1 for _, r in results if r)
    total = len(results)
    print(f"\n{passed}/{total} tests passed")
    
    return all(r for _, r in results)

if __name__ == "__main__":
    success = asyncio.run(main())
    sys.exit(0 if success else 1)
````

## File: tests/test_tiendanube.py
````python
import pytest
from fastapi.testclient import TestClient
from unittest.mock import patch

from tiendanube_service.main import app

client = TestClient(app)

def test_internal_token_required():
    response = client.post("/tools/productsq", json={"q": "test"})
    # Missing token
    assert response.status_code == 422 # FastAPI checks header presence first (Validation Error)
    
    # Invalid token
    response = client.post("/tools/productsq", json={"q": "test"}, headers={"X-Internal-Token": "wrong"})
    assert response.status_code == 401

@patch("tiendanube_service.main.requests.get")
def test_toolresponse_schema(mock_get):
    mock_get.return_value.status_code = 200
    mock_get.return_value.json.return_value = [{"id": 1, "name": "Producto Test"}]
    
    response = client.post(
        "/tools/productsq", 
        json={"q": "test"}, 
        headers={"X-Internal-Token": "test_internal_token"}
    )
    
    assert response.status_code == 200
    data = response.json()
    assert "ok" in data
    assert "data" in data
    assert data["ok"] is True
    assert data["data"][0]["name"] == "Producto Test"

@patch("tiendanube_service.main.requests.get")
def test_toolresponse_error_handling(mock_get):
    # Simulate Tienda Nube Error
    mock_get.side_effect = Exception("Network Error")
    
    response = client.post(
        "/tools/productsq", 
        json={"q": "test"}, 
        headers={"X-Internal-Token": "test_internal_token"}
    )
    
    assert response.status_code == 200 # We return 200 with ok=False
    data = response.json()
    assert data["ok"] is False
    assert data["error"]["code"] == "INTERNAL_ERROR"
````

## File: tests/test_whatsapp.py
````python
import pytest
import hmac
import hashlib
import time
from fastapi.testclient import TestClient
from unittest.mock import patch, MagicMock

# Import app AFTER env vars are set (which happens in conftest or here implicitly due to pytest order)
# However, we need to ensure redis/etc are mocked if they are instantiated at import time.
# In whatsapp_service/main.py, redis_client IS instantiated at module level.
# So we need to patch redis.from_url before importing main

with patch('redis.from_url') as mock_redis_from_url:
    from whatsapp_service.main import app, YCLOUD_WEBHOOK_SECRET

client = TestClient(app)

def generate_signature(body: str, secret: str = YCLOUD_WEBHOOK_SECRET):
    t = str(int(time.time()))
    payload = f"{t}.{body}"
    s = hmac.new(secret.encode(), payload.encode(), hashlib.sha256).hexdigest()
    return f"t={t},s={s}"

def test_signature_invalid_returns_401():
    response = client.post(
        "/webhook/ycloud",
        content="test",
        headers={"ycloud-signature": "t=123,s=invalid"}
    )
    assert response.status_code == 401
    assert "Invalid signature" in response.text or "Timestamp" in response.text or "format" in response.text

@patch("whatsapp_service.main.requests.post")
def test_signature_valid_forwards_to_orchestrator(mock_post):
    # Mock orchestrator response
    mock_post.return_value.status_code = 200
    mock_post.return_value.json.return_value = {"status": "ok", "send": False}
    
    body = '[{"type": "whatsapp.inbound_message.received", "id": "evt_1", "whatsappInboundMessage": {"from": "123", "text": {"body": "hola"}}}]'
    sig = generate_signature(body)
    
    response = client.post(
        "/webhook/ycloud",
        content=body,
        headers={"ycloud-signature": sig}
    )
    
    assert response.status_code == 200
    assert mock_post.called
    # Check if correct URL and Headers
    args, kwargs = mock_post.call_args
    assert "/chat" in args[0]
    assert kwargs["headers"]["X-Internal-Token"] == "test_internal_token"
    assert "X-Correlation-Id" in kwargs["headers"]
````

## File: whatsapp_service/Dockerfile
````
FROM python:3.11-slim

WORKDIR /app

COPY requirements.txt .

RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8002"]
````

## File: whatsapp_service/main.py
````python
import os
import hmac
import hashlib
import time
import uuid
import asyncio
import redis
import httpx
import structlog
import json
from typing import List, Optional, Dict, Any
from fastapi import FastAPI, HTTPException, Request, Response
from fastapi.responses import JSONResponse
from pydantic import BaseModel, Field
from dotenv import load_dotenv
from tenacity import retry, stop_after_attempt, wait_exponential, retry_if_exception_type, RetryError
from prometheus_client import Counter, Histogram, generate_latest, CONTENT_TYPE_LATEST

from ycloud_client import YCloudClient

# Initialize config
load_dotenv()

# Config handling
_config_cache = {}

async def get_config(name: str, default: str = None) -> str:
    # 1. Check local cache
    if name in _config_cache:
        return _config_cache[name]
    
    # 2. Check local Environment
    val = os.getenv(name)
    if val:
        _config_cache[name] = val
        return val
        
    # 3. Query Orchestrator
    try:
        async with httpx.AsyncClient() as client:
            resp = await client.get(
                f"{ORCHESTRATOR_URL}/admin/internal/credentials/{name}",
                headers={"X-Internal-Token": INTERNAL_API_TOKEN},
                timeout=5.0
            )
            if resp.status_code == 200:
                val = resp.json().get("value")
                if val:
                    _config_cache[name] = val
                    return val
    except Exception as e:
        logger.warning("config_fetch_failed", name=name, error=str(e))
        
    return default

# Initialize startup values (can be overridden later)
YCLOUD_API_KEY = os.getenv("YCLOUD_API_KEY")
YCLOUD_WEBHOOK_SECRET = os.getenv("YCLOUD_WEBHOOK_SECRET")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
INTERNAL_API_TOKEN = os.getenv("INTERNAL_API_TOKEN")
REDIS_URL = os.getenv("REDIS_URL", "redis://redis:6379")
ORCHESTRATOR_URL = os.getenv("ORCHESTRATOR_SERVICE_URL", "http://orchestrator_service:8000")

# Initialize structlog
structlog.configure(
    processors=[
        structlog.processors.TimeStamper(fmt="iso"),
        structlog.processors.JSONRenderer()
    ],
    logger_factory=structlog.PrintLoggerFactory(),
)
logger = structlog.get_logger()

# Initialize Redis
redis_client = redis.from_url(REDIS_URL, decode_responses=True)

# --- Models ---
class OrchestratorMessage(BaseModel):
    part: Optional[int] = None
    total: Optional[int] = None
    text: Optional[str] = None
    imageUrl: Optional[str] = None
    needs_handoff: bool = False
    handoff: Optional[str] = None
    meta: Dict[str, Any] = Field(default_factory=dict)

class OrchestratorResult(BaseModel):
    status: str
    send: bool
    text: Optional[str] = None
    messages: List[OrchestratorMessage] = Field(default_factory=list)

class SendMessage(BaseModel):
    to: str
    text: Optional[str] = None
    message: Optional[str] = None # Support both

# FastAPI App
app = FastAPI(
    title="WhatsApp Service",
    description="A service to handle WhatsApp interactions and forward them to the orchestrator.",
)

# Metrics
SERVICE_NAME = "whatsapp_service"
REQUESTS = Counter("http_requests_total", "Total Request Count", ["service", "endpoint", "method", "status"])
LATENCY = Histogram("http_request_latency_seconds", "Request Latency", ["service", "endpoint"])

# --- Middleware ---
@app.middleware("http")
async def add_metrics_and_logs(request: Request, call_next):
    start_time = time.time()
    correlation_id = request.headers.get("X-Correlation-Id") or request.headers.get("traceparent")
    response = await call_next(request)
    process_time = time.time() - start_time
    status_code = response.status_code
    REQUESTS.labels(service=SERVICE_NAME, endpoint=request.url.path, method=request.method, status=status_code).inc()
    LATENCY.labels(service=SERVICE_NAME, endpoint=request.url.path).observe(process_time)
    logger.bind(
        service=SERVICE_NAME, correlation_id=correlation_id, status_code=status_code,
        method=request.method, endpoint=request.url.path, latency_ms=round(process_time * 1000, 2)
    ).info("request_completed" if status_code < 400 else "request_failed")
    return response

# --- Helpers ---
async def verify_signature(request: Request):
    signature_header = request.headers.get("ycloud-signature")
    if not signature_header: raise HTTPException(status_code=401, detail="Missing signature header")
    try:
        parts = {k: v for k, v in [p.split("=") for p in signature_header.split(",")]}
        t, s = parts.get("t"), parts.get("s")
    except: raise HTTPException(status_code=401, detail="Invalid signature format")
    if not t or not s: raise HTTPException(status_code=401, detail="Missing timestamp or signature")
    if abs(time.time() - int(t)) > 300: raise HTTPException(status_code=401, detail="Timestamp out of tolerance")
    raw_body = await request.body()
    body_str = raw_body.decode('utf-8') if raw_body else ""
    signed_payload = f"{t}.{body_str}"
    
    # Fetch secret dynamically to support DB-stored credentials
    v_secret = await get_config("YCLOUD_WEBHOOK_SECRET", YCLOUD_WEBHOOK_SECRET)
    if not v_secret:
        logger.error("missing_webhook_secret", note="Cannot verify signature without secret")
        raise HTTPException(status_code=500, detail="Webhook configuration error")

    expected = hmac.new(v_secret.encode("utf-8"), signed_payload.encode("utf-8"), hashlib.sha256).hexdigest()
    if not hmac.compare_digest(expected, s): raise HTTPException(status_code=401, detail="Invalid signature")

@retry(stop=stop_after_attempt(3), wait=wait_exponential(multiplier=1, min=2, max=10),
       retry=retry_if_exception_type(httpx.HTTPError))
async def forward_to_orchestrator(payload: dict, headers: dict):
    async with httpx.AsyncClient(timeout=httpx.Timeout(120.0, connect=5.0)) as client:
        response = await client.post(f"{ORCHESTRATOR_URL}/chat", json=payload, headers=headers)
        response.raise_for_status()
        return response.json()

async def transcribe_audio(audio_url: str, correlation_id: str) -> Optional[str]:
    """Downloads audio from YCloud and transcribes it using OpenAI Whisper."""
    if not OPENAI_API_KEY:
        logger.error("missing_openai_api_key", note="Transcription requires OpenAI API key")
        return None
    
    try:
        async with httpx.AsyncClient(timeout=httpx.Timeout(60.0)) as client:
            # 1. Download audio
            audio_res = await client.get(audio_url)
            audio_res.raise_for_status()
            audio_data = audio_res.content
            
            # 2. Transcribe with Whisper
            files = {"file": ("audio.ogg", audio_data, "audio/ogg")}
            v_openai = await get_config("OPENAI_API_KEY", OPENAI_API_KEY)
            headers = {"Authorization": f"Bearer {v_openai}"}
            data = {"model": "whisper-1"}
            
            trans_res = await client.post(
                "https://api.openai.com/v1/audio/transcriptions",
                headers=headers,
                files=files,
                data=data
            )
            trans_res.raise_for_status()
            return trans_res.json().get("text")
    except Exception as e:
        logger.error("transcription_failed", error=str(e), correlation_id=correlation_id)
        return None

async def send_sequence(messages: List[OrchestratorMessage], user_number: str, business_number: str, inbound_id: str, correlation_id: str):
    v_ycloud = await get_config("YCLOUD_API_KEY", YCLOUD_API_KEY)
    client = YCloudClient(v_ycloud, business_number)
    
    try: 
        await client.mark_as_read(inbound_id, correlation_id)
        await client.typing_indicator(inbound_id, correlation_id)
    except: pass

    for msg in messages:
        try:
            # 1. Image Bubble
            if msg.imageUrl:
                try: await client.typing_indicator(inbound_id, correlation_id)
                except: pass
                await asyncio.sleep(4)
                await client.send_image(user_number, msg.imageUrl, correlation_id)
                try: await client.mark_as_read(inbound_id, correlation_id)
                except: pass

            # 2. Text Bubble(s) with Safety Splitter (Layer 2)
            if msg.text:
                # Emergency splitting if orchestrator sent a wall of text (>400 chars)
                import re
                if len(msg.text) > 400:
                    text_parts = re.split(r'(?<=[.!?]) +', msg.text)
                    refined_parts = []
                    current = ""
                    for p in text_parts:
                        if len(current) + len(p) < 400:
                            current += (" " + p if current else p)
                        else:
                            if current: refined_parts.append(current)
                            current = p
                    if current: refined_parts.append(current)
                else:
                    refined_parts = [msg.text]

                for part in refined_parts:
                    try: await client.typing_indicator(inbound_id, correlation_id)
                    except: pass
                    await asyncio.sleep(1.5)
                    await client.send_text(user_number, part, correlation_id)
                    try: await client.mark_as_read(inbound_id, correlation_id)
                    except: pass

            # Delay between messages to prevent out-of-order delivery
            await asyncio.sleep(2)

        except Exception as e:
            logger.error("sequence_step_error", error=str(e), correlation_id=correlation_id)

# --- Background Task ---
async def process_user_buffer(from_number: str, business_number: str, customer_name: Optional[str], event_id: str, provider_message_id: str):
    buffer_key, timer_key, lock_key = f"buffer:{from_number}", f"timer:{from_number}", f"active_task:{from_number}"
    correlation_id = str(uuid.uuid4())
    log = logger.bind(correlation_id=correlation_id, from_number=from_number[-4:])
    try:
        while True:
            # 1. Debounce Phase: Wait until user stopped typing
            while True:
                await asyncio.sleep(2)
                if redis_client.ttl(timer_key) <= 0: break
            
            # 2. Atomic Fetch: How many messages are we starting with?
            L = redis_client.llen(buffer_key)
            if L == 0: break
            
            raw_items = redis_client.lrange(buffer_key, 0, L-1)
            parsed_items = []
            for item in raw_items:
                try:
                    parsed_items.append(json.loads(item))
                except:
                    # Fallback for legacy items or unexpected formats
                    parsed_items.append({"text": item, "wamid": provider_message_id, "event_id": event_id})
            
            joined_text = "\n".join([i["text"] for i in parsed_items])
            # We use the LAST message IDs to identify this batch in the orchestrator (deduplication)
            current_event_id = parsed_items[-1].get("event_id") or event_id
            current_wamid = parsed_items[-1].get("wamid") or provider_message_id

            inbound_event = {
                "provider": "ycloud", 
                "event_id": current_event_id, 
                "provider_message_id": current_wamid,
                "from_number": from_number, "to_number": business_number, "text": joined_text, "customer_name": customer_name,
                "event_type": "whatsapp.inbound_message.received", "correlation_id": correlation_id
            }
            headers = {"X-Correlation-Id": correlation_id}
            if INTERNAL_API_TOKEN: headers["X-Internal-Token"] = INTERNAL_API_TOKEN
                 
            log.info("forwarding_to_orchestrator", text_preview=joined_text[:50])
            raw_res = await forward_to_orchestrator(inbound_event, headers)
            log.info("orchestrator_response_received", status=raw_res.get("status"), send=raw_res.get("send"))
            
            try:
                orch_res = OrchestratorResult(**raw_res)
            except Exception as e:
                log.error("orchestrator_parse_error", error=str(e), raw=raw_res)
                # Cleanup and break to avoid stuck state
                redis_client.ltrim(buffer_key, L, -1)
                break

            if orch_res.status == "duplicate":
                log.info("ignoring_duplicate_response")
                redis_client.ltrim(buffer_key, L, -1)
                break

            if orch_res.send:
                if not YCLOUD_API_KEY:
                    log.error("missing_ycloud_api_key", note="Cannot send sequence without API key")
                else:
                    msgs = orch_res.messages
                    if not msgs and orch_res.text:
                        msgs = [OrchestratorMessage(text=orch_res.text)]
                    
                    if msgs:
                        img_count = len([m for m in msgs if m.imageUrl])
                        log.info("starting_send_sequence", count=len(msgs), images_found=img_count)
                        await send_sequence(msgs, from_number, business_number, current_event_id, correlation_id)
            
            # 3. ATOMIC TRIM: Remove only the messages we just processed
            redis_client.ltrim(buffer_key, L, -1)
            
            # 4. LOOP CHECK: If more messages arrived during the sequence, process them immediately
            if redis_client.llen(buffer_key) == 0:
                break
            else:
                log.info("new_messages_while_responding", remaining=redis_client.llen(buffer_key))
                # Reset timer to force a small fresh debounce for the new messages
                redis_client.setex(timer_key, 5, "1")

    except Exception as e:
        log.error("buffer_process_error", error=str(e))
    finally:
        # Buffer is handled by ltrim inside the loop or error
        for k in [lock_key, timer_key]:
            try:
                redis_client.delete(k)
            except:
                pass

# --- Endpoints ---
@app.get("/metrics")
def metrics(): return Response(content=generate_latest(), media_type=CONTENT_TYPE_LATEST)

@app.get("/ready")
def ready():
    if not YCLOUD_WEBHOOK_SECRET: raise HTTPException(status_code=503, detail="Configuration missing")
    return {"status": "ok"}

@app.get("/health")
def health(): return {"status": "ok"}

@app.post("/webhook")
@app.post("/webhook/ycloud")
async def ycloud_webhook(request: Request):
    logger.info("webhook_hit", headers=str(request.headers))
    await verify_signature(request)
    correlation_id = request.headers.get("traceparent") or str(uuid.uuid4())
    try: body = await request.json()
    except: raise HTTPException(status_code=400, detail="Invalid JSON")
    
    event = body[0] if isinstance(body, list) and body else body
    event_type = event.get("type")
    
    # --- 1. Handle Inbound Messages ---
    if event_type == "whatsapp.inbound_message.received":
        msg = event.get("whatsappInboundMessage", {})
        from_n, to_n, name = msg.get("from"), msg.get("to"), msg.get("customerProfile", {}).get("name")
        msg_type = msg.get("type")
        
        # A. Text Messages -> Buffer (Debounce)
        if msg_type == "text":
            text = msg.get("text", {}).get("body")
            if text:
                buffer_key, timer_key, lock_key = f"buffer:{from_n}", f"timer:{from_n}", f"active_task:{from_n}"
                # Store message as JSON to preserve IDs for the atomic loop
                redis_client.rpush(buffer_key, json.dumps({
                    "text": text,
                    "wamid": msg.get("wamid") or event.get("id"),
                    "event_id": event.get("id")
                }))
                redis_client.setex(timer_key, 12, "1")
                
                if not redis_client.get(lock_key):
                    redis_client.setex(lock_key, 60, "1")
                    asyncio.create_task(process_user_buffer(from_n, to_n, name, event.get("id"), msg.get("wamid") or event.get("id")))
                    return {"status": "buffering_started", "correlation_id": correlation_id}
                return {"status": "buffering_updated", "correlation_id": correlation_id}
        
        # B. Media Messages -> Immediate Forward (No Buffer)
        media_list = []
        text_content = None
        
        if msg_type == "image":
            node = msg.get("image", {})
            text_content = node.get("caption")
            media_list.append({
                "type": "image", 
                "url": node.get("link"), 
                "mime_type": node.get("mime_type"),
                "provider_id": node.get("id")
            })
            
        elif msg_type == "document":
            node = msg.get("document", {})
            text_content = node.get("caption")
            media_list.append({
                "type": "document", 
                "url": node.get("link"), 
                "mime_type": node.get("mime_type"), 
                "file_name": node.get("filename"),
                "provider_id": node.get("id")
            })
            
        elif msg_type == "audio":
            node = msg.get("audio", {})
            media_list.append({
                "type": "audio", 
                "url": node.get("link"), 
                "mime_type": node.get("mime_type"),
                "provider_id": node.get("id")
            })
            # Transcription
            if node.get("link"):
                logger.info("audio_received_starting_transcription", correlation_id=correlation_id)
                transcription = await transcribe_audio(node.get("link"), correlation_id)
                if transcription:
                     text_content = transcription
                     
        if media_list:
             # Construct payload compatible with InboundChatEvent + Media extension
             payload = {
                "provider": "ycloud", 
                "event_id": event.get("id"), 
                "provider_message_id": msg.get("wamid") or event.get("id"),
                "from_number": from_n, 
                "to_number": to_n, 
                "text": text_content, # Can be None/null
                "customer_name": name,
                "event_type": "whatsapp.inbound_message.received", 
                "correlation_id": correlation_id,
                "media": media_list
             }
             headers = {"X-Correlation-Id": correlation_id}
             if INTERNAL_API_TOKEN: headers["X-Internal-Token"] = INTERNAL_API_TOKEN
             
             # Send to Orchestrator and Process Response
             try:
                 raw_res = await forward_to_orchestrator(payload, headers)
                 
                 orch_res = OrchestratorResult(**raw_res)
                 if orch_res.send:
                     if not YCLOUD_API_KEY:
                         logger.error("missing_ycloud_api_key_media_reply")
                     else:
                         msgs = orch_res.messages
                         if not msgs and orch_res.text:
                             msgs = [OrchestratorMessage(text=orch_res.text)]
                         
                         if msgs:
                             await send_sequence(msgs, from_n, to_n, event.get("id"), correlation_id)
             except Exception as e:
                 logger.error("media_response_processing_error", error=str(e))
                 
             return {"status": "media_and_response_processed", "count": len(media_list)}
             
        return {"status": "ignored_type_or_empty", "type": msg_type}

    # --- 2. Handle Echoes (Manual Messages) ---
    elif event_type == "whatsapp.message.echo" or event_type == "whatsapp.smb.message.echoes":
        logger.info("echo_received", correlation_id=correlation_id, evt_type=event_type)
        msg = event.get("whatsappMessage", {}) or event.get("message", {})
        
        user_phone = msg.get("to")
        bot_phone = msg.get("from")
        
        text = None
        msg_type = msg.get("type")
        
        if msg_type == "text":
            text = msg.get("text", {}).get("body")
        elif msg_type == "audio":
            text = "[Audio enviado]"
        elif msg_type == "image":
            text = msg.get("image", {}).get("caption") or "[Imagen enviada]"
        elif msg_type == "document":
            text = msg.get("document", {}).get("caption") or "[Documento enviado]"
        elif msg_type == "video":
             text = msg.get("video", {}).get("caption") or "[Video enviado]"
        
        # If we have text (real or fallback) and a user phone, forward it
        if text and user_phone:
             payload = {
                "provider": "ycloud", 
                "event_id": event.get("id"), 
                "provider_message_id": msg.get("wamid") or event.get("id"),
                "from_number": user_phone,     # Ensuring this maps to 'external_user_id' in DB
                "to_number": bot_phone,
                "text": text,
                "event_type": "whatsapp.message.echo", # Standardize for Orchestrator
                "correlation_id": correlation_id
             }
             headers = {"X-Correlation-Id": correlation_id}
             if INTERNAL_API_TOKEN: headers["X-Internal-Token"] = INTERNAL_API_TOKEN
             
             try:
                 await forward_to_orchestrator(payload, headers)
                 return {"status": "echo_forwarded", "type": msg_type}
             except Exception as e:
                 logger.error("echo_forward_failed", error=str(e))
                 return {"status": "error_forwarding_echo"}
                 
    return {"status": "ignored_event_type", "type": event_type}

@app.post("/send")
async def send_message(message: SendMessage, request: Request):
    """Internal endpoint for sending manual messages from orchestrator."""
    correlation_id = request.headers.get("X-Correlation-Id") or str(uuid.uuid4())
    logger.info("manual_send_request", to=message.to, correlation_id=correlation_id)
    token = request.headers.get("X-Internal-Token")
    if token != INTERNAL_API_TOKEN:
        raise HTTPException(status_code=401, detail="Unauthorized")
    
    correlation_id = request.headers.get("X-Correlation-Id") or str(uuid.uuid4())
    # Retrieve config
    v_ycloud = await get_config("YCLOUD_API_KEY", YCLOUD_API_KEY)
    # We need to know which business number to use - for now assume default or pass in body if model updated
    # To keep it simple for now, we use the default env var logic inside YCloudClient via send_sequence or re-instantiate
    # Ideally SendMessage model should include 'from_number' (business number)
    
    # Since SendMessage is simple (to, text), we try to get a business number from config or context
    # But YCloudClient needs it.
    # Hack: We initialize YCloudClient with a dummy if needed, but it really needs the sender ID.
    # Let's check send_sequence usage: client = YCloudClient(v_ycloud, business_number)
    
    # IMPROVEMENT: The request should probably provide the separate business number/ID
    # For this MVP, let's assume global YCloud config unless passed
    
    try:
        # Re-use send_sequence logic but for a single message
        # We need to wrap it as OrchestratorMessage
        orch_msg = OrchestratorMessage(text=message.text)
        
        # We need the 'from' number (the bot's number). 
        # Since we don't have it in the simple body, we might need to assume it's the one in ENV or context.
        # However, for multi-tenant, orchestrator MUST tell us.
        # Let's inspect headers or just rely on YCloudClient to default if allowed.
        # Actually YCloudClient requires `from_phone_number`. 
        
        # Updated Logic: We will parse `from_number` from query param or header if available, or fetch from config
        business_number = request.query_params.get("from_number")
        if not business_number:
            # Fallback to env or fetch
             business_number = await get_config("YCLOUD_Phone_Number_ID") # Placeholder
        
        if not business_number:
             # Basic fallback
             business_number = "default"
        
        logger.info("manual_send_config", 
                    has_api_key=bool(v_ycloud), 
                    business_number=business_number, 
                    correlation_id=correlation_id)

        # Initialize Client
        client = YCloudClient(v_ycloud, business_number)
        
        # Use either text or message field
        content = message.text or message.message
        if not content:
            raise HTTPException(status_code=400, detail="Missing message content")
            
        # Send
        await client.send_text(message.to, content, correlation_id)
        return {"status": "sent", "correlation_id": correlation_id}
        
    except Exception as e:
        logger.error("manual_send_failed", error=str(e), correlation_id=correlation_id)
        raise HTTPException(status_code=500, detail=str(e))

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8002)
````

## File: whatsapp_service/requirements.txt
````
fastapi
uvicorn
pydantic
httpx
tenacity
structlog
redis
python-dotenv
prometheus-client
requests
````

## File: whatsapp_service/ycloud_client.py
````python
import os
import httpx
from tenacity import retry, stop_after_attempt, wait_exponential, retry_if_exception_type
import structlog

logger = structlog.get_logger()

class YCloudClient:
    BASE_URL = "https://api.ycloud.com/v2"

    def __init__(self, api_key: str, business_number: str):
        self.api_key = api_key
        self.business_number = business_number
        self.headers = {
            "X-API-Key": self.api_key,
            "Content-Type": "application/json"
        }

    @retry(
        stop=stop_after_attempt(2),
        wait=wait_exponential(multiplier=1, min=1, max=4),
        retry=retry_if_exception_type(httpx.HTTPError)
    )
    async def _post(self, endpoint: str, json_data: dict, correlation_id: str):
        async with httpx.AsyncClient(timeout=httpx.Timeout(20.0, connect=5.0)) as client:
            url = f"{self.BASE_URL}{endpoint}"
            response = await client.post(url, json=json_data, headers=self.headers)
            response.raise_for_status()
            return response.json()

    async def send_text(self, to: str, text: str, correlation_id: str):
        payload = {
            "from": self.business_number,
            "to": to,
            "type": "text",
            "text": {"body": text, "preview_url": True}
        }
        logger.info("ycloud_send_text", to=to, from_number=self.business_number, text_preview=text[:30], correlation_id=correlation_id)
        return await self._post("/whatsapp/messages/sendDirectly", payload, correlation_id)

    async def send_image(self, to: str, image_url: str, correlation_id: str):
        payload = {
            "from": self.business_number,
            "to": to,
            "type": "image",
            "image": {"link": image_url}
        }
        logger.info("ycloud_send_image", to=to, image_url=image_url, correlation_id=correlation_id)
        return await self._post("/whatsapp/messages/sendDirectly", payload, correlation_id)

    async def mark_as_read(self, inbound_id: str, correlation_id: str):
        logger.info("ycloud_mark_as_read", inbound_id=inbound_id, correlation_id=correlation_id)
        return await self._post(f"/whatsapp/inboundMessages/{inbound_id}/markAsRead", {}, correlation_id)

    async def typing_indicator(self, inbound_id: str, correlation_id: str):
        # The node "marcar_leido" in n8n calls typingIndicator
        logger.info("ycloud_typing_indicator", inbound_id=inbound_id, correlation_id=correlation_id)
        return await self._post(f"/whatsapp/inboundMessages/{inbound_id}/typingIndicator", {}, correlation_id)
````

## File: .dockerignore
````
.git/
.venv/
__pycache__/
.pytest_cache/
*.log
.env
node_modules/
*.pyc
*.pyo
.DS_Store
````

## File: .gitignore
````
# ==================== Python ====================
# Byte-compiled / optimized / DLL files
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
*.egg-info/
.installed.cfg
*.egg

# Virtual environments
.venv/
venv/
ENV/
env/
.virtualenv/

# PyCharm
.idea/

# VS Code
.vscode/

# ==================== Node.js ====================
node_modules/
npm-debug.log*
yarn-debug.log*
yarn-error.log*
package-lock.json
.yarn/
.pnp.*

# ==================== Environment & Secrets ====================
.env
.env.local
.env.*.local
*.pem
*.key
*.p12
google-credentials.json

# ==================== Docker ====================
docker-compose.override.yml

# ==================== Database ====================
*.db
*.sqlite
*.sqlite3
postgres_data/

# ==================== Logs ====================
*.log
logs/

# ==================== OS ====================
# macOS
.DS_Store
.AppleDouble
.LSOverride

# Windows
Thumbs.db
ehthumbs.db
Desktop.ini
$RECYCLE.BIN/

# Linux
*~

# ==================== Frontend (React/Vite) ====================
dist/
.cache/
.parcel-cache/
.vite/
coverage/

# ==================== Testing ====================
.pytest_cache/
.coverage
htmlcov/
.tox/
.hypothesis/

# ==================== Misc ====================
*.swp
*.swo
*.bak
*.tmp
*~
.vagrant/
````

## File: AGENTS.md
````markdown
# ü§ñ AGENTS.md: La Gu√≠a Suprema para el Mantenimiento del Proyecto (Nexus v7.6)

Este documento es el manual de instrucciones definitivo para cualquier IA o desarrollador que necesite modificar o extender este sistema. Sigue estas reglas para evitar regresiones.

---

## üèóÔ∏è Arquitectura de Microservicios (v7.6 Platinum)

### üì° Core Intelligence (Orchestrator) - `orchestrator_service`
El cerebro central. Gestiona el agente LangChain, la memoria y la base de datos.
- **Seguridad de Triple Capa:** JWT para identidad, `X-Admin-Token` para infraestructura, y estado `pending` para nuevos registros.
- **Maintenance Robot (db.py):** Sistema de auto-curaci√≥n de base de datos. Los parches PL/pgSQL se ejecutan en cada arranque para asegurar el esquema.
- **WebSocket / Socket.IO:** Sincronizaci√≥n en tiempo real de la agenda.

### üì± Percepci√≥n y Transmisi√≥n (WhatsApp Service) - `whatsapp_service`
Maneja la integraci√≥n con YCloud y la IA de audio (Whisper).

### üé® Control (Frontend React)
- **Routing:** Usa `path="/*"` en el router ra√≠z de `App.tsx` para permitir rutas anidadas.
- **AuthContext:** Gestiona el estado de sesi√≥n y rol del usuario.

---

## üíæ Base de Datos y L√≥gica de Bloqueo

### üö¶ Mecanismo de Silencio (Human Override)
- **Duraci√≥n:** 24 horas. Se guarda en `human_override_until`.

### ü§ñ Maintenance Robot (Self-Healing)
- **Protocolo Omega Prime:** Se auto-activa al primer administrador (CEO) para evitar bloqueos en despliegues nuevos.

---

## üõ†Ô∏è Herramientas (Tools) - Nombres Exactos
- `check_availability`: Consulta disponibilidad de turnos.
- `book_appointment`: Registra un turno.
- `triage_urgency`: Analiza s√≠ntomas.
- `derivhumano`: Derivaci√≥n a humano y bloqueo de 24h.

---

## üìú Reglas de Oro para el C√≥digo

### 1. üêç Python (Backend)
- **Auth Layers**: Siempre usa `Depends(get_current_user)` para rutas protegidas.
- **Exception handling**: Usa el manejador global en `main.py` para asegurar estabilidad de CORS.

### 2. üîÑ React (Frontend)
- **Wildcard Routes**: Siempre pon `/*` en rutas que contengan `Routes` hijos.
- **Axios**: Los headers `Authorization` y `X-Admin-Token` se inyectan autom√°ticamente en `api/axios.ts`.

---

## üìà Observabilidad
- Los links de activaci√≥n se imprimen en los logs como `WARNING` (Protocolo Omega).

---

## üõ†Ô∏è Available Skills Index

| Skill Name | Trigger | Descripci√≥n |
| :--- | :--- | :--- |
| **Sovereign Backend Engineer** | *FastAPI, Backend* | Experto en l√≥gica de negocio, seguridad y API multi-tenant. |
| **Nexus UI Developer** | *React, Frontend* | Especialista en interfaces din√°micas y sincronizaci√≥n Socket.IO. |
| **DB Schema Surgeon** | *Postgres, SQL* | Gesti√≥n avanzada de modelos, √≠ndices y parches. |
| **Maintenance Robot Architect**| *db.py, miguel* | Arquitecto de evoluci√≥n de base de datos segura y self-healing. |

---
*Actualizado: 2026-02-05 - Protocolo Platinum Resilience v7.6*
Ê≥õ
````

## File: DEPLOYMENT_CHECKLIST.md
````markdown
# ‚úÖ DEPLOYMENT CHECKLIST - Backend Final

## Estado Actual

‚úÖ **main.py:** Actualizado con:
- Lifespan context manager (db.connect/disconnect)
- Chat history persistence (get_chat_history + append_chat_message)
- 4 helper functions (parse_date, parse_datetime, generate_free_slots, get_next_weekday)
- 4 dental tools con BD queries (check_availability, book_appointment, triage_urgency, derivhumano)
- System prompt v8 con reglas argentinas

‚úÖ **admin_routes.py:** Actualizado con:
- FK validation (professional_id, patient_id)
- Specific error handling (asyncpg.UniqueViolationError, ForeignKeyViolationError)
- CRUD endpoints para pacientes, turnos, registros cl√≠nicos

‚úÖ **requirements.txt:** Agregado `python-dateutil`

‚è≥ **Pasos restantes:** 3 (15 min total)

---

## üìã PASO 1: INSTALAR DEPENDENCIAS

### Opci√≥n A: Windows PowerShell
```powershell
cd "c:\Users\Asus\Downloads\Clinica Dental"
python -m pip install --upgrade pip
python -m pip install -r orchestrator_service/requirements.txt
```

### Opci√≥n B: Windows CMD
```cmd
cd c:\Users\Asus\Downloads\Clinica Dental
python -m pip install -r orchestrator_service/requirements.txt
```

**Tiempo esperado:** 3-5 min

**Verificaci√≥n:**
```powershell
python -c "from dateutil.parser import parse; print('‚úÖ python-dateutil OK')"
```

---

## üìã PASO 2: EJECUTAR SCHEMA SQL

### Opci√≥n A: Command Line (RECOMENDADO)

Ejecuta el schema unificado:
```powershell
cd "c:\Users\Asus\Downloads\Clinica Dental"
psql -U postgres -d postgres -c "CREATE DATABASE clinica_dental;"
psql -U postgres -d clinica_dental -f db/init/dentalogic_schema.sql
```

**Qu√© hace:**
1. ‚úÖ Crea BD `clinica_dental` si no existe
2. ‚úÖ Ejecuta dentalogic_schema.sql (schema unificado completo)
3. ‚úÖ Verifica autom√°ticamente la creaci√≥n de tablas

**Tiempo esperado:** 2-3 min

### Opci√≥n B: Manual con psql

```powershell
# 1. Conectar
psql -U postgres -h localhost

# 2. En el prompt de psql:
CREATE DATABASE clinica_dental;
\c clinica_dental

# 3. Ejecutar schema unificado
\i 'db/init/dentalogic_schema.sql'

# 4. Verificar
\dt  # Debe mostrar 14+ tablas
```

**Tiempo esperado:** 5 min

---

## üìã PASO 3: VALIDAR SINTAXIS Y CORRER SERVIDOR LOCAL

### 3.1 Validar Python Syntax

```powershell
cd "c:\Users\Asus\Downloads\Clinica Dental"

# Validar main.py
python -m py_compile orchestrator_service/main.py
if ($?) { Write-Host "‚úÖ main.py OK" } else { Write-Host "‚ùå Error en main.py" }

# Validar admin_routes.py
python -m py_compile orchestrator_service/admin_routes.py
if ($?) { Write-Host "‚úÖ admin_routes.py OK" } else { Write-Host "‚ùå Error en admin_routes.py" }
```

**Resultado esperado:** Ambos archivos OK (sin output = sin errores)

### 3.2 Configurar Variables de Entorno

Crea archivo `.env` en la ra√≠z:

```bash
# DB
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_USER=postgres
POSTGRES_PASSWORD=your_password_here
POSTGRES_DB=clinica_dental

# OpenAI
OPENAI_API_KEY=sk-...your-key...

# Clinic Config
CLINIC_NAME=Mi Cl√≠nica Dental
CLINIC_LOCATION=Buenos Aires
CLINIC_PHONE=+5491111111
CLINIC_EMAIL=contact@clinica.ar

# WhatsApp (YCloud - deshabilitado por ahora)
YCLOUD_API_KEY=test_key
YCLOUD_WEBHOOK_URL=http://localhost:3000/webhook

# Log Level
LOG_LEVEL=INFO

# API Port
API_PORT=8000
```

### 3.3 Iniciar Servidor Local

```powershell
cd "c:\Users\Asus\Downloads\Clinica Dental"

# Opci√≥n A: Con uvicorn directo
python -m uvicorn orchestrator_service.main:app --host 0.0.0.0 --port 8000 --reload

# Opci√≥n B: En background (PowerShell)
Start-Process -NoNewWindow -FilePath "python" -ArgumentList `
  "-m uvicorn orchestrator_service.main:app --host 0.0.0.0 --port 8000 --reload"
```

**Resultado esperado:**
```
INFO:     Uvicorn running on http://127.0.0.1:8000
INFO:     Application startup complete
```

---

## üìã PASO 4: PRUEBAS R√ÅPIDAS

### 4.1 Test Chat Endpoint

```powershell
# Prueba simple (PowerShell)
$body = @{
    message = "Hola, quiero agendar un turno"
    phone = "5491111111"
} | ConvertTo-Json

Invoke-WebRequest -Uri "http://localhost:8000/chat" `
  -Method POST `
  -Headers @{"Content-Type"="application/json"} `
  -Body $body | Select-Object -ExpandProperty Content
```

**Resultado esperado:**
```json
{
  "output": "¬°Hola! üëã Te ayudar√© a agendar un turno...",
  "status": "ok"
}
```

### 4.2 Test Admin CRUD

```powershell
# Listar pacientes (requiere token)
Invoke-WebRequest -Uri "http://localhost:8000/admin/patients?search=Juan" `
  -Headers @{"X-Admin-Token"="admin-secret-token"} | Select-Object -ExpandProperty Content

# Listar turnos
Invoke-WebRequest -Uri "http://localhost:8000/admin/appointments" `
  -Headers @{"X-Admin-Token"="admin-secret-token"} | Select-Object -ExpandProperty Content

# Listar profesionales
Invoke-WebRequest -Uri "http://localhost:8000/admin/professionals" `
  -Headers @{"X-Admin-Token"="admin-secret-token"} | Select-Object -ExpandProperty Content
```

### 4.3 OpenAPI Documentation

Abre en navegador:
```
http://localhost:8000/docs
```

Deber√≠as ver Swagger UI con todos los endpoints documentados.

---

## üìã PASO 5: VERIFICACI√ìN FINAL

### Checklist de Confirmaci√≥n

- [ ] `python -m pip install -r orchestrator_service/requirements.txt` ejecutado sin errores
- [ ] `dentalogic_schema.sql` ejecutado ‚Üí Todas las tablas creadas
- [ ] `python -m py_compile orchestrator_service/main.py` sin errores
- [ ] `python -m py_compile orchestrator_service/admin_routes.py` sin errores
- [ ] Servidor uvicorn inicia sin errores (startup complete)
- [ ] POST /chat responde con JSON v√°lido
- [ ] GET /admin/patients responde (con token v√°lido)
- [ ] http://localhost:8000/docs muestra swagger

### Si falla algo:

**Error: `ModuleNotFoundError: No module named 'dateutil'`**
```powershell
python -m pip install python-dateutil
```

**Error: `Connection refused` en PostgreSQL**
```powershell
# Verificar que PostgreSQL est√° corriendo
net start postgresql-x64-XX  # Ajusta el n√∫mero de versi√≥n

# O desde PowerShell
Start-Service -Name postgresql-x64-*
```

**Error: `foreign key violation` al crear turnos**
‚Üí Significa que falta un profesional. Inserta uno:
```sql
INSERT INTO professionals (id, name, specialty, is_active)
VALUES (1, 'Dr. Merlo', 'General', true);
```

---

## üéØ PR√ìXIMO PASO: FRONTEND

Una vez que **todos** los pasos anteriores pasen:

```powershell
# El backend est√° listo para recibir requests del frontend
# La documentaci√≥n OpenAPI est√° en: http://localhost:8000/docs
```

Frontend puede conectar a:
- **Chat:** POST http://localhost:8000/chat
- **Admin Panel:** GET/POST http://localhost:8000/admin/*

Continuar con: `FRONTEND_SETUP.md` (ser√° creado)

---

## üìä Timeline

| Paso | Acci√≥n | Tiempo | Estado |
|------|--------|--------|--------|
| 1 | Instalar deps | 5 min | ‚è≥ |
| 2 | SQL migrations | 3 min | ‚è≥ |
| 3 | Validar sintaxis | 2 min | ‚è≥ |
| 4 | Correr servidor | 1 min | ‚è≥ |
| 5 | Tests r√°pidos | 3 min | ‚è≥ |
| **TOTAL** | | **14 min** | ‚è≥ |

**Objetivo:** Backend 100% funcional en ~15 minutos ‚úÖ
````

## File: docker-compose.yml
````yaml
version: '3.8'
services:
  # --- New Microservices ---
  bff_service:
    build: ./bff_service
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - ORCHESTRATOR_URL=http://orchestrator_service:8000
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - orchestrator_service

  frontend_react:
    build: ./frontend_react
    ports:
      - "4173:80"
    environment:
      - VITE_API_BASE_URL=https://bff.pointcoach.shop # Logic needed here or baking in build
    depends_on:
      - bff_service

  # --- Existing Backend Services ---

  orchestrator_service:
    build: ./orchestrator_service
    ports:
      - "8000:8000"
    volumes:
      - ./orchestrator_service:/app
    environment:
      - WHATSAPP_SERVICE_URL=http://whatsapp_service:8002
      - REDIS_URL=redis://redis:6379
      - POSTGRES_DSN=${POSTGRES_DSN}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - INTERNAL_API_TOKEN=${INTERNAL_API_TOKEN}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - redis
      - postgres

  whatsapp_service:
    build: ./whatsapp_service
    ports:
      - "8002:8002"
    volumes:
      - ./whatsapp_service:/app
    environment:
      - YCLOUD_API_KEY=${YCLOUD_API_KEY}
      - YCLOUD_WEBHOOK_SECRET=${YCLOUD_WEBHOOK_SECRET}
      - INTERNAL_API_TOKEN=${INTERNAL_API_TOKEN}
      - ORCHESTRATOR_SERVICE_URL=http://orchestrator_service:8000
      - REDIS_URL=redis://redis:6379
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8002/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - redis
      - orchestrator_service

  # --- Infrastructure ---

  redis:
    image: "redis:alpine"
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 3

  postgres:
    image: "postgres:13"
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER}" ]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:
````

## File: ENVIRONMENT_VARIABLES.md
````markdown
# Dentalogic - Environment Variables Reference

Quick reference for EasyPanel deployment.

## Service Ports

| Service       | Internal Port |
|---------------|---------------|
| orchestrator  | 8000          |
| bff_service   | 8001          |
| whatsapp      | 8002          |
| frontend      | 3000          |
| postgres      | 5432          |
| redis         | 6379          |

## Internal Service URLs

```bash
ORCHESTRATOR_SERVICE_URL=http://orchestrator:8000
WHATSAPP_SERVICE_URL=http://whatsapp:8002
BFF_SERVICE_URL=http://bff_service:8001
```

## Core Variables (All Backend Services)

```bash
POSTGRES_DSN=postgresql+asyncpg://postgres:password@postgres:5432/dentalogic
REDIS_URL=redis://redis:6379/0
INTERNAL_API_TOKEN=secret-internal-token-2024
LOG_LEVEL=INFO
```

## orchestrator (8000)

```bash
OPENAI_API_KEY=sk-proj-...
CLINIC_NAME=Cl√≠nica Dental
CLINIC_LOCATION=Buenos Aires, Argentina
GOOGLE_CREDENTIALS={"type":"service_account",...}
GOOGLE_CALENDAR_ID=primary
YCLOUD_API_KEY=...
YCLOUD_WEBHOOK_SECRET=...
WHATSAPP_SERVICE_URL=http://whatsapp:8002
ADMIN_TOKEN=admin-secret-token
CORS_ALLOWED_ORIGINS=https://dentalogic-frontend.ugwrjq.easypanel.host,http://localhost:3000

# SMTP Configuration (Human Handoff)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=tu-email@gmail.com
SMTP_PASS=tu-app-password
SMTP_SENDER=tu-email@gmail.com
NOTIFICATIONS_EMAIL=doctor@clinica.com
```

## whatsapp (8002)

```bash
OPENAI_API_KEY=sk-proj-...
YCLOUD_API_KEY=...
YCLOUD_WEBHOOK_SECRET=...
ORCHESTRATOR_SERVICE_URL=http://orchestrator:8000
INTERNAL_API_TOKEN=secret-internal-token-2024
```

## bff_service (8001)

```bash
POSTGRES_DSN=postgresql+asyncpg://...
REDIS_URL=redis://redis:6379/0
ORCHESTRATOR_SERVICE_URL=http://orchestrator:8000
WHATSAPP_SERVICE_URL=http://whatsapp:8002
INTERNAL_API_TOKEN=secret-internal-token-2024
ADMIN_TOKEN=admin-secret-token
JWT_SECRET=your-jwt-secret
```

## frontend (3000)

```bash
VITE_API_URL=https://dentalogic-orchestrator.ugwrjq.easypanel.host
VITE_BFF_URL=https://dentalogic-bff.ugwrjq.easypanel.host
NODE_ENV=production
```
````

## File: Instrucciones para IA.md
````markdown
# **Role: Senior Fullstack Engineer & AI Architect**

# **Context: Transformation of Nexus v3 (E-commerce) to Dental Platform (Mercedes)**

You are an expert developer tasked with refactoring an existing multi-tenant AI agent platform (Nexus v3) into a professional Dental Management Ecosystem.

## **1\. Project Knowledge Base (Reference Docs)**

* Current Backend: Orchestrator (FastAPI/LangChain), WhatsApp Service (YCloud/Whisper).  
* Current Storage: PostgreSQL (Persistence), Redis (Ephemeral/Locks).  
* Current UI: Vanilla JavaScript (Platform UI).  
* New Goal: docs/propuesta\_dental.md (Functional requirements).

## **2\. Transformation Guidelines**

### **A. Backend & Agent Logic**

* **From Store to Clinic:** Replace Tienda Nube tools (search\_products, orders) with Dental Tools.  
* **Required New Tools:**  
  * check\_availability(): Integration with Google Calendar API (Mirror mode).  
  * book\_appointment(): Create events in Calendar and entries in PGSQL.  
  * triage\_urgency(): NLP classification for "Pain/Emergency" to flag in Dashboard.  
* **Memory:** Maintain the 20-message sliding window but adapt the sys\_template to the "Dental Professional" persona (Argentine, warm, but clinical).  
* **Human Silence:** Keep the 24h lockout mechanism (human\_override\_until) for manual intervention.

### **B. Database Schema Evolution (PostgreSQL)**

Refactor the current schema to support:

* patients: (Extending current tenants/users) adding medical history, allergies (anamnesis), and OSDE Token fields.  
* appointments: Linked to Google Calendar IDs and box/chair assignment.  
* clinical\_records: JSONB structure for Odontograms and text for clinical notes.  
* accounting: Tables for payments, insurance claims (OSDE), and daily cash flow.

### **C. Frontend Refactoring (Vanilla JS)**

* **Dashboard:** Shift from "Sales" to "Patient Flow". Highlight "Urgencies".  
* **Agenda:** Implement a CSS Grid/Flexbox calendar view (Box-based) with Drag & Drop capability.  
* **CRM:** Create a view for Clinical Records including an SVG-based Odontogram.

## **3\. Implementation Instructions**

When I ask you to write code:

1. **Reuse Nexus v3 infrastructure:** Don't delete the Orchestrator/WhatsApp service bridge.  
2. **Modularize:** Create a new dental\_logic/ directory in the orchestrator if necessary.  
3. **Multi-tenant:** Ensure X-Tenant-ID logic remains intact so Mercedes can scale.  
4. **Safety:** Always prioritize data privacy for medical records.

**Current Task:** \[Insert your specific task here, e.g., "Create the SQLAlchemy model for the new Clinical Records table"\]
````

## File: pytest.ini
````ini
[pytest]
pythonpath = . whatsapp_service orchestrator_service tiendanube_service
asyncio_mode = auto
testpaths = tests
````

## File: README_BACKEND.md
````markdown
# Nexus Dental - Backend Documentation

## üìã Descripci√≥n General

Backend del sistema de gesti√≥n para cl√≠nica dental, built with FastAPI + PostgreSQL + LangChain AI agent.

## üèóÔ∏è Arquitectura

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      WhatsApp (YCloud)                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚îÇ
                          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 WhatsApp Service (Port 5005)                ‚îÇ
‚îÇ  - Transcripci√≥n de audio (Whisper)                         ‚îÇ
‚îÇ  - Forwarding de mensajes al Orchestrator                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚îÇ
                          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              Orchestrator Service (Port 8000)               ‚îÇ
‚îÇ  - AI Agent (GPT-4o-mini)                                   ‚îÇ
‚îÇ  - Tools: check_availability, book_appointment,            ‚îÇ
‚îÇ            triage_urgency, derivhumano                      ‚îÇ
‚îÇ  - Persistencia de chat en BD                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚îÇ
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚ñº               ‚ñº               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PostgreSQL  ‚îÇ  ‚îÇ  TiendaNube     ‚îÇ  ‚îÇ  Platform   ‚îÇ
‚îÇ (Puerto     ‚îÇ  ‚îÇ  Service        ‚îÇ  ‚îÇ  UI (Puerto ‚îÇ
‚îÇ 5432)       ‚îÇ  ‚îÇ  (Opcional)     ‚îÇ  ‚îÇ  3000)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üìÅ Estructura del Proyecto

```
orchestrator_service/
‚îú‚îÄ‚îÄ main.py              # AI Agent + API endpoints
‚îú‚îÄ‚îÄ admin_routes.py      # CRUD endpoints (patients, appointments)
‚îú‚îÄ‚îÄ db.py                # Database connection + helpers
‚îú‚îÄ‚îÄ utils.py             # Utility functions
‚îú‚îÄ‚îÄ debug_creds.py       # Debug credentials
‚îî‚îÄ‚îÄ requirements.txt     # Python dependencies

db/
‚îú‚îÄ‚îÄ init/
‚îÇ   ‚îî‚îÄ‚îÄ dentalogic_schema.sql   # Unified schema (all tables)
‚îî‚îÄ‚îÄ models_dental.py    # SQLAlchemy models (shared)

shared/
‚îú‚îÄ‚îÄ models_dental.py     # Shared Pydantic models
‚îî‚îÄ‚îÄ models.py            # Base models
```

## üöÄ Inicio R√°pido

### 1. Configuraci√≥n

```bash
# Copiar variables de entorno
cp .env.example .env
# Editar .env con tus valores
```

### 2. Ejecutar Schema SQL

```bash
# En PostgreSQL
psql -d dental_clinic -f db/init/dentalogic_schema.sql
```

### 3. Iniciar Servidor

```bash
cd orchestrator_service
python main.py
# Servidor corriendo en http://localhost:8000
```

### 4. Verificar

```bash
# Health check
curl http://localhost:8000/health

# Verificaci√≥n completa
python verify_backend_final.py
```

## üîß API Endpoints

### Chat Endpoint

```bash
POST /chat
Content-Type: application/json

{
  "message": "Hola, quiero agendar un turno",
  "phone": "+5491112345678",
  "name": "Juan P√©rez"
}
```

### Admin Endpoints

| Method | Endpoint | Descripci√≥n |
|--------|----------|-------------|
| GET | `/admin/patients` | Listar pacientes |
| POST | `/admin/patients` | Crear paciente |
| GET | `/admin/appointments` | Listar turnos |
| POST | `/admin/appointments` | Crear turno manual |
| GET | `/admin/professionals` | Listar profesionales |
| PUT | `/admin/appointments/{id}/status` | Actualizar estado |
| GET | `/health` | Health check |

## ü§ñ AI Agent Tools

| Tool | Descripci√≥n |
|------|-------------|
| `check_availability(date_query)` | Consulta disponibilidad de turnos |
| `book_appointment(date_time, treatment_reason)` | Registra un turno |
| `triage_urgency(symptoms)` | Clasifica urgencia de s√≠ntomas |
| `derivhumano(reason)` | Deriva a humano (bloquea bot 24h) |

## üóÑÔ∏è Base de Datos

### Tablas Principales

| Tabla | Descripci√≥n |
|-------|-------------|
| `patients` | Pacientes de la cl√≠nica |
| `professionals` | Profesionales/odont√≥logos |
| `appointments` | Turnos agendados |
| `appointment_statuses` | Estados de turnos |
| `chat_messages` | Historial de chat |
| `clinical_records` | Historia cl√≠nica |
| `inbound_messages` | Mensajes entrantes |

### Estados de Turno

| ID | Nombre | Descripci√≥n |
|----|--------|-------------|
| 1 | scheduled | Turno programado |
| 2 | confirmed | Turno confirmado |
| 3 | completed | Turno realizado |
| 4 | cancelled | Turno cancelado |
| 5 | no_show | Paciente no asisti√≥ |

## üîí Variables de Entorno

```env
# Base de datos
POSTGRES_DSN=postgresql://user:pass@localhost:5432/dental_clinic

# OpenAI
OPENAI_API_KEY=sk-...

# Cl√≠nica
CLINIC_NAME=Nexus Dental
CLINIC_LOCATION=Buenos Aires, Argentina

# WhatsApp (YCloud)
YCLOUD_API_KEY=...
YCLOUD_WEBHOOK_VERIFY_TOKEN=...

# Logging
LOG_LEVEL=INFO
```

## üß™ Tests

```bash
# Ejecutar tests
pytest tests/

# Test r√°pido
pytest tests/test_quick.py -v
```

## üì¶ Deployment

### Docker

```bash
# Build de todos los servicios
docker-compose build

# Iniciar servicios
docker-compose up -d

# Ver logs
docker-compose logs -f orchestrator
```

### EasyPanel

1. Crear servicio desde `orchestrator_service/`
2. Configurar variables de entorno
3. Deploy

## üìÑ Documentaci√≥n Adicional

- [Arquitectura](docs/01_architecture.md)
- [Variables de Entorno](docs/02_environment_variables.md)
- [Gu√≠a de Deployment](docs/03_deployment_guide.md)
- [L√≥gica del Agente](docs/04_agent_logic_and_persona.md)
- [Notas del Desarrollador](docs/05_developer_notes.md)
- [Template del Agente](docs/06_ai_prompt_template.md)
- [Workflow](docs/07_workflow_guide.md)
- [Historia de Troubleshooting](docs/08_troubleshooting_history.md)
- [Datos Espec√≠ficos Dental](docs/09_fase1_dental_datos_especificacion.md)

## üÜò Troubleshooting

### Error de conexi√≥n a BD
```
Verificar POSTGRES_DSN en .env
Ejecutar migraciones SQL
```

### El agente no responde
```
Revisar logs: docker-compose logs orchestrator
Verificar OPENAI_API_KEY
```

### Turnos no se crean
```
Verificar que existen profesionales activos
Revisar que las tablas existen
```

## üìù Changelog

### v1.0.0 (2025-01)
- ‚úÖ AI Agent con LangChain
- ‚úÖ Tools dental (check_availability, book_appointment)
- ‚úÖ CRUD endpoints
- ‚úÖ Persistencia de chat en BD
- ‚úÖ Sistema de derivaci√≥n a humano (24h block)
- ‚úÖ Integraci√≥n WhatsApp via YCloud
````

## File: README.md
````markdown
# ü¶∑ Dentalogic - Plataforma de Gesti√≥n Cl√≠nica con IA

Sistema de coordinaci√≥n cl√≠nica inteligente, impulsado por IA (**LangChain + OpenAI GPT-4o-mini**). El sistema act√∫a como un coordinador cl√≠nico que gestiona turnos, realiza triajes de urgencias y mantiene historias cl√≠nicas digitales multi-tenant.

## üöÄ Gu√≠a R√°pida de Inicio

### 1. Configuraci√≥n Inicial
```bash
# Sincronizar entorno dental
cp dental.env.example .env

# Completar las variables (Ver docs/02_environment_variables.md):
# - OPENAI_API_KEY
# - YCLOUD_API_KEY / YCLOUD_WEBHOOK_SECRET  
# - POSTGRES_DSN / REDIS_URL
# - CLINIC_NAME, BOT_PHONE_NUMBER
# - GOOGLE_CALENDAR_ID (Opcional)
```

### 2. Levantar la Infraestructura
```bash
docker-compose up --build
```

### 3. Acceder a los Servicios
| Servicio | URL | Funci√≥n |
| :--- | :--- | :--- |
| **Orchestrator** | `http://localhost:8000` | Coordinador Cl√≠nico (FastAPI + LangChain) |
| **WhatsApp Service** | `http://localhost:8002` | Relay de Mensajer√≠a y Whisper |
| **Operations Center** | `http://localhost:5173` | Centro de Operaciones Dental (React) |

---

## üìö Documentaci√≥n Completa

### ‚öôÔ∏è [01. Arquitectura de Microservicios](docs/01_architecture.md)
- Estructura de servicios (Backend, Frontend, Database)
- Flujo de mensajes y triaje de urgencias
- **Dentalogic:** Herramientas cl√≠nicas embebidas

### üîë [02. Variables de Envorno](docs/02_environment_variables.md)
- Credenciales de Google Calendar, OpenAI y YCloud.

### ‚òÅÔ∏è [03. Gu√≠a de Despliegue](docs/03_deployment_guide.md)
- Instrucciones para EasyPanel y Docker.

### üß† [04. L√≥gica del Agente Dental](docs/04_agent_logic_and_persona.md)
- Persona: Asistente Cl√≠nico Profesional.
- Tools: `check_availability`, `book_appointment`, `triage_urgency`.
- Mecanismo de silencio de 24 horas.

### üìä [11. An√°lisis de Gaps (Nexus vs Dentalogic)](docs/11_gap_analysis_nexus_to_dental.md)
- Estado actual de la implementaci√≥n vs requerimientos finales.

### üïµÔ∏è [Audit Report (Latest)](C:\Users\Asus\.gemini\antigravity\brain\d01b6032-f575-4ca0-8860-f5ec951011d8\audit_report.md)
- Detecci√≥n de spec drift y validaci√≥n de documentaci√≥n.
- √öltima auditor√≠a: 2026-02-05.

---

## üèóÔ∏è Tecnolog√≠as Core

| Componente | Tecnolog√≠a |
| :--- | :--- |
| **Backend** | FastAPI + Python 3.11+ |
| **IA / LLM** | LangChain + GPT-4o-mini + Whisper |
| **Persistencia** | PostgreSQL (Historias Cl√≠nicas) |
| **Cach√© / Locks** | Redis (Deduplicaci√≥n / Contexto) |
| **Frontend** | React + Tailwind CSS |
| **Infraestructura** | Docker + EasyPanel |

---

## üéØ Arquitectura Cl√≠nica

```mermaid
graph TD
    User((Paciente WhatsApp)) --> WS[WhatsApp Service]
    WS -->|Audio/Texto| ORC[Orchestrator Service]
    ORC -->|Triage| AI[OpenAI GPT-4o-mini]
    ORC -->|Sync| GC[Google Calendar]
    ORC -->|Record| DB[(PostgreSQL)]
    UI[Platform UI] -->|Admin| ORC
```

---

## ‚ö° Caracter√≠sticas Principales

‚úÖ **Coordinador Cl√≠nico:** Gesti√≥n automatizada de turnos v√≠a WhatsApp.  
‚úÖ **Triaje Inteligente:** Clasificaci√≥n de urgencias por IA.  
‚úÖ **Historias Cl√≠nicas:** Registro autom√°tico de evoluciones y anamnesis.  
‚úÖ **Sincronizaci√≥n de Agenda:** Vista espejo con Google Calendar.  
‚úÖ **Transcripci√≥n Whisper:** Soporte completo para s√≠ntomas enviados por audio.  
‚úÖ **Lockout de 24h:** Silencio autom√°tico ante intervenci√≥n humana.

---

*Sistema Dentalogic ¬© 2026. Optimizado para la Dra. Laura Delgado.*
````

## File: run_migrations.ps1
````powershell
#!/usr/bin/env powershell
# ========================================
# run_migrations.ps1
# Ejecuta todas las migraciones SQL
# ========================================

$ErrorActionPreference = "Stop"

# Variables
$POSTGRES_USER = "postgres"
$POSTGRES_PASSWORD = "postgres"  # Cambiar seg√∫n tu setup
$POSTGRES_HOST = "localhost"
$POSTGRES_PORT = 5432
$DATABASE_NAME = "clinica_dental"
$MIGRATIONS_DIR = "db/init"

Write-Host "üöÄ Iniciando migraciones SQL..." -ForegroundColor Green

# Verificar que psql est√° disponible
try {
    $psqlVersion = psql --version
    Write-Host "‚úÖ PostgreSQL encontrado: $psqlVersion" -ForegroundColor Green
} catch {
    Write-Host "‚ùå Error: PostgreSQL no est√° instalado o no est√° en PATH" -ForegroundColor Red
    exit 1
}

# Funci√≥n para ejecutar un archivo SQL
function Execute-SqlFile {
    param(
        [string]$FilePath,
        [string]$Description
    )
    
    Write-Host "`nüìÑ Ejecutando: $Description" -ForegroundColor Cyan
    Write-Host "   Archivo: $FilePath" -ForegroundColor Gray
    
    try {
        # Ejecutar el archivo
        $env:PGPASSWORD = $POSTGRES_PASSWORD
        psql `
            -h $POSTGRES_HOST `
            -p $POSTGRES_PORT `
            -U $POSTGRES_USER `
            -d $DATABASE_NAME `
            -f $FilePath
        
        Write-Host "   ‚úÖ OK" -ForegroundColor Green
    } catch {
        Write-Host "   ‚ùå Error: $_" -ForegroundColor Red
        exit 1
    } finally {
        Remove-Item env:PGPASSWORD -ErrorAction SilentlyContinue
    }
}

# Verificar que la BD existe
Write-Host "`nüîç Verificando base de datos '$DATABASE_NAME'..." -ForegroundColor Cyan
$env:PGPASSWORD = $POSTGRES_PASSWORD
$dbExists = psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -l | Select-String $DATABASE_NAME
Remove-Item env:PGPASSWORD -ErrorAction SilentlyContinue

if (-not $dbExists) {
    Write-Host "‚ö†Ô∏è  La base de datos no existe. Creando..." -ForegroundColor Yellow
    try {
        $env:PGPASSWORD = $POSTGRES_PASSWORD
        psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -c "CREATE DATABASE $DATABASE_NAME;"
        Write-Host "‚úÖ Base de datos creada" -ForegroundColor Green
    } catch {
        Write-Host "‚ùå Error al crear BD: $_" -ForegroundColor Red
        exit 1
    } finally {
        Remove-Item env:PGPASSWORD -ErrorAction SilentlyContinue
    }
} else {
    Write-Host "‚úÖ Base de datos encontrada" -ForegroundColor Green
}

# Ejecutar migraciones en orden
Write-Host "`nüì¶ Ejecutando migraciones..." -ForegroundColor Cyan

Execute-SqlFile `
    -FilePath "$MIGRATIONS_DIR/001_schema.sql" `
    -Description "Schema base (inbound_messages, chat_messages)"

Execute-SqlFile `
    -FilePath "$MIGRATIONS_DIR/002_platform_schema.sql" `
    -Description "Platform schema (tenants, credentials, system_events)"

Execute-SqlFile `
    -FilePath "$MIGRATIONS_DIR/004_dental_phase1_schema.sql" `
    -Description "Dental schema (patients, professionals, appointments, clinical_records)"

# Verificaci√≥n final
Write-Host "`n‚úÖ Migraciones completadas. Verificando tablas..." -ForegroundColor Green

$env:PGPASSWORD = $POSTGRES_PASSWORD
$tables = psql `
    -h $POSTGRES_HOST `
    -p $POSTGRES_PORT `
    -U $POSTGRES_USER `
    -d $DATABASE_NAME `
    -t `
    -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';"
Remove-Item env:PGPASSWORD -ErrorAction SilentlyContinue

$tableCount = [int]$tables.Trim()
Write-Host "üìä Total de tablas creadas: $tableCount" -ForegroundColor Green

if ($tableCount -ge 10) {
    Write-Host "`n‚úÖ ¬°√âXITO! Backend listo para funcionar" -ForegroundColor Green
    Write-Host "Pr√≥ximo paso: Ejecutar main.py con uvicorn" -ForegroundColor Cyan
} else {
    Write-Host "`n‚ö†Ô∏è  Advertencia: Se esperaban al menos 10 tablas, se encontraron $tableCount" -ForegroundColor Yellow
}

Write-Host "`n"
````

## File: sync-schema.ps1
````powershell
# Script de Sincronizaci√≥n de Esquemas Dentalogic
# Copia el esquema de la ra√≠z a la carpeta interna del orquestador

$Source = "db\init\dentalogic_schema.sql"
$Dest = "orchestrator_service\db\init\dentalogic_schema.sql"

if (Test-Path $Source) {
    Copy-Item $Source $Dest -Force
    Write-Host "‚úÖ Esquema sincronizado exitosamente de $Source a $Dest" -ForegroundColor Green
} else {
    Write-Error "‚ùå No se encontr√≥ el archivo de origen: $Source"
}
````

## File: verify_backend_final.py
````python
#!/usr/bin/env python3
"""
VERIFY_BACKEND_FINAL.py
Script de verificaci√≥n final para el backend dental.
Ejecutar despu√©s de las migraciones SQL.
"""
import asyncio
import asyncpg
import os
import sys

POSTGRES_DSN = os.getenv("POSTGRES_DSN", "postgresql://postgres:postgres@localhost:5432/dental_clinic")

async def verify_database():
    """Verifica que la BD est√© configurada correctamente."""
    print("=" * 60)
    print("üîç VERIFICACI√ìN FINAL DEL BACKEND DENTAL")
    print("=" * 60)
    
    try:
        # 1. Conectar a la BD
        print("\nüì° Conectando a PostgreSQL...")
        conn = await asyncpg.connect(POSTGRES_DSN)
        print("‚úÖ Conexi√≥n exitosa")
        
        # 2. Verificar tablas necesarias
        print("\nüìã Verificando tablas...")
        required_tables = [
            'patients', 'professionals', 'appointments', 
            'appointment_statuses', 'chat_messages', 'inbound_messages',
            'clinical_records', 'system_events'
        ]
        
        result = await conn.fetch("""
            SELECT tablename FROM pg_tables 
            WHERE schemaname = 'public' 
            ORDER BY tablename
        """)
        existing_tables = [row['tablename'] for row in result]
        
        missing = []
        for table in required_tables:
            if table in existing_tables:
                print(f"   ‚úÖ {table}")
            else:
                print(f"   ‚ùå {table} (FALTA)")
                missing.append(table)
        
        if missing:
            print(f"\n‚ö†Ô∏è  Faltan tablas: {missing}")
            print("   Ejecutar: psql -d dental_clinic -f db/init/RUN_MIGRATIONS.sql")
            return False
        
        # 3. Verificar profesionales activos
        print("\nüë®‚Äç‚öïÔ∏è Verificando profesionales...")
        pros = await conn.fetch("SELECT id, name FROM professionals WHERE is_active = true")
        if pros:
            for p in pros:
                print(f"   ‚úÖ Dr. {p['name']} (ID: {p['id']})")
        else:
            print("   ‚ö†Ô∏è  No hay profesionales activos (necesario para agendar turnos)")
        
        # 4. Verificar statuses de turnos
        print("\nüìä Verificando statuses de turnos...")
        statuses = await conn.fetch("SELECT id, name FROM appointment_statuses")
        for s in statuses:
            print(f"   ‚úÖ {s['name']} (ID: {s['id']})")
        
        await conn.close()
        print("\n" + "=" * 60)
        print("‚úÖ VERIFICACI√ìN COMPLETA - TODO OK")
        print("=" * 60)
        return True
        
    except asyncpg.InvalidCatalogSequenceError as e:
        print(f"\n‚ùå Error: Faltan migraciones SQL")
        print(f"   Ejecutar: psql -d dental_clinic -f db/init/RUN_MIGRATIONS.sql")
        print(f"\n   Error detalle: {e}")
        return False
    except Exception as e:
        print(f"\n‚ùå Error conectando a BD: {e}")
        print("   Verificar POSTGRES_DSN en .env")
        return False

async def verify_tools_import():
    """Verifica que las tools se puedan importar."""
    print("\nüîß Verificando imports de tools...")
    try:
        # Intentar importar main.py
        sys.path.insert(0, 'orchestrator_service')
        from main import DENTAL_TOOLS, check_availability, book_appointment
        print("   ‚úÖ main.py importado correctamente")
        print(f"   ‚úÖ Tools disponibles: {[t.name for t in DENTAL_TOOLS]}")
        return True
    except Exception as e:
        print(f"   ‚ùå Error importando: {e}")
        return False

async def main():
    """Ejecuta todas las verificaciones."""
    print("\nüöÄ INICIANDO VERIFICACI√ìN...")
    
    # Verificar DB
    db_ok = await verify_database()
    
    # Verificar imports
    tools_ok = await verify_tools_import()
    
    # Resumen final
    print("\n" + "=" * 60)
    print("üìä RESUMEN FINAL")
    print("=" * 60)
    print(f"   Base de Datos: {'‚úÖ OK' if db_ok else '‚ùå FALTA'}")
    print(f"   Tools importadas: {'‚úÖ OK' if tools_ok else '‚ùå ERROR'}")
    print()
    
    if db_ok and tools_ok:
        print("üéâ EL BACKEND EST√Å COMPLETO Y LISTO PARA USAR")
        print("\nüìù PR√ìXIMOS PASOS:")
        print("   1. Iniciar el servidor: python -m orchestrator_service.main")
        print("   2. Probar con: curl -X POST http://localhost:8000/health")
        return 0
    else:
        print("‚ö†Ô∏è  HAY PENDIENTES POR RESOLVER")
        if not db_ok:
            print("   ‚Üí Ejecutar migraciones SQL")
        if not tools_ok:
            print("   ‚Üí Revisar errores de import")
        return 1

if __name__ == "__main__":
    exit_code = asyncio.run(main())
    sys.exit(exit_code)
````

## File: verify_backend.ps1
````powershell
#!/usr/bin/env pwsh
# ‚úÖ QUICK VERIFICATION SCRIPT
# Valida que backend est√© OK antes de proceder con frontend

Write-Host "üîç Iniciando verificaciones del backend..." -ForegroundColor Cyan

# 1. Verificar que Python existe
Write-Host "`n[1/6] Verificando Python..." -ForegroundColor Yellow
try {
    $pythonVersion = python --version 2>&1
    Write-Host "‚úÖ $pythonVersion" -ForegroundColor Green
} catch {
    Write-Host "‚ùå Python no encontrado. Instala Python 3.9+" -ForegroundColor Red
    exit 1
}

# 2. Verificar que FastAPI existe
Write-Host "`n[2/6] Verificando FastAPI..." -ForegroundColor Yellow
try {
    python -c "import fastapi; print(f'FastAPI {fastapi.__version__}')" 2>&1 | ForEach-Object {
        if ($_ -match "FastAPI") {
            Write-Host "‚úÖ $_" -ForegroundColor Green
        }
    }
} catch {
    Write-Host "‚ùå FastAPI no instalado. Ejecuta: pip install fastapi" -ForegroundColor Red
}

# 3. Verificar que LangChain existe
Write-Host "`n[3/6] Verificando LangChain..." -ForegroundColor Yellow
try {
    python -c "import langchain; print(f'LangChain OK')" 2>&1 | ForEach-Object {
        Write-Host "‚úÖ $_" -ForegroundColor Green
    }
} catch {
    Write-Host "‚ùå LangChain no instalado. Ejecuta: pip install langchain" -ForegroundColor Red
}

# 4. Validar sintaxis de main.py
Write-Host "`n[4/6] Validando main.py..." -ForegroundColor Yellow
try {
    python -m py_compile orchestrator_service/main.py 2>&1
    Write-Host "‚úÖ main.py sintaxis OK" -ForegroundColor Green
} catch {
    Write-Host "‚ùå Error de sintaxis en main.py" -ForegroundColor Red
    Write-Host $_ -ForegroundColor Red
}

# 5. Validar sintaxis de admin_routes.py
Write-Host "`n[5/6] Validando admin_routes.py..." -ForegroundColor Yellow
try {
    python -m py_compile orchestrator_service/admin_routes.py 2>&1
    Write-Host "‚úÖ admin_routes.py sintaxis OK" -ForegroundColor Green
} catch {
    Write-Host "‚ùå Error de sintaxis en admin_routes.py" -ForegroundColor Red
    Write-Host $_ -ForegroundColor Red
}

# 6. Verificar PostgreSQL
Write-Host "`n[6/6] Verificando PostgreSQL..." -ForegroundColor Yellow
try {
    $pgVersion = psql --version 2>&1
    if ($pgVersion -match "psql") {
        Write-Host "‚úÖ $pgVersion" -ForegroundColor Green
    } else {
        Write-Host "‚ö†Ô∏è PostgreSQL client OK, pero BD no verificada" -ForegroundColor Yellow
    }
} catch {
    Write-Host "‚ö†Ô∏è PostgreSQL no disponible. Ser√° requerido para producci√≥n." -ForegroundColor Yellow
}

Write-Host "`n" -ForegroundColor Cyan
Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" -ForegroundColor Cyan
Write-Host "‚úÖ VERIFICACIONES COMPLETADAS" -ForegroundColor Green
Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" -ForegroundColor Cyan

Write-Host "`nüìã PR√ìXIMOS PASOS:" -ForegroundColor Cyan
Write-Host "1. Ejecutar: pip install -r orchestrator_service/requirements.txt"
Write-Host "2. Ejecutar: .\run_migrations.ps1 (para SQL migrations)"
Write-Host "3. Ejecutar: python -m uvicorn orchestrator_service.main:app --reload"
Write-Host "4. Abrir en navegador: http://localhost:8000/docs"
Write-Host ""
````

## File: verify_phases.py
````python
import hmac
import hashlib
import time
import requests
import json
import uuid

# Configuration
WHATSAPP_SERVICE_URL = "http://localhost:8002"
YCLOUD_WEBHOOK_SECRET = os.getenv("YCLOUD_WEBHOOK_SECRET", "test_secret")
INTERNAL_API_TOKEN = os.getenv("INTERNAL_API_TOKEN", "test_token")

def generate_signature(body, secret):
    t = str(int(time.time()))
    payload = f"{t}.{body}"
    s = hmac.new(secret.encode(), payload.encode(), hashlib.sha256).hexdigest()
    return f"t={t},s={s}"

def test_invalid_signature():
    print("\n--- Testing Invalid Signature ---")
    url = f"{WHATSAPP_SERVICE_URL}/webhook/ycloud"
    payload = json.dumps({"test": "data"})
    headers = {"ycloud-signature": "t=1234567890,s=invalid_signature"}
    try:
        response = requests.post(url, data=payload, headers=headers)
        print(f"Status: {response.status_code}")
        print(f"Response: {response.text}")
        if response.status_code == 401:
            print("PASS: Invalid signature rejected")
        else:
            print("FAIL: Invalid signature accepted")
    except Exception as e:
        print(f"Error: {e}")

def test_valid_signature_and_flow():
    print("\n--- Testing Valid Signature & Flow ---")
    url = f"{WHATSAPP_SERVICE_URL}/webhook/ycloud"
    
    # Payload matching n8n structure
    wamid = f"wamid.{uuid.uuid4()}"
    payload_data = [
        {
            "id": "evt_123",
            "type": "whatsapp.inbound_message.received",
            "apiVersion": "v2",
            "createTime": "2023-10-27T10:00:00Z",
            "whatsappInboundMessage": {
                "id": wamid,
                "wamid": wamid,
                "from": "123456789",
                "to": "987654321",
                "type": "text",
                "text": {"body": "Hola, prueba agente"},
                "customerProfile": {"name": "Test User"},
                "sendTime": "2023-10-27T10:00:00Z"
            }
        }
    ]
    payload = json.dumps(payload_data)
    signature = generate_signature(payload, YCLOUD_WEBHOOK_SECRET)
    headers = {
        "ycloud-signature": signature,
        "Content-Type": "application/json"
    }
    
    # First Request
    print(f"Sending First Request (WAMID: {wamid})...")
    try:
        response = requests.post(url, data=payload, headers=headers)
        print(f"Status: {response.status_code}")
        print(f"Response: {response.text}")
        if response.status_code == 200:
             print("PASS: Valid request accepted")
        else:
             print(f"FAIL: Request failed with {response.status_code}")
    except Exception as e:
         print(f"Error: {e}")

    # Duplicate Request
    print(f"\nSending Duplicate Request (WAMID: {wamid})...")
    try:
        response = requests.post(url, data=payload, headers=headers)
        print(f"Status: {response.status_code}")
        print(f"Response: {response.text}")
        
        # We expect a 200 OK from whatsapp_service regardless, but the content might show it was duplicate handled by orchestrator
        # OR if orchestrator returns a 'send=False' with status='duplicate', whatsapp_service just returns that json.
        response_json = response.json()
        if response_json.get("status") == "duplicate":
            print("PASS: Duplicate request correctly identified")
        else:
            print(f"FAIL: Duplicate not identified or unexpected response {response_json}")
            
    except Exception as e:
        print(f"Error: {e}")

if __name__ == "__main__":
    test_invalid_signature()
    test_valid_signature_and_flow()
````
